---
title: 分布式系统中的CAP理论
url: cap_theorem
tags:
  - 分布式
categories:
  - 编程杂谈
date: 2020-02-06 20:06:00
---

# 前言
很多人都见过下面这张图, 鱼与熊掌不可兼得, 在分布式系统中也是一样.
{% img /images/分布式系统中的CAP理论_01.png %}

<!-- more -->

一个分布式系统, 我们要关注的是它的可用性、一致性、分区容错性
1. **C**onsistency 一致性
2. **A**vailability 可用性
3. **P**artition tolerance 分区容错

# 什么是CAP
我们假设一个分布式系统有`3`个终端, 数据库`DB1`和`BD2`以及应用端`App`
![分布式系统](https://yuml.me/diagram/nofunky/class/[DB1]->[App],[DB2]->[App])

假设服务端有数据`a=1`
1. 如果`App`往`DB1`写入数据`a=2`, 然后从`BD2`读到数据`a=2`, `DB1`和`BD2`的数据保持一致, 这叫做一致性**`C`**.
2. 如果`App`从`DB1`读取数据`a`, `BD1`能够及时响应, 这叫做可用性**`A`**.
3. `DB1`和`DB2`存在于不同的网络分区, 比如一个在华东, 一个在华南, 他们两个能相互通信做主从复制, 这叫做**`P`**.

# 那么`CAP`能同时做到吗?
正常情况下是可以的, 我们说的只能三选二的情况一般都是网络故障的时候, 才会进行取舍.
还是以这张图为例
![分布式系统](https://yuml.me/diagram/nofunky/class/[DB1]->[App],[DB2]->[App])
作为分布式系统, 必定要满足**`P`**, 那么当`DB1`和`DB2`之间的网络发生故障, 此时就要对**`AC`**进行取舍.
1. 保障**`A`**, `App`能正常读写`DB1`和`DB2`, 但是一旦进行了写入操作, `DB1`和`DB2`是不能进行通信做主从复制的, 换句话说, 就会导致数据不一致的情况.
2. 保障**`C`**, 那么为了保证数据一致性, `App`就应该等待`DB1`和`DB2`之间的网络恢复, 这样就不能访问数据库了, 舍弃了可用性.

那有人问, 能不能只保证**`AC`**?
可以啊, 我们把两个数据库都放在一台服务器上, 这样就不会因为网络故障导致**`AC`**二选一的问题了, 因为根本没有网络.
但是这还能叫做分布式吗?

# 参考资料
- [An Illustrated Proof of the CAP Theorem](https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/)