<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>PPT如何使用VBA批量替换字体</title>
    <url>/posts/PPT_how_to_replace_font_by_vba.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近有个需求, 需要将<code>PPT</code>内的字体全部修改为华文中宋, 并修改字号, 字符间距.<br>原以为可以和<code>notepad++</code>录制宏, 但是<code>office</code>居然把录制宏这个功能干掉了, 要实现这个需求, 只能自己写<code>VBA</code>.<br>本文从零开始学习<code>VBA</code>使用.</p>
<span id="more"></span>

<h1 id="什么是VBA"><a href="#什么是VBA" class="headerlink" title="什么是VBA"></a>什么是VBA</h1><blockquote>
<p>Visual Basic for Applications（VBA）是Visual Basic的一种宏语言，主要能用来扩展Windows的应用程序功能，特别是Microsoft Office软件。也可说是一种应用程序视觉化的Basic Script。 1994年发行的Excel 5.0版本中，即具备了VBA的宏功能。</p>
</blockquote>
<p>以上来自维基百科, 在我看来就是可以应用在<code>office</code>全家桶的一个编程语言. 既然是编程语言, 那就肯定有数据结构, 变量, 流程控制语句等.</p>
<h1 id="PPT内的VBA对象"><a href="#PPT内的VBA对象" class="headerlink" title="PPT内的VBA对象"></a>PPT内的VBA对象</h1><p><a href="https://docs.microsoft.com/en-us/office/vba/api/powerpoint.application.activepresentation"><code>ActivePresentation</code></a>: 返回一个<code>Presentation</code>对象, 该对象表示当前打开的<code>PPT</code>.<br><a href="https://docs.microsoft.com/en-us/office/vba/api/powerpoint.slides"><code>ActivePresentation.Slides</code></a>: 返回<code>PPT</code>内的幻灯片集合.<br><a href="https://docs.microsoft.com/en-us/office/vba/api/powerpoint.slide.shapes"><code>ActivePresentation.Slides.Shapes</code></a>: 返回幻灯片内的所有元素集合, 包括图片、文字等.<br><a href="https://docs.microsoft.com/en-us/office/vba/api/powerpoint.shape.textframe"><code>ActivePresentation.Slides.Shapes.TextFrame</code></a>: 修改元素内的文本属性<br><a href="https://docs.microsoft.com/en-us/office/vba/api/powerpoint.textframe2"><code>ActivePresentation.Slides.Shapes.TextFrame2</code></a>: 修改元素内的文本属性</p>
<p><code>TextFrame</code>和<code>TextFrame2</code>都是可以修改文本属性. 不需要纠结它们有什么不同.</p>
<h1 id="VBA语法"><a href="#VBA语法" class="headerlink" title="VBA语法"></a>VBA语法</h1><p><a href="https://docs.microsoft.com/en-us/office/vba/language/concepts/getting-started/declaring-variables"><code>Dim a As object</code></a>: 声明<code>object</code>类型的对象变量<code>a</code><br><a href="https://docs.microsoft.com/en-us/office/vba/language/concepts/getting-started/using-for-eachnext-statements"><code>For Each a In Array ... Next</code></a>: 循环遍历<code>Array</code>数组, 每个元素都赋值给变量<code>a</code>.<br><a href="https://docs.microsoft.com/en-us/office/vba/language/concepts/getting-started/using-ifthenelse-statements"><code>If...Then...Else</code></a>: 流程判断语句.<br><a href="https://docs.microsoft.com/en-us/dotnet/visual-basic/language-reference/operators/not-operator"><code>Not a</code></a>: 对表达式的值取反, 相当于<code>!a</code>.<br><a href="https://docs.microsoft.com/en-us/office/vba/language/reference/user-interface-help/with-statement"><code>With object ... End With</code></a>: 为<code>object</code>对象设置属性.<br><a href="https://docs.microsoft.com/en-us/dotnet/visual-basic/programming-guide/program-structure/comments-in-code"><code>&#39;我被单引号注释了</code></a>: 单引号表示注释</p>
<h1 id="完整例子"><a href="#完整例子" class="headerlink" title="完整例子"></a>完整例子</h1><p>整个逻辑很简单, 就是循环遍历, 判断有文字就修改文字的属性.<br>如果有不想修改的属性, 打上单引号注释掉, 或者直接删掉那一行代码就可以了.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Sub ChangeFont()</span><br><span class="line">    Dim oShape As Shape</span><br><span class="line">    Dim oSlide As Slide</span><br><span class="line">    Dim oTxtRange As TextRange</span><br><span class="line">    On Error Resume Next</span><br><span class="line">  </span><br><span class="line">    For Each oSlide In ActivePresentation.Slides</span><br><span class="line">        For Each oShape In oSlide.Shapes</span><br><span class="line">            Set oTxtRange1 = oShape.TextFrame.TextRange</span><br><span class="line">            If Not IsNull(oTxtRange1) Then</span><br><span class="line">                With oTxtRange1.Font</span><br><span class="line">                .NameFarEast = &quot;华文中宋&quot;           &#x27;中文字体名称</span><br><span class="line">                .Name = &quot;华文中宋&quot;                  &#x27;字体名称</span><br><span class="line">                .NameOther = &quot;华文中宋&quot;             &#x27;其他字体名称</span><br><span class="line">                .Size = 20                          &#x27;字体大小</span><br><span class="line">                .Color.RGB = RGB(Red:=0, Green:=0, Blue:=0) &#x27;字体颜色</span><br><span class="line">                .Bold = False                       &#x27;是否加粗</span><br><span class="line">                .Italic = False                     &#x27;是否倾斜</span><br><span class="line">                .Shadow = False                     &#x27;是否阴影</span><br><span class="line">                End With</span><br><span class="line">            End If</span><br><span class="line">            </span><br><span class="line">            Set oTxtRange2 = oShape.TextFrame2.TextRange</span><br><span class="line">            If Not IsNull(oTxtRange2) Then</span><br><span class="line">                With oTxtRange2.Font</span><br><span class="line">                .Spacing = 0                        &#x27;字体字符间距为普通</span><br><span class="line">                End With</span><br><span class="line">            End If</span><br><span class="line">        Next</span><br><span class="line">    Next</span><br><span class="line">End Sub</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>写<code>VBA</code>的主要难点是对<code>office</code>体系内的对象不了解, 就拿<code>TextFrame</code>和<code>TextFrame2</code>来说, 同样设置字体格式, 居然分为两个对象来设置.</p>
<p>目前的需求很简单, 已经能满足了, 如果后续有其他奇奇怪怪的需求, 再补充下这个代码.</p>
]]></content>
      <categories>
        <category>Microsoft Office</category>
      </categories>
      <tags>
        <tag>VBA</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA的LiveTempleate自动生成代码</title>
    <url>/posts/IDEA_LiveTempleate_Setting.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Live Template是IDEA提供的一个自动生成代码的工具, 可以自定义一段小代码, 比如最常见的 <code>System.out.println(&quot;&quot;);</code> ,  当然这已经被内置了, 输入 <code>sout</code>即可输出。</p>
<span id="more"></span>

<h1 id="自定义xml的存储位置"><a href="#自定义xml的存储位置" class="headerlink" title="自定义xml的存储位置"></a>自定义xml的存储位置</h1><ul>
<li>Windows: 用户目录/.IntelliJ IDEA/config/templates</li>
<li>Linux: ~IntelliJ IDEA/config/templates</li>
<li>macOS: ~/Library/Preferences/IntelliJ IDEA/templates</li>
</ul>
<p>当然这在<a href="https://www.jetbrains.com/help/idea/live-templates.html">官方文档</a>中有提到</p>
<h1 id="自定义Live-Template"><a href="#自定义Live-Template" class="headerlink" title="自定义Live Template"></a>自定义Live Template</h1><p>打开IDEA, 点击工具栏File -&gt; Settings -&gt; Editor -&gt; Live Template, 点击右边的加号+。<br>输入下面的代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> org.slf4j.<span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> org.slf4j.LoggerFactory.getLogger($CLASS_NAME$.class);</span><br><span class="line">$END$</span><br></pre></td></tr></table></figure>
<p>再点击右边的 <code>Edit variables</code>, 选择 <code>Expression</code> 为 <code>className()</code><br>在代码中输入 <code>logg</code> 即可生成自动生成上面的代码, <code>$CLASS_NAME$</code> 表示当前的类名。</p>
<h1 id="自用的Live-Template"><a href="#自用的Live-Template" class="headerlink" title="自用的Live Template"></a>自用的Live Template</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">templateSet</span> <span class="attr">group</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logg&quot;</span> <span class="attr">value</span>=<span class="string">&quot;private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger($CLASS_NAME$.class);<span class="symbol">&amp;#10;</span>$END$&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志输出器&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;CLASS_NAME&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;className()&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;&quot;</span> <span class="attr">alwaysStopAt</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;loge&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.error(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志error级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logw&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.warn(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志warn级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logi&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.info(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志info级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.debug(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志debug级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;can&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java.util.Scanner in = new java.util.Scanner(System.in);<span class="symbol">&amp;#10;</span>int n = in.nextInt();<span class="symbol">&amp;#10;</span>$END$&quot;</span> <span class="attr">description</span>=<span class="string">&quot;控制台输入&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;pra&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java.util.Arrays.toString($END$)&quot;</span> <span class="attr">description</span>=<span class="string">&quot;打印数组&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;prm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;for(java.util.Map.Entry entry : $VAR$.entrySet())&#123;<span class="symbol">&amp;#10;</span>    System.out.println(entry.getKey()+<span class="symbol">&amp;quot;</span> : <span class="symbol">&amp;quot;</span>+entry.getValue());<span class="symbol">&amp;#10;</span>&#125;&quot;</span> <span class="attr">description</span>=<span class="string">&quot;打印Map集合&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;VAR&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;&quot;</span> <span class="attr">alwaysStopAt</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">templateSet</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.jetbrains.com/help/idea/live-templates.html">官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>IDEA的基本配置</title>
    <url>/posts/IDEA_common_setting.html</url>
    <content><![CDATA[<h1 id="版本选择"><a href="#版本选择" class="headerlink" title="版本选择"></a>版本选择</h1><p>选择: <a href="https://www.jetbrains.com/idea/download/previous.html">2017.3</a><br>激活: <a href="http://idea.liyang.io/">http://idea.liyang.io/</a></p>
<span id="more"></span>

<h1 id="字体颜色设置"><a href="#字体颜色设置" class="headerlink" title="字体颜色设置"></a>字体颜色设置</h1><ol>
<li>设置主题: File -&gt; Settings -&gt; Appearence&amp;Behavior -&gt; Appearence, 选择 <code>Darcula</code>暗色背景</li>
<li>设置代码字体: File -&gt; Settings -&gt; Editor -&gt; Font, 设置 <code>font</code> 为 <code>Consolas</code> ,  <code>Size</code> 为 <code>16</code>。</li>
<li>设置控制台字体: File -&gt; Settings -&gt; Editor -&gt; Color Scheme -&gt; Console Font, 设置 <code>font</code> 为 <code>Consolas</code> ,  <code>Size</code> 为 <code>14</code>。</li>
</ol>
<h1 id="配置Git"><a href="#配置Git" class="headerlink" title="配置Git"></a>配置Git</h1><p>在 File -&gt; Settings -&gt; Version Control -&gt; Git -&gt; Path to Git executable 添加 <code>Git路径\bin\git.exe</code>。</p>
<h1 id="中文输入法配置"><a href="#中文输入法配置" class="headerlink" title="中文输入法配置"></a>中文输入法配置</h1><p><code>2017.2</code>不支持中文输入法候选框的显示。</p>
<ol>
<li>找到IDEA在本地安装路径(先把IDEA关闭)</li>
<li>在IDEA安装路径中把jre64文件删除,或者重命名(万一不行可以再改回来…)</li>
<li>找到本地java安装路径,把jre文件夹复制一份.(java安装路径里有jdk和jre的文件夹)</li>
<li>把复制的jre文件夹粘贴在刚才修改jre64位置,重命名为jre64(这样IDEA启动就能找到它)</li>
<li>在java安装路径中找到jdk文件-再找到lib文件-找到tools.jar文件,复制一份</li>
<li>把jar包粘贴到已经重命名过的jre64/lib下</li>
<li>打开IDEA,写一段代码,然后写一段中文注释试试,问题解决~</li>
</ol>
<h1 id="maven设置"><a href="#maven设置" class="headerlink" title="maven设置"></a>maven设置</h1><p>在 <code>IntelliJ IDEA</code> 文件夹下新建文件夹 <code>mvnlib</code>,<br>打开 <code>IntelliJ IDEA\plugins\maven\lib\maven2\conf\settings.xml</code> (maven3同理) , 添加如下xml, 注意层级结构</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- maven的下载路径, 默认下载在C盘用户目录下 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">localRepository</span>&gt;</span>mvnlib的目录<span class="tag">&lt;/<span class="name">localRepository</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- 阿里云的maven镜像仓库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>alimaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://maven.aliyun.com/nexus/content/groups/public/<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span>        </span><br><span class="line">        <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h1><ul>
<li><a href="https://plugins.jetbrains.com/plugin/4441-jrebel-for-intellij">热部署jrebel</a>: 用Twitter或者Facebook登录<a href="https://my.jrebel.com/account/how-to-activate">获取注册码</a>即可。</li>
<li><a href="https://plugins.jetbrains.com/plugin/3847-findbugs-idea">findbugs</a>: 找到隐藏比较深的bug</li>
<li><a href="https://plugins.jetbrains.com/plugin/7125-grep-console">Grep Console</a>: 输出彩色日志</li>
<li><a href="https://github.com/Skykai521/ECTranslation">ECTranslation</a>: 翻译插件</li>
<li><a href="https://github.com/jansorg/BashSupport">BashSupport</a>: 执行shell</li>
<li><a href="https://github.com/zielu/GitToolBox">GitToolBox</a>: <code>Git</code>功能扩展</li>
<li><a href="https://plugins.jetbrains.com/plugin/7179-maven-helper">Maven Helper</a>: <code>Maven</code>功能扩展</li>
<li><a href="https://plugins.jetbrains.com/plugin/4455-key-promoter">Key promoter</a>: 帮助记住<code>IDEA</code>快捷键</li>
<li><a href="https://plugins.jetbrains.com/plugin/10292-restfultoolkit">RestfulToolkit</a>: 根据<code>URL</code>快速找到<code>Controller</code>所在位置</li>
<li><a href="https://github.com/gejun123456/intellij-generateAllSetMethod">GenerateAllSetter</a>: 快速生成<code>set</code>方法</li>
</ul>
<ul>
<li><a href="https://plugins.jetbrains.com/plugin/7293-mybatis-plugin">MyBatis插件</a>: 照着说明复制粘贴即可破解, <a href="https://github.com/myoss/profile">github地址</a>(失效)</li>
</ul>
<h1 id="Live-Template"><a href="#Live-Template" class="headerlink" title="Live Template"></a>Live Template</h1><ul>
<li>Windows: 用户目录/.IntelliJ IDEA/config/templates</li>
<li>Linux: ~IntelliJ IDEA/config/templates</li>
<li>macOS: ~/Library/Preferences/IntelliJ IDEA/templates<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">templateSet</span> <span class="attr">group</span>=<span class="string">&quot;user&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logg&quot;</span> <span class="attr">value</span>=<span class="string">&quot;private static final org.slf4j.Logger logger = org.slf4j.LoggerFactory.getLogger($CLASS_NAME$.class);<span class="symbol">&amp;#10;</span>$END$&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志输出器&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;CLASS_NAME&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;className()&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;&quot;</span> <span class="attr">alwaysStopAt</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;loge&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.error(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志error级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logw&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.warn(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志warn级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logi&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.info(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志info级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;logd&quot;</span> <span class="attr">value</span>=<span class="string">&quot;logger.debug(<span class="symbol">&amp;quot;</span>$END$<span class="symbol">&amp;quot;</span>);&quot;</span> <span class="attr">description</span>=<span class="string">&quot;log日志debug级别&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;can&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java.util.Scanner in = new java.util.Scanner(System.in);<span class="symbol">&amp;#10;</span>int n = in.nextInt();<span class="symbol">&amp;#10;</span>$END$&quot;</span> <span class="attr">description</span>=<span class="string">&quot;控制台输入&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;pra&quot;</span> <span class="attr">value</span>=<span class="string">&quot;java.util.Arrays.toString($END$)&quot;</span> <span class="attr">description</span>=<span class="string">&quot;打印数组&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">template</span> <span class="attr">name</span>=<span class="string">&quot;prm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;for(java.util.Map.Entry entry : $VAR$.entrySet())&#123;<span class="symbol">&amp;#10;</span>    System.out.println(entry.getKey()+<span class="symbol">&amp;quot;</span> : <span class="symbol">&amp;quot;</span>+entry.getValue());<span class="symbol">&amp;#10;</span>&#125;&quot;</span> <span class="attr">description</span>=<span class="string">&quot;打印Map集合&quot;</span> <span class="attr">toReformat</span>=<span class="string">&quot;false&quot;</span> <span class="attr">toShortenFQNames</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">variable</span> <span class="attr">name</span>=<span class="string">&quot;VAR&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;&quot;</span> <span class="attr">defaultValue</span>=<span class="string">&quot;&quot;</span> <span class="attr">alwaysStopAt</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">&quot;JAVA_CODE&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">templateSet</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.csdn.net/weixin_39641494/article/details/78435941">IntelliJ IDEA 2017.2.5 中文输入后,输入框文字不随指针显示问题</a></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>VMware虚拟机的网络连接方式</title>
    <url>/posts/VMware_virtual_machine_network_connection.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>安装VMware后, 可以在网络适配器看到两个虚拟网卡<code>VMnet1</code>和<code>VMnet8</code>。</p>
<span id="more"></span>

<h1 id="连接方式"><a href="#连接方式" class="headerlink" title="连接方式"></a>连接方式</h1><p>打开<code>网络与共享中心</code>, 点击左侧<code>更改适配器设置</code>, 右键<code>VMnet1</code>或<code>VMnet8</code>, 选择<code>属性</code>。<br>确保两个网卡都开启<code>VMware Bridge Protocal</code>协议。</p>
<p>打开VMware, 点击菜单栏<code>编辑</code>, 选择<code>虚拟网络编辑器</code>, 可以看到三种配置。</p>
<h2 id="桥接模式"><a href="#桥接模式" class="headerlink" title="桥接模式"></a>桥接模式</h2><p>使用真实网卡连接, 选择可以<code>上网</code>的一块网卡。<br>推荐指定具体网卡, 不选择自动。</p>
<p>只要和真实机相同<code>网段</code>即可通信。<br>需要<code>占用</code>真实网段的ip地址。</p>
<h2 id="NAT连接模式"><a href="#NAT连接模式" class="headerlink" title="NAT连接模式"></a>NAT连接模式</h2><p>使用VMnet8虚拟网卡连接。<br>只能和真实机通信, 不能连接局域网其他设备。<br>可以访问互联网。</p>
<h2 id="Host-only连接方式"><a href="#Host-only连接方式" class="headerlink" title="Host-only连接方式"></a>Host-only连接方式</h2><p>使用VMnet1虚拟网卡连接。<br>只能和真实机通信, 不能连接局域网其他设备。<br>只能连接真实机。</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>VMware</tag>
      </tags>
  </entry>
  <entry>
    <title>adb制作gif</title>
    <url>/posts/how_to_use_adb_to_create_gif.html</url>
    <content><![CDATA[<h1 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h1><p>有时候我们需要录制Android手机的屏幕，比如写了一个Demo应用，需要发布到博客和微博上。<br>如下是我录制转GIF的效果图</p>
<span id="more"></span>
<img data-src="/images/adb%E5%88%B6%E4%BD%9Cgif_01.gif" class="">
<h1 id="正常录制"><a href="#正常录制" class="headerlink" title="正常录制"></a>正常录制</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb devices</span><br><span class="line">adb -s 驱动编号 shell screenrecord /sdcard/test.mp4</span><br><span class="line">adb -s 驱动编号 pull /sdcard/test.mp4 C:\Users\Avalon\Desktop</span><br></pre></td></tr></table></figure>
<p>视频保存目录可以自己指定，如上面的/sdcard/test.mp4，<br>命令执行后会一直录制180s，按下ctrl+c可以提前结束录制</p>
<h1 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">adb -s 驱动编号 shell /system/bin/screencap -p /sdcard/screenshot.png</span><br><span class="line">adb -s 驱动编号 pull /sdcard/screenshot.png C:\Users\Avalon\Desktop</span><br></pre></td></tr></table></figure>


<h1 id="转GIF文件"><a href="#转GIF文件" class="headerlink" title="转GIF文件"></a>转GIF文件</h1><p>在<code>Windows</code>下有个不错的软件<a href="http://www.video-gif-converter.com/index.html">Free Video to GIF Converter</a> 可以把<code>mp4</code>转换成<code>GIF</code>。<br>转换时还可以删除不需要的帧，这点真得很不错。<br><code>Mac</code>上可以使用<a href="http://www.gifrocket.com/">gifrocket</a> 进行转换。<br>还有一些在线的<a href="http://ezgif.com/video-to-gif">转换工具</a> 可以使用，但是都会打上水印。</p>
<h1 id="其他设置"><a href="#其他设置" class="headerlink" title="其他设置"></a>其他设置</h1><ul>
<li>设定视频分辨率<br><code>adb shell screenrecord --size 848x480 /sdcard/test.mp4</code></li>
<li>设定视频比特率<br><code>adb shell screenrecord --bit-rate 2000000 /sdcard/test.mp4</code></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>git使用</title>
    <url>/posts/how_to_use_GitHub_with_git.html</url>
    <content><![CDATA[<h1 id="常用上传"><a href="#常用上传" class="headerlink" title="常用上传"></a>常用上传</h1><ol>
<li>初始化<code>git init</code></li>
<li>添加所有文件<code>git add .</code></li>
<li>提交到本地仓库<code>git commit -m &quot;描述&quot;</code></li>
<li>连接github分支<code>git pull origin master</code></li>
<li>连接到github仓库<code>git remote add origin git@github.com:Ahaochan/项目名.git</code></li>
<li>提交到远程仓库<code>git push -u origin master</code></li>
</ol>
<span id="more"></span>

<h1 id="常用下载"><a href="#常用下载" class="headerlink" title="常用下载"></a>常用下载</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git clone https://github.com/seven332/EhViewer</span><br><span class="line">cd EhViewer</span><br><span class="line">./gradlew app:assembleDebug</span><br></pre></td></tr></table></figure>

<h1 id="分支相关"><a href="#分支相关" class="headerlink" title="分支相关"></a>分支相关</h1><ul>
<li>新建分支：<code>git branch 分支名</code></li>
<li>切换分支：<code>git checkout 分支名</code></li>
<li>上传分支：<code>git push origin 分支名</code></li>
<li>删除本地分支：<code>git branch -d 分支名</code></li>
<li>删除<code>github</code>分支(分支名前的冒号代表删除)：<code>git push origin :分支名</code></li>
</ul>
<h1 id="Tag相关"><a href="#Tag相关" class="headerlink" title="Tag相关"></a>Tag相关</h1><ul>
<li>为过往<code>commit</code>添加<code>tag</code><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">git log --oneline</span><br><span class="line">git tag -a v1.00 -m &quot;描述&quot; b6195be</span><br></pre></td></tr></table></figure></li>
<li>查看tag：<code>git tag</code></li>
<li>删除tag：<code>git tag -d v1.00</code></li>
<li>删除github Tag：<code>git push origin :v1.00</code></li>
<li>提交github仓库：<code>git push origin v1.00</code></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>使用git同步一个fork</title>
    <url>/posts/how_to_update_fork_by_git.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>搭了个Hexo博客, 然后把NexT主题<a href="https://github.com/Ahaochan/hexo-theme-next">fork</a>了一下。<br>本文记录下从被fork的项目更新fork的操作。</p>
<span id="more"></span>

<h1 id="添加一个远程仓库"><a href="#添加一个远程仓库" class="headerlink" title="添加一个远程仓库"></a>添加一个远程仓库</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ git remote add upstream 原始项目地址  <span class="comment"># 添加一个名为upstream的远程项目</span></span><br><span class="line">$ git remote -v <span class="comment"># 查看远程仓库, origin是默认仓库名, 一般是自己的github项目</span></span><br><span class="line">  origin    https://github.com/YOUR_USERNAME/YOUR_FORK.git (fetch)</span><br><span class="line">  origin    https://github.com/YOUR_USERNAME/YOUR_FORK.git (push)</span><br><span class="line">  upstream  https://github.com/ORIGINAL_OWNER/ORIGINAL_REPOSITORY.git (fetch)</span><br><span class="line">  upstream  https://github.com/ORIGINAL_OWNER/ORIGINAL_REPOSITORY.git (push)</span><br></pre></td></tr></table></figure>

<h1 id="从原始项目同步"><a href="#从原始项目同步" class="headerlink" title="从原始项目同步"></a>从原始项目同步</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ git fetch upstream  <span class="comment"># 下载原始项目upstream的所有变动</span></span><br><span class="line">$ git checkout master <span class="comment"># 确保切换到本地master分支</span></span><br><span class="line">$ git merge upstream/master <span class="comment"># 合并upstream仓库的master分支到当前分支</span></span><br></pre></td></tr></table></figure>

<h1 id="解决冲突"><a href="#解决冲突" class="headerlink" title="解决冲突"></a>解决冲突</h1><p>一般可以自动解决冲突问题。<br>但是复杂的冲突就需要手动解决。</p>
<p><strong>直接编辑文件</strong><br>手动打开冲突的文件, 冲突的部分是<code>bbbbbbb</code>和<code>ccccccc</code>, 也就是特殊符号之间的字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">aaaaaaa</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD</span><br><span class="line">bbbbbbb</span><br><span class="line">=======</span><br><span class="line">ccccccc</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; ddddddd</span><br><span class="line">eeeeeee</span><br></pre></td></tr></table></figure>

<p><strong>图形界面</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ git mergetool <span class="comment"># 用预先配置的Beyond Compare解决冲突</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://gaohaoyang.github.io/2015/04/12/Syncing-a-fork/">同步一个 fork</a></li>
<li><a href="http://www.cnblogs.com/sinojelly/archive/2011/08/07/2130172.html">Git下的冲突解决</a></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Git</tag>
      </tags>
  </entry>
  <entry>
    <title>长城宽带拒退光猫押金</title>
    <url>/posts/The_Great_Wall_Broadband_refused_to_refund_the_deposit.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>长城宽带是真的坑, 没想到被我遇上了, 这里记录下。</p>
<span id="more"></span>

<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><p>2017年10月13日, 家里断网了, 我拨打长城宽带客服电话<code>95079</code>咨询, 得知我所在地在进行三线合一工程, 要求使用光猫才能上网。<br>不接光猫就上不了网。<br>行吧, 赶紧催长城宽带过来装光猫。</p>
<p>2017年10月14日, 长城宽带工作人员范某某<!-- 范杰彬 -->(工号<code>14041</code>, 现已离职), 来我家装光猫。<br>说要交<code>200</code>押金, 我就问交押金到时怎么退押金, 重点来了, 他说只要带<code>开户人身份证</code>和<code>开户人手机号</code>过去, 就可以退押金了。<br>于是在没有收到收据的情况下, 交给他<code>200</code>元光猫押金。</p>
<h1 id="口头承诺都是屁-白纸黑字才是理"><a href="#口头承诺都是屁-白纸黑字才是理" class="headerlink" title="口头承诺都是屁, 白纸黑字才是理"></a>口头承诺都是屁, 白纸黑字才是理</h1><p>2018年6月, 家里要换电信, 我去打电话准备办光猫退押金手续。<br>结果长城宽带就开始表演了, 说是后台查不到我的记录, 要我提供押金单, 但是这不存在的押金单根本没有给我。<br>打电话打了几天, 都是在扯皮, 一副你没有押金单, 就不给你退的嘴脸。</p>
<h1 id="投诉之路"><a href="#投诉之路" class="headerlink" title="投诉之路"></a>投诉之路</h1><ol>
<li>(失败) <a href="http://web.sicq.org/">深圳市消费者委员会消费维权公共服务平台</a>, 长城宽带要求我提供本不存在的单据才能退款, 和解失败。</li>
<li>(完结) 离职工作人员范某某联系我说愿意以<code>100</code>元回收光猫, 迫于没有单据证明, 只好妥协。</li>
</ol>
<h1 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h1><p>原价<code>200</code>的光猫最后只收到<code>100</code>元。</p>
<h1 id="人生经验"><a href="#人生经验" class="headerlink" title="人生经验"></a>人生经验</h1><p>以后做什么事, 无论是工作合同, 还是买卖东西, 银行取款什么的, 都要白纸黑字写的一清二楚, 不给的话就不弄。</p>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>生活</tag>
      </tags>
  </entry>
  <entry>
    <title>AJAX加载和SEO优化</title>
    <url>/posts/AJAX_loading_and_SEO.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>搜索引擎是不执行<code>JavaScript</code>的, 换言之, 搜索引擎和<code>AJAX</code>加载数据是水火不容的。<br>不过<a href="https://github.com/cssmagic/blog-old/issues/22">听说</a>谷歌的搜索引擎可以执行<code>AJAX</code>, 不愧是谷人希。</p>
<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>既然搜索引擎不能爬到<code>AJAX</code>数据, 那么只要将数据写到<code>JSP</code>中就可以了。<br>但是这样就失去了<code>AJAX</code>局部加载的功能。</p>
<p>搜索引擎是爬取链接的, 那么只要以下形式加载数据, 就可以兼顾搜索引擎和<code>AJAX</code>了。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- http://localhost:8080/blog-1 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">c:set</span> <span class="attr">var</span>=<span class="string">&quot;next&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;page+1&#125;&quot;</span>/&gt;</span><span class="comment">&lt;!-- JSP标签, next值为2 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/blog-$&#123;next&#125;&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ajaxBlog($&#123;next&#125;); return false;&quot;</span>&gt;</span>加载第$&#123;next&#125;页的blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在点击<code>&lt;a&gt;</code>标签的时候, 会执行以下顺序</p>
<ol>
<li>执行<code>onclick()</code>函数</li>
<li>执行<code>ajaxBlog()</code>函数加载下一页的博客</li>
<li><code>onclick()</code>函数<code>return false</code>拦截点击事件</li>
<li><code>href</code>链接跳转被拦截, 不执行</li>
</ol>
<p>数据加载就解决了, 但是又有个问题, 这个<code>&lt;a&gt;</code>标签也必须写在<code>JSP</code>中, 不能通过<code>JavaScript</code>生成, 因为搜索引擎不爬取<code>JavaScript</code>。<br>也就是说, 这个<code>&lt;a&gt;</code>标签, 分页器, 需要在<code>Java</code>代码拼接<code>Html</code>分页器。</p>
<p>分页器如下, 需要<code>Java</code>代码拼接<code>Html</code>, 传到<code>JSP</code>中。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/blog-1&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ajaxBlog(1); return false;&quot;</span>&gt;</span>加载第1页的blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/blog-2&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ajaxBlog(2); return false;&quot;</span>&gt;</span>加载第2页的blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/blog-3&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ajaxBlog(3); return false;&quot;</span>&gt;</span>加载第3页的blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/blog-4&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;ajaxBlog(4); return false;&quot;</span>&gt;</span>加载第4页的blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://zy116494718.iteye.com/blog/1685776">ajax对于seo的影响</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>SEO</tag>
        <tag>AJAX</tag>
      </tags>
  </entry>
  <entry>
    <title>BandwagonHost推广获取佣金</title>
    <url>/posts/How_to_get_Commission_of_Bandwagonhost.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>BandwagonHost</code>是一个国外的<code>VPS</code>网站, 可以做一些在国内做不了的事情。</p>
<span id="more"></span>

<h1 id="如何获取推广链接"><a href="#如何获取推广链接" class="headerlink" title="如何获取推广链接"></a>如何获取推广链接</h1><p>首先你要注册一个帐号, 注意资料尽量真实, 貌似搬瓦工会检测你的<code>IP</code>来判断你是否在欺诈他。<br>然后访问<a href="https://bandwagonhost.com/affiliates.php">自己的推广页面</a>。<br>可以看到一个推广链接, 下面是<a href="https://bandwagonhost.com/aff.php?aff=22459">我的推广链接</a></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://bandwagonhost.com/aff.php?aff=22459</span><br></pre></td></tr></table></figure>

<p>还可以看到各种统计的数据</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"></th>
</tr>
</thead>
<tbody><tr>
<td align="center">佣金百分比</td>
<td align="center">22%</td>
</tr>
<tr>
<td align="center">待定佣金</td>
<td align="center">$0.00 USD</td>
</tr>
<tr>
<td align="center">可提取佣金</td>
<td align="center">$0.00 USD</td>
</tr>
<tr>
<td align="center">支付总额</td>
<td align="center">$0.00 USD</td>
</tr>
</tbody></table>
<h2 id="获取单品推广链接"><a href="#获取单品推广链接" class="headerlink" title="获取单品推广链接"></a>获取单品推广链接</h2><p>但是上面的推广链接访问的是搬瓦工首页, 如果想直接推广某个<code>VPS</code>, 就需要自己写<code>url</code>。<br>比如最便宜的<code>10G VPS</code>, 它的<a href="https://bandwagonhost.com/cart.php?a=add&pid=43">商品链接</a>如下</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://bandwagonhost.com/cart.php?a=add&amp;pid=43</span><br></pre></td></tr></table></figure>
<p>我们只要在自己的推广链接后面加上<code>pid</code>参数即可。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://bandwagonhost.com/aff.php?aff=22459&amp;pid=43</span><br></pre></td></tr></table></figure>
<p>这样别人点你的推广链接, 并且购买成功, 你就可以获得一定比例的佣金, 比如上面写的<code>22%</code>。</p>
<h1 id="如何使用佣金"><a href="#如何使用佣金" class="headerlink" title="如何使用佣金"></a>如何使用佣金</h1><p>值得注意的是, 推广链接必须贴在<strong>网页</strong>上。不能私发, 不能<code>hack</code>别人。<br>在<a href="https://bandwagonhost.com/affiliates.php">affiliates</a>提交提现申请即可。<br>选择<code>To account balance (to be used to pay for services)</code>用于下次续费。</p>
<p>默认等个两三天就可以提现成功, 如果没有成功, 可以发个<a href="https://bandwagonhost.com/supporttickets.php">工单</a>。</p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>如果你是第一次购买, 可以使用下我的<a href="https://bandwagonhost.com/cart.php?a=add&pid=43">推广链接</a>支持下我, 感激不尽。</p>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>BandwagonHost</tag>
      </tags>
  </entry>
  <entry>
    <title>Chrome Slow network is detected.Fallback font will be used while loading</title>
    <url>/posts/Chrome_Slow_network_is_detected.Fallback_font_will_be_used_while_loading.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>升级<code>Chrome</code>后, 在<code>F12控制台</code>调试的时候, 经常会出现一堆代码。看起来也不是错误。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Slow network is detected. Fallback font will be used while loading: http://xxxxxxxx.woff</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="意义"><a href="#意义" class="headerlink" title="意义"></a>意义</h1><p>从字面意思上理解。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">检测到缓慢的网络请求。当加载http://xxxxxxx.woff时，回调字体将会被使用。</span><br></pre></td></tr></table></figure>
<p>就是当网络字体没加载完毕的时候, 页面会出现空白界面, 这对用户体验很不友好。Chrome正在用本地字体替换网页字体(使用<code>Css</code>的<code>@ font-face</code>规则加载）。</p>
<p>这是一个叫做<a href="https://developer.mozilla.org/zh-CN/docs/Web/CSS/@font-face">@font-face</a>的<a href="https://developer.mozilla.org/zh-CN/docs/CSS" title="CSS">CSS</a>  <a href="https://developer.mozilla.org/zh-CN/docs/CSS/At-rule" title="At-rule">@规则</a>, 它允许网页开发者为其网页指定在线字体, 避免对本地字库的依赖。</p>
<p>简单的说, 这是一个Chrome的<code>bug</code>, 只要加载网络字体, 就会提示这个信息。<br>但是这个信息对<strong>Web调试</strong>来说是噪音信息, 无用的信息。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>关闭这个提示。眼不见心不烦。<br>在地址栏输入<code>chrome://flags/#enable-webfonts-intervention-v2</code>, 选择<strong>Disable</strong>即可。<br>目前版本 61.0.3163.100, 尚未修复这个bug。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/40143098">why-does-this-slow-network-detected-log-appear-in-chrome</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>Chrome</tag>
      </tags>
  </entry>
  <entry>
    <title>GitHub删除敏感commit</title>
    <url>/posts/Delete_sensitive_submissions_in_Github.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>GitHub</code>上提交项目时, 有时会把密钥等敏感信息不小心提交上去, 这时候需要删除<code>commit</code>。而<code>GitHub</code>自身是不支持删除<code>commit</code>的, 需要借助<code>Git</code>来删除。</p>
<span id="more"></span>

<h1 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h1><p>打开一个文件夹, 在里面打开<code>Git</code>命令行。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. clone 整个项目</span></span><br><span class="line">$ git <span class="built_in">clone</span> 项目路径</span><br><span class="line"><span class="comment"># 2. 查看最近4条commit记录</span></span><br><span class="line">$ git <span class="built_in">log</span> -n 4</span><br><span class="line">commit abcdefg1234567 (HEAD -&gt; master, origin/master, origin/HEAD)</span><br><span class="line">Author: Ahaochan &lt;844394093@qq.com&gt;</span><br><span class="line">Date:   Wed Jan 3 09:06:34 2018 +0800</span><br><span class="line"><span class="comment"># 3. 根据commit-id回滚</span></span><br><span class="line">git reset --hard abcdefg1234567 </span><br><span class="line"><span class="comment"># 4. 强制push到GitHub上</span></span><br><span class="line">git push --force</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li>[5.2 代码回滚：Reset、Checkout、Revert 的选择](<a href="https://github.com/geeeeeeeeek/git-recipes/wiki/5.2">https://github.com/geeeeeeeeek/git-recipes/wiki/5.2</a> 代码回滚：Reset、Checkout、Revert 的选择)</li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>GitHub</tag>
      </tags>
  </entry>
  <entry>
    <title>Travis-CI加密变量</title>
    <url>/posts/Travis_CI_Encrypting_keys.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>原文: <a href="https://docs.travis-ci.com/user/encryption-keys/">Encryption keys</a></p>
<p><strong>这里有单独的关于<a href="https://docs.travis-ci.com/user/encrypting-files/">加密文件</a>的文档。</strong></p>
<p>仓库<code>Repository</code>中的<code>.travis.yml</code>文件可以具有“加密值”，例如<a href="https://docs.travis-ci.com/user/environment-variables/">环境变量</a>，通知设置和部署<code>api</code>的<code>key</code>。这些加密后的值可以由任何人添加，但只能由<code>Travis CI</code>解密读取。仓库<code>Repository</code>拥有者不保留任何加密<code>key</code>。</p>
<p><strong>请注意，加密的环境变量不适用于<a href="https://docs.travis-ci.com/user/pull-requests#Pull-Requests-and-Security-Restrictions">pull requests</a>。</strong></p>
<span id="more"></span>

<h1 id="加密方案"><a href="#加密方案" class="headerlink" title="加密方案"></a>加密方案</h1><p><code>Travis CI</code> 使用<strong>非对称密码学</strong>. 对于每个注册过的仓库<code>Repository</code>, <code>Travis CI</code> 会生成一对<code>RSA</code>密钥对.<br><code>Travis CI</code> 拥有私钥, 但是可以让每个人都可以使用该公钥. </p>
<p>例如, <code>GitHub</code>仓库<code>foo/bar</code> 的<strong>公钥</strong>可以在<code>https://api.travis-ci.org/repos/foo/bar/key</code>获取. 任何人都可以在任何仓库<code>Repository</code>运行<code>travis encrypt</code>, 使用<strong>公钥</strong>来加密参数.<br>因此, <code>foo/bar</code>的<strong>加密后的值</strong>可以被<code>Travis CI</code>使用<code>foo/bar</code>的<strong>私钥</strong>解密, 但这些<strong>加密后的值</strong>不能被任何人解密, 即使是加密这些值的人, 或者是仓库的拥有者, 任何人都不能解密.</p>
<h1 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h1><p>使用公钥加密某些东西的最简单方法是使用<code>Travis CLI</code>工具。 这个工具是用<code>Ruby</code>编写的，并以<code>gem</code>的形式发布。 首先，你需要安装gem：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 译者追加</span></span><br><span class="line">$ yum install -y gcc ruby ruby-devel <span class="comment"># 安装gcc和ruby环境</span></span><br><span class="line">$ gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/ <span class="comment"># 改为国内gem源</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原文</span></span><br><span class="line">$ gem install travis</span><br></pre></td></tr></table></figure>

<p>然后, 你可以使用<code>encrypt</code>命令去加密数据( 这个例子假设你的工作目录<code>pwd</code>是在仓库<code>Repository</code>下面, 如果不是, 请追加<code>-r 用户名/项目名</code> )</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 译者追加</span></span><br><span class="line">$ travis encrypt 变量名=<span class="string">&quot;待加密的值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原文</span></span><br><span class="line">$ travis encrypt SOMEVAR=<span class="string">&quot;secretvalue&quot;</span></span><br></pre></td></tr></table></figure>
<p>这将输出一个字符串，如下所示：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 译者追加</span></span><br><span class="line">secure: <span class="string">&quot;加密后的值&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 原文</span></span><br><span class="line">secure: <span class="string">&quot;.... encrypted data ....&quot;</span></span><br></pre></td></tr></table></figure>
<p>现在你可以把它放在<code>.travis.yml</code>文件中.<br>你也可以跳过上面的步骤, 直接追加参数<code>--add</code>, 自动添加到<code>.travis.yml</code>文件中.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt SOMEVAR=<span class="string">&quot;secretvalue&quot;</span> --add</span><br></pre></td></tr></table></figure>
<p>请注意，环境变量的名称及其值都由<code>travis encrypt</code>生成的字符串进行编码。您必须将生成的<code>secure: &quot;.... encrypted data ....&quot;</code>添加到您的<code>.travis.yml</code>中。这样您的程序就可以使用环境变量<code>SOMEVAR</code>。</p>
<p>您可以使用多个加密变量, 添加到您的<code>.travis.yml</code>文件中。它们都可用于您的程序。</p>
<p>加密后的值可用于<a href="https://docs.travis-ci.com/user/environment-variables#Defining-Variables-in-.travis.yml">secure environment variables in the build matrix</a> 和<a href="https://docs.travis-ci.com/user/notifications">notifications</a>.</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 译者追加</span></span><br><span class="line"><span class="comment"># .travis.yml</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">secure:</span> <span class="string">执行travis</span> <span class="string">encrypt得到的加密值</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">secure:</span> <span class="string">可以存在多个加密变量</span></span><br></pre></td></tr></table></figure>

<h2 id="关于转义某些符号的注意事项"><a href="#关于转义某些符号的注意事项" class="headerlink" title="关于转义某些符号的注意事项"></a>关于转义某些符号的注意事项</h2><p>当你使用<code>travis encrypt</code>去加密敏感数据时, 请注意<code>travis encrypt</code>将作为<code>bash</code>语句处理.<br>这意味着你正在加密的数据不能出现<code>bash</code>语法错误.<br>不完整的数据会导致<code>bash</code>将错误<code>statement </code>语句存储到日志文件中, 这个日志文件会包含你的敏感数据. 并且是明文显示.</p>
<p>所以你需要对<a href="(http://www.tldp.org/LDP/abs/html/special-chars.html">特殊字符</a>进行转义, 就像<code>&#123;&#125;</code>、<code>()</code>、<code>\</code>、<code>|</code>之类的特殊字符.</p>
<p>例如，当您想要将字符串<code>6&amp;a(5!1Ab\</code>分配到<code>FOO</code>变量中，您需要执行：</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt <span class="string">&quot;FOO=6\\&amp;a\\(5\\!1Ab\\\\&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>travis</code>加密了字符串<code>FOO=6\&amp;a\(5\!1Ab\\</code>,然后<code>bash</code>使用加密后的字符串在构建环境中<code>evaluate</code>.<br>你也可以这样做, 这和上面的加密语句等价.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt <span class="string">&#x27;FOO=6\&amp;a\(5\!1AB\\&#x27;</span></span><br></pre></td></tr></table></figure>

<h2 id="Notifications-例子"><a href="#Notifications-例子" class="headerlink" title="Notifications 例子"></a>Notifications 例子</h2><p>我们想要添加一个<code>campfire notifications</code>到<code>.travis.yml</code>文件中, 但是我们不想暴露我们的<code>API token</code>.<br>应该在<code>.travis.yml</code>中使用以下格式:</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="attr">campfire:</span></span><br><span class="line">    <span class="attr">rooms:</span> [<span class="string">subdomain</span>]<span class="string">:[api</span> <span class="string">token]@[room</span> <span class="string">id]</span></span><br></pre></td></tr></table></figure>
<p>举个例子, 比如<code>rooms: somedomain:abcxyz@14</code><br>我们加密这个字符串<code>somedomain:abcxyz@14</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt somedomain:abcxyz@14</span><br></pre></td></tr></table></figure>
<p>会输出以下内容</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">Please add the following to your .travis.yml file:</span></span><br><span class="line">  <span class="attr">secure:</span> <span class="string">&quot;ABC5OwLpwB7L6Ca....&quot;</span></span><br></pre></td></tr></table></figure>
<p>我们将其加入到<code>.travis.yml</code>文件中</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="attr">campfire:</span></span><br><span class="line">    <span class="attr">rooms:</span></span><br><span class="line">      <span class="attr">secure:</span> <span class="string">&quot;ABC5OwLpwB7L6Ca....&quot;</span></span><br></pre></td></tr></table></figure>
<p>这样就完成了</p>
<h2 id="详细讨论"><a href="#详细讨论" class="headerlink" title="详细讨论"></a>详细讨论</h2><p><strong>安全变量系统</strong>在配置<code>YAML</code>中采用<code>&#123; &#39;secure&#39; =&gt; &#39;encrypted string&#39; &#125;</code>形式的值，并将其替换为解密后的字符串。</p>
<p>所以会发生如下变化</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="attr">campfire:</span></span><br><span class="line">    <span class="attr">rooms:</span></span><br><span class="line">      <span class="attr">secure:</span> <span class="string">&quot;加密后的值&quot;</span></span><br><span class="line"><span class="comment"># 变成</span></span><br><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="attr">campfire:</span></span><br><span class="line">    <span class="attr">rooms:</span> <span class="string">&quot;解密后的值&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="attr">campfire:</span></span><br><span class="line">    <span class="attr">rooms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">secure:</span> <span class="string">&quot;加密后的值&quot;</span></span><br><span class="line"><span class="comment"># 变成</span></span><br><span class="line"><span class="attr">notifications:</span></span><br><span class="line">  <span class="attr">campfire:</span></span><br><span class="line">    <span class="attr">rooms:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;解密后的值&quot;</span></span><br></pre></td></tr></table></figure>
<p>如果是环境变量, 则会发生如下变化</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">secure:</span> <span class="string">&quot;加密后的值&quot;</span></span><br><span class="line"><span class="comment"># 变成</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;解密后的值&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="为您的仓库Repository获取公钥"><a href="#为您的仓库Repository获取公钥" class="headerlink" title="为您的仓库Repository获取公钥"></a>为您的仓库<code>Repository</code>获取公钥</h1><p>你可以通过<code>Travis API</code>获取公钥, 使用<code>/repos/用户名/仓库名/key</code>或者<code>/repos/:id/key</code>来获取公钥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">https://api.travis-ci.org/repos/travis-ci/travis-ci/key</span><br></pre></td></tr></table></figure>
<p>你也可以使用<code>travis pubkey</code>命令行获取公钥.<br>如果你不在项目文件夹下, 则使用<code>travis pubkey -r 用户名/项目名</code>获取指定项目的公钥.</p>
<p>请注意, <code>Travis</code>在您的项目中使用<code>travis.slug</code>来确定端点是否存在（通过使用<code>git config --local travis.slug</code>来检查), 如果您重命名您的仓库或将您的仓库移动到另一个用户/组织，则可能需要对其进行更改。</p>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>Travis-CI</tag>
        <tag>翻译</tag>
      </tags>
  </entry>
  <entry>
    <title>Travis-CI加密文件</title>
    <url>/posts/Travis_CI_Encrypting_Files.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>原文: <a href="https://docs.travis-ci.com/user/encrypting-files/">Encrypting Files</a></p>
<p><strong>请注意，加密文件不适用于<a href="https://docs.travis-ci.com/user/pull-requests#Pull-Requests-and-Security-Restrictions">pull requests from forks</a>。</strong></p>
<span id="more"></span>

<h1 id="先决条件"><a href="#先决条件" class="headerlink" title="先决条件"></a>先决条件</h1><ul>
<li>  安装 Travis CI <a href="https://github.com/travis-ci/travis.rb#readme">命令行客户端</a></li>
<li>  使用<code>$ travis login</code>或者<code>$ travis login --pro</code><a href="https://github.com/travis-ci/travis.rb#login">登录</a> 到 Travis CI </li>
</ul>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 译者追加</span></span><br><span class="line">$ yum install -y gcc ruby ruby-devel <span class="comment"># 安装gcc和ruby环境</span></span><br><span class="line">$ gem sources --add https://gems.ruby-china.org/ --remove https://rubygems.org/ <span class="comment"># 改为国内gem源</span></span><br><span class="line">$ gem install travis</span><br><span class="line">$ travis login</span><br></pre></td></tr></table></figure>
<p>有关系统所需版本的<code>Ruby</code>和操作系统的更多信息，请参阅命令行客户端<a href="https://github.com/travis-ci/travis.rb#installation">安装说明</a>。</p>
<h1 id="自动加密"><a href="#自动加密" class="headerlink" title="自动加密"></a>自动加密</h1><p>假设:</p>
<ul>
<li>  这个仓库设置在了<code>Travis CI</code>上</li>
<li>  你安装了<strong>1.7.0</strong>以上版本的<code>Travis CI</code>命令行客户端, 并成功登录<code>Travis CI</code></li>
<li>  你<code>clone</code>了仓库到本地, 并且工作目录<code>pwd</code>在该本地仓库下</li>
<li>  你在仓库中有一个名为<code>super_secret.txt</code>的文件, 你想要在<code>Travis CI</code>使用这个文件，但你不想在<code>GitHub</code>上公开这个文件的内容。</li>
</ul>
<p><code>travis encrypt-file</code>命令将使用对称加密(AES-256)为你加密文件, 并将密钥存储在<code>secure</code>变量中。<br><code>travis encrypt-file</code>命令将输出以下命令, 你可以在你的构建脚本中解密这个文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt-file super_secret.txt</span><br><span class="line">encrypting super_secret.txt <span class="keyword">for</span> rkh/travis-encrypt-file-example</span><br><span class="line">storing result as super_secret.txt.enc</span><br><span class="line">storing secure <span class="built_in">env</span> variables <span class="keyword">for</span> decryption</span><br><span class="line"><span class="comment"># 请将以下内容添加到您的构建脚本中(例如，在`.travis.yml`中的`before_install`阶段)：</span></span><br><span class="line">openssl aes-256-cbc -K <span class="variable">$encrypted_0a6446eb3ae3_key</span> -iv <span class="variable">$encrypted_0a6446eb3ae3_iv</span> -<span class="keyword">in</span> super_secret.txt.enc -out super_secret.txt -d</span><br><span class="line"><span class="comment"># 提示: 你可以添加 `--add` 选项让它自动添加到`.travis.yml`.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保添加 super_secret.txt.enc 到你的 git 仓库</span></span><br><span class="line"><span class="comment"># 确保不要添加 super_secret.txt 到你的 git 仓库</span></span><br><span class="line"><span class="comment"># 提交你的`.travis.yml`</span></span><br></pre></td></tr></table></figure>
<p>您也可以使用<code>--add</code>选项自动将解密命令添加到您的<code>.travis.yml</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt-file super_secret.txt --add</span><br><span class="line">encrypting super_secret.txt <span class="keyword">for</span> rkh/travis-encrypt-file-example</span><br><span class="line">storing result as super_secret.txt.enc</span><br><span class="line">storing secure <span class="built_in">env</span> variables <span class="keyword">for</span> decryption</span><br><span class="line"></span><br><span class="line">确保添加 super_secret.txt.enc 到你的 git 仓库</span><br><span class="line">确保不要添加 super_secret.txt 到你的 git 仓库</span><br><span class="line">提交你的`.travis.yml`</span><br></pre></td></tr></table></figure>

<h2 id="加密多个文件"><a href="#加密多个文件" class="headerlink" title="加密多个文件"></a>加密多个文件</h2><p>直接加密多个文件会有<code>bug</code>，命令行客户端将会<a href="https://github.com/travis-ci/travis.rb/issues/239">覆盖前一个加密文件</a>。</p>
<p>如果您需要加密多个文件，请首先创建敏感文件的<strong>压缩包</strong>，然后在构建期间将其解密并解压.<br>假设我们有敏感文件<code>foo</code>和<code>bar</code>, 运行以下命令.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ tar cvf secrets.tar foo bar</span><br><span class="line">$ travis encrypt-file secrets.tar</span><br><span class="line">$ vi .travis.yml</span><br><span class="line">$ git add secrets.tar.enc .travis.yml</span><br><span class="line">$ git commit -m <span class="string">&#x27;use secret archive&#x27;</span></span><br><span class="line">$ git push</span><br></pre></td></tr></table></figure>

<p>然后在<code>.travis.yml</code>中添加解密步骤, 根据你的需求调整<code>$*_key</code> 和<code>$*_iv</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">before_install:</span><br><span class="line">  - openssl aes-256-cbc -K $encrypted_5880cf525281_key -iv $encrypted_5880cf525281_iv -in secrets.tar.enc -out secrets.tar -d</span><br><span class="line">  - tar xvf secrets.tar</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="警告"><a href="#警告" class="headerlink" title="警告"></a>警告</h2><p>这个函数在本地<code>Windows</code>机器上不起作用。 请使用<code>WSL</code>(适用于<code>Linux</code>的<code>Windows</code>子系统)或<code>Linux</code>或<code>OS X</code>操作系统。</p>
<h1 id="手动加密"><a href="#手动加密" class="headerlink" title="手动加密"></a>手动加密</h1><p>假设:</p>
<ul>
<li>  这个仓库设置在了<code>Travis CI</code>上</li>
<li>  你安装了<strong>1.7.0</strong>以上版本的`Travis CI命令行客户端, 并成功登录</li>
<li>  你<code>clone</code>了仓库到本地, 并且工作目录<code>pwd</code>在该本地仓库下</li>
<li>  你在仓库中有一个名为<code>super_secret.txt</code>的文件, 你想要在<code>Travis CI</code>使用这个文件，但你不想在<code>GitHub</code>上公开这个文件的内容。</li>
</ul>
<p>该文件可能<strong>太大</strong>，无法通过<code>travis encrypt</code>命令直接加密。<br>但是，您可以使用密码来加密文件，然后再加密这个密码。在Travis CI上，您可以使用密码解密这个文件。</p>
<p>设置过程如下所示：</p>
<ol>
<li> <strong>创建密码</strong>。首先，你需要一个密码。我们建议使用<code>pwgen</code>或<code>1password</code>等工具生成随机密码。在我们的例子中，我们将使用<code>ahduQu9ushou0Roh</code>作为密码。</li>
<li> <strong>加密这个密码并添加到.travis.yml</strong>。这里我们可以使用这个加密命令: <code>travis encrypt super_secret_password=ahduQu9ushou0Roh --add</code>, 注意，如果你有多个文件需要手动加密, 你必须使用不同的变量名, 这样密码就不会相互覆盖。</li>
<li> <strong>本地加密文件</strong>。使用你已经安装在本地的工具<code>GPG</code>或<code>OpenSSL</code>，它也安装在<code>Travis CI</code>上(见下文)。</li>
<li> <strong>设置解密命令</strong>。您应该将用于解密文件的命令添加到<code>.travis.yml</code>的<code>before_install</code>阶段（请参阅下文）。<br>确保添加<code>super_secret.txt</code>到你的<code>.gitignore</code>文件中, 并提交你的<code>加密后的文件</code>和<code>.travis.yml</code>.</li>
</ol>
<h2 id="使用GPG加密"><a href="#使用GPG加密" class="headerlink" title="使用GPG加密"></a>使用GPG加密</h2><p>设置:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt super_secret_password=ahduQu9ushou0Roh --add</span><br><span class="line">$ gpg -c super_secret.txt</span><br><span class="line">(将提示您输入密码两次，使用与上述super_secret_password相同的值)</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .travis.yml</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">secure:</span> <span class="string">加密后的值</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">echo</span> <span class="string">$super_secret_password</span> <span class="string">|</span> <span class="string">gpg</span> <span class="string">--passphrase-fd</span> <span class="number">0</span> <span class="string">super_secret.txt.gpg</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>加密的文件名为<code>super_secret.txt.gpg</code>, 并且必须被提交到仓库。</p>
<h2 id="使用OpenSSL"><a href="#使用OpenSSL" class="headerlink" title="使用OpenSSL"></a>使用OpenSSL</h2><p>设置:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ travis encrypt super_secret_password=ahduQu9ushou0Roh --add</span><br><span class="line">$ openssl aes-256-cbc -k <span class="string">&quot;ahduQu9ushou0Roh&quot;</span> -<span class="keyword">in</span> super_secret.txt -out super_secret.txt.enc</span><br><span class="line">(记住用适当的值替换密码)</span><br></pre></td></tr></table></figure>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .travis.yml</span></span><br><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="attr">global:</span></span><br><span class="line">    <span class="attr">secure:</span> <span class="string">加密后的值</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="string">-k</span> <span class="string">&quot;$super_secret_password&quot;</span> <span class="string">-in</span> <span class="string">super_secret.txt.enc</span> <span class="string">-out</span> <span class="string">super_secret.txt</span> <span class="string">-d</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>加密的文件名为<code>super_secret.txt.enc</code>, 并且必须被提交到仓库。</p>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>Travis-CI</tag>
        <tag>翻译</tag>
      </tags>
  </entry>
  <entry>
    <title>XML语法详解</title>
    <url>/posts/XML_syntax.html</url>
    <content><![CDATA[<h1 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h1><p>目前<code>XML</code>有<code>1.0</code>和<code>1.1</code>两个版本，但是<code>1.1</code>不向下兼容，常用的是<code>1.0</code>版本<br>只能有一个根标签元素</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">person</span>&gt;</span><span class="tag">&lt;/<span class="name">person</span>&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h1 id="CDATA区"><a href="#CDATA区" class="headerlink" title="CDATA区"></a>CDATA区</h1><p>语法<code>&lt;![CDATA[内容]]&gt;</code>，解决频繁转义字符的问题，当成文本内容</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">person</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">code</span>&gt;</span>&lt;![CDATA[(1&lt;2)&amp;&amp;(2&lt;3)?true:false;]]&gt;<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">person</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="PI指令设置XML样式"><a href="#PI指令设置XML样式" class="headerlink" title="PI指令设置XML样式"></a>PI指令设置XML样式</h1><p>语法<code>&lt;?xml-stylesheet type=&quot;text/css&quot; href=&quot;test.css&quot;?&gt;</code><br>将<code>css</code>样式应用于<code>XML</code>文档</p>
<h1 id="xml约束"><a href="#xml约束" class="headerlink" title="xml约束"></a>xml约束</h1><p>限制xml中出现的标签名</p>
<h2 id="dtd约束"><a href="#dtd约束" class="headerlink" title="dtd约束"></a>dtd约束</h2><h3 id="dtd引入方式"><a href="#dtd引入方式" class="headerlink" title="dtd引入方式"></a>dtd引入方式</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE 根元素名 <span class="keyword">SYSTEM</span> <span class="string">&quot;dtd路径&quot;</span>&gt;</span>                <span class="comment">&lt;!--第一种，外部引用本地dtd--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE 根元素名 [约束内容]&gt;</span>                      <span class="comment">&lt;!--第二种，内部引用dtd--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE 根元素名 <span class="keyword">PUBLIC</span> <span class="string">&quot;dtd名称&quot;</span> <span class="string">&quot;dtd的url路径&quot;</span>&gt;</span> <span class="comment">&lt;!--第三种，外部引用网络dtd--&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="dtd语法"><a href="#dtd语法" class="headerlink" title="dtd语法"></a>dtd语法</h3><p>先创建一个<code>DTD</code>文件<code>personDTD.dtd</code>，</p>
<ol>
<li>元素的语法格式为<code>&lt;!ELEMENT 元素名 ([子元素名|#PCDATA|EMPTY|ANY])(+|*|?)&gt;</code></li>
<li>属性的语法格式为<code>&lt;!ATTLIST 元素名 属性名 属性类型 约束&gt;</code></li>
<li>实体的语法格式为<code>&lt;!ENTITY 实体名 实体值&gt;</code></li>
</ol>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--定义元素-&gt;</span></span><br><span class="line"><span class="comment">&lt;!ELEMENT person (name+, age?)&gt;&lt;!--含有子元素的元素，+出现不少于一次，？出现不多于一次，*出现任意多次--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="keyword">person</span> (<span class="keyword">name</span> | <span class="keyword">age</span>)&gt;</span><span class="comment">&lt;!--含有子元素的元素，表示只能出现一个nama或者age</span></span><br><span class="line"><span class="comment">&lt;!ELEMENT name (#PCDATA)&gt;&lt;!--不含有子元素的元素--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="keyword">isMan</span> <span class="keyword">EMPTY</span>&gt;</span><span class="comment">&lt;!--不含有内容的元素--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ELEMENT <span class="keyword">school</span> <span class="keyword">ANY</span>&gt;</span><span class="comment">&lt;!--任意的元素--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--定义属性--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ATTLIST <span class="keyword">name</span> <span class="keyword">nameAttr</span> <span class="keyword">CDATA</span> <span class="keyword">#REQUIRED</span>  &lt;!--CDATA是字符串，#REQUIRED是必须出现--&gt;</span></span><br><span class="line">               pid ID #REQUIRED          <span class="comment">&lt;!--ID是只能字母和下划线开头--&gt;</span></span><br><span class="line">               sex CDATA &quot;男&quot;            <span class="comment">&lt;!--直接在后面加上字符串，表示默认值--&gt;</span></span><br><span class="line">&gt;     </span><br><span class="line"><span class="meta">&lt;!ATTLIST <span class="keyword">food</span> <span class="keyword">like</span> (苹果|香蕉|橘子) <span class="keyword">#IMPLIED</span>&gt;</span> <span class="comment">&lt;!--枚举，#IMPLIED是可有可无--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ATTLIST <span class="keyword">school</span> <span class="keyword">CDATA</span> <span class="keyword">#FIXED</span> <span class="string">&quot;学校&quot;</span>&gt;</span>         <span class="comment">&lt;!--固定值，#FIXED只能选择固定属性值--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!--定义实体--&gt;</span></span><br><span class="line"><span class="meta">&lt;!ENTITY <span class="keyword">copyright</span> <span class="string">&quot;版权所有不得抄袭&quot;</span>&gt;</span><span class="comment">&lt;!--在xml中可用&amp;copyright;引用该实体--&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">person</span> <span class="keyword">SYSTEM</span> <span class="string">&quot;personDTD.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">person</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>张三<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">age</span>&gt;</span>20<span class="tag">&lt;/<span class="name">age</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;error&gt;编译出错&lt;/error&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">person</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="schema约束"><a href="#schema约束" class="headerlink" title="schema约束"></a>schema约束</h2><p><code>schema</code>是<code>xml</code>格式的一个约束文件。<br>需要先在命名空间引入<code>http://www.w3.org/2001/XMLSchema</code>，在<code>targetNamespace</code>中定义<code>schema</code>的引用地址名，用于在<code>xml</code>文件中引入。<br>和<code>xml</code>文件类似，每个子元素都在父元素之中。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">schema</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">targetNamespace</span>=<span class="string">&quot;http://mySchemaUrl&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">elementFormDefault</span>=<span class="string">&quot;qualified&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">element</span> <span class="attr">name</span>=<span class="string">&quot;store&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">complexType</span>&gt;</span><span class="comment">&lt;!--表示store元素有子元素--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sequence</span>&gt;</span><span class="comment">&lt;!--子元素严格按顺序显示--&gt;</span></span><br><span class="line"></span><br><span class="line">                <span class="tag">&lt;<span class="name">element</span> <span class="attr">name</span>=<span class="string">&quot;book&quot;</span> <span class="attr">maxOccurs</span>=<span class="string">&quot;unbounded&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">complexType</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">sequence</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">element</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;string&quot;</span> <span class="attr">maxOccurs</span>=<span class="string">&quot;unbounded&quot;</span>/&gt;</span><span class="comment">&lt;!--maxOccurs表示元素出现次数--&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">sequence</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">attribute</span> <span class="attr">name</span>=<span class="string">&quot;id&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span> <span class="attr">use</span>=<span class="string">&quot;required&quot;</span>/&gt;</span><span class="comment">&lt;!--book的属性，必须在最后声明--&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">complexType</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">element</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">sequence</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">complexType</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">element</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">schema</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>xml</code>中引入时，先引入别名为<code>xsi</code>的<code>http://www.w3.org/2001/XMLSchema-instance</code>命名空间，<br>再引入自定义<code>schema</code>的引用地址，及<code>schema</code>文件名</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">store</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns</span>=<span class="string">&quot;http://mySchemaUrl&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://mySchemaUrl 1.xsd&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">book</span> <span class="attr">id</span>=<span class="string">&quot;01&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>第一本书<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">book</span> <span class="attr">id</span>=<span class="string">&quot;02&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>第二本书<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>第三本书<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">store</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>XML</tag>
      </tags>
  </entry>
  <entry>
    <title>二进制的原码，反码，补码，移码之间的相互转换</title>
    <url>/posts/true_code,_ones-complement_code,_complemental_code,_shift_code.html</url>
    <content><![CDATA[<p>二进制最高位为符号位，<code>0</code>为正数，<code>1</code>为负数。<br>正数的原码和反码和补码一致。<br>负数的反码 = 原码除了最高位（符号位）全部取反。<br>负数的补码 = 反码+1。</p>
<span id="more"></span>

<p>移码 = 补码的最高位（符号位）取反。</p>
<p><code>-0</code>原码:<code>1000 0000</code><br><code>-0</code>反码:<code>1111 1111</code><br><code>-0</code>补码:<code>0000 0000</code><br><code>-0</code>移码:<code>1000 0000</code></p>
<p><code>+0</code>原码:<code>0000 0000</code><br><code>+0</code>反码:<code>0000 0000</code>(正数反码和原码相同)<br><code>+0</code>补码:<code>0000 0000</code>(正数补码和原码相同)<br><code>+0</code>移码:<code>1000 0000</code></p>
<p><code>-1</code>原码:<code>1000 0001</code><br><code>-1</code>反码:<code>1111 1110</code><br><code>-1</code>补码:<code>1111 1111</code><br><code>-1</code>移码:<code>0111 1111</code></p>
<p><code>+1</code>原码:<code>0000 0001</code><br><code>+1</code>反码:<code>0000 0001</code>(正数反码和原码相同)<br><code>+1</code>补码:<code>0000 0001</code>(正数补码和原码相同)<br><code>+1</code>移码:<code>1000 0001</code></p>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>二进制</tag>
      </tags>
  </entry>
  <entry>
    <title>分布式系统中的CAP理论</title>
    <url>/posts/cap_theorem.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><ul>
<li>2020-02-06: 初版</li>
<li>2020-04-07: 阅读<a href="http://gk.link/a/10hoK">从0开始学架构-想成为架构师，你必须知道CAP理论</a>后觉得还有不足之处, 于是再次修改.</li>
</ul>
<p>一个分布式系统, 我们要关注的是它的可用性、一致性、分区容错性</p>
<ol>
<li><strong>C</strong>onsistency 一致性</li>
<li><strong>A</strong>vailability 可用性</li>
<li><strong>P</strong>artition tolerance 分区容错性</li>
</ol>
<span id="more"></span>

<h1 id="什么样的系统适合CAP理论"><a href="#什么样的系统适合CAP理论" class="headerlink" title="什么样的系统适合CAP理论"></a>什么样的系统适合CAP理论</h1><p>在了解什么是<code>CAP</code>之前, 我们先来看看什么样的系统适合CAP理论.</p>
<p>从<strong>参考资料</strong>里的所有英文文章得知</p>
<ol>
<li><a href="https://www.teamsilverback.com/understanding-the-cap-theorem/"><code>Silverback</code></a>提到<code>A distributed system (generally running in a datacenter)</code>.</li>
<li><a href="https://en.wikipedia.org/wiki/CAP_theorem#cite_note-Brewer2012-6"><code>Wikipedia</code></a>提到<code>A distributed data store</code>.</li>
<li><a href="https://cloud.ibm.com/docs/services/Cloudant/guides?topic=cloudant-cap-theorem&locale=en#cap-"><code>IBM</code></a>只提到了<code>a distributed computer system</code>.</li>
<li><a href="https://robertgreiner.com/cap-theorem-revisited/"><code>Robert Greiner</code></a>一开始提到<a href="https://robertgreiner.com/cap-theorem-explained/"><code>any distributed system</code></a>, 两个月后重新定义为<a href="https://robertgreiner.com/cap-theorem-revisited/"><code>In a distributed system (a collection of interconnected nodes that share data.)</code></a></li>
</ol>
<p>大家都认为, 分布式系统才适合<code>CAP</code>理论, 但是, 不是所有分布式系统都适合.<br><a href="https://robertgreiner.com/cap-theorem-revisited/"><code>Robert Greiner</code></a>强调了这个分布式系统是<code>interconnected</code>互联和<code>share data</code>共享数据的.</p>
<p>举一个反例, 比如<code>Memcache</code>集群.<br><img data-src="https://yuml.me/diagram/nofunky/class/[%E5%AE%A2%E6%88%B7%E7%AB%AF]-1%E5%88%B0100%3E[Memcache_Server_1],[%E5%AE%A2%E6%88%B7%E7%AB%AF]-101%E5%88%B0200%3E[Memcache_Server_2]" alt="Memcache集群"><br><code>Memcache</code>的各个节点之间是不互联和共享数据的, 客户端根据路由规则, 自行决定存储数据到哪个节点上.<br>这确实是一个分布式系统, 但是却不适用于<code>CAP</code>理论.</p>
<p>举一个正例, 比如<code>MySQL</code>集群.<br><code>MySQL</code>我们熟, 主从复制, 就是<code>interconnected</code>和<code>share data</code>.</p>
<blockquote>
<p>In a distributed system (a collection of interconnected nodes that share data.)</p>
</blockquote>
<p>所以这里还是以<a href="https://robertgreiner.com/cap-theorem-revisited/"><code>Robert Greiner</code></a>的文章为准, 一个互联且共享数据的节点集合, 才是适用<code>CAP</code>的分布式系统. </p>
<h1 id="什么是CAP"><a href="#什么是CAP" class="headerlink" title="什么是CAP"></a>什么是CAP</h1><p>我们假设一个分布式系统有<code>4</code>个终端, 数据库<code>DB1</code>和<code>DB2</code>以及应用端<code>App1</code>和<code>App2</code>.<br><img data-src="https://yuml.me/diagram/nofunky/class/[DB1]-%3E[App1],[DB2]-%3E[App1],[DB1]-%3E[App2],[DB2]-%3E[App2]" alt="分布式系统"><br>假设有数据<code>a=1</code></p>
<h2 id="C-一致性"><a href="#C-一致性" class="headerlink" title="C 一致性"></a>C 一致性</h2><p>从<strong>参考资料</strong>里的所有英文文章得知</p>
<ol>
<li><a href="https://www.teamsilverback.com/understanding-the-cap-theorem/"><code>Silverback</code></a>提到<code>all nodes have access to the same data simultaneously</code>.</li>
<li><a href="https://en.wikipedia.org/wiki/CAP_theorem#cite_note-Brewer2012-6"><code>Wikipedia</code></a>提到<code>Every read receives the most recent write or an error</code>.</li>
<li><a href="https://cloud.ibm.com/docs/services/Cloudant/guides?topic=cloudant-cap-theorem&locale=en#cap-"><code>IBM</code></a>提到<code>where all nodes see the same data at the same time</code>.</li>
<li><a href="https://robertgreiner.com/cap-theorem-revisited/"><code>Robert Greiner</code></a>一开始提到<a href="https://robertgreiner.com/cap-theorem-explained/"><code>All nodes see the same data at the same time.</code></a>, 两个月后重新定义为<a href="https://robertgreiner.com/cap-theorem-revisited/"><code>A read is guaranteed to return the most recent write for a given client.</code></a></li>
</ol>
<p>在客户端看来, 每次读都要能读到最新写入的数据.<br>举个例子, 如果<code>App1</code>往<code>DB1</code>写入数据<code>a=2</code>, 然后从<code>APP2</code>读<code>DB2</code>得到数据<code>a=2</code>, 对于客户端来说, <code>DB1</code>和<code>DB2</code>的数据保持一致.</p>
<p>但是实际情况下, 对于这个<strong>最新写入</strong>的理解, 是不同的.<br>同一时刻, 不同节点可能拥有不同的最新数据.<br>我举个例子, 在事务执行过程中, 不同的节点的数据并不完全一致.</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center"><code>App1</code></th>
<th align="center"><code>App2</code></th>
</tr>
</thead>
<tbody><tr>
<td align="center"></td>
<td align="center"><code>start transaction</code></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>update t set a = 2</code></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">t1</td>
<td align="center"></td>
<td align="center"><code>select a from t</code>(a=1)</td>
</tr>
<tr>
<td align="center">t2</td>
<td align="center"><code>select a from t</code>(a=2)</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"><code>commit</code></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">t3</td>
<td align="center"></td>
<td align="center"><code>select a from t</code>(a=2)</td>
</tr>
</tbody></table>
<p><code>t1</code>和<code>t2</code>时刻, <code>App1</code>能读到最新写入的<code>a=2</code>的数据. <code>App2</code>能读到最新写入的<code>a=1</code>的数据.<br>此时, <code>App1</code>的事务还没有提交, 对于<code>App2</code>来说, <code>App1</code>的写入的数据是感知不到的, <code>App2</code>的最新数据还是<code>a=1</code>.<br>等到<code>t3</code>时刻, <code>App1</code>提交事务后, <code>App2</code>才能读到最新的<code>a=2</code>.</p>
<p>如果<code>App1</code>的事务回滚了, 那么<code>App2</code>是不知道<code>a=2</code>这个事件发生过的.</p>
<h2 id="A-可用性"><a href="#A-可用性" class="headerlink" title="A 可用性"></a>A 可用性</h2><p>从<strong>参考资料</strong>里的所有英文文章得知</p>
<ol>
<li><a href="https://www.teamsilverback.com/understanding-the-cap-theorem/"><code>Silverback</code></a>提到<code>a promise that every request receives a response, at minimum whether the request succeeded or failed</code>.</li>
<li><a href="https://en.wikipedia.org/wiki/CAP_theorem#cite_note-Brewer2012-6"><code>Wikipedia</code></a>提到<code>Every request receives a (non-error) response, without the guarantee that it contains the most recent write</code>.</li>
<li><a href="https://cloud.ibm.com/docs/services/Cloudant/guides?topic=cloudant-cap-theorem&locale=en#cap-"><code>IBM</code></a>提到<code>which guarantees that every request receives a response about whether it succeeded or failed.</code>.</li>
<li><a href="https://robertgreiner.com/cap-theorem-revisited/"><code>Robert Greiner</code></a>一开始提到<a href="https://robertgreiner.com/cap-theorem-explained/"><code>Every request gets a response on success/failure.</code></a>, 两个月后重新定义为<a href="https://robertgreiner.com/cap-theorem-revisited/"><code>A non-failing node will return a reasonable response within a reasonable amount of time (no error or timeout).</code></a></li>
</ol>
<p><code>Silverback</code>、<code>IBM</code>和<code>Robert Greiner</code>都认为只要每个请求能收到响应, 无论是成功还是失败, 就算满足可用性.<br><code>Robert Greiner</code>的第二篇文章和<code>Wikipedia</code>则认为请求要返回合理的成功的响应, 无论数据对错. 也就是说, 可用性的定义更严格一点.</p>
<p>我个人赞同第二种观点, 成功和失败的定义太广泛. 请求超时、错误也算失败的响应, 但这算可用吗? 我认为是不可用的.<br>比如<code>App1</code>读取<code>DB1</code>的数据</p>
<ol>
<li>得到正确的数据<code>a=1</code>, <code>DB1</code>是可用的.</li>
<li>得到错误的数据<code>a=111</code>, <code>DB1</code>是可用的.</li>
<li>得到<code>connection timeout</code>, <code>DB1</code>是不可用的.</li>
</ol>
<h2 id="P-分区容错性"><a href="#P-分区容错性" class="headerlink" title="P 分区容错性"></a>P 分区容错性</h2><p>从<strong>参考资料</strong>里的所有英文文章得知</p>
<ol>
<li><a href="https://www.teamsilverback.com/understanding-the-cap-theorem/"><code>Silverback</code></a>提到<code>the system will continue to work even if some arbitrary node goes offline or can’t communicate</code>.</li>
<li><a href="https://en.wikipedia.org/wiki/CAP_theorem#cite_note-Brewer2012-6"><code>Wikipedia</code></a>提到<code>The system continues to operate despite an arbitrary number of messages being dropped (or delayed) by the network between nodes</code>.</li>
<li><a href="https://cloud.ibm.com/docs/services/Cloudant/guides?topic=cloudant-cap-theorem&locale=en#cap-"><code>IBM</code></a>提到<code>where the system continues to operate even if any one part of the system is lost or fails.</code>.</li>
<li><a href="https://robertgreiner.com/cap-theorem-revisited/"><code>Robert Greiner</code></a>一开始提到<a href="https://robertgreiner.com/cap-theorem-explained/"><code>System continues to work despite message loss or partial failure.</code></a>, 两个月后重新定义为<a href="https://robertgreiner.com/cap-theorem-revisited/"><code>The system will continue to function when network partitions occur.</code></a></li>
</ol>
<p>分区容错性就是当网络发生分区的时候, 集群能够继续完成工作, 返回合理的成功的响应.<br>网络分区是一种现象, 举个例子, 就是<code>DB1</code>和<code>DB2</code>之间的通信断了, 主从复制失败.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>C</code>: 对客户端来说, 读操作保证能够返回最新的写操作结果. 这就是一致性.<br><code>A</code>: 对客户端来说, 非故障的节点在合理的时间内返回合理的响应, 不是错误和超时的响应. 这就是可用性<br><code>P</code>: 对集群来说, 当出现网络分区后, 系统能够继续返回合理的响应. 这就是分区容错性</p>
<h1 id="那么CAP能同时做到吗"><a href="#那么CAP能同时做到吗" class="headerlink" title="那么CAP能同时做到吗?"></a>那么<code>CAP</code>能同时做到吗?</h1><p>正常情况下是可以的, 我们说的只能三选二的情况一般都是网络故障的时候, 才会进行取舍.<br>还是以这张图为例<br><img data-src="https://yuml.me/diagram/nofunky/class/[DB1]-%3E[App1],[DB2]-%3E[App1],[DB1]-%3E[App2],[DB2]-%3E[App2]" alt="分布式系统"><br>因为网络的不可靠性, **<code>P</code><strong>分区容错性是一定要保证的.<br>那么当<code>DB1</code>和<code>DB2</code>之间的网络发生故障, 此时就要对</strong><code>AC</code>**进行取舍.</p>
<ol>
<li>保障**<code>A</code>**, <code>App</code>能正常读写<code>DB1</code>和<code>DB2</code>, 但是一旦进行了写入操作, <code>DB1</code>和<code>DB2</code>是不能进行通信做主从复制的, 换句话说, 就会导致数据不一致的情况.</li>
<li>保障**<code>C</code>**, 那么为了保证数据一致性, <code>App</code>就应该等待<code>DB1</code>和<code>DB2</code>之间的网络恢复, 这样就不能访问数据库了, 舍弃了可用性.</li>
</ol>
<p>那有人问, 能不能只保证**<code>AC</code><strong>?<br>可以啊, 我们把两个数据库都放在一台服务器上, 这样就不会因为网络分区导致</strong><code>AC</code>**二选一的问题了, 因为根本没有网络.<br>但是这还能叫做分布式吗?</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://mwhittaker.github.io/blog/an_illustrated_proof_of_the_cap_theorem/">An Illustrated Proof of the CAP Theorem</a></li>
<li><a href="https://console.bluemix.net/docs/services/Cloudant/guides/cap_theorem.html#cap-">IBM CAP 定理</a></li>
<li><a href="https://en.wikipedia.org/wiki/CAP_theorem#cite_note-Brewer2012-6">Wiki CAP theorem</a></li>
<li><a href="https://www.teamsilverback.com/understanding-the-cap-theorem/">Understanding the CAP Theorem</a></li>
<li><a href="https://stackoverflow.com/a/12347673">cap-theorem-availability-and-partition-tolerance</a></li>
<li><a href="https://robertgreiner.com/cap-theorem-revisited/">cap-theorem-revisited</a></li>
<li>[cap-theorem-explained][<a href="https://robertgreiner.com/cap-theorem-explained/]">https://robertgreiner.com/cap-theorem-explained/]</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>分布式</tag>
      </tags>
  </entry>
  <entry>
    <title>初探FFmpeg命令行</title>
    <url>/posts/learn_FFmpeg_command_tool.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>微博上很火的<code>sorry</code>表情包程序, 看到有<code>Java</code>程序, 于是扒了下来看<a href="https://github.com/xtyxtyx/sorry">源码</a>。<br>看是怎么实现的, 原来是生成<code>ass</code>字幕文件, 然后用<code>FFmpeg</code>命令加入视频。</p>
<span id="more"></span>

<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><code>FFmpeg</code>是用于录制、转换和流化音频和视频的完整解决方案。<br><a href="https://www.ffmpeg.org/">官网地址</a>、<a href="https://github.com/FFmpeg/FFmpeg">GitHub地址</a></p>
<p><strong>安装教程</strong></p>
<ul>
<li><a href="https://www.ffmpeg.org/download.html">官网安装教程</a></li>
<li><a href="https://www.vultr.com/docs/how-to-install-ffmpeg-on-centos">如何在CentOS上安装FFmpeg</a></li>
</ul>
<h1 id="ffmpeg-h帮助"><a href="#ffmpeg-h帮助" class="headerlink" title="ffmpeg -h帮助"></a>ffmpeg -h帮助</h1><p>在命令行输入<code>ffmpeg -h</code>可以看到帮助命令。<br>这里只显示常用的帮助命令。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">用法: ffmpeg [options] [[infile options] -i infile]... &#123;[outfile options] outfile&#125;...</span><br><span class="line"></span><br><span class="line">获取帮助:</span><br><span class="line">    -h      -- 打印基本帮助命令</span><br><span class="line">    -h long -- 打印更多帮助命令</span><br><span class="line">    -h full -- 打印所有帮助命令 (包括所有格式和编解码器特定的选项, 很长)</span><br><span class="line">    有关选项的详细说明, 请参阅man ffmpeg.</span><br><span class="line"></span><br><span class="line">打印帮助 / 信息 / 功能:</span><br><span class="line">-L                  显示license许可证</span><br><span class="line">-version            显示版本</span><br><span class="line">-formats            显示可用的格式</span><br><span class="line">-codecs             显示可用的编码器、解码器</span><br><span class="line"></span><br><span class="line">全局选项（影响整个程序而不是仅仅一个文件:</span><br><span class="line">-v loglevel         设置日志输出等级</span><br><span class="line">-report             generate a report</span><br><span class="line">-y                  覆盖输出文件</span><br><span class="line">-n                  不覆盖输出文件</span><br><span class="line"></span><br><span class="line">每个文件的主要选项:</span><br><span class="line">-f <span class="built_in">fmt</span>              指定输出格式</span><br><span class="line">-t duration         录制或转码音频/视频的“持续时间”, 以秒为单位</span><br><span class="line">-to time_stop       录制或转码音频/视频的“截止时间”, 以秒为单位</span><br><span class="line">-ss time_off        录制或转码音频/视频的“开始时间”, 以秒为单位, 也支持[-]hh:mm:ss[.xxx]的时间格式</span><br><span class="line"></span><br><span class="line">视频选项:</span><br><span class="line">-vframes number     设置要输出的视频帧的数量</span><br><span class="line">-r rate             设置帧率(Hz值，分数或缩写)</span><br><span class="line">-s size             设置帧分辨率(如1280x720)</span><br><span class="line">-aspect aspect      设置纵横比 (4:3, 16:9 或 1.3333, 1.7777)</span><br><span class="line">-vn                 禁用视频, 用于只输出音频文件</span><br><span class="line">-vf filter_graph    设置视频过滤器</span><br><span class="line">-ab bitrate         指定音频比特率(单位kbit/s), 如-b:a 320</span><br><span class="line">-b bitrate          指定视频比特率(单位kbit/s), 如-b:v 64</span><br><span class="line"></span><br><span class="line">音频选项:</span><br><span class="line">-ar rate            设置音频采样率(以Hz为单位)</span><br><span class="line">-an                 禁用音频, 用于只输出视频</span><br><span class="line"></span><br><span class="line">字幕选项:</span><br><span class="line">-sn                 禁用字幕</span><br></pre></td></tr></table></figure>
<h1 id="FFmpeg过滤器"><a href="#FFmpeg过滤器" class="headerlink" title="FFmpeg过滤器"></a>FFmpeg过滤器</h1><p><code>ffmpeg</code>目录下, 有个文件夹叫<code>libavfilter</code>, 它可以单独编译为一个库。用于音视频过滤。<br>相当于一个特效之类的东西。<br><a href="https://ffmpeg.org/ffmpeg-filters.html">官方文档</a></p>
<h1 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h1><ol>
<li>显示媒体文件详细信息<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mp4</span><br></pre></td></tr></table></figure></li>
<li>将视频文件转换为不同的格式<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mp4 output.avi</span><br></pre></td></tr></table></figure></li>
<li>将视频文件转换为音频文件<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -vn -ar 44100 -ac 2 -ab 320 -f mp3 output.mp3 </span><br></pre></td></tr></table></figure></li>
<li>更改视频文件的分辨率<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -s 1280x720 -c:a copy output.mp4 </span><br><span class="line">ffmpeg -i input.mp4 -filter:v scale=640:480 -c:a copy output.mp4</span><br></pre></td></tr></table></figure></li>
<li>压缩<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 压缩视频文件</span></span><br><span class="line">ffmpeg -i input.mp4 -vf scale=1280:-1 -c:v libx264 -preset veryslow -crf 24 output.mp4 </span><br><span class="line"><span class="comment"># 压缩音频文件</span></span><br><span class="line">ffmpeg -i input.mp3 -ab 128 output.mp3 </span><br></pre></td></tr></table></figure></li>
<li>删除音频、视频<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 删除视频</span></span><br><span class="line">ffmpeg -i input.mp4 -vn output.mp3</span><br><span class="line"><span class="comment"># 删除音频</span></span><br><span class="line">ffmpeg -i input.mp4 -an output.mp4</span><br></pre></td></tr></table></figure></li>
<li>截取图片<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 截取1帧图片保存为image-01.png的格式</span></span><br><span class="line">ffmpeg -i input.mp4 -r 1 -f image2 image-%2d.png </span><br></pre></td></tr></table></figure></li>
<li>裁剪视频<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 从位置(10,20)开始裁剪300×400的部分</span></span><br><span class="line">ffmpeg -i input.mp4 -filter:v <span class="string">&quot;crop=10:20:300:400&quot;</span> output.mp4 </span><br><span class="line"><span class="comment"># 将第10秒开始的50秒视频转为avi格式, 可以用hh.mm.ss格式</span></span><br><span class="line">ffmpeg -i input.mp4 -ss 10 -t 50 output.avi </span><br><span class="line"><span class="comment"># 将纵横比改为16:9</span></span><br><span class="line">ffmpeg -i input.mp4 -aspect 16:9 output.mp4 </span><br></pre></td></tr></table></figure></li>
<li>添加字幕到视频文件<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -i subtitle.srt -map 0 -map 1 -c copy -c:v libx264 -crf 23 -preset veryfast output.mp4</span><br></pre></td></tr></table></figure></li>
<li>添加字幕并转为gif<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">ffmpeg -i input.mp4 -r 6 -vf ass=videoAss.ass,scale=300:-1 -y output.gif</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://github.com/xtyxtyx/sorry">在线制作sorry 为所欲为的gif</a></li>
<li><a href="https://www.ostechnix.com/20-ffmpeg-commands-beginners/">20 FFmpeg初学者命令</a></li>
<li><a href="https://blog.csdn.net/axdc_qa_team/article/details/4204358">FFMPEG使用参数详解</a></li>
<li><a href="https://blog.csdn.net/newchenxf/article/details/51364105">ffmpeg filter过滤器 基础实例及全面解析</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>FFmpeg</tag>
      </tags>
  </entry>
  <entry>
    <title>如何优雅的使用GitHub的js脚本</title>
    <url>/posts/The_Best_Practices_for_Using_GitHub&#39;s_JavaScript.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>GitHub</code>上有很多优秀的开源脚本, 但是不能直接使用, 需要下载下来保存在自己的项目中。<br>如果是使用<a href="https://jsfiddle.net/">JSFiddle</a>进行演示的话, 只能通过<code>url</code>引用(当然如果你不嫌累长篇大段的CV大法另当别论)。<br>即使是直接引用<code>raw</code>也会抛出异常, <code>GitHub</code>的<code>raw</code>文件的<code>MIME type(Internet media type)</code>为<code>text/plain</code>。而<code>&lt;script&gt;</code>要求为<code>application/javascript</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Refused to execute script from &#x27;http://raw.githubusercontent.com/user/repo/branch/file.js&#x27; because its MIME type (&#x27;text/plain&#x27;) is not executable, and strict MIME type checking is enabled.</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>其实<code>GitHub</code>自己就提供了解决方案。<br>只要将<code>raw.githubusercontent.com</code>替换为<code>rawgit.com</code>(非生产环境)或<code>cdn.rawgit.com</code>即可。<br>项目生产环境最好使用<code>cdn</code>。</p>
<p>比如<code>http://raw.githubusercontent.com/user/repo/branch/file.js</code>替换为<code>http://cdn.rawgit.com/user/repo/tag/file.js</code></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/17341122/link-and-execute-external-javascript-file-hosted-on-github">Link and execute external JavaScript file hosted on GitHub</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>GitHub</tag>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>如何解决Radeon Software Host Application的CPU占用率高的问题</title>
    <url>/posts/How_to_Fix_Radeon_Software_Host_Application_High_CPU_Usage.html</url>
    <content><![CDATA[<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>打开<code>cmd</code>命令行, 输入以下命令. 然后任务管理器结束<code>Radeon Software Host Application</code>这个进程, 重启程序即可.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> <span class="string">&quot;%USERPROFILE%\videos\Radeon ReLive&quot;</span></span><br></pre></td></tr></table></figure>

<p>缺少了这个<code>Radeon ReLive</code>文件夹, 导致程序一直在占用<code>CPU</code>高达<code>30%</code>.<br><code>AMD</code>居然连这种<code>bug</code>都写的出来, 也是厉害.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.youtube.com/watch?v=Aiak1-bN048">How to Fix Radeon Software Host Application High CPU Usage</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
  </entry>
  <entry>
    <title>数据单位</title>
    <url>/posts/data_unit.html</url>
    <content><![CDATA[<h1 id="数据单位"><a href="#数据单位" class="headerlink" title="数据单位"></a>数据单位</h1><h2 id="位（bit）"><a href="#位（bit）" class="headerlink" title="位（bit）"></a>位（bit）</h2><p>来自英文<code>bit</code>，音译为“比特”，表示二进制位。<br>位是计算机内部数据储存的最小单位，<code>11010100</code>是一个<code>8</code>位二进制数。一个二进制位只可以表示<code>0</code>和<code>1</code>两种状态。<br>两个二进制位可以表示<code>00</code>、<code>01</code>、<code>10</code>、<code>11</code>四种状态。<br><code>N</code>个二进制位可以表示$2^N$种状态</p>
<span id="more"></span>

<h2 id="字节（byte）"><a href="#字节（byte）" class="headerlink" title="字节（byte）"></a>字节（byte）</h2><p>字节来自英文<code>Byte</code>，音译为“拜特”，习惯上用大写的<code>B</code>表示。<br>字节是计算机中数据处理的基本单位。<br>计算机中以字节为单位存储和解释信息，规定一个字节由八个二进制位构成。<br><strong>即1个字节等于8个比特（1Byte=8bit）</strong>。<br>八位二进制数最小为<code>00000000</code>，最大为<code>11111111</code>。<br>通常<code>1</code>个字节可以存入一个<code>ASCII</code>码，<code>2</code>个字节可以存放一个汉字国标码。 </p>
<h2 id="字"><a href="#字" class="headerlink" title="字"></a>字</h2><p>计算机进行数据处理时，一次存取、加工和传送的数据长度称为字（<code>word</code>）。<br>一个字通常由一个或多个（一般是字节的整数位）字节构成。<br>例如<code>286</code>微机的字由<code>2</code>个字节组成，它的字长为<code>16</code>位机；<br><code>486</code>微机的字由<code>4</code>个字节组成，它的字长为<code>32</code>位机。<br>计算机的字长决定了其<code>CPU</code>一次操作处理实际位数的多少，由此可见计算机的字长越大，其性能越优越。 </p>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>二进制</tag>
      </tags>
  </entry>
  <entry>
    <title>计算两个日期之间的工作日时间差</title>
    <url>/posts/Calculate_the_number_of_working_days_between_two_dates.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>工作日的计算是一个大的问题, 要考虑假期, 而且每年的假期也不一样。假期完还有工作日调休等。<br>所以必须要将假期存储在硬盘上的数据(数据库或xml)。<br>然后计算时间差。<br>比如, 2018年5月11日星期五, 需要过3个工作日, 那么就是2018年5月16日星期三。</p>
<span id="more"></span>

<h1 id="假期的获取"><a href="#假期的获取" class="headerlink" title="假期的获取"></a>假期的获取</h1><p>假期每年都是不一样的, 所以</p>
<ol>
<li>通过人工查看政策文件手动写入硬盘, 如<a href="http://sousuo.gov.cn/s.htm?t=paper&advance=true&title=%E8%8A%82%E5%81%87%E6%97%A5%E5%AE%89%E6%8E%92">节假日安排</a></li>
<li>通过<code>Api</code>定时任务<code>Quartz</code>进行获取, 如<a href="https://www.juhe.cn/docs/api/id/177">聚合数据Api</a></li>
</ol>
<h2 id="以xml形式存储"><a href="#以xml形式存储" class="headerlink" title="以xml形式存储"></a>以xml形式存储</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">xml</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">holidays</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-01-01&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;元旦&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-15&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-16&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-17&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-18&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-19&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-20&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-21&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;春节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-05&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;清明节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-06&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;清明节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-07&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;清明节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-29&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;劳动节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-30&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;劳动节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-05-01&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;劳动节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-06-16&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;端午节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-06-17&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;端午节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-06-18&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;端午节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-09-22&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;中秋节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-09-23&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;中秋节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-09-24&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;中秋节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-01&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-02&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-03&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-04&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-05&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-06&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-10-07&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;国庆节&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">holidays</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">workingdays</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-11&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;调休成为工作日&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-02-24&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;调休成为工作日&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-08&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;调休成为工作日&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-04-28&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;调休成为工作日&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-09-29&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;调休成为工作日&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">day</span> <span class="attr">value</span>=<span class="string">&quot;2018-09-30&quot;</span> <span class="attr">desc</span>=<span class="string">&quot;调休成为工作日&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">workingdays</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">xml</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="以数据库形式存储"><a href="#以数据库形式存储" class="headerlink" title="以数据库形式存储"></a>以数据库形式存储</h2><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">id          day        desc</span><br><span class="line">1        2018-01-01    元旦</span><br><span class="line">2        2018-02-15    春节</span><br><span class="line">3        2018-02-16    春节</span><br><span class="line">4        2018-02-17    春节</span><br><span class="line">5        2018-02-18    春节</span><br><span class="line">6        2018-02-19    春节</span><br><span class="line">7        2018-02-20    春节</span><br><span class="line">8        2018-02-21    春节</span><br><span class="line">9        2018-04-05    清明节</span><br><span class="line">10       2018-04-06    清明节</span><br><span class="line">11       2018-04-07    清明节</span><br><span class="line">12       2018-04-29    劳动节</span><br><span class="line">13       2018-04-30    劳动节</span><br><span class="line">14       2018-05-01    劳动节</span><br><span class="line">15       2018-06-16    端午节</span><br><span class="line">16       2018-06-17    端午节</span><br><span class="line">17       2018-06-18    端午节</span><br><span class="line">18       2018-09-22    中秋节</span><br><span class="line">19       2018-09-23    中秋节</span><br><span class="line">20       2018-09-24    中秋节</span><br><span class="line">21       2018-10-01    国庆节</span><br><span class="line">22       2018-10-02    国庆节</span><br><span class="line">23       2018-10-03    国庆节</span><br><span class="line">24       2018-10-04    国庆节</span><br><span class="line">25       2018-10-05    国庆节</span><br><span class="line">26       2018-10-06    国庆节</span><br><span class="line">27       2018-10-07    国庆节</span><br><span class="line">28       2018-02-11    调休成为工作日</span><br><span class="line">29       2018-02-24    调休成为工作日</span><br><span class="line">30       2018-04-08    调休成为工作日</span><br><span class="line">31       2018-04-28    调休成为工作日</span><br><span class="line">32       2018-09-29    调休成为工作日</span><br><span class="line">33       2018-09-30    调休成为工作日</span><br></pre></td></tr></table></figure>

<h1 id="计算工作日的时间差"><a href="#计算工作日的时间差" class="headerlink" title="计算工作日的时间差"></a>计算工作日的时间差</h1><p>代码逻辑都写在注释中了。<br>其中, <code>holidaysMap&lt;年月日, 节假日名称&gt;</code>和<code>workingdaysMap&lt;年月日, 调休&gt;</code>两个<code>Map</code>集合读取的数据, 来源于上述的数据集合。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.time.DurationFormatUtils;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WorkDateHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(WorkDateHelper.class);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DAY_TIME</span> <span class="operator">=</span> <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000</span>; <span class="comment">// 1天的毫秒数</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">SimpleDateFormat</span> <span class="variable">yyyyMMdd</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 计算工作日的时间差</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> preDate 前一个日期</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> nextDate 后一个日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">workTimeDiff</span><span class="params">(Date preDate, Date nextDate)</span>&#123;</span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 保证 前一个日期 大于 后一个日期</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">preTime</span> <span class="operator">=</span> preDate.getTime(), nextTime = nextDate.getTime();</span><br><span class="line">        <span class="keyword">if</span>(preTime &gt; nextTime)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;前一个日期&quot;</span>+yyyyMMdd.format(preDate)+<span class="string">&quot;不能大于后一个日期&quot;</span>+yyyyMMdd.format(nextDate));</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 校准 preTime, 调整到明天0点整点</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">timeDiff</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        calendar.setTimeInMillis(preTime);</span><br><span class="line">        calendar.add(Calendar.DATE, <span class="number">1</span>);</span><br><span class="line">        calendar.set(Calendar.HOUR_OF_DAY, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.MINUTE, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.SECOND, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.1. 如果是节假日调休或工作日, 就记录校准时间差</span></span><br><span class="line">        <span class="keyword">if</span>(isWorkDate(preTime)) &#123;</span><br><span class="line">            timeDiff += calendar.getTimeInMillis() - preTime;</span><br><span class="line">        &#125;</span><br><span class="line">        preTime = calendar.getTimeInMillis();</span><br><span class="line"><span class="comment">//        logger.debug(&quot;校准preTime:&quot;+new Date(preTime)+&quot;,&quot;+DurationFormatUtils.formatDuration(timeDiff, &quot;**dd HH:mm:ss**&quot;, true));</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 校准 nextTime, 调整到当天0点整点</span></span><br><span class="line">        calendar.setTimeInMillis(nextTime);</span><br><span class="line">        calendar.set(Calendar.HOUR_OF_DAY, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.MINUTE, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.SECOND, <span class="number">0</span>);</span><br><span class="line">        calendar.set(Calendar.MILLISECOND, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3.1. 如果是节假日调休或工作日, 就记录校准时间差</span></span><br><span class="line">        <span class="keyword">if</span>(isWorkDate(nextTime)) &#123;</span><br><span class="line">            timeDiff += nextTime - calendar.getTimeInMillis();</span><br><span class="line">        &#125;</span><br><span class="line">        nextTime = calendar.getTimeInMillis();</span><br><span class="line"><span class="comment">//        logger.debug(&quot;校准nextTime:&quot;+new Date(nextTime)+&quot;,&quot;+DurationFormatUtils.formatDuration(timeDiff, &quot;**dd HH:mm:ss**&quot;, true));</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 模拟时间流逝, 计算在工作日内的时间差</span></span><br><span class="line">        <span class="keyword">while</span>(preTime &lt; nextTime) &#123;</span><br><span class="line">            <span class="comment">// 3. 如果是节假日调休或工作日, 就记录校准时间差</span></span><br><span class="line">            <span class="keyword">if</span>(isWorkDate(preTime)) &#123;</span><br><span class="line">                timeDiff += DAY_TIME;</span><br><span class="line">            &#125;</span><br><span class="line">            preTime += DAY_TIME;</span><br><span class="line"><span class="comment">//            logger.debug(&quot;时间流逝:&quot;+new Date(preTime)+&quot;,&quot;+DurationFormatUtils.formatDuration(timeDiff, &quot;**dd HH:mm:ss**&quot;, true));</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> timeDiff;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否为 工作日, 节假日调休或正常工作日</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> time 计算的日期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isWorkDate</span><span class="params">(<span class="type">long</span> time)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">day</span> <span class="operator">=</span> yyyyMMdd.format(<span class="keyword">new</span> <span class="title class_">Date</span>(time));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 是节假日就返回false</span></span><br><span class="line">        <span class="keyword">if</span>(holidaysMap.containsKey(day))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 是节假日调休就返回true</span></span><br><span class="line">        <span class="keyword">if</span>(workingdaysMap.containsKey(day))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 是周末返回false</span></span><br><span class="line">        <span class="type">Calendar</span> <span class="variable">calendar</span> <span class="operator">=</span> Calendar.getInstance();</span><br><span class="line">        calendar.setTimeInMillis(time);</span><br><span class="line">        <span class="type">int</span> <span class="variable">dayOfWeek</span> <span class="operator">=</span> calendar.get(Calendar.DAY_OF_WEEK);</span><br><span class="line">        <span class="keyword">if</span>(dayOfWeek == Calendar.SUNDAY || dayOfWeek == Calendar.SATURDAY)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 是正常工作日就返回true</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>计算机网络之IP地址、子网掩码、网关详解</title>
    <url>/posts/IP_address,_subnet_mask,_gateway_Introduction.html</url>
    <content><![CDATA[<h1 id="IP地址"><a href="#IP地址" class="headerlink" title="IP地址"></a>IP地址</h1><p>由于IPv6尚未普及，这里的 IP地址为IPv4地址。<br>IP地址相当于互联网上的门牌号, 由 <code>4字节</code>, 也就是 <code>32位</code> 的二进制码组成，包含了网络号( <code>net-id</code> )和主机号( <code>host-id</code> )。</p>
<ul>
<li>网络号( <code>net-id</code> ): 标志主机(或路由器)所连接到的网络。</li>
<li>主机号( <code>host-id</code> ): 网络号范围内唯一的主机(或路由器)。</li>
</ul>
<span id="more"></span>

<table>
<thead>
<tr>
<th align="center">IP地址种类</th>
<th align="center">二进制组成(前缀位+网络位+主机位)</th>
<th align="center">IP范围</th>
<th align="center">网络数</th>
<th align="center">主机数/网络</th>
</tr>
</thead>
<tbody><tr>
<td align="center">A类地址</td>
<td align="center">0+7位网络号+24位主机号</td>
<td align="center">1.0.0.0 - 127.255.255.255</td>
<td align="center">2^7-2</td>
<td align="center">2^24-2</td>
</tr>
<tr>
<td align="center">B类地址</td>
<td align="center">10+14位网络号+16位主机号</td>
<td align="center">128.0.0.0 - 191.255.255.255</td>
<td align="center">2^14-1</td>
<td align="center">2^16-2</td>
</tr>
<tr>
<td align="center">C类地址</td>
<td align="center">110+21位网络号+8位主机号</td>
<td align="center">192.0.0.0 - 223.255.255.255</td>
<td align="center">2^21-1</td>
<td align="center">2^8-2</td>
</tr>
<tr>
<td align="center">D类地址</td>
<td align="center">1110+多播地址(用于多播)</td>
<td align="center">224.0.0.0 - 239.255.255.255</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">E类地址</td>
<td align="center">1111+保留位(不开放, 保留使用)</td>
<td align="center">240.0.0.0-249.255.255.255</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p>前缀位标识是什么种类的网络, 0为A类地址, 10为B类地址, 110为C类地址, 依次类推。</p>
<h2 id="网络数计算"><a href="#网络数计算" class="headerlink" title="网络数计算"></a>网络数计算</h2><p>网络数就是一种网络的子网数, 比如A类地址, 可以分为多少个子网。<br>看表格可以推出网络数的计算公式为:  <code>2^网络号位数</code>。<br>规定网络地址全为 <code>0</code> 的IP地址是保留地址，意思是“本网络”。</p>
<ul>
<li>在A类地址中，实际上 <code>0.0.0.0</code> 是不指派的，而可以指派的最小网络是 <code>1.0.0.0</code>；网络地址为 <code>127</code> 的A类IP地址(比如常用的 <code>127.0.0.1</code>)保留作为本地软件环回测试本主机的进程之间的通信。所以A类地址网络数为 <code>2^7-2</code>。</li>
<li>在B类地址中，实际上 <code>128.0.0.0</code> 是不指派的，而可以指派的最小网络是 <code>128.1.0.0</code>，所以B类地址网络数是 <code>2^14-1</code>。</li>
<li>在C类地址中，实际上 <code>192.0.0.0</code> 是不指派的，而可以指派的最小网络是 <code>192.0.1.0</code>，所以C类地址网络数是 <code>2^21-1</code>。</li>
</ul>
<h2 id="主机数计算"><a href="#主机数计算" class="headerlink" title="主机数计算"></a>主机数计算</h2><p>主机数就是一个子网里面可以容纳多少台主机。<br>看表格可以推出主机数的计算公式为:  <code>2^主机号位数-2</code>。<br>主机号全为0表示该网络，而主机号全为1表示广播地址, 排除掉这两个。<br>比如A类地址 <code>1.0.0.0</code> 表示主机所在的网段的网络地址,  <code>1.255.255.255</code> 为该网段的广播地址。</p>
<h2 id="私有IP地址"><a href="#私有IP地址" class="headerlink" title="私有IP地址"></a>私有IP地址</h2><p>经常可以看到 <code>192.168.1.101</code> 这类的IP地址, 这些是私有IP地址, 专用地址, 也就是局域网分配的地址。<br>公网IP地址是需要掏钱申请的，私有IP地址不用掏钱, 但是仅限内网使用, 目的是为了节约公网IP。</p>
<table>
<thead>
<tr>
<th align="center">IP地址种类</th>
<th align="center">私有IP范围</th>
</tr>
</thead>
<tbody><tr>
<td align="center">A类地址</td>
<td align="center">10.0.0.0 - 10.255.255.255</td>
</tr>
<tr>
<td align="center">B类地址</td>
<td align="center">172.16.0.0 - 172.31.255.255</td>
</tr>
<tr>
<td align="center">C类地址</td>
<td align="center">192.168.0.0 - 192.168.255.255</td>
</tr>
</tbody></table>
<p>路由器看到专用地址就不转发，所以说专用地址作为目的地址是不可能在因特网上传送的。专用IP地址也可叫做可重用地址。那好，问题来了，如果配置了这些专用地址的主机想和因特网上的主机通信，怎么办呢？NAT(network address translation: 网络地址转换)在这种情况下就应运而生了。NAT就是将这种地址转换成有效的外部全球IP地址，使得整个专用网只需要一个全球IP地址就可以与因特网联通。</p>
<p>使用NAT技术，需要在专用网(整个网络内部都是使用的这种地址)连接到因特网的路由器上安装NAT软件。装有NAT软件的路由器叫做NAT路由器，它至少有一个有效的外部全球IP地址。但是NAT并不能从根本上解决IP地址的耗尽问题，因为NAT并不能从根本上解决IP地址的耗尽问题，因为NAT并没有增加IP地址的个数。而真正解决IP地址耗尽问题的是IPv6。</p>
<h1 id="子网掩码"><a href="#子网掩码" class="headerlink" title="子网掩码"></a>子网掩码</h1><p>计算网络地址就是判断网络中的计算机在不在同一网段,在就能通,不在就不能通。<br>将IP地址和子网掩码都换算成二进制,然后进行与运算,结果就是网络地址, 也就是网络号。<br>子网掩码的1和0必须连续, 比如 <code>11111111.00000000.00000000.00000000 </code>, 即 <code>255.0.0.0</code>。</p>
<p>以上的主机数和网络数都是使用标准子网掩码算出来的, 比如A类地址的标准子网掩码为 <code>255.0.0.0</code>, B类地址的标准子网掩码为 <code>255.255.0.0</code>, C类地址的标准子网掩码为 <code>255.255.255.0</code>。</p>
<p>比如 <code>126.1.2.3</code> 和 <code>255.0.0.0</code>进行二进制的按位与运算, 得到网络地址 <code>126.0.0.0</code>。这个 <code>126.0.0.0</code>也就是上面计算主机数排除掉的该网段内其中一位IP地址。</p>
<p>当然还有非标准的子网掩码。具体参考 <code>常用计算例子</code> 章节的第1题。</p>
<h1 id="网关"><a href="#网关" class="headerlink" title="网关"></a>网关</h1><p>网关是用来进行跨网段通信的工具, 本质是一个IP地址。</p>
<p>比如一个C类网 A<code>192.168.1.101</code> 想要和 B<code>192.168.0.101</code> 通信, 标准的子网掩码是 <code>255.255.255.0</code>, 进行按位与运算获得的网络地址为 <code>192.168.1.0</code> 和 <code>192.168.0.0</code>, 也就是不在同一个网段内, 那么只通过交换机是不能进行通信的, 必须借助路由器。</p>
<p>可以把网关想象一个国家的外交部。A想要和B通信, 但是A在中国, B在美国, 那么就不能直接面对面谈话(借助交换机), 这时候, A可以把信息传递给中国的外交部X, 由X交给美国的外交部Y, 再由Y交给B。</p>
<p>也就是说, 如果内网IP地址想要访问不是同一网段的主机, 那么必须借助网关. 将数据发送到另一个网关。</p>
<h1 id="常用计算例子"><a href="#常用计算例子" class="headerlink" title="常用计算例子"></a>常用计算例子</h1><p>1、利用子网数目计算子网掩码<br>把B类地址 <code>172.16.0.0</code> 划分成 <code>30</code> 个子网络，它的子网掩码是多少？<br>①将子网络数目 <code>30</code> 转换成二进制表示 <code>11110</code><br>②统计一下这个二进制的数共有 <code>5</code> 位<br>③注意：当二进制数中只有一个1的时候，所统计的位数需要减1（例如：10000要统计为4位）<br>④将B类地址的子网掩码 <code>255.255.0.0</code> 主机地址部分的前 <code>5</code> 位变成 <code>1</code><br>⑤这就得到了所要的子网掩码<code>（11111111.11111111.11111000.00000000 ）255.255.248.0</code>。</p>
<p>2、利用主机数目计算子网掩码<br>把B类地址 <code>172.16.0.0</code> 划分成若干子网络，每个子网络能容纳 <code>500</code> 台主机，它的子网掩码是多少？<br>①把 <code>500</code> 转换成二进制表示 <code>111110100</code><br>②统计一下这个二进制的数共有 <code>9</code> 位<br>③将子网掩码 <code>255.255.255.255</code> 从后向前的 <code>9</code> 位变成 <code>0</code><br>④这就得到了所要的子网掩码<code>（11111111.11111111.11111110.00000000）255.255.254.0</code>。</p>
<p>3、利用子网掩码计算最大有效子网数<br>A类IP地址，子网掩码为 <code>255.224.0.0</code> ，它所能划分的最大有效子网数是多少？<br>①将子网掩码转换成二进制表示 <code>11111111.11100000.00000000.00000000</code><br>②统计一下它的网络位共有 <code>11</code> 位<br>③A类地址网络位的基础数是 <code>8</code> ，二者之间的位数差是 <code>3</code><br>④最大有效子网数就是<code>2^3</code>，即最多可以划分 <code>8</code> 个子网络。</p>
<p>4、利用子网掩码计算最大可用主机数<br>A类IP地址，子网掩码为 <code>255.252.0.0</code> ，将它划分成若干子网络，每个子网络中可用主机数有多少？<br>①将子网掩码转换成二进制表示 <code>11111111.11111100.00000000.00000000</code><br>②统计一下它的主机位共有 <code>18</code> 位<br>③最大可用主机数就是 <code>2^18-2</code>（除去全是0的网络地址和全是1广播地址），即每个子网络最多有 <code>262142</code> 台主机可用。</p>
<p>5、利用子网掩码确定子网络的起止地址<br>B类IP地址 <code>172.16.0.0</code> ，子网掩码为 <code>255.255.192.0</code> ，它所能划分的子网络起止地址是多少？<br>①利用子网掩码计算，最多可以划分 <code>4</code> 个子网络<br>②利用子网掩码计算，每个子网络可容纳 <code>16384</code> 台主机（包括网络地址和广播地址）<br>③用 <code>16384</code> 除以 <code>256</code> （网段内包括网络地址和广播地址的全部主机数），结果是 <code>64</code><br>④具体划分网络起止方法如下：<br>172.16.0.0～172.16.63.255<br>172.16.64.0～172.16.127.255<br>172.16.128.0～172.16.191.255<br>172.16.192.0～172.16.255.255</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.sciencenet.cn/blog-2355761-1036878.html">TCP/IP之IP地址详解</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_5753d0930101fxdf.html">子网数、主机数与子网掩码的关系</a></li>
<li><a href="http://www.cnblogs.com/JuneWang/p/3917697.html">IP地址，子网掩码，默认网关，DNS服务器详解</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>计算机网络</tag>
      </tags>
  </entry>
  <entry>
    <title>A+B问题</title>
    <url>/posts/a_b_problem.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>萌新重新开始刷题了, 在<code>LintCode</code>遇到一道题目, 是讲不用<code>+</code>运算符进行加法运算。<br><a href="https://www.lintcode.com/problem/a-b-problem/description">A + B 问题</a></p>
<span id="more"></span>

<h1 id="不进位加法算法"><a href="#不进位加法算法" class="headerlink" title="不进位加法算法"></a>不进位加法算法</h1><p>既然不用<code>+</code>运算符, 那就直接<code>return a-(-b)</code>就行啦~</p>
<img data-src="/images/%E5%BC%80%E7%8E%A9%E7%AC%91.jpg" class="">

<p>言归正传, 既然不能用<code>+</code>运算符, 那必然是位运算的范畴了。</p>
<p>异或运算, 又叫做不进位加法, 这里的加法都是基于二进制的。</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">0</th>
<th align="center">1</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0+0=0</td>
<td align="center">0+1=1</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1+0=1</td>
<td align="center">1+1=0(不进位)</td>
</tr>
</tbody></table>
<p>再来看下异或运算</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">0</th>
<th align="center">1</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">0^0=0</td>
<td align="center">0^1=1</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">1^0=1</td>
<td align="center">1^1=0</td>
</tr>
</tbody></table>
<p>可以看出 <strong>不进位加法 = 异或运算</strong></p>
<h1 id="进位算法"><a href="#进位算法" class="headerlink" title="进位算法"></a>进位算法</h1><p>进位的情况只有一种, 也就是<code>1+1</code>的情况, 可以通过<code>&amp;</code>与运算找到。<br>也就是说, 我们需要找到全1的一位, 再左移一位, 就可以得到进位后的值。</p>
<p>下面是一个加法的例子</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">a       + b         = (a ^ b)  + (a &amp; b &lt;&lt; 1)</span><br><span class="line">4(0100) + 6(0110)   = 2(0010)  + 4(0100) &lt;&lt; 1</span><br><span class="line">4(0100) + 6(0110)   = 2(0010)  + 8(1000)</span><br><span class="line">2(0010) + 8(1000)   = 10(1010) + 0(0000)</span><br></pre></td></tr></table></figure>
<p>当不需要进位之后, 运算结束。</p>
<p>伪代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="type">int</span> xor=a^b, and=(a&amp;b)&lt;&lt;<span class="number">1</span>;</span><br><span class="line">    a = xor;</span><br><span class="line">    b = and;</span><br><span class="line">&#125; <span class="keyword">while</span>(b != <span class="number">0</span>);</span><br><span class="line"><span class="keyword">return</span> a;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>LintCode</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>LintCode</tag>
      </tags>
  </entry>
  <entry>
    <title>尾部的零</title>
    <url>/posts/trailing_zeros.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://www.lintcode.com/problem/trailing-zeros">LintCode-尾部的零</a><br><strong>描述</strong><br>设计一个算法，计算出n阶乘中尾部零的个数</p>
<p><strong>样例</strong><br>11! = 39916800，因此应该返回 2</p>
<p><strong>挑战</strong><br>O(logN)的时间复杂度</p>
<span id="more"></span>

<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p><del>这么简单, 递归阶乘, 转字符串, 从后往前遍历</del></p>
<img data-src="/images/%E5%BC%80%E7%8E%A9%E7%AC%91.jpg" class="">

<p>上面的方法当然是超时了.<br>网上也已经有很多解题思路, 自己再总结一下。<br>这个问题可以换个问法, <code>n!=K*10^M</code>, 求<code>M</code>。<br>在样例中, <code>n! = K * 10^M = 11! = 399168 * 10^2</code>。<br>也就是说, 尾部有多少个零, 那么就是<code>K</code>乘以<code>10</code>的多少次方。</p>
<p>再转化一下</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">11! = 1 * 2 * 3 *    4    * 5 *    6    * 7 *      8      *    9    *   10    * 11</span><br><span class="line">11! = 1 * 2 * 3 * (2 * 2) * 5 * (2 * 3) * 7 * (2 * 2 * 2) * (3 * 3) * (2 * 5) * 11</span><br><span class="line">11! = 1 * 7 * 11 * 3^4 * 2^8 * 5^2</span><br><span class="line">11! = (1 * 7 * 11 * 3^4 * 2^6) * 2^2 * 5^2</span><br><span class="line">11! = (1 * 7 * 11 * 3^4 * 2^6) * (2 * 5)^2</span><br><span class="line">11! = (399168) * 10^2</span><br><span class="line">n!  = K * 10^M</span><br></pre></td></tr></table></figure>
<p>可以看到解题方法就是找出<strong>因式分解</strong>后, 里面有多少个 <code>2*5</code>的组合。<br>从上面可以看出, <code>2</code>的数量一定是比<code>5</code>多的。<br>所以, 因式分解后有多少个<code>5</code>, 尾部就有多少个零。</p>
<p>再转化一下, 能被<code>5</code>整除的因子必然是<code>5</code>的倍数, 也就是说, <del>找出<code>n</code>之前有多少个<code>5</code>的倍数</del>(这是不正确的)。<br>还需要考虑到<code>25, 125</code>等数字。</p>
<table>
<thead>
<tr>
<th align="center">n</th>
<th align="center">因子是5的倍数</th>
<th align="center">计算方法</th>
<th align="center">多少个零</th>
</tr>
</thead>
<tbody><tr>
<td align="center">11</td>
<td align="center">5, 10</td>
<td align="center">11 / 5 = 2</td>
<td align="center">2</td>
</tr>
<tr>
<td align="center">26</td>
<td align="center">5, 10, 15, 20, 25</td>
<td align="center">26 / 5 + 26 / 25 = 6</td>
<td align="center">6</td>
</tr>
<tr>
<td align="center">1000</td>
<td align="center">5, 10, 15, …. 995, 1000</td>
<td align="center">1000 / 5 + 1000 / 25 + 1000 / 125 …. = 249</td>
<td align="center">249</td>
</tr>
</tbody></table>
<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">trailingZeros</span><span class="params">(<span class="type">long</span> n)</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (n != <span class="number">0</span>) &#123; </span><br><span class="line">        count += n / <span class="number">5</span>;</span><br><span class="line">        n /= <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>LintCode</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>LintCode</tag>
      </tags>
  </entry>
  <entry>
    <title>KMP算法</title>
    <url>/posts/KMP_Algorithm.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>KMP</code>是一种字符串匹配算法，并不算高效，晦涩难懂，比它简单易懂高效的算法是有，但不知为何，课本只讲了这种字符串匹配算法。<br>整个算法的精髓就在于<code>next</code>数组的计算，网上关于<code>KMP</code>的资料有很多。这里只讲<code>next</code>数组的计算。</p>
<span id="more"></span>

<h1 id="求P＝-ababbaaba-的next数组"><a href="#求P＝-ababbaaba-的next数组" class="headerlink" title="求P＝{ababbaaba}的next数组"></a>求P＝{ababbaaba}的next数组</h1><p>1、首先，给前两个赋值01</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ababbaaba</span><br><span class="line">01</span><br></pre></td></tr></table></figure>


<p>2、下标移到3号位，对应下标为a，<br>前缀为<code>a</code>，后缀为<code>b</code>，没有相同的，赋1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  ↓</span><br><span class="line">ababbaaba</span><br><span class="line">011</span><br></pre></td></tr></table></figure>

<p>3、下标移到4号位，对应下标为b，<br>前缀为<code>a</code>、<code>ab</code>，后缀为<code>ba</code>、<code>a</code><br>有相同的<code>a</code>，长度为1，赋2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">   ↓</span><br><span class="line">ababbaaba</span><br><span class="line">0112</span><br></pre></td></tr></table></figure>

<p>4、下标移到5号位，对应下标为b，<br>前缀为<code>a</code>、<code>ab</code>、<code>aba</code>，后缀为<code>bab</code>、<code>ab</code>、<code>b</code><br>有相同的<code>ab</code>，长度为2，赋3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">    ↓</span><br><span class="line">ababbaaba</span><br><span class="line">01123</span><br></pre></td></tr></table></figure>

<p>5、下标移到6号位，对应下标为a，<br>前缀为<code>a</code>、<code>ab</code>、<code>aba</code>、<code>abab</code>，后缀为<code>babb</code>、<code>abb</code>、<code>bb</code>、<code>b</code><br>没有相同的，赋1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">     ↓</span><br><span class="line">ababbaaba</span><br><span class="line">011231</span><br></pre></td></tr></table></figure>
<p>6、下标移到7号位，对应下标为a，<br>前缀为<code>a</code>、<code>ab</code>、<code>aba</code>、<code>abab</code>、<code>ababb</code>，后缀为<code>babba</code>、<code>abba</code>、<code>bba</code>、<code>ba</code>、<code>a</code><br>有相同的<code>a</code>，长度为1，赋2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">      ↓</span><br><span class="line">ababbaaba</span><br><span class="line">0112312</span><br></pre></td></tr></table></figure>

<p>7、下标移到8号位，对应下标为b，<br>前缀为<code>a</code>、<code>ab</code>、<code>aba</code>、<code>abab</code>、<code>ababb</code>、<code>ababba</code>，后缀为<code>babbaa</code>、<code>abbaa</code>、<code>bbaa</code>、<code>baa</code>、<code>aa</code>、<code>a</code><br>有相同的<code>a</code>，长度为1，赋2</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       ↓</span><br><span class="line">ababbaaba</span><br><span class="line">01123122</span><br></pre></td></tr></table></figure>
<p>8、下标移到9号位，对应下标为a，<br>前缀为<code>a</code>、<code>ab</code>、<code>aba</code>、<code>abab</code>、<code>ababb</code>、<code>ababba</code>、<code>ababbaa</code>，后缀为<code>babbaab</code>、<code>abbaab</code>、<code>bbaab</code>、<code>baab</code>、<code>aab</code>、<code>ab</code>、<code>b</code><br>有相同的<code>ab</code>，长度为2，赋3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">        ↓</span><br><span class="line">ababbaaba</span><br><span class="line">011231223</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>如何高效的获取一个数字的首位数字</title>
    <url>/posts/How_to_efficiently_get_the_first_digit_of_a_number.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一直以来都是通过转化为String的方式来获得首位数字, 但是直觉告诉我, 这个肯定不是最高效的。<br>在stackoverflow上找到了这篇文章。虽然看标题是C#的, 但是算法没有语言之分。同样适用于java<br><a href="https://stackoverflow.com/questions/701322">How can you get the first digit in an int (C#)?</a></p>
<span id="more"></span>

<h1 id="解法-效率从低到高"><a href="#解法-效率从低到高" class="headerlink" title="解法(效率从低到高)"></a>解法(效率从低到高)</h1><h2 id="转化为字符串"><a href="#转化为字符串" class="headerlink" title="转化为字符串"></a>转化为字符串</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">firstDigit</span> <span class="operator">=</span> String.valueOf(num).charAt(<span class="number">0</span>) - <span class="string">&#x27;0&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p>Result: <code>9,165,089 ticks</code></p>
<h2 id="循环除10"><a href="#循环除10" class="headerlink" title="循环除10"></a>循环除10</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span>(num &gt;= <span class="number">10</span>)&#123;</span><br><span class="line">    num = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Results: <code>6,001,570 ticks</code></p>
<h2 id="暴力if"><a href="#暴力if" class="headerlink" title="暴力if"></a>暴力if</h2><p>因为int的取值范围有限, 所以可以使用这种暴力枚举的方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> firstdigit;</span><br><span class="line"><span class="keyword">if</span> (num &lt; <span class="number">10</span>)</span><br><span class="line">     firstdigit = num;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">100</span>)</span><br><span class="line">     firstdigit = num / <span class="number">10</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">1000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">100</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">10000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">1000</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">100000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">1000000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">100000</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">10000000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">1000000</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">100000000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">10000000</span>;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (num &lt; <span class="number">1000000000</span>)</span><br><span class="line">     firstdigit = num / <span class="number">100000000</span>;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">     firstdigit = num / <span class="number">1000000000</span>;</span><br></pre></td></tr></table></figure>
<p>Results: <code>1,421,659 ticks</code></p>
<h2 id="二分if"><a href="#二分if" class="headerlink" title="二分if"></a>二分if</h2><p>因为int的取值范围有限, 所以可以使用这种暴力枚举的方法。<br>对上面的暴力枚举使用二分法进行优化。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (num &gt;= <span class="number">100000000</span>) num /= <span class="number">100000000</span>;</span><br><span class="line"><span class="keyword">if</span> (num &gt;= <span class="number">10000</span>) num /= <span class="number">10000</span>;</span><br><span class="line"><span class="keyword">if</span> (num &gt;= <span class="number">100</span>) num /= <span class="number">100</span>;</span><br><span class="line"><span class="keyword">if</span> (num &gt;= <span class="number">10</span>) num /= <span class="number">10</span>;</span><br></pre></td></tr></table></figure>
<p>Results: <code>1,399,788 ticks</code></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/701322">How can you get the first digit in an int (C#)?</a></li>
</ul>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>康托展开</title>
    <url>/posts/cantor_algorithm.html</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>康托展开是一个全排列到一个自然数的双射, 常用于构建哈希表时的空间压缩,  康托展开的实质是计算当前排列在所有由小到大全排列中的顺序，因此是可逆的。</p>
<span id="more"></span>

<h1 id="运算"><a href="#运算" class="headerlink" title="运算"></a>运算</h1><p><code>3 5 7 4 1 2 9 6 8</code>展开为<code>98884</code>。<br><code>98884 = 2*8!+3*7!+4*6!+2*5!+0*4!+0*3!+2*2!+0*1!+0*0!</code><br>排列的第一位是3，比3小的数有两个，以这样的数开始的排列有8!个，因此第一项为2<em>8!<br>排列的第二位是5，比5小的数有1、2、3、4，由于3已经出现，因此共有3个比5小的数，这样的排列有7!个，因此第二项为3</em>7!<br>以此类推，直至0*0!</p>
<h1 id="逆运算"><a href="#逆运算" class="headerlink" title="逆运算"></a>逆运算</h1><p>如n=5,x=96时：<br>首先用96-1得到95，说明x之前有95个排列.(将此数本身减去1)<br>用95去除4! 得到3余23，说明有3个数比第1位小，所以第一位是4.<br>用23去除3! 得到3余5，说明有3个数比第2位小，所以是4，但是4已出现过，因此是5.<br>用5去除2!得到2余1，类似地，这一位是3.<br>用1去除1!得到1余0，这一位是2.<br>最后一位只能是1.<br>所以这个数是45321.</p>
<h1 id="java-代码实现"><a href="#java-代码实现" class="headerlink" title="java 代码实现"></a>java 代码实现</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MathUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer[] factorial = <span class="keyword">new</span> <span class="title class_">Integer</span>[<span class="number">11</span>];</span><br><span class="line">    <span class="keyword">static</span>&#123;</span><br><span class="line">        factorial[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        factorial[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">2</span>, len = factorial.length; i &lt; len; i++)&#123;</span><br><span class="line">            factorial[i] = factorial[i-<span class="number">1</span>]*i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将cantor逆康托展开, 返回一个全排列</span></span><br><span class="line"><span class="comment">     * 如[1,2,3],1</span></span><br><span class="line"><span class="comment">     * 如[3,2,1],6</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sequence 全排列中的元素序列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> cantor 康拓展开值</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 全排列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span>[] deCantor(<span class="type">int</span>[] sequence, <span class="type">int</span> cantor)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> sequence.length;</span><br><span class="line">        <span class="keyword">if</span>(len&gt;<span class="number">10</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;确保&quot;</span>+len+<span class="string">&quot;不大于10&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(cantor&lt;=<span class="number">0</span> || cantor&gt;factorial[len])&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;确保&quot;</span>+cantor+<span class="string">&quot;在[0,&quot;</span>+factorial[len]+<span class="string">&quot;&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Arrays.sort(sequence);</span><br><span class="line">        <span class="type">int</span>[] num = <span class="keyword">new</span> <span class="title class_">int</span>[len];</span><br><span class="line">        <span class="type">boolean</span>[] mark = <span class="keyword">new</span> <span class="title class_">boolean</span>[len];</span><br><span class="line"></span><br><span class="line">        cantor--;</span><br><span class="line">        len--;</span><br><span class="line">        <span class="type">int</span> <span class="variable">idx</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(len!=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> cantor/factorial[len];</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= k; i++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(mark[i])&#123;</span><br><span class="line">                    k++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            num[idx++] = sequence[k];</span><br><span class="line">            mark[k] = <span class="literal">true</span>;</span><br><span class="line">            cantor %= factorial[len--];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, k = mark.length; i&lt;k; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(!mark[i])&#123;</span><br><span class="line">                num[k-<span class="number">1</span>] = sequence[i];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> num;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回chars[]在全排列中是第几大的排列</span></span><br><span class="line"><span class="comment">     * 如[1,2,3]返回1</span></span><br><span class="line"><span class="comment">     * 如[3,2,1]返回6</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> chars 全排列</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 康托展开的值</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">enCantor</span><span class="params">(<span class="type">int</span>... chars)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> chars.length;</span><br><span class="line">        <span class="keyword">if</span>(len&gt;<span class="number">10</span>)&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;确保&quot;</span>+len+<span class="string">&quot;不大于10&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">int</span>[] low = <span class="keyword">new</span> <span class="title class_">int</span>[len];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i+<span class="number">1</span>; j &lt; len; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(chars[j]&lt;chars[i] &amp;&amp; j&gt;i)&#123;</span><br><span class="line">                    low[i]++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">            num += low[i] == <span class="number">0</span> ? <span class="number">0</span> : low[i] * factorial[len-<span class="number">1</span>-i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> num+<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> BigInteger <span class="title function_">factorial</span><span class="params">(<span class="type">int</span> n)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> factorial.length;</span><br><span class="line">        <span class="keyword">if</span>(n&lt;len)&#123;</span><br><span class="line">            <span class="keyword">return</span> BigInteger.valueOf(factorial[n]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">BigInteger</span> <span class="variable">result</span> <span class="operator">=</span> BigInteger.valueOf(factorial[len-<span class="number">1</span>]);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> len; i &lt;= n; i++)&#123;</span><br><span class="line">            result = result.multiply(BigInteger.valueOf(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://zh.wikipedia.org/wiki/%E5%BA%B7%E6%89%98%E5%B1%95%E5%BC%80">康托展开-维基百科</a></li>
</ul>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>排序算法</title>
    <url>/posts/Sorting_Algorithm.html</url>
    <content><![CDATA[<h1 id="排序算法"><a href="#排序算法" class="headerlink" title="排序算法"></a>排序算法</h1><span id="more"></span>

<hr>
<h2 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h2><p><strong>分析</strong><br>比较从<code>0</code>到<code>arr.length</code>的<strong>每一对</strong>数字，如果前一个数字<strong>大于（或小于）</strong>后一个数字，则交换位置，这样外层<code>for</code>循环每执行一次就把数组中的最大（小）数，移动到数组的<strong>最后</strong>。所以在内层<code>for</code>循环中可以<strong>不用比较</strong>已经排好序的数字，即<code>arr.length-i</code>之后的数字。时间复杂度为O(n^2)</p>
<p><strong>代码</strong></p>
<ul>
<li><p>伪代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">function <span class="title function_">bubble_sort</span> <span class="params">(array, length)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i, j;</span><br><span class="line">    <span class="keyword">for</span>(i from <span class="number">0</span> to length-<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j from <span class="number">0</span> to length-<span class="number">1</span>-i)&#123;</span><br><span class="line">            <span class="keyword">if</span> (array[j] &gt; array[j+<span class="number">1</span>])</span><br><span class="line">                swap(array[j], array[j+<span class="number">1</span>])</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Java代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> class 冒泡排序 &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">      arr[i] = in.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length-<span class="number">1</span>; i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; arr.length-<span class="number">1</span>-i; j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(arr[j]&gt;arr[j+<span class="number">1</span>])&#123;</span><br><span class="line">          <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[j+<span class="number">1</span>];</span><br><span class="line">          arr[j+<span class="number">1</span>] = arr[j];</span><br><span class="line">          arr[j] = temp;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; arr.length; j++)&#123;</span><br><span class="line">        System.out.print(arr[j]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>打印结果</strong><br>输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">10</span><br><span class="line">8 100 50 22 15 6 1 1000 999 0</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">8 50 22 15 6 1 100 999 0 1000 </span><br><span class="line">8 22 15 6 1 50 100 0 999 1000 </span><br><span class="line">8 15 6 1 22 50 0 100 999 1000 </span><br><span class="line">8 6 1 15 22 0 50 100 999 1000 </span><br><span class="line">6 1 8 15 0 22 50 100 999 1000 </span><br><span class="line">1 6 8 0 15 22 50 100 999 1000 </span><br><span class="line">1 6 0 8 15 22 50 100 999 1000 </span><br><span class="line">1 0 6 8 15 22 50 100 999 1000 </span><br><span class="line">0 1 6 8 15 22 50 100 999 1000 </span><br></pre></td></tr></table></figure>

<hr>
<h2 id="直接插入排序"><a href="#直接插入排序" class="headerlink" title="直接插入排序"></a>直接插入排序</h2><p><strong>分析</strong><br>有一个数组<code>[89, 27, 35, 78, 41, 15]</code>，分为已经排好序的部分<code>[89]</code>和未进行排序的部分<code>[27, 35, 78, 41, 15]</code><br>然后取出<code>27</code>，与<strong>排好序的部分</strong>从后往前比较，找到适合<code>27</code>的位置<code>0</code><br>把排好序的数组的位置<code>0</code>之后的部分数组往后移一位，将<code>27</code>填入位置<code>0</code>中，完成一次插入排序。<br>其他依次类推</p>
<p><strong>代码</strong></p>
<ul>
<li><p>伪代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">function <span class="title function_">bubble_sort</span> <span class="params">(array, length)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i, j;</span><br><span class="line">    <span class="keyword">for</span>(i from <span class="number">0</span> to length-<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">for</span>(j from length-<span class="number">1</span> to <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">if</span>(array[j] &lt;= array[j+<span class="number">1</span>])    <span class="keyword">break</span>;</span><br><span class="line">            swap(array[j], array[j+<span class="number">1</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Java代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> class 插入排序 &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">      arr[i] = in.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i-<span class="number">1</span>; j&gt;=<span class="number">0</span> &amp;&amp; arr[j]&gt;arr[j+<span class="number">1</span>]; j--)&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[j];</span><br><span class="line">        arr[j] = arr[j+<span class="number">1</span>];</span><br><span class="line">        arr[j+<span class="number">1</span>] = temp;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">        System.out.print(arr[i]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(<span class="string">&quot;&quot;</span>);&#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>打印结果</strong><br>输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6</span><br><span class="line">89 27 35 78 41 15</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">27 89 35 78 41 15 </span><br><span class="line">27 35 89 78 41 15 </span><br><span class="line">27 35 78 89 41 15 </span><br><span class="line">27 35 41 78 89 15 </span><br><span class="line">15 27 35 41 78 89</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="快速排序"><a href="#快速排序" class="headerlink" title="快速排序"></a>快速排序</h2><p><strong>分析</strong><br>从小到大排序，标记最左边的数为<code>key</code>,然后从<strong>右</strong>往左找比<code>key</code>小的数，再从<strong>左</strong>往右找比key大的数，交换位置，最后左右扫描到同一个位置时结束，二分，<br>对左子数组和右子数组进行下一轮排序。</p>
<p><strong>代码</strong></p>
<ul>
<li><p>伪代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">function <span class="title function_">quick_sort</span> <span class="params">(array, left, right)</span> &#123;</span><br><span class="line">    <span class="type">var</span> <span class="variable">l</span> <span class="operator">=</span> left;</span><br><span class="line">    <span class="type">var</span> <span class="variable">r</span> <span class="operator">=</span> right;</span><br><span class="line">    <span class="type">var</span> <span class="variable">key</span> <span class="operator">=</span> array[left];</span><br><span class="line">    <span class="keyword">while</span>(l&lt;r)&#123;</span><br><span class="line">        <span class="keyword">while</span>(l&lt;r &amp;&amp; array[r]&gt;=key) r--;<span class="comment">//必须先从右开始</span></span><br><span class="line">        <span class="keyword">while</span>(l&lt;r &amp;&amp; array[l]&lt;=key) l++;</span><br><span class="line">        <span class="keyword">if</span>(l&lt;r) swap(arr[l], arr[r]);</span><br><span class="line">    &#125;</span><br><span class="line">    array[left] = array[l];<span class="comment">//交换终点值和key的位置</span></span><br><span class="line">    array[l] = key;</span><br><span class="line">    quick_sort(arr, l+<span class="number">1</span>, right);<span class="comment">//二分排序，顺序不重要</span></span><br><span class="line">    quick_sort(arr, left, l-<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>Java代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">        <span class="type">int</span>[] arr = <span class="keyword">new</span> <span class="title class_">int</span>[n];</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">            arr[i] = in.nextInt();</span><br><span class="line">        &#125;</span><br><span class="line">        quickSort(arr, <span class="number">0</span>, arr.length-<span class="number">1</span>);</span><br><span class="line">        printf(arr);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">quickSort</span><span class="params">(<span class="type">int</span>[] arr, <span class="type">int</span> left, <span class="type">int</span> right)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(left&gt;right) <span class="keyword">return</span>;  </span><br><span class="line">        <span class="type">int</span> <span class="variable">l</span> <span class="operator">=</span> left;</span><br><span class="line">        <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> right;</span><br><span class="line">        <span class="type">int</span> <span class="variable">key</span> <span class="operator">=</span> arr[left];</span><br><span class="line">        <span class="keyword">while</span>(l&lt;r)&#123;</span><br><span class="line">            <span class="keyword">while</span>(l&lt;r &amp;&amp; arr[r]&gt;=key) r--;</span><br><span class="line">            <span class="keyword">while</span>(l&lt;r &amp;&amp; arr[l]&lt;=key) l++;</span><br><span class="line">            <span class="keyword">if</span>(l&lt;r)&#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">temp</span> <span class="operator">=</span> arr[l];</span><br><span class="line">                arr[l] = arr[r];</span><br><span class="line">                arr[r] = temp;</span><br><span class="line">            &#125;</span><br><span class="line">            printf(arr);</span><br><span class="line">        &#125;</span><br><span class="line">        arr[left] = arr[l];</span><br><span class="line">        arr[l] = key;</span><br><span class="line">        quickSort(arr, l+<span class="number">1</span>, right);</span><br><span class="line">        quickSort(arr, left, l-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printf</span><span class="params">(<span class="type">int</span>[] arr)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">            System.out.print(arr[i]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>打印结果</strong><br>输入</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">10</span><br><span class="line">6 1 2 7 9 3 4 5 10 8</span><br></pre></td></tr></table></figure>
<p>输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">6 1 2 5 9 3 4 7 10 8 </span><br><span class="line">6 1 2 5 4 3 9 7 10 8 </span><br><span class="line">6 1 2 5 4 3 9 7 10 8 </span><br><span class="line">3 1 2 5 4 6 9 7 8 10 </span><br><span class="line">3 1 2 5 4 6 9 7 8 10 </span><br><span class="line">3 1 2 5 4 6 8 7 9 10 </span><br><span class="line">3 1 2 5 4 6 7 8 9 10 </span><br><span class="line">2 1 3 5 4 6 7 8 9 10 </span><br><span class="line">2 1 3 4 5 6 7 8 9 10 </span><br><span class="line">1 2 3 4 5 6 7 8 9 10 </span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料:"></a>参考资料:</h1><p><a href="http://blog.csdn.net/morewindows/article/details/6665714">白话经典算法系列之二 直接插入排序的三种实现</a></p>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>最短路径</title>
    <url>/posts/The_Shortest_path.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最短路径算法一般是广搜算法。有多种情况，单源最短路径，多源最短路径，负权回路等问题</p>
<span id="more"></span>

<style type="text/css">
    .fancybox {
        display: inline-block;
    }
</style>

<h1 id="多源最短路径Floyd-Warshall算法"><a href="#多源最短路径Floyd-Warshall算法" class="headerlink" title="多源最短路径Floyd-Warshall算法"></a>多源最短路径Floyd-Warshall算法</h1><ul>
<li>优点：实现简单，代码量少</li>
<li>缺点：时间复杂度为O(n^3)，不能解决负权回路的问题</li>
</ul>
<p>使用邻接矩阵存储法存储图</p>
<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_01.png" class="" width="200">
<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_02.png" class="" width="200">

<p>遍历每个节点作为中转点，取距离的最小值<br>比如1到3，<code>a[1][3]=6</code><br>以2作为中转点，即<code>a[1][2]+a[2][3]=5&lt;a[1][3]</code></p>
<p><strong>伪代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">function <span class="title function_">floyd</span><span class="params">(map, length)</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> i,j,k;</span><br><span class="line">    <span class="keyword">for</span>(k <span class="keyword">for</span> <span class="number">0</span> to length)&#123;<span class="comment">//k为中转点，每个点都可以是中转点</span></span><br><span class="line">        <span class="keyword">for</span>(i <span class="keyword">for</span> <span class="number">0</span> to length)&#123;<span class="comment">//起点i</span></span><br><span class="line">            <span class="keyword">for</span>(j <span class="keyword">for</span> <span class="number">0</span> to length)&#123;<span class="comment">//终点j</span></span><br><span class="line">                map[i][j] = min(map[i][j], map[i][k]+map[k][j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="单源最短路径Dijkstra算法"><a href="#单源最短路径Dijkstra算法" class="headerlink" title="单源最短路径Dijkstra算法"></a>单源最短路径Dijkstra算法</h1><img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_03.png" class="" width="200">
<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_04.png" class="" width="200">
<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_05.gif" class="" width="200">
<p>假设有一个数组 <code>dis[]</code>，存储第一个点能到达的所有点的距离，<code>&#123;0,1,12,∞,∞,∞&#125;</code>,<br>那么, <code>dis[]</code> 就是 <code>第一个点1</code> 到达所有点的最短距离。<br><code>dis[]</code> 为 <code>&#123;0,1,12,∞,∞,∞&#125;</code>。</p>
<p>从<code>dis[]数组</code>可以看出, 距离<code>第一个点1</code>最近的点是<code>第二个点2</code>, 将其作为中转点。<br>再从矩阵<code>map[2][j]</code>中获取所有与<code>第二个点B</code>邻接的点, 即<code>第三个点3</code>和<code>第四个点4</code>,<br>用<code>dis[j]</code>加上<code>3、4</code>和<code>2</code>的距离，如果小于最小值<code>dis[j]</code>, 则更新<code>dis[j]</code>的值。<br><code>dis[]</code> 为 <code>&#123;0,1,10,4,∞,∞&#125;</code>。</p>
<p>再找<code>dis[]数组</code>的最小点, 因为<code>点2</code>已经使用过了, 所以选择 <code>点4</code>作为中转点。<br><code>dis[]</code> 为 <code>&#123;0,1,8,4,17,19&#125;</code>。</p>
<p>以此类推<br>以<code>点3</code>作为中转点, <code>dis[]</code> 为 <code>&#123;0,1,8,4,13,19&#125;</code>。<br>以<code>点5</code>作为中转点, <code>dis[]</code> 为 <code>&#123;0,1,8,4,13,17&#125;</code>。<br>还剩下最后一个 <code>点6</code>, 没必要找了, 因为没有另一个点可以到达了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">MAX_STEP</span> <span class="operator">=</span> <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);    </span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();<span class="comment">//顶点数</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> in.nextInt();<span class="comment">//边数</span></span><br><span class="line">    <span class="type">int</span>[][] map = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>][n+<span class="number">1</span>];<span class="comment">//存储图的邻接矩阵</span></span><br><span class="line">    <span class="type">boolean</span>[] book = <span class="keyword">new</span> <span class="title class_">boolean</span>[n+<span class="number">1</span>];<span class="comment">//标记某个点是否走过</span></span><br><span class="line">    <span class="type">int</span>[] dis = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>];<span class="comment">//存储最短距离的数组</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i==j) map[i][j] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">else</span>     map[i][j] = MAX_STEP;</span><br><span class="line">        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= m; i++)&#123;</span><br><span class="line">      map[in.nextInt()][in.nextInt()] = in.nextInt();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">      dis[i] = map[<span class="number">1</span>][i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//初始化完毕</span></span><br><span class="line">    </span><br><span class="line">    book[<span class="number">1</span>] = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n-<span class="number">1</span>; i++)&#123;<span class="comment">//遍历第1到n-1个点</span></span><br><span class="line">      <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> MAX_STEP;</span><br><span class="line">      <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;=n; j++)&#123;<span class="comment">//找到距离第i个点最近的一个点作为中转点</span></span><br><span class="line">        <span class="keyword">if</span>(book[j]==<span class="literal">false</span> &amp;&amp; dis[j]&lt;min)&#123;</span><br><span class="line">          min = dis[j];</span><br><span class="line">          next = j;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      book[next] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= n; j++)&#123;<span class="comment">//根据中转点获得新的距离，用来更新dis</span></span><br><span class="line">        dis[j] = Math.min(dis[j], dis[next]+map[next][j]);</span><br><span class="line">      &#125;</span><br><span class="line">      printf(dis);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printf</span><span class="params">(<span class="type">int</span>[] arr)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">      System.out.print(arr[i]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外还有邻接表存储图的算法(看不懂, 弃了)</p>
<h1 id="单源最短路径Bellman-Ford算法"><a href="#单源最短路径Bellman-Ford算法" class="headerlink" title="单源最短路径Bellman-Ford算法"></a>单源最短路径Bellman-Ford算法</h1><img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_03.png" class="" width="200">
<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_04.png" class="" width="200">

<p>和Dijkstra算法一样, 假设有一个数组 <code>dis[]</code>,<br>存储第一个点能到达的所有点的距离，<code>&#123;0,∞,∞,∞,∞,∞&#125;</code>,<br>那么, <code>dis[]</code> 就是 <code>第一个点0</code> 到达所有点的最短距离。<br><code>dis[]</code> 为 <code>&#123;0,∞,∞,∞,∞,∞&#125;</code>, 注意这里和Dijkstra算法不一样。</p>
<p>扫描第一条边<code>0 1 1</code>, <code>点0</code> 到 <code>点1</code> 的权值为 <code>1</code>。<br>因为 <code>点0</code>是起点, 所以<code>原先的dis[0]+第一条边的权值w[1]&lt;原先的dis[1]</code>, 也就是<code>0+1&lt;∞</code>。<br>通过第一条边, 可以把 <code>dis[]</code>更新为<code>&#123;0,1,∞,∞,∞,∞&#125;</code>。</p>
<p>扫描第二条边<code>0 2 12</code>, <code>点0</code> 到 <code>点2</code> 的权值为 <code>12</code>。<br>因为 <code>点0</code>是起点, 所以<code>原先的dis[0]+第二条边的权值w[2]&lt;原先的dis[2]</code>, 也就是<code>0+12&lt;∞</code>。<br>通过第一条边, 可以把 <code>dis[]</code>更新为<code>&#123;0,1,12,∞,∞,∞&#125;</code>。</p>
<p>扫描第三条边<code>1 2 9</code>, <code>点1</code> 到 <code>点2</code> 的权值为 <code>9</code>。<br>因为 <code>点1</code>是起点, 所以<code>原先的dis[1]+第三条边的权值w[3]&lt;原先的dis[2]</code>, 也就是<code>1+9&lt;12</code>。<br>通过第一条边, 可以把 <code>dis[]</code>更新为<code>&#123;0,1,10,∞,∞,∞&#125;</code>。</p>
<p>依次类推,<br>扫描第4条边<code>1 3 3</code>, <code>dis[]数组</code> 为 <code>&#123;0,1,10,4,∞,∞&#125;</code>。<br>扫描第5条边<code>2 4 5</code>, <code>dis[]数组</code> 为 <code>&#123;0,1,10,4,15,∞&#125;</code>。<br>扫描第6条边<code>3 2 4</code>, <code>dis[]数组</code> 为 <code>&#123;0,1,8,4,15,∞&#125;</code>。<br>扫描第7条边<code> 3 4 13</code>, <code>dis[]数组</code> 为 <code>&#123;0,1,8,4,15,∞&#125;</code>。<br>扫描第8条边<code> 3 5 15</code>, <code>dis[]数组</code> 为 <code>&#123;0,1,8,4,15,19&#125;</code>。<br>扫描第9条边<code>4 5 4</code>,<code>dis[]数组</code> 为 <code>&#123;0,1,8,4,15,19&#125;</code>。</p>
<p>第一轮扫描完毕, 一共要扫描 <code>顶点数-1</code>轮。<br>因为任意两点之间最多包含<code>顶点数-1</code>条边。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        6 9</span></span><br><span class="line"><span class="comment">        0 1 1</span></span><br><span class="line"><span class="comment">        0 2 12</span></span><br><span class="line"><span class="comment">        1 2 9</span></span><br><span class="line"><span class="comment">        1 3 3</span></span><br><span class="line"><span class="comment">        2 4 5</span></span><br><span class="line"><span class="comment">        3 2 4</span></span><br><span class="line"><span class="comment">        3 4 13</span></span><br><span class="line"><span class="comment">        3 5 15</span></span><br><span class="line"><span class="comment">        4 5 4</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt(), m = in.nextInt();</span><br><span class="line">        <span class="type">int</span>[] dis = <span class="keyword">new</span> <span class="title class_">int</span>[n]; <span class="comment">// 第0个顶点距离其他顶点的距离</span></span><br><span class="line">        <span class="type">int</span>[] u = <span class="keyword">new</span> <span class="title class_">int</span>[m];<span class="comment">// 第i条边的起点</span></span><br><span class="line">        <span class="type">int</span>[] v = <span class="keyword">new</span> <span class="title class_">int</span>[m];<span class="comment">// 第i条边的终点</span></span><br><span class="line">        <span class="type">int</span>[] w = <span class="keyword">new</span> <span class="title class_">int</span>[m];<span class="comment">// 第i条边的权值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">            u[i] = in.nextInt();</span><br><span class="line">            v[i] = in.nextInt();</span><br><span class="line">            w[i] = in.nextInt();</span><br><span class="line">        &#125;</span><br><span class="line">        dis[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; n; i++)&#123;</span><br><span class="line">            dis[i] = <span class="number">999</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 初始化完毕</span></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">equals</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">int</span>[] backupDis = <span class="keyword">new</span> <span class="title class_">int</span>[m];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 扫描 顶点数-1 轮</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>; k &lt; n-<span class="number">1</span> &amp;&amp; !equals; k++)&#123;</span><br><span class="line">            backup(dis, backupDis); <span class="comment">// 备份距离数组</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m; i++)&#123;</span><br><span class="line">                dis[v[i]] = Math.min(dis[v[i]], dis[u[i]]+w[i]); <span class="comment">// 扫描每条边, 更新dis数组</span></span><br><span class="line">            &#125;</span><br><span class="line">            equals = equals(dis, backupDis); <span class="comment">// 扫描后dis数组是否有变化, 没有则已经是最短路径</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isLoop</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; m &amp;&amp; !isLoop; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(dis[v[i]] &gt; dis[u[i]]+w[i])&#123; </span><br><span class="line">                isLoop = <span class="literal">true</span>; <span class="comment">// 如果还能继续更新, 说明有负权回路</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(isLoop?<span class="string">&#x27;有&#x27;</span>:<span class="string">&#x27;无&#x27;</span>+<span class="string">&quot;负权回路&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!isLoop)&#123;</span><br><span class="line">            System.out.println(Arrays.toString(dis));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">backup</span><span class="params">(<span class="type">int</span>[] src, <span class="type">int</span>[] backup)</span>&#123;</span><br><span class="line">        System.arraycopy(src, <span class="number">0</span>, backup, <span class="number">0</span>, src.length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(<span class="type">int</span>[] src, <span class="type">int</span>[] other)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(src.length!=other.length) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, len = src.length; i &lt; len; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(src[i]!=other[i]) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><table>
<thead>
<tr>
<th align="center">算法</th>
<th align="center">单、多源</th>
<th align="center">算法核心</th>
<th align="center">空间复杂度</th>
<th align="center">时间复杂度</th>
<th align="center">适用情况</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Floyd-Warshall</td>
<td align="center">多源</td>
<td align="center">中转点</td>
<td align="center">O(N^2)</td>
<td align="center">O(N^3)</td>
<td align="center">稠密图, 解决负权回路</td>
</tr>
<tr>
<td align="center">Dijkstra</td>
<td align="center">单源</td>
<td align="center">中转点</td>
<td align="center">O(M)</td>
<td align="center">O((M+N)logN)</td>
<td align="center">稠密图</td>
</tr>
<tr>
<td align="center">Bellman-Ford</td>
<td align="center">单源</td>
<td align="center">边</td>
<td align="center">O(M)</td>
<td align="center">O(NM)</td>
<td align="center">稀疏图, 解决负权回路</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>深搜广搜算法</title>
    <url>/posts/DFS_and_BFS.html</url>
    <content><![CDATA[<h1 id="深搜"><a href="#深搜" class="headerlink" title="深搜"></a>深搜</h1><h2 id="全排列"><a href="#全排列" class="headerlink" title="全排列"></a>全排列</h2><p>现有n个字符，要求进行全排列，比如<code>abc</code>三个字符，则有<code>abc</code>，<code>acb</code>，<code>bac</code>，<code>bca</code>，<code>cab</code>，<code>cba</code>，6种排列。</p>
<span id="more"></span>
<img data-src="/images/%E6%B7%B1%E6%90%9C%E5%B9%BF%E6%90%9C%E7%AE%97%E6%B3%95_01.png" class="">
<p><strong>java代码</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span>[] arr;<span class="comment">//待全排列字符数组</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">char</span>[] box;<span class="comment">//盒子</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span>[] flag;<span class="comment">//标记</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    arr = <span class="keyword">new</span> <span class="title class_">char</span>[n];</span><br><span class="line">    box = <span class="keyword">new</span> <span class="title class_">char</span>[n];</span><br><span class="line">    flag = <span class="keyword">new</span> <span class="title class_">boolean</span>[n];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">      arr[i] = in.next().charAt(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    dfs(<span class="number">0</span>);	<span class="comment">//核心算法</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> step)</span>&#123;<span class="comment">//前step个字符已排列，正在排列第step个字符</span></span><br><span class="line">    <span class="keyword">if</span>(step == box.length) &#123;<span class="comment">//当全部字符排列完毕，输出并return</span></span><br><span class="line">      printf(box);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; box.length; i++)&#123;</span><br><span class="line">      <span class="keyword">if</span>(flag[i]==<span class="literal">true</span>) <span class="keyword">continue</span>;<span class="comment">//第i个字符已使用则跳出</span></span><br><span class="line">      box[step] = arr[i];<span class="comment">//将第i个字符放入第step个盒子</span></span><br><span class="line">      flag[i] = <span class="literal">true</span>;<span class="comment">//标记第i个字符已使用</span></span><br><span class="line">      dfs(step+<span class="number">1</span>);</span><br><span class="line">      flag[i] = <span class="literal">false</span>;<span class="comment">//标记第i个字符未使用</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printf</span><span class="params">(<span class="type">char</span>[] flag)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; flag.length; i++)&#123;</span><br><span class="line">      System.out.print(flag[i]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="走迷宫"><a href="#走迷宫" class="headerlink" title="走迷宫"></a>走迷宫</h2><p>现有一个n*m的迷宫，标记从起点(startx,starty)到终点(endx,endy)的一条路径<br>例如，0为可行，1为墙壁，2为走过的路径标记，起点为(0,0)，终点为(3,3)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0 1 0 1</span><br><span class="line">0 0 0 1</span><br><span class="line">0 0 0 0</span><br><span class="line">1 0 0 0</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">startx</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">starty</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">endx</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">endy</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span>[][] maze = <span class="keyword">new</span> <span class="title class_">int</span>[n+<span class="number">1</span>][m+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= m; j++)&#123;</span><br><span class="line">        maze[i][j] = in.nextInt();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    maze[startx][starty] = <span class="number">2</span>;</span><br><span class="line">    dfs(startx,starty,endx,endy,maze);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">dfs</span><span class="params">(<span class="type">int</span> startx, <span class="type">int</span> starty, <span class="type">int</span> endx, <span class="type">int</span> endy, <span class="type">int</span>[][] maze)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(startx==endx&amp;&amp;starty==endy)&#123;</span><br><span class="line">      printf(maze);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(startx-<span class="number">1</span> &gt;= <span class="number">1</span> &amp;&amp; maze[startx-<span class="number">1</span>][starty]==<span class="number">0</span>)&#123;<span class="comment">//往上走</span></span><br><span class="line">      maze[startx-<span class="number">1</span>][starty]=<span class="number">2</span>;</span><br><span class="line">      dfs(startx-<span class="number">1</span>,starty,endx,endy,maze);</span><br><span class="line">      maze[startx-<span class="number">1</span>][starty] = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(startx+<span class="number">1</span> &lt;= maze.length-<span class="number">1</span> &amp;&amp; maze[startx+<span class="number">1</span>][starty]==<span class="number">0</span>)&#123;<span class="comment">//往下走</span></span><br><span class="line">      maze[startx+<span class="number">1</span>][starty]=<span class="number">2</span>;</span><br><span class="line">      dfs(startx+<span class="number">1</span>,starty,endx,endy,maze);</span><br><span class="line">      maze[startx+<span class="number">1</span>][starty]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(starty-<span class="number">1</span> &gt;= <span class="number">1</span> &amp;&amp; maze[startx][starty-<span class="number">1</span>]==<span class="number">0</span>)&#123;<span class="comment">//往左走</span></span><br><span class="line">      maze[startx][starty-<span class="number">1</span>]=<span class="number">2</span>;</span><br><span class="line">      dfs(startx,starty-<span class="number">1</span>,endx,endy,maze);</span><br><span class="line">      maze[startx][starty-<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(starty+<span class="number">1</span> &lt;= maze[startx].length-<span class="number">1</span> &amp;&amp; maze[startx][starty+<span class="number">1</span>]==<span class="number">0</span>)&#123;<span class="comment">//往右走</span></span><br><span class="line">      maze[startx][starty+<span class="number">1</span>]=<span class="number">2</span>;</span><br><span class="line">      dfs(startx,starty+<span class="number">1</span>,endx,endy,maze);</span><br><span class="line">      maze[startx][starty+<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printf</span><span class="params">(<span class="type">int</span>[][] arr)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; arr.length; i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; arr[i].length; j++)&#123;</span><br><span class="line">        System.out.print(arr[i][j]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="广搜"><a href="#广搜" class="headerlink" title="广搜"></a>广搜</h1><h2 id="走迷宫之最短路径"><a href="#走迷宫之最短路径" class="headerlink" title="走迷宫之最短路径"></a>走迷宫之最短路径</h2><p>现有一个n*m的迷宫，输出从起点(startx,starty)到终点(endx,endy)的最短路径步数<br>例如，0为可行，*为墙壁，起点为(0,0)，终点为(3,3)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0 1 0 1</span><br><span class="line">0 0 0 1</span><br><span class="line">0 0 0 0</span><br><span class="line">1 0 0 0</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Scanner</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(System.in);</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">startX</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">startY</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">endX</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">int</span> <span class="variable">endY</span> <span class="operator">=</span> in.nextInt();</span><br><span class="line">    <span class="type">char</span>[][] maze = <span class="keyword">new</span> <span class="title class_">char</span>[n+<span class="number">1</span>][m+<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= n; i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt;= m; j++)&#123;</span><br><span class="line">        maze[i][j] = in.next().charAt(<span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">int</span>[] queueX = <span class="keyword">new</span> <span class="title class_">int</span>[n*n];<span class="comment">//x坐标队列</span></span><br><span class="line">    <span class="type">int</span>[] queueY = <span class="keyword">new</span> <span class="title class_">int</span>[n*n];<span class="comment">//y坐标队列</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">head</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//头指针</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">tail</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//尾指针</span></span><br><span class="line">    queueX[head] = startX;<span class="comment">//起点入队</span></span><br><span class="line">    queueY[head] = startY;</span><br><span class="line">    maze[queueX[head]][queueY[head]] = (<span class="type">char</span>)(<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>(tail-head&gt;<span class="number">0</span>)&#123;<span class="comment">//判断队列不为空</span></span><br><span class="line">      <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> queueX[head];</span><br><span class="line">      <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> queueY[head];</span><br><span class="line">      printf(maze);</span><br><span class="line">      <span class="keyword">if</span>(x==endX &amp;&amp; y==endY)&#123;<span class="comment">//到达终点</span></span><br><span class="line">        System.out.println(maze[endX][endY]-<span class="string">&#x27;a&#x27;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(x-<span class="number">1</span>&gt;=<span class="number">1</span> &amp;&amp; maze[x-<span class="number">1</span>][y]==<span class="string">&#x27;0&#x27;</span>)&#123;<span class="comment">//往左走</span></span><br><span class="line">        maze[x-<span class="number">1</span>][y] = (<span class="type">char</span>) (maze[x][y]+<span class="number">1</span>);</span><br><span class="line">        queueX[tail] = x-<span class="number">1</span>;<span class="comment">//入队</span></span><br><span class="line">        queueY[tail] = y;</span><br><span class="line">        tail++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(x+<span class="number">1</span>&lt;=maze.length-<span class="number">1</span> &amp;&amp; maze[x+<span class="number">1</span>][y]==<span class="string">&#x27;0&#x27;</span>)&#123;<span class="comment">//往右走</span></span><br><span class="line">        maze[x+<span class="number">1</span>][y] = (<span class="type">char</span>) (maze[x][y]+<span class="number">1</span>);</span><br><span class="line">        queueX[tail] = x+<span class="number">1</span>;<span class="comment">//入队</span></span><br><span class="line">        queueY[tail] = y;</span><br><span class="line">        tail++;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span>(y-<span class="number">1</span>&gt;=<span class="number">1</span> &amp;&amp; maze[x][y-<span class="number">1</span>]==<span class="string">&#x27;0&#x27;</span>)&#123;<span class="comment">//往上走</span></span><br><span class="line">        maze[x][y-<span class="number">1</span>] = (<span class="type">char</span>) (maze[x][y]+<span class="number">1</span>);</span><br><span class="line">        queueX[tail] = x;<span class="comment">//入队</span></span><br><span class="line">        queueY[tail] = y-<span class="number">1</span>;</span><br><span class="line">        tail++;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span>(y+<span class="number">1</span>&lt;=maze[x].length-<span class="number">1</span> &amp;&amp; maze[x][y+<span class="number">1</span>]==<span class="string">&#x27;0&#x27;</span>)&#123;<span class="comment">//往下走</span></span><br><span class="line">        System.out.println((y+<span class="number">1</span>)+<span class="string">&quot;,&quot;</span>+maze[x].length+<span class="string">&quot;,&quot;</span>+maze[x][y+<span class="number">1</span>]);</span><br><span class="line">        maze[x][y+<span class="number">1</span>] = (<span class="type">char</span>) (maze[x][y]+<span class="number">1</span>);</span><br><span class="line">        queueX[tail] = x;<span class="comment">//入队</span></span><br><span class="line">        queueY[tail] = y+<span class="number">1</span>;</span><br><span class="line">        tail++;</span><br><span class="line">      &#125;</span><br><span class="line">      head++;<span class="comment">//出队</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">printf</span><span class="params">(<span class="type">char</span>[][] maze)</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt; maze.length; i++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">1</span>; j &lt; maze[i].length; j++)&#123;</span><br><span class="line">        System.out.print(maze[i][j]+<span class="string">&quot; &quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.out.println(<span class="string">&quot;&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>算法</category>
      </categories>
      <tags>
        <tag>算法</tag>
      </tags>
  </entry>
  <entry>
    <title>Activity、Fragment状态缓存和恢复</title>
    <url>/posts/Save_Restore_Activity%E2%80%99s_and_Fragment%E2%80%99s_state.html</url>
    <content><![CDATA[<h1 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h1><blockquote>
<p><a href="https://inthecheesefactory.com/blog/fragment-state-saving-best-practices/en">Activity/Fragment状态缓存和恢复的最佳实践</a><br><a href="http://www.voidcn.com/blog/lwk520136/article/p-6138230.html">译文</a></p>
</blockquote>
<span id="more"></span>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="Activity"><a href="#Activity" class="headerlink" title="Activity"></a>Activity</h2><p><code>Activity</code>中已经自己实现了。<br>只要重写<code>onSaveInstanceState()</code>和<code>onRestoreInstanceState()</code>这两个方法即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onSaveInstanceState</span><span class="params">(Bundle outState)</span> &#123;</span><br><span class="line">    outState.putString(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="built_in">super</span>.onSaveInstanceState(outState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onRestoreInstanceState</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onRestoreInstanceState(savedInstanceState);</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> savedInstanceState.getString(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    Log.i(TAG, <span class="string">&quot;onRestoreInstanceState: &quot;</span>+value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Fragment"><a href="#Fragment" class="headerlink" title="Fragment"></a>Fragment</h2><p><code>Fragment</code>分为两种：</p>
<ul>
<li>一种是<code>View</code>的<code>Save/Restore</code></li>
<li>另一种是<code>Fragment</code>自身数据的<code>Save/Restore</code></li>
</ul>
<h3 id="View的Save-Restore"><a href="#View的Save-Restore" class="headerlink" title="View的Save/Restore"></a>View的Save/Restore</h3><p>和<code>Activity</code>一样，在<code>View</code>内部实现<code>onSaveInstanceState()</code>和<code>onRestoreInstanceState()</code>即可。<br>如果是第三方的View，则写一个子类手动实现<code>Save/Restore</code>即可。</p>
<h3 id="Fragment的Save-Restore"><a href="#Fragment的Save-Restore" class="headerlink" title="Fragment的Save/Restore"></a>Fragment的Save/Restore</h3><p>在Fragment内部实现<code>onSaveInstanceState()</code>和<code>onActivityCreated()</code>即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onSaveInstanceState</span><span class="params">(Bundle outState)</span> &#123;</span><br><span class="line">    outState.putString(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">    <span class="built_in">super</span>.onSaveInstanceState(outState);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onActivityCreated</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onActivityCreated(savedInstanceState);</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> savedInstanceState.getString(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">    Log.i(TAG, <span class="string">&quot;onRestoreInstanceState: &quot;</span>+value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Activity</tag>
        <tag>Fragment</tag>
      </tags>
  </entry>
  <entry>
    <title>Android命名规范和编码规范</title>
    <url>/posts/Android_naming_conventions_and_coding_specifications.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文适用范围：已参加项目开发的人</p>
<p>写这篇文章的目的是为方便地对代码进行管理，让整个团队的代码规范化。这里的部分规定可能和你在其他地方看到的不一样，但还是请遵守这些规则。</p>
<blockquote>
<p>编码规范是泯灭程序猿个性的一项制度，但对于整个团队而言，却是一件利器<br>-《App 研发录》</p>
</blockquote>
<span id="more"></span>

<h1 id="统一代码格式"><a href="#统一代码格式" class="headerlink" title="统一代码格式"></a>统一代码格式</h1><p>首先请参照这篇文章设置 <code>Android Studio</code> 的 <code>Code Style</code>：<br><a href="http://blog.qiji.tech/archives/5153">设置 Code Style</a><br>细心的同学可能会发现代码风格跟 <code>Google</code> 推荐的不一致，但请记住，我们是一个团队。</p>
<h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><img data-src="/images/Android%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E5%92%8C%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83_01.jpg" class="">
<h2 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h2><h3 id="控件-Id-命名方式"><a href="#控件-Id-命名方式" class="headerlink" title="控件 Id 命名方式"></a>控件 Id 命名方式</h3><p>命名模式：<code>View</code> 缩写_逻辑名称<br>例如一个登陆按钮 <code>Button</code>：<code>id</code> 为 <code>btn_login</code>，私有成员变量 <code>mBtnLogin</code></p>
<table>
<thead>
<tr>
<th align="left">View</th>
<th align="left">@Id</th>
<th align="left">ava variable（private）</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Button</td>
<td align="left">btn_</td>
<td align="left">mBtnLogin</td>
</tr>
<tr>
<td align="left">TextView</td>
<td align="left">txt_</td>
<td align="left">mTxtLogin</td>
</tr>
<tr>
<td align="left">ImageView</td>
<td align="left">img_</td>
<td align="left">mImageLogin</td>
</tr>
<tr>
<td align="left">EditText</td>
<td align="left">edt_</td>
<td align="left">mEdtContent</td>
</tr>
<tr>
<td align="left">Spinner</td>
<td align="left">spinner_</td>
<td align="left">mSpinnerNation</td>
</tr>
<tr>
<td align="left">TabLayout</td>
<td align="left">tab_</td>
<td align="left">mTabLayout</td>
</tr>
<tr>
<td align="left">LinearLayout</td>
<td align="left">linear_</td>
<td align="left">mLinearLayout</td>
</tr>
</tbody></table>
<h3 id="Layout-相关"><a href="#Layout-相关" class="headerlink" title="Layout 相关"></a>Layout 相关</h3><table>
<thead>
<tr>
<th align="left">Component</th>
<th align="left">Class Name</th>
<th align="left">Layout Name</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Activity</td>
<td align="left">UserProfileActivity</td>
<td align="left">activity_user_profile.xml</td>
</tr>
<tr>
<td align="left">Fragment</td>
<td align="left">SignUpFragment</td>
<td align="left">fragment_sign_up.xml</td>
</tr>
<tr>
<td align="left">Dialog</td>
<td align="left">ChangePasswordDialog</td>
<td align="left">dialog_change_password.xml</td>
</tr>
<tr>
<td align="left">AdapterView item</td>
<td align="left">-</td>
<td align="left">list_item_archive.xml</td>
</tr>
</tbody></table>
<h3 id="Color-相关"><a href="#Color-相关" class="headerlink" title="Color 相关"></a>Color 相关</h3><p>通常我们不直接使用数字来定义一些属性值，而是先将它定义在所对应的文件里，然后去引用它。</p>
<ul>
<li>推荐从 <code>Material Design</code> 中 <code>Color</code> 中选取颜色(后详)</li>
<li>尽量以 “颜色名称_程度” 来命名</li>
<li>必要时也可用颜色功能来命名</li>
</ul>
<p>在<a href="https://material.google.com/style/color.html#color-color-palette">Material color palette</a> 的网页中，可以看到官方设计文档的调色板，尽量从文档中选取颜色，来命名和使用。<br>命名采用全小写，下划线分割的形式。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- color --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;grey_xlight&quot;</span>&gt;</span># F5F5F5<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;grey_light&quot;</span>&gt;</span># E0E0E0<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;grey&quot;</span>&gt;</span># 9E9E9E<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;grey_dark&quot;</span>&gt;</span># 616161<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;grey_xdark&quot;</span>&gt;</span># 424242<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;title_normal&quot;</span>&gt;</span># FBE9E7<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;bg_pop&gt;# FF6D00&lt;/color&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag"> </span></span></span><br><span class="line"><span class="string"><span class="tag">&lt;!-- material color --&gt;</span></span></span><br><span class="line"><span class="string"><span class="tag"> &lt;color name=&quot;</span><span class="attr">material_red_500</span>&quot;&gt;</span># F44336<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;material_purple_100&quot;</span>&gt;</span># E1BEE7<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;material_green_800&quot;</span>&gt;</span># 2E7D32<span class="tag">&lt;/<span class="name">color</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意 <code>Material color</code> 的命名方式</p>
<h3 id="Dimen-相关"><a href="#Dimen-相关" class="headerlink" title="Dimen 相关"></a>Dimen 相关</h3><ul>
<li>尽量以 “逻辑名称_程度” 来命名</li>
<li>必要时也可用 “逻辑名称_功能” 来命名<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- text size --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_xxsmall&quot;</span>&gt;</span>12sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_xsmall&quot;</span>&gt;</span>14sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_small&quot;</span>&gt;</span>16sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_medium&quot;</span>&gt;</span>18sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_large&quot;</span>&gt;</span>20sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_xlarge&quot;</span>&gt;</span>22sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;text_size_title&quot;</span>&gt;</span>18sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">&lt;!-- typical spacing between two views, margin or padding --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;spacing_tiny&quot;</span>&gt;</span>4dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;spacing_small&quot;</span>&gt;</span>10dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;spacing_medium&quot;</span>&gt;</span>14dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;spacing_large&quot;</span>&gt;</span>24dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;spacing_huge&quot;</span>&gt;</span>40dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- typical sizes of views --&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;button_height_small&quot;</span>&gt;</span>32dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;button_height_medium&quot;</span>&gt;</span>40dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;button_height_large&quot;</span>&gt;</span>60dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="String-相关"><a href="#String-相关" class="headerlink" title="String 相关"></a>String 相关</h3>String 命名的前缀应该能够清楚地表达它的功能职责，若是某个模块的字符串，可以以这个模块的名字为前缀然后再加上它的含义，如，<code>registratione_mail_hint</code>，<code>registration_name_hint</code>。<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;app_name&quot;</span>&gt;</span>app名<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;registration_email_hint&quot;</span>&gt;</span>请输入邮箱地址<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">string</span> <span class="attr">name</span>=<span class="string">&quot;registration_name_hint&quot;</span>&gt;</span>请输入用户名<span class="tag">&lt;/<span class="name">string</span>&gt;</span></span><br></pre></td></tr></table></figure>
如果一个Sting不属于任何模块，这也就意味着它是通用的，应该遵循以下规范：</li>
</ul>
<table>
<thead>
<tr>
<th align="left">type</th>
<th align="left">detail</th>
</tr>
</thead>
<tbody><tr>
<td align="left">error_</td>
<td align="left">错误提示</td>
</tr>
<tr>
<td align="left">success_</td>
<td align="left">正确提示</td>
</tr>
<tr>
<td align="left">msg_</td>
<td align="left">一般信息提示</td>
</tr>
<tr>
<td align="left">title_</td>
<td align="left">标题提示，如，Dialog 标题</td>
</tr>
<tr>
<td align="left">action_</td>
<td align="left">动作提示，如，“保存”，“取消”，“创建”</td>
</tr>
<tr>
<td align="left">direct_</td>
<td align="left">页面跳转提示</td>
</tr>
</tbody></table>
<p>其他通用字符串尽量以：类别_功能 或 含义 来命名</p>
<h3 id="Drawable-相关"><a href="#Drawable-相关" class="headerlink" title="Drawable 相关"></a>Drawable 相关</h3><p>当没有多种类型的图片时，图片统一放在 drawable-xxhdpi 的文件夹下</p>
<table>
<thead>
<tr>
<th align="left">Asset Type</th>
<th align="left">Prefix</th>
<th align="left">Example</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Action bar</td>
<td align="left">ab_</td>
<td align="left">ab_stacked.9.png</td>
</tr>
<tr>
<td align="left">Button</td>
<td align="left">btn_</td>
<td align="left">btn_send_pressed.9.png</td>
</tr>
<tr>
<td align="left">Dialog</td>
<td align="left">dialog_</td>
<td align="left">dialog_top.9.png</td>
</tr>
<tr>
<td align="left">Divider</td>
<td align="left">divider_</td>
<td align="left">divider_horizontal.9.png</td>
</tr>
<tr>
<td align="left">Icon</td>
<td align="left">ic_</td>
<td align="left">ic_star.png</td>
</tr>
<tr>
<td align="left">Menu</td>
<td align="left">menu_</td>
<td align="left">menu_submenu_bg.9.png</td>
</tr>
<tr>
<td align="left">Notification</td>
<td align="left">notification_</td>
<td align="left">notification_bg.9.png</td>
</tr>
<tr>
<td align="left">Tabs</td>
<td align="left">tab_</td>
<td align="left">tab_pressed.9.png</td>
</tr>
</tbody></table>
<h2 id="Android-编码规范"><a href="#Android-编码规范" class="headerlink" title="Android 编码规范"></a>Android 编码规范</h2><h3 id="XML-文件规范"><a href="#XML-文件规范" class="headerlink" title="XML 文件规范"></a>XML 文件规范</h3><p><strong>属性</strong><br>当你写好 layout 文件后，按 <code>Ctrl + alt + L</code> 格式化后，手动排版为下面这样的格式：</p>
<ul>
<li>每行两个属性</li>
<li><code>android:id</code> 作为第一个属性</li>
<li>如果存在 <code>style</code> 属性，则紧随作为第二行首个属性</li>
<li>如果不存在 <code>style</code> 属性，则 <code>android:layout_xxx</code> 紧随作为第二行首个属性</li>
<li>当布局中的一个元素不再包含子元素时，在最后一个属性右边使用自闭合标签<code>/&gt;</code><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag"> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span> <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line"> </span><br><span class="line"> <span class="tag">&lt;<span class="name">TextView</span> <span class="attr">android:id</span>=<span class="string">&quot;@+id/txt_name&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">style</span>=<span class="string">&quot;@style/FancyText&quot;</span> <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span> <span class="attr">android:layout_alignParentRight</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<p> <strong>使用 Tools</strong><br>布局预览应使用 <code>tools:</code>相关属性，避免 <code>android:text</code> 等硬编码的出现</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag"> <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span> <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag"> <span class="attr">tools:text</span>=<span class="string">&quot;Home Link&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="Java-代码规范"><a href="#Java-代码规范" class="headerlink" title="Java 代码规范"></a>Java 代码规范</h2><h3 id="Field"><a href="#Field" class="headerlink" title="Field"></a>Field</h3><p>对Field的定义应该放在文件的首位，并且遵守以下规范：</p>
<ul>
<li>被 <code>private</code> 修饰的非静态变量，以 <code>m</code> 作为前缀</li>
<li>被 <code>private</code> 修饰的静态变量，以 <code>s</code> 作为前缀</li>
<li>被 <code>public</code> 修饰的非静态变量，以小写首字母做前缀</li>
<li>其他变量，以 <code>m</code> 作为前缀，采用驼峰命名</li>
<li>静态常量命名字母全部大写，单词之间用下划线分隔<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyClass</span> &#123;</span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SOME_CONSTANT</span> <span class="operator">=</span> <span class="number">42</span>;</span><br><span class="line"> </span><br><span class="line"> <span class="meta">@Bind(R.id.edit_collection_name)</span> EditText mEdtName;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span> <span class="type">int</span> publicField;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> MyClass sSingleton;</span><br><span class="line"> <span class="type">int</span> mPackagePrivate;</span><br><span class="line"> <span class="keyword">private</span> <span class="type">int</span> mPrivate;</span><br><span class="line"> <span class="keyword">protected</span> <span class="type">int</span> mProtected;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="Entity"><a href="#Entity" class="headerlink" title="Entity"></a>Entity</h3><p>对于继承 <code>Entity</code> 的 <code>Model</code> 类型，按照下图进行编码：</p>
<img data-src="/images/Android%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83%E5%92%8C%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83_02.png" class="">
<p>注意变量修饰符和大小写</p>
<h3 id="类成员排序"><a href="#类成员排序" class="headerlink" title="类成员排序"></a>类成员排序</h3><p>关于这个并没有硬性要求，不过好的排序方式，能够提高可读性和易学性。这里给出一些排序建议：</p>
<ol>
<li>常量</li>
<li>字段</li>
<li>构造函数</li>
<li>被重写的函数（不区分修饰符类型）</li>
<li>被private修饰的函数</li>
<li>被public修饰的函数</li>
<li>被定义的内部类或者接口</li>
</ol>
<p><strong>如果继承了<code>Android</code>组件，比如<code>Activity</code>或者<code>Fragment</code>，重写生命周期函数时，应该按照组件的生命周期进行排序</strong><br>示例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">Activity</span> &#123;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> MainActivity.class.getSimpleName();</span><br><span class="line"> <span class="keyword">private</span> String mTitle;</span><br><span class="line"> <span class="keyword">private</span> TextView mTextViewTitle;</span><br><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setUpView</span><span class="params">()</span> &#123; &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setTitle</span><span class="params">(String title)</span> &#123;</span><br><span class="line"> mTitle = title;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">AnInnerClass</span> &#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="字符串常量的命名"><a href="#字符串常量的命名" class="headerlink" title="字符串常量的命名"></a>字符串常量的命名</h3><p><code>Android SDK</code> 中诸如 <code>SharedPreferences</code>，<code>Bundle</code> 和 <code>Intent</code> 等，都采用 <code>key-value</code> 的方式进行赋值，当使用这些组件的时候，key 必须被 <code>static final</code> 所修饰，并且命名应该符合以下规范：</p>
<table>
<thead>
<tr>
<th align="left">ElementField</th>
<th align="left">Name Prefix</th>
</tr>
</thead>
<tbody><tr>
<td align="left">SharedPreferences</td>
<td align="left">PREF_</td>
</tr>
<tr>
<td align="left">Bundle</td>
<td align="left">BUNDLE_</td>
</tr>
<tr>
<td align="left">Fragment Arguments</td>
<td align="left">ARGUMENT_</td>
</tr>
<tr>
<td align="left">Intent Extra</td>
<td align="left">EXTRA_</td>
</tr>
<tr>
<td align="left">Intent Action</td>
<td align="left">ACTION_</td>
</tr>
</tbody></table>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PREF_EMAIL</span> <span class="operator">=</span> <span class="string">&quot;PREF_EMAIL&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BUNDLE_AGE</span> <span class="operator">=</span> <span class="string">&quot;BUNDLE_AGE&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ARGUMENT_USER_ID</span> <span class="operator">=</span> <span class="string">&quot;ARGUMENT_USER_ID&quot;</span>;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXTRA_SURNAME</span> <span class="operator">=</span> <span class="string">&quot;com.myapp.extras.EXTRA_SURNAME&quot;</span>;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ACTION_OPEN_USER</span> <span class="operator">=</span> <span class="string">&quot;com.myapp.action.ACTION_OPEN_USER&quot;</span>;</span><br></pre></td></tr></table></figure>

<h3 id="Activity-与-Fragment-打开方式"><a href="#Activity-与-Fragment-打开方式" class="headerlink" title="Activity 与 Fragment 打开方式"></a>Activity 与 Fragment 打开方式</h3><p>当通过 <code>Intent</code> 或者<code>Bundle</code>向<code>Activity</code>与<code>Fragment</code>传值时，应该遵循上面提到的<code>key-value</code>规范，公开一个被 <code>public static</code> 修饰的方法，方法的参数应该包含所有打开这个 <code>Activity</code> 或者 <code>Fragment</code> 的信息，示例如下：</p>
<ul>
<li>通过 <code>.startActivity()</code> 函数，开启指定 <code>Activity</code>：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startActivity</span><span class="params">(AppCompatActivity startingActivity, User user)</span> &#123;</span><br><span class="line"> <span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(startingActivity, ThisActivity.class);</span><br><span class="line"> intent.putParcelableExtra(EXTRA_USER, user);</span><br><span class="line"> startingActivity.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>通过 <code>.newInstance()</code> 函数，加载指定 <code>Fragment</code>：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> UserFragment <span class="title function_">newInstance</span><span class="params">(User user)</span> &#123;</span><br><span class="line"> <span class="type">UserFragment</span> <span class="variable">fragment</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserFragment</span>;</span><br><span class="line"> <span class="type">Bundle</span> <span class="variable">args</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bundle</span>();</span><br><span class="line"> args.putParcelable(ARGUMENT_USER, user);</span><br><span class="line"> fragment.setArguments(args)</span><br><span class="line"> <span class="keyword">return</span> fragment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1>如果您所寻找的命名不在上述规范中，可以暂时使用自己的方式来命名，但也要有一定格式并在自己的程序中统一。<br>通常我们会把更大的类别放在前，更细致的放在后。<br>欢迎大家提出问题，互相探讨，共同维护出一份更好的更清晰的开发规范。</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.qiji.tech/archives/10395">[Android]命名规范和编码规范</a></li>
<li><a href="https://github.com/RxSmart/Link-Android-Guideline/blob/master/Android-Guideline.md">Android编码规范</a></li>
<li><a href="https://github.com/nekocode/nekoblog/blob/master/AndroidDevGuideline.md#property-%E5%AE%9A%E4%B9%89%E4%B8%8E%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83">Android Development Guideline</a></li>
<li><a href="http://blog.csdn.net/vipzjyno1/article/details/23542617">Android 命名规范 （提高代码可以读性）</a></li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>编码规范</tag>
      </tags>
  </entry>
  <entry>
    <title>常用配置文件</title>
    <url>/posts/Android_common_xml.html</url>
    <content><![CDATA[<h1 id="dimens-xml"><a href="#dimens-xml" class="headerlink" title="dimens.xml"></a>dimens.xml</h1><p>经常需要使用到一些尺寸，这里就记录一下，方便拷贝。<br>直接在<code>values中</code>的<code>dimens.xml</code>文件中粘贴即可<br>使用方法，如：<code>Android:TextSize=&quot;@dimens/offset_2dp&quot;</code></p>
<span id="more"></span>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- text size --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_tiny&quot;</span>&gt;</span>10sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_small&quot;</span>&gt;</span>12sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_normal&quot;</span>&gt;</span>14sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_normal_high&quot;</span>&gt;</span>16sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_large&quot;</span>&gt;</span>18sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_large_high&quot;</span>&gt;</span>20sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;font_size_xlarge&quot;</span>&gt;</span>22sp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--边距--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;offset_2dp&quot;</span>&gt;</span>2dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;offset_4dp&quot;</span>&gt;</span>4dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">&quot;offset_6dp&quot;</span>&gt;</span>6dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="colors-xml"><a href="#colors-xml" class="headerlink" title="colors.xml"></a>colors.xml</h1><p>经常需要使用到一些颜色，这里就记录一下，方便拷贝。<br>直接在values中的colors.xml文件中粘贴即可<br>使用方法，如：<code>Android:background=&quot;@color/yellow&quot;</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--values中的colors.xml文件--&gt;</span>  </span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;colorPrimary&quot;</span>&gt;</span>#3F51B5<span class="tag">&lt;/<span class="name">color</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;colorPrimaryDark&quot;</span>&gt;</span>#303F9F<span class="tag">&lt;/<span class="name">color</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;colorAccent&quot;</span>&gt;</span>#FF4081<span class="tag">&lt;/<span class="name">color</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;white&quot;</span>&gt;</span>#FFFFFF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--白色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;ivory&quot;</span>&gt;</span>#FFFFF0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--象牙色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightyellow&quot;</span>&gt;</span>#FFFFE0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮黄色--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;yellow&quot;</span>&gt;</span>#FFFF00<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--黄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;snow&quot;</span>&gt;</span>#FFFAFA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--雪白色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;floralwhite&quot;</span>&gt;</span>#FFFAF0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--花白色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lemonchiffon&quot;</span>&gt;</span>#FFFACD<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--柠檬绸色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;cornsilk&quot;</span>&gt;</span>#FFF8DC<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--米绸色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;seashell&quot;</span>&gt;</span>#FFF5EE<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--海贝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lavenderblush&quot;</span>&gt;</span>#FFF0F5<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--淡紫红 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;papayawhip&quot;</span>&gt;</span>#FFEFD5<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--番木色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;blanchedalmond&quot;</span>&gt;</span>#FFEBCD<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--白杏色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mistyrose&quot;</span>&gt;</span>#FFE4E1<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--浅玫瑰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;bisque&quot;</span>&gt;</span>#FFE4C4<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--桔黄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;moccasin&quot;</span>&gt;</span>#FFE4B5<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--鹿皮色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;navajowhite&quot;</span>&gt;</span>#FFDEAD<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--纳瓦白 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;peachpuff&quot;</span>&gt;</span>#FFDAB9<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--桃色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;gold&quot;</span>&gt;</span>#FFD700<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--金色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;pink&quot;</span>&gt;</span>#FFC0CB<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--粉红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightpink&quot;</span>&gt;</span>#FFB6C1<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮粉红色--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;orange&quot;</span>&gt;</span>#FFA500<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--橙色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightsalmon&quot;</span>&gt;</span>#FFA07A<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮肉色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkorange&quot;</span>&gt;</span>#FF8C00<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗桔黄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;coral&quot;</span>&gt;</span>#FF7F50<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--珊瑚色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;hotpink&quot;</span>&gt;</span>#FF69B4<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--热粉红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;tomato&quot;</span>&gt;</span>#FF6347<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--西红柿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;orangered&quot;</span>&gt;</span>#FF4500<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--红橙色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;deeppink&quot;</span>&gt;</span>#FF1493<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--深粉红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;fuchsia&quot;</span>&gt;</span>#FF00FF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--紫红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;magenta&quot;</span>&gt;</span>#FF00FF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--红紫色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;red&quot;</span>&gt;</span>#FF0000<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;oldlace&quot;</span>&gt;</span>#FDF5E6<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--老花色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightgoldenrodyellow&quot;</span>&gt;</span>#FAFAD2<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮金黄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;linen&quot;</span>&gt;</span>#FAF0E6<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亚麻色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;antiquewhite&quot;</span>&gt;</span>#FAEBD7<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--古董白 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;salmon&quot;</span>&gt;</span>#FA8072<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--鲜肉色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;ghostwhite&quot;</span>&gt;</span>#F8F8FF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--幽灵白 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mintcream&quot;</span>&gt;</span>#F5FFFA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--薄荷色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;whitesmoke&quot;</span>&gt;</span>#F5F5F5<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--烟白色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;beige&quot;</span>&gt;</span>#F5F5DC<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--米色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;wheat&quot;</span>&gt;</span>#F5DEB3<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--浅黄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;sandybrown&quot;</span>&gt;</span>#F4A460<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--沙褐色--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;azure&quot;</span>&gt;</span>#F0FFFF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--天蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;honeydew&quot;</span>&gt;</span>#F0FFF0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--蜜色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;aliceblue&quot;</span>&gt;</span>#F0F8FF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--艾利斯兰 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;khaki&quot;</span>&gt;</span>#F0E68C<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--黄褐色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightcoral&quot;</span>&gt;</span>#F08080<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮珊瑚色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;palegoldenrod&quot;</span>&gt;</span>#EEE8AA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--苍麒麟色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;violet&quot;</span>&gt;</span>#EE82EE<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--紫罗兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darksalmon&quot;</span>&gt;</span>#E9967A<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗肉色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lavender&quot;</span>&gt;</span>#E6E6FA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--淡紫色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightcyan&quot;</span>&gt;</span>#E0FFFF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮青色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;burlywood&quot;</span>&gt;</span>#DEB887<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--实木色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;plum&quot;</span>&gt;</span>#DDA0DD<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--洋李色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;gainsboro&quot;</span>&gt;</span>#DCDCDC<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--淡灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;crimson&quot;</span>&gt;</span>#DC143C<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗深红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;palevioletred&quot;</span>&gt;</span>#DB7093<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--苍紫罗兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;goldenrod&quot;</span>&gt;</span>#DAA520<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--金麒麟色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;orchid&quot;</span>&gt;</span>#DA70D6<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--淡紫色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;thistle&quot;</span>&gt;</span>#D8BFD8<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--蓟色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightgray&quot;</span>&gt;</span>#D3D3D3<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightgrey&quot;</span>&gt;</span>#D3D3D3<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;tan&quot;</span>&gt;</span>#D2B48C<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--茶色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;chocolate&quot;</span>&gt;</span>#D2691E<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--巧可力色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;peru&quot;</span>&gt;</span>#CD853F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--秘鲁色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;indianred&quot;</span>&gt;</span>#CD5C5C<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--印第安红 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumvioletred&quot;</span>&gt;</span>#C71585<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中紫罗兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;silver&quot;</span>&gt;</span>#C0C0C0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--银色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkkhaki&quot;</span>&gt;</span>#BDB76B<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗黄褐色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;rosybrown&quot;</span>&gt;</span>#BC8F8F<span class="tag">&lt;/<span class="name">color</span>&gt;</span> <span class="comment">&lt;!--褐玫瑰红 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumorchid&quot;</span>&gt;</span>#BA55D3<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中粉紫色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkgoldenrod&quot;</span>&gt;</span>#B8860B<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗金黄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;firebrick&quot;</span>&gt;</span>#B22222<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--火砖色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;powderblue&quot;</span>&gt;</span>#B0E0E6<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--粉蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightsteelblue&quot;</span>&gt;</span>#B0C4DE<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮钢兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;paleturquoise&quot;</span>&gt;</span>#AFEEEE<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--苍宝石绿 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;greenyellow&quot;</span>&gt;</span>#ADFF2F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--黄绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightblue&quot;</span>&gt;</span>#ADD8E6<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkgray&quot;</span>&gt;</span>#A9A9A9<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkgrey&quot;</span>&gt;</span>#A9A9A9<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;brown&quot;</span>&gt;</span>#A52A2A<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--褐色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;sienna&quot;</span>&gt;</span>#A0522D<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--赭色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkorchid&quot;</span>&gt;</span>#9932CC<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗紫色--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;palegreen&quot;</span>&gt;</span>#98FB98<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--苍绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkviolet&quot;</span>&gt;</span>#9400D3<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗紫罗兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumpurple&quot;</span>&gt;</span>#9370DB<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中紫色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightgreen&quot;</span>&gt;</span>#90EE90<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkseagreen&quot;</span>&gt;</span>#8FBC8F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗海兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;saddlebrown&quot;</span>&gt;</span>#8B4513<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--重褐色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkmagenta&quot;</span>&gt;</span>#8B008B<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗洋红 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkred&quot;</span>&gt;</span>#8B0000<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗红色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;blueviolet&quot;</span>&gt;</span>#8A2BE2<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--紫罗兰蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightskyblue&quot;</span>&gt;</span>#87CEFA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮天蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;skyblue&quot;</span>&gt;</span>#87CEEB<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--天蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;gray&quot;</span>&gt;</span>#808080<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;grey&quot;</span>&gt;</span>#808080<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;olive&quot;</span>&gt;</span>#808000<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--橄榄色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;purple&quot;</span>&gt;</span>#800080<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--紫色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;maroon&quot;</span>&gt;</span>#800000<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--粟色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;aquamarine&quot;</span>&gt;</span>#7FFFD4<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--碧绿色--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;chartreuse&quot;</span>&gt;</span>#7FFF00<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--黄绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lawngreen&quot;</span>&gt;</span>#7CFC00<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--草绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumslateblue&quot;</span>&gt;</span>#7B68EE<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中暗蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightslategray&quot;</span>&gt;</span>#778899<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮蓝灰 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightslategrey&quot;</span>&gt;</span>#778899<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮蓝灰 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;slategray&quot;</span>&gt;</span>#708090<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--灰石色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;slategrey&quot;</span>&gt;</span>#708090<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--灰石色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;olivedrab&quot;</span>&gt;</span>#6B8E23<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--深绿褐色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;slateblue&quot;</span>&gt;</span>#6A5ACD<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--石蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;dimgray&quot;</span>&gt;</span>#696969<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;dimgrey&quot;</span>&gt;</span>#696969<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumaquamarine&quot;</span>&gt;</span>#66CDAA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;cornflowerblue&quot;</span>&gt;</span>#6495ED<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--菊兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;cadetblue&quot;</span>&gt;</span>#5F9EA0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--军兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkolivegreen&quot;</span>&gt;</span>#556B2F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗橄榄绿  --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;indigo&quot;</span>&gt;</span>#4B0082<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--靛青色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumturquoise&quot;</span>&gt;</span>#48D1CC<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中绿宝石 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkslateblue&quot;</span>&gt;</span>#483D8B<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗灰蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;steelblue&quot;</span>&gt;</span>#4682B4<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--钢兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;royalblue&quot;</span>&gt;</span>#4169E1<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--皇家蓝 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;turquoise&quot;</span>&gt;</span>#40E0D0<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--青绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumseagreen&quot;</span>&gt;</span>#3CB371<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中海蓝 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;limegreen&quot;</span>&gt;</span>#32CD32<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--橙绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkslategray&quot;</span>&gt;</span>#2F4F4F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗瓦灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkslategrey&quot;</span>&gt;</span>#2F4F4F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗瓦灰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;seagreen&quot;</span>&gt;</span>#2E8B57<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--海绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;forestgreen&quot;</span>&gt;</span>#228B22<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--森林绿 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lightseagreen&quot;</span>&gt;</span>#20B2AA<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--亮海蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;dodgerblue&quot;</span>&gt;</span>#1E90FF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--闪兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;midnightblue&quot;</span>&gt;</span>#191970<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中灰兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;aqua&quot;</span>&gt;</span>#00FFFF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--浅绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;cyan&quot;</span>&gt;</span>#00FFFF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--青色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;springgreen&quot;</span>&gt;</span>#00FF7F<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--春绿色--&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;lime&quot;</span>&gt;</span>#00FF00<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--酸橙色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumspringgreen&quot;</span>&gt;</span>#00FA9A<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中春绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkturquoise&quot;</span>&gt;</span>#00CED1<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗宝石绿 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;deepskyblue&quot;</span>&gt;</span>#00BFFF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--深天蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkcyan&quot;</span>&gt;</span>#008B8B<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗青色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;teal&quot;</span>&gt;</span>#008080<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--水鸭色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;green&quot;</span>&gt;</span>#008000<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkgreen&quot;</span>&gt;</span>#006400<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗绿色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;blue&quot;</span>&gt;</span>#0000FF<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;mediumblue&quot;</span>&gt;</span>#0000CD<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--中兰色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;darkblue&quot;</span>&gt;</span>#00008B<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--暗蓝色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;navy&quot;</span>&gt;</span>#000080<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--海军色 --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">color</span> <span class="attr">name</span>=<span class="string">&quot;black&quot;</span>&gt;</span>#000000<span class="tag">&lt;/<span class="name">color</span>&gt;</span><span class="comment">&lt;!--黑色 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span>  </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>配置文件</tag>
      </tags>
  </entry>
  <entry>
    <title>Android沉浸式状态栏</title>
    <url>/posts/Android_Using_Immersive_Full-Screen_Mode.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>沉浸式状态栏的实现方式在以前是五花八门。<br>在这里主要是给出一个我觉得比较完美的实现沉浸式状态栏的方案（兼容最低android4.4）。</p>
<span id="more"></span>

<h1 id="效果图"><a href="#效果图" class="headerlink" title="效果图"></a>效果图</h1><p>android 5.0 以上</p>
<img data-src="/images/Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A0%8F_01.gif" class="">

<p>android 4.4 API 19</p>
<img data-src="/images/Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A0%8F_02.gif" class="">

<p>以上都是原生安卓系统的效果，具体到国内的各种各样改过的系统可能会有细微差别，我测试小米和华为的机器效果基本一样。</p>
<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="修改主题属性"><a href="#修改主题属性" class="headerlink" title="修改主题属性"></a>修改主题属性</h2><p>在values-v19之后的主题属性中添加一条即可,如下</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowTranslucentStatus&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="设置fitsSystemWindows属性"><a href="#设置fitsSystemWindows属性" class="headerlink" title="设置fitsSystemWindows属性"></a>设置fitsSystemWindows属性</h2><p>如果你想让一个View的图像显示在状态栏下，那么就在View的XML布局文件中添加如下属性</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">android:fitsSystemWindows=&quot;true&quot;</span><br></pre></td></tr></table></figure>
<p>例子：<br>这里我设置了ToolBar</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">android.support.design.widget.CoordinatorLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">&quot;com.mjj.statusbar.MainActivity&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">android.support.design.widget.AppBarLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">&quot;@style/AppTheme.AppBarOverlay&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">android.support.v7.widget.Toolbar</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/toolbar&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;?attr/actionBarSize&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">&quot;?attr/colorPrimary&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:fitsSystemWindows</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">app:popupTheme</span>=<span class="string">&quot;@style/AppTheme.PopupOverlay&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">android.support.design.widget.AppBarLayout</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">android.support.design.widget.CoordinatorLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>注意：如果你在同一个布局中添加了多个这个属性，那么一般只有最外层View的这个属性生效</p>
<h2 id="调整View高度"><a href="#调整View高度" class="headerlink" title="调整View高度"></a>调整View高度</h2><p>上面两步都是统一的，这一步就比较有针对性了，对不同布局和API版本都会有所微调，主要是顶部View的高度。<br>如果你像我一样基本使用原生控件，那么一般情况下是调整ToolBar(ActionBar)的高度。你需要给Toolbar加上系统状态栏的高度，因为如果你设置了前面两步，那么ToolBar会上移到状态栏下面,如图</p>
<img data-src="/images/Android%E6%B2%89%E6%B5%B8%E5%BC%8F%E7%8A%B6%E6%80%81%E6%A0%8F_03.png" class="">


<p>我比较喜欢的处理方式是在java代码中改变高度,注意需要判断安卓版本，样例如下：<br>（具体获取状态栏高度的代码可以到后面的参考资料中看，也可以在我的Demo中看源码）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mToolbar = (Toolbar) findViewById(R.id.toolbar);</span><br><span class="line">        </span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.KITKAT)</span><br><span class="line">&#123;</span><br><span class="line">    mToolbar.getLayoutParams().height = getAppBarHeight();</span><br><span class="line">    mToolbar.setPadding(mToolbar.getPaddingLeft(),</span><br><span class="line">            getStatusBarHeight(),</span><br><span class="line">            mToolbar.getPaddingRight(),</span><br><span class="line">            mToolbar.getPaddingBottom());</span><br><span class="line">&#125;</span><br><span class="line">setSupportActionBar(mToolbar);</span><br></pre></td></tr></table></figure>

<p>当然了，也有一些同学喜欢在XML中定义，那么就需要写一些分离区分版本的XML文件。目前的话安卓手机端除6.0的系统状态栏是24dp,其它都是25dp。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.mosil.biz/2014/01/android-transparent-kitkat/">API 19 设置状态栏</a></li>
<li><a href="http://stackoverflow.com/questions/3407256/height-of-status-bar-in-android">获取状态栏的高度</a></li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Toolbar</tag>
      </tags>
  </entry>
  <entry>
    <title>Canvas中rotate,translate,save和restore</title>
    <url>/posts/rotate,translate,save_and_restore_of_Canvas.html</url>
    <content><![CDATA[<h1 id="rotate"><a href="#rotate" class="headerlink" title="rotate()"></a>rotate()</h1><p>rotate()是对坐标系的旋转，而不是对屏幕的旋转。</p>
<span id="more"></span>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">    canvas.drawRect(<span class="number">100</span>, <span class="number">100</span>, <span class="number">150</span>, <span class="number">150</span>, mPrePaint);<span class="comment">//画出蓝色矩形</span></span><br><span class="line">    canvas.rotate(<span class="number">30</span>);<span class="comment">//顺时针旋转30度</span></span><br><span class="line">    canvas.drawRect(<span class="number">200</span>, <span class="number">200</span>, <span class="number">250</span>, <span class="number">250</span>, mLastPaint);<span class="comment">//画出黄色矩形</span></span><br><span class="line">    <span class="built_in">super</span>.onDraw(canvas);<span class="comment">//画出文字</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<img data-src="/images/Canvas%E4%B8%ADrotate,translate,save%E5%92%8Crestore_01.png" class="">

<p>很明显，在坐标系旋转前，画出的蓝色矩形并没有跟着坐标系的旋转而旋转，<br>而在坐标系旋转后，画出的黄色矩形和文字旋转了30度。<br><code>rotate()</code>有两个重载方法：</p>
<ul>
<li>rotate(float degrees);</li>
<li>rotate(float degrees, float px, float py);<br>明显第一个参数<code>degrees</code>是坐标系旋转的角度，正数为顺时针旋转，负数为逆时针旋转。<br><code>px</code>和<code>py</code>表示的是，以<code>(px,py)</code>为旋转中心，进行<code>degrees</code>度的旋转。<br>如果使用第一个重载方法，则旋转中心<code>(px,py)</code>为<code>(0,0)</code>。</li>
</ul>
<h1 id="translate"><a href="#translate" class="headerlink" title="translate()"></a>translate()</h1><p><code>translate()</code>是对坐标系的平移。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">    canvas.drawRect(<span class="number">100</span>, <span class="number">100</span>, <span class="number">150</span>, <span class="number">150</span>, mPrePaint);<span class="comment">//画出蓝色矩形</span></span><br><span class="line">    canvas.rotate(<span class="number">30</span>);<span class="comment">//顺时针旋转30°</span></span><br><span class="line">    <span class="built_in">super</span>.onDraw(canvas);<span class="comment">//画出文字</span></span><br><span class="line">    canvas.drawRect(<span class="number">200</span>, <span class="number">200</span>, <span class="number">250</span>, <span class="number">250</span>, mLastPaint);<span class="comment">//画出黄色矩形</span></span><br><span class="line">    canvas.translate(<span class="number">500</span>, <span class="number">0</span>);<span class="comment">//往x轴正方向平移500单位长度</span></span><br><span class="line">    <span class="built_in">super</span>.onDraw(canvas);<span class="comment">//画出文字</span></span><br><span class="line">    canvas.drawRect(<span class="number">200</span>, <span class="number">200</span>, <span class="number">250</span>, <span class="number">250</span>, mLastPaint);<span class="comment">//画出黄色矩形</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<img data-src="/images/Canvas%E4%B8%ADrotate,translate,save%E5%92%8Crestore_02.jpg" class="">

<p>从上述例子可以看出，<code>canvas</code>绘图，实际上是以坐标系为基准进行绘图的。<br>所有的图形都是由在坐标系原点的基础上进行计算并绘制。</p>
<p>那么，如果我们进行了很多次<code>rotate()</code>和<code>translate()</code>操作后，想回退到某一次操作后的坐标轴位置，应该怎么做呢？</p>
<p><code>Canvas</code>中有两个方法<code>save()</code>和<code>restore()</code>，一个是存储，一个是回退。</p>
<h2 id="save"><a href="#save" class="headerlink" title="save()"></a>save()</h2><p>无</p>
<h2 id="restore"><a href="#restore" class="headerlink" title="restore()"></a>restore()</h2><p>无</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>自定义View</tag>
      </tags>
  </entry>
  <entry>
    <title>GreenDAO使用心得</title>
    <url>/posts/how_to_use_GreenDAO.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为一个程序员，基本的<code>SQL</code>语句是必须掌握的，但是如果单单使用原生的<code>SQL</code>语句，开发效率就太低了.<br>虽然<code>Android</code>有给我们提供一套封装好的<code>API</code>，但我觉得并没有提高多少便利，反而增加了学习成本。<br>我选择的是<a href="https://github.com/greenrobot/greenDAO">greenDAO</a> .<br>虽然<code>github</code>上<a href="https://github.com/realm/realm-java">realm-java</a> 的星星比<a href="https://github.com/greenrobot/greenDAO">greenDAO</a>高一点.<br>但是<a href="https://github.com/realm/realm-java">realm-java</a> 有一个弊端，就是<code>apk</code>的体积会大上5M左右。</p>
<span id="more"></span>

<p>下面一图说明<code>greenDAO</code>的好处</p>
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_01.png" class="">

<h1 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h1><h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><p><a href="https://github.com/greenrobot/greenDAO">greenDAO</a> 已经讲解的很清楚了。<br>但是还是要说一下</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这段代码是放在根build.gradle而不是某个module的build.gradle里的</span></span><br><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;org.greenrobot:greendao-gradle-plugin:3.1.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这段代码是放在android的module的build.gradle里的</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;org.greenrobot.greendao&#x27;</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile <span class="string">&#x27;org.greenrobot:greendao:3.1.1&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这段代码是放在java library的module的build.gradle里的(下一小节会提到)</span></span><br><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>], <span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>)</span><br><span class="line">    compile <span class="string">&#x27;org.greenrobot:greendao-generator:3.1.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="创建一个新的Module"><a href="#创建一个新的Module" class="headerlink" title="创建一个新的Module"></a>创建一个新的Module</h2><p>首先需要一个<code>Java Library</code>，通俗的讲，就是用来创建一系列的实体类（一个类对应一个表）和数据库工具类。<br>并且导入<code>compile &#39;org.greenrobot:greendao-generator:3.1.0&#39;</code>，上面有提到。</p>
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_02.png" class="">
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_03.png" class="">


<p>注意，我们创建的是<code>Java Library</code>，是<code>Java Library</code>，是<code>Java Library</code>。<br>所以要用<code>Java</code>的方式写代码，而不是<code>Android</code>的方式。<br>既然是<code>Java</code>的方式，就要写<code>main</code>函数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">VERSION</span> <span class="operator">=</span> <span class="number">1</span>;<span class="comment">//数据库的版本号，用来检测是否升级数据库</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">PACKAGE</span> <span class="operator">=</span> <span class="string">&quot;com.ahao.demo.dao&quot;</span>;<span class="comment">//自动生成代码的包名</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">OUT_DIR</span> <span class="operator">=</span> <span class="string">&quot;./app/src/main/java-gen&quot;</span>;<span class="comment">//自动生成代码的路径</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 创建了一个用于添加实体（Entity）的模式（Schema）对象。</span></span><br><span class="line">        <span class="type">Schema</span> <span class="variable">schema</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Schema</span>(VERSION, PACKAGE);</span><br><span class="line">        <span class="comment">// 添加一个实体(类),一个实体(类)对应一张表</span></span><br><span class="line">        addNote(schema);</span><br><span class="line">        <span class="comment">// 创建存放自动生成代码的目录</span></span><br><span class="line">        rebuild(OUT_DIR);</span><br><span class="line">        <span class="comment">// 自动生成代码</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">DaoGenerator</span>().generateAll(schema, OUT_DIR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">addNote</span><span class="params">(Schema schema)</span> &#123;</span><br><span class="line">        <span class="comment">// 一个实体（类）就关联到数据库中的一张表，此处表名为「Note」（既类名）</span></span><br><span class="line">        <span class="type">Entity</span> <span class="variable">note</span> <span class="operator">=</span> schema.addEntity(<span class="string">&quot;Note&quot;</span>);</span><br><span class="line">        <span class="comment">// 你也可以重新给表命名</span></span><br><span class="line">        <span class="comment">// note.setTableName(&quot;NODE&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// greenDAO 会自动根据实体类的属性值来创建表字段，并赋予默认值</span></span><br><span class="line">        <span class="comment">// 接下来你便可以设置表中的字段：</span></span><br><span class="line">        note.addIdProperty();<span class="comment">//添加一个id主键字段</span></span><br><span class="line">        note.addStringProperty(<span class="string">&quot;text&quot;</span>).notNull();<span class="comment">//添加一个名为TEXT的String字段</span></span><br><span class="line">        <span class="comment">// 与在 Java 中使用驼峰命名法不同，默认数据库中的命名是使用大写和下划线来分割单词的。</span></span><br><span class="line">        <span class="comment">// 例如,一个名为creationDate的属性,在表中的字段名为CREATION_DATE</span></span><br><span class="line">        note.addStringProperty(<span class="string">&quot;comment&quot;</span>);</span><br><span class="line">        note.addDateProperty(<span class="string">&quot;date&quot;</span>);<span class="comment">//添加一个Data字段</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 确保outdir文件夹存在</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">rebuild</span><span class="params">(String file)</span> &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">outDir</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(OUT_DIR);</span><br><span class="line">        outDir.delete();</span><br><span class="line">        outDir.mkdir();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么问题来了，生成的代码到哪里去了呢？要如何使用呢？</p>
<h2 id="自动生成代码"><a href="#自动生成代码" class="headerlink" title="自动生成代码"></a>自动生成代码</h2><p>运行代码</p>
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_04.png" class="">

<p>如果出现以下信息就是创建成功</p>
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_05.png" class="">

<p> 切换到<code>Project Files</code>视图，可以看到代码已经自动生成了 </p>
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_06.png" class="">
<img data-src="/images/GreenDAO%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97_07.png" class="">


<p>这里<a href="http://my.oschina.net/cheneywangc/blog/196354">引用</a> 一下</p>
<ul>
<li>DaoMaster：一看名字就知道它是Dao中的最大的官了。它保存了sqlitedatebase对象以及操作DAO classes（注意：不是对象）。其提供了一些创建和删除table的静态方法，其内部类OpenHelper和DevOpenHelper实现了SQLiteOpenHelper并创建数据库的框架。</li>
<li>DaoSession：会话层。操作具体的DAO对象（注意：是对象），比如各种getter方法。</li>
<li>XXXDao：实际生成的某某DAO类，通常对应具体的java类，比如NoteDao等。其有更多的权限和方法来操作数据库元素。</li>
<li>XXXEntity：持久的实体对象。通常代表了一个数据库row的标准java properties。</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>数据库</tag>
        <tag>ORM</tag>
      </tags>
  </entry>
  <entry>
    <title>LayoutParams的addRule方法</title>
    <url>/posts/addRule_method_of_LayoutParams.html</url>
    <content><![CDATA[<p>自定义<code>ViewGroup</code>中，需要用<code>LayoutParams</code>对子<code>View</code>进行布局</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">mLeftParams = <span class="keyword">new</span> <span class="title class_">LayoutParams</span>(LayoutParams.WRAP_CONTENT, LayoutParams.MATCH_PARENT);</span><br><span class="line">mLeftParams.addRule(RelativeLayout.ALIGN_PARENT_LEFT, TRUE);</span><br><span class="line">mLeftParams.addRule(RelativeLayout.RIGHT_OF, R.id.leftView);</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p>等价于</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">android:layout_alignParentLeft=&quot;true&quot;</span><br><span class="line">android:layout_toRightOf=&quot;@id/leftView&quot;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>自定义View</tag>
      </tags>
  </entry>
  <entry>
    <title>ListActivity源码详解</title>
    <url>/posts/ListActivity_source_code.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在研究<code>PreferenceActivity</code>发现是继承自ListActivity的，打开看了下<code>ListActivity</code>的源码，发现也不长，就详细阅读认识一下。</p>
<span id="more"></span>

<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p><code>ListActivity</code>简单到只要在<code>onCreate()</code>中调用<code>setListAdapter()</code>方法就可以实现了。<br>支持空数据显示。</p>
<p>点进去我们看到前两个<code>field</code>很熟悉，就是一个<code>ListView</code>+<code>Adapter</code>。<br>很容易就知道这两个<code>field</code>就是<code>ListActivity</code>的核心，数据存储在<code>Adapter</code>中，展示在<code>ListView</code>中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> ListAdapter mAdapter;</span><br><span class="line"><span class="keyword">protected</span> ListView mList;</span><br><span class="line"><span class="comment">/** 省略部分代码 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setListAdapter</span><span class="params">(ListAdapter adapter)</span> &#123;</span><br><span class="line">    <span class="comment">//加上锁，防止多个线程同时调用这个方法</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        ensureList();<span class="comment">//内含setContentView的方法</span></span><br><span class="line">        mAdapter = adapter;</span><br><span class="line">        mList.setAdapter(adapter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在调用了<code>setListAdapter()</code>之后，对<code>Adapter</code>重新赋值，并重新设置<code>ListView</code>的<code>Adapter</code>，并且调用了<code>ensureList()</code>方法，重新创建布局。<br>点进<code>ensureList()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">ensureList</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mList != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    setContentView(com.android.internal.R.layout.list_content_simple);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>哈！原来每次<code>setListAdapter()</code>都会把<code>Adapter</code>替换掉，并且重新<code>setContentView()</code>，怪不得<code>ListActivity</code>不用我们操心布局。<br>我们再来看看这个布局的内容</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ListView</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@android:id/list&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:drawSelectorOnTop</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">    /&gt;</span></span><br></pre></td></tr></table></figure>
<p>也就是说，你可以自己<code>setContentView()</code>，只要你的布局有一个<code>viewId</code>是<code>android:id=&quot;@android:id/list&quot;</code>的就行。<br>看到这你可能会无语，就一个简单的<code>ListView</code>就完事了？这么简单我也会啊！<br>别急，这只是完成了基本的功能而已，还要开放一些接口给子<code>Activity</code>调用。<br>有了<code>ListView</code>当然要实现各种事件啊。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setSelection</span><span class="params">(<span class="type">int</span> position)</span> &#123;</span><br><span class="line">     mList.setSelection(position);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getSelectedItemPosition</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mList.getSelectedItemPosition();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getSelectedItemId</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mList.getSelectedItemId();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然还有点击事件，我们发现有一个点击的监听器<code>mOnClickListener</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> AdapterView.<span class="type">OnItemClickListener</span> <span class="variable">mOnClickListener</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AdapterView</span>.OnItemClickListener() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onItemClick</span><span class="params">(AdapterView&lt;?&gt; parent, View v, <span class="type">int</span> position, <span class="type">long</span> id)</span>    &#123;</span><br><span class="line">        onListItemClick((ListView)parent, v, position, id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onListItemClick</span><span class="params">(ListView l, View v, <span class="type">int</span> position, <span class="type">long</span> id)</span> &#123;</span><br><span class="line">    <span class="comment">//空方法，交由子类实现</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>既然有监听器，那又是在哪里设置了这个监听器呢？我们发现有一个<code>onContentChanged()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onContentChanged</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onContentChanged();  <span class="comment">//Activity中是空方法</span></span><br><span class="line">    <span class="type">View</span> <span class="variable">emptyView</span> <span class="operator">=</span> findViewById(com.android.internal.R.id.empty); <span class="comment">//空数据时显示</span></span><br><span class="line">    mList = (ListView)findViewById(com.android.internal.R.id.list); <span class="comment">//绑定ListView</span></span><br><span class="line">    <span class="keyword">if</span> (mList == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>( <span class="string">&quot;Your content must have a ListView whose id attribute is &quot;</span></span><br><span class="line">                         + <span class="string">&quot;&#x27;android.R.id.list&#x27;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (emptyView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mList.setEmptyView(emptyView);    <span class="comment">//多好啊，recyclerView就没有这个方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    mList.setOnItemClickListener(mOnClickListener); <span class="comment">//设置点击事件</span></span><br><span class="line">    <span class="keyword">if</span> (mFinishedStart) &#123;</span><br><span class="line">        <span class="comment">// 这个if不知道有什么用意</span></span><br><span class="line">        setListAdapter(mAdapter);</span><br><span class="line">    &#125;</span><br><span class="line">    mHandler.post(mRequestFocus); <span class="comment">//待会解释</span></span><br><span class="line">    mFinishedStart = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可是翻遍源代码也没发现哪里调用了<code>onContentChanged()</code>。<br>从字面上看，<code>onContentChanged()</code>是<code>Content</code>改变时的回调接口，等等，<code>Content</code>？<br>我们不是在<code>ensureList()</code>中调用了<code>setContentView()</code>方法吗？<br>答案是正确的，在调用了<code>setContentView()</code>，会调用<code>onContentChanged()</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Activity的setContentView()调用Window(具体子类是PhoneWindow)的setContentView()方法</span></span><br><span class="line"><span class="comment">// 以下代码出现在PhoneWindow中</span></span><br><span class="line"><span class="meta">@Override</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentView</span><span class="params">(<span class="type">int</span> layoutResID)</span> &#123;  </span><br><span class="line">    <span class="comment">/** 省略部分代码 */</span></span><br><span class="line">    mLayoutInflater.inflate(layoutResID, mContentParent);  </span><br><span class="line">    getCallback().onContentChanged();  <span class="comment">//注意这里!!!</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>再解释下，上面的<code>mHandler.post(mRequestFocus);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Runnable</span> <span class="variable">mRequestFocus</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 用来使ListView获取焦点。</span></span><br><span class="line">        mList.focusableViewAvailable(mList);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// Activity销毁时移除</span></span><br><span class="line">    mHandler.removeCallbacks(mRequestFocus);</span><br><span class="line">    <span class="built_in">super</span>.onDestroy();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，<code>ListActivity</code>已经认识的差不多了。有什么讲错了希望能有大牛来提点一下。<br>有兴趣的可以自己用<code>recyclerView</code>替换<code>listView</code>实现一个<code>RecyclerActivity</code>.</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>源码分析</tag>
      </tags>
  </entry>
  <entry>
    <title>ListView 使用技巧</title>
    <url>/posts/ListView_skills.html</url>
    <content><![CDATA[<h1 id="ListView常用优化技巧"><a href="#ListView常用优化技巧" class="headerlink" title="ListView常用优化技巧"></a>ListView常用优化技巧</h1><h2 id="使用ViewHolder提高效率"><a href="#使用ViewHolder提高效率" class="headerlink" title="使用ViewHolder提高效率"></a>使用ViewHolder提高效率</h2><p>创建一个ViewHolder内部类</p>
<span id="more"></span>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ViewHolder</span>&#123;</span><br><span class="line">    TextView titleView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>getView()</code>方法里面复用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">LayoutInflater mInflater;</span><br><span class="line"><span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">(<span class="type">int</span> position, View convertView, ViewGroup parent)</span>&#123;</span><br><span class="line">    <span class="type">ViewHolder</span> <span class="variable">holder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span>(convertView == <span class="literal">null</span>)&#123;<span class="comment">//当前子View没有被初始化过</span></span><br><span class="line">        holder = <span class="keyword">new</span> <span class="title class_">ViewHolder</span>();</span><br><span class="line">        convertView = mInflater.inflate(R.id.list_item, <span class="literal">null</span>);<span class="comment">//通过LayoutInflater实例化布局</span></span><br><span class="line">        holder.titleView = (TextView) convertView.findViewById(R.id.title_view);</span><br><span class="line">        convertView.setTag(holder);<span class="comment">//缓存布局</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        holder = (ViewHolder) convertView.getTag();<span class="comment">//通过tag找到缓存的布局</span></span><br><span class="line">    &#125;</span><br><span class="line">    holder.titleView.setText(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> convertView;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="设置item分割线"><a href="#设置item分割线" class="headerlink" title="设置item分割线"></a>设置item分割线</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">android:divider = &quot;@android:color/darker_gray&quot;<span class="comment">&lt;!--设置分割线资源--&gt;</span></span><br><span class="line">android:dividerHeight = &quot;10dp&quot;<span class="comment">&lt;!--设置分割线高度--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--android:divider = &quot;null&quot;--&gt;</span><span class="comment">&lt;!--分割线为空--&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="隐藏ListVIew滚动条"><a href="#隐藏ListVIew滚动条" class="headerlink" title="隐藏ListVIew滚动条"></a>隐藏ListVIew滚动条</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">android:scrollbars=&quot;none&quot;<span class="comment">&lt;!--隐藏ListVIew滚动条--&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="取消item点击效果"><a href="#取消item点击效果" class="headerlink" title="取消item点击效果"></a>取消item点击效果</h2><p>在Android 5.X上是一个波纹效果，在Android 5.X之下版本是一个改变背景颜色的效果。<br>可以通过listSelector取消点击效果</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line">andoird:listSelector=&quot;# 00000000&quot;</span><br><span class="line">andoird:listSelector=&quot;@android:color/transparent&quot;//设置选择时背景为透明色，也可使用自定义的颜色效果</span><br></pre></td></tr></table></figure>

<h2 id="设置显示到第几项"><a href="#设置显示到第几项" class="headerlink" title="设置显示到第几项"></a>设置显示到第几项</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">listView.setSelection(n);<span class="comment">//设置Listview具体显示在第几项，默认是0</span></span><br><span class="line"> listView.smoothScrollByOffset(<span class="number">35</span>);<span class="comment">//偏移量</span></span><br><span class="line"> listView.smoothScrollToPosition(<span class="number">35</span>);<span class="comment">//位置</span></span><br><span class="line"> listView.smoothScrollBy(<span class="number">35</span>,<span class="number">1000</span>);<span class="comment">//距离，时间</span></span><br></pre></td></tr></table></figure>

<h2 id="动态修改ListView数据"><a href="#动态修改ListView数据" class="headerlink" title="动态修改ListView数据"></a>动态修改ListView数据</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">data.add(<span class="string">&quot;new&quot;</span>);</span><br><span class="line">adapter.notifyDataSetChanged();</span><br></pre></td></tr></table></figure>

<h2 id="遍历所有item"><a href="#遍历所有item" class="headerlink" title="遍历所有item"></a>遍历所有item</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; listView.getChildCount(); i++)&#123;</span><br><span class="line">    <span class="type">View</span> <span class="variable">child</span> <span class="operator">=</span> listView.getChildAt(i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="处理空ListView"><a href="#处理空ListView" class="headerlink" title="处理空ListView"></a>处理空ListView</h2><p>当数据源为空时，提示无数据</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">listView.setEmptyView(emptyView);</span><br></pre></td></tr></table></figure>

<h2 id="滑动监听"><a href="#滑动监听" class="headerlink" title="滑动监听"></a>滑动监听</h2><h3 id="使用OnTouchListener"><a href="#使用OnTouchListener" class="headerlink" title="使用OnTouchListener"></a>使用OnTouchListener</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">listView.setOnTouchListener(<span class="keyword">new</span> <span class="title class_">OnTouchListener</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">onTouch</span><span class="params">(View v, MotionEvent e)</span>&#123;</span><br><span class="line">        swicth(e.getAction())&#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:    <span class="comment">//按下时操作</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:    <span class="comment">//移动时操作</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP    :<span class="comment">//抬起时操作</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="使用OnScrollListener"><a href="#使用OnScrollListener" class="headerlink" title="使用OnScrollListener"></a>使用OnScrollListener</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">listView.setOnScrollListener(<span class="keyword">new</span> <span class="title class_">OnScrollListener</span>()&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onScrollStateChanged</span><span class="params">(AbsListView view, <span class="type">int</span> scrollState)</span>&#123;    <span class="comment">//当滑动状态改变时回调</span></span><br><span class="line">        swicth(scrollState)&#123;</span><br><span class="line">            <span class="keyword">case</span> OnScrollListener.SCROLL_STATE_IDLE:    <span class="comment">//滑动停止时操作</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OnScrollListener.SCROLL_STATE_TOUCH_SCROLL:    <span class="comment">//正在滚动</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> OnScrollListener.SCROLL_STATE_FLING:    <span class="comment">//手指用力滑动时操作</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onScroll</span><span class="params">(AbsListView view, <span class="type">int</span> firstVisibleItem, <span class="type">int</span> visibleItemCount, <span class="type">int</span> totalItemCount)</span>&#123;</span><br><span class="line">        <span class="comment">//滚动时调用</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="ListView常用拓展"><a href="#ListView常用拓展" class="headerlink" title="ListView常用拓展"></a>ListView常用拓展</h1><h2 id="弹性ListView"><a href="#弹性ListView" class="headerlink" title="弹性ListView"></a>弹性ListView</h2><p>可以通过增加HeaderView或者使用ScrollView嵌套使用<br>这里通过修改源码实现。<br><code>overScrollBy()</code>是一个控制滑动到边缘的处理方法，只要修改maxOverScrollY值即可。<br>为了适配多分辨率，建议使用DisplayMetrics 获得屏幕尺寸进行计算</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">overScrollBy</span><span class="params">(<span class="type">int</span> deltaX, <span class="type">int</span> deltaY, <span class="type">int</span> scrollX, <span class="type">int</span> scrollY,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> scrollRangeX, <span class="type">int</span> scrollRangeY,</span></span><br><span class="line"><span class="params">                                   <span class="type">int</span> maxOverScrollX, <span class="type">int</span> maxOverScrollY, <span class="type">boolean</span> isTouchEvent)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.overScrollBy(deltaX, deltaY, scrollX, scrollY,</span><br><span class="line">                scrollRangeX, scrollRangeY,</span><br><span class="line">                maxOverScrollX, mMaxOverScrollY, isTouchEvent);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>ListView</tag>
      </tags>
  </entry>
  <entry>
    <title>OkHttp使用</title>
    <url>/posts/how_to_use_OKHttp.html</url>
    <content><![CDATA[<h1 id="导入gradle"><a href="#导入gradle" class="headerlink" title="导入gradle"></a>导入gradle</h1><p><a href="https://github.com/square/okhttp">OkHttp地址</a></p>
<span id="more"></span>
<p>在gradle中加入</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    compile fileTree(<span class="attr">dir:</span> <span class="string">&#x27;libs&#x27;</span>, <span class="attr">include:</span> [<span class="string">&#x27;*.jar&#x27;</span>])</span><br><span class="line">    testCompile <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    compile <span class="string">&#x27;com.squareup.okhttp3:okhttp:3.4.1&#x27;</span></span><br><span class="line">    compile <span class="string">&#x27;com.squareup.okio:okio:1.9.0&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="创建OkHttpClient"><a href="#创建OkHttpClient" class="headerlink" title="创建OkHttpClient"></a>创建OkHttpClient</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">OkHttpClient</span> <span class="variable">mOkHttpClient</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br></pre></td></tr></table></figure>

<h1 id="创建Request"><a href="#创建Request" class="headerlink" title="创建Request"></a>创建Request</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Request</span> <span class="variable">mRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">                .url(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line">                .build();</span><br></pre></td></tr></table></figure>

<h1 id="创建回调Call并异步执行"><a href="#创建回调Call并异步执行" class="headerlink" title="创建回调Call并异步执行"></a>创建回调Call并异步执行</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Call</span> <span class="variable">call</span> <span class="operator">=</span> mOkHttpClient.newCall(mRequest);</span><br><span class="line">call.enqueue(<span class="keyword">new</span> <span class="title class_">Callback</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onFailure</span><span class="params">(Call call, IOException e)</span> &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;失败&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onResponse</span><span class="params">(Call call, Response response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;成功&quot;</span>+response.body());</span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">html</span> <span class="operator">=</span> response.body().string();</span><br><span class="line">        runOnUiThread(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;<span class="comment">//在子线程中更新ui</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                contentView.setText(html);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>OKHttp</tag>
      </tags>
  </entry>
  <entry>
    <title>PreferenceActivity实现Toolbar</title>
    <url>/posts/How_to_set_Toolbar_with_PreferenceActivity.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>尝试使用<code>PreferenceActivity</code>时，发现从有<code>Toolbar</code>的上一个<code>Activity</code>进入了没有<code>Toolbar</code>的<code>Activity</code>，感觉太丑了。但是<code>google</code>居然没有推出<code>AppCompatPreferenceActivity</code>，没办法只好自己写。</p>
<span id="more"></span>

<h1 id="PreferenceActivity-ToolBar-限Android-5-0以上"><a href="#PreferenceActivity-ToolBar-限Android-5-0以上" class="headerlink" title="PreferenceActivity+ToolBar(限Android 5.0以上)"></a>PreferenceActivity+ToolBar(限Android 5.0以上)</h1><p><strong>思路</strong><br>模仿<code>AppCompatActivity</code>，对<code>PreferenceActivity</code>进行改造</p>
<p><strong>实现</strong><br>继承PreferenceActivity重写onCreate方法添加如下代码:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle savedInstanceState)</span> &#123;</span><br><span class="line">    getDelegate().installViewFactory();</span><br><span class="line">    getDelegate().onCreate(savedInstanceState);</span><br><span class="line">    <span class="built_in">super</span>.onCreate(savedInstanceState);</span><br><span class="line">    <span class="comment">/** 初始化StatusBar,交由子类实现 */</span></span><br><span class="line">    setStatusBar();</span><br><span class="line">    <span class="comment">/** 获取DecorView下的ContentView*/</span></span><br><span class="line">    <span class="type">ViewGroup</span> <span class="variable">contentViews</span> <span class="operator">=</span> (ViewGroup) findViewById(android.R.id.content);</span><br><span class="line">    <span class="comment">/** 获取ContentView的子View */</span></span><br><span class="line">    <span class="type">View</span> <span class="variable">content</span> <span class="operator">=</span> contentView.getChildAt(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">/** 加载自定义布局文件,获取id交由子类实现 */</span></span><br><span class="line">    <span class="type">LinearLayout</span> <span class="variable">toolbarLayout</span> <span class="operator">=</span> (LinearLayout) LayoutInflater.from(<span class="built_in">this</span>).inflate(getActLayoutId(), <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">/** 移除根布局所有子view */</span></span><br><span class="line">    contentView.removeAllViews();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 注意这里一要将前面移除的子View添加到我们自定义布局文件中，否则PreferenceActivity中的Header将不会显示 */</span></span><br><span class="line">    toolbarLayout.addView(content);</span><br><span class="line">    <span class="comment">/** 将包含Toolbar的自定义布局添加到根布局中 */</span></span><br><span class="line">    contentView.addView(toolbarLayout);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 设置Toolbar,获取Toolbar的Id的方法交由子类实现 */</span></span><br><span class="line">    mToolbar = (Toolbar) toolbarLayout.findViewById(getActToolbarId());</span><br><span class="line">    <span class="comment">/** 初始化Toolbar,交由子类实现 */</span></span><br><span class="line">    initToolbar(getToolbar());  &#125;</span><br></pre></td></tr></table></figure>

<h1 id="AppCompatActivity-PreferenceFragment-ToolBar-适用于Android-5-0以下"><a href="#AppCompatActivity-PreferenceFragment-ToolBar-适用于Android-5-0以下" class="headerlink" title="AppCompatActivity+PreferenceFragment+ToolBar(适用于Android 5.0以下)"></a>AppCompatActivity+PreferenceFragment+ToolBar(适用于Android 5.0以下)</h1><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>在<code>Activity</code>中设置<code>Toolbar</code>，使用事务替换<code>Fragment</code>的方法。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>和普通的使用<code>Fragment</code>方法一样，这里不赘述。</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Activity</tag>
        <tag>Fragment</tag>
      </tags>
  </entry>
  <entry>
    <title>View的onMeasure()</title>
    <url>/posts/onMeasure_method_of_View.html</url>
    <content><![CDATA[<h1 id="自定义View首先需要测量View的大小"><a href="#自定义View首先需要测量View的大小" class="headerlink" title="自定义View首先需要测量View的大小"></a>自定义View首先需要测量View的大小</h1><p>自定义<code>View</code>首先需要测量<code>View</code>的大小，在<code>View</code>的<code>onMeasure()</code>方法中进行。<br><code>View</code>的大小分为三种类型，测量模式也有三种</p>
<ul>
<li>自适应(<code>wrap_content</code>)，对应<code>at_most</code>(最大值模式)，代表的是最大可获得的空间</li>
<li>固定(100dp)，对应<code>Exactly</code>(精确值模式)，代表的是精确的尺寸； </li>
<li>填充父<code>View</code>(<code>match_parent</code>)，对应<code>Exactly</code>(精确值模式)，代表的是精确的尺寸； </li>
<li>还有个<code>UnSpecified</code>(未指定模式)，不指定<code>View</code>的大小，想多大就多大，用于<code>scrollView</code>等类。</li>
</ul>
<span id="more"></span>


<h1 id="默认情况"><a href="#默认情况" class="headerlink" title="默认情况"></a>默认情况</h1><p><code>onMeasure()</code>只支持<code>Exactly</code>模式，所以要重写<code>onMeasure</code>方法.<br><code>onMeasure</code>传入的<code>widthMeasureSpec</code>和<code>heightMeasureSpec</code>不是一般的尺寸数值，而是将模式和尺寸组合在一起的数值。<br><code>MeasureSpec</code>是一个32位的<code>int</code>值，高2位为测量模式，低30位为测量的大小。<br>查看<code>View</code>的<code>onMeasure()</code>源码发现，调用了<code>setMeasuredDimension(int measuredWidth, int measuredHeight)</code>方法。<br>那么我们只要将设置好的长宽参数穿进去即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMeasure</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line"><span class="comment">//    super.onMeasure(widthMeasureSpec, heightMeasureSpec);</span></span><br><span class="line">    Log.i(<span class="string">&quot;onMeasure&quot;</span>,<span class="string">&quot;onMeasure&quot;</span>);</span><br><span class="line">    setMeasuredDimension(measureWidth(widthMeasureSpec),</span><br><span class="line">                         measureHeight(heightMeasureSpec));</span><br><span class="line"><span class="comment">//    measureWidth()和measureHeight()源码基本一致</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">measureWidth</span><span class="params">(<span class="type">int</span> measureSpec)</span> &#123;</span><br><span class="line">    <span class="type">int</span> result;</span><br><span class="line">    <span class="type">int</span> <span class="variable">specMode</span> <span class="operator">=</span> MeasureSpec.getMode(measureSpec);<span class="comment">//获取测量模式</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">specSize</span> <span class="operator">=</span> MeasureSpec.getSize(measureSpec);<span class="comment">//获取Size</span></span><br><span class="line"><span class="comment">//    Log.i(&quot;measureWidth&quot;,&quot;measureSpec:&quot;+measureSpec);</span></span><br><span class="line">    Log.i(<span class="string">&quot;measureWidth&quot;</span>,<span class="string">&quot;specSize:&quot;</span>+specSize);</span><br><span class="line">    <span class="keyword">if</span>(specMode == MeasureSpec.EXACTLY)&#123;</span><br><span class="line">        Log.i(<span class="string">&quot;measureWidth&quot;</span>,<span class="string">&quot;specMode:&quot;</span>+<span class="string">&quot;MeasureSpec.EXACTLY&quot;</span>);</span><br><span class="line">        result = specSize;<span class="comment">//如果是Exactly模式,则直接设置</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="number">200</span>;<span class="comment">//如果不是Exactly模式,设置最小的Size</span></span><br><span class="line">        <span class="keyword">if</span>(specMode == MeasureSpec.AT_MOST)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;measureWidth&quot;</span>,<span class="string">&quot;specMode:&quot;</span>+<span class="string">&quot;MeasureSpec.AT_MOST&quot;</span>);</span><br><span class="line">            result = Math.min(result, specSize);</span><br><span class="line">            <span class="comment">//这里需要自定义,对子`View`的Size进行测量</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(specMode == MeasureSpec.UNSPECIFIED)&#123;</span><br><span class="line">            Log.i(<span class="string">&quot;measureWidth&quot;</span>,<span class="string">&quot;specMode:&quot;</span>+<span class="string">&quot;MeasureSpec.UNSPECIFIED&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="onMeasure-触发了两次？"><a href="#onMeasure-触发了两次？" class="headerlink" title="onMeasure()触发了两次？"></a>onMeasure()触发了两次？</h1><p>打印log时出现这个问题，待解决</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>自定义View</tag>
      </tags>
  </entry>
  <entry>
    <title>getWidth()、getHeight()方法返回的值为0</title>
    <url>/posts/getWidth()%E3%80%81getHeight()_method_alway_return_zero.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在自定义<code>View</code>的构造方法中使用<code>getWidth()</code>和<code>getHeight()</code>返回值为0，<br>因为过早的使用了这些方法，也就是说在这个<code>view</code>被加入到<code>rootview</code>之前你就调用了这些方法，返回的值自然为0。</p>
<span id="more"></span>

<h1 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h1><h2 id="自定义View实现OnGlobalLayoutListener接口，并重写onGlobalLayout方法"><a href="#自定义View实现OnGlobalLayoutListener接口，并重写onGlobalLayout方法" class="headerlink" title="自定义View实现OnGlobalLayoutListener接口，并重写onGlobalLayout方法"></a>自定义View实现OnGlobalLayoutListener接口，并重写onGlobalLayout方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onAttachedToWindow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onAttachedToWindow();</span><br><span class="line">    getViewTreeObserver().addOnGlobalLayoutListener(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//在自定义View添加到窗体上时,添加onGlobalLayoutListener</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDetachedFromWindow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>.onDetachedFromWindow();</span><br><span class="line">    getViewTreeObserver().removeOnGlobalLayoutListener(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">//在自定义View从窗体移除时,移除onGlobalLayoutListener</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onGlobalLayout</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//重写onGlobalLayoutListener中的onGlobalLayout方法</span></span><br><span class="line">    Log.i(TAG, <span class="string">&quot;onGlobalLayout&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!mCreated)&#123;<span class="comment">//设置只执行一次</span></span><br><span class="line">        mCreated = <span class="literal">true</span></span><br><span class="line">    <span class="comment">//这里getWidth(),getHeight()不为0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>自定义View</tag>
      </tags>
  </entry>
  <entry>
    <title>改变support中AlertDialog的样式</title>
    <url>/posts/change_the_style_of_AlertDialog.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>原文:<a href="http://blog.isming.me/2015/08/31/modify-alert-style/">http://blog.isming.me/2015/08/31/modify-alert-style/</a></p>
</blockquote>
<p><code>android</code>最近的<code>support</code>库提供了<code>AlertDialog</code>，可以让我们在低于<code>5.0</code>的系统使用到跟<code>5.0</code>系统一样的<code>Material Design</code>风格的对话框。</p>
<span id="more"></span>
<img data-src="/images/%E6%94%B9%E5%8F%98support%E4%B8%ADAlertDialog%E7%9A%84%E6%A0%B7%E5%BC%8F_01.jpg" class="">


<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="自定义一个Style"><a href="#自定义一个Style" class="headerlink" title="自定义一个Style"></a>自定义一个Style</h2><p>在<code>values/styles.xml</code>中创建一个<code>Style</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;MyAlertDialogStyle&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;Theme.AppCompat.Light.Dialog.Alert&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- Used for the buttons --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;colorAccent&quot;</span>&gt;</span>#FFC107<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- Used for the title and text --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:textColorPrimary&quot;</span>&gt;</span>#FFFFFF<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!-- Used for the background --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:background&quot;</span>&gt;</span>#4CAF50<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="在创建对话框时使用"><a href="#在创建对话框时使用" class="headerlink" title="在创建对话框时使用"></a>在创建对话框时使用</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AlertDialog.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlertDialog</span>.Builder(<span class="built_in">this</span>, R.style.MyAlertDialogStyle);</span><br><span class="line">builder.setTitle(<span class="string">&quot;AppCompatDialog&quot;</span>);</span><br><span class="line">builder.setMessage(<span class="string">&quot;Lorem ipsum dolor...&quot;</span>);</span><br><span class="line">builder.setPositiveButton(<span class="string">&quot;OK&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">builder.setNegativeButton(<span class="string">&quot;Cancel&quot;</span>, <span class="literal">null</span>);</span><br><span class="line">builder.show();</span><br></pre></td></tr></table></figure>

<h2 id="全局使用style（可选）"><a href="#全局使用style（可选）" class="headerlink" title="全局使用style（可选）"></a>全局使用style（可选）</h2><p>这样的方法是每个地方使用的时候，都要在构造函数传我们的这个<code>Dialog</code>的<code>Theme</code>，我们也可以全局的定义对话框的样式。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;MyTheme&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;Base.Theme.AppCompat.Light&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;alertDialogTheme&quot;</span>&gt;</span>@style/MyAlertDialogStyle<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;colorAccent&quot;</span>&gt;</span>@color/accent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在我们的<code>AndroidManifest.xml</code>文件中声明<code>application</code>或者<code>activity</code>的时候设置<code>theme</code>为<code>MyTheme</code>即可.<br>不过需要注意的一点是，我们的<code>Activity</code>需要继承自<code>AppCompatActivity</code>。</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>AlertDialog</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义一个简单的TextView</title>
    <url>/posts/custom_a_simple_TextView.html</url>
    <content><![CDATA[<h1 id="定义、使用属性"><a href="#定义、使用属性" class="headerlink" title="定义、使用属性"></a>定义、使用属性</h1><p>首先在<code>res/values/attrs.xml</code>文件夹（没有的话自己创建一个）中设置好自定义的属性。<br>注意，因为<code>Toolbar</code>中已经有了<code>titleTextColor</code>的属性，如果我们进行声明，则会编译不通过。<br>所以这里进行了引用，也就是不写format。</p>
<span id="more"></span>
<p>属性有：</p>
<table>
<thead>
<tr>
<th align="left">值</th>
<th align="left">含义</th>
<th align="left">值</th>
<th align="left">含义</th>
</tr>
</thead>
<tbody><tr>
<td align="left">string</td>
<td align="left">字符串</td>
<td align="left">color</td>
<td align="left">颜色</td>
</tr>
<tr>
<td align="left">demension</td>
<td align="left">尺寸</td>
<td align="left">integer</td>
<td align="left">整型</td>
</tr>
<tr>
<td align="left">enum</td>
<td align="left">枚举</td>
<td align="left">reference</td>
<td align="left">引用</td>
</tr>
<tr>
<td align="left">float</td>
<td align="left">浮点</td>
<td align="left">boolean</td>
<td align="left">布尔</td>
</tr>
<tr>
<td align="left">fraction</td>
<td align="left">百分数</td>
<td align="left">flag</td>
<td align="left">位或运算</td>
</tr>
</tbody></table>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">resources</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">&quot;CustomTitleView&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;titleText&quot;</span> <span class="attr">format</span>=<span class="string">&quot;string&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;titleTextSize&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;titleTextColor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">resources</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="在代码中获取属性值"><a href="#在代码中获取属性值" class="headerlink" title="在代码中获取属性值"></a>在代码中获取属性值</h2><p>自定义了属性之后，当然是在构造方法中获取属性值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomTitleView</span> <span class="keyword">extends</span> <span class="title class_">View</span> <span class="keyword">implements</span> <span class="title class_">View</span>.OnClickListener&#123;</span><br><span class="line">    <span class="keyword">private</span> String titleText;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> titleTextColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> titleTextSize;</span><br><span class="line">    <span class="keyword">private</span> Rect rect;</span><br><span class="line">    <span class="keyword">private</span> Paint paint;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTitleView</span><span class="params">(Context context)</span> &#123;<span class="built_in">this</span>(context, <span class="literal">null</span>);&#125;<span class="comment">//调用自身构造方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTitleView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;<span class="built_in">this</span>(context, attrs, <span class="number">0</span>);&#125;<span class="comment">//调用自身构造方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomTitleView</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        <span class="comment">//获取所有的属性</span></span><br><span class="line">        <span class="type">TypedArray</span> <span class="variable">ta</span> <span class="operator">=</span> context.obtainStyledAttributes(attrs, R.styleable.CustomTitleView, defStyleAttr, <span class="number">0</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> ta.getIndexCount();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; i++)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">attr</span> <span class="operator">=</span> ta.getIndex(i);</span><br><span class="line">            <span class="keyword">switch</span>(attr)&#123;</span><br><span class="line">                <span class="keyword">case</span> R.styleable.CustomTitleView_titleText:</span><br><span class="line">                    titleText = ta.getString(attr);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> R.styleable.CustomTitleView_titleTextColor:</span><br><span class="line">                    titleTextColor = ta.getColor(attr, Color.BLACK);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> R.styleable.CustomTitleView_titleTextSize:</span><br><span class="line">                    <span class="comment">//这里将获取的数值单位转换为sp单位</span></span><br><span class="line">                    titleTextSize = ta.getDimensionPixelSize(attr, (<span class="type">int</span>) TypedValue.applyDimension(</span><br><span class="line">                            TypedValue.COMPLEX_UNIT_SP, <span class="number">15</span>, getResources().getDisplayMetrics()));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        ta.recycle();</span><br><span class="line">        <span class="comment">//设置画笔</span></span><br><span class="line">        paint = <span class="keyword">new</span> <span class="title class_">Paint</span>();</span><br><span class="line">        paint.setTextSize(titleTextSize);</span><br><span class="line">        <span class="comment">//Rect是文字所在的矩形，用于测量View的大小</span></span><br><span class="line">        rect = <span class="keyword">new</span> <span class="title class_">Rect</span>();</span><br><span class="line">        paint.getTextBounds(titleText, <span class="number">0</span>, titleText.length(), rect);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="重写onMeasure方法"><a href="#重写onMeasure方法" class="headerlink" title="重写onMeasure方法"></a>重写onMeasure方法</h2><p>重写onMeasure方法，否则的话不支持wrap_content</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onMeasure</span><span class="params">(<span class="type">int</span> widthMeasureSpec, <span class="type">int</span> heightMeasureSpec)</span> &#123;</span><br><span class="line">    <span class="comment">//这里是必须的,当titleText改变时,rect也必须改变,否则不会对titleText适配</span></span><br><span class="line">    paint.setTextSize(titleTextSize);</span><br><span class="line">    paint.getTextBounds(titleText, <span class="number">0</span>, titleText.length(), rect);</span><br><span class="line">    <span class="type">int</span> <span class="variable">widthMode</span> <span class="operator">=</span> MeasureSpec.getMode(widthMeasureSpec);<span class="comment">//获取测量模式</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">widthSize</span> <span class="operator">=</span> MeasureSpec.getSize(widthMeasureSpec);<span class="comment">//获取测量大小</span></span><br><span class="line">    <span class="type">int</span> width;</span><br><span class="line">    <span class="keyword">if</span>(widthMode == MeasureSpec.EXACTLY)&#123;<span class="comment">//如果是固定100dp或match_parent</span></span><br><span class="line">        width = widthSize;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;如果是<span class="type">warp_content</span></span><br><span class="line">        <span class="variable">width</span> <span class="operator">=</span> getPaddingLeft()+rect.width()+getPaddingRight();<span class="comment">//注意要加上padding</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="variable">heightMode</span> <span class="operator">=</span> MeasureSpec.getMode(heightMeasureSpec);<span class="comment">//同width</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">heightSize</span> <span class="operator">=</span> MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">    <span class="type">int</span> height;</span><br><span class="line">    <span class="keyword">if</span>(heightMode == MeasureSpec.EXACTLY)&#123;</span><br><span class="line">        height = heightSize;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        height = getPaddingTop()+rect.height()+getPaddingBottom();</span><br><span class="line">    &#125;</span><br><span class="line">    setMeasuredDimension(width, height);<span class="comment">//最后设置参数,super里面也是调用这个方法进行设置</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="进行绘制"><a href="#进行绘制" class="headerlink" title="进行绘制"></a>进行绘制</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">onDraw</span><span class="params">(Canvas canvas)</span> &#123;</span><br><span class="line">    paint.setColor(Color.YELLOW);</span><br><span class="line">    canvas.drawRect(<span class="number">0</span>, <span class="number">0</span>, getMeasuredWidth(), getMeasuredHeight(), paint);<span class="comment">//绘制背景</span></span><br><span class="line">    paint.setColor(titleTextColor);</span><br><span class="line">    canvas.drawText(titleText, getWidth()/<span class="number">2</span>-rect.width()/<span class="number">2</span>, getHeight()/<span class="number">2</span>+rect.height()/<span class="number">2</span>, paint);<span class="comment">//绘制文字</span></span><br><span class="line">    <span class="comment">//为什么width是减,height是加,要看API文档</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>自定义View</tag>
      </tags>
  </entry>
  <entry>
    <title>Android Studio疑难解决</title>
    <url>/posts/Android_Studio_question.html</url>
    <content><![CDATA[<h1 id="导入第三方类库错误：Could-not-find-com-github-jitpack-release"><a href="#导入第三方类库错误：Could-not-find-com-github-jitpack-release" class="headerlink" title="导入第三方类库错误：Could not find com.github.* :{jitpack-release}"></a>导入第三方类库错误：Could not find com.github.* :{jitpack-release}</h1><p>在使用<a href="https://github.com/techery/progresshint">progresshint</a> 的第三方库时，直接在gradle中添加</p>
<span id="more"></span>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">repositories &#123;  </span><br><span class="line">  jcenter()  </span><br><span class="line">  maven &#123; url <span class="string">&quot;https://jitpack.io&quot;</span> &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">dependencies &#123;  </span><br><span class="line">  compile <span class="string">&#x27;com.github.techery.progresshint:library-addition:&#123;jitpack-release&#125;&#x27;</span>  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>但是爆出了错误</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Error:Could not find com.github.techery.progresshint:library-addition:&#123;jitpack-release&#125;.  </span><br><span class="line">Required by:  </span><br><span class="line">    wnacg:app:unspecified  </span><br><span class="line">Search in build.gradle files  </span><br></pre></td></tr></table></figure>
<p>把**{jitpack-release}<strong>换成</strong>版本号**就可以了<br>解决代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">repositories &#123;  </span><br><span class="line">  jcenter()  </span><br><span class="line">  maven &#123; url &quot;https://jitpack.io&quot; &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">dependencies &#123;  </span><br><span class="line">  compile &#x27;com.github.techery.progresshint:library-addition:0.2.3&#x27;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<h1 id="找不到v4、v7包"><a href="#找不到v4、v7包" class="headerlink" title="找不到v4、v7包"></a>找不到v4、v7包</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"> Rendering Problems Missing styles. Is the correct theme chosen for this layout?  Use the Theme combo box above the layout to choose a different layout, or fix the theme style references.  The following classes could not be found:  </span><br><span class="line">- android.support.v7.widget.AppCompatSeekBar (Fix Build Path, Create Class)  </span><br><span class="line">- android.support.v7.widget.RecyclerView (Fix Build Path, Create Class)  </span><br><span class="line"> Tip: Try to build the project.  Failed to find style &#x27;textViewStyle&#x27; in current theme (62 similar errors not shown)   </span><br></pre></td></tr></table></figure>
<p>检查了<code>gradle</code>中是否有导入</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">compile <span class="string">&#x27;com.android.support:support-v4:23.4.0&#x27;</span>  </span><br><span class="line">compile <span class="string">&#x27;com.android.support:appcompat-v7:23.4.0&#x27;</span>  </span><br><span class="line">compile <span class="string">&#x27;com.android.support:design:23.4.0&#x27;</span>  </span><br></pre></td></tr></table></figure>
<p>仍然找不到<code>v4</code>、<code>v7</code>包<br>最后在<code>SDK Manager</code>中发现<code>Android Support Library</code>的版本号才更新到<code>23.2.1</code><br>换成<code>23.2.1</code>就好了</p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>Genymotion疑难解决</title>
    <url>/posts/Genymotion_questionh.html</url>
    <content><![CDATA[<p><code>genymotion</code>安装及使用出现的问题<br>此处总结<code>genymotion</code>出现的问题。</p>
<span id="more"></span>

<h1 id="Unable-to-create-Virtual-Device"><a href="#Unable-to-create-Virtual-Device" class="headerlink" title="Unable to create Virtual Device"></a>Unable to create Virtual Device</h1><h2 id="Connection-timeout"><a href="#Connection-timeout" class="headerlink" title="Connection timeout."></a>Connection timeout.</h2><p>安装好<code>genymotion</code>后，新建一个模拟器。去下载的时候报错<br><code>Unable to create Virtual Device: Connection timeout.</code></p>
<p>在 <code>C:\Users\[你的名字]\AppData\Local\Genymobile</code>目录下找到 <code>genymotion.log</code>。</p>
<p>打开日志文件，在最后几行找到出错原因如下：</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">四月 21 15:38:02 [Genymotion] [Debug] Remote file size: 182005760 ,current local file size: 0 </span><br><span class="line">四月 21 15:38:02 [Genymotion] [Debug] writting to local file with mode OpenMode( &quot;Append|WriteOnly&quot; ) </span><br><span class="line">四月 21 15:38:02 [Genymotion] [Debug] Downloading file  &quot;http://files2.genymotion.com/dists/4.3/ova/genymotion_vbox86p_4.3_140326_020620.ova&quot; </span><br><span class="line">四月 21 15:38:02 [Genymotion] [Debug] Start timer </span><br><span class="line">四月 21 15:38:02 [Genymotion] [Error] Connection Timeout </span><br><span class="line">四月 21 15:38:02 [Genymotion] [Debug] Received code: 2 : &quot;&quot; </span><br></pre></td></tr></table></figure>
<p>复制<code>http://files2.genymotion.com/dists/4.3/ova/genymotion_vbox86p_4.3_140326_020620.ova </code><br>到浏览器地址栏，通过浏览器下载这个ova</p>
<p>下载好后<code>copy</code> 到<code>C:\Users\[你的名字]\AppData\Local\Genymobile\Genymotion\ova</code> 里。<br>再次启动<code>genymotion</code>，下载这个版本的模拟器就不会报错了。</p>
<h1 id="Unable-to-start-the-Virtual-Device"><a href="#Unable-to-start-the-Virtual-Device" class="headerlink" title="Unable to start the Virtual Device"></a>Unable to start the Virtual Device</h1><h2 id="VitualBox-cannot-start-the-virtual-device"><a href="#VitualBox-cannot-start-the-virtual-device" class="headerlink" title="VitualBox cannot start the virtual device"></a>VitualBox cannot start the virtual device</h2><p><strong>问题描述</strong><br>打开genymotion，启动虚拟设备，出现如下报错</p>
<img data-src="/images/Genymotion%E7%96%91%E9%9A%BE%E8%A7%A3%E5%86%B3_01.png" class="">

<p>打开VirtualBox直接启动虚拟设备</p>
<img data-src="/images/Genymotion%E7%96%91%E9%9A%BE%E8%A7%A3%E5%86%B3_02.png" class="">

<p>发现是网络接口问题</p>
<img data-src="/images/Genymotion%E7%96%91%E9%9A%BE%E8%A7%A3%E5%86%B3_03.png" class="">

<p><strong>解决方案</strong><br>打开网络中心，右键<code>VirtualBox Host-Only Network #2</code>，属性，开启<code>VirtualBox NDIS6 Bridged Networking Driver</code>。</p>
<h1 id="使用Genymotion调试出现错误INSTALL-FAILED-CPU-ABI-INCOMPATIBLE解决办法"><a href="#使用Genymotion调试出现错误INSTALL-FAILED-CPU-ABI-INCOMPATIBLE解决办法" class="headerlink" title="使用Genymotion调试出现错误INSTALL_FAILED_CPU_ABI_INCOMPATIBLE解决办法"></a>使用Genymotion调试出现错误INSTALL_FAILED_CPU_ABI_INCOMPATIBLE解决办法</h1><p>转自：<a href="http://blog.csdn.net/wjr2012/article/details/16359113">http://blog.csdn.net/wjr2012/article/details/16359113</a></p>
<p>点击下载Genymotion-ARM-Translation.zip</p>
<p>将你的虚拟器运行起来，将下载好的zip包用鼠标拖到虚拟机窗口中，出现确认对跨框点OK就行。然后重启你的虚拟机。</p>
<p>来源： <a href="http://www.cnblogs.com/wliangde/p/3678649.html">http://www.cnblogs.com/wliangde/p/3678649.html</a></p>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>使用Gradle发布Android开源项目到JCenter</title>
    <url>/posts/how_to_use_Gradle_to_publish_project_to_JCenter.html</url>
    <content><![CDATA[<h1 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h1><blockquote>
<p>使用bintray-release发布</p>
</blockquote>
<p>使用<code>github</code>帐号登录<a href="https://bintray.com/">https://bintray.com/</a> ，<br>你可以点击<code>Your Profile</code>-&gt;<code>Edit</code>-&gt;<code>API Key</code>，复制。</p>
<span id="more"></span>

<h1 id="AS"><a href="#AS" class="headerlink" title="AS"></a>AS</h1><p>在最顶层的<code>gradle</code>中添加</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;...&#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.android.tools.build:gradle:2.1.2&#x27;</span></span><br><span class="line">        classpath <span class="string">&#x27;com.novoda:bintray-release:0.3.4&#x27;</span><span class="comment">//添加</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">allprojects &#123;</span><br><span class="line">    repositories &#123;...&#125;</span><br><span class="line">    tasks.withType(Javadoc) &#123;<span class="comment">//添加</span></span><br><span class="line">        options&#123; encoding <span class="string">&quot;UTF-8&quot;</span> charSet <span class="string">&#x27;UTF-8&#x27;</span> links <span class="string">&quot;http://docs.oracle.com/javase/7/docs/api&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在想要上传的<code>module</code>添加</p>
<figure class="highlight groovy"><table><tr><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.android.library&#x27;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;com.novoda.bintray-release&#x27;</span><span class="comment">//添加</span></span><br><span class="line">android &#123;...&#125;</span><br><span class="line">dependencies &#123;...&#125;</span><br><span class="line">publish &#123;</span><br><span class="line">    userOrg = <span class="string">&#x27;ahaochan&#x27;</span></span><br><span class="line">    groupId = <span class="string">&#x27;com.ahaochan&#x27;</span></span><br><span class="line">    artifactId = <span class="string">&#x27;TabLayout&#x27;</span><span class="comment">//项目名</span></span><br><span class="line">    publishVersion = <span class="string">&#x27;0.0.2&#x27;</span><span class="comment">//版本号</span></span><br><span class="line">    desc = <span class="string">&#x27;Imitate WeChat6.0 TabLayout&#x27;</span><span class="comment">//描述</span></span><br><span class="line">    website = <span class="string">&#x27;https://github.com/Ahaochan/TabLayout&#x27;</span><span class="comment">//github地址</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在<code>AS</code>底下的<code>Terminal</code>中输入</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gradlew clean build bintrayUpload </span><br><span class="line">-PbintrayUser=ahaochan</span><br><span class="line">-PbintrayKey=之前复制的key</span><br><span class="line">-PdryRun=false</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>工具</tag>
      </tags>
  </entry>
  <entry>
    <title>海关跨境申报流程165号和179号文档</title>
    <url>/posts/Customs_Declaration_Documents_165_And_179.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>苦啊, 弄了快两个月了.<br>整个业务流程复杂的很, 但是走通过一次, 就懂了.<br>我要吐槽的就两个</p>
<ol>
<li>海关文档一言难尽.</li>
<li>微信群办公, 每天看海关人员发文档, 都觉得心累. 还不如弄个QQ群上传群文件呢.</li>
</ol>
<span id="more"></span>

<h1 id="开发背景"><a href="#开发背景" class="headerlink" title="开发背景"></a>开发背景</h1><p>说下我司背景, 我司是电商平台, 以前都是供应商进行海关申报的, 进行四单对碰, 订单、支付单、运单、清单.<br>现在由于海关出了两个文档</p>
<ol>
<li><a href="http://www.customs.gov.cn/customs/302249/302266/302267/2134975/index.html">海关总署公告2018年第165号（关于实时获取跨境电子商务平台企业支付相关原始数据有关事宜的公告）</a></li>
<li><a href="http://www.customs.gov.cn/customs/302249/302266/302267/2155884/index.html">海关总署公告2018年第179号（关于实时获取跨境电子商务平台企业支付相关原始数据接入有关事宜的公告）</a></li>
</ol>
<p>所以必须由我司进行<strong>支付单</strong>的推送了.<br>我司使用的是微信支付, 所以调用微信支付的<a href="https://pay.weixin.qq.com/wiki/doc/api/external/declarecustom.php?chapter=18_1">报关接口</a>来报支付单.</p>
<h1 id="开发前的准备"><a href="#开发前的准备" class="headerlink" title="开发前的准备"></a>开发前的准备</h1><ol>
<li>采购一台实体<code>Window Server 2012R2</code>主机, 并要求能访问外网.</li>
<li>阅读<a href="http://www.chinaport.gov.cn/kfzq/xyhdh/index.htm">新用户导航</a>, 弄到一张<strong>法人卡</strong>和<strong>操作员卡</strong>, 实际上就是两个<code>U盘</code>.</li>
<li>获取海关技术人员<a href="http://www.chinaport.gov.cn/gg/zgdzkasjzx/18400.htm">联系方式</a>, 要求加入微信联调群.</li>
<li>准备最长两个月的开发对接时间</li>
</ol>
<h1 id="改造支付接口"><a href="#改造支付接口" class="headerlink" title="改造支付接口"></a>改造支付接口</h1><p>根据<a href="http://www.customs.gov.cn/customs/302249/302266/302267/2134975/index.html">海关总署公告2018年第165号.doc</a> 第<code>3.5</code>节, 我们需要保留微信支付的原始请求体<code>initalRequest</code>和原始响应体<code>initalResponse</code>.<br>微信支付的请求体和响应体是<code>xml</code>格式的, 那就直接塞进数据库保存起来就好了, 以后再根据订单号取出来.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">id      订单id        请求体xml      响应体xml</span><br><span class="line">1       ORDER-1      &lt;xml&gt;&lt;/xml&gt;   &lt;xml&gt;&lt;/xml&gt;</span><br><span class="line">2       ORDER-2      &lt;xml&gt;&lt;/xml&gt;   &lt;xml&gt;&lt;/xml&gt;</span><br></pre></td></tr></table></figure>

<h1 id="注册测试环境"><a href="#注册测试环境" class="headerlink" title="注册测试环境"></a>注册测试环境</h1><p>假设现在你已经拿到了<strong>操作员卡</strong>.</p>
<p>跟着<a href="https://www.cnblogs.com/whtydn/p/10220209.html">海关 实时数据 企业联调接口 开发步骤与概要 第四步</a>做, 这是为了拿到证书.<br>要注意的有几点</p>
<ol>
<li>安装海关控件, 必须先安装<code>.net framework 3.5</code>.</li>
<li>初始密码一般是<code>88888888</code>, 密码错误多次会锁卡.</li>
<li>证书一定是<strong>读取证书</strong>那个方框里的, 不要把<strong>证书序列号</strong>也复制进去.</li>
<li>证书保存完毕后, 双击打开, 可以看到证书信息, 确认公司名和法人名没错后, 就可以了.</li>
</ol>
<p>得到证书和证书序列号后, 联系海关微信联调群里的陈书宾, 注册测试环境, 将相关信息提供给他.<br>目前需要以下资料</p>
<ol>
<li>证书</li>
<li>证书序列号</li>
<li>电商平台代码</li>
<li>电商企业名称</li>
<li>联系人</li>
<li>联系人电话</li>
</ol>
<h1 id="在测试环境进行验签"><a href="#在测试环境进行验签" class="headerlink" title="在测试环境进行验签"></a>在测试环境进行验签</h1><p>请务必在完成<strong>注册测试环境</strong>步骤后, 保持<strong>操作员卡</strong>插在自己电脑的状态.<br>我们可以在微信联调群拿到一个<code>html+js加签工具.rar</code>, 海关文档只提供了<code>js</code>版的<code>websocket</code>加签客户端. 这个<code>html</code>的应该是其他热心企业提供的.</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html--&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">Content-Type</span> <span class="attr">content</span>=<span class="string">&quot;text/html; charset=UTF-8&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">text/javascript</span> <span class="attr">src</span>=<span class="string">./json2.js</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">text/javascript</span> <span class="attr">src</span>=<span class="string">&quot;./client.js?d=2018-12-19_16:00:00&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://unpkg.com/axios/dist/axios.min.js</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">https://cdn.jsdelivr.net/npm/vue@2.6.8/dist/vue.js</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">text/javascript</span>&gt;</span><span class="language-javascript"><span class="keyword">function</span> <span class="title function_">SignDataAsPem</span>(<span class="params"></span>)&#123;<span class="title class_">EportClient</span>.<span class="title function_">isInstalledTest</span>(<span class="title class_">EportClient</span>.<span class="property">cusSpcSignDataAsPEM</span>,<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;txt1&quot;</span>).<span class="property">value</span>,<span class="string">&quot;88888888&quot;</span>,<span class="keyword">function</span>(<span class="params">t</span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(t)),<span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;txt2&quot;</span>).<span class="property">value</span>=<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(t)&#125;)&#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">vue-app</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>轮询加签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">startReq()</span>&gt;</span>开始轮询<span class="tag">&lt;/<span class="name">button</span>&gt;</span> <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">stopReq()</span>&gt;</span>停止轮询<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-if</span>=<span class="string">&quot;list.length &gt; 0&quot;</span>&gt;</span>数据加签中...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span> <span class="attr">v-else</span>&gt;</span>空闲...<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-for</span>=<span class="string">&quot;(item, index) in list&quot;</span> <span class="attr">:key</span>=<span class="string">index</span>&gt;</span>&#123;&#123;item.text&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">h3</span>&gt;</span>加签记录:<span class="tag">&lt;/<span class="name">h3</span>&gt;</span><span class="tag">&lt;<span class="name">p</span> <span class="attr">v-for</span>=<span class="string">&quot;(item, index) in responseList&quot;</span>&gt;</span>&#123;&#123;item&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>手动加签<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">30</span> <span class="attr">cols</span>=<span class="string">60</span> <span class="attr">id</span>=<span class="string">txt1</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">textarea</span> <span class="attr">rows</span>=<span class="string">30</span> <span class="attr">cols</span>=<span class="string">60</span> <span class="attr">id</span>=<span class="string">txt2</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">SignDataAsPem()</span>&gt;</span>加签<span class="tag">&lt;/<span class="name">button</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="meta"></span></span></span><br><span class="line"><span class="meta"><span class="language-javascript">&quot;use strict&quot;</span>;<span class="keyword">function</span> <span class="title function_">_asyncToGenerator</span>(<span class="params">e</span>)&#123;<span class="keyword">return</span> <span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> t=e.<span class="title function_">apply</span>(<span class="variable language_">this</span>,<span class="variable language_">arguments</span>);<span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">e,n</span>)&#123;<span class="keyword">function</span> <span class="title function_">r</span>(<span class="params">o,a</span>)&#123;<span class="keyword">try</span>&#123;<span class="keyword">var</span> s=t[o](a),u=s.<span class="property">value</span>&#125;<span class="keyword">catch</span>(e)&#123;<span class="keyword">return</span> <span class="keyword">void</span> <span class="title function_">n</span>(e)&#125;<span class="keyword">if</span>(!s.<span class="property">done</span>)<span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(u).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="title function_">r</span>(<span class="string">&quot;next&quot;</span>,e)&#125;,<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="title function_">r</span>(<span class="string">&quot;throw&quot;</span>,e)&#125;);<span class="title function_">e</span>(u)&#125;<span class="keyword">return</span> <span class="title function_">r</span>(<span class="string">&quot;next&quot;</span>)&#125;)&#125;&#125;<span class="keyword">function</span> <span class="title function_">SignDataToAsPem</span>(<span class="params">e,t</span>)&#123;<span class="keyword">return</span> <span class="variable language_">console</span>.<span class="title function_">log</span>(e),<span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="keyword">function</span>(<span class="params">n,r</span>)&#123;<span class="title class_">EportClient</span>.<span class="title function_">isInstalledTest</span>(<span class="title class_">EportClient</span>.<span class="property">cusSpcSignDataAsPEM</span>,t,<span class="string">&quot;88888888&quot;</span>,<span class="keyword">function</span>(<span class="params">t,o</span>)&#123;<span class="keyword">if</span>(!t)<span class="keyword">return</span> <span class="keyword">void</span> <span class="title function_">r</span>(<span class="string">&quot;error&quot;</span>);<span class="title function_">doResponse</span>(&#123;<span class="attr">asin</span>:t.<span class="property">Data</span>[<span class="number">0</span>],<span class="attr">orderNo</span>:e&#125;).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">t</span>)&#123;va.<span class="property">responseList</span>.<span class="title function_">push</span>(<span class="string">&quot;订单&quot;</span>+e+<span class="string">&quot;: &quot;</span>+t.<span class="property">data</span>),<span class="title function_">n</span>()&#125;)&#125;)&#125;)&#125;<span class="keyword">var</span> timeout=<span class="number">4e3</span>,status=<span class="number">1</span>,doRequest=<span class="keyword">function</span> <span class="title function_">e</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> t=<span class="variable language_">this</span>;<span class="keyword">return</span> axios.<span class="title function_">post</span>(<span class="string">&quot;http://xxxxxxxx/oms/custom/lunxun&quot;</span>).<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> n=<span class="title function_">_asyncToGenerator</span>(regeneratorRuntime.<span class="title function_">mark</span>(<span class="keyword">function</span> <span class="title function_">n</span>(<span class="params">r</span>)&#123;<span class="keyword">var</span> o,a,s,u,i,c,f,p=r.<span class="property">data</span>;<span class="keyword">return</span> regeneratorRuntime.<span class="title function_">wrap</span>(<span class="keyword">function</span>(<span class="params">t</span>)&#123;<span class="keyword">for</span>(;;)<span class="keyword">switch</span>(t.<span class="property">prev</span>=t.<span class="property">next</span>)&#123;<span class="keyword">case</span> <span class="number">0</span>:<span class="keyword">if</span>(o=<span class="title class_">Object</span>.<span class="title function_">keys</span>(p),!(o.<span class="property">length</span>&gt;<span class="number">0</span>&amp;&amp;<span class="string">&quot;error&quot;</span>!==o[<span class="number">0</span>]))&#123;t.<span class="property">next</span>=<span class="number">29</span>;<span class="keyword">break</span>&#125;o.<span class="title function_">forEach</span>(<span class="keyword">function</span>(<span class="params">e</span>)&#123;va.<span class="property">list</span>.<span class="title function_">push</span>(&#123;<span class="attr">key</span>:e,<span class="attr">text</span>:p[e]&#125;)&#125;),a=!<span class="number">0</span>,s=!<span class="number">1</span>,u=<span class="keyword">void</span> <span class="number">0</span>,t.<span class="property">prev</span>=<span class="number">6</span>,i=va.<span class="property">list</span>[<span class="title class_">Symbol</span>.<span class="property">iterator</span>]();<span class="keyword">case</span> <span class="number">8</span>:<span class="keyword">if</span>(a=(c=i.<span class="title function_">next</span>()).<span class="property">done</span>)&#123;t.<span class="property">next</span>=<span class="number">15</span>;<span class="keyword">break</span>&#125;<span class="keyword">return</span> f=c.<span class="property">value</span>,t.<span class="property">next</span>=<span class="number">12</span>,<span class="title class_">SignDataToAsPem</span>(f.<span class="property">key</span>,f.<span class="property">text</span>);<span class="keyword">case</span> <span class="number">12</span>:a=!<span class="number">0</span>,t.<span class="property">next</span>=<span class="number">8</span>;<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">15</span>:t.<span class="property">next</span>=<span class="number">21</span>;<span class="keyword">break</span>;<span class="keyword">case</span> <span class="number">17</span>:t.<span class="property">prev</span>=<span class="number">17</span>,t.<span class="property">t0</span>=t.<span class="title function_">catch</span>(<span class="number">6</span>),s=!<span class="number">0</span>,u=t.<span class="property">t0</span>;<span class="keyword">case</span> <span class="number">21</span>:t.<span class="property">prev</span>=<span class="number">21</span>,t.<span class="property">prev</span>=<span class="number">22</span>,!a&amp;&amp;i.<span class="property">return</span>&amp;&amp;i.<span class="keyword">return</span>();<span class="keyword">case</span> <span class="number">24</span>:<span class="keyword">if</span>(t.<span class="property">prev</span>=<span class="number">24</span>,!s)&#123;t.<span class="property">next</span>=<span class="number">27</span>;<span class="keyword">break</span>&#125;<span class="keyword">throw</span> u;<span class="keyword">case</span> <span class="number">27</span>:<span class="keyword">return</span> t.<span class="title function_">finish</span>(<span class="number">24</span>);<span class="keyword">case</span> <span class="number">28</span>:<span class="keyword">return</span> t.<span class="title function_">finish</span>(<span class="number">21</span>);<span class="keyword">case</span> <span class="number">29</span>:va.<span class="property">list</span>=[],status&amp;&amp;<span class="built_in">setTimeout</span>(e,timeout);<span class="keyword">case</span> <span class="number">31</span>:<span class="keyword">case</span><span class="string">&quot;end&quot;</span>:<span class="keyword">return</span> t.<span class="title function_">stop</span>()&#125;&#125;,n,t,[[<span class="number">6</span>,<span class="number">17</span>,<span class="number">21</span>,<span class="number">29</span>],[<span class="number">22</span>,,<span class="number">24</span>,<span class="number">28</span>]])&#125;));<span class="keyword">return</span> <span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">return</span> n.<span class="title function_">apply</span>(<span class="variable language_">this</span>,<span class="variable language_">arguments</span>)&#125;&#125;())&#125;,doResponse=<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">return</span> <span class="title function_">axios</span>(&#123;<span class="attr">method</span>:<span class="string">&quot;post&quot;</span>,<span class="attr">url</span>:<span class="string">&quot;http://xxxxxxx/oms/custom/callback&quot;</span>,<span class="attr">data</span>:e,<span class="attr">transformRequest</span>:[<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">var</span> t=<span class="string">&quot;&quot;</span>;<span class="keyword">for</span>(<span class="keyword">var</span> n <span class="keyword">in</span> e)t+=<span class="built_in">encodeURIComponent</span>(n)+<span class="string">&quot;=&quot;</span>+<span class="built_in">encodeURIComponent</span>(e[n])+<span class="string">&quot;&amp;&quot;</span>;<span class="keyword">return</span> t&#125;],<span class="attr">headers</span>:&#123;<span class="string">&quot;Content-Type&quot;</span>:<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>&#125;&#125;)&#125;,stopReq=<span class="keyword">function</span>(<span class="params"></span>)&#123;status=<span class="number">0</span>&#125;,startReq=<span class="keyword">function</span>(<span class="params"></span>)&#123;status=<span class="number">1</span>,<span class="title function_">doRequest</span>()&#125;,va=<span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;<span class="attr">el</span>:<span class="string">&quot;#vue-app&quot;</span>,<span class="attr">data</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">return</span>&#123;<span class="attr">list</span>:[],<span class="attr">responseList</span>:[]&#125;&#125;&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// client.js</span></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"><span class="variable language_">window</span>,<span class="variable language_">document</span>,navigator</span>)&#123;<span class="keyword">var</span> installlerUrl;<span class="keyword">var</span> swVersionScript=<span class="string">&quot;https://app.singlewindow.cn/sat/swVersion.js&quot;</span>;<span class="keyword">if</span>(!<span class="variable language_">window</span>.<span class="property">SwVersion</span>)&#123;<span class="keyword">var</span> onloadFunc=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> jsDom=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;script&quot;</span>);jsDom.<span class="title function_">setAttribute</span>(<span class="string">&quot;type&quot;</span>,<span class="string">&quot;text/javascript&quot;</span>);jsDom.<span class="title function_">setAttribute</span>(<span class="string">&quot;src&quot;</span>,swVersionScript+<span class="string">&quot;?d=&quot;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>().<span class="title function_">getTime</span>());<span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(jsDom);installlerUrl=<span class="variable language_">window</span>.<span class="property">SwVersion</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">SwVersion</span>.<span class="title function_">getIkeyDownloadUrl</span>();<span class="keyword">if</span>(!installlerUrl)&#123;<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;installlerUrl=<span class="variable language_">window</span>.<span class="property">SwVersion</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">SwVersion</span>.<span class="title function_">getIkeyDownloadUrl</span>();<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c installlerUrl地址为:&quot;</span>+installlerUrl,<span class="string">&quot;color:#1941EC;font-size:12px&quot;</span>)&#125;&#125;,<span class="number">3000</span>)&#125;&#125;;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">addEventListener</span>)&#123;<span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;load&quot;</span>,onloadFunc,<span class="literal">false</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">attachEvent</span>)&#123;<span class="variable language_">window</span>.<span class="title function_">attachEvent</span>(<span class="string">&quot;onload&quot;</span>,onloadFunc)&#125;<span class="keyword">else</span>&#123;<span class="variable language_">window</span>.<span class="property">onload</span>=onloadFunc&#125;&#125;&#125;<span class="keyword">if</span>(!installlerUrl)&#123;<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;installlerUrl=<span class="variable language_">window</span>.<span class="property">SwVersion</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">SwVersion</span>.<span class="title function_">getIkeyDownloadUrl</span>();<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c installlerUrl地址为:&quot;</span>+installlerUrl,<span class="string">&quot;color:#1941EC;font-size:12px&quot;</span>)&#125;&#125;,<span class="number">3000</span>)&#125;<span class="keyword">var</span> <span class="title class_">DefaultType</span>=<span class="string">&quot;iKey&quot;</span>;<span class="keyword">var</span> toJson=<span class="keyword">function</span>(<span class="params">obj</span>)&#123;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">JSON</span>)&#123;<span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">stringify</span>(obj)&#125;<span class="keyword">else</span>&#123;<span class="title function_">alert</span>(<span class="string">&quot;JSON转换错误!&quot;</span>);<span class="keyword">return</span> <span class="literal">null</span>&#125;&#125;;<span class="keyword">var</span> jsonToObj=<span class="keyword">function</span>(<span class="params">text</span>)&#123;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">JSON</span>)&#123;<span class="keyword">return</span> <span class="title class_">JSON</span>.<span class="title function_">parse</span>(text)&#125;<span class="keyword">else</span>&#123;<span class="keyword">return</span> <span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span>+text+<span class="string">&quot;)&quot;</span>)&#125;&#125;;<span class="keyword">var</span> getGuid=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> s4=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">return</span>(((<span class="number">1</span>+<span class="title class_">Math</span>.<span class="title function_">random</span>())*<span class="number">65536</span>)|<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">substring</span>(<span class="number">1</span>)&#125;;<span class="keyword">return</span>(<span class="title function_">s4</span>()+<span class="title function_">s4</span>()+<span class="string">&quot;-&quot;</span>+<span class="title function_">s4</span>()+<span class="string">&quot;-&quot;</span>+<span class="title function_">s4</span>()+<span class="string">&quot;-&quot;</span>+<span class="title function_">s4</span>()+<span class="string">&quot;-&quot;</span>+<span class="title function_">s4</span>()+<span class="title function_">s4</span>()+<span class="title function_">s4</span>())&#125;;<span class="keyword">var</span> splitStrData=<span class="keyword">function</span>(<span class="params">dataStr</span>)&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> dataStr!==<span class="string">&quot;string&quot;</span>)&#123;<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;数据类型错误&quot;</span>)&#125;<span class="keyword">var</span> <span class="title class_">MaxLength</span>=<span class="number">120</span>*<span class="number">1024</span>;<span class="keyword">var</span> byteCount=<span class="number">0</span>,p=<span class="number">0</span>;<span class="keyword">var</span> rst=[];<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;dataStr.<span class="property">length</span>;i++)&#123;<span class="keyword">var</span> _escape=<span class="built_in">escape</span>(dataStr.<span class="title function_">charAt</span>(i));byteCount=byteCount+((_escape.<span class="property">length</span>&gt;=<span class="number">4</span>&amp;&amp;_escape.<span class="title function_">charAt</span>(<span class="number">0</span>)===<span class="string">&quot;%&quot;</span>&amp;&amp;_escape.<span class="title function_">charAt</span>(<span class="number">1</span>)===<span class="string">&quot;u&quot;</span>)?<span class="number">3</span>:<span class="number">1</span>);<span class="keyword">if</span>(byteCount&gt;<span class="title class_">MaxLength</span>-<span class="number">3</span>)&#123;rst.<span class="title function_">push</span>(dataStr.<span class="title function_">substring</span>(p,i+<span class="number">1</span>));p=i+<span class="number">1</span>;byteCount=<span class="number">0</span>&#125;&#125;<span class="keyword">if</span>(p!==dataStr.<span class="property">length</span>)&#123;rst.<span class="title function_">push</span>(dataStr.<span class="title function_">substring</span>(p))&#125;<span class="keyword">return</span> rst&#125;;<span class="keyword">var</span> getDataHeader=<span class="keyword">function</span>(<span class="params">checkCode,blockCheckCode,size,currsize,blockCount,blockGuid,blockNum</span>)&#123;<span class="keyword">var</span> rst=<span class="string">&quot;BLOCKTXT&quot;</span>;rst+=<span class="title function_">equilongString</span>(checkCode,<span class="number">4</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="title function_">equilongString</span>(blockCheckCode,<span class="number">4</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="title function_">equilongString</span>(size,<span class="number">16</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="title function_">equilongString</span>(currsize,<span class="number">8</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="title function_">equilongString</span>(blockCount,<span class="number">4</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="title function_">equilongString</span>(blockGuid,<span class="number">36</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="title function_">equilongString</span>(blockNum,<span class="number">4</span>,<span class="string">&quot;0&quot;</span>);rst+=<span class="string">&quot;00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000&quot;</span>;<span class="keyword">return</span> rst.<span class="title function_">substring</span>(<span class="number">0</span>,<span class="number">128</span>)&#125;;<span class="keyword">var</span> equilongString=<span class="keyword">function</span>(<span class="params">str,length,prefix</span>)&#123;<span class="keyword">if</span>(!str)&#123;str=<span class="string">&quot;&quot;</span>&#125;<span class="keyword">if</span>(<span class="keyword">typeof</span> str!==<span class="string">&quot;string&quot;</span>)&#123;str=str+<span class="string">&quot;&quot;</span>&#125;<span class="keyword">if</span>(!prefix)&#123;prefix=<span class="string">&quot;0&quot;</span>&#125;<span class="keyword">var</span> diff=length-str.<span class="property">length</span>;<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;diff;i++)&#123;str=prefix+str&#125;<span class="keyword">return</span> str&#125;;<span class="keyword">var</span> isIE6789=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> version=(!!navigator.<span class="property">appVersion</span>)?navigator.<span class="property">appVersion</span>.<span class="title function_">split</span>(<span class="string">&quot;;&quot;</span>):[];<span class="keyword">var</span> trim_Version=(version.<span class="property">length</span>&gt;<span class="number">1</span>)?version[<span class="number">1</span>].<span class="title function_">replace</span>(<span class="regexp">/[ ]/g</span>,<span class="string">&quot;&quot;</span>):<span class="string">&quot;&quot;</span>;<span class="keyword">return</span> navigator.<span class="property">appName</span>===<span class="string">&quot;Microsoft Internet Explorer&quot;</span>&amp;&amp;(trim_Version===<span class="string">&quot;MSIE6.0&quot;</span>||trim_Version===<span class="string">&quot;MSIE7.0&quot;</span>||trim_Version===<span class="string">&quot;MSIE8.0&quot;</span>||trim_Version===<span class="string">&quot;MSIE9.0&quot;</span>)&#125;;<span class="keyword">if</span>(!<span class="variable language_">window</span>.<span class="property">WebSocket</span>&amp;&amp;<span class="title function_">isIE6789</span>())&#123;<span class="title class_">WebSocket</span>=<span class="keyword">function</span>(<span class="params">url</span>)&#123;<span class="variable language_">this</span>.<span class="property">activeXObject</span>=<span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&quot;snsoft.WebSocket&quot;</span>);<span class="keyword">var</span> _self=<span class="variable language_">this</span>,ax=<span class="variable language_">this</span>.<span class="property">activeXObject</span>;<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;ax.<span class="title function_">websocketOpen</span>(_self,url)&#125;,<span class="number">0</span>)&#125;;<span class="title class_">WebSocket</span>.<span class="property"><span class="keyword">prototype</span></span>=&#123;<span class="attr">_callback</span>:<span class="keyword">function</span>(<span class="params">call,ev</span>)&#123;<span class="keyword">var</span> f;<span class="keyword">if</span>(<span class="title function_">typeof</span>(f=<span class="variable language_">this</span>[call])===<span class="string">&quot;function&quot;</span>)&#123;f.<span class="title function_">call</span>(<span class="variable language_">this</span>,ev)&#125;&#125;,<span class="attr">getReadyState</span>:<span class="keyword">function</span>(<span class="params">type</span>)&#123;<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">activeXObject</span>.<span class="title function_">getReadyState</span>((type||<span class="title class_">DefaultType</span>))&#125;,<span class="attr">send</span>:<span class="keyword">function</span>(<span class="params">data</span>)&#123;<span class="variable language_">this</span>.<span class="property">activeXObject</span>.<span class="title function_">websocketSendText</span>(data)&#125;,<span class="attr">close</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="variable language_">this</span>.<span class="property">activeXObject</span>.<span class="title function_">websocketClose</span>()&#125;&#125;&#125;<span class="keyword">var</span> ws;<span class="keyword">var</span> conn=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(!ws||<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">2</span>||<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">3</span>)&#123;<span class="keyword">try</span>&#123;<span class="keyword">var</span> websocketurl=((!!<span class="variable language_">window</span>.<span class="property">location</span>)&amp;&amp;<span class="variable language_">window</span>.<span class="property">location</span>.<span class="property">protocol</span>===<span class="string">&quot;http:&quot;</span>)?<span class="string">&quot;ws://127.0.0.1:61232&quot;</span>:<span class="string">&quot;wss://wss.singlewindow.cn:61231&quot;</span>;<span class="keyword">var</span> websocketurl=<span class="literal">true</span>?<span class="string">&quot;ws://127.0.0.1:61232&quot;</span>:<span class="string">&quot;wss://wss.singlewindow.cn:61231&quot;</span>;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c 使用&quot;</span>+websocketurl+<span class="string">&quot;连接控件服务&quot;</span>,<span class="string">&quot;color:#1941EC;font-size:12px&quot;</span>)&#125;ws=<span class="keyword">new</span> <span class="title class_">WebSocket</span>(websocketurl);ws.<span class="property">onmessage</span>=<span class="keyword">function</span>(<span class="params">e</span>)&#123;<span class="keyword">if</span>(e.<span class="property">data</span>.<span class="title function_">charAt</span>(<span class="number">0</span>)===<span class="string">&quot;&#123;&quot;</span>)&#123;<span class="keyword">var</span> msg=<span class="title function_">jsonToObj</span>(e.<span class="property">data</span>);<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span>)&#123;<span class="keyword">var</span> errMsg=<span class="string">&quot;调用&quot;</span>+msg[<span class="string">&quot;_method&quot;</span>]+<span class="string">&quot;方法已返回, Result=&quot;</span>+(msg[<span class="string">&quot;_args&quot;</span>]&amp;&amp;msg[<span class="string">&quot;_args&quot;</span>].<span class="property">Result</span>);<span class="keyword">var</span> errStyle=<span class="string">&quot;color:#1941EC;font-size:12px&quot;</span>;<span class="keyword">if</span>(!(msg[<span class="string">&quot;_args&quot;</span>]&amp;&amp;msg[<span class="string">&quot;_args&quot;</span>].<span class="property">Result</span>))&#123;errMsg+=<span class="string">&quot;, CallbackInfos=&quot;</span>+e.<span class="property">data</span>;errStyle=<span class="string">&quot;color:#D94E34;font-size:14px&quot;</span>&#125;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c &quot;</span>+errMsg,errStyle)&#125;<span class="keyword">if</span>(callbacks[msg[<span class="string">&quot;_method&quot;</span>]])&#123;callbacks[msg[<span class="string">&quot;_method&quot;</span>]](msg[<span class="string">&quot;_args&quot;</span>],e.<span class="property">data</span>)&#125;&#125;<span class="keyword">else</span>&#123;<span class="title function_">alert</span>(<span class="string">&quot;数据格式非法:&quot;</span>+e.<span class="property">data</span>)&#125;&#125;&#125;<span class="keyword">catch</span>(ex)&#123;<span class="keyword">if</span>(<span class="variable language_">console</span>&amp;&amp;<span class="variable language_">console</span>.<span class="property">log</span>)&#123;<span class="variable language_">console</span>.<span class="title function_">log</span>(ex)&#125;&#125;&#125;<span class="keyword">return</span> ws&#125;;ws=<span class="title function_">conn</span>();<span class="keyword">var</span> callbacks=&#123;&#125;;<span class="keyword">var</span> blockData=&#123;&#125;;<span class="keyword">var</span> sendMessage=<span class="keyword">function</span>(<span class="params">msg,callback</span>)&#123;<span class="keyword">if</span>(<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">1</span>)&#123;ws.<span class="title function_">send</span>(msg)&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> times=<span class="number">0</span>;<span class="keyword">var</span> waitForWebSocketConn=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(times&gt;<span class="number">9</span>)&#123;<span class="title function_">callback</span>(&#123;<span class="title class_">Result</span>:<span class="literal">false</span>,<span class="title class_">Data</span>:[],<span class="title class_">Error</span>:[<span class="string">&quot;连接客户端控件服务失败,请重试.&quot;</span>,<span class="string">&quot;Err:Base60408&quot;</span>]&#125;);</span><br><span class="line"><span class="title function_">conn</span>()&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">0</span>)&#123;<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">if</span>(<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">1</span>)&#123;ws.<span class="title function_">send</span>(msg)&#125;<span class="keyword">else</span>&#123;times++;<span class="title function_">waitForWebSocketConn</span>()&#125;&#125;,<span class="number">500</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">2</span>||<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">3</span>)&#123;times++;<span class="title function_">conn</span>()&#125;&#125;&#125;&#125;;<span class="title function_">waitForWebSocketConn</span>()&#125;&#125;;callbacks.<span class="property">_nextBlock</span>=<span class="keyword">function</span>(<span class="params">args</span>)&#123;<span class="keyword">var</span> guid=args.<span class="property">Data</span>[<span class="number">0</span>][<span class="string">&quot;guid&quot;</span>];<span class="keyword">if</span>(args.<span class="property">Data</span>[<span class="number">0</span>][<span class="string">&quot;finish&quot;</span>])&#123;<span class="keyword">if</span>(blockData[guid])&#123;<span class="keyword">delete</span> blockData[guid]&#125;&#125;<span class="keyword">else</span>&#123;<span class="title function_">conn</span>();<span class="keyword">var</span> next=args.<span class="property">Data</span>[<span class="number">0</span>][<span class="string">&quot;next&quot;</span>];<span class="keyword">var</span> blockObj=blockData[guid];<span class="keyword">if</span>(!args.<span class="property">Result</span>)&#123;<span class="keyword">var</span> retry=blockObj[<span class="string">&quot;retry&quot;</span>]||<span class="number">0</span>;retry=retry+<span class="number">1</span>;blockObj[<span class="string">&quot;retry&quot;</span>]=retry;<span class="keyword">if</span>(retry&gt;blockObj.<span class="property">block</span>.<span class="property">length</span>*<span class="number">3</span>)&#123;<span class="title function_">alert</span>(<span class="string">&quot;数据接收错误!&quot;</span>)&#125;&#125;<span class="keyword">var</span> currData=blockObj.<span class="property">block</span>[next];<span class="keyword">var</span> blockCheckCode=<span class="variable constant_">DIGEST</span>.<span class="title class_">CheckCode</span>(currData);<span class="keyword">var</span> pakHeaser=<span class="title function_">getDataHeader</span>(blockObj[<span class="string">&quot;checkcode&quot;</span>],blockCheckCode,blockObj[<span class="string">&quot;totalLength&quot;</span>],currData.<span class="property">length</span>,blockObj.<span class="property">block</span>.<span class="property">length</span>,guid,next);<span class="keyword">var</span> msg=pakHeaser+currData;<span class="title function_">sendMessage</span>(msg)&#125;&#125;;<span class="keyword">var</span> <span class="variable constant_">DIGEST</span>=&#123;&#125;;<span class="variable constant_">DIGEST</span>.<span class="property">_auchCRCHi</span>=[<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">1</span>,<span class="number">192</span>,<span class="number">128</span>,<span class="number">65</span>,<span class="number">0</span>,<span class="number">193</span>,<span class="number">129</span>,<span class="number">64</span>];<span class="variable constant_">DIGEST</span>.<span class="property">_auchCRCLo</span>=[<span class="number">0</span>,<span class="number">192</span>,<span class="number">193</span>,<span class="number">1</span>,<span class="number">195</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">194</span>,<span class="number">198</span>,<span class="number">6</span>,<span class="number">7</span>,<span class="number">199</span>,<span class="number">5</span>,<span class="number">197</span>,<span class="number">196</span>,<span class="number">4</span>,<span class="number">204</span>,<span class="number">12</span>,<span class="number">13</span>,<span class="number">205</span>,<span class="number">15</span>,<span class="number">207</span>,<span class="number">206</span>,<span class="number">14</span>,<span class="number">10</span>,<span class="number">202</span>,<span class="number">203</span>,<span class="number">11</span>,<span class="number">201</span>,<span class="number">9</span>,<span class="number">8</span>,<span class="number">200</span>,<span class="number">216</span>,<span class="number">24</span>,<span class="number">25</span>,<span class="number">217</span>,<span class="number">27</span>,<span class="number">219</span>,<span class="number">218</span>,<span class="number">26</span>,<span class="number">30</span>,<span class="number">222</span>,<span class="number">223</span>,<span class="number">31</span>,<span class="number">221</span>,<span class="number">29</span>,<span class="number">28</span>,<span class="number">220</span>,<span class="number">20</span>,<span class="number">212</span>,<span class="number">213</span>,<span class="number">21</span>,<span class="number">215</span>,<span class="number">23</span>,<span class="number">22</span>,<span class="number">214</span>,<span class="number">210</span>,<span class="number">18</span>,<span class="number">19</span>,<span class="number">211</span>,<span class="number">17</span>,<span class="number">209</span>,<span class="number">208</span>,<span class="number">16</span>,<span class="number">240</span>,<span class="number">48</span>,<span class="number">49</span>,<span class="number">241</span>,<span class="number">51</span>,<span class="number">243</span>,<span class="number">242</span>,<span class="number">50</span>,<span class="number">54</span>,<span class="number">246</span>,<span class="number">247</span>,<span class="number">55</span>,<span class="number">245</span>,<span class="number">53</span>,<span class="number">52</span>,<span class="number">244</span>,<span class="number">60</span>,<span class="number">252</span>,<span class="number">253</span>,<span class="number">61</span>,<span class="number">255</span>,<span class="number">63</span>,<span class="number">62</span>,<span class="number">254</span>,<span class="number">250</span>,<span class="number">58</span>,<span class="number">59</span>,<span class="number">251</span>,<span class="number">57</span>,<span class="number">249</span>,<span class="number">248</span>,<span class="number">56</span>,<span class="number">40</span>,<span class="number">232</span>,<span class="number">233</span>,<span class="number">41</span>,<span class="number">235</span>,<span class="number">43</span>,<span class="number">42</span>,<span class="number">234</span>,<span class="number">238</span>,<span class="number">46</span>,<span class="number">47</span>,<span class="number">239</span>,<span class="number">45</span>,<span class="number">237</span>,<span class="number">236</span>,<span class="number">44</span>,<span class="number">228</span>,<span class="number">36</span>,<span class="number">37</span>,<span class="number">229</span>,<span class="number">39</span>,<span class="number">231</span>,<span class="number">230</span>,<span class="number">38</span>,<span class="number">34</span>,<span class="number">226</span>,<span class="number">227</span>,<span class="number">35</span>,<span class="number">225</span>,<span class="number">33</span>,<span class="number">32</span>,<span class="number">224</span>,<span class="number">160</span>,<span class="number">96</span>,<span class="number">97</span>,<span class="number">161</span>,<span class="number">99</span>,<span class="number">163</span>,<span class="number">162</span>,<span class="number">98</span>,<span class="number">102</span>,<span class="number">166</span>,<span class="number">167</span>,<span class="number">103</span>,<span class="number">165</span>,<span class="number">101</span>,<span class="number">100</span>,<span class="number">164</span>,<span class="number">108</span>,<span class="number">172</span>,<span class="number">173</span>,<span class="number">109</span>,<span class="number">175</span>,<span class="number">111</span>,<span class="number">110</span>,<span class="number">174</span>,<span class="number">170</span>,<span class="number">106</span>,<span class="number">107</span>,<span class="number">171</span>,<span class="number">105</span>,<span class="number">169</span>,<span class="number">168</span>,<span class="number">104</span>,<span class="number">120</span>,<span class="number">184</span>,<span class="number">185</span>,<span class="number">121</span>,<span class="number">187</span>,<span class="number">123</span>,<span class="number">122</span>,<span class="number">186</span>,<span class="number">190</span>,<span class="number">126</span>,<span class="number">127</span>,<span class="number">191</span>,<span class="number">125</span>,<span class="number">189</span>,<span class="number">188</span>,<span class="number">124</span>,<span class="number">180</span>,<span class="number">116</span>,<span class="number">117</span>,<span class="number">181</span>,<span class="number">119</span>,<span class="number">183</span>,<span class="number">182</span>,<span class="number">118</span>,<span class="number">114</span>,<span class="number">178</span>,<span class="number">179</span>,<span class="number">115</span>,<span class="number">177</span>,<span class="number">113</span>,<span class="number">112</span>,<span class="number">176</span>,<span class="number">80</span>,<span class="number">144</span>,<span class="number">145</span>,<span class="number">81</span>,<span class="number">147</span>,<span class="number">83</span>,<span class="number">82</span>,<span class="number">146</span>,<span class="number">150</span>,<span class="number">86</span>,<span class="number">87</span>,<span class="number">151</span>,<span class="number">85</span>,<span class="number">149</span>,<span class="number">148</span>,<span class="number">84</span>,<span class="number">156</span>,<span class="number">92</span>,<span class="number">93</span>,<span class="number">157</span>,<span class="number">95</span>,<span class="number">159</span>,<span class="number">158</span>,<span class="number">94</span>,<span class="number">90</span>,<span class="number">154</span>,<span class="number">155</span>,<span class="number">91</span>,<span class="number">153</span>,<span class="number">89</span>,<span class="number">88</span>,<span class="number">152</span>,<span class="number">136</span>,<span class="number">72</span>,<span class="number">73</span>,<span class="number">137</span>,<span class="number">75</span>,<span class="number">139</span>,<span class="number">138</span>,<span class="number">74</span>,<span class="number">78</span>,<span class="number">142</span>,<span class="number">143</span>,<span class="number">79</span>,<span class="number">141</span>,<span class="number">77</span>,<span class="number">76</span>,<span class="number">140</span>,<span class="number">68</span>,<span class="number">132</span>,<span class="number">133</span>,<span class="number">69</span>,<span class="number">135</span>,<span class="number">71</span>,<span class="number">70</span>,<span class="number">134</span>,<span class="number">130</span>,<span class="number">66</span>,<span class="number">67</span>,<span class="number">131</span>,<span class="number">65</span>,<span class="number">129</span>,<span class="number">128</span>,<span class="number">64</span>];<span class="variable constant_">DIGEST</span>.<span class="property">CheckCode</span>=<span class="keyword">function</span>(<span class="params">buffer</span>)&#123;<span class="keyword">var</span> hi=<span class="number">255</span>;<span class="keyword">var</span> lo=<span class="number">255</span>;<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;buffer.<span class="property">length</span>;i++)&#123;<span class="keyword">var</span> idx=<span class="number">255</span>&amp;(hi^buffer.<span class="title function_">charCodeAt</span>(i));hi=(lo^<span class="variable constant_">DIGEST</span>.<span class="property">_auchCRCHi</span>[idx]);lo=<span class="variable constant_">DIGEST</span>.<span class="property">_auchCRCLo</span>[idx]&#125;<span class="keyword">return</span> <span class="variable constant_">DIGEST</span>.<span class="title function_">padLeft</span>((hi&lt;&lt;<span class="number">8</span>|lo).<span class="title function_">toString</span>(<span class="number">16</span>).<span class="title function_">toUpperCase</span>(),<span class="number">4</span>,<span class="string">&quot;0&quot;</span>)&#125;;<span class="variable constant_">DIGEST</span>.<span class="property">padLeft</span>=<span class="keyword">function</span>(<span class="params">s,w,pc</span>)&#123;<span class="keyword">if</span>(pc===<span class="literal">undefined</span>)&#123;pc=<span class="string">&quot;0&quot;</span>&#125;<span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>,c=w-s.<span class="property">length</span>;i&lt;c;i++)&#123;s=pc+s&#125;<span class="keyword">return</span> s&#125;;<span class="keyword">var</span> id=<span class="number">0</span>;<span class="keyword">var</span> baseInvoke=<span class="keyword">function</span>(<span class="params">method,args,callback</span>)&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> args===<span class="string">&quot;function&quot;</span>)&#123;callback=args;args=&#123;&#125;&#125;<span class="title function_">conn</span>();<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c 调用方法&quot;</span>+method,<span class="string">&quot;color:#95F065;font-size:12px&quot;</span>)&#125;callbacks[method]=callback;<span class="keyword">var</span> _data=&#123;<span class="string">&quot;_method&quot;</span>:method&#125;;_data[<span class="string">&quot;_id&quot;</span>]=id++;args=args||&#123;&#125;;_data[<span class="string">&quot;args&quot;</span>]=args;<span class="keyword">var</span> s=<span class="title function_">toJson</span>(_data);<span class="keyword">if</span>(<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">0</span>)&#123;<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="title function_">sendMessage</span>(s,callback)&#125;,<span class="number">500</span>)&#125;<span class="keyword">else</span>&#123;<span class="title function_">sendMessage</span>(s,callback)&#125;&#125;;<span class="keyword">var</span> baseInvokeByFrames=<span class="keyword">function</span>(<span class="params">method,args,callback</span>)&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> args===<span class="string">&quot;function&quot;</span>)&#123;callback=args;args=&#123;&#125;&#125;<span class="title function_">conn</span>();<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>&amp;&amp;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="property">log</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(<span class="string">&quot;%c 调用方法&quot;</span>+method,<span class="string">&quot;color:#95F065;font-size:12px&quot;</span>)&#125;callbacks[method]=callback;<span class="keyword">var</span> _data=&#123;<span class="string">&quot;_method&quot;</span>:method&#125;;_data[<span class="string">&quot;_id&quot;</span>]=id++;args=args||&#123;&#125;;_data[<span class="string">&quot;args&quot;</span>]=args;<span class="keyword">var</span> s=<span class="title function_">toJson</span>(_data);<span class="keyword">if</span>(<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">0</span>||<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">3</span>)&#123;<span class="built_in">setTimeout</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="title function_">sendFrames</span>(s,callback)&#125;,<span class="number">500</span>)&#125;<span class="keyword">else</span>&#123;<span class="title function_">sendFrames</span>(s,callback)&#125;&#125;;<span class="keyword">var</span> sendFrames=<span class="keyword">function</span>(<span class="params">s,callback</span>)&#123;<span class="keyword">var</span> checkCode=<span class="variable constant_">DIGEST</span>.<span class="title class_">CheckCode</span>(s);<span class="keyword">var</span> guid=<span class="title function_">getGuid</span>();<span class="keyword">while</span>(blockData[guid])&#123;guid=<span class="title function_">getGuid</span>()&#125;<span class="keyword">var</span> splitData=<span class="title function_">splitStrData</span>(s);blockData[guid]=&#123;<span class="attr">checkcode</span>:checkCode,<span class="attr">totalLength</span>:s.<span class="property">length</span>,<span class="attr">retry</span>:<span class="number">0</span>,<span class="attr">block</span>:splitData&#125;;<span class="keyword">var</span> blockCheckCode=<span class="variable constant_">DIGEST</span>.<span class="title class_">CheckCode</span>(splitData[<span class="number">0</span>]);<span class="keyword">var</span> pakHeaser=<span class="title function_">getDataHeader</span>(checkCode,blockCheckCode,s.<span class="property">length</span>,splitData[<span class="number">0</span>].<span class="property">length</span>,splitData.<span class="property">length</span>,guid,<span class="number">0</span>);<span class="keyword">var</span> msg=pakHeaser+splitData[<span class="number">0</span>];<span class="title function_">sendMessage</span>(msg,callback)&#125;;<span class="keyword">var</span> getWebSocketReadyState=<span class="keyword">function</span>(<span class="params">thisWs</span>)&#123;<span class="keyword">var</span> currWs=thisWs||<span class="title function_">conn</span>();<span class="keyword">if</span>(!currWs)&#123;<span class="keyword">return</span> <span class="number">0</span>&#125;<span class="keyword">if</span>(currWs.<span class="property">readyState</span>!==<span class="literal">undefined</span>)&#123;<span class="keyword">return</span> currWs.<span class="property">readyState</span>&#125;<span class="keyword">if</span>(currWs.<span class="property">getReadyState</span>)&#123;<span class="keyword">return</span> currWs.<span class="title function_">getReadyState</span>()&#125;<span class="keyword">return</span> <span class="number">0</span>&#125;;<span class="variable language_">window</span>.<span class="property">EportClient</span>=&#123;<span class="attr">isInstalled</span>:<span class="keyword">function</span>(<span class="params">type,callback,currInstalllerUrl</span>)&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> type===<span class="string">&quot;function&quot;</span>)&#123;<span class="keyword">if</span>(callback)&#123;currInstalllerUrl=callback&#125;callback=type;type=<span class="title class_">DefaultType</span>&#125;ws=<span class="title function_">conn</span>();<span class="keyword">var</span> bInstalled=<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">1</span>;<span class="keyword">var</span> retryConut=<span class="number">0</span>;<span class="keyword">function</span> <span class="title function_">retry</span>(<span class="params"></span>)&#123;retryConut++;ws=<span class="title function_">conn</span>();bInstalled=<span class="title function_">getWebSocketReadyState</span>(ws)===<span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>(!bInstalled)&#123;<span class="keyword">if</span>(retryConut&lt;<span class="number">3</span>)&#123;<span class="built_in">setTimeout</span>(retry,<span class="number">1500</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(retryConut===<span class="number">3</span>)&#123;<span class="keyword">var</span> iframeDom=<span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;iframe&quot;</span>);iframeDom.<span class="property">style</span>.<span class="property">cssText</span>=<span class="string">&quot;width:1px;height:1px;position:fixed;top:0;left:0;display:none;&quot;</span>;iframeDom.<span class="property">src</span>=<span class="string">&quot;singlewindow://Restart&quot;</span>;<span class="variable language_">document</span>.<span class="property">body</span>.<span class="title function_">appendChild</span>(iframeDom);<span class="built_in">setTimeout</span>(retry,<span class="number">2500</span>)&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> errMsg=<span class="string">&quot;检测到您未安装&quot;</span>+type+<span class="string">&quot;客户端! &quot;</span>+type+<span class="string">&quot;下载地址为:&quot;</span>+currInstalllerUrl||installlerUrl||<span class="variable language_">window</span>.<span class="property">installlerUrl</span>;<span class="keyword">if</span>(callback)&#123;<span class="title function_">callback</span>(&#123;<span class="string">&quot;Result&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;Data&quot;</span>:[],<span class="string">&quot;Error&quot;</span>:[errMsg]&#125;)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(errMsg)&#125;&#125;&#125;&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">var</span> okMsg=<span class="string">&quot;已经安装了&quot;</span>+type+<span class="string">&quot;客户端.&quot;</span>;<span class="keyword">if</span>(callback)&#123;<span class="title function_">callback</span>(&#123;<span class="string">&quot;Result&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;Data&quot;</span>:[okMsg],<span class="string">&quot;Error&quot;</span>:[]&#125;)&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="variable language_">window</span>.<span class="property">console</span>)&#123;<span class="variable language_">window</span>.<span class="property">console</span>.<span class="title function_">log</span>(okMsg)&#125;&#125;&#125;&#125;<span class="title function_">retry</span>()&#125;,<span class="attr">isInstalledTest</span>:<span class="keyword">function</span>(<span class="params">func,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10</span>)&#123;<span class="keyword">if</span>(!func)&#123;<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;未知的JS的function,请检查调用isInstalledTest传入的第一个参数是否存在该函数.&quot;</span>)&#125;<span class="title class_">EportClient</span>.<span class="title function_">isInstalled</span>(<span class="title class_">DefaultType</span>,<span class="keyword">function</span>(<span class="params">msg</span>)&#123;<span class="keyword">if</span>(msg.<span class="property">Result</span>)&#123;<span class="keyword">if</span>(func&amp;&amp;(<span class="keyword">typeof</span> func)===<span class="string">&quot;function&quot;</span>)&#123;func.<span class="title function_">call</span>(<span class="literal">null</span>,arg1,arg2,arg3,arg4,arg5,arg6,arg7,arg8,arg9,arg10)&#125;<span class="keyword">else</span>&#123;<span class="title function_">alert</span>(msg.<span class="property">Data</span>[<span class="number">0</span>])&#125;&#125;<span class="keyword">else</span>&#123;<span class="title function_">alertErrMsg</span>(msg)&#125;&#125;,installlerUrl||<span class="variable language_">window</span>.<span class="property">installlerUrl</span>)&#125;,<span class="attr">cusSpcSignDataAsPEM</span>:<span class="keyword">function</span>(<span class="params">inData,passwd,callback</span>)&#123;<span class="title function_">baseInvoke</span>(<span class="string">&quot;cus-sec_SpcSignDataAsPEM&quot;</span>,(!!passwd)?&#123;<span class="string">&quot;inData&quot;</span>:inData,<span class="string">&quot;passwd&quot;</span>:passwd&#125;:&#123;<span class="string">&quot;inData&quot;</span>:inData&#125;,callback)&#125;,<span class="attr">swcLogin</span>:<span class="keyword">function</span>(<span class="params">passwd,callback</span>)&#123;<span class="title function_">baseInvoke</span>(<span class="string">&quot;swc_security_login&quot;</span>,&#123;<span class="string">&quot;passwd&quot;</span>:passwd&#125;,callback)&#125;,<span class="attr">swcPostData</span>:<span class="keyword">function</span>(<span class="params">data,callback,method</span>)&#123;<span class="title function_">conn</span>();method=(method||<span class="string">&quot;swc_postdata&quot;</span>);callbacks[method]=callback;<span class="keyword">var</span> _data=&#123;<span class="string">&quot;_method&quot;</span>:method&#125;;_data[<span class="string">&quot;_id&quot;</span>]=id++;<span class="keyword">if</span>(<span class="keyword">typeof</span> data===<span class="string">&quot;object&quot;</span>)&#123;_data[<span class="string">&quot;args&quot;</span>]=<span class="title function_">toJson</span>(data)&#125;<span class="keyword">else</span>&#123;_data[<span class="string">&quot;args&quot;</span>]=data&#125;<span class="keyword">var</span> s=<span class="title function_">toJson</span>(_data);<span class="keyword">var</span> checkCode=<span class="variable constant_">DIGEST</span>.<span class="title class_">CheckCode</span>(s);<span class="keyword">var</span> guid=<span class="title function_">getGuid</span>();<span class="keyword">while</span>(blockData[guid])&#123;guid=<span class="title function_">getGuid</span>()&#125;<span class="keyword">var</span> splitData=<span class="title function_">splitStrData</span>(s);<span class="keyword">if</span>(splitData.<span class="property">length</span>&gt;<span class="number">1</span>)&#123;blockData[guid]=&#123;<span class="attr">checkcode</span>:checkCode,<span class="attr">totalLength</span>:s.<span class="property">length</span>,<span class="attr">retry</span>:<span class="number">0</span>,<span class="attr">block</span>:splitData&#125;&#125;<span class="keyword">var</span> blockCheckCode=<span class="variable constant_">DIGEST</span>.<span class="title class_">CheckCode</span>(splitData[<span class="number">0</span>]);<span class="keyword">var</span> pakHeaser=<span class="title function_">getDataHeader</span>(checkCode,blockCheckCode,s.<span class="property">length</span>,splitData[<span class="number">0</span>].<span class="property">length</span>,splitData.<span class="property">length</span>,guid,<span class="number">0</span>);<span class="keyword">var</span> msg=pakHeaser+splitData[<span class="number">0</span>];<span class="title function_">sendMessage</span>(msg)&#125;,<span class="attr">data</span>:<span class="keyword">function</span>(<span class="params"></span>)&#123;&#125;&#125;;<span class="title class_">EportClient</span>.<span class="property">data</span>.<span class="property"><span class="keyword">prototype</span></span>=&#123;<span class="title class_">Execute</span>:<span class="keyword">function</span>(<span class="params">callback</span>)&#123;<span class="keyword">var</span> d=<span class="title function_">toJson</span>(<span class="variable language_">this</span>);<span class="title class_">EportClient</span>.<span class="title function_">swcPostData</span>(d,callback)&#125;&#125;&#125;)(<span class="variable language_">window</span>,<span class="variable language_">document</span>,navigator);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// json2.js</span></span><br><span class="line"><span class="keyword">if</span>(navigator.<span class="property">appName</span>==<span class="string">&quot;Microsoft Internet Explorer&quot;</span>&amp;&amp;(navigator.<span class="property">appVersion</span>.<span class="title function_">split</span>(<span class="string">&quot;;&quot;</span>)[<span class="number">1</span>].<span class="title function_">replace</span>(<span class="regexp">/[ ]/g</span>,<span class="string">&quot;&quot;</span>)==<span class="string">&quot;MSIE6.0&quot;</span>||navigator.<span class="property">appVersion</span>.<span class="title function_">split</span>(<span class="string">&quot;;&quot;</span>)[<span class="number">1</span>].<span class="title function_">replace</span>(<span class="regexp">/[ ]/g</span>,<span class="string">&quot;&quot;</span>)==<span class="string">&quot;MSIE7.0&quot;</span>||navigator.<span class="property">appVersion</span>.<span class="title function_">split</span>(<span class="string">&quot;;&quot;</span>)[<span class="number">1</span>].<span class="title function_">replace</span>(<span class="regexp">/[ ]/g</span>,<span class="string">&quot;&quot;</span>)==<span class="string">&quot;MSIE8.0&quot;</span>||navigator.<span class="property">appVersion</span>.<span class="title function_">split</span>(<span class="string">&quot;;&quot;</span>)[<span class="number">1</span>].<span class="title function_">replace</span>(<span class="regexp">/[ ]/g</span>,<span class="string">&quot;&quot;</span>)==<span class="string">&quot;MSIE9.0&quot;</span>))&#123;<span class="title class_">JSON</span>=&#123;&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="title class_">JSON</span>!==<span class="string">&quot;object&quot;</span>)&#123;<span class="title class_">JSON</span>=&#123;&#125;&#125;&#125;(<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">var</span> rx_one=<span class="regexp">/^[\],:&#123;&#125;\s]*$/</span>;<span class="keyword">var</span> rx_two=<span class="regexp">/\\(?:[&quot;\\\/bfnrt]|u[0-9a-fA-F]&#123;4&#125;)/g</span>;<span class="keyword">var</span> rx_three=<span class="regexp">/&quot;[^&quot;\\\n\r]*&quot;|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g</span>;<span class="keyword">var</span> rx_four=<span class="regexp">/(?:^|:|,)(?:\s*\[)+/g</span>;<span class="keyword">var</span> rx_escapable=<span class="regexp">/[\\&quot;\u0000-\u001f\u007f-\u009f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g</span>;<span class="keyword">var</span> rx_dangerous=<span class="regexp">/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g</span>;<span class="keyword">function</span> <span class="title function_">f</span>(<span class="params">n</span>)&#123;<span class="keyword">return</span>(n&lt;<span class="number">10</span>)?<span class="string">&quot;0&quot;</span>+<span class="attr">n</span>:n&#125;<span class="keyword">function</span> <span class="title function_">this_value</span>(<span class="params"></span>)&#123;<span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">valueOf</span>()&#125;<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="title class_">Date</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toJSON</span>!==<span class="string">&quot;function&quot;</span>)&#123;<span class="title class_">Date</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toJSON</span>=<span class="keyword">function</span>(<span class="params"></span>)&#123;<span class="keyword">return</span> <span class="built_in">isFinite</span>(<span class="variable language_">this</span>.<span class="title function_">valueOf</span>())?(<span class="variable language_">this</span>.<span class="title function_">getUTCFullYear</span>()+<span class="string">&quot;-&quot;</span>+<span class="title function_">f</span>(<span class="variable language_">this</span>.<span class="title function_">getUTCMonth</span>()+<span class="number">1</span>)+<span class="string">&quot;-&quot;</span>+<span class="title function_">f</span>(<span class="variable language_">this</span>.<span class="title function_">getUTCDate</span>())+<span class="string">&quot;T&quot;</span>+<span class="title function_">f</span>(<span class="variable language_">this</span>.<span class="title function_">getUTCHours</span>())+<span class="string">&quot;:&quot;</span>+<span class="title function_">f</span>(<span class="variable language_">this</span>.<span class="title function_">getUTCMinutes</span>())+<span class="string">&quot;:&quot;</span>+<span class="title function_">f</span>(<span class="variable language_">this</span>.<span class="title function_">getUTCSeconds</span>())+<span class="string">&quot;Z&quot;</span>):<span class="literal">null</span>&#125;;<span class="title class_">Boolean</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toJSON</span>=this_value;<span class="title class_">Number</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toJSON</span>=this_value;<span class="title class_">String</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toJSON</span>=this_value&#125;<span class="keyword">var</span> gap;<span class="keyword">var</span> indent;<span class="keyword">var</span> meta;<span class="keyword">var</span> rep;<span class="keyword">function</span> <span class="title function_">quote</span>(<span class="params">string</span>)&#123;rx_escapable.<span class="property">lastIndex</span>=<span class="number">0</span>;<span class="keyword">return</span> rx_escapable.<span class="title function_">test</span>(string)?<span class="string">&#x27;&quot;&#x27;</span>+string.<span class="title function_">replace</span>(rx_escapable,<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">var</span> c=meta[a];<span class="keyword">return</span> <span class="keyword">typeof</span> c===<span class="string">&quot;string&quot;</span>?<span class="attr">c</span>:<span class="string">&quot;\\u&quot;</span>+(<span class="string">&quot;0000&quot;</span>+a.<span class="title function_">charCodeAt</span>(<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">slice</span>(-<span class="number">4</span>)&#125;)+<span class="string">&#x27;&quot;&#x27;</span>:<span class="string">&#x27;&quot;&#x27;</span>+string+<span class="string">&#x27;&quot;&#x27;</span>&#125;<span class="keyword">function</span> <span class="title function_">str</span>(<span class="params">key,holder</span>)&#123;<span class="keyword">var</span> i;<span class="keyword">var</span> k;<span class="keyword">var</span> v;<span class="keyword">var</span> length;<span class="keyword">var</span> mind=gap;<span class="keyword">var</span> partial;<span class="keyword">var</span> value=holder[key];<span class="keyword">if</span>(value&amp;&amp;<span class="keyword">typeof</span> value===<span class="string">&quot;object&quot;</span>&amp;&amp;<span class="keyword">typeof</span> value.<span class="property">toJSON</span>===<span class="string">&quot;function&quot;</span>)&#123;value=value.<span class="title function_">toJSON</span>(key)&#125;<span class="keyword">if</span>(<span class="keyword">typeof</span> rep===<span class="string">&quot;function&quot;</span>)&#123;value=rep.<span class="title function_">call</span>(holder,key,value)&#125;<span class="keyword">switch</span>(<span class="keyword">typeof</span> value)&#123;<span class="keyword">case</span><span class="string">&quot;string&quot;</span>:<span class="keyword">return</span> <span class="title function_">quote</span>(value);<span class="keyword">case</span><span class="string">&quot;number&quot;</span>:<span class="keyword">return</span>(<span class="built_in">isFinite</span>(value))?<span class="title class_">String</span>(value):<span class="string">&quot;null&quot;</span>;<span class="keyword">case</span><span class="string">&quot;boolean&quot;</span>:<span class="keyword">case</span><span class="string">&quot;null&quot;</span>:<span class="keyword">return</span> <span class="title class_">String</span>(value);<span class="keyword">case</span><span class="string">&quot;object&quot;</span>:<span class="keyword">if</span>(!value)&#123;<span class="keyword">return</span><span class="string">&quot;null&quot;</span>&#125;gap+=indent;partial=[];<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">toString</span>.<span class="title function_">apply</span>(value)===<span class="string">&quot;[object Array]&quot;</span>)&#123;length=value.<span class="property">length</span>;<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;length;i+=<span class="number">1</span>)&#123;partial[i]=<span class="title function_">str</span>(i,value)||<span class="string">&quot;null&quot;</span>&#125;v=partial.<span class="property">length</span>===<span class="number">0</span>?<span class="string">&quot;[]&quot;</span>:gap?(<span class="string">&quot;[\n&quot;</span>+gap+partial.<span class="title function_">join</span>(<span class="string">&quot;,\n&quot;</span>+gap)+<span class="string">&quot;\n&quot;</span>+mind+<span class="string">&quot;]&quot;</span>):<span class="string">&quot;[&quot;</span>+partial.<span class="title function_">join</span>(<span class="string">&quot;,&quot;</span>)+<span class="string">&quot;]&quot;</span>;gap=mind;<span class="keyword">return</span> v&#125;<span class="keyword">if</span>(rep&amp;&amp;<span class="keyword">typeof</span> rep===<span class="string">&quot;object&quot;</span>)&#123;length=rep.<span class="property">length</span>;<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;length;i+=<span class="number">1</span>)&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> rep[i]===<span class="string">&quot;string&quot;</span>)&#123;k=rep[i];v=<span class="title function_">str</span>(k,value);<span class="keyword">if</span>(v)&#123;partial.<span class="title function_">push</span>(<span class="title function_">quote</span>(k)+((gap)?<span class="string">&quot;: &quot;</span>:<span class="string">&quot;:&quot;</span>)+v)&#125;&#125;&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">for</span>(k <span class="keyword">in</span> value)&#123;<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(value,k))&#123;v=<span class="title function_">str</span>(k,value);<span class="keyword">if</span>(v)&#123;partial.<span class="title function_">push</span>(<span class="title function_">quote</span>(k)+((gap)?<span class="string">&quot;: &quot;</span>:<span class="string">&quot;:&quot;</span>)+v)&#125;&#125;&#125;&#125;v=partial.<span class="property">length</span>===<span class="number">0</span>?<span class="string">&quot;&#123;&#125;&quot;</span>:gap?<span class="string">&quot;&#123;\n&quot;</span>+gap+partial.<span class="title function_">join</span>(<span class="string">&quot;,\n&quot;</span>+gap)+<span class="string">&quot;\n&quot;</span>+mind+<span class="string">&quot;&#125;&quot;</span>:<span class="string">&quot;&#123;&quot;</span>+partial.<span class="title function_">join</span>(<span class="string">&quot;,&quot;</span>)+<span class="string">&quot;&#125;&quot;</span>;gap=mind;<span class="keyword">return</span> v&#125;&#125;<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="title class_">JSON</span>.<span class="property">stringify</span>!==<span class="string">&quot;function&quot;</span>)&#123;meta=&#123;<span class="string">&quot;\b&quot;</span>:<span class="string">&quot;\\b&quot;</span>,<span class="string">&quot;\t&quot;</span>:<span class="string">&quot;\\t&quot;</span>,<span class="string">&quot;\n&quot;</span>:<span class="string">&quot;\\n&quot;</span>,<span class="string">&quot;\f&quot;</span>:<span class="string">&quot;\\f&quot;</span>,<span class="string">&quot;\r&quot;</span>:<span class="string">&quot;\\r&quot;</span>,<span class="string">&#x27;&quot;&#x27;</span>:<span class="string">&#x27;\\&quot;&#x27;</span>,<span class="string">&quot;\\&quot;</span>:<span class="string">&quot;\\\\&quot;</span>&#125;;<span class="title class_">JSON</span>.<span class="property">stringify</span>=<span class="keyword">function</span>(<span class="params">value,replacer,space</span>)&#123;<span class="keyword">var</span> i;gap=<span class="string">&quot;&quot;</span>;indent=<span class="string">&quot;&quot;</span>;<span class="keyword">if</span>(<span class="keyword">typeof</span> space===<span class="string">&quot;number&quot;</span>)&#123;<span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;space;i+=<span class="number">1</span>)&#123;indent+=<span class="string">&quot; &quot;</span>&#125;&#125;<span class="keyword">else</span>&#123;<span class="keyword">if</span>(<span class="keyword">typeof</span> space===<span class="string">&quot;string&quot;</span>)&#123;indent=space&#125;&#125;rep=replacer;<span class="keyword">if</span>(replacer&amp;&amp;<span class="keyword">typeof</span> replacer!==<span class="string">&quot;function&quot;</span>&amp;&amp;(<span class="keyword">typeof</span> replacer!==<span class="string">&quot;object&quot;</span>||<span class="keyword">typeof</span> replacer.<span class="property">length</span>!==<span class="string">&quot;number&quot;</span>))&#123;<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;JSON.stringify&quot;</span>)&#125;<span class="keyword">return</span> <span class="title function_">str</span>(<span class="string">&quot;&quot;</span>,&#123;<span class="string">&quot;&quot;</span>:value&#125;)&#125;&#125;<span class="keyword">if</span>(<span class="keyword">typeof</span> <span class="title class_">JSON</span>.<span class="property">parse</span>!==<span class="string">&quot;function&quot;</span>)&#123;<span class="title class_">JSON</span>.<span class="property">parse</span>=<span class="keyword">function</span>(<span class="params">text,reviver</span>)&#123;<span class="keyword">var</span> j;<span class="keyword">function</span> <span class="title function_">walk</span>(<span class="params">holder,key</span>)&#123;<span class="keyword">var</span> k;<span class="keyword">var</span> v;<span class="keyword">var</span> value=holder[key];<span class="keyword">if</span>(value&amp;&amp;<span class="keyword">typeof</span> value===<span class="string">&quot;object&quot;</span>)&#123;<span class="keyword">for</span>(k <span class="keyword">in</span> value)&#123;<span class="keyword">if</span>(<span class="title class_">Object</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">hasOwnProperty</span>.<span class="title function_">call</span>(value,k))&#123;v=<span class="title function_">walk</span>(value,k);<span class="keyword">if</span>(v!==<span class="literal">undefined</span>)&#123;value[k]=v&#125;<span class="keyword">else</span>&#123;<span class="keyword">delete</span> value[k]&#125;&#125;&#125;&#125;<span class="keyword">return</span> reviver.<span class="title function_">call</span>(holder,key,value)&#125;text=<span class="title class_">String</span>(text);rx_dangerous.<span class="property">lastIndex</span>=<span class="number">0</span>;<span class="keyword">if</span>(rx_dangerous.<span class="title function_">test</span>(text))&#123;text=text.<span class="title function_">replace</span>(rx_dangerous,<span class="keyword">function</span>(<span class="params">a</span>)&#123;<span class="keyword">return</span>(<span class="string">&quot;\\u&quot;</span>+(<span class="string">&quot;0000&quot;</span>+a.<span class="title function_">charCodeAt</span>(<span class="number">0</span>).<span class="title function_">toString</span>(<span class="number">16</span>)).<span class="title function_">slice</span>(-<span class="number">4</span>))&#125;)&#125;<span class="keyword">if</span>(rx_one.<span class="title function_">test</span>(text.<span class="title function_">replace</span>(rx_two,<span class="string">&quot;@&quot;</span>).<span class="title function_">replace</span>(rx_three,<span class="string">&quot;]&quot;</span>).<span class="title function_">replace</span>(rx_four,<span class="string">&quot;&quot;</span>)))&#123;j=<span class="built_in">eval</span>(<span class="string">&quot;(&quot;</span>+text+<span class="string">&quot;)&quot;</span>);<span class="keyword">return</span>(<span class="keyword">typeof</span> reviver===<span class="string">&quot;function&quot;</span>)?<span class="title function_">walk</span>(&#123;<span class="string">&quot;&quot;</span>:j&#125;,<span class="string">&quot;&quot;</span>):j&#125;<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SyntaxError</span>(<span class="string">&quot;JSON.parse&quot;</span>)&#125;&#125;&#125;());</span><br></pre></td></tr></table></figure>

<p>复制下面的加签原文, 应该就是将几个<code>json</code>字符串, 用<code>||</code>连接起来.<br>这些字段在<a href="http://www.customs.gov.cn/customs/302249/302266/302267/2134975/index.html">海关总署公告2018年第165号（关于实时获取跨境电子商务平台企业支付相关原始数据有关事宜的公告）</a>文件中有详细说明, 但是我们做测试随便填数据就行了.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">&quot;sessionID&quot;:&quot;ad2254-8hewyf32-556162449&quot;||&quot;payExchangeInfoHead&quot;:&quot;&#123;&quot;guid&quot;:&quot;9D55BA71-22DE-41F4-8B50-C36C83B3B530&quot;,&quot;initalRequest&quot;:&quot;原始请求&quot;,&quot;initalResponse&quot;:&quot;原始响应&quot;,&quot;ebpCode&quot;:&quot;4403169BVN&quot;,&quot;payCode&quot;:&quot;4403169D3W&quot;,&quot;payTransactionId&quot;:&quot;2018121222001354081010726129&quot;,&quot;totalAmount&quot;:100,&quot;currency&quot;:&quot;CNY&quot;,&quot;verDept&quot;:&quot;3&quot;,&quot;payType&quot;:&quot;1&quot;,&quot;tradingTime&quot;:&quot;20181212041803&quot;,&quot;note&quot;:&quot;批量订单，测试订单优化,生成多个so订单&quot;&#125;&quot;||&quot;payExchangeInfoLists&quot;:&quot;[&#123;&quot;orderNo&quot;:&quot;SO1710301150602574003&quot;,&quot;goodsInfo&quot;:[&#123;&quot;gname&quot;:&quot;lhy-gnsku2&quot;,&quot;itemLink&quot;:&quot;http://m.yunjiweidian.com/yunjibuyer/static/vue-buyer/idc/index.html#/detail?itemId=999760&amp;shopId=453&quot;&#125;],&quot;recpAccount&quot;:&quot;1234567&quot;,&quot;recpCode&quot;:&quot;7654321&quot;,&quot;recpName&quot;:&quot;我的公司&quot;&#125;]&quot;||&quot;serviceTime&quot;:&quot;1544519952469&quot;</span><br></pre></td></tr></table></figure>
<p>修改部分字段.</p>
<ol>
<li><code>ebpCode</code>: 你司的电商平台代码</li>
<li><code>payCode</code>: 支付企业的海关注册码, 如<a href="https://pay.weixin.qq.com/wiki/doc/api/external/declarecustom.php?chapter=18_1">微信支付</a>的<code>4403169D3W</code></li>
</ol>
<p>然后粘贴到上面<code>html</code>进行<strong>手动加签</strong>, 得到以下数据</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">&#123;&quot;Result&quot;:true,&quot;Data&quot;:[&quot;BsA3cCpwsaYrFlwgkjccUGpPBNGni7CiP6F5SmCY8OWxw4xd1kwLWKwR69tSQHSmHmT2O07KYvzj5/N0NkWvoTvyNolQ822/jDTAMcrBPmv5xtu3FHEDYgdkB4sfdeu7EdyVeDWyMEPkT1n/7h80kxKerJzjQAB6HrxPSgLJ+MQ=&quot;,&quot;01304235&quot;],&quot;Error&quot;:[]&#125;</span><br></pre></td></tr></table></figure>
<p><code>Data</code>字段里第一个就是签名, 第二个是证书编号<br>然后将签名和证书编号复制, 拼接成以下<code>JSON</code></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">&#123;&quot;sessionID&quot;:&quot;ad2254-8hewyf32-556162449&quot;,&quot;payExchangeInfoHead&quot;:&#123;&quot;guid&quot;:&quot;9D55BA71-22DE-41F4-8B50-C36C83B3B530&quot;,&quot;initalRequest&quot;:&quot;原始请求&quot;,&quot;initalResponse&quot;:&quot;原始响应&quot;,&quot;ebpCode&quot;:&quot;4403169BVN&quot;,&quot;payCode&quot;:&quot;4403169D3W&quot;,&quot;payTransactionId&quot;:&quot;2018121222001354081010726129&quot;,&quot;totalAmount&quot;:100,&quot;currency&quot;:&quot;CNY&quot;,&quot;verDept&quot;:&quot;3&quot;,&quot;payType&quot;:&quot;1&quot;,&quot;tradingTime&quot;:&quot;20181212041803&quot;,&quot;note&quot;:&quot;批量订单，测试订单优化,生成多个so订单&quot;&#125;,&quot;payExchangeInfoLists&quot;:[&#123;&quot;orderNo&quot;:&quot;SO1710301150602574003&quot;,&quot;goodsInfo&quot;:[&#123;&quot;gname&quot;:&quot;lhy-gnsku2&quot;,&quot;itemLink&quot;:&quot;http://m.yunjiweidian.com/yunjibuyer/static/vue-buyer/idc/index.html#/detail?itemId=999760&amp;shopId=453&quot;&#125;],&quot;recpAccount&quot;:&quot;1234567&quot;,&quot;recpCode&quot;:&quot;7654321&quot;,&quot;recpName&quot;:&quot;我的公司&quot;&#125;],&quot;serviceTime&quot;:&quot;1544519952469&quot;,&quot;certNo&quot;:&quot;01304235&quot;,&quot;signValue&quot;:&quot;VRx4eIXfQWItQNiJEkINMWKXMrjVGDFP/HkzqzZ7r+7IJcFK+pcHqZf+IS0PiIz29I2IsXXhV1Tg+3Tlq0fz4UjfsyPE1vEgqA51q3S/fGv4B1MlzS5KG1ETyB+FZaZegUQchK4vl4QGuSJqyi4QJ8b/eCa75KOyyNRm+wUsQtg=&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>然后发送给海关测试接口, 这里使用<code>OKHttp</code>做客户端.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">json</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;sessionID\&quot;:\&quot;ad2254-8hewyf32-556162449\&quot;,\&quot;payExchangeInfoHead\&quot;:&#123;\&quot;guid\&quot;:\&quot;9D55BA71-22DE-41F4-8B50-C36C83B3B530\&quot;,\&quot;initalRequest\&quot;:\&quot;原始请求\&quot;,\&quot;initalResponse\&quot;:\&quot;原始响应\&quot;,\&quot;ebpCode\&quot;:\&quot;4403169BVN\&quot;,\&quot;payCode\&quot;:\&quot;4403169D3W\&quot;,\&quot;payTransactionId\&quot;:\&quot;2018121222001354081010726129\&quot;,\&quot;totalAmount\&quot;:100,\&quot;currency\&quot;:\&quot;CNY\&quot;,\&quot;verDept\&quot;:\&quot;3\&quot;,\&quot;payType\&quot;:\&quot;1\&quot;,\&quot;tradingTime\&quot;:\&quot;20181212041803\&quot;,\&quot;note\&quot;:\&quot;批量订单，测试订单优化,生成多个so订单\&quot;&#125;,\&quot;payExchangeInfoLists\&quot;:[&#123;\&quot;orderNo\&quot;:\&quot;SO1710301150602574003\&quot;,\&quot;goodsInfo\&quot;:[&#123;\&quot;gname\&quot;:\&quot;lhy-gnsku2\&quot;,\&quot;itemLink\&quot;:\&quot;http://m.yunjiweidian.com/yunjibuyer/static/vue-buyer/idc/index.html#/detail?itemId=999760&amp;shopId=453\&quot;&#125;],\&quot;recpAccount\&quot;:\&quot;1234567\&quot;,\&quot;recpCode\&quot;:\&quot;7654321\&quot;,\&quot;recpName\&quot;:\&quot;我的公司\&quot;&#125;],\&quot;serviceTime\&quot;:\&quot;1544519952469\&quot;,\&quot;certNo\&quot;:\&quot;01304235\&quot;,\&quot;signValue\&quot;:\&quot;VRx4eIXfQWItQNiJEkINMWKXMrjVGDFP/HkzqzZ7r+7IJcFK+pcHqZf+IS0PiIz29I2IsXXhV1Tg+3Tlq0fz4UjfsyPE1vEgqA51q3S/fGv4B1MlzS5KG1ETyB+FZaZegUQchK4vl4QGuSJqyi4QJ8b/eCa75KOyyNRm+wUsQtg=\&quot;&#125;\n&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encode</span> <span class="operator">=</span> URLEncoder.encode(json, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="type">OkHttpClient</span> <span class="variable">client</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">OkHttpClient</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="type">MediaType</span> <span class="variable">mediaType</span> <span class="operator">=</span> MediaType.parse(<span class="string">&quot;application/x-www-form-urlencoded&quot;</span>);</span><br><span class="line">        <span class="type">RequestBody</span> <span class="variable">body</span> <span class="operator">=</span> RequestBody.create(mediaType, <span class="string">&quot;payExInfoStr=&quot;</span>+encode);</span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Request</span>.Builder()</span><br><span class="line">              .url(<span class="string">&quot;https://swapptest.singlewindow.cn/ceb2grab/grab/realTimeDataUpload&quot;</span>)</span><br><span class="line">              .post(body)</span><br><span class="line">              .addHeader(<span class="string">&quot;Content-Type&quot;</span>, <span class="string">&quot;application/x-www-form-urlencoded&quot;</span>)</span><br><span class="line">              .build();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> client.newCall(request).execute();</span><br><span class="line">        System.out.println(response.body().string());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果返回<strong>上传成功</strong>, 那就说明验签通过了.</p>
<h2 id="上传失败-入库失败-java-sql-SQLException-ORA-00001-违反唯一约束条件-sessionID重复"><a href="#上传失败-入库失败-java-sql-SQLException-ORA-00001-违反唯一约束条件-sessionID重复" class="headerlink" title="上传失败,入库失败 java.sql.SQLException: ORA-00001: 违反唯一约束条件 (sessionID重复)"></a>上传失败,入库失败 java.sql.SQLException: ORA-00001: 违反唯一约束条件 (sessionID重复)</h2><p>这个只需要把<code>sessionID</code>随便改一下, 比如改成<code>ad2254-8hewyf32-556162450</code>, 然后重新加签即可.<br>海关没做校验, 应该就是给数据库加了个唯一索引.</p>
<h2 id="企业实时数据获取验签证书未在服务系统注册"><a href="#企业实时数据获取验签证书未在服务系统注册" class="headerlink" title="企业实时数据获取验签证书未在服务系统注册"></a>企业实时数据获取验签证书未在服务系统注册</h2><p>修改上面提到的<code>ebpCode</code>和<code>payCode</code>以及<strong>证书编号</strong>.<br>并确保<strong>证书编号</strong>小写.<br>再不行, 在海关微信联调群问.</p>
<h2 id="验签失败"><a href="#验签失败" class="headerlink" title="验签失败"></a>验签失败</h2><p>海关的验签规则很严格, 每个字段顺序都有要求, 错一个字符, 多一个<code>\n</code>都会导致验签失败.<br>因为加签原文和上传<code>JSON</code>是两种不同的数据类型, 所以耐心一个字符一个字符地对比.<br>特别是换行符<code>\n</code>这种不可见字符, 卡了我几个钟.</p>
<p>这种问题就不用去海关微信联调群问了, 肯定是自己问题.</p>
<h1 id="注册线上环境"><a href="#注册线上环境" class="headerlink" title="注册线上环境"></a>注册线上环境</h1><p>插入<strong>操作员卡</strong>后, 注意, 一定要<strong>操作员卡</strong>.<br>打开<a href="https://swapp.singlewindow.cn/deskserver/sw/deskIndex?menu_id=swcebimp">中国国际贸易单一窗口</a></p>
<img data-src="/images/%E6%B5%B7%E5%85%B3%E8%B7%A8%E5%A2%83%E7%94%B3%E6%8A%A5%E6%B5%81%E7%A8%8B165%E5%8F%B7%E5%92%8C179%E5%8F%B7%E6%96%87%E6%A1%A3_01.png" class="">
<p>需要确保电商平台代码和电商平台名称这两个灰色的框框是有值的, 没有则去找海关企管科注册电商平台权限, 具体打海关电话<code>010-65194114</code>咨询.</p>
<p>还记得我们之前提供给海关的证书吗? 点击选择证书, 上传了. 证书编号记得小写.<br>之后就是注册服务地址, 填入<code>http://你的域名/项目前缀/platDataOpen</code>, 点击注册地址, 然后肯定注册失败的. 这个之后处理.</p>
<p>值得注意的是, 这个服务注册地址可以注册多个, 审核通过多个, 但是最终<strong>启用</strong>的只能有一个. </p>
<h1 id="配置实体加签主机"><a href="#配置实体加签主机" class="headerlink" title="配置实体加签主机"></a>配置实体加签主机</h1><p>有的企业是全部云主机, 会问能不能不要这个实体主机, 不可以, 因为我司现在也是全部云主机, 还是妥协弄了个实体主机.<br>我司用的是<code>Windows Server 2012 R2</code>.</p>
<p>和注册测试环境的步骤一样<br>值得注意的是, 一定要先手动安装<code>.net framework 3.5</code>, 一定要先手动安装<code>.net framework 3.5</code>.<br>否则海关提供的客户端安装程序可能会出现打不开的情况.</p>
<p>主要步骤就是</p>
<ol>
<li>安装<code>.net framework 3.5</code></li>
<li>安装海关提供的客户端</li>
<li>开放实体加签主机的<code>61231</code>和<code>61232</code>端口.</li>
<li>修改上面提供的<code>client.js</code>中的<code>ws://127.0.0.1:61232</code>为实体加签主机的外网<code>IP</code>.</li>
<li>在外网使用<code>html</code>进行加签.</li>
</ol>
<h1 id="编写-platDataOpen-逻辑"><a href="#编写-platDataOpen-逻辑" class="headerlink" title="编写 /platDataOpen 逻辑"></a>编写 /platDataOpen 逻辑</h1><p>我们之前注册了<code>http://你的域名/项目前缀/platDataOpen</code>地址, 但是没有实现这个接口.<br>下面是一个简单的例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(value=&quot;/platDataOpen&quot; , headers=&quot;content-type=application/x-www-form-urlencoded&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">platDataOpen</span><span class="params">(<span class="meta">@RequestParam</span> String openReq)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取请求参数</span></span><br><span class="line">        openReq = StringUtils.replace(openReq, <span class="string">&quot;&amp;quot;&quot;</span>, <span class="string">&quot;\&quot;&quot;</span>);</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> JSONObject.parseObject(openReq);</span><br><span class="line">        <span class="type">String</span> <span class="variable">orderNo</span> <span class="operator">=</span> json.getString(<span class="string">&quot;orderNo&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionID</span> <span class="operator">=</span> json.getString(<span class="string">&quot;sessionID&quot;</span>);</span><br><span class="line">        <span class="type">Long</span> <span class="variable">serviceTime</span> <span class="operator">=</span> json.getLong(<span class="string">&quot;serviceTime&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 海关调用此接口, 返回特定格式的json数据</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 上报海关, 这里是异步操作 @Async</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">testUrl</span>      <span class="operator">=</span> <span class="string">&quot;https://swapptest.singlewindow.cn/ceb2grab/grab/realTimeDataUpload&quot;</span>;</span><br><span class="line"><span class="comment">//        String onlineUrl    = &quot;https://customs.chinaport.gov.cn/ceb2grab/grab/realTimeDataUpload&quot;;</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">websocketUrl</span> <span class="operator">=</span> <span class="string">&quot;ws://127.0.0.1:61232&quot;</span>;</span><br><span class="line">        myservice.uploadCustomsDeclare(testUrl, websocketUrl, orderNo, sessionID, serviceTime);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 返回数据</span></span><br><span class="line">        result.put(<span class="string">&quot;code&quot;</span>, <span class="string">&quot;10000&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;serviceTime&quot;</span>, System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里是一个简单的例子, 具体的业务逻辑在<code>uploadCustomsDeclare</code>方法里, 不同公司的底层业务逻辑不同.<br>反正关键点就是</p>
<ol>
<li>异步, 用线程池或者队列都行, 但是必须要在<strong>两分钟</strong>内上传完毕.</li>
<li>根据海关传过来的订单, 查询海关需要的数据, 然后写个<code>WebSocket</code>客户端加签, 再上传数据到海关的接口.</li>
<li>海关加签<code>WebSocket</code>客户端的接收的数据和发送的数据的<strong>数据格式</strong>是固定的<code>JSON</code>格式.</li>
</ol>
<p>这里提供一个简单的依赖于<a href="https://mvnrepository.com/artifact/org.java-websocket/Java-WebSocket"><code>Java-WebSocket</code></a>的<code>WebSocket</code>客户端.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> 业务代码() <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 初始化 WebSocket 客户端, 注意这里是异步回调</span></span><br><span class="line">        <span class="type">WebSocketClient</span> <span class="variable">client</span> <span class="operator">=</span> getWebSocketClient(<span class="keyword">new</span> <span class="title class_">URI</span>(<span class="string">&quot;ws://127.0.0.1:61232&quot;</span>), message -&gt; &#123;</span><br><span class="line">            <span class="comment">// 3. 异步回调, 解析响应体</span></span><br><span class="line">            <span class="comment">//    &#123;&quot;_id&quot;:0,&quot;_method&quot;:&quot;cus-sec_SpcSignDataAsPEM&quot;,&quot;_status&quot;:&quot;00&quot;,&quot;_args&quot;:&#123;&quot;Result&quot;:true,&quot;Data&quot;:[&quot;rgTtbpFAmxQ+3mMEaIcztj4zV3SMJ0Jo09HnAE8b+GwxuHYqgcfqEGj/DB+Vb6A8ETXtLMsHGEvsItSm+fDlwOXPPjvpoG5sDeiQXBV4qcGPnLUaDZmdSTJdhRHUn1xFMBCvzP77h2x8RRow8l2ZIyVujY/H0hxZ/flUVERsD8I=&quot;,&quot;01304235&quot;],&quot;Error&quot;:[]&#125;&#125;</span></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">responseJSON</span> <span class="operator">=</span> JSONObject.parseObject(message);</span><br><span class="line">            <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> responseJSON.getString(<span class="string">&quot;_method&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!<span class="string">&quot;cus-sec_SpcSignDataAsPEM&quot;</span>.equalsIgnoreCase(method)) &#123;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 如果不是加签代码, 不处理</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">args</span> <span class="operator">=</span> responseJSON.getJSONObject(<span class="string">&quot;_args&quot;</span>);</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> args.getBooleanValue(<span class="string">&quot;Result&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span>(!result) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> args.getJSONArray(<span class="string">&quot;Error&quot;</span>).toJSONString();</span><br><span class="line">                logger.info(<span class="string">&quot;==============WebSocket连接错误:&#123;&#125;==============&quot;</span>, error);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 获取签名和证书编号</span></span><br><span class="line">            <span class="type">JSONArray</span> <span class="variable">wsData</span> <span class="operator">=</span> args.getJSONArray(<span class="string">&quot;Data&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">signValue</span> <span class="operator">=</span> wsData.getString(<span class="number">0</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">certNo</span> <span class="operator">=</span> wsData.getString(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 初始化请求体上报海关</span></span><br><span class="line">            <span class="comment">// doPost(...);</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">if</span>(client == <span class="literal">null</span>) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;Websocket客户端获取失败!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 连接上后, 发送 Websocket 请求</span></span><br><span class="line"><span class="comment">//            String json = &quot;&#123;\&quot;_method\&quot;:\&quot;cus-sec_SpcSignDataAsPEM\&quot;,\&quot;_id\&quot;:0,\&quot;args\&quot;:&#123;\&quot;inData\&quot;:\&quot;123\&quot;,\&quot;passwd\&quot;:\&quot;88888888\&quot;&#125;&#125;&quot;;</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">websocketRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        websocketRequest.put(<span class="string">&quot;_method&quot;</span>, <span class="string">&quot;cus-sec_SpcSignDataAsPEM&quot;</span>); <span class="comment">// 加签方法</span></span><br><span class="line">        websocketRequest.put(<span class="string">&quot;_id&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">websocketRequestArgs</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        <span class="type">String</span> <span class="variable">inData</span> <span class="operator">=</span> <span class="string">&quot;\&quot;sessionID\&quot;:\&quot;&quot;</span> + sessionID + <span class="string">&quot;\&quot;||&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;payExchangeInfoHead\&quot;:\&quot;&quot;</span> + JSONObject.toJSONString(payExchangeInfoHead) + <span class="string">&quot;\&quot;||&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;payExchangeInfoLists\&quot;:\&quot;&quot;</span> + JSONArray.toJSONString(payExchangeInfoList) + <span class="string">&quot;\&quot;||&quot;</span> +</span><br><span class="line">                <span class="string">&quot;\&quot;serviceTime\&quot;:\&quot;&quot;</span> + JSONObject.toJSONString(serviceTime) + <span class="string">&quot;\&quot;&quot;</span>;</span><br><span class="line">        websocketRequestArgs.put(<span class="string">&quot;inData&quot;</span>, inData);</span><br><span class="line">        websocketRequestArgs.put(<span class="string">&quot;passwd&quot;</span>, <span class="string">&quot;88888888&quot;</span>);</span><br><span class="line">        websocketRequest.put(<span class="string">&quot;args&quot;</span>, websocketRequestArgs);</span><br><span class="line"></span><br><span class="line">        client.send(websocketRequest.toString());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取 Websocket 客户端</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> websocketUrl Websocket 连接地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> callback     回调函数接口</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> WebSocketClient <span class="title function_">getWebSocketClient</span><span class="params">(URI websocketUrl, WebsocketCallback callback)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 双重锁保证, 检查是否超时关闭</span></span><br><span class="line">        <span class="keyword">if</span>(webSocketClient == <span class="literal">null</span> || webSocketClient.isClosed() || webSocketClient.isClosing()) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (CustomsDeclareServiceImpl.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(webSocketClient == <span class="literal">null</span> || webSocketClient.isClosed() || webSocketClient.isClosing()) &#123;</span><br><span class="line">                    <span class="comment">// 2. 初始化 Websocket 客户端, 调用 callback</span></span><br><span class="line">                    webSocketClient = <span class="keyword">new</span> <span class="title class_">WebSocketClient</span>(websocketUrl) &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(ServerHandshake handshakedata)</span> &#123;</span><br><span class="line">                            logger.info(<span class="string">&quot;==============打开WebSocket连接:&#123;&#125;==============&quot;</span>, websocketUrl.toString());</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span> &#123;</span><br><span class="line">                            callback.onMessage(message); <span class="comment">// 调用回调函数</span></span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(ByteBuffer bytes)</span> &#123;</span><br><span class="line">                            <span class="type">String</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes.array(), StandardCharsets.UTF_8);</span><br><span class="line">                            onMessage(message);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(<span class="type">int</span> code, String reason, <span class="type">boolean</span> remote)</span> &#123;</span><br><span class="line">                            logger.info(<span class="string">&quot;==============关闭WebSocket连接:&#123;&#125;==============&quot;</span>, reason);</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Exception ex)</span> &#123;</span><br><span class="line">                            logger.info(<span class="string">&quot;==============WebSocket连接错误:&#123;&#125;==============&quot;</span>, ex.getMessage());</span><br><span class="line">                            logger.error(<span class="string">&quot;==============WebSocket连接错误!==============&quot;</span>, ex);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;;</span><br><span class="line">                    <span class="comment">// 3. 阻塞等待连接</span></span><br><span class="line">                    webSocketClient.connect();</span><br><span class="line">                    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                    <span class="keyword">while</span> (!Objects.equal(webSocketClient.getReadyState(), ReadyState.OPEN)) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            count += <span class="number">10</span>;</span><br><span class="line">                            Thread.sleep(<span class="number">10</span>);</span><br><span class="line">                            TimeUnit.MILLISECONDS.sleep(<span class="number">10</span>);</span><br><span class="line">                            <span class="keyword">if</span> (count &gt;= <span class="number">3</span> * <span class="number">60</span> * <span class="number">1000</span>) &#123;</span><br><span class="line">                                logger.info(<span class="string">&quot;WebSocket服务器连接超时或服务器已经关闭&quot;</span>);</span><br><span class="line">                                webSocketClient.close();</span><br><span class="line">                                webSocketClient = <span class="literal">null</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                            logger.error(<span class="string">&quot;发送信息异常&quot;</span>, e);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> webSocketClient;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@FunctionalInterface</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">interface</span> <span class="title class_">WebsocketCallback</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写完后, 我们可以用<a href="https://www.getpostman.com/"><code>Postman</code></a>模拟海关调用我们写的接口, 看是否上传成功.</p>
<h1 id="审核服务注册地址"><a href="#审核服务注册地址" class="headerlink" title="审核服务注册地址"></a>审核服务注册地址</h1><p>既然接口写好了, 那就可以让海关人员审核了, 在海关微信联调群呼叫下海关人员审核即可.<br>在审核之前, 要确保几件事</p>
<ol>
<li>三天内有订单, 订单需要在<a href="https://swapp.singlewindow.cn/deskserver/sw/deskIndex?menu_id=swcebimp">中国国际贸易单一窗口</a>的订单查询里可以查到.</li>
<li>返回正确格式, 状态值是否为<code>10000</code>, 返回的json数据格式是否正确.</li>
<li>审核接口和企业上传原始支付数据没有直接联系, 接口审核是测试接口的连通性和返回格式是否正确.</li>
<li>端口必须是<code>80</code>, 不过多解释.</li>
<li>是否配置白名单, 企业的防火墙是否把海关的请求拒绝了.</li>
</ol>
<p>注意, 我司是电商平台, 所以是不能提交订单的, 调用微信报关接口上报的是支付单.<br>要买了境外商品后, 联系供应商申报运单、清单、订单. 有一个订单, 然后才能审核服务注册地址.</p>
<p>还有就是, 海关这个订单查询系统, 必须填订单号, 才能查询到订单, 我之前没填订单号, 想查出所有订单, 结果一个订单都查不到.</p>
<h1 id="后续维护"><a href="#后续维护" class="headerlink" title="后续维护"></a>后续维护</h1><p>因为<strong>操作员卡</strong>现在在机房了, 但是我们有登录海关网站配置注册地址, 或者查看订单等需求.<br>这时候有两种方案</p>
<ol>
<li>给实体加签主机开远程, 但是这样会有安全风险</li>
<li>用<strong>法人卡</strong>登录</li>
</ol>
<p>我尝试使用账号密码登录, 登录成功了, 但是海关网站会隐藏掉一些菜单, 导致你不能配置注册地址, 查看订单.</p>
<h1 id="业务流程"><a href="#业务流程" class="headerlink" title="业务流程"></a>业务流程</h1><p>看完前面的步骤, 最后再来梳理下业务流程, 为什么最后放流程, 因为没走完流程, 看了也是一脸懵逼.<br>其中支付宝(微信)和海关的业务是我猜的, 估计应该八九不离十.</p>
<ol>
<li>我司: 用户下单, 支付, 后端保存和支付宝(微信)对接的支付请求体和支付响应体.</li>
<li>我司: 后端调用支付宝(微信)的报关接口进行报关.</li>
<li>支付宝(微信): 异步提交企业发送过来的报关信息给海关方.</li>
<li>海关: 接受到支付宝(微信)提交的报关信息, 海关不信任支付宝(微信)的报关信息, 将订单号发给电商平台(我司), 要求将必要数据交给海关进行对比校验.</li>
<li>我司: 接收到海关的订单号, 告诉海关接收到查询请求了, <strong>异步</strong>查询相关订单数据, 发送给加签主机.</li>
<li>加签主机: 将数据加签, 回传给我司.</li>
<li>我司: 接收到加签后的数据, 拼接<code>JSON</code>, 上传给海关.</li>
<li>海关: 接收到电商平台上传的数据, 和支付宝(微信)的数据做对比, 对比无误后, 告诉支付宝(微信)报关成功,</li>
<li>我司: 调用支付宝(微信)查询接口, 查询报关是否成功.</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.cnblogs.com/whtydn/p/10220209.html">海关 实时数据 企业联调接口 开发步骤与概要</a></li>
<li><a href="https://blog.csdn.net/ccbox_net/article/details/89031736">记录海关165号、179号实时数据联调接口中需要注意的细节</a></li>
<li><a href="http://www.customs.gov.cn/customs/302249/302266/302267/2134975/index.html">海关总署公告2018年第165号（关于实时获取跨境电子商务平台企业支付相关原始数据有关事宜的公告）</a></li>
<li><a href="http://www.customs.gov.cn/customs/302249/302266/302267/2155884/index.html">海关总署公告2018年第179号（关于实时获取跨境电子商务平台企业支付相关原始数据接入有关事宜的公告）</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>业务设计</tag>
      </tags>
  </entry>
  <entry>
    <title>从发票信息中获取位置信息</title>
    <url>/posts/Get_location_from_invoice_information.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间要做<a href="https://github.com/Ahaochan/invoice">毕业设计</a>, 需要了解发票的相关知识。<br>需要做地理位置分析, 画个地图。<br>其中,</p>
<ol>
<li><code>统一社会信用代码</code>可以获取购销单位的<code>行政区划代码</code>。</li>
<li><code>发票代码</code>可以获取发票所属地的<code>行政区划代码</code>。</li>
</ol>
<span id="more"></span>

<h1 id="计算方法"><a href="#计算方法" class="headerlink" title="计算方法"></a>计算方法</h1><p>查阅资料都写的很清楚, 这里再说简单点。<br>获取行政区划代码可以参考我写的一个<a href="https://greasyfork.org/zh-CN/scripts/31888">油猴脚本</a>。</p>
<p><strong>统一社会信用代码</strong><br>在【<strong>金融-统一社会信用代码的校验码验证</strong>】一文中有提到, 统一社会信用代码是纳税人的唯一标识。<br>而18位的统一社会信用代码中, 第3-8位就是行政区划代码。<br>比如<code>91350100M000100Y43</code>的行政区划代码为<code>350100</code>, 为福建省福州市。</p>
<p><strong>发票代码</strong><br>注意, <code>发票代码</code>和<code>发票号码</code>是两回事。</p>
<p>增值税发票共10位, 第1-4位为市级行政区划代码, 后两位补0即可。<br>比如<code>3100164320</code>的行政区划代码为<code>3100</code>, 补零为<code>310000</code>, 为上海市。</p>
<p>普通发票共12位, 第2-5位为市级行政区划代码, 后两位补0即可。<br>比如<code>144031601133</code>的行政区划代码为<code>4403</code>, 补零为<code>440300</code>, 为广东省深圳市。</p>
]]></content>
      <categories>
        <category>金融</category>
      </categories>
      <tags>
        <tag>发票</tag>
      </tags>
  </entry>
  <entry>
    <title>发票代码和发票号码的意义</title>
    <url>/posts/The_meaning_of_invoice_code_and_invoice_number.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间要做<a href="https://github.com/Ahaochan/invoice">毕业设计</a>, 需要了解发票的相关知识。<br>这里简单介绍下<code>发票代码</code>和<code>发票号码</code>有什么不同。</p>
<span id="more"></span>

<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>最主要的还是<code>发票代码</code>, <code>发票号码</code>是一个8位的流水号。<br><code>发票代码</code>和<code>发票号码</code>组合起来, 能够确保这张发票在全国的唯一性。</p>
<h2 id="增值税发票"><a href="#增值税发票" class="headerlink" title="增值税发票"></a>增值税发票</h2><p><code>增值税发票</code>分为<code>增值税普通发票</code>和<code>增值税专用发票</code>。<br>两者都是<code>10位</code>的阿拉伯数字。</p>
<table style="text-align: center;"
  ><tr
    ><th>代码序号</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td
  ></tr
  ><tr
    ><th>代码</th><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td></td
  ></tr
  ><tr><th>说明</th
    ><td colspan="4">市级行政区划代码4位</td
    ><td colspan="2">制版年度2位</td
    ><td>批次1位</td
    ><td>语言文字1位</td
    ><td>几联发票1位</td
    ><td>金额版本号1位</td
  ></tr></table>
  

<ol>
<li>行政区划代码有4位, 后面补两个零, 参考【<strong>从发票信息中获取位置信息</strong>】</li>
<li>制版年度, 代表是<code>几几年</code>印刷的</li>
<li>批次, 代表是几几年印刷<code>第几批</code>印刷的</li>
<li>语言文字, 1中文、 2中英文、 3藏汉文、 4维汉文。</li>
<li>几联发票, 4代表<code>四联发票</code>、 7代表<code>七联发票</code>。</li>
<li>金额版本号, 1万元版、 2十万元版、 3百万元版、 4千万元版、 用0表示电脑发票。</li>
</ol>
<h2 id="普通发票"><a href="#普通发票" class="headerlink" title="普通发票"></a>普通发票</h2><p>普通发票代码共<code>12位</code>阿拉伯数字。</p>
<table style="text-align: center;"
  ><tr
    ><th>代码序号</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td
  ></tr
  ><tr
    ><th>代码</th><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td
  ></tr
  ><tr><th>说明</th
    ><td>税务局代码1位</td
    ><td colspan="4">市级行政区划代码4位</td
    ><td colspan="2">制版年度2位</td
    ><td>统一的行业代码1位</td
    ><td colspan="4">细化的发票种类代码4位</td
  ></tr></table>
  
<ol>
<li>税务局代码, 1为国家税务局、 2为地方税务局、 0为总局。</li>
<li>行政区划代码有4位, 后面补两个零, 参考【<strong>从发票信息中获取位置信息</strong>】</li>
<li>制版年度, 代表是<code>几几年</code>印刷的</li>
<li>统一的行业代码,<br>国税行业划分：1工业、2商业、3加工修理修配业、4收购业、5水电业、6其他。<br>地税行业划分：1交通运输业、2建筑业、3金融保险业、4邮电通信业、5文化体育业、6娱乐业、7服务业、8转让无形资产、9销售不动产、0表示其他。 </li>
<li>细化的发票种类代码4位, 由各税务局自行编制。</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.chinatax.gov.cn/n810341/n810765/n812193/n813008/c1203713/content.html">国家税务总局关于统一全国普通发票分类代码和发票号码的通知</a></li>
</ul>
]]></content>
      <categories>
        <category>金融</category>
      </categories>
      <tags>
        <tag>发票</tag>
      </tags>
  </entry>
  <entry>
    <title>统一社会信用代码的校验码验证</title>
    <url>/posts/The_validation_of_the_unified_social_credit_identifier.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间要做<a href="https://github.com/Ahaochan/invoice">毕业设计</a>, 需要了解发票的相关知识。<br>而购销单位必须要有统一社会信用代码。<br>在<a href="http://qyj.saic.gov.cn/zyfb/gszjfb/201612/t20161208_232473.html">中国企业登记网</a>上有详细的介绍。</p>
<span id="more"></span>

<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>统一社会信用代码由18位<code>数字</code>或<code>大写字母</code>组成。<br>详细的介绍在<a href="http://qyj.saic.gov.cn/zyfb/gszjfb/201612/t20161208_232473.html">中国企业登记网</a>中。</p>
<table style="text-align: center;"
  ><tr
    ><th>代码序号</th><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td><td>13</td><td>14</td><td>15</td><td>16</td><td>17</td><td>18</td
  ></tr
  ><tr
    ><th>代码</th><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td><td>X</td
  ></tr
  ><tr><th>说明</th
    ><td>登记管理部门代码1位</td
    ><td>机构类别代码1位</td
    ><td colspan="6">登记关机机关行政区划码6位</td
    ><td colspan="9">主题标识码(组织机构代码9位)</td
    ><td>校验码1位</td
  ></tr></table>
  
<h1 id="校验码计算"><a href="#校验码计算" class="headerlink" title="校验码计算"></a>校验码计算</h1><p>下面是js的计算代码。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> (<span class="params">value</span>)&#123;</span><br><span class="line">    <span class="comment">// value = 91350100M000100Y43;</span></span><br><span class="line">    <span class="comment">// value = 12440200455904030C;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 判断字符串长度是否为18</span></span><br><span class="line">    <span class="keyword">if</span> (!$.<span class="title function_">isString</span>(value) || value.<span class="property">length</span> !== <span class="number">18</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 转化为大写字母</span></span><br><span class="line">    value = value.<span class="title function_">toUpperCase</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> valid = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">var</span> array = [];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> dist = &#123;</span><br><span class="line">        <span class="comment">// 基础值</span></span><br><span class="line">        <span class="string">&#x27;0&#x27;</span>: <span class="number">0</span>, <span class="string">&#x27;1&#x27;</span>: <span class="number">1</span>, <span class="string">&#x27;2&#x27;</span>: <span class="number">2</span>, <span class="string">&#x27;3&#x27;</span>: <span class="number">3</span>, <span class="string">&#x27;4&#x27;</span>: <span class="number">4</span>, <span class="string">&#x27;5&#x27;</span>: <span class="number">5</span>, <span class="string">&#x27;6&#x27;</span>: <span class="number">6</span>, <span class="string">&#x27;7&#x27;</span>: <span class="number">7</span>, <span class="string">&#x27;8&#x27;</span>: <span class="number">8</span>, <span class="string">&#x27;9&#x27;</span>: <span class="number">9</span>,</span><br><span class="line">        <span class="string">&#x27;A&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;B&#x27;</span>: <span class="number">11</span>, <span class="string">&#x27;C&#x27;</span>: <span class="number">12</span>, <span class="string">&#x27;D&#x27;</span>: <span class="number">13</span>, <span class="string">&#x27;E&#x27;</span>: <span class="number">14</span>, <span class="string">&#x27;F&#x27;</span>: <span class="number">15</span>, <span class="string">&#x27;G&#x27;</span>: <span class="number">16</span>, <span class="string">&#x27;H&#x27;</span>: <span class="number">17</span>, <span class="string">&#x27;J&#x27;</span>: <span class="number">18</span>,</span><br><span class="line">        <span class="string">&#x27;K&#x27;</span>: <span class="number">19</span>, <span class="string">&#x27;L&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;M&#x27;</span>: <span class="number">21</span>, <span class="string">&#x27;N&#x27;</span>: <span class="number">22</span>, <span class="string">&#x27;P&#x27;</span>: <span class="number">23</span>, <span class="string">&#x27;Q&#x27;</span>: <span class="number">24</span>, <span class="string">&#x27;R&#x27;</span>: <span class="number">25</span>, <span class="string">&#x27;T&#x27;</span>: <span class="number">26</span>, <span class="string">&#x27;U&#x27;</span>: <span class="number">27</span>,</span><br><span class="line">        <span class="string">&#x27;W&#x27;</span>: <span class="number">28</span>, <span class="string">&#x27;X&#x27;</span>: <span class="number">29</span>, <span class="string">&#x27;Y&#x27;</span>: <span class="number">30</span>,</span><br><span class="line">        <span class="comment">// 权值对应字母</span></span><br><span class="line">        <span class="string">&#x27;10&#x27;</span>: <span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;11&#x27;</span>: <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;12&#x27;</span>: <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;13&#x27;</span>: <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;14&#x27;</span>: <span class="string">&#x27;E&#x27;</span>, <span class="string">&#x27;15&#x27;</span>: <span class="string">&#x27;F&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;16&#x27;</span>: <span class="string">&#x27;G&#x27;</span>, <span class="string">&#x27;17&#x27;</span>: <span class="string">&#x27;H&#x27;</span>, <span class="string">&#x27;18&#x27;</span>: <span class="string">&#x27;J&#x27;</span>, <span class="string">&#x27;19&#x27;</span>: <span class="string">&#x27;K&#x27;</span>, <span class="string">&#x27;20&#x27;</span>: <span class="string">&#x27;L&#x27;</span>, <span class="string">&#x27;21&#x27;</span>: <span class="string">&#x27;M&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;22&#x27;</span>: <span class="string">&#x27;N&#x27;</span>, <span class="string">&#x27;23&#x27;</span>: <span class="string">&#x27;P&#x27;</span>, <span class="string">&#x27;24&#x27;</span>: <span class="string">&#x27;Q&#x27;</span>, <span class="string">&#x27;25&#x27;</span>: <span class="string">&#x27;R&#x27;</span>, <span class="string">&#x27;26&#x27;</span>: <span class="string">&#x27;T&#x27;</span>, <span class="string">&#x27;27&#x27;</span>: <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;28&#x27;</span>: <span class="string">&#x27;W&#x27;</span>, <span class="string">&#x27;29&#x27;</span>: <span class="string">&#x27;X&#x27;</span>, <span class="string">&#x27;30&#x27;</span>: <span class="string">&#x27;Y&#x27;</span></span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 17位权值</span></span><br><span class="line">    <span class="keyword">var</span> power = [<span class="number">1</span>, <span class="number">3</span>, <span class="number">9</span>, <span class="number">27</span>, <span class="number">19</span>, <span class="number">26</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">20</span>, <span class="number">29</span>, <span class="number">25</span>, <span class="number">13</span>, <span class="number">8</span>, <span class="number">24</span>, <span class="number">10</span>, <span class="number">30</span>, <span class="number">28</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 获取前17位的基础值</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = value.<span class="property">length</span> - <span class="number">1</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> num = dist[value[i]];</span><br><span class="line">        <span class="keyword">if</span> (num === <span class="literal">undefined</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        array.<span class="title function_">push</span>(num);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 获取前17位的权值的和</span></span><br><span class="line">    <span class="keyword">var</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = array.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">        sum += array[i] * power[i];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. 将(31-权值和)%31的值转化为字母, 和第18位进行比较</span></span><br><span class="line">    <span class="keyword">if</span> (dist[<span class="number">31</span> - sum % <span class="number">31</span>] + <span class="string">&#x27;&#x27;</span> === value.<span class="title function_">charAt</span>(value.<span class="property">length</span> - <span class="number">1</span>)) &#123;</span><br><span class="line">        valid = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> valid;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>金融</category>
      </categories>
      <tags>
        <tag>金融</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker Swarm容器编排</title>
    <url>/posts/Docker_Swarm_mode_overview.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Swarm</code>是一个<code>Docker</code>官方提供的容器编排工具. 是<code>Docker</code>推出的一个<code>kubernetes</code>的竞品(当然现在已经是<code>kubernetes</code>的天下了<br><code>Swarm</code>用来解决多机下<code>Docker</code>容器的部署问题, 这是传统<code>Docker</code>和<code>Docker compose</code>解决不了的.<br>并且<code>Swarm</code>已经集成到<code>Docker</code>原生工具里了, 可以直接使用.</p>
<span id="more"></span>

<h1 id="拓扑图"><a href="#拓扑图" class="headerlink" title="拓扑图"></a>拓扑图</h1><p><img data-src="https://yuml.me/diagram/nofunky;dir:UD/class/[manager1]-%3E[worker1],[manager1]-%3E[worker2],[manager1]-%3E[worker3],[manager2]-%3E[worker2],[manager2]-%3E[worker3]" alt="拓扑图"><br><code>Docker Swarm</code>有两个角色, <code>Manager</code>和<code>Worker</code>.<br><code>Manager</code>用于管理多个<code>Worker</code>.</p>
<h1 id="手动创建三个节点的Swarm集群"><a href="#手动创建三个节点的Swarm集群" class="headerlink" title="手动创建三个节点的Swarm集群"></a>手动创建三个节点的Swarm集群</h1><p>这里用一个在线环境来搭建. <a href="https://labs.play-with-docker.com/"><code>labs.play-with-docker</code></a><br>先创建<code>3</code>个节点</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在节点A上声明自己是 manager</span></span><br><span class="line">docker swarm init --advertise-addr=`hostname -i | awk <span class="string">&#x27;&#123;print $1&#125;&#x27;</span>`</span><br><span class="line"><span class="comment"># Swarm initialized: current node (ob8gsaxiz3a4k8rubrv20im2q) is now a manager.</span></span><br><span class="line"><span class="comment"># To add a worker to this swarm, run the following command:</span></span><br><span class="line"><span class="comment">#     docker swarm join --token SWMTKN-1-4luou0jd1580qrjuodc74c7nnavzdoj6pmo8sdfjxy7i0mdld3-45orfnut6qf9ey4kxzs36yjkw 192.168.0.8:2377</span></span><br><span class="line"><span class="comment"># To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 在节点B和节点C上执行上面提供的命令, 加入到 manager 的管理下 </span></span><br><span class="line">docker swarm <span class="built_in">join</span> --token SWMTKN-1-4luou0jd1580qrjuodc74c7nnavzdoj6pmo8sdfjxy7i0mdld3-45orfnut6qf9ey4kxzs36yjkw 192.168.0.8:2377</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 在 manager 上查看节点</span></span><br><span class="line">docker node <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># ID                            HOSTNAME    STATUS  AVAILABILITY    MANAGER STATUS  ENGINE VERSION</span></span><br><span class="line"><span class="comment">#  ob8gsaxiz3a4k8rubrv20im2q *   node1       Ready   Active          Leader          19.03.11</span></span><br><span class="line"><span class="comment">#  jlhp9zpjdhgwygxxl0hrky794     node2       Ready   Active                          19.03.11</span></span><br><span class="line"><span class="comment">#  cohz6uotcm6iogvlxmrh7cdwi     node3       Ready   Active                          19.03.11</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 在 manager 上创建一个 service</span></span><br><span class="line">docker service create --name service1 alpine /bin/ping 127.0.0.1</span><br><span class="line"><span class="comment"># u83i2d5k6aiog3elo9fndbic5</span></span><br><span class="line"><span class="comment"># overall progress: 1 out of 1 tasks </span></span><br><span class="line"><span class="comment"># 1/1: running   [==================================================&gt;] </span></span><br><span class="line"><span class="comment"># verify: Service converged </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 在 manager 上查看 service</span></span><br><span class="line">docker service <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># ID                  NAME                MODE                REPLICAS            IMAGE               PORTS</span></span><br><span class="line"><span class="comment"># u83i2d5k6aio        service1            replicated          1/1                 alpine:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 在 manager 上给 service 动态扩容成 2 个节点</span></span><br><span class="line">docker service scale service1=2</span><br></pre></td></tr></table></figure>

<h1 id="手动搭建一个-wordpress"><a href="#手动搭建一个-wordpress" class="headerlink" title="手动搭建一个 wordpress"></a>手动搭建一个 wordpress</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个 overlay 网络</span></span><br><span class="line">docker network create -d overlay my-overlay</span><br><span class="line"><span class="comment"># 2. 创建 mysql 的 service </span></span><br><span class="line">docker service create --name my-mysql --network my-overlay --mount <span class="built_in">type</span>=volume,<span class="built_in">source</span>=mysql-data,destination=/var/lib/mysql --<span class="built_in">env</span> MYSQL_ROOT_PASSWORD=root --<span class="built_in">env</span> MYSQL_DATABASE=wordpress mysql</span><br><span class="line"><span class="comment"># 3. 创建 wordpress 的 service </span></span><br><span class="line">docker service create --name my-wordpress --network my-overlay -p 80:80 --<span class="built_in">env</span> WORDPRESS_DB_PASSWORD=root --<span class="built_in">env</span> WORDPRESS_DB_HOST=mysql wordpress</span><br><span class="line"><span class="comment"># 4. 为 wordpress 扩容</span></span><br><span class="line">docker service scale my-wordpress=3</span><br></pre></td></tr></table></figure>
<p>这又回到了古老的<code>docker run</code>, 有没有类似<code>docker compose</code>的东西呢?</p>
<h1 id="使用-yaml-配置文件部署-swarm-集群"><a href="#使用-yaml-配置文件部署-swarm-集群" class="headerlink" title="使用 yaml 配置文件部署 swarm 集群"></a>使用 yaml 配置文件部署 swarm 集群</h1><p><code>docker stack</code>就是在<code>swarm</code>上的<code>docker compose</code>, 用的也是<code>yaml</code>配置.<br><code>compose file</code>在<code>3</code>之后提供了一个<code>deploy</code>的配置, 用于<code>swarm</code>集群的部署.</p>
<p>这里还是用<code>wordpress</code>举例</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wordpress:latest</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db:3306</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-overlay</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">replicated</span></span><br><span class="line">      <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">endpoint_mode:</span> <span class="string">vip</span></span><br><span class="line">      <span class="attr">update_config:</span></span><br><span class="line">        <span class="attr">parallelism:</span> <span class="number">2</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">10s</span></span><br><span class="line">      <span class="attr">restart_policy:</span></span><br><span class="line">        <span class="attr">condition:</span> <span class="string">on-failure</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="string">5s</span></span><br><span class="line">        <span class="attr">max_attempts:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-overlay</span></span><br><span class="line">    <span class="attr">deploy:</span></span><br><span class="line">      <span class="attr">mode:</span> <span class="string">global</span> <span class="comment"># 只部署一个节点</span></span><br><span class="line">      <span class="attr">placement:</span></span><br><span class="line">        <span class="attr">constraints:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">node.role</span> <span class="string">==</span> <span class="string">manager</span> <span class="comment"># 只部署在 manager 节点上</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql-data:</span> &#123;&#125;</span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">my-overlay:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">overlay</span></span><br></pre></td></tr></table></figure>
<p>然后使用<code>docker stack</code>命令启动</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 编辑 docker-compose.yml</span></span><br><span class="line">vim docker-compose.yml</span><br><span class="line"><span class="comment"># 2. 部署 swarm 集群</span></span><br><span class="line">docker stack deploy wordpress --compose-file=docker-compose.yml</span><br><span class="line"><span class="comment"># 3. 查看 service</span></span><br><span class="line">docker stack services wordpress</span><br><span class="line"><span class="comment"># ID                  NAME                  MODE                REPLICAS            IMAGE               PORTS</span></span><br><span class="line"><span class="comment"># 3uuc9055uadr        wordpress_db          global              1/1                 mysql:5.7           </span></span><br><span class="line"><span class="comment"># z7l7b5chkq0t        wordpress_wordpress   replicated          3/3                 wordpress:latest    *:80-&gt;80/tcp</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://docs.docker.com/compose/compose-file/"><code>compose-file</code>文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>DockerFile详解</title>
    <url>/posts/DockerFile.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们使用<code>Docker</code>镜像, 一般都是从远程<a href="https://hub.docker.com/"><code>Registry</code></a>仓库<code>pull</code>下来的.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker pull hello-world</span><br></pre></td></tr></table></figure>
<p>但是实际开发过程中, 经常会需要把自己的应用程序打包成一个<code>images</code>镜像. 这个镜像是需要自己打包的.<br>打包的方式一般有两种, <code>Docker File</code>和<code>Docker Compose</code>.</p>
<span id="more"></span>

<h1 id="如何在已有-image-上做修改"><a href="#如何在已有-image-上做修改" class="headerlink" title="如何在已有 image 上做修改"></a>如何在已有 image 上做修改</h1><p>官方虽然提供了很多的<code>Image</code>, 但是我们总会要做一些定制化需求.<br>比如往<code>Image</code>里面塞一些应用程序. 下面列举一个不推荐使用的修改<code>Image</code>的方法.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 拉取基础image</span></span><br><span class="line">docker pull alpine</span><br><span class="line"><span class="comment"># 2. 运行基础image, 并创建一个 hello.txt 文件</span></span><br><span class="line">docker run -it --name base-alpine alpine /bin/sh</span><br><span class="line"><span class="comment"># /bin/echo hello &gt; /hello.txt</span></span><br><span class="line"><span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 使用这个退出后的container, 重新构建一个新的image</span></span><br><span class="line">docker commit base-alpine ahao-alpine</span><br><span class="line"><span class="comment"># 4. 使用这个新构建的镜像, 能找到之前编辑过的 hello.txt</span></span><br><span class="line">docker run -it ahao-alpine /bin/sh</span><br><span class="line"><span class="comment"># /bin/cat /hello.txt</span></span><br></pre></td></tr></table></figure>
<p>但是这种方法不推荐, 也不安全.<br>如果是有恶意的人, 在第二步创建了一个恶意脚本, 然后发布到官方仓库. 使用者根本不知道上传者做了什么操作, 无法进行<code>Review</code>.<br>为了能进行<code>Review</code>代码审查, <code>Docker</code>提供了一个叫<code>DockerFile</code>的文件. 用来记录修改了哪些操作.</p>
<h1 id="使用-Dockerfile-改造上述例子"><a href="#使用-Dockerfile-改造上述例子" class="headerlink" title="使用 Dockerfile 改造上述例子"></a>使用 Dockerfile 改造上述例子</h1><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 基于 alpine 镜像构建</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="comment"># 2. 创建一个 hello.txt 文件</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /bin/echo hello &gt; /hello.txt</span></span><br><span class="line"><span class="comment"># 3. 输出 hello.txt</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/cat&quot;</span>, <span class="string">&quot;/hello.txt&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>我们创建了一个<code>Dockerfile</code>文件, 然后执行构建命令, 输出了<code>hello</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在当前目录根据 Dockerfile 构建 Docker 镜像</span></span><br><span class="line">docker build -t ahaochan/ahao-alpine .</span><br><span class="line"><span class="comment"># 2. 运行构建的镜像, 输出</span></span><br><span class="line">docker run ahaochan/ahao-alpine</span><br><span class="line"><span class="comment"># hello</span></span><br></pre></td></tr></table></figure>

<h1 id="Dockerfile-语法"><a href="#Dockerfile-语法" class="headerlink" title="Dockerfile 语法"></a>Dockerfile 语法</h1><p>下面讲讲<code>Dockerfile</code>的一些命令的语法和使用, 不过建议还是看<a href="https://docs.docker.com/engine/reference/builder/">官方文档</a>的好.</p>
<h2 id="FROM"><a href="#FROM" class="headerlink" title="FROM"></a>FROM</h2><p><code>FROM</code>表示当前镜像是基于哪个镜像做的.<br>比如之前用的<code>FROM alpine</code>, 表示当前镜像是基于<code>alpine</code>来做定制化需求.<br>推荐使用官方的<code>Image</code>来作为<code>FROM</code>基础镜像.</p>
<h2 id="LABEL"><a href="#LABEL" class="headerlink" title="LABEL"></a>LABEL</h2><p><code>LABEL</code>用来标记一些元数据<code>metadata</code>, 相当于镜像的注释.<br>虽然可以没有, 但是建议要有. 不然就是一个三无产品<code>Image</code>, 谁敢放心用呢?</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 基于 alpine 镜像构建</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="comment"># 2. 元数据 metadata</span></span><br><span class="line"><span class="keyword">LABEL</span><span class="language-bash"> maintainer=<span class="string">&quot;作者&quot;</span> version=<span class="string">&quot;版本号&quot;</span> description=<span class="string">&quot;描述&quot;</span></span></span><br></pre></td></tr></table></figure>

<h2 id="WORKDIR"><a href="#WORKDIR" class="headerlink" title="WORKDIR"></a>WORKDIR</h2><p><code>WORKDIR</code>相当于<code>linux</code>的<code>cd</code>命令, 用于进入某个目录中, 如果目录不存在会自动创建目录.<br>有两点需要注意</p>
<ol>
<li>千万不要使用<code>RUN cd</code>, 因为每一次<code>RUN</code>都会产生一层<code>Image Layer</code>.</li>
<li>尽量使用绝对目录, 避免弄混淆了</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /test</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> demo</span></span><br><span class="line"><span class="comment"># 输出 /test/demo</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">pwd</span></span></span><br></pre></td></tr></table></figure>

<h2 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h2><p><code>ENV</code>用于设置环境变量, 提高可维护性.<br>比如我要升级<code>MySQL</code>版本, 改变量就可以了.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ENV</span> MYSQL_VERSION <span class="number">5.6</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y mysql-server=<span class="string">&quot;<span class="variable">$&#123;MYSQL_VERSION&#125;</span>&quot;</span> &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure>
<p>除了上面这种简单用法还有一些高级用法</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">ENV</span> VAR ahao</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo <span class="variable">$&#123;VAR&#125;</span> <span class="variable">$&#123;VAR:-default&#125;</span> <span class="variable">$&#123;NO:-default&#125;</span> <span class="variable">$&#123;VAR:+value&#125;</span> <span class="variable">$&#123;NO:+value&#125;</span>&quot;</span>]</span></span><br><span class="line"><span class="comment"># ahao ahao default value</span></span><br></pre></td></tr></table></figure>
<ol>
<li><code>$&#123;VAR:-default&#125;</code>的意思是, 当<code>VAR</code>没有被定义的时候, 使用后面的<code>default</code>值</li>
<li><code>$&#123;VAR:+default&#125;</code>的意思是, 当<code>VAR</code>被定义的时候, 使用后面的<code>value</code>值, 否则使用空字符串</li>
</ol>
<p>当重复定义一个变量的时候, 当前<code>Image Layer</code>会使用上一层<code>Image Layer</code>定义的变量.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">ENV</span> a=hello</span><br><span class="line"><span class="keyword">ENV</span> a=world b=$a</span><br><span class="line"><span class="keyword">ENV</span> c=$a</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo <span class="variable">$&#123;a&#125;</span> <span class="variable">$&#123;b&#125;</span> <span class="variable">$&#123;c&#125;</span>&quot;</span>]</span></span><br><span class="line"><span class="comment"># world hello world</span></span><br></pre></td></tr></table></figure>

<h2 id="ARG"><a href="#ARG" class="headerlink" title="ARG"></a>ARG</h2><p><code>ARG &lt;name&gt;[=&lt;default value&gt;]</code><br>在<code>docker build</code>镜像的时候使用<code>--build-arg &lt;varname&gt;=&lt;value&gt;</code>参数, 可以将外部参数传入<code>Dockerfile</code>文件中, 用来构建镜像.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">ARG</span> VERSION=latest</span><br><span class="line"><span class="keyword">FROM</span> alpine:$&#123;VERSION&#125;</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/echo hello</span></span><br></pre></td></tr></table></figure>
<p>构建镜像</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 构建基于 最新alpine 的镜像</span></span><br><span class="line">docker build -t ahaochan/ahao-alpine-last .</span><br><span class="line"><span class="comment"># 2. 构建基于 2.7 alpine 的镜像</span></span><br><span class="line">docker build --build-arg VERSION=2.7 -t ahaochan/ahao-alpine-2.7 .</span><br></pre></td></tr></table></figure>
<p>值得注意的是, 官方文档提到, <code>ARG</code>不要传递敏感数据, 不安全.</p>
<p>还有就是同名变量<code>ENV</code>会覆盖<code>ARG</code>. 根据这个特性, 可以做一些默认的操作.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">ARG</span> VERSION</span><br><span class="line"><span class="keyword">ENV</span> VERSION $&#123;VERSION:-lastest&#125;</span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/echo <span class="variable">$VERSION</span></span></span><br></pre></td></tr></table></figure>

<h2 id="COPY"><a href="#COPY" class="headerlink" title="COPY"></a>COPY</h2><p><code>ADD</code>和<code>COPY</code>都是在构建镜像的时候, 将上下文的文件拷贝到镜像中.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t ahaochan/ahao-alpine .</span><br></pre></td></tr></table></figure>
<p>关于上下文, 其实我们一直有在用, 在构建的时候会传入一个参数<code>.</code>, 表示将当前目录作为上下文.<br>构建的时候, <code>docker</code>客户端会把上下文中的所有文件发送给<code>docker daemon</code>.<br>那么如果<code>docker</code>客户端和<code>docker daemon</code>不在同一台机器上, <code>docker daemon</code>是获取不到除了上下文之外的文件的.<br>所以<code>Dockerfile</code>里面的文件, 都要基于这个上下文来访问.</p>
<p>如果只是简单的将文件复制到镜像中, 直接使用<code>COPY</code>就可以了</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="comment"># 1. 将 file1 文件 复制到镜像内 /tmp/test1/ 目录下</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> file1  /tmp/test1/</span></span><br><span class="line"><span class="comment"># 2. 将 file2开头的 文件 复制到镜像内 /tmp/test2/ 目录下</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> file2* /tmp/test2/</span></span><br><span class="line"><span class="comment"># 3. 将 file3开头的 文件 复制到镜像内 /tmp/test3/ 目录下, ?占一个字符, *占多个字符</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> file3? /tmp/test3/</span></span><br><span class="line"><span class="comment"># 4. 将 dir4目录下的 文件 复制到镜像内 /tmp/test4/ 目录下</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> dir4/ /tmp/test4/</span></span><br><span class="line"><span class="comment"># 5. 将 dir5目录下的 文件 复制到镜像内 /tmp/test4/ 目录下, 不会复制 dir5目录本身</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> dir5 /tmp/test5/</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> /bin/ls /tmp/test*</span></span><br></pre></td></tr></table></figure>
<p>构建完毕后, 我们进去看看</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 准备文件</span></span><br><span class="line"><span class="built_in">touch</span> file1</span><br><span class="line"><span class="built_in">touch</span> file2 file22 file222</span><br><span class="line"><span class="built_in">touch</span> file3 file33 file333</span><br><span class="line"><span class="built_in">mkdir</span> dir4 &amp;&amp; <span class="built_in">touch</span> dir4/1 dir4/2 dir4/3</span><br><span class="line"><span class="built_in">mkdir</span> dir5 &amp;&amp; <span class="built_in">touch</span> dir5/1 dir5/2 dir5/3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 构建镜像并运行</span></span><br><span class="line">docker build -t ahaochan/ahao-alpine .</span><br><span class="line">docker run ahaochan/ahao-alpine</span><br><span class="line"><span class="comment"># /tmp/test1:</span></span><br><span class="line"><span class="comment"># file1</span></span><br><span class="line"><span class="comment"># /tmp/test2:</span></span><br><span class="line"><span class="comment"># file2     file22       file222</span></span><br><span class="line"><span class="comment"># /tmp/test3:</span></span><br><span class="line"><span class="comment"># file33</span></span><br><span class="line"><span class="comment"># /tmp/test4:</span></span><br><span class="line"><span class="comment"># 1         2           3</span></span><br><span class="line"><span class="comment"># /tmp/test5:</span></span><br><span class="line"><span class="comment"># 1         2           3</span></span><br></pre></td></tr></table></figure>

<p>另外, <code>COPY</code>还能在多阶段构建中使用, 这是区别于<code>ADD</code>的一个用法.<br>多阶段构建常用在编译打包阶段, 这里不细讲.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /bin/echo hello &gt; /hello.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="comment"># from = 0 引用第一个阶段的 stage, 拉取 hello.txt</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /hello.txt .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/bin/cat hello.txt&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h2 id="ADD"><a href="#ADD" class="headerlink" title="ADD"></a>ADD</h2><p><code>ADD</code>和<code>COPY</code>差不多, 也是将上下文的文件拷贝到镜像中.<br><code>ADD</code>除了不能应用在多阶段构建的场景之外, <code>ADD</code>比<code>COPY</code>多了两个功能.</p>
<ol>
<li>自动解压缩文件并添加到镜像中</li>
<li>从<code>url</code>拷贝文件并添加到镜像中. (<a href="https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#add-or-copy">官方不推荐</a>, 使用<code>curl</code>或<code>wget</code>替代)</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> hello.tar.gz /</span></span><br><span class="line"><span class="keyword">ADD</span><span class="language-bash"> https://greasyfork.org/zh-CN/users/30831.json /</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/bin/ls -l hello.txt 30831.json&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 准备压缩包</span></span><br><span class="line"><span class="built_in">echo</span> hello &gt; hello.txt</span><br><span class="line">tar zcvf hello.tar.gz hello.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 构建镜像</span></span><br><span class="line">docker build -t ahaochan/ahao-alpine .</span><br><span class="line">docker run ahaochan/ahao-alpine</span><br><span class="line"><span class="comment"># -rw-------    1 root  root  7748 Jan  1  1970 30831.json</span></span><br><span class="line"><span class="comment"># -rw-r--r--    1 root  root     6 Jun  7 08:09 hello.txt</span></span><br></pre></td></tr></table></figure>

<h2 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h2><p><code>RUN</code>有2种形式</p>
<ol>
<li><code>shell</code>形式: <code>RUN &lt;command&gt;</code></li>
<li><code>exec</code>形式: <code>RUN [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code></li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">ENV</span> VAR ahao</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$&#123;VAR&#125;</span>&quot;</span></span></span><br><span class="line"><span class="comment"># ahao</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="variable">$&#123;VAR&#125;</span></span></span><br><span class="line"><span class="comment"># ahao</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;<span class="variable">$&#123;VAR&#125;</span>&quot;</span>]</span></span><br><span class="line"><span class="comment"># $&#123;VAR&#125;</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo <span class="variable">$&#123;VAR&#125;</span>&quot;</span>]</span></span><br><span class="line"><span class="comment"># ahao</span></span><br></pre></td></tr></table></figure>
<p>可以看到, <code>exec</code>形式的<code>RUN</code>命令(其实不止<code>RUN</code>, 还有<code>CMD</code>和<code>ENTRYPOINT</code>), 不会去解析<code>$&#123;VAR&#125;</code>.</p>
<p><code>RUN</code>命令一般用来安装一些依赖, 删除缓存等操作.<br>但是每一次<code>RUN</code>都会产生一层<code>Image Layer</code>, 所以需要尽可能的少用<code>RUN</code>, 安装依赖尽量一行代码搞定.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># yum 安装例子</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    yum install -y vim</span></span><br><span class="line"><span class="comment"># apt 安装例子, 注意删除缓存</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    apt-get install -y vim &amp;&amp; \</span></span><br><span class="line"><span class="language-bash">    <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br></pre></td></tr></table></figure>

<h2 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h2><p><code>CMD</code>有3种形式</p>
<ol>
<li><code>shell</code>形式: <code>CMD &lt;command&gt;</code></li>
<li><code>exec</code>形式: <code>CMD [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code></li>
<li><code>exec</code>形式: <code>CMD [&quot;param1&quot;,&quot;param2&quot;]</code>, 作为<code>ENTRYPOINT</code>的默认参数.<br><code>CMD</code>是<code>container</code>启动时默认执行的命令.<br>使用<code>CMD</code>有几个需要注意的地方.</li>
<li>如果<code>Dockerfile</code>有多个<code>CMD</code>, 就只会执行最后一个.</li>
<li>外部命令会覆盖内部的<code>CMD</code>.</li>
</ol>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 基于 alpine 镜像构建</span></span><br><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="comment"># 2. 第1个 CMD 命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/ping&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>]</span></span><br><span class="line"><span class="comment"># 3. 第2个 CMD 命令</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/echo&quot;</span>, <span class="string">&quot;hello&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>编写完<code>Dockerfile</code>后, 我们来构建它.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 构建镜像</span></span><br><span class="line">docker build -t ahaochan/ahao-alpine .</span><br><span class="line"><span class="comment"># 2. 不指定外部命令, 默认执行 Dockerfile 最后一个 CMD 命令 </span></span><br><span class="line">docker run ahaochan/ahao-alpine</span><br><span class="line"><span class="comment"># hello</span></span><br><span class="line"><span class="comment"># 3. 指定外部命令, 覆盖 Dockerfile 里的 CMD 命令</span></span><br><span class="line">docker run -it ahaochan/ahao-alpine /bin/echo ahao</span><br><span class="line"><span class="comment"># ahao</span></span><br></pre></td></tr></table></figure>

<h2 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h2><p><code>ENTRYPOINT</code>有2种形式</p>
<ol>
<li><code>shell</code>形式: <code>ENTRYPOINT command param1 param2</code></li>
<li><code>exec</code>形式: <code>ENTRYPOINT [&quot;executable&quot;, &quot;param1&quot;, &quot;param2&quot;]</code>, 推荐使用.</li>
</ol>
<p><code>ENTRYPOINT</code>让<code>container</code>以应用程序或者服务的形式在后台运行.<br>等价于<code>docker run --entrypoint &quot;command&quot;</code></p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> alpine</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/ping&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t ahaochan/ahao-alpine .</span><br><span class="line"><span class="comment"># 1. 错误使用--entrypoint覆盖</span></span><br><span class="line">docker run --entrypoint <span class="string">&quot;/bin/echo hello&quot;</span> ahaochan/ahao-alpine</span><br><span class="line"><span class="comment"># docker: Error response from daemon: OCI runtime create failed: container_linux.go:345: starting container process caused &quot;exec: \&quot;/bin/echo hello\&quot;: stat /bin/echo hello: no such file or directory&quot;: unknown.</span></span><br><span class="line"><span class="comment"># 2. 正确使用--entrypoint覆盖</span></span><br><span class="line">docker run --entrypoint /bin/echo ahaochan/ahao-alpine hello</span><br><span class="line"><span class="comment"># hello</span></span><br><span class="line"><span class="comment"># 3. 循环执行ping 127.0.0.1</span></span><br><span class="line">docker run ahaochan/ahao-alpine </span><br><span class="line"><span class="comment"># 4. CMD 和 ENTRYPOINT 组合使用, ping 127.0.0.1 -c 3</span></span><br><span class="line">docker run ahaochan/ahao-alpine -c 3</span><br></pre></td></tr></table></figure>

<h1 id="Docker-Compose-语法"><a href="#Docker-Compose-语法" class="headerlink" title="Docker Compose 语法"></a>Docker Compose 语法</h1><p>我们在进行容器间的通信的时候, 要分别启动容器, 关闭还要一个个关闭.<br>比如我要在<code>ahao-alpine2</code>向<code>ahao-alpine1</code>发送请求, 需要先启动<code>ahao-alpine1</code>, 然后再启动<code>ahao-alpine2</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name ahao-alpine1  alpine /bin/ping 127.0.0.1</span><br><span class="line">docker run --name ahao-alpine2 --<span class="built_in">link</span> ahao-alpine1 alpine /bin/ping ahao-alpine1</span><br></pre></td></tr></table></figure>
<p>为了解决这个繁琐的操作, <code>Docker</code>提供了一个工具<code>Docker Compose</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 不推荐使用 apt install, 这安装的是旧版本</span></span><br><span class="line"><span class="comment"># apt install docker-compose -y</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://docs.docker.com/compose/install/#install-compose-on-linux-systems</span></span><br><span class="line">curl -L <span class="string">&quot;https://github.com/docker/compose/releases/download/1.26.0/docker-compose-<span class="subst">$(uname -s)</span>-<span class="subst">$(uname -m)</span>&quot;</span> -o /usr/local/bin/docker-compose</span><br><span class="line"><span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="built_in">ln</span> -s /usr/local/bin/docker-compose /usr/bin/docker-compose</span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>
<p>我们创建一个<code>docker-compose.yml</code>文件</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ahao-alpine1:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/ping&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>]</span><br><span class="line">  <span class="attr">ahao-alpine2:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">links:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">ahao-alpine1</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/ping&quot;</span>, <span class="string">&quot;127.0.0.1&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>一个<code>Service</code>代表一个<code>Container</code>, 启动类似<code>docker run</code>, 可以为其指定<code>network</code>和<code>volume</code>.<br>然后执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 在后台启动 compose</span></span><br><span class="line">docker-compose up -d</span><br><span class="line"><span class="comment"># 进行容器间的网络通信</span></span><br><span class="line">docker-compose <span class="built_in">exec</span> ahao-alpine2 /bin/ping -c 3 ahao-alpine1</span><br><span class="line"><span class="comment"># 关闭进程并删除镜像</span></span><br><span class="line">docker-compose down</span><br></pre></td></tr></table></figure>

<h2 id="搭建-wordpress"><a href="#搭建-wordpress" class="headerlink" title="搭建 wordpress"></a>搭建 wordpress</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">wordpress:</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">wordpress:latest</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_HOST:</span> <span class="string">db:3306</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">WORDPRESS_DB_NAME:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-bridge</span></span><br><span class="line">  <span class="attr">db:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:5.7</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql-data:/var/lib/mysql</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">MYSQL_DATABASE:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_USER:</span> <span class="string">wordpress</span></span><br><span class="line">      <span class="attr">MYSQL_PASSWORD:</span> <span class="string">wordpress</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-bridge</span></span><br><span class="line">  <span class="attr">pma:</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">db</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">phpmyadmin/phpmyadmin</span></span><br><span class="line">    <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">8080</span><span class="string">:80</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="comment"># https://docs.phpmyadmin.net/en/latest/setup.html#docker-environment-variables</span></span><br><span class="line">      <span class="attr">PMA_HOST:</span> <span class="string">db</span></span><br><span class="line">      <span class="attr">PMA_PORT:</span> <span class="number">3306</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">my-bridge</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">mysql-data:</span> &#123;&#125;</span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">my-bridge:</span></span><br><span class="line">    <span class="attr">driver:</span> <span class="string">bridge</span></span><br></pre></td></tr></table></figure>

<h1 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h1><ul>
<li><a href="https://docs.docker.com/engine/reference/builder/">官方文档</a></li>
<li><a href="https://docs.docker.com/compose/compose-file/"><code>compose-file</code>文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker入门安装与运行</title>
    <url>/posts/Docker_simple_installation_and_operation.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>docker</code>是一个存放应用的容器, 将下载、安装、运行等进行了规范化。<br>本文将在虚拟机中<code>CentOS</code>使用桥接连接本机。关于桥接可以看我的另一篇文章, 上方搜索<strong>桥接</strong>即可。</p>
<span id="more"></span>

<h1 id="CentOS7安装"><a href="#CentOS7安装" class="headerlink" title="CentOS7安装"></a>CentOS7安装</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 1. 检查是否为root用户</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================检查是否为root用户==================&quot;</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;EUID&#125;</span> != 0 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;请切换到root用户&quot;</span>;</span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前用户是root&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 检查内核版本号大于3.10</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================检查内核版本号大于3.10==================&quot;</span></span><br><span class="line">status=$(<span class="built_in">uname</span> -r | awk -F <span class="string">&#x27;.&#x27;</span> <span class="string">&#x27;&#123;if($1&gt;=3&amp;&amp;$2&gt;=10) &#123;print &quot;0&quot;&#125; else &#123; print &quot;1&quot;&#125;&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;status&#125;</span> != 0 ]]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Kernel version must be &gt;= 3.10, you version is <span class="subst">$(uname -r)</span>&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1;</span><br><span class="line"><span class="keyword">fi</span>;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;当前内核版本号是<span class="subst">$(uname -r)</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除旧版本docker</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================删除旧版本docker==================&quot;</span></span><br><span class="line">yum remove docker docker-common docker-selinux docker-engine</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. yum-util提供yum-config-manager功能, 另外两个是devicemapper驱动依赖的</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================安装相关依赖==================&quot;</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 设置yum源</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================设置yum源==================&quot;</span></span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 安装docker并启动</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================安装docker==================&quot;</span></span><br><span class="line">yum install -y docker-ce</span><br><span class="line">service docker start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 7. 验证是否安装成功</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;==================验证是否安装成功==================&quot;</span></span><br><span class="line">docker version</span><br></pre></td></tr></table></figure>

<h1 id="安装运行Hello-World"><a href="#安装运行Hello-World" class="headerlink" title="安装运行Hello World"></a>安装运行Hello World</h1><p><code>docker</code>包含几个命令, <code>docker pull</code>下载, <code>docker images</code>查看镜像, <code>docker run</code> 运行。<br>这是一个<code>hello world</code>程序, <a href="https://hub.docker.com/_/hello-world/">docker hub 地址</a></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 从仓库下载hello-world</span></span><br><span class="line">docker pull hello-world</span><br><span class="line"><span class="comment"># latest: Pulling from library/hello-world</span></span><br><span class="line"><span class="comment"># 9db2ca6ccae0: Pull complete </span></span><br><span class="line"><span class="comment"># Digest: sha256:4b8ff392a12ed9ea17784bd3c9a8b1fa3299cac44aca35a85c90c5e3c7afacdc</span></span><br><span class="line"><span class="comment"># Status: Downloaded newer image for hello-world:latest</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看已有镜像</span></span><br><span class="line">docker images</span><br><span class="line"><span class="comment"># REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</span></span><br><span class="line"><span class="comment"># hello-world         latest              2cb0d9787c4d        5 days ago          1.85kB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 运行 hello world, 打印如下信息</span></span><br><span class="line">docker run hello-world</span><br><span class="line"><span class="comment"># 来自Docker的问好!</span></span><br><span class="line"><span class="comment"># 此消息表示您的安装似乎正常工作。</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 为了生成这些信息, Docker进行了以下的操作:</span></span><br><span class="line"><span class="comment">#  1. Docker客户端 连接到 Docker daemon守护进程</span></span><br><span class="line"><span class="comment">#  2. Docker daemon守护进程 从 Docker 仓库 下载(pull) 了 hello-world 镜像(image)</span></span><br><span class="line"><span class="comment">#  3. Docker daemon守护进程从该镜像(image)创建了一个新容器(container)，该容器运行并执行可执行文件, 输出您现在看到的内容。</span></span><br><span class="line"><span class="comment">#  4. Docker daemon守护进程将输出流输出到Docker客户端, Docker客户端会将信息发送到你的终端(terminal)</span></span><br></pre></td></tr></table></figure>
<p>执行操作: </p>
<ol>
<li><code>docker client</code>客户端向<code>docker daemon</code>服务端发送<code>docker run</code>命令</li>
<li><code>docker daemon</code>检查是否有<code>image</code>镜像, 没有则向<code>docker hub</code>仓库下载<code>image</code>镜像</li>
<li><code>docker daemon</code>会创建一个<code>container</code>容器运行这个<code>image</code>镜像</li>
</ol>
<h1 id="安装运行Nginx"><a href="#安装运行Nginx" class="headerlink" title="安装运行Nginx"></a>安装运行Nginx</h1><p>先安装<code>docker pull nginx</code>, 然后运行<code>docker run -dp 8080:80 nginx</code>。</p>
<ol>
<li><code>-d</code>: 后台运行容器, 并返回容器ID</li>
<li><code>-p</code>: 进行端口映射, 格式为: <code>主机端口:容器端口</code></li>
</ol>
<p>然后我们就可以在自己电脑输入<code>http://ip地址:8080</code>访问到<code>nginx</code>。</p>
<h2 id="WARNING-IPv4-forwarding-is-disabled-Networking-will-not-work"><a href="#WARNING-IPv4-forwarding-is-disabled-Networking-will-not-work" class="headerlink" title="WARNING: IPv4 forwarding is disabled. Networking will not work."></a>WARNING: IPv4 forwarding is disabled. Networking will not work.</h2><p>如果提示<code>IPv4</code>转发没有开启, 那就去开启。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.ip_forward=1&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>

<h2 id="为什么要做端口映射"><a href="#为什么要做端口映射" class="headerlink" title="为什么要做端口映射?"></a>为什么要做端口映射?</h2><p><code>Docker</code>容器可以看成是一个<code>虚拟机</code>, 那我们的3台机器就有这种关系<br>![主机关系](<a href="https://yuml.me/diagram/nofunky/class/[win10%E7%9C%9F%E6%AD%A3%E7%9A%84%E4%B8%BB%E6%9C%BA]-&gt;[CentOS7%E8%99%9A%E6%8B%9F%E6%9C%BA],[CentOS7%E8%99%9A%E6%8B%9F%E6%9C%BA]-&gt;[Docker">https://yuml.me/diagram/nofunky/class/[win10真正的主机]-&gt;[CentOS7虚拟机],[CentOS7虚拟机]-&gt;[Docker</a> Nginx容器])</p>
<p>如果是直接安装在<code>CentOS7虚拟机</code>上的话, 我们的<code>win10真正的主机</code>是可以直接访问<code>Nginx</code>的。 但是现在是运行在<code>Docker</code>容器里, 中间隔了个<code>CentOS7虚拟机</code>, 我们就需要做端口映射, 如<code>docker run -dp 8080:80 nginx</code>。</p>
<p>这样我们在<code>win10真正的主机</code>访问<code>CentOS7虚拟机</code>的<code>8080</code>端口时, <code>CentOS7虚拟机</code>会转发到<code>Docker</code>容器的<code>80</code>端口(这也是之前我们为什么要开启<code>IPv4</code>转发的原因)，我们就可以在<code>win10真正的主机</code>间接访问<code>Docker</code>容器中的<code>Nginx</code>了。</p>
<p><strong>注意</strong><br>实际最好端口要一致, 这里为了容易区分, 才分为<code>8080:80</code>, 最好为<code>80:80</code>。</p>
<h2 id="修改Nginx配置文件"><a href="#修改Nginx配置文件" class="headerlink" title="修改Nginx配置文件"></a>修改Nginx配置文件</h2><p><code>Docker</code>容器就像一个虚拟机, 所以我们也可以通过<code>bash</code>进入。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 后台启动nginx, 映射虚拟机端口8080到容器端口80</span></span><br><span class="line">docker run -dp 8080:80 nginx</span><br><span class="line"><span class="comment"># 0df7493162a1e34d43c74e67b1bbe4c810ea821a994d85d5d45eae837d4ddf25</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看docker进程, 找到nginx的容器id</span></span><br><span class="line">docker ps</span><br><span class="line"><span class="comment"># CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                  NAMES</span></span><br><span class="line"><span class="comment"># 0df7493162a1        nginx               &quot;nginx -g &#x27;daemon of…&quot;   6 seconds ago       Up 5 seconds        0.0.0.0:8080-&gt;80/tcp   naughty_kilby</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 执行bash命令进入docker容器内部</span></span><br><span class="line">docker <span class="built_in">exec</span> -it 0df7493162a1 bash</span><br><span class="line"><span class="comment"># -i 让容器的标准输入保持打开</span></span><br><span class="line"><span class="comment"># -t 让Docker分配一个伪终端（pseudo-tty）并绑定到容器的标准输入上</span></span><br><span class="line"><span class="comment"># root@0df7493162a1:/$ vim /etc/nginx/nginx.conf</span></span><br></pre></td></tr></table></figure>
<p>进入容器, 就可以像普通的<code>Linux</code>一样进行操作了, 如编辑配置文件<code>vim /etc/nginx/nginx.conf</code>。</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker多阶段构建</title>
    <url>/posts/docker_multi_stage_build.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>Docker多阶段构建是17.05以后引入的新特性，旨在解决编译和构建复杂的问题。<br>减小镜像大小。因此要使用多阶段构建特性必须使用高于或等于17.05的Docker。</p>
</blockquote>
<p>在<code>Docker</code>多阶段构建出现之前, 要将<code>java</code>程序打包运行, 需要编写两个<code>Dockerfile</code>文件, 一个用来打包, 一个用来部署.</p>
<span id="more"></span>

<h1 id="两个-Dockerfile-的部署方式"><a href="#两个-Dockerfile-的部署方式" class="headerlink" title="两个 Dockerfile 的部署方式"></a>两个 Dockerfile 的部署方式</h1><p>创建用于打包的<code>Dockerfile</code>文件</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Dockerfile.build</span></span><br><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/acs/maven:<span class="number">3</span>-jdk-<span class="number">8</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/app</span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /root/.m2</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ../../.. .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;mvn&quot;</span>, <span class="string">&quot;clean&quot;</span>, <span class="string">&quot;package&quot;</span>, <span class="string">&quot;-DfinalName=ahao&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>创建用于部署的<code>Dockerfile</code>文件.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-jre-alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> ./ahao.jar /ahao.jar</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/java&quot;</span>, <span class="string">&quot;-jar&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/ahao.jar&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>然后编写<code>shell</code>脚本, 将两个<code>Dockerfile</code>构建镜像后, 关联起来</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 构建打包镜像</span></span><br><span class="line">docker build -t ahao-build-image -f Dockerfile.build .</span><br><span class="line"><span class="comment"># 2. 创建 volume 存储, 缓存依赖项</span></span><br><span class="line">docker volume create --name maven-repo</span><br><span class="line"><span class="comment"># 3. 执行打包命令</span></span><br><span class="line">docker run -it -v maven-repo:/root/.m2 --name ahao-build ahao-build-image</span><br><span class="line"><span class="comment"># 4. 将打包后的 jar 包移出容器</span></span><br><span class="line">docker <span class="built_in">cp</span> ahao-build:/usr/app/target/ahao.jar .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 构建部署镜像</span></span><br><span class="line">docker build -t ahao-jar-deploy -f Dockerfile .</span><br><span class="line"><span class="comment"># 6. 启动部署容器</span></span><br><span class="line">docker run -it --name ahao-deploy ahao-jar-deploy</span><br></pre></td></tr></table></figure>

<h1 id="Docker-多阶段构建"><a href="#Docker-多阶段构建" class="headerlink" title="Docker 多阶段构建"></a>Docker 多阶段构建</h1><p>在<code>Docker</code>多阶段构建出现之前, 除了两个<code>Dockerfile</code>文件之外, 还要编写<code>shell</code>脚本.<br>真复杂, 于是多阶段构建就出现了.</p>
<p>在编写<code>Dockerfile</code>之前, 先把<code>pom.xml</code>几个重要的参数设置一下.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">file.encoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">file.encoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">start-class</span>&gt;</span>moe.ahao.docker.Main<span class="tag">&lt;/<span class="name">start-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;-$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;finalName&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>$&#123;start-class&#125;<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">addDefaultImplementationEntries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addDefaultImplementationEntries</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里用<code>maven-jar-plugin</code>打包, 还用到几个参数</p>
<ol>
<li><code>finalName</code>, 用于指定打包出来的<code>jar</code>名称, 方便编写<code>Dockfile</code></li>
<li><code>mainClass</code>, 用于指定<code>jar</code>包的主类.</li>
</ol>
<p>将上面的打包部署脚本翻译一下.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> registry.cn-hangzhou.aliyuncs.com/acs/maven:<span class="number">3</span>-jdk-<span class="number">8</span> AS build</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /usr/app</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> pom.xml .</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/usr/local/bin/mvn-entrypoint.sh&quot;</span>, <span class="string">&quot;mvn&quot;</span>, <span class="string">&quot;verify&quot;</span>, <span class="string">&quot;clean&quot;</span>, <span class="string">&quot;--fail-never&quot;</span>]</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> src ./src</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> [<span class="string">&quot;/usr/local/bin/mvn-entrypoint.sh&quot;</span>, <span class="string">&quot;mvn&quot;</span>, <span class="string">&quot;verify&quot;</span>, <span class="string">&quot;-DfinalName=ahao&quot;</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span>-jre-alpine</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=build /usr/app/target/ahao.jar /usr/app/app.jar</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/java&quot;</span>, <span class="string">&quot;-jar&quot;</span>]</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/usr/app/app.jar&quot;</span>]</span></span><br><span class="line"><span class="comment"># docker build -t ahao-docker .</span></span><br><span class="line"><span class="comment"># docker run -it ahao-docker</span></span><br></pre></td></tr></table></figure>
<p>然后构建镜像, 部署.</p>
<p>相关代码可以看我的<a href="https://github.com/Ahaochan/project/tree/master/ahao-docker">例子</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/a/14417340"><code>Is it possible to rename a maven jar-with-dependencies?</code></a></li>
</ul>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker容器网络</title>
    <url>/posts/Docker_network.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Docker</code>有四种网络连接方式.</p>
<ol>
<li>单机模式: <code>bridge</code>、<code>host</code>和<code>none</code>.</li>
<li>多机模式: <code>overlay</code><br><code>Docker</code>会自动创建<code>3</code>个网络.<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># NETWORK ID          NAME                DRIVER              SCOPE</span></span><br><span class="line"><span class="comment"># 7b083adc391a        bridge              bridge              local</span></span><br><span class="line"><span class="comment"># 5855c878dc68        host                host                local</span></span><br><span class="line"><span class="comment"># 9895a4ab897d        none                null                local</span></span><br></pre></td></tr></table></figure></li>
</ol>
<span id="more"></span>

<h1 id="Docker-Container-之间的网络连接"><a href="#Docker-Container-之间的网络连接" class="headerlink" title="Docker Container 之间的网络连接"></a>Docker Container 之间的网络连接</h1><p>如果我有一个应用的容器, 需要连接到<code>MySQL</code>的容器, 那么就需要建立两个容器之间的网络连接.<br><code>Docker</code>提供了一个<code>--link &lt;container&gt;</code>的参数, 用来连接到其他的<code>container</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个 bridge1 容器, 并查看ip地址</span></span><br><span class="line">docker run -d --name bridge1 alpine /bin/ping 127.0.0.1</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge1 hostname -i</span><br><span class="line"><span class="comment"># 172.17.0.4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建一个 bridge2 容器, 并 ping bridge1 的 ip 地址</span></span><br><span class="line">docker run -d --name bridge2 --<span class="built_in">link</span> bridge1 alpine /bin/ping 127.0.0.1</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge2 /bin/ping -c 3 172.17.0.4</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge2 /bin/ping -c 3 bridge1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 默认的 bridge 是单向的, bridge1 ping bridge2 失败</span></span><br><span class="line">docker <span class="built_in">exec</span> -it bridge1 /bin/ping bridge2</span><br></pre></td></tr></table></figure>
<p>发现<code>bridge2</code>可以直接<code>ping bridge1</code>, 不用输入<code>IP</code>地址.<br>因为<code>--link bridge1</code>相当于给<code>bridge2</code>添加了一条<code>DNS</code>解析.<br><strong>而且, 默认的 <code>bridge</code> 是单向的, 这句话先记着, 后面讲</strong></p>
<p>那这两个容器, 是用哪个<code>network</code>连接的呢?<br>答案是默认创建的名为<code>bridge</code>的<code>bridge</code>类型的<code>network</code>. 执行下面语句</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># docker network inspect &lt;network name&gt;</span></span><br><span class="line"><span class="comment"># docker network inspect bridge # 输出详细信息</span></span><br><span class="line">docker network inspect -f <span class="string">&#x27;&#123;&#123;range .Containers&#125;&#125;&#123;&#123;.Name&#125;&#125;&#123;&#123;println&#125;&#125;&#123;&#123;else&#125;&#125;With No Containers&#123;&#123;end&#125;&#125;&#x27;</span> bridge</span><br><span class="line"><span class="comment"># bridge2</span></span><br><span class="line"><span class="comment"># bridge1</span></span><br></pre></td></tr></table></figure>
<p>可以看到<code>bridge1</code>和<code>bridge2</code>这两个容器都绑在名为<code>bridge</code>的<code>bridge</code>类型的<code>network</code>上了.<br>那如果我想做网络隔离, 绑定到自定义的<code>bridge</code>上呢?</p>
<h1 id="单机-Docker-网络"><a href="#单机-Docker-网络" class="headerlink" title="单机 Docker 网络"></a>单机 Docker 网络</h1><h2 id="bridge-网络隔离"><a href="#bridge-网络隔离" class="headerlink" title="bridge 网络隔离"></a>bridge 网络隔离</h2><p>我们可以自己创建一个<code>bridge</code>, 做网络隔离.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建自己的 bridge</span></span><br><span class="line">docker network create -d bridge my-bridge</span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建一个新的 container 连接到 my-bridge</span></span><br><span class="line">docker run -d --name bridge3 --<span class="built_in">link</span> bridge1 --network my-bridge alpine /bin/ping 127.0.0.1</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge3 hostname -i</span><br><span class="line"><span class="comment"># 172.18.0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ping bridge1 失败</span></span><br><span class="line">docker <span class="built_in">exec</span> -it bridge3 /bin/ping 172.17.0.4</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge3 /bin/ping bridge1</span><br></pre></td></tr></table></figure>
<p>可以看到, 即使我们手动指定了<code>--link bridge1</code>, <code>bridge3</code>容器仍然访问不了<code>bridge1</code>容器.<br>因为<code>bridge3</code>容器和<code>bridge1</code>容器使用的不是同一个<code>docker</code>网络.</p>
<p>把<code>bridge1</code>容器连接到<code>my-bridge</code>上, 注意, 此时<code>bridge1</code>仍然存在于默认的网络<code>bridge</code>上.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 把 bridge1 连接到 my-bridge</span></span><br><span class="line">docker network connect my-bridge bridge1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ping bridge1 成功</span></span><br><span class="line">docker <span class="built_in">exec</span> -it bridge3 /bin/ping -c 3 172.18.0.3</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge3 /bin/ping -c 3 bridge1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ping bridge3 成功</span></span><br><span class="line">docker <span class="built_in">exec</span> -it bridge1 /bin/ping -c 3 172.18.0.2</span><br><span class="line">docker <span class="built_in">exec</span> -it bridge1 /bin/ping -c 3 bridge3</span><br></pre></td></tr></table></figure>
<p>注意, 我们没有给<code>bridge1</code>添加<code>--link bridge3</code>, 只是连接到 <code>my-bridge</code>, 却可以<code>ping bridge3</code>.<br>因为和默认的<code>bridge</code>不同, <strong>自己创建的<code>bridge</code>默认是双向的</strong>.</p>
<h2 id="host-共享-network-namespace"><a href="#host-共享-network-namespace" class="headerlink" title="host 共享 network namespace"></a>host 共享 network namespace</h2><p>如果我们用<code>Docker</code>启动了一个<code>nginx</code>服务器.<br>此时, 只有宿主机可以访问<code>Docker</code>容器里的<code>nginx</code>服务器.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 运行本地服务器 nginx</span></span><br><span class="line">docker run -d --name web-local nginx</span><br><span class="line"><span class="comment"># 2. 查看container的容器地址, 默认连接到 bridge 上</span></span><br><span class="line"><span class="comment">#    看 Containers 下的 IPv4Address, 得知 IP 地址为 172.17.0.2</span></span><br><span class="line">docker network inspect bridge</span><br><span class="line"><span class="comment"># 3. 测试连接 nginx, 访问成功</span></span><br><span class="line">ping 172.17.0.2</span><br><span class="line">curl http://172.17.0.2</span><br></pre></td></tr></table></figure>
<p>在宿主机里可以访问这个<code>nginx</code>, 但是在局域网的其他机器上, 却不能访问<code>http://172.17.0.2</code>.<br>我们需要把宿主机里的<code>nginx</code>暴露到外部来, 使用端口映射达到这个目的.<br>将<code>container</code>的<code>80</code>端口, 映射到宿主机的<code>8080</code>端口, 这样, 我们直接访问宿主机的<code>8080</code>端口, 就可以间接的访问到<code>nginx</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d -p 8080:80 --name web-port-map nginx</span><br></pre></td></tr></table></figure>

<p>以上文字和<code>host</code>毫无关联, 只是为下文做铺垫.<br><code>host</code>可以共享宿主机的<code>network namespace</code>, 关于<code>Linux network namespace</code>可以看我的另一篇文章.<br>把它想象成一个网络沙箱即可.<br>还是用<code>nginx</code>做个简单例子, 我们从上面可以知道部署<code>nginx</code>需要做端口映射.<br>但是使用<code>host</code>共享宿主机的<code>network namespace</code>就可以<strong>不用做端口映射</strong>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name web-host --network host nginx</span><br></pre></td></tr></table></figure>
<p>我们在外部使用宿主机的<code>IP</code>地址, 可以访问到<code>80</code>端口的<code>nginx</code>.<br>但是, 这个用法有个缺陷, 如果我想在一台机器上同时启动两个<code>nginx</code>服务, 就会发生端口冲突, 它们会去争夺<code>80</code>端口.</p>
<h2 id="none-断网操作"><a href="#none-断网操作" class="headerlink" title="none 断网操作"></a>none 断网操作</h2><p>一般用于安全性, 保密性较高的程序.<br>直接隔离网络, 断网.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d --name net-none --network none alpine /bin/ping 127.0.0.1</span><br><span class="line">docekr <span class="built_in">exec</span> -it net-none ip a</span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue qlen 1</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"><span class="comment">#     inet 127.0.0.1/8 scope host lo</span></span><br><span class="line"><span class="comment">#        valid_lft forever preferred_lft forever</span></span><br></pre></td></tr></table></figure>
<p>可以看到没有分配<code>ip</code>地址, 只有一个本地的回环地址<code>127.0.0.1</code>.</p>
<h1 id="多机-Docker-网络"><a href="#多机-Docker-网络" class="headerlink" title="多机 Docker 网络"></a>多机 Docker 网络</h1><p>在<code>Docker 1.9</code>之前, 要实现多机<code>Docker</code>容器之间的网络通信, 都是通过端口映射或者<code>host</code>网络, 将<code>Docker</code>容器的端口暴露到宿主机.<br>通过宿主机之间的网络通信, 间接完成了多机<code>Docker</code>容器之间的网络通信.</p>
<p>TODO 待续</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>Docker数据持久化</title>
    <url>/posts/Docker_data_persistence.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>当我们使用<code>Docker</code>创建一个<code>mysql</code>的<code>container</code>, 数据是存储在<code>container</code>内的.<br>如果有一天不小心执行了<code>docker rm $(docker ps -aq)</code>删除所有<code>container</code>. 那么<code>mysql</code>里的数据也会被删掉, 这是不安全的.<br>我们需要将数据持久化, 存储在<code>container</code>外部. 即使删除<code>container</code>也不会删除原有的数据.</p>
<span id="more"></span>

<h1 id="Data-Volume-数据持久化"><a href="#Data-Volume-数据持久化" class="headerlink" title="Data Volume 数据持久化"></a>Data Volume 数据持久化</h1><p><code>Volume</code>可以将数据持久化到宿主机的某个目录下.<br>我们在官方的<code>mysql</code>的<a href="https://github.com/docker-library/mysql/blob/bb7ea52db4e12d3fb526450d22382d5cd8cd41ca/5.7/Dockerfile#L73"><code>Dockerfile</code></a>里可以看到指定了<code>VOLUME</code>. </p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">VOLUME</span><span class="language-bash"> /var/lib/mysql</span></span><br></pre></td></tr></table></figure>
<p>说明这个<code>mysql</code>的数据存在宿主机的这个文件夹下, <strong>但是, 不是直接存在宿主机的这个文件夹下, 里面还有多层目录</strong>.</p>
<p>先看看下面的例子</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 运行一个mysql, -v 等价于 VOLUME 关键字, -e 指定环境变量</span></span><br><span class="line"><span class="comment"># docker run -d -v &lt;volume名称&gt;:/var/lib/mysql --name my-mysql -e MYSQL_ALLOW_EMPTY_PASSWORD=true mysql</span></span><br><span class="line">docker run -d -v my-volume:/var/lib/mysql --name my-mysql -e MYSQL_ALLOW_EMPTY_PASSWORD=<span class="literal">true</span> mysql</span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># DRIVER   VOLUME NAME</span></span><br><span class="line"><span class="comment"># local    my-volume</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看 my-volume 的详细信息, 可以看到 Mountpoint 指定了具体存储位置</span></span><br><span class="line">docker volumn inspect my-volume</span><br><span class="line"><span class="comment"># [</span></span><br><span class="line"><span class="comment">#     &#123;</span></span><br><span class="line"><span class="comment">#         &quot;CreatedAt&quot;: &quot;2019-02-03T10:25:00+08:00&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Driver&quot;: &quot;local&quot;,</span></span><br><span class="line"><span class="comment">#         &quot;Labels&quot;: null,</span></span><br><span class="line"><span class="comment">#         &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/my-volume/_data&quot;,  # Mysql文件真实存储路径</span></span><br><span class="line"><span class="comment">#         &quot;Name&quot;: &quot;my-volume&quot;,                                      # 通过 -v 重命名的 volume 名称</span></span><br><span class="line"><span class="comment">#         &quot;Options&quot;: null,</span></span><br><span class="line"><span class="comment">#         &quot;Scope&quot;: &quot;local&quot;</span></span><br><span class="line"><span class="comment">#     &#125;</span></span><br><span class="line"><span class="comment"># ]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除 container 后, volume 仍然存在</span></span><br><span class="line">docker <span class="built_in">rm</span> -f my-mysql</span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># DRIVER   VOLUME NAME</span></span><br><span class="line"><span class="comment"># local    my-volume</span></span><br></pre></td></tr></table></figure>
<p>删除<code>Mysql</code>容器后, <code>volume</code>不会一起被删除, 这样的话, 数据就不会丢失了.<br>那如果我想重新连接这个<code>volume</code>怎么办呢? 还是用<code>-v</code>参数指定.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -d -v my-volume:/var/lib/mysql --name my-mysql-new -e MYSQL_ALLOW_EMPTY_PASSWORD=<span class="literal">true</span> mysql</span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"><span class="comment"># DRIVER   VOLUME NAME</span></span><br><span class="line"><span class="comment"># local    my-volume</span></span><br></pre></td></tr></table></figure>

<h1 id="Bing-Mounting-绑定挂载"><a href="#Bing-Mounting-绑定挂载" class="headerlink" title="Bing Mounting 绑定挂载"></a>Bing Mounting 绑定挂载</h1><p>如果我想自定义<code>volume</code>在宿主机的存储路径, 要怎么配置呢?</p>
<p><code>Bing Mounting</code>可以将<code>container</code>里的目录和宿主机的目录做映射.<br>比如<code>nginx</code>, 想要改里面的<code>html</code>, 每次都要<code>docker exec -it my-nginx /bin/bash</code>进去容器内部改.<br>并且, <code>container</code>删掉后, 里面的<code>html</code>也不见了.</p>
<p>使用<code>Bing Mounting</code>解决这个问题.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个自己的 index.html</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/nginx &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;替换掉的html&quot;</span> &gt; /opt/nginx/index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 将当前目录 /opt/nginx 和 container 内部的 html 目录做映射</span></span><br><span class="line">docker run -v /opt/nginx:/usr/share/nginx/html -d -p 80:80 --name my-nginx nginx</span><br><span class="line">curl http://127.0.0.1:80</span><br><span class="line"><span class="comment"># 替换掉的html</span></span><br></pre></td></tr></table></figure>
<p>这样, 在外部访问<code>nginx</code>时, 就可以看到被替换的<code>html</code>.</p>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>RUN和CMD和ENTRYPOINT</title>
    <url>/posts/RUN_CMD_ENTRYPOINT.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Docker</code>有三种命令执行方式</p>
<ol>
<li><code>RUN</code>: 执行命令并创建新的<code>Image Layer</code></li>
<li><code>CMD</code>: 设置容器启动后默认执行的命令和参数</li>
<li><code>ENTRYPOINT</code>: 设置容器启动时运行的命令</li>
</ol>
<span id="more"></span>

<h1 id="RUN"><a href="#RUN" class="headerlink" title="RUN"></a>RUN</h1><p><code>RUN</code>命令一般用来安装一些依赖, 删除缓存等操作.<br>但是每一次<code>RUN</code>都会产生一层<code>Image Layer</code>, 所以需要尽可能的少用<code>RUN</code>, 尽量一行代码搞定.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> yum update &amp;&amp; yum install -y vim</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apt-get update &amp;&amp; apt-get install -y \</span></span><br><span class="line"><span class="language-bash">        vim &amp;&amp; <span class="built_in">rm</span> -rf /var/lib/apt/lists/*</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> /bin/bash -c <span class="string">&#x27;source $HOME/.bashrc; echo $HOME&#x27;</span></span></span><br></pre></td></tr></table></figure>

<h1 id="CMD"><a href="#CMD" class="headerlink" title="CMD"></a>CMD</h1><p><code>CMD</code>是<code>container</code>启动时默认执行的命令.<br>等价于<code>docker run -it [image] /bin/bash</code>.<br>并且会被覆盖.</p>
<ol>
<li>多个CMD只会执行最后一个.</li>
<li>外部命令会覆盖内部的<code>CMD</code>.</li>
</ol>
<p>利用外部命令会覆盖内部<code>CMD</code>的特性, 我们可以从外部传入参数.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/usr/bin/curl&quot;</span>]</span></span><br><span class="line"><span class="comment"># 默认查看curl版本号</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;--version&quot;</span>] </span></span><br></pre></td></tr></table></figure>
<p>然后执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker build -t centos-curl .</span><br><span class="line">docker run -it centos-curl --<span class="built_in">head</span> www.baidu.com</span><br></pre></td></tr></table></figure>
<p>等价于在<code>container</code>中执行<code>/usr/bin/curl --head www.baidu.com</code>.</p>
<h1 id="ENTRYPOINT"><a href="#ENTRYPOINT" class="headerlink" title="ENTRYPOINT"></a>ENTRYPOINT</h1><p><code>ENTRYPOINT</code>让<code>container</code>以应用程序或者服务的形式运行.<br>和<code>CMD</code>相比, <code>ENTRYPOINT</code>不会被忽略, 一定会执行.<br>最佳实践就是写一个<code>shell</code>作为<code>ENTRYPOINT</code></p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">COPY</span><span class="language-bash"> docker-entrypoint.sh /usr/local/bin</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;docker-entrypoint.sh&quot;</span>]</span></span><br></pre></td></tr></table></figure>

<h1 id="参数格式-SHELL-和-EXEC"><a href="#参数格式-SHELL-和-EXEC" class="headerlink" title="参数格式 SHELL 和 EXEC"></a>参数格式 SHELL 和 EXEC</h1><p>另外, <code>RUN</code>和<code>CMD</code>和<code>ENTRYPOINT</code>的参数规则有两种, <code>SHELL</code> 和 <code>EXEC</code>.<br>以<code>ENTRYPOINT</code>为例, 这两种<code>ENTRYPOINT</code>的写法是等价的.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"><span class="keyword">ENV</span> name Ahao</span><br><span class="line"><span class="comment"># ENTRYPOINT echo &quot;hello $&#123;Ahao&#125;&quot;</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/bin/bash&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;echo hello <span class="variable">$&#123;Ahao&#125;</span>&quot;</span>]</span></span><br><span class="line"><span class="comment"># ENRTYPOINT [COMMAND] 等价于 ENTRYPOINT [&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;[COMMAND]&quot;]</span></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>使用<code>RUN</code>安装软件依赖, 并记得删除缓存.</li>
<li>构建服务时使用<code>Exec</code>格式的<code>ENTRYPOINT</code>.</li>
<li>默认启动命令使用<code>CMD</code>.</li>
</ol>
]]></content>
      <categories>
        <category>Docker</category>
      </categories>
      <tags>
        <tag>Docker</tag>
      </tags>
  </entry>
  <entry>
    <title>精通ES的单节点和集群安装</title>
    <url>/posts/ES_single_and_cluster_installation.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前有用到搜索引擎<code>Solr</code>, 当时我想上<code>ElasticSearch</code>的, 然后趁机学习下, 可是<code>Leader</code>要用<code>Solr</code>没说原因.<br>现在想来, 应该机器资源不够.<br>结果<code>Solr</code>的文章还没出来, 反而先出了<code>ElasticSearch</code>的.<br>于是现在就开始学习如何精通<code>ElasticSearch</code>, 工欲善其事必先利其器, 先来精通一下如何安装.</p>
<span id="more"></span>

<h1 id="选择-ES-版本"><a href="#选择-ES-版本" class="headerlink" title="选择 ES 版本"></a>选择 ES 版本</h1><p><a href="https://www.elastic.co/cn/support/matrix">https://www.elastic.co/cn/support/matrix</a></p>
<table>
<thead>
<tr>
<th align="center">版本</th>
<th align="center"><code>JDK8</code></th>
<th align="center"><code>JDK9</code></th>
<th align="center"><code>JDK10</code></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>5.6.x</code></td>
<td align="center">✔</td>
<td align="center">✖</td>
<td align="center">✖</td>
</tr>
<tr>
<td align="center"><code>6.0.x</code></td>
<td align="center">✔</td>
<td align="center">✖</td>
<td align="center">✖</td>
</tr>
<tr>
<td align="center"><code>6.1.x</code></td>
<td align="center">✔</td>
<td align="center">✖</td>
<td align="center">✖</td>
</tr>
<tr>
<td align="center"><code>6.2.x</code></td>
<td align="center">✔</td>
<td align="center">✔</td>
<td align="center">✖</td>
</tr>
<tr>
<td align="center"><code>6.3.x</code></td>
<td align="center">✔</td>
<td align="center">✖</td>
<td align="center">✔</td>
</tr>
</tbody></table>
<p>从官方提供的表格, 可以看到<code>6.x</code>开始, 官方将<code>JDK</code>打包到<code>ElasticSearch</code>里面了.<br>并且, <code>6.2.x</code>开始同时支持<code>JDK8</code>和<code>JDK9</code>, <code>6.3.x</code>同时支持<code>JDK8</code>和<code>JDK10</code>, 支持的版本号一路突飞猛进.<br>目前生产环境最新也才<code>JDK8</code>, 所以我这里选择了最新的<code>5.x</code>版本<code>5.6.3</code>.</p>
<h1 id="安装-ES-并在单节点启动"><a href="#安装-ES-并在单节点启动" class="headerlink" title="安装 ES 并在单节点启动"></a>安装 ES 并在单节点启动</h1><p>直接在<a href="https://www.elastic.co/downloads/elasticsearch">官网下载</a>就好了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.3.tar.gz</span><br><span class="line">tar zxvf elasticsearch-5.6.3.tar.gz</span><br><span class="line"><span class="built_in">mv</span> elasticsearch-5.6.3 elasticsearch</span><br><span class="line"><span class="built_in">cd</span> elasticsearch/</span><br><span class="line">./bin/elasticsearch</span><br><span class="line"><span class="comment"># ./bin/elasticsearch -d # 后台启动</span></span><br></pre></td></tr></table></figure>
<p>然后访问<code>http://虚拟机IP:9200</code>.<br>一般这样就可以启动了, 但是我在虚拟机里面启动的, 所以出现了各种各样的问题.</p>
<h2 id="修改-jvm-内存"><a href="#修改-jvm-内存" class="headerlink" title="修改 jvm 内存"></a>修改 jvm 内存</h2><blockquote>
<p>OpenJDK 64-Bit Server VM warning: INFO: os::commit_memory(0x0000000085330000, 2060255232, 0) failed; error=’Cannot allocate memory’ (errno=12)</p>
<p>There is insufficient memory for the Java Runtime Environment to continue.<br>Native memory allocation (mmap) failed to map 2060255232 bytes for committing reserved memory.<br>An error report file with more information is saved as:<br>/opt/elasticsearch/hs_err_pid3215.log</p>
</blockquote>
<p>可以看到, <code>JVM</code>内存不足了, 有两个建议</p>
<ol>
<li>给虚拟机加内存.</li>
<li>修改<code>-Xms</code>和<code>-Xmx</code>配置, 改小一点, 如<code>512m</code>.</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">vim config/jvm.options</span><br><span class="line"></span><br><span class="line"><span class="comment"># Xms represents the initial size of total heap space</span></span><br><span class="line"><span class="comment"># Xmx represents the maximum size of total heap space</span></span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br></pre></td></tr></table></figure>
<p>如果改了<code>JVM</code>配置还是启动不了, 就直接加虚拟机内存吧. 我后来是加了内存.</p>
<h2 id="禁止-root-用户启动"><a href="#禁止-root-用户启动" class="headerlink" title="禁止 root 用户启动"></a>禁止 root 用户启动</h2><blockquote>
<p>Caused by: java.lang.RuntimeException: can not run elasticsearch as root<br>    at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:106) ~[elasticsearch-5.6.3.jar:5.6.3]<br>    at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:195) ~[elasticsearch-5.6.3.jar:5.6.3]<br>    at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:342) ~[elasticsearch-5.6.3.jar:5.6.3]<br>    at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:132) ~[elasticsearch-5.6.3.jar:5.6.3]</p>
</blockquote>
<p>那就新建一个<code>es</code>用户就好了</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加一个 es 用户组</span></span><br><span class="line">groupadd es</span><br><span class="line"><span class="comment"># 添加一个 es 用户</span></span><br><span class="line">useradd es -g es -p es -m</span><br><span class="line"><span class="comment"># 修改 elasticsearch 目录的权限</span></span><br><span class="line"><span class="built_in">chown</span> -R es:es /opt/elasticsearch</span><br><span class="line"><span class="comment"># 切换到 es 用户, 并启动应用</span></span><br><span class="line">sudo su es</span><br><span class="line">./bin/elasticsearch</span><br></pre></td></tr></table></figure>

<h2 id="虚拟内存区域太低-vm-max-map-count"><a href="#虚拟内存区域太低-vm-max-map-count" class="headerlink" title="虚拟内存区域太低 vm.max_map_count"></a>虚拟内存区域太低 vm.max_map_count</h2><blockquote>
<p>ERROR: [1] bootstrap checks failed<br>[1]: max virtual memory areas vm.max_map_count [65530] is too low, increase to at least [262144]</p>
</blockquote>
<p><code>vm.max_map_count</code>是<code>linux</code>系统的一个配置, 限制一个进程拥有的<code>VMA</code>(虚拟内存区域)的数量.<br>不懂也没关系. 这是运维做的事, 咱们只要能跑起来就好了.<br>临时解决方案(重启失效)执行以下命令:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sysctl -w vm.max_map_count=262144</span><br></pre></td></tr></table></figure>
<p>永久配置当然是写入文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;vm.max_map_count=262144&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br></pre></td></tr></table></figure>

<h2 id="绑定-IP-允许局域网访问"><a href="#绑定-IP-允许局域网访问" class="headerlink" title="绑定 IP 允许局域网访问"></a>绑定 IP 允许局域网访问</h2><p>启动起来后, 发现浏览器访问<code>http://虚拟机IP:9200</code>失败.<br>然后在虚拟机执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://127.0.0.1:9200</span><br><span class="line"><span class="comment"># &#123;</span></span><br><span class="line"><span class="comment">#   &quot;name&quot; : &quot;oYRDx50&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;cluster_uuid&quot; : &quot;kXiVFPyvSdO-_s3zY06L3A&quot;,</span></span><br><span class="line"><span class="comment">#   &quot;version&quot; : &#123;</span></span><br><span class="line"><span class="comment">#     &quot;number&quot; : &quot;5.6.3&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;build_hash&quot; : &quot;1a2f265&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;build_date&quot; : &quot;2017-10-06T20:33:39.012Z&quot;,</span></span><br><span class="line"><span class="comment">#     &quot;build_snapshot&quot; : false,</span></span><br><span class="line"><span class="comment">#     &quot;lucene_version&quot; : &quot;6.6.1&quot;</span></span><br><span class="line"><span class="comment">#   &#125;,</span></span><br><span class="line"><span class="comment">#   &quot;tagline&quot; : &quot;You Know, for Search&quot;</span></span><br><span class="line"><span class="comment"># &#125;</span></span><br><span class="line"></span><br><span class="line">curl http://虚拟机IP:9200</span><br><span class="line"><span class="comment"># curl: (7) Failed to connect to 虚拟机IP port 9200: 拒绝连接</span></span><br></pre></td></tr></table></figure>
<p>修改配置文件, 注意这里是危险操作, 生产环境不能绑定<code>0.0.0.0</code>, 绑定内网<code>IP</code>就好了.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;network.host: 0.0.0.0&quot;</span> &gt;&gt; config/elasticsearch.yml</span><br></pre></td></tr></table></figure>

<h1 id="安装可视化插件-elasticsearch-head"><a href="#安装可视化插件-elasticsearch-head" class="headerlink" title="安装可视化插件 elasticsearch-head"></a>安装可视化插件 elasticsearch-head</h1><p>在安装<code>ElasticSearch</code>集群前, 先来安装一下这个可视化插件.<br><a href="https://github.com/mobz/elasticsearch-head"><code>elasticsearch-head</code></a>提供了一个可视化的操作页面.<br>不同<code>ElasticSearch</code>版本有不同的安装方法.<br>在<code>5.0.0</code>后, <code>ElasticSearch</code>不再支持直接安装<code>elasticsearch-head</code>插件, 所以只能单独启动<code>elasticsearch-head</code>服务器.</p>
<blockquote>
<p><a href="https://github.com/mobz/elasticsearch-head/issues/262#issuecomment-228927247">https://github.com/mobz/elasticsearch-head/issues/262#issuecomment-228927247</a></p>
</blockquote>
<p>因为要安装<code>npm</code>, 我就懒得弄了, 直接跑<code>docker</code>搞定.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -p 9100:9100 -d mobz/elasticsearch-head:5</span><br></pre></td></tr></table></figure>
<p>然后修改<code>config/elasticsearch.yml</code>, 追加<code>CORS</code>跨域配置.</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br></pre></td></tr></table></figure>
<p>然后访问<code>http://虚拟机IP:9100</code>打开控制台, 输入<code>http://虚拟机IP:9200</code>, 点击连接即可.</p>
<h1 id="安装-ES-集群"><a href="#安装-ES-集群" class="headerlink" title="安装 ES 集群"></a>安装 ES 集群</h1><p>要弄一个集群, 我们得先弄几个节点, 我们复制<code>/opt/elasticsearch</code>文件夹到<code>/opt/elasticsearch2</code>和<code>/opt/elasticsearch3</code>.<br>记得先删除里面的<code>data</code>目录, 否则会出现错误<code>failed to send join request to master</code>.</p>
<p>先设置个<code>master</code>节点, 修改<code>/opt/elasticsearch/config/elasticsearch.yml</code>.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 支持跨域访问, 供 head 使用</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">9200</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 设置集群名称</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">ahao-cluster</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 设置节点名, 以及确定主节点</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">ahao-master</span></span><br><span class="line"><span class="attr">node.master:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>然后设置两个<code>slave</code>节点, 同样修改<code>config/elasticsearch.yml</code>, 记得修改端口号, 避免端口冲突.</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 支持跨域访问, 供 head 使用</span></span><br><span class="line"><span class="attr">http.cors.enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">http.cors.allow-origin:</span> <span class="string">&quot;*&quot;</span></span><br><span class="line"><span class="attr">http.port:</span> <span class="number">8200</span></span><br><span class="line"><span class="attr">network.host:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 设置集群名称</span></span><br><span class="line"><span class="attr">cluster.name:</span> <span class="string">ahao-cluster</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 设置节点名, 以及确定主节点地址</span></span><br><span class="line"><span class="attr">node.name:</span> <span class="string">ahao-node1</span></span><br><span class="line"><span class="attr">discovery.zen.ping.unicast.hosts:</span> [<span class="string">&quot;127.0.0.1&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>然后都启动起来</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">/opt/elasticsearch/bin/elasticsearch -d</span><br><span class="line">/opt/elasticsearch2/bin/elasticsearch -d</span><br><span class="line">/opt/elasticsearch3/bin/elasticsearch -d</span><br></pre></td></tr></table></figure>
<p>过一段时间, 启动完毕, 访问<code>http://虚拟机IP:9100</code>打开<code>head</code>控制台, 连接到任意一个节点, 就可以获取整个集群的信息.</p>
]]></content>
      <categories>
        <category>ElasticSearch</category>
      </categories>
      <tags>
        <tag>ElasticSearch</tag>
      </tags>
  </entry>
  <entry>
    <title>东方STG混关攻略</title>
    <url>/posts/Touhou_project_game_plan.html</url>
    <content><![CDATA[<h1 id="东方风神录"><a href="#东方风神录" class="headerlink" title="东方风神录"></a>东方风神录</h1><p>混关攻略视频(未收卡): <a href="https://www.bilibili.com/video/av3769788">https://www.bilibili.com/video/av3769788</a><br><strong>风神的神德 符卡收法</strong><br>蓝绿  中间往右<br>青红  中间往右<br>紫蓝  中间往左<br>蓝绿  左边往左上穿</p>
<span id="more"></span>

<h1 id="东方星莲船"><a href="#东方星莲船" class="headerlink" title="东方星莲船"></a>东方星莲船</h1><p>混关攻略视频: <a href="https://www.bilibili.com/video/av6570060">https://www.bilibili.com/video/av6570060</a><br>开碟顺序</p>
<ol>
<li>红 彩（红蓝绿） 红 绿 2绿碎片</li>
<li>绿（2绿碎片）绿 绿 红（炸） 红 1红碎片</li>
<li>红（1红碎片）绿 绿 红（炸） 绿 1绿碎片</li>
<li>绿（1绿碎片）彩（绿红蓝）绿 红（蓝左红右） 蓝 绿（炸折返）红（炸）绿（炸）绿（炸）2绿碎片</li>
<li>绿（2绿碎片，炸）绿 绿（炸？）绿 绿 红 蓝 1绿碎片</li>
<li>绿（1绿碎片） （炸）绿 绿 红 蓝 绿</li>
</ol>
]]></content>
      <categories>
        <category>游戏</category>
      </categories>
      <tags>
        <tag>东方project</tag>
      </tags>
  </entry>
  <entry>
    <title>上古卷轴5之寻找消失的Revus Sarvani</title>
    <url>/posts/How_to_find_Revus_Sarvani.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在上古卷轴<code>5</code>天际龙裔<code>DLC</code>所在的索瑟海姆<code>Solstheim</code>，有<code>3</code>个隐藏任务。</p>
<ol>
<li>召唤巨人卡斯塔<code>Karstaag</code></li>
<li>偷取<code>Falas Selvayn</code>的雄鹿王子之玻璃弓<code>Glass Bow of the Stag Prince</code></li>
<li>收集<code>5</code>个卡古梅兹共振宝石<code>Kagrumez Resonance Gem</code></li>
</ol>
<p>当我在完成卡古梅兹共振宝石的任务时，最后一颗宝石却怎么也找不到。<br>这里记录下怎么拿到沙瓦尼<code>Revus Sarvani</code>的那颗卡古梅兹共振宝石<code>Kagrumez Resonance Gem</code>。</p>
<span id="more"></span>

<h1 id="Revus-Sarvani-的位置"><a href="#Revus-Sarvani-的位置" class="headerlink" title="Revus Sarvani 的位置"></a>Revus Sarvani 的位置</h1><p>沙瓦尼<code>Revus Sarvani</code>就在泰尔密希临<code>Tel Mithryn</code>左上角不远处，有一个很显眼的阔步沙蚤<code>Dusty</code>，旁边有一个营地，沙瓦尼<code>Revus Sarvani</code>就在这里。<br>找他购买一个卡古梅兹共振宝石<code>Kagrumez Resonance Gem</code>即可。</p>
<img data-src="/posts/How_to_find_Revus_Sarvani/01.png" class="">

<h1 id="找不到Revus-Sarvani"><a href="#找不到Revus-Sarvani" class="headerlink" title="找不到Revus Sarvani"></a>找不到Revus Sarvani</h1><p>最大的可能就是他被杀了，葬身荒郊野岭。<br>为什么呢?<br>首先米拉克<code>Miraak</code>没被打倒前，营地对岸会有一个潜伏者维护者<code>Lurker Vindicator</code>，这个几乎是陆地最强近战兵种。<br>另外，营地附近会刷出几只灰烬魔<code>Ash Spawn</code>。<br>还有，泰尔密希临<code>Tel Mithryn</code>的管家任务，管家会被几只灰烬魔<code>Ash Spawn</code>杀死，这个地点也在营地附近。</p>
<p>综上，这附近是非常危险的，沙瓦尼<code>Revus Sarvani</code>基本不可能存活太久。<br>所以对于老手，上岛第一件事，就应该是去买卡古梅兹共振宝石<code>Kagrumez Resonance Gem</code>。</p>
<img data-src="/posts/How_to_find_Revus_Sarvani/02.png" class="">

<h1 id="死者苏生——复活Revus-Sarvani"><a href="#死者苏生——复活Revus-Sarvani" class="headerlink" title="死者苏生——复活Revus Sarvani"></a>死者苏生——复活Revus Sarvani</h1><p>怎么确定他死了呢?<br>网上有说，在控制台输入<code>coc wideadbodycleanupcell</code>，进入一个墓地空间，可以看到死去<code>NPC</code>的尸体，但是我没找到沙瓦尼<code>Revus Sarvani</code>的尸体。</p>
<p>我们换个思路，在控制台输入<code>player.moveto xx02C1EA</code>，<strong>将自己移动到<code>NPC</code>旁边</strong>。<br>从<a href="https://en.uesp.net/wiki/Dragonborn:Revus_Sarvani"><code>wiki</code></a> 上可以看到沙瓦尼<code>Revus Sarvani</code>的代码就是<code>xx02C1EA</code>。<br>这个<code>xx</code>一般是<code>00</code>、<code>01</code>、<code>02</code>、<code>03</code>、<code>04</code>。 我这边是<code>04</code>，也就是<code>player.moveto 0402C1EA</code>。<br>不想猜的话，可以进泰尔密希临<code>Tel Mithryn</code>，打开控制台，点击任意一个<code>NPC</code>，就可以看到<code>ID</code>的前缀了。</p>
<p>如果前缀猜错，就会报错<code>Invalid</code>。</p>
<p>输入完毕后，我们会移动到阔步沙蚤<code>Dusty</code>的营地旁边。<br>接下来我们发送<strong>魔法卡——死者苏生</strong></p>
<img data-src="/posts/How_to_find_Revus_Sarvani/03.png" class="">
<p>在控制台输入以下两条指令，锁定该人物，复活。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">prid xx02C1EA</span><br><span class="line">resurrect</span><br></pre></td></tr></table></figure>
<p>这样沙瓦尼<code>Revus Sarvani</code>就复活了，和他进行交易吧。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://en.uesp.net/wiki/Dragonborn:Revus_Sarvani">Dragonborn: Revus Sarvani</a></li>
<li><a href="https://www.reddit.com/r/skyrim/comments/18xju7/someone_i_cant_find_in_dragonborn/">someone_i_cant_find_in_dragonborn</a></li>
</ul>
]]></content>
      <categories>
        <category>游戏</category>
      </categories>
      <tags>
        <tag>上古卷轴5</tag>
      </tags>
  </entry>
  <entry>
    <title>使用ASF为Steam挂卡</title>
    <url>/posts/Using_ASF_for_Steam_Idling_Card.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>ASF</code>不只是一个挂卡工具，更像是一个命令行模式下的一个<code>Steam</code>客户端。<br>自己用的话就在<code>Win</code>上操作即可，多人最好还是丢服务器挂。</p>
<span id="more"></span>

<h1 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h1><h2 id="第一步-下载"><a href="#第一步-下载" class="headerlink" title="第一步 下载"></a>第一步 下载</h2><p>下载最新的<a href="https://github.com/JustArchiNET/ArchiSteamFarm/releases/latest"><code>ASF</code>软件</a></p>
<h2 id="第二步-建目录"><a href="#第二步-建目录" class="headerlink" title="第二步 建目录"></a>第二步 建目录</h2><p>建立易懂的层级目录结构</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">C:\ASF (放置您所有与 ASF 相关的东西)</span><br><span class="line">    ├── ASF    ( /Core/ArchiSteamFarm.exe 的快捷方式)              ──┐</span><br><span class="line">    ├── config ( /Core/config             的快捷方式)              ──┤</span><br><span class="line">    ├── ...                                                         |</span><br><span class="line">    └── Core (下载解压后的文件都放在这里面)                            |</span><br><span class="line">         ├── ArchiSteamFarm.exe  ───────────────────────────────────┤</span><br><span class="line">         ├── config              ───────────────────────────────────┘</span><br><span class="line">         └── (...)</span><br></pre></td></tr></table></figure>
<p>主要就是建立两个快捷方式，方便使用。</p>
<h2 id="第三步-配置"><a href="#第三步-配置" class="headerlink" title="第三步 配置"></a>第三步 配置</h2><p>打开以下链接获取自己的<code>64</code>位<code>SteamID</code>，将<code>Ahaochan</code>换成自己的<code>Steam</code>个人资料链接即可。<br><code>https://steamrep.com/search?q=https://steamcommunity.com/id/Ahaochan/</code></p>
<p>在<code>/config</code>目录下创建<code>ASF.json</code>，填写自己的<code>SteamID</code>，用于允许执行命令。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;s_SteamOwnerID&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1234567890&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;IPC&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>创建<code>Ahaochan.json</code>，填写账号密码。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;SteamLogin&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Steam账户名&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;SteamPassword&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Steam密码&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;CustomGamePlayedWhileFarming&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Idling cards&quot;</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="第四步"><a href="#第四步" class="headerlink" title="第四步"></a>第四步</h2><p>打开<code>ASF</code>即可愉快地进行挂卡了，如果有两步验证，则每次都要输入两步验证密码。</p>
<h1 id="两步验证解决方案"><a href="#两步验证解决方案" class="headerlink" title="两步验证解决方案"></a>两步验证解决方案</h1><p>如果开了两步验证，每次登陆都要打开手机翻密码再输入，太麻烦了。</p>
<p>如果你在<code>Android</code>上安装了<code>Steam</code>官方的验证器（<strong>这是前提</strong><br>复制<code>Android</code>手机的<code>/data/data/com.valvesoftware.android.steam.community</code>目录到<code>PC</code>上。</p>
<ol>
<li>打开<code>shared_prefs/steam.uuid.xml</code>，记录下里面的<code>uuid</code>。</li>
<li>复制<code>files/Steamguard-$&#123;SteamID&#125;</code>到电脑<code>C:\ASF\config</code>目录下，并更名为<code>Ahaochan.maFile</code>。</li>
<li>打开<code>ASF</code>，要求输入<code>uuid</code>时，就输入（我没输入就成功了</li>
</ol>
<h1 id="为ASF开启代理"><a href="#为ASF开启代理" class="headerlink" title="为ASF开启代理"></a>为ASF开启代理</h1><blockquote>
<p>Right now ASF uses web proxy only for http and https requests,<br>which do not include internal Steam network communication done within ASF’s internal Steam client.</p>
<p><a href="https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Configuration#webproxy">https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Configuration#webproxy</a></p>
</blockquote>
<p>简单的说，就是不支持<code>socks5</code>代理。 那我也不研究了。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://github.com/JustArchiNET/ArchiSteamFarm/wiki/Setting-up-zh-CN">官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>游戏</category>
      </categories>
      <tags>
        <tag>Steam</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo中Next主题最新版本的微信公众号引流教程</title>
    <url>/posts/hexo_next_last_how_drainage_to_wechat_channel.html</url>
    <content><![CDATA[<h1 id="重拾博客"><a href="#重拾博客" class="headerlink" title="重拾博客"></a>重拾博客</h1><p>很久没有分享博客了，也是最近比较忙的原因。这几天对博客代码重构了一下，主要针对以下几点</p>
<ol>
<li>搭建本地<code>NodeJs</code>环境</li>
<li>优化<code>Github Action</code>自动化构建流程</li>
<li>调整<code>post</code>目录下的文章目录结构</li>
<li>开了一个公众号，逆向分析并修改<code>readMore</code>脚本，引流到公众号</li>
</ol>
<span id="more"></span>

<h1 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h1><p>为了宣传我的公众号，我参考 <a href="https://gylq.gitee.io/posts/137.html">【知识积累】Hexo中next主题微信引流教程</a> 这篇文章进行配置。<br>但是过程中遇到了一个问题，我博客的<code>Next</code>主题似乎太新了，是<code>v8</code>版本的。因此带来了几个问题</p>
<ol>
<li>最新版的<code>Next</code>主题将<code>_layout.swig</code>改为了<code>_layout.njk</code></li>
<li><code>Next</code>在主题配置文件里支持了<code>custom_file_path</code>属性, 不需要再修改<code>_layout.njk</code></li>
<li><code>&lt;div id=&quot;content&quot;&gt;</code>不存在, 这里要修改原来的<code>readmore.js</code>的注入方式</li>
</ol>
<p>迫于网上答案过于陈旧，我这里重新再梳理下<code>v8</code>版本的<code>Next</code>主题要怎么使用<code>readmore.js</code>脚本。<br>这个思路可用于其他主题的适配。<del>（必可活用于下次</del></p>
<img data-src="/posts/hexo_next_last_how_drainage_to_wechat_channel/01.png" class="">

<h1 id="自定义模块页面"><a href="#自定义模块页面" class="headerlink" title="自定义模块页面"></a>自定义模块页面</h1><p><code>Next</code>主题的 <a href="https://github.com/next-theme/hexo-theme-next/blob/v8.8.2/_config.yml#L21-L31">主题配置文件</a> 里已经提供了扩展点</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">custom_file_path:</span></span><br><span class="line">  <span class="attr">footer:</span> <span class="string">source/_data/footer.njk</span></span><br></pre></td></tr></table></figure>
<p>我们修改完主题配置文件后, 在<code>source/_data</code>目录下创建一个<code>footer.njk</code>文件.<br>在里面填上<code>script</code>脚本</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&#123;% if page.comments %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;/js/readmore.js&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--&lt;script src=&quot;https://readmore.openwrite.cn/js/readmore.js&quot; type=&quot;text/javascript&quot;&gt;&lt;/script&gt;--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">const</span> btw = <span class="keyword">new</span> <span class="title class_">BTWPlugin</span>();</span></span><br><span class="line"><span class="language-javascript">    btw.<span class="title function_">init</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">id</span>: <span class="string">&#x27;container&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">blogId</span>: <span class="string">&#x27;30660-1666263355112-307&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">name</span>: <span class="string">&#x27;岁寒的编程随想&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">qrcode</span>: <span class="string">&#x27;https://blog.ahao.moe/images/config/wechat_channel.jpg&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">keyword</span>: <span class="string">&#x27;more&#x27;</span>,</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br></pre></td></tr></table></figure>

<h1 id="反混淆魔改readmore脚本"><a href="#反混淆魔改readmore脚本" class="headerlink" title="反混淆魔改readmore脚本"></a>反混淆魔改readmore脚本</h1><p>从上面那套<code>js</code>语法可以猜测出<code>readmore</code>的遮罩层，是根据<code>id</code>为<code>container</code>的<code>DOM</code>元素进行定位操作的。<br>但是我们发现<code>v8</code>版本的文章部分已经没有<code>id</code>这个属性了</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;main-inner &#123;% block class %&#125;&#123;% endblock %&#125;&quot;</span>&gt;</span></span><br><span class="line">  &#123;%- include &#x27;_partials/header/sub-menu.njk&#x27; -%&#125;</span><br><span class="line">  &#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line">  &#123;%- include &#x27;_partials/comments.njk&#x27; -%&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里的<code>&#123;% block content %&#125;&#123;% endblock %&#125;</code>语法，其实就是将<code>themes/next/layout/_macro/post.njk</code>这个文件引进来。</p>
<img data-src="/posts/hexo_next_last_how_drainage_to_wechat_channel/02.png" class="">
<p>这个<code>&lt;article&gt;</code>就是文章的主要区域, 我们目标是<code>div.post-block</code>。</p>
<p>在<code>source/js</code>目录下创建一个<code>readmore.js</code>文件，将 <a href="https://readmore.openwrite.cn/js/readmore.js">原始<code>readmore.js</code></a> 的内容复制进去, 并格式化。<br>原始的<code>readmore.js</code>是经过混淆加密的，我们先借助<code>IDE</code>进行格式化.<br>然后找到我们熟悉的<code>init</code>初始化方法，加上<code>debugger</code>断点</p>
<img data-src="/posts/hexo_next_last_how_drainage_to_wechat_channel/03.png" class="">
<p>可以看到这里是通过<code>jQuery</code>的<code>$(&#39;#container&#39;)</code>定位的, 那就简单了, 直接把这一行替换成以下代码即可</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">_0x77ddx3 = $(<span class="string">&#x27;div.post-block&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p>思路就是这样，如果你的主题不是<code>Next v8</code>，那么也是修改这行代码，取想要<code>hack</code>的元素即可。</p>
<h1 id="微信公众号的配置"><a href="#微信公众号的配置" class="headerlink" title="微信公众号的配置"></a>微信公众号的配置</h1><p>剩下的公众号配置就按照<code>openwrite</code>的教程来处理就可以了，这里不再赘诉<br><a href="https://openwrite.cn/guide/readmore/readmore.html">https://openwrite.cn/guide/readmore/readmore.html</a></p>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>想了想，最后还是没有强制引流到公众号。有感兴趣的就点击下面的微信公众号或者<code>RSS</code>订阅吧。</p>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>你必须知道的Markdown高级用法汇总</title>
    <url>/posts/advanced_usage_of_Markdown.html</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><a href="http://daringfireball.net/projects/markdown/">Markdown</a> 作为一种网络书写语言，特别适合程序员书写文档：</p>
<ul>
<li>全文本格式，方便进行<code>diff</code>，<code>patch</code>和版本的管理；</li>
<li>格式直观，简单易学，便于书写和阅读；</li>
<li>兼容 <code>HTML</code>，能方便地转换为 <code>pdf</code>，<code>doc</code>等格式；</li>
<li>支持 <code>Linux</code>，<code>Windows</code>，<code>Mac</code>；</li>
<li>支持内嵌代码和语法高亮；</li>
</ul>
<span id="more"></span>

<p>本文的目标读者是对<code>Markdown</code>有一定了解的群体，能简单书写<code>Markdown</code>笔记</p>
<h1 id="通过-plantuml-编程式插入UML图片"><a href="#通过-plantuml-编程式插入UML图片" class="headerlink" title="通过 plantuml 编程式插入UML图片"></a>通过 <a href="https://plantuml.com/zh/"><code>plantuml</code></a> 编程式插入<code>UML</code>图片</h1><p><code>yuml.me</code>只适用于简单的<code>UML</code>图片生成，如果是比较复杂的<code>UML</code>，那么响应的描述预言挤在<code>url</code>里，会导致<code>url</code>特别长。而浏览器的<code>url</code><a href="https://stackoverflow.com/questions/417142">长度是有限制的</a></p>
<p>在<code>Markdown</code>里使用<code>plantuml</code>绘图，需要<code>IDE</code>的支持。</p>
<h2 id="IDEA支持UML"><a href="#IDEA支持UML" class="headerlink" title="IDEA支持UML"></a><code>IDEA</code>支持<code>UML</code></h2><p>我使用的是<code>Intellij IDEA</code>进行编辑。<code>IDEA</code>现在有个关于<code>Markdown</code>的<a href="https://youtrack.jetbrains.com/issue/IDEA-285306"><code>Bug IDEA-285306</code></a>` ，还没标记为修复。</p>
<blockquote>
</blockquote>
<p>第一步，打开<code>plantuml</code>的配置，<code>File-&gt;Settings-&gt;Language &amp; Frameworks -&gt; Markdown -&gt; plantuml</code></p>
<img data-src="/posts/advanced_usage_of_Markdown/01.png" class="">

<p>第二步，下载 <a href="https://github.com/plantuml/plantuml/releases/tag/v1.2021.16"><code>plantuml-1.2021.16.jar</code></a> ，改名为<code>plantuml.jar</code>。<br>拷贝到<code>IDEA</code>的数据目录<code>%LOCALAPPDATA%\JetBrains\IntelliJIdea2021.3</code>里面的<code>download-cache\plantuml</code>目录下。</p>
<p>第三步，重启<code>IDEA</code>即可。</p>
<p>如果还有问题，可以参考下<a href="https://youtrack.jetbrains.com/issue/IDEA-285306"><code>IDEA-285306</code></a></p>
<h2 id="Hexo支持plantuml"><a href="#Hexo支持plantuml" class="headerlink" title="Hexo支持plantuml"></a><code>Hexo</code>支持<code>plantuml</code></h2><p>不止编辑器预览需要支持<code>plantuml</code>，渲染到<code>hexo</code>博客上也需要支持<code>plantuml</code>。<br>我们安装依赖<a href="https://github.com/miao1007/hexo-filter-plantuml"><code>hexo-filter-plantuml</code></a><br>然后编写<code>plantuml</code>语法即可。</p>
<img data-src="/posts/advanced_usage_of_Markdown/02.png" class="">

<img data-src='data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiBjb250ZW50U3R5bGVUeXBlPSJ0ZXh0L2NzcyIgaGVpZ2h0PSIyMDhweCIgcHJlc2VydmVBc3BlY3RSYXRpbz0ibm9uZSIgc3R5bGU9IndpZHRoOjI5NXB4O2hlaWdodDoyMDhweDtiYWNrZ3JvdW5kOiNGRkZGRkY7IiB2ZXJzaW9uPSIxLjEiIHZpZXdCb3g9IjAgMCAyOTUgMjA4IiB3aWR0aD0iMjk1cHgiIHpvb21BbmRQYW49Im1hZ25pZnkiPjxkZWZzLz48Zz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjAuNTtzdHJva2UtZGFzaGFycmF5OjUuMCw1LjA7IiB4MT0iMjkiIHgyPSIyOSIgeTE9IjM2LjI5NjkiIHkyPSIxNzIuODI4MSIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41O3N0cm9rZS1kYXNoYXJyYXk6NS4wLDUuMDsiIHgxPSIyNjciIHgyPSIyNjciIHkxPSIzNi4yOTY5IiB5Mj0iMTcyLjgyODEiLz48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ5IiB4PSI1IiB5PSI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMzUiIHg9IjEyIiB5PSIyNC45OTUxIj5BbGljZTwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQ5IiB4PSI1IiB5PSIxNzEuODI4MSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjM1IiB4PSIxMiIgeT0iMTkxLjgyMzIiPkFsaWNlPC90ZXh0PjxyZWN0IGZpbGw9IiNFMkUyRjAiIGhlaWdodD0iMzAuMjk2OSIgcng9IjIuNSIgcnk9IjIuNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDowLjU7IiB3aWR0aD0iNDMiIHg9IjI0NiIgeT0iNSIvPjx0ZXh0IGZpbGw9IiMwMDAwMDAiIGZvbnQtZmFtaWx5PSJzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBsZW5ndGhBZGp1c3Q9InNwYWNpbmciIHRleHRMZW5ndGg9IjI5IiB4PSIyNTMiIHk9IjI0Ljk5NTEiPkJvYjwvdGV4dD48cmVjdCBmaWxsPSIjRTJFMkYwIiBoZWlnaHQ9IjMwLjI5NjkiIHJ4PSIyLjUiIHJ5PSIyLjUiIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MC41OyIgd2lkdGg9IjQzIiB4PSIyNDYiIHk9IjE3MS44MjgxIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTQiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjkiIHg9IjI1MyIgeT0iMTkxLjgyMzIiPkJvYjwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1NS41LDYzLjQyOTcsMjY1LjUsNjcuNDI5NywyNTUuNSw3MS40Mjk3LDI1OS41LDY3LjQyOTciIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIvPjxsaW5lIHN0eWxlPSJzdHJva2U6IzE4MTgxODtzdHJva2Utd2lkdGg6MS4wOyIgeDE9IjI5LjUiIHgyPSIyNjEuNSIgeTE9IjY3LjQyOTciIHkyPSI2Ny40Mjk3Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTUwIiB4PSIzNi41IiB5PSI2Mi4zNjM4Ij5BdXRoZW50aWNhdGlvbiBSZXF1ZXN0PC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDAuNSw5Mi41NjI1LDMwLjUsOTYuNTYyNSw0MC41LDEwMC41NjI1LDM2LjUsOTYuNTYyNSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjM0LjUiIHgyPSIyNjYuNSIgeTE9Ijk2LjU2MjUiIHkyPSI5Ni41NjI1Ii8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMTYwIiB4PSI0Ni41IiB5PSI5MS40OTY2Ij5BdXRoZW50aWNhdGlvbiBSZXNwb25zZTwvdGV4dD48cG9seWdvbiBmaWxsPSIjMTgxODE4IiBwb2ludHM9IjI1NS41LDEyMS42OTUzLDI2NS41LDEyNS42OTUzLDI1NS41LDEyOS42OTUzLDI1OS41LDEyNS42OTUzIiBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiLz48bGluZSBzdHlsZT0ic3Ryb2tlOiMxODE4MTg7c3Ryb2tlLXdpZHRoOjEuMDsiIHgxPSIyOS41IiB4Mj0iMjYxLjUiIHkxPSIxMjUuNjk1MyIgeTI9IjEyNS42OTUzIi8+PHRleHQgZmlsbD0iIzAwMDAwMCIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iMTMiIGxlbmd0aEFkanVzdD0ic3BhY2luZyIgdGV4dExlbmd0aD0iMjA0IiB4PSIzNi41IiB5PSIxMjAuNjI5NCI+QW5vdGhlciBhdXRoZW50aWNhdGlvbiBSZXF1ZXN0PC90ZXh0Pjxwb2x5Z29uIGZpbGw9IiMxODE4MTgiIHBvaW50cz0iNDAuNSwxNTAuODI4MSwzMC41LDE1NC44MjgxLDQwLjUsMTU4LjgyODEsMzYuNSwxNTQuODI4MSIgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7Ii8+PGxpbmUgc3R5bGU9InN0cm9rZTojMTgxODE4O3N0cm9rZS13aWR0aDoxLjA7c3Ryb2tlLWRhc2hhcnJheToyLjAsMi4wOyIgeDE9IjM0LjUiIHgyPSIyNjYuNSIgeTE9IjE1NC44MjgxIiB5Mj0iMTU0LjgyODEiLz48dGV4dCBmaWxsPSIjMDAwMDAwIiBmb250LWZhbWlseT0ic2Fucy1zZXJpZiIgZm9udC1zaXplPSIxMyIgbGVuZ3RoQWRqdXN0PSJzcGFjaW5nIiB0ZXh0TGVuZ3RoPSIyMTQiIHg9IjQ2LjUiIHk9IjE0OS43NjIyIj5Bbm90aGVyIGF1dGhlbnRpY2F0aW9uIFJlc3BvbnNlPC90ZXh0PjwhLS1NRDU9W2E5NzAyYzkyODBkYmJhOTUzMGVlODEwOTZmZTliNmE1XQpAc3RhcnR1bWwNCkFsaWNlIC0+IEJvYjogQXV0aGVudGljYXRpb24gUmVxdWVzdA0KQm9iIC0gLT4gQWxpY2U6IEF1dGhlbnRpY2F0aW9uIFJlc3BvbnNlDQoNCkFsaWNlIC0+IEJvYjogQW5vdGhlciBhdXRoZW50aWNhdGlvbiBSZXF1ZXN0DQpBbGljZSA8LSAtIEJvYjogQW5vdGhlciBhdXRoZW50aWNhdGlvbiBSZXNwb25zZQ0KQGVuZHVtbA0KClBsYW50VU1MIHZlcnNpb24gMS4yMDIyLjEzYmV0YTgoVW5rbm93biBjb21waWxlIHRpbWUpCihHUEwgc291cmNlIGRpc3RyaWJ1dGlvbikKSmF2YSBSdW50aW1lOiBKYXZhKFRNKSBTRSBSdW50aW1lIEVudmlyb25tZW50CkpWTTogSmF2YSBIb3RTcG90KFRNKSA2NC1CaXQgU2VydmVyIFZNCkRlZmF1bHQgRW5jb2Rpbmc6IFVURi04Ckxhbmd1YWdlOiBlbgpDb3VudHJ5OiBVUwotLT48L2c+PC9zdmc+'>

<h1 id="使用LaTeX语法编写数学公式"><a href="#使用LaTeX语法编写数学公式" class="headerlink" title="使用LaTeX语法编写数学公式"></a>使用<code>LaTeX</code>语法编写数学公式</h1><p>在线生成图片的网站: <a href="https://latex.codecogs.com/eqneditor/editor.php?lang=zh-cn"><code>latex.codecogs.com</code></a></p>
<p>比如<code>https://latex.codecogs.com/gif.latex?x^&#123;2&#125;+y^&#123;2&#125;=z^&#123;2&#125;</code>，就可以得到下面的数学公式图片<br><img data-src="https://latex.codecogs.com/gif.latex?x%5E%7B2%7D+y%5E%7B2%7D=z%5E%7B2%7D"> </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://xiaocong.github.io/blog/2013/04/22/writing-development-documentation-with-markdown/">在 Markdown 中嵌入 UML 文档</a></li>
</ul>
]]></content>
      <categories>
        <category>工具</category>
      </categories>
      <tags>
        <tag>Markdown</tag>
        <tag>UML</tag>
      </tags>
  </entry>
  <entry>
    <title>Hexo多图并排显示</title>
    <url>/posts/Hexo_multiple_images_side_by_side.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Hexo有时候需要进行多图并排显示对比。<br>fancybox默认一张图占据一行。需要自己修改Css样式。<br><del>本文默认使用<a href="https://github.com/gyk001/hexo-qiniu-sync">七牛云插件</a>。</del><br>测试域名被收回了, 再次感受到国内开发者巨大的政策风险。</p>
<span id="more"></span>

<style type="text/css">
    .fancybox {
        display: inline-block;
    }
</style>

<h1 id="插入Css样式"><a href="#插入Css样式" class="headerlink" title="插入Css样式"></a>插入Css样式</h1><p>在<code>&lt;!-- more --&gt;</code>之后插入样式, 避免将样式写入<code>description</code>。<br>注意, 因为渲染问题, 请尽量使用回车隔离以下代码块。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-class">.fancybox</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">display</span>: inline-block;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% img /images/最短路径_01.png 200 %&#125;</span><br><span class="line">&#123;% img /images/最短路径_02.png 200 %&#125;</span><br></pre></td></tr></table></figure>

<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_01.png" class="" width="200">
<img data-src="/images/%E6%9C%80%E7%9F%AD%E8%B7%AF%E5%BE%84_02.png" class="" width="200">]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>TravisCI加密配置文件并自动部署Hexo</title>
    <url>/posts/TravisCI_encrypts_configuration_files_and_automatically_deploys_Hexo.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><a href="https://travis-ci.org/">Travis-CI</a>是一个可以将<code>Github</code>上的代码做持续集成的网站。<br>持续集成和版本控制相关联, <code>Git</code>就是一种版本控制, 可以提交, 也可以下载, 就像网盘一样。<br>持续集成就是你的每一次提交上传, 服务器都会自动对你提交后的代码进行编译, 单元测试等一系列行为, 并告知你是否成功。</p>
<span id="more"></span>

<h1 id="阅读条件"><a href="#阅读条件" class="headerlink" title="阅读条件"></a>阅读条件</h1><ol>
<li>至少一次手动<code>hexo d</code>部署过<code>GitHub Page</code>博客</li>
<li>熟悉Linux基本命令</li>
<li>熟练Git基本命令</li>
</ol>
<h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><h2 id="准备虚拟机"><a href="#准备虚拟机" class="headerlink" title="准备虚拟机"></a>准备虚拟机</h2><ol>
<li><p>使用的是<code>CentOS7</code>虚拟机, 用户名<code>root</code>, 密码<code>root</code></p>
</li>
<li><p>网络连接选择<strong>桥接</strong>模式, 关于桥接模式可以看我的另一篇文章。</p>
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_01.png" class=""></li>
<li><p><code>Windows</code>网络环境选择专用网络</p>
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_02.png" class=""></li>
<li><p><code>Windows10</code>需要在网络适配器属性界面, 添加<code>VMware Bridge Protocol</code>协议。</p>
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_03.png" class=""></li>
<li><p>使用<a href="https://www.netsarang.com/products/xsh_overview.html">Xshell</a>(发送命令)和<a href="https://filezilla-project.org/">FileZilla</a>(传输文件)在<code>Windows</code>上连接虚拟机. 两者都是通过<code>ssh</code>连接的, 在软件中配置好虚拟机的<code>IP</code>地址和账号密码<code>root</code>即可。</p>
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_04.png" class="">
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_05.png" class="">
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_06.png" class=""></li>
</ol>
<h2 id="准备Travis-CI帐号"><a href="#准备Travis-CI帐号" class="headerlink" title="准备Travis-CI帐号"></a>准备Travis-CI帐号</h2><p><a href="https://travis-ci.org/">Travis-CI</a>支持<code>GitHub</code>帐号登录。<br>配置教程参考<a href="https://segmentfault.com/a/1190000009054888#articleHeader1">使用 Travis 自动部署 Hexo 到 Github 与 自己的服务器</a></p>
<h2 id="准备Git并clone"><a href="#准备Git并clone" class="headerlink" title="准备Git并clone"></a>准备Git并clone</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 修改yum源 为 网易源</span></span><br><span class="line">yum install -y wget</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.163.com/.help/CentOS7-Base-163.repo</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line"><span class="comment"># 2. 安装git</span></span><br><span class="line">yum install -y git</span><br><span class="line"><span class="comment"># 3. 配置git</span></span><br><span class="line">git config --global user.name <span class="string">&quot;Ahaochan&quot;</span></span><br><span class="line">git config --global user.email <span class="string">&quot;844394093@qq.com&quot;</span></span><br><span class="line"><span class="comment"># 3. clone项目到/opt文件夹下</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Ahaochan/Ahaochan.github.io.git</span><br><span class="line"><span class="built_in">cd</span> Ahaochan.github.io/</span><br><span class="line"><span class="comment"># 4. 新建并切换到source分支</span></span><br><span class="line">git branch <span class="built_in">source</span></span><br><span class="line">git checkout <span class="built_in">source</span></span><br><span class="line"><span class="comment"># 5. 删除所有文件, 为hexo源文件腾出位置</span></span><br><span class="line"><span class="built_in">rm</span> -rf *</span><br></pre></td></tr></table></figure>

<h2 id="准备Travis-CI-客户端"><a href="#准备Travis-CI-客户端" class="headerlink" title="准备Travis-CI 客户端"></a>准备Travis-CI 客户端</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装gcc和ruby环境</span></span><br><span class="line">yum install -y gcc ruby ruby-devel</span><br><span class="line"><span class="comment"># 2. 改为国内gem源</span></span><br><span class="line">gem sources --add https://gems.ruby-china.com/ --remove https://rubygems.org/ </span><br><span class="line"><span class="comment"># 3. 安装Travis</span></span><br><span class="line">gem install travis</span><br><span class="line"><span class="comment"># 4. 登录Travis, 并输入账号密码, 注意使用的是 travis-ci.org 或 travis-ci.com</span></span><br><span class="line"><span class="comment">#    org 现在已迁移到 com, 发送标题 Open Source Migration Beta Testing 邮件到 support@travis-ci.com 即可开通 Beta 迁移功能.</span></span><br><span class="line"><span class="comment">#    https://docs.travis-ci.com/user/migrate/open-source-on-travis-ci-com/#existing-open-source-repositories-on-travis-ciorg</span></span><br><span class="line">travis login --com</span><br></pre></td></tr></table></figure>

<h2 id="将本地的hexo移动到服务器"><a href="#将本地的hexo移动到服务器" class="headerlink" title="将本地的hexo移动到服务器"></a>将本地的hexo移动到服务器</h2><p><strong>请确保服务器的项目分支已经切换到<code>source</code></strong><br>通过<a href="https://filezilla-project.org/">FileZilla</a>将本地的<code>hexo</code>文件夹部署到服务器。<br>为了节省<code>GitHub</code>空间, 我只将以下文件加入仓库中。</p>
<img data-src="/images/TravisCI%E5%8A%A0%E5%AF%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%B9%B6%E8%87%AA%E5%8A%A8%E9%83%A8%E7%BD%B2Hexo_07.png" class="">

<h1 id="加密next-yml"><a href="#加密next-yml" class="headerlink" title="加密next.yml"></a>加密next.yml</h1><p>我将<code>hexo/_config.yml</code>和<code>theme/next/_config.yml</code>的内容统一复制到<code>source/_data/next.yml</code>中。<br>配置文件包含太多敏感信息, 所以我进行了加密.<br><code>Travis-CI</code>提供了加密策略, 只要加密后, 就只有<code>Travis-CI</code>能解密, 就算是加密的人也不能解密。具体可以看我翻译的<code>Travis-CI</code>文档。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 确保在source分支下操作</span></span><br><span class="line">git checkout <span class="built_in">source</span></span><br><span class="line"><span class="comment"># 2. 进入next.yml所在文件夹</span></span><br><span class="line"><span class="built_in">cd</span> <span class="built_in">source</span>/_data</span><br><span class="line"><span class="comment"># 3. 进行加密(如果想要加密多个文件, 需要将多个文件打包, 再在Travis-CI解压)</span></span><br><span class="line">travis encrypt-file next.yml</span><br><span class="line"><span class="comment"># 4. 在.travis.yml中加入配置, 注意要指定source/_data/next.yml路径. (这里不要复制我的key, 每个人都不一样)</span></span><br><span class="line">vim /opt/Ahaochan.github.io/.travis.yml</span><br><span class="line">before_install:</span><br><span class="line">- openssl aes-256-cbc -K <span class="variable">$encrypted_3873d9e40d23_key</span> -iv <span class="variable">$encrypted_3873d9e40d23_iv</span> -<span class="keyword">in</span> <span class="built_in">source</span>/_data/next.yml.enc -out <span class="built_in">source</span>/_data/next.yml -d</span><br><span class="line"><span class="comment"># 5. 在.gitignore添加一行, 不提交next.yml</span></span><br><span class="line">vim /opt/Ahaochan.github.io/.gitignore</span><br><span class="line"><span class="built_in">source</span>/_data/next.yml</span><br></pre></td></tr></table></figure>

<h1 id="给予Travis推送GitHub的权限"><a href="#给予Travis推送GitHub的权限" class="headerlink" title="给予Travis推送GitHub的权限"></a>给予Travis推送GitHub的权限</h1><p>网上很多都是生成<code>ssh</code>公钥, 或者直接使用<code>git push -u origin master</code>的方式部署。<br>我参考的<a href="https://segmentfault.com/a/1190000009054888#articleHeader1">使用 Travis 自动部署 Hexo 到 Github 与 自己的服务器</a>配置了<code>REPO_TOKEN</code>, 但是没有物尽其用。<br>这里将<code>REPO_TOKEN</code>做了替换。</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># next.yml</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">https://REPO_TOKEN@github.com/Ahaochan/Ahaochan.github.io.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br></pre></td></tr></table></figure>

<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># .travis.yml</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="comment"># 注意要放在解密next.yml文件命令之后</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/REPO_TOKEN/$&#123;REPO_TOKEN&#125;/&quot;</span> <span class="string">source/_data/next.yml</span></span><br></pre></td></tr></table></figure>

<h1 id="从GitHub下载最新模块和主题"><a href="#从GitHub下载最新模块和主题" class="headerlink" title="从GitHub下载最新模块和主题"></a>从GitHub下载最新模块和主题</h1><p>为了节省<code>Github</code>空间, 我在<code>.travis.yml</code>配置了很多的下载命令.<br>详细可以看我的GitHub</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用语言</span></span><br><span class="line"><span class="attr">language:</span> <span class="string">node_js</span></span><br><span class="line"><span class="comment"># node版本</span></span><br><span class="line"><span class="attr">node_js:</span> <span class="string">lts/*</span></span><br><span class="line"><span class="comment"># 设置只监听哪个分支</span></span><br><span class="line"><span class="attr">branches:</span></span><br><span class="line">  <span class="attr">only:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">source</span></span><br><span class="line"><span class="comment"># 缓存，可以节省集成的时间，这里我用了yarn，如果不用可以删除</span></span><br><span class="line"><span class="attr">cache:</span></span><br><span class="line">  <span class="attr">apt:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">yarn:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">directories:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">node_modules</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">theme</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="comment">#  配置git</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.name</span> <span class="string">&quot;Ahaochan&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">config</span> <span class="string">--global</span> <span class="string">user.email</span> <span class="string">&quot;844394093@qq.com&quot;</span></span><br><span class="line"><span class="comment"># 由于使用了yarn，所以需要下载，如不用yarn这两行可以删除</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">curl</span> <span class="string">-o-</span> <span class="string">-L</span> <span class="string">https://yarnpkg.com/install.sh</span> <span class="string">|</span> <span class="string">bash</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">export</span> <span class="string">PATH=$HOME/.yarn/bin:$PATH</span></span><br><span class="line"><span class="comment"># npm模块安装</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">global</span> <span class="string">add</span> <span class="string">hexo-cli</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-asset-image</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-generator-searchdb</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-generator-feed</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-related-popular-posts</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-symbols-count-time</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-generator-sitemap</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-generator-baidu-sitemap</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-deployer-git</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-leancloud-counter-security</span> <span class="string">--save</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span> <span class="string">add</span> <span class="string">hexo-helper-live2d</span> <span class="string">--save</span></span><br><span class="line"><span class="comment"># next.yml配置文件解密</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">openssl</span> <span class="string">aes-256-cbc</span> <span class="string">-K</span> <span class="string">$encrypted_3873d9e40d23_key</span> <span class="string">-iv</span> <span class="string">$encrypted_3873d9e40d23_iv</span> <span class="string">-in</span> <span class="string">source/_data/next.yml.enc</span> <span class="string">-out</span> <span class="string">source/_data/next.yml</span> <span class="string">-d</span></span><br><span class="line"><span class="comment"># 将 GitHub Token 替换到 next.yml 中</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/REPO_TOKEN/$&#123;REPO_TOKEN&#125;/&quot;</span> <span class="string">source/_data/next.yml</span></span><br><span class="line"><span class="comment"># next主题下载</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/hexo-theme-next</span> <span class="string">themes/next</span></span><br><span class="line"><span class="comment"># next主题依赖下载</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-pangu.git</span> <span class="string">themes/next/source/lib/pangu</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-reading-progress</span> <span class="string">themes/next/source/lib/reading_progress</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-fastclick</span> <span class="string">themes/next/source/lib/fastclick</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-jquery-lazyload</span> <span class="string">themes/next/source/lib/jquery_lazyload</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-pace</span> <span class="string">themes/next/source/lib/pace</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-canvas-nest</span> <span class="string">themes/next/source/lib/canvas-nest</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">git</span> <span class="string">clone</span> <span class="string">https://github.com/theme-next/theme-next-fancybox3</span> <span class="string">themes/next/source/lib/fancybox</span></span><br><span class="line"><span class="attr">install:</span></span><br><span class="line"><span class="comment"># 不用yarn的话这里改成 npm i 即可</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">yarn</span></span><br><span class="line"><span class="attr">script:</span></span><br><span class="line"><span class="comment"># 配置 LeanCloud</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo</span> <span class="string">lc-counter</span> <span class="string">register</span> <span class="string">$leancloud_username</span> <span class="string">$leancloud_password</span> <span class="string">--config</span> <span class="string">source/_data/next.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo</span> <span class="string">clean</span> <span class="string">--config</span> <span class="string">source/_data/next.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo</span> <span class="string">g</span> <span class="string">--config</span> <span class="string">source/_data/next.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">hexo</span> <span class="string">d</span> <span class="string">--config</span> <span class="string">source/_data/next.yml</span></span><br></pre></td></tr></table></figure>
<h1 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h1><p>最后将所有文件<code>git push -u origin source</code>推送到远程的<code>source</code>分支上即可。<br>如果失败, 可以在 <a href="https://travis-ci.org/Ahaochan/Ahaochan.github.io/requests">https://travis-ci.org/Ahaochan/Ahaochan.github.io/requests</a> 查看错误信息。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.jianshu.com/p/d8573f9d1f96">CentOS yum 源的配置与使用</a></li>
<li><a href="https://segmentfault.com/a/1190000009054888">使用 Travis 自动部署 Hexo 到 Github 与 自己的服务器</a></li>
<li><a href="http://kflu.github.io/2017/01/03/2017-01-03-hexo-travis/">Auto Deploy Hexo.io to Github Pages With Travis CI</a></li>
</ul>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Travis-CI</tag>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>为GitHub博客添加域名并允许百度收录</title>
    <url>/posts/Add_domain_and_allow_Baidu.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>之前写了一篇文章, <a href="https://ahao.moe/posts/TravisCI_encrypts_configuration_files_and_automatically_deploys_Hexo.html">TravisCI 加密配置文件并自动部署 Hexo</a><br>迫于囊中羞涩, 没有域名, 于是也绕不过<code>GitHub</code>对<code>Baidu</code>的封锁.<br>现在买了个域名<code>ahao.moe</code>, 终于让<code>Baidu</code>访问到我的博客了.</p>
<span id="more"></span>

<h1 id="GoDaddy-购买域名"><a href="#GoDaddy-购买域名" class="headerlink" title="GoDaddy 购买域名"></a>GoDaddy 购买域名</h1><p>注意, 有些域名是不能备案的, 比如<code>moe</code>域名.</p>
<h1 id="为-GitHub-博客添加-DNS-解析"><a href="#为-GitHub-博客添加-DNS-解析" class="headerlink" title="为 GitHub 博客添加 DNS 解析"></a>为 GitHub 博客添加 DNS 解析</h1><h2 id="更换-DNS-解析服务器"><a href="#更换-DNS-解析服务器" class="headerlink" title="更换 DNS 解析服务器"></a>更换 DNS 解析服务器</h2><p>因为阿里云提供了免费的<code>SSL</code>证书, 所以使用阿里云做域名解析.<br>在<code>GoDaddy</code>配置阿里云的<code>DNS</code>解析服务器.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">ns1.alidns.com</span><br><span class="line">ns2.alidns.com</span><br></pre></td></tr></table></figure>

<h2 id="阿里云添加-A-记录"><a href="#阿里云添加-A-记录" class="headerlink" title="阿里云添加 A 记录"></a>阿里云添加 A 记录</h2><p>然后回到阿里云, 在<a href="https://dns.console.aliyun.com/#/dns/domainList">管理界面</a>新增一个域名<code>ahao.moe</code>.<br>进入<a href="https://dns.console.aliyun.com/#/dns/setting/ahao.moe"><code>ahao.moe</code>解析设置</a></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://dns.console.aliyun.com/#/dns/setting/ahao.moe</span><br></pre></td></tr></table></figure>

<p>先去看下<a href="https://help.github.com/en/articles/setting-up-an-apex-domain#configuring-a-records-with-your-dns-provider">GitHub文档</a><br>根据这几个<code>IP</code>地址, 设置<code>A记录</code>, 这里列举要修改的值, 其他没列出的默认即可.</p>
<table>
<thead>
<tr>
<th align="center">记录类型</th>
<th align="center">主机记录</th>
<th align="center">解析线路</th>
<th align="center">记录值</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">默认</td>
<td align="center"><code>185.199.108.153</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">默认</td>
<td align="center"><code>185.199.109.153</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">默认</td>
<td align="center"><code>185.199.110.153</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">默认</td>
<td align="center"><code>185.199.111.153</code></td>
</tr>
</tbody></table>
<h2 id="阿里云添加-SSL-证书"><a href="#阿里云添加-SSL-证书" class="headerlink" title="阿里云添加 SSL 证书"></a>阿里云添加 SSL 证书</h2><p>进入<a href="https://common-buy.aliyun.com/?commodityCode=cas#/buy">云盾证书服务</a>, 选择<code>免费型DV SSL</code>.<br>之后填上自己的域名<code>ahao.moe</code>即可, 注意此证书只能针对一个域名, 不包括子域名.</p>
<p>然后我们回到阿里云<a href="https://dns.console.aliyun.com/#/dns/setting/ahao.moe"><code>ahao.moe</code>解析设置</a></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://dns.console.aliyun.com/#/dns/setting/ahao.moe</span><br></pre></td></tr></table></figure>
<p>添加验证的记录</p>
<table>
<thead>
<tr>
<th align="center">记录类型</th>
<th align="center">主机记录</th>
<th align="center">解析线路</th>
<th align="center">记录值</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>TXT</code></td>
<td align="center"><code>_dnsauth</code></td>
<td align="center">默认</td>
<td align="center"><code>123456789abcdefg</code></td>
</tr>
</tbody></table>
<h2 id="GitHub-博客项目配置"><a href="#GitHub-博客项目配置" class="headerlink" title="GitHub 博客项目配置"></a>GitHub 博客项目配置</h2><p>进入<code>GitHub</code>的<a href="https://github.com/Ahaochan/Ahaochan.github.io">博客项目</a>.<br>在<code>Setting</code>里的<code>GitHub Pages</code>标签, 看到<code>Custom domain</code>, 在里面配置<code>ahao.moe</code>, 并勾选<code>Enforce HTTPS</code>.</p>
<p>同时, 我们还要在<a href="https://github.com/Ahaochan/Ahaochan.github.io/blob/source/source"><code>source</code></a>添加一个<a href="https://github.com/Ahaochan/Ahaochan.github.io/blob/source/source/CNAME"><code>CNAME</code></a>文件.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">ahao.moe</span><br></pre></td></tr></table></figure>
<p>至此, 等待几分钟, 就可以在<code>ahao.moe</code>访问到自己的<code>GitHub</code>博客了.</p>
<h1 id="部署到-Coding-Pages"><a href="#部署到-Coding-Pages" class="headerlink" title="部署到 Coding Pages"></a>部署到 Coding Pages</h1><h2 id="腾讯云项目配置"><a href="#腾讯云项目配置" class="headerlink" title="腾讯云项目配置"></a>腾讯云项目配置</h2><p><code>Coding Pages</code>现在已经迁移到<a href="https://dev.tencent.com/u/Ahaochan">腾讯云开发者平台</a>了<br>我们先<a href="https://dev.tencent.com/user/projects/create">新建</a>一个<code>Ahaochan.coding.me</code>的项目.</p>
<p>和<code>GitHub</code>一样, 我们也要指定<code>ahao.moe</code>.<br>在<code>https://dev.tencent.com/u/Ahaochan/p/Ahaochan.coding.me/git/pages/settings</code>里绑定新域名<code>ahao.moe</code><br>然后在阿里云配置<code>A</code>记录即可, 注意<code>IP</code>地址我们需要自己手动查询, 还有解析线路要改为<strong>百度</strong>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. windows 查询 IP</span></span><br><span class="line">nslookup Ahaochan.coding.me</span><br><span class="line"><span class="comment"># 2. linux 查询 IP</span></span><br><span class="line">host -a Ahaochan.coding.me</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">记录类型</th>
<th align="center">主机记录</th>
<th align="center">解析线路</th>
<th align="center">记录值</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">百度</td>
<td align="center"><code>128.1.133.223</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">百度</td>
<td align="center"><code>128.1.138.212</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">百度</td>
<td align="center"><code>128.1.138.154</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">百度</td>
<td align="center"><code>128.1.138.163</code></td>
</tr>
<tr>
<td align="center"><code>A</code></td>
<td align="center"><code>@</code></td>
<td align="center">百度</td>
<td align="center"><code>128.1.138.9</code></td>
</tr>
</tbody></table>
<h2 id="Travis-CI-配置"><a href="#Travis-CI-配置" class="headerlink" title="Travis CI 配置"></a>Travis CI 配置</h2><p>注意, 此时<code>Ahaochan.coding.me</code>仍然是一个空项目, 我们需要在<code>Travis CI</code>中配置<code>push</code>到腾讯云平台.</p>
<p>先在<code>https://dev.tencent.com/user/account/setting/tokens/new</code>新建一个<code>Token</code>令牌, 配置所需权限.<br>和<code>GitHub</code>一样, 在<code>Travis CI</code>的<code>Environment Variables</code>配置加密变量<code>CODING_TOKEN</code>.<br>之后的步骤就和<code>GitHub</code>一样了, 参考我开头的那篇文章.<br>这里放下<code>next.yml</code>和<code>.travis.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># next.yml</span></span><br><span class="line"><span class="attr">deploy:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">https://REPO_TOKEN@github.com/Ahaochan/Ahaochan.github.io.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">    <span class="attr">repo:</span> <span class="string">https://Ahaochan:CODING_TOKEN@git.dev.tencent.com/Ahaochan/Ahaochan.coding.me.git</span></span><br><span class="line">    <span class="attr">branch:</span> <span class="string">master</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># .travis.yml</span></span><br><span class="line"><span class="attr">before_install:</span></span><br><span class="line"><span class="comment"># - 解密 next.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/REPO_TOKEN/$&#123;REPO_TOKEN&#125;/&quot;</span> <span class="string">source/_data/next.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&quot;s/CODING_TOKEN/$&#123;CODING_TOKEN&#125;/&quot;</span> <span class="string">source/_data/next.yml</span></span><br></pre></td></tr></table></figure>

<h1 id="添加百度和谷歌收录"><a href="#添加百度和谷歌收录" class="headerlink" title="添加百度和谷歌收录"></a>添加百度和谷歌收录</h1><h2 id="谷歌收录"><a href="#谷歌收录" class="headerlink" title="谷歌收录"></a>谷歌收录</h2><p>进入谷歌站长工具, 点击左边的<strong>添加资源</strong>.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://search.google.com/search-console?resource_id=sc-domain%3Aahao.moe</span><br></pre></td></tr></table></figure>
<p>选择<strong>添加网域</strong>, 输入<code>ahao.moe</code>.<br>谷歌会提示你将<code>google-site-verification=123456789</code>这段代码在<code>DNS</code>配置为<code>TXT</code>记录.<br>我们回到阿里云<a href="https://dns.console.aliyun.com/#/dns/setting/ahao.moe"><code>ahao.moe</code>解析设置</a></p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://dns.console.aliyun.com/#/dns/setting/ahao.moe</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">记录类型</th>
<th align="center">主机记录</th>
<th align="center">解析线路</th>
<th align="center">记录值</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>TXT</code></td>
<td align="center"><code>@</code></td>
<td align="center">默认</td>
<td align="center"><code>google-site-verification=123456789</code></td>
</tr>
</tbody></table>
<p>然后为<code>hexo</code>添加<code>hexo-generator-sitemap</code>插件(<a href="https://github.com/Ahaochan/Ahaochan.github.io/blob/source/.travis.yml#L30">.travis.yml#L30</a>), 它会生成一个<code>sitemap.xml</code>.<br>回到谷歌站长工具, 添加一个<code>sitemap</code>地址<code>https://ahao.moe/sitemap.xml</code>.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://search.google.com/search-console/sitemaps?resource_id=sc-domain%3Aahao.moe</span><br></pre></td></tr></table></figure>

<h2 id="百度收录"><a href="#百度收录" class="headerlink" title="百度收录"></a>百度收录</h2><p>进入<a href="https://ziyuan.baidu.com/site/index">百度站点管理</a>, 添加<code>https://ahao.moe</code>, 选择<code>CNAME</code>验证.</p>
<table>
<thead>
<tr>
<th align="center">记录类型</th>
<th align="center">主机记录</th>
<th align="center">解析线路</th>
<th align="center">记录值</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>CNAME</code></td>
<td align="center"><code>abcdefg</code></td>
<td align="center">默认</td>
<td align="center"><code>ziyuan.baidu.com</code></td>
</tr>
</tbody></table>
<p>同理, 为<code>hexo</code>添加<code>hexo-generator-baidu-sitemap</code>插件(<a href="https://github.com/Ahaochan/Ahaochan.github.io/blob/source/.travis.yml#L31">.travis.yml#L31</a>), 它会生成一个<code>baidusitemap.xml</code>.<br>回到百度站长工具, 添加一个<code>sitemap</code>地址<code>https://ahao.moe/baidusitemap.xml</code>.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">https://ziyuan.baidu.com/linksubmit/index?site=https%3A%2F%2Fahao.moe/</span><br></pre></td></tr></table></figure>

<p>因为之前在阿里云<code>DNS</code>解析将百度的爬虫指向了<code>Coding Me</code>, 所以绕开了<code>GitHub</code>的封锁.</p>
]]></content>
      <categories>
        <category>Hexo</category>
      </categories>
      <tags>
        <tag>Travis-CI</tag>
        <tag>Hexo</tag>
      </tags>
  </entry>
  <entry>
    <title>JVM垃圾收集简介</title>
    <url>/posts/garbage_collection_of_jvm.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Java</code>相比于<code>C/C++</code>最大的不同是不用手动进行管理内存, 这一特性得益于<code>Java</code>的自动回收内存机制.<br>这一回收动作称为<code>Garbage Collection</code>垃圾收集, 也就是<code>GC</code>. 由此延伸出了垃圾收集算法, 垃圾收集器等.</p>
<span id="more"></span>

<h1 id="如何判断一个对象可以回收"><a href="#如何判断一个对象可以回收" class="headerlink" title="如何判断一个对象可以回收"></a>如何判断一个对象可以回收</h1><p>我们判断一个对象<code>obj</code>是否可以回收, 一般是通过判断是否有其他对象对这个<code>obj</code>还持有引用. 如果没有, 这个<code>obj</code>就是可以回收的对象. 使用到的算法, 就是垃圾收集算法.</p>
<p>垃圾收集算法主要有两种</p>
<ol>
<li>引用计数算法</li>
<li>可达性分析算法</li>
</ol>
<h2 id="引用计数算法（不使用）"><a href="#引用计数算法（不使用）" class="headerlink" title="引用计数算法（不使用）"></a>引用计数算法（不使用）</h2><p>最简单高效的方法, 是在对象中添加一个计数器, 比如一个<code>count</code>字段, 有对象持有对它的引用则加一, 有对象失去对它的引用则减一.<br>只要计数器为<code>0</code>则说明没有其他对象引用它. 那么就可以对它进行垃圾回收.</p>
<p>但是目前主流的<code>Java</code>虚拟机都没有使用引用计数算法. 这个算法看似简单的背后, 要配合大量额外处理才能保证正常工作.<br>比如对象间相互循环引用的问题, 就不能简单使用引用计数算法来解决.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyGC</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">        <span class="type">B</span> <span class="variable">b</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">        a.val = b;</span><br><span class="line">        b.val = a;</span><br><span class="line">        </span><br><span class="line">        a = <span class="literal">null</span>;</span><br><span class="line">        b = <span class="literal">null</span>;</span><br><span class="line">        </span><br><span class="line">        System.gc(); <span class="comment">// a 和 b 不能被回收</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按引用计数算法的逻辑, 对象<code>a</code>和<code>b</code>各自的引用计数器的值都是<code>1</code>, 不能被回收.<br>但是外界已经没有对这两个对象的引用了, 按正常逻辑来说, 应该是可以被回收的.</p>
<h2 id="可达性分析算法"><a href="#可达性分析算法" class="headerlink" title="可达性分析算法"></a>可达性分析算法</h2><p>所以, 主流的<code>JVM</code>还是使用可达性分析算法来判断对象是否可以被垃圾回收的. 涉及到图论相关知识.<br>基本思路就是通过一系列被称为<code>GC Roots</code>的跟对象作为起始节点, 从这些节点根据引用关系向下搜索, 搜索走过的路径称为<strong>引用链</strong>.<br>如果某个对象没有经过这个<strong>引用链</strong>, 那么就说明此对象可以被回收.<br>即使是循环引用的两个对象<code>DE</code>, 它们都没有经过<strong>引用链</strong>, 也可以被回收.<br><img data-src="https://yuml.me/diagram/nofunky;dir:UD/class/[GC%20Roots]-%3E[A],[GC%20Roots]-%3E[B],[B]-%3E[C],[D]-%3E[E],[E]-%3E[D]" alt="可达性分析算法"></p>
<h1 id="常见垃圾收集算法"><a href="#常见垃圾收集算法" class="headerlink" title="常见垃圾收集算法"></a>常见垃圾收集算法</h1><p>说到垃圾收集, 就不得不说到分代收集这个概念.<br><code>JVM</code>中大部分的对象都是朝生夕灭的, 当一个对象经历了多次<code>GC</code>还没有被回收, 就说明它是一个很难被回收的对象. 根据对象经过<code>GC</code>的次数, 将堆划分为新生代和老年代, 以此来使用不同的垃圾收集算法。</p>
<p>但是也有些收集器是不按分代收集的, 比如<code>G1</code>收集器是按一块一块的区域收集的.</p>
<h2 id="标记-清除算法"><a href="#标记-清除算法" class="headerlink" title="标记-清除算法"></a>标记-清除算法</h2><p>标记-清除算法是最早出现的最基础的垃圾收集算法.<br>它主要是通过可达性分析算法, 标记出所有需要回收的对象, 然后做垃圾回收.<br>但它有两个缺点</p>
<ol>
<li>执行效率不稳定, 对象越多, 标记清除花费的时间越多</li>
<li>内存碎片化问题, 下次分配大内存对象的时候找不到足够连续大的内存空间导致提前进行垃圾回收<img data-src="/images/JVM%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%80%E4%BB%8B_01.png" class=""></li>
</ol>
<h2 id="标记-复制算法"><a href="#标记-复制算法" class="headerlink" title="标记-复制算法"></a>标记-复制算法</h2><p>标记-清除算法会出现内存碎片化的问题, 要解决内存碎片化的问题, 就需要对内存碎片进行整理. 标记-复制算法用了巧妙的方式, 用复制的方法避过了整理.<br>原理是将<strong>新生代</strong>内存空间划分为一个<code>Eden</code>区和两个<code>Survivor</code>区, 默认比例是<code>8:1:1</code>,<br>每次<code>GC</code>的时候, 会把<code>Eden</code>区和其中一块<code>Survivor</code>区做垃圾回收, 存活的对象复制到另一块未使用的<code>Survivor</code>区. 每次存活下来的对象年龄会加一, 到达一定年龄, 就复制到老年代去.</p>
<img data-src="/images/JVM%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%80%E4%BB%8B_02.png" class="">

<h2 id="标记-整理算法"><a href="#标记-整理算法" class="headerlink" title="标记-整理算法"></a>标记-整理算法</h2><p>标记-清除算法如果每次<code>GC</code>时存活的对象越多, 进行复制的成本也越高, 那就还不如直接进行内存整理了.</p>
<img data-src="/images/JVM%E5%9E%83%E5%9C%BE%E6%94%B6%E9%9B%86%E7%AE%80%E4%BB%8B_03.png" class="">

<h1 id="垃圾收集器"><a href="#垃圾收集器" class="headerlink" title="垃圾收集器"></a>垃圾收集器</h1><p>从上面的垃圾收集算法, 可以知道, 根据不同分代的垃圾特性, 需要使用不同的垃圾收集算法, 也需要使用不同垃圾收集器.</p>
<p>下面简单列了一些收集器的特点</p>
<table>
<thead>
<tr>
<th align="center">垃圾收集器</th>
<th align="center">新生代</th>
<th align="center">老年代</th>
<th align="center">并行</th>
<th align="center">垃圾收集算法</th>
<th align="center">特点</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>Serial</code></td>
<td align="center">√</td>
<td align="center"></td>
<td align="center">单线程</td>
<td align="center">复制</td>
<td align="center">单核下效率最高</td>
</tr>
<tr>
<td align="center"><code>ParNew</code></td>
<td align="center">√</td>
<td align="center"></td>
<td align="center">多线程</td>
<td align="center">复制</td>
<td align="center"><code>Serial</code>多线程版本, 和<code>CMS</code>是官配</td>
</tr>
<tr>
<td align="center"><code>Parallel Scavenge</code></td>
<td align="center">√</td>
<td align="center"></td>
<td align="center">多线程</td>
<td align="center">复制</td>
<td align="center">吞吐量优先</td>
</tr>
<tr>
<td align="center"><code>Serial Old</code></td>
<td align="center"></td>
<td align="center">√</td>
<td align="center">单线程</td>
<td align="center">复制</td>
<td align="center"><code>Serial</code>老年代版本</td>
</tr>
<tr>
<td align="center"><code>Parallel Old</code></td>
<td align="center"></td>
<td align="center">√</td>
<td align="center">多线程</td>
<td align="center">整理</td>
<td align="center"><code>Parallel Scavenge</code>老年代版本</td>
</tr>
<tr>
<td align="center"><code>CMS</code></td>
<td align="center"></td>
<td align="center">√</td>
<td align="center">并发多线程</td>
<td align="center">清除</td>
<td align="center">尽量少停顿时间</td>
</tr>
<tr>
<td align="center"><code>G1</code></td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">并发多线程</td>
<td align="center">分区回收</td>
<td align="center">大内存无脑上</td>
</tr>
</tbody></table>
<p>各个分代间的垃圾收集器搭配</p>
<table>
<thead>
<tr>
<th align="center">老年代/年轻代</th>
<th align="center"><code>Serial</code></th>
<th align="center"><code>ParNew</code></th>
<th align="center"><code>Parallel Scavenge</code></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>Serial Old</code></td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center">√</td>
</tr>
<tr>
<td align="center"><code>Parallel Old</code></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">√</td>
</tr>
<tr>
<td align="center"><code>CMS</code></td>
<td align="center">√</td>
<td align="center">√</td>
<td align="center"></td>
</tr>
</tbody></table>
<p><code>Serial + Serial Old</code>是低配置服务端的解决方案.<br><code>ParNew + CMS</code> 是<code>JDK9</code>之前官方推荐的服务端模式下的收集器解决方案.<br><code>Parallel Scavenge + Parallel Old</code>是吞吐量优先的组合, 应用在处理器资源比较稀缺的场合.<br><code>G1</code>是超大堆的首选, 遇到超大堆就直接选<code>G1</code>.</p>
<h2 id="CMS-垃圾收集器"><a href="#CMS-垃圾收集器" class="headerlink" title="CMS 垃圾收集器"></a>CMS 垃圾收集器</h2><p><code>CMS</code>垃圾收集器是在老年代使用标记清除算法进行垃圾回收的, 一种以获取最短回收停顿时间为目标的收集器.</p>
<p>回收步骤如下</p>
<ol>
<li>初始标记, 只标记<code>GC Roots</code>的直接关联对象, 会发生<code>Stop the world</code></li>
<li>并发标记, 和用户线程并发执行, 用来遍历整个对象图</li>
<li>重新标记, 修正因为用户线程运行导致的引用变动, 也会发生<code>Stop the world</code></li>
<li>并发清除, 和用户线程并发执行, 因为不用去移动存活对象.</li>
</ol>
<p><code>ParNew + CMS</code> 是<code>JDK9</code>之前官方推荐的服务端模式下的收集器解决方案.</p>
<h2 id="G1-垃圾收集器"><a href="#G1-垃圾收集器" class="headerlink" title="G1 垃圾收集器"></a>G1 垃圾收集器</h2><p><code>Garbage First</code>简称<code>G1</code>, 不再使用分代收集策略, 是一个面向全堆收集的垃圾收集器.<br>将全堆内存划分为一块一块的<code>Region</code>区域, 然后根据每块<code>Region</code>区域的价值(有点类似背包问题), 进行垃圾回收, 从而做到<code>GC</code>时间可控制.</p>
<p>用于在超大内存下, 替换<code>ParNew + CMS</code>组合的收集器方案.</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>内存映像工具jmap</title>
    <url>/posts/jmap.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>jmap</code>全称<code>Memory Map For Java</code>虚拟机统计信息监视工具, 可以生成堆内存的快照, 在事后进行分析.<br>当然我们还可以给<code>JVM</code>加上<code>-XX:+HeapDumpOnOutOfMemoryError</code>, 在内存溢出的时候自动生成堆内存的快照.<br>命令格式: <code>jmap [option] vmid</code></p>
<span id="more"></span>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>vmid</code></td>
<td align="center">如果是本地虚拟机, 那就是<code>jps</code>的进程号. 如果是远程虚拟机, 则应该是<code>[protocol:][//]lvmid[@hostname[:port]/servername]</code></td>
</tr>
</tbody></table>
<p>选项<code>option</code>代表要查询的数据</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>-dump</code></td>
<td align="center">生成堆内存快照. 格式为<code>-dump:[live,]format=b,file=/tmp/heap.dump</code>, 其中<code>live</code>说明是否只<code>dump</code>存活的对象</td>
</tr>
<tr>
<td align="center"><code>-finalizerinfo</code></td>
<td align="center">显示在<code>F-Queue</code>中等待<code>Finalizer</code>线程执行<code>finalize</code>方法的对象.</td>
</tr>
<tr>
<td align="center"><code>-heap</code></td>
<td align="center">显示堆详细信息</td>
</tr>
<tr>
<td align="center"><code>-histo</code></td>
<td align="center">显示堆中对象统计信息</td>
</tr>
<tr>
<td align="center"><code>-permstat</code></td>
<td align="center">以<code>ClassLoader</code>为统计口径显示永久代内存状态</td>
</tr>
<tr>
<td align="center"><code>-F</code></td>
<td align="center"><code>-dump</code>没响应的时候, 强制生成<code>dump</code>快照</td>
</tr>
</tbody></table>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="jmap-heap-PID"><a href="#jmap-heap-PID" class="headerlink" title="jmap -heap PID"></a>jmap -heap PID</h2><p>用来查看堆内存, <code>jstat</code>已有相同的功能了, 并且更全面.<br><code>jstat</code>除了堆内存信息, 还有<code>GC</code>的相关信息.</p>
<h2 id="jmap-histo-PID"><a href="#jmap-histo-PID" class="headerlink" title="jmap -histo PID"></a>jmap -histo PID</h2><p>所以一般<code>jmap</code>都是用来查看堆内对象的具体内存信息的. 这是<code>jstat</code>做不到的事情.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line"> num     #instances         #bytes  class name</span><br><span class="line">----------------------------------------------</span><br><span class="line">   1:        190803       63620528  [B</span><br><span class="line">   2:         33239       40343096  [I</span><br><span class="line">   3:        349476       39534528  [C</span><br><span class="line">   4:        186246        4469904  java.lang.String</span><br><span class="line">   5:         14783        4389000  [Ljava.util.HashMap$Node;</span><br><span class="line">   6:         54116        2809872  [Ljava.lang.Object;</span><br><span class="line">   7:         29125        2563000  java.lang.reflect.Method</span><br><span class="line">...</span><br><span class="line">Total       1671051      186914432</span><br></pre></td></tr></table></figure>
<p>从输出信息可以看出<br><code>byte[]</code>类型有<code>190803</code>个实例, 占用<code>63620528</code>个字节.<br><code>int[]</code>类型有<code>33239</code>个实例, 占用<code>40343096</code>个字节.<br><code>char[]</code>类型有<code>349476</code>个实例, 占用<code>39534528</code>个字节.<br>以此类推</p>
<h2 id="jmap-dump-live-format-b-file-dump-hprof-PID"><a href="#jmap-dump-live-format-b-file-dump-hprof-PID" class="headerlink" title="jmap -dump:live,format=b,file=dump.hprof PID"></a>jmap -dump:live,format=b,file=dump.hprof PID</h2><p>当然生产环境不会给你慢慢的分析, 一般都是输出到文件, 把文件传到本地慢慢分析.<br>可以用<code>jhat dump.hprof -port 7000</code>分析, 但一般使用的是<code>MAT</code>做分析.</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>虚拟机统计信息监视工具jstat</title>
    <url>/posts/jstat.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>jstat</code>全称<code>JVM Statistics Monitoring Tool</code>虚拟机统计信息监视工具, 可以用来监视虚拟机进程中的类加载、内存、垃圾收集、即时编译等运行时数据.<br>命令格式: <code>jstat [option vmid [interval[s|ms] [count]]]</code></p>
<span id="more"></span>

<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>vmid</code></td>
<td align="center">如果是本地虚拟机, 那就是<code>jps</code>的进程号. 如果是远程虚拟机, 则应该是<code>[protocol:][//]lvmid[@hostname[:port]/servername]</code></td>
</tr>
<tr>
<td align="center"><code>interval</code></td>
<td align="center">查询间隔</td>
</tr>
<tr>
<td align="center"><code>count</code></td>
<td align="center">查询次数</td>
</tr>
</tbody></table>
<p>选项<code>option</code>代表用户希望查询的虚拟机信息, 主要分为三类: 类加载、垃圾收集、运行期编译状况.<br>| 选项 | 作用 |<br>|:——:|:——:|<br>| <code>-gc</code> | 监视堆状况 |<br>| <code>-gcutil</code> | 和<code>-gc</code>基本相同, 但主要关注已使用空间占总空间的百分比 |</p>
<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="jstat-gc-PID"><a href="#jstat-gc-PID" class="headerlink" title="jstat -gc PID"></a>jstat -gc PID</h2><p>执行<code>jstat -gc PID</code>命令, 查看<code>JVM</code>状态<br>| 列 | 值 | 说明 |<br>|:——:|:——:|:——:|<br>| <code>S0C</code> | <code>14848.0</code>  | <code>From Survivor</code>区的内存大小 |<br>| <code>S1C</code> | <code>14336.0</code> | <code>To Survivor</code>区的内存大小 |<br>| <code>S0U</code> | <code>0.0</code> | <code>From Survivor</code>区已使用内存大小 |<br>| <code>S1U</code> | <code>11904.5</code> | <code>To Survivor</code>区已使用内存大小 |<br>| <code>EC</code> | <code>147456.0</code> | <code>Eden</code>区的内存大小 |<br>| <code>EU</code> | <code>145865.4</code> | <code>Eden</code>区已使用内存大小 |<br>| <code>OC</code> | <code>168960.0</code> | 老年代的内存大小 |<br>| <code>OU</code> | <code>18178.0</code> | 老年代已使用内存大小 |<br>| <code>MC</code> | <code>44328.0</code> | 方法区的内存大小 |<br>| <code>MU</code> | <code>41720.7</code> | 方法区已使用内存大小 |<br>| <code>CCSC</code> | <code>6440.0</code> | 压缩类空间的内存大小 |<br>| <code>CCSU</code> | <code>5907.5</code> | 压缩类空间已使用内存大小 |<br>| <code>YGC</code> | <code>9</code> | 系统运行迄今为止的<code>Young GC</code>次数 |<br>| <code>YGCT</code> | <code>0.036</code> | <code>Young GC</code>耗时 |<br>| <code>FGC</code> | <code>2</code> | 系统运行迄今为止的<code>Full GC</code>次数 |<br>| <code>FGCT</code> | <code>0.041</code> | <code>Full GC</code>耗时 |<br>| <code>GCT</code> | <code>0.077</code> | 所有<code>GC</code>耗时 |</p>
<h2 id="其他-jstat-命令"><a href="#其他-jstat-命令" class="headerlink" title="其他 jstat 命令"></a>其他 jstat 命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">jstat -gccapacity PID <span class="comment"># 堆内存分析</span></span><br><span class="line">jstat -gcnew PID <span class="comment"># 年轻代GC分析，这里的TT和MTT可以看到对象在年轻代存活的年龄和存活的最大年龄</span></span><br><span class="line">jstat -gcnewcapacity PID <span class="comment"># 年轻代内存分析</span></span><br><span class="line">jstat -gcold PID <span class="comment"># 老年代GC分析</span></span><br><span class="line">jstat -gcoldcapacity PID <span class="comment"># 老年代内存分析</span></span><br><span class="line">jstat -gcmetacapacity PID <span class="comment"># 元数据区内存分析</span></span><br></pre></td></tr></table></figure>

<h1 id="常用场景"><a href="#常用场景" class="headerlink" title="常用场景"></a>常用场景</h1><h2 id="新生代对象增长速率"><a href="#新生代对象增长速率" class="headerlink" title="新生代对象增长速率"></a>新生代对象增长速率</h2><p>使用命令<code>jstat -gc PID 1000 10</code>, 表示每<code>1000</code>毫秒输出一次统计信息, 共输出<code>10</code>次.<br>就可以根据每次的<code>EU</code>, 计算出新生代对象增长速率</p>
<h2 id="YoungGC的触发频率"><a href="#YoungGC的触发频率" class="headerlink" title="YoungGC的触发频率"></a>YoungGC的触发频率</h2><p>既然知道了新生代对象增长速率，就可以用新生代内存大小除以速率, 得到新生代还有多久填满, 也就是多久触发一次<code>YoungGC</code>.</p>
<h2 id="YoungGC的每次耗时"><a href="#YoungGC的每次耗时" class="headerlink" title="YoungGC的每次耗时"></a>YoungGC的每次耗时</h2><p>直接用<code>YGCT</code>除以<code>YGC</code>就可以得到<code>YoungGC</code>的每次耗时</p>
<h2 id="每次YoungGC后有多少对象进入老年代"><a href="#每次YoungGC后有多少对象进入老年代" class="headerlink" title="每次YoungGC后有多少对象进入老年代"></a>每次YoungGC后有多少对象进入老年代</h2><p>其实就是看老年代的对象增长速率, 和新生代对象增长速率同样的方法.<br>使用命令<code>jstat -gc PID 1000 10</code>, 表示每<code>1000</code>毫秒输出一次统计信息, 共输出<code>10</code>次.<br>就可以根据每次的<code>OU</code>, 计算出新生代对象增长速率</p>
<h2 id="每次YoungGC后有多少对象存活下来"><a href="#每次YoungGC后有多少对象存活下来" class="headerlink" title="每次YoungGC后有多少对象存活下来"></a>每次YoungGC后有多少对象存活下来</h2><p>看<code>S</code>区的内存大小, 加上老年代内存增长大小</p>
<h2 id="FullGC的触发频率"><a href="#FullGC的触发频率" class="headerlink" title="FullGC的触发频率"></a>FullGC的触发频率</h2><p>和<code>YoungGC</code>触发频率同样的计算方式.<br>既然知道了老年代对象增长速率，就可以用老年代内存大小除以速率, 得到老年代还有多久填满, 也就是多久触发一次<code>FullGC</code>.</p>
<h2 id="FullGC的每次耗时"><a href="#FullGC的每次耗时" class="headerlink" title="FullGC的每次耗时"></a>FullGC的每次耗时</h2><p>直接用<code>FGCT</code>除以<code>FGC</code>就可以得到<code>FullGC</code>的每次耗时</p>
]]></content>
      <categories>
        <category>Java</category>
      </categories>
      <tags>
        <tag>JVM</tag>
      </tags>
  </entry>
  <entry>
    <title>Collectors.reducing压缩List&amp;lt;Map&amp;gt;为Map</title>
    <url>/posts/how_to_use_Collectors.reducing_method_to_reducing_List%5BMap%5D_to_Map.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>reduce</code>操作可以实现从一组元素中生成一个值, 也可以作为<code>downstream</code>下游处理器。本文默认读者已经掌握基本的<code>Stream</code>知识。</p>
<span id="more"></span>

<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>先大致看下结论, 不懂可以看下面的解释。</p>
<ol>
<li><code>identity</code> 只会初始化一次。</li>
<li><code>identity</code> 在每次 <code>downstream</code> 的时候会重新放到 <strong>左值(left)</strong> 中。</li>
<li>如果操作 <code>identity</code> 的话, 将会影响下次 <code>downstream</code> 的第一次的 <strong>左值(left)</strong></li>
</ol>
<h1 id="情景重现"><a href="#情景重现" class="headerlink" title="情景重现"></a>情景重现</h1><p>假设有一个邮递员业务的数据。用json展示。可以复制到<a href="http://www.json.cn/">【JSON在线解析及格式化验证】</a>进行格式化。<br>就是一个数组，每个元素都包含<strong>日期</strong>、<strong>邮件数量</strong>、<strong>发送地区的行政区划代码</strong>、<strong>是否大件行李</strong>。</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">[</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-01&quot;</span><span class="punctuation">,</span>  <span class="comment">// 日期</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;1&quot;</span><span class="punctuation">,</span>      <span class="comment">// 邮件数量</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;420000&quot;</span><span class="punctuation">,</span>   <span class="comment">// 发送地区的行政区划代码</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span>     <span class="comment">// 是否大件行李</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-01&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;440000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-02&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;3&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;420000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-03&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;4&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;420000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-03&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;410000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-03&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;6&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;440000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;420000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;date&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2016-04&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;number&quot;</span><span class="punctuation">:</span> <span class="string">&quot;8&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="string">&quot;440000&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="string">&quot;false&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span>;</span><br></pre></td></tr></table></figure>
<p>目标是根据 <strong>日期</strong> 分组, 根据 <strong>是否大件行李</strong> 分区, 把结果 <code>List&lt;Map&gt;</code> 压缩成一个 <code>Map&lt;行政区划代码， 数量&gt;</code>。</p>
<h1 id="进行编码"><a href="#进行编码" class="headerlink" title="进行编码"></a>进行编码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; postmans = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &quot;420000&quot; :行政区划代码, &quot;false&quot;: 是否为大件行李</span></span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-01&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-01&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;440000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-02&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-03&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-03&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;410000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-03&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;440000&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-04&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-04&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;440000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 fastjson 打印输出 原始数据</span></span><br><span class="line">        System.out.println(JSONObject.toJSONString(postmans));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Map&lt;Boolean, Map&gt;&gt; data = postmans.stream()</span><br><span class="line">                .collect(</span><br><span class="line">                    Collectors.groupingBy(    <span class="comment">// 分组</span></span><br><span class="line">                        d -&gt; d.get(<span class="string">&quot;date&quot;</span>),   <span class="comment">// 根据 日期 分组</span></span><br><span class="line">                        TreeMap::<span class="keyword">new</span>,         <span class="comment">// 使用 TreeMap 构造有序 Map</span></span><br><span class="line">                        Collectors.partitioningBy(</span><br><span class="line">                            d-&gt; d.get(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;true&quot;</span>), <span class="comment">// 根据 是否大件行李 分区</span></span><br><span class="line">                            Collectors.reducing(<span class="keyword">new</span> <span class="title class_">HashMap</span>(), (left, right)-&gt;&#123; <span class="comment">// 压缩 List&lt;Map&gt; 为 Map</span></span><br><span class="line">                                <span class="type">Object</span> <span class="variable">code</span> <span class="operator">=</span> right.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">                                <span class="type">Object</span> <span class="variable">number</span> <span class="operator">=</span> right.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line">                                left.put(code, number);</span><br><span class="line">                                <span class="comment">// 这里不应该修改left, 也就是identity</span></span><br><span class="line">                                <span class="keyword">return</span> left;</span><br><span class="line">                            &#125;))));</span><br><span class="line">        <span class="comment">// 使用 fastjson 打印输出 格式化后的数据</span></span><br><span class="line">        System.out.println(JSONObject.toJSONString(data));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,String&gt; <span class="title function_">createMap</span><span class="params">(String date, String number, String code, String type)</span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;date&quot;</span>, date);</span><br><span class="line">        map.put(<span class="string">&quot;number&quot;</span>, number);</span><br><span class="line">        map.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        map.put(<span class="string">&quot;type&quot;</span>, type);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="预期和实际的结果不同"><a href="#预期和实际的结果不同" class="headerlink" title="预期和实际的结果不同"></a>预期和实际的结果不同</h1><p>很明显, 每次最新的 <strong>行政区划代码</strong> 和 <strong>对应的数量</strong> 覆盖了之前的值。<br>可以复制到<a href="http://www.json.cn/">【JSON在线解析及格式化验证】</a>进行格式化。</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> 预期结果 = &#123;</span><br><span class="line">  <span class="string">&quot;2016-01&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;2&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;2016-02&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;3&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;2016-03&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;true&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;4&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;6&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;2016-04&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">var</span> 实际结果= &#123;</span><br><span class="line">  <span class="string">&quot;2016-01&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;true&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;2016-02&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;true&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;2016-03&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;true&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;2016-04&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;false&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;true&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;410000&quot;</span>: <span class="string">&quot;5&quot;</span>,</span><br><span class="line">      <span class="string">&quot;420000&quot;</span>: <span class="string">&quot;7&quot;</span>,</span><br><span class="line">      <span class="string">&quot;440000&quot;</span>: <span class="string">&quot;8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h1 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h1><p>上<a href="https://stackoverflow.com/questions/46143242/">【stackoverflow】</a>问了下，有人给出了正确的代码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collectors.reducing(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(),</span><br><span class="line">    (left, right) -&gt; &#123;</span><br><span class="line">        <span class="comment">// 注意这里 new 了个 Map</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="type">String</span> <span class="variable">leftCode</span> <span class="operator">=</span> left.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">leftNumber</span> <span class="operator">=</span> left.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (leftCode == <span class="literal">null</span>) &#123;</span><br><span class="line">            map.putAll(left);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            map.put(leftCode, leftNumber);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">rightCode</span> <span class="operator">=</span> right.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">rightNumber</span> <span class="operator">=</span> right.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line"></span><br><span class="line">        map.put(rightCode, rightNumber);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
<p>再结合自己调试之后，发现了几点</p>
<ol>
<li><code>identity</code> 只会初始化一次。</li>
<li><code>identity</code> 在每次 <code>downstream</code> 的时候会重新放到 <strong>左值(left)</strong> 中。</li>
<li>如果操作 <code>identity</code> 的话, 将会影响下次 <code>downstream</code> 的第一次的 <strong>左值(left)</strong></li>
</ol>
<p>注意我的代码, 我修改了 <code>identity</code> 的值, 造成了之后每次 <code>downstream</code> 重新放到 <strong>左值</strong> 的  <code>identity</code> 携带了上一次<code>downstream</code> 处理过的参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Collectors.reducing(</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">HashMap</span>(), </span><br><span class="line">    (left, right)-&gt;&#123; <span class="comment">// 压缩 List&lt;Map&gt; 为 Map</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">code</span> <span class="operator">=</span> right.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">number</span> <span class="operator">=</span> right.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line">        left.put(code, number);</span><br><span class="line">        <span class="comment">// 我修改了 identity 的值</span></span><br><span class="line">        <span class="keyword">return</span> left;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>而新的代码, 是重新 new 了个 Map, 没有修改 <code>identity</code> 。保持了 <code>identity</code> 的纯净。</p>
<h1 id="具体调试代码"><a href="#具体调试代码" class="headerlink" title="具体调试代码"></a>具体调试代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; postmans = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// &quot;420000&quot; : post area code, &quot;false&quot;: just paper(without goods)</span></span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-01&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-01&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;440000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-02&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-03&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-03&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;410000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-03&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;440000&quot;</span>, <span class="string">&quot;true&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-04&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;420000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line">        postmans.add(createMap(<span class="string">&quot;2016-04&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;440000&quot;</span>, <span class="string">&quot;false&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// before, I use fastjson Library</span></span><br><span class="line">        System.out.println(JSONObject.toJSONString(postmans));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Map&lt;String, Map&lt;Boolean, Map&gt;&gt; data = postmans.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(d -&gt; d.get(<span class="string">&quot;date&quot;</span>), TreeMap::<span class="keyword">new</span>,</span><br><span class="line">                        Collectors.partitioningBy(d-&gt; d.get(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;true&quot;</span>),</span><br><span class="line">                                Collectors.reducing(newHashMap(), (left, right)-&gt;&#123;</span><br><span class="line"></span><br><span class="line">                                    System.out.println(<span class="string">&quot;开始:&quot;</span>+JSONObject.toJSONString(left)+<span class="string">&quot;,&quot;</span>+JSONObject.toJSONString(right));</span><br><span class="line"></span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">code</span> <span class="operator">=</span> right.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">                                    <span class="type">Object</span> <span class="variable">number</span> <span class="operator">=</span> right.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line">                                    <span class="comment">// I think bug in reducing</span></span><br><span class="line">                                    left.put(code, number);</span><br><span class="line">                                    System.out.println(<span class="string">&quot;结果:&quot;</span>+JSONObject.toJSONString(left)+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                    <span class="keyword">return</span> left;</span><br><span class="line">                                &#125;))));</span><br><span class="line">        <span class="comment">// after, I use fastjson Library</span></span><br><span class="line">        System.out.println(JSONObject.toJSONString(data));</span><br><span class="line"></span><br><span class="line">        Map&lt;String, Map&lt;Boolean, Map&lt;String, String&gt;&gt;&gt; test = postmans.stream()</span><br><span class="line">                .collect(Collectors.groupingBy(d -&gt; d.get(<span class="string">&quot;date&quot;</span>), TreeMap::<span class="keyword">new</span>,</span><br><span class="line">                        Collectors.partitioningBy(d -&gt; d.get(<span class="string">&quot;type&quot;</span>).equals(<span class="string">&quot;true&quot;</span>),</span><br><span class="line">                                Collectors.reducing(newHashMap(), (left, right) -&gt; &#123;</span><br><span class="line">                                            Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">                                            System.out.println(<span class="string">&quot;开始:&quot;</span>+JSONObject.toJSONString(left)+<span class="string">&quot;,&quot;</span>+JSONObject.toJSONString(right));</span><br><span class="line"></span><br><span class="line">                                            <span class="type">String</span> <span class="variable">leftCode</span> <span class="operator">=</span> left.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">                                            <span class="type">String</span> <span class="variable">leftNumber</span> <span class="operator">=</span> left.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">if</span> (leftCode == <span class="literal">null</span>) &#123;</span><br><span class="line">                                                map.putAll(left);</span><br><span class="line">                                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                                map.put(leftCode, leftNumber);</span><br><span class="line">                                            &#125;</span><br><span class="line"></span><br><span class="line">                                            <span class="type">String</span> <span class="variable">rightCode</span> <span class="operator">=</span> right.get(<span class="string">&quot;code&quot;</span>);</span><br><span class="line">                                            <span class="type">String</span> <span class="variable">rightNumber</span> <span class="operator">=</span> right.get(<span class="string">&quot;number&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                            map.put(rightCode, rightNumber);</span><br><span class="line"></span><br><span class="line">                                            System.out.println(<span class="string">&quot;结果:&quot;</span>+JSONObject.toJSONString(map)+<span class="string">&quot;\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">                                            <span class="keyword">return</span> map;</span><br><span class="line">                                        &#125;))));</span><br><span class="line">        System.out.println(JSONObject.toJSONString(test));</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title function_">newHashMap</span><span class="params">()</span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;time&quot;</span>+System.currentTimeMillis(), <span class="string">&quot;测试:&quot;</span>+System.currentTimeMillis());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String,String&gt; <span class="title function_">createMap</span><span class="params">(String date, String number, String code, String type)</span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;date&quot;</span>, date);</span><br><span class="line">        map.put(<span class="string">&quot;number&quot;</span>, number);</span><br><span class="line">        map.put(<span class="string">&quot;code&quot;</span>, code);</span><br><span class="line">        map.put(<span class="string">&quot;type&quot;</span>, type);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="结论-1"><a href="#结论-1" class="headerlink" title="结论"></a>结论</h1><ol>
<li><code>identity</code> 只会初始化一次。</li>
<li><code>identity</code> 在每次 <code>downstream</code> 的时候会重新放到 <strong>左值(left)</strong> 中。</li>
<li>如果操作 <code>identity</code> 的话, 将会影响下次 <code>downstream</code> 的第一次的 <strong>左值(left)</strong></li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/46143242/">java8 Stream List<Map> how to covert a Map after groupingBy</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Java8</tag>
      </tags>
  </entry>
  <entry>
    <title>JDBC简单使用</title>
    <url>/posts/JDBC_simple_use.html</url>
    <content><![CDATA[<h1 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h1><p>先<a href="https://dev.mysql.com/downloads/connector/j/">下载jar包</a> ，或者<a href="https://mvnrepository.com/artifact/mysql/mysql-connector-java">导入maven</a></p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line"><span class="comment">//    private static final String driver = &quot;com.mysql.jdbc.Driver&quot;;//已过时</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">schema</span> <span class="operator">=</span> <span class="string">&quot;test&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">3306</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:&quot;</span></span><br><span class="line">            + port + <span class="string">&quot;/&quot;</span> + schema+<span class="string">&quot;?serverTimezone=GMT&amp;useUnicode=true&amp;characterEncoding=utf8&quot;</span>;</span><br><span class="line">    <span class="comment">//最好使用properties文件存储配置信息，或者使用数据库连接池</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Connection conn;<span class="comment">//建立连接</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initJDBC</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Class.forName(driver);<span class="comment">//加载驱动</span></span><br><span class="line">        conn = DriverManager.getConnection(url, username, password);<span class="comment">//建立数据库连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRead</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Statement</span> <span class="variable">s</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">            <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> s.executeQuery(<span class="string">&quot;SELECT * FROM stu;&quot;</span>)<span class="comment">//查询数据表返回结果集</span></span><br><span class="line">        ) &#123;</span><br><span class="line">            <span class="type">ResultSetMetaData</span> <span class="variable">rsmd</span> <span class="operator">=</span> rs.getMetaData();<span class="comment">//获取结果集的元数据</span></span><br><span class="line">            <span class="keyword">while</span> (rs.next()) &#123;<span class="comment">//如果有下一条记录</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= rsmd.getColumnCount(); i++) &#123;</span><br><span class="line">                    System.out.print(rs.getString(i)+<span class="string">&quot;\t&quot;</span>);<span class="comment">//将每列打印输出</span></span><br><span class="line">                &#125;</span><br><span class="line">                System.out.print(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">destoryJDBC</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        conn.close();<span class="comment">//释放连接</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="执行SQL语句的Statement"><a href="#执行SQL语句的Statement" class="headerlink" title="执行SQL语句的Statement"></a>执行SQL语句的Statement</h1><h2 id="Statement的基本用法"><a href="#Statement的基本用法" class="headerlink" title="Statement的基本用法"></a>Statement的基本用法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecuteUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Statement</span> <span class="variable">s</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        )&#123;</span><br><span class="line">            s.executeUpdate(<span class="string">&quot;CREATE TABLE stu(&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;sid INT UNSIGNED PRIMARY KEY AUTO_INCREMENT,&quot;</span> +</span><br><span class="line">                    <span class="string">&quot;sname VARCHAR(20),&quot;</span> + <span class="string">&quot;age INT ,&quot;</span> + <span class="string">&quot;tid INT )&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;共有&quot;</span>+<span class="number">0</span>+<span class="string">&quot;条记录受影响&quot;</span>);<span class="comment">//执行DDL语句时返回0</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">records</span> <span class="operator">=</span> s.executeUpdate(<span class="string">&quot;UPDATE stu SET age=age+1&quot;</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;共有&quot;</span>+records+<span class="string">&quot;条记录受影响&quot;</span>);<span class="comment">//执行DML语句时返回受影响记录数目</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testExecute</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">Statement</span> <span class="variable">s</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">hasResultSet</span> <span class="operator">=</span> s.execute(<span class="string">&quot;SELECT * FROM stu;&quot;</span>);<span class="comment">//判断有没有结果集</span></span><br><span class="line">            <span class="keyword">if</span>(hasResultSet)&#123;</span><br><span class="line">                <span class="keyword">try</span>(<span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> s.getResultSet())&#123;<span class="comment">//获取结果集</span></span><br><span class="line">                    <span class="type">ResultSetMetaData</span> <span class="variable">rsmd</span> <span class="operator">=</span> rs.getMetaData();<span class="comment">//获取结果集元数据</span></span><br><span class="line">                    <span class="keyword">while</span> (rs.next()) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= rsmd.getColumnCount(); i++) &#123;</span><br><span class="line">                            System.out.print(rs.getString(i)+<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                        System.out.print(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;    <span class="comment">//省略释放资源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="预编译的PreparedStatement"><a href="#预编译的PreparedStatement" class="headerlink" title="预编译的PreparedStatement"></a>预编译的PreparedStatement</h2><p><code>PreparedStatement</code>是<code>Statement</code>的子接口，可以预编译<code>SQL</code>语句，效率高，还可以防注入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testPreparedStatement</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> conn.prepareStatement(</span><br><span class="line">                <span class="string">&quot;INSERT INTO stu(sname, age) VALUES(?,?) &quot;</span>);<span class="comment">//预编译SQL语句</span></span><br><span class="line">        )&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">                ps.setString(<span class="number">1</span>,<span class="string">&quot;stu&quot;</span>+i);<span class="comment">//填充占位符</span></span><br><span class="line">                ps.setInt(<span class="number">2</span>, <span class="number">20</span>+i);<span class="comment">//填充占位符</span></span><br><span class="line">                ps.executeUpdate();<span class="comment">//提交</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SQLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略释放资源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="调用存储过程的CallableStatement"><a href="#调用存储过程的CallableStatement" class="headerlink" title="调用存储过程的CallableStatement"></a>调用存储过程的CallableStatement</h2><p>自定义一个加法的存储过程</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> add_num(<span class="keyword">in</span> a <span class="type">int</span>, <span class="keyword">in</span> b <span class="type">int</span>, <span class="keyword">out</span> sum <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">set</span> sum <span class="operator">=</span> a <span class="operator">+</span> b;</span><br><span class="line"><span class="keyword">end</span><span class="operator">/</span><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testCallableStatement</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">CallableStatement</span> <span class="variable">cs</span> <span class="operator">=</span> conn.prepareCall(<span class="string">&quot;&#123;CALL add_num(?,?,?)&#125;&quot;</span>);)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">5</span>, b = <span class="number">3</span>;</span><br><span class="line">            cs.setInt(<span class="number">1</span>, a);</span><br><span class="line">            cs.setInt(<span class="number">2</span>, b);</span><br><span class="line">            cs.registerOutParameter(<span class="number">3</span>, Types.INTEGER);</span><br><span class="line">            cs.execute();</span><br><span class="line">            System.out.println(a+<span class="string">&quot;+&quot;</span>+b+<span class="string">&quot;=&quot;</span>+cs.getInt(<span class="number">3</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略释放资源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testTransaction</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        conn.setAutoCommit(<span class="literal">false</span>); <span class="comment">// 关闭事务自动提交</span></span><br><span class="line">        <span class="type">Statement</span> <span class="variable">s</span> <span class="operator">=</span> conn.createStatement();</span><br><span class="line">        s.executeUpdate(<span class="string">&quot;INSERT INTO stu(sname) VALUES (&#x27;stu1&#x27;);&quot;</span>);</span><br><span class="line">        s.executeUpdate(<span class="string">&quot;INSERT INTO stu(sname) VALUES (&#x27;stu2&#x27;);&quot;</span>);</span><br><span class="line">        <span class="type">Savepoint</span> <span class="variable">sp</span> <span class="operator">=</span> conn.setSavepoint(<span class="string">&quot;事务中间点&quot;</span>); <span class="comment">// 设置事务中间点</span></span><br><span class="line">        s.executeUpdate(<span class="string">&quot;INSERT INTO stu(sname) VALUES (&#x27;stu3&#x27;);&quot;</span>);</span><br><span class="line">        conn.rollback(sp); <span class="comment">// 回滚事务</span></span><br><span class="line">        conn.commit();     <span class="comment">// 提交事务</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略释放资源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="数据库连接池"><a href="#数据库连接池" class="headerlink" title="数据库连接池"></a>数据库连接池</h1><h2 id="DBCP数据源"><a href="#DBCP数据源" class="headerlink" title="DBCP数据源"></a>DBCP数据源</h2><p><code>Tomcat</code>的连接池使用<code>DBCP</code>连接池。<br>在<a href="https://mvnrepository.com/artifact/commons-dbcp/commons-dbcp/1.4">maven中导入</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-dbcp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从数据库连接池中获取数据库连接</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDBCP</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">//BasicDataSource bds = BasicDataSourceFactory.createDataSource(properties);//另一种创建方式</span></span><br><span class="line">        <span class="type">BasicDataSource</span> <span class="variable">bds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BasicDataSource</span>();</span><br><span class="line">        bds.setDriverClassName(driver); <span class="comment">// 加载驱动</span></span><br><span class="line">        bds.setUrl(url);                <span class="comment">// 设置url</span></span><br><span class="line">        bds.setUsername(username);      <span class="comment">// 设置用户名</span></span><br><span class="line">        bds.setPassword(password);      <span class="comment">// 设置密码</span></span><br><span class="line">        bds.setInitialSize(<span class="number">5</span>);          <span class="comment">//设置连接池的初始连接数</span></span><br><span class="line">        bds.setMaxActive(<span class="number">20</span>);           <span class="comment">//设置连接池最多可有20个活动连接数</span></span><br><span class="line">        bds.setMinIdle(<span class="number">2</span>);              <span class="comment">//设置连接池中最少有2个空闲的连接</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> bds.getConnection();</span><br><span class="line">        <span class="comment">//执行sql语句</span></span><br><span class="line">        conn.close();<span class="comment">//释放连接，归还连接池</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略释放资源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="C3P0数据源"><a href="#C3P0数据源" class="headerlink" title="C3P0数据源"></a>C3P0数据源</h2><p><code>Hibernate</code>的连接池使用<code>C3P0</code>连接池。<br>在<a href="https://mvnrepository.com/artifact/c3p0/c3p0/0.9.1.2">maven中导入</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>c3p0<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>从数据库连接池中获取数据库连接</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JDBCTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testC3P0</span><span class="params">()</span> <span class="keyword">throws</span> PropertyVetoException, SQLException &#123;</span><br><span class="line">        <span class="type">ComboPooledDataSource</span> <span class="variable">cpds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">        cpds.setDriverClass(driver); <span class="comment">// 加载驱动</span></span><br><span class="line">        cpds.setJdbcUrl(url);        <span class="comment">// 设置url</span></span><br><span class="line">        cpds.setUser(username);      <span class="comment">// 设置用户名</span></span><br><span class="line">        cpds.setPassword(password);  <span class="comment">// 设置密码</span></span><br><span class="line">        cpds.setMaxPoolSize(<span class="number">40</span>);     <span class="comment">//设置连接池的最大连接数</span></span><br><span class="line">        cpds.setMinPoolSize(<span class="number">2</span>);      <span class="comment">//设置连接池的最小连接数</span></span><br><span class="line">        cpds.setInitialPoolSize(<span class="number">10</span>); <span class="comment">//设置连接池的初始连接数</span></span><br><span class="line">        cpds.setMaxStatements(<span class="number">190</span>);  <span class="comment">//设置连接池的缓存Statement的最大数</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> cpds.getConnection();</span><br><span class="line">        <span class="comment">//执行SQL语句</span></span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;    <span class="comment">//省略释放资源代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>JDBC</tag>
      </tags>
  </entry>
  <entry>
    <title>JUnit单元测试</title>
    <url>/posts/junit_foundation.html</url>
    <content><![CDATA[<h1 id="常规的单元测试"><a href="#常规的单元测试" class="headerlink" title="常规的单元测试"></a>常规的单元测试</h1><h2 id="编写被测试类"><a href="#编写被测试类" class="headerlink" title="编写被测试类"></a>编写被测试类</h2><p>进行单元测试首先需要一个被测试类和被测试方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Div</span>&#123;</span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">div</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a/b;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="编写测试类"><a href="#编写测试类" class="headerlink" title="编写测试类"></a>编写测试类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DivTest</span> &#123;</span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initClass</span><span class="params">()</span>&#123;    System.out.println(<span class="string">&quot;加载类前执行&quot;</span>);    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;    System.out.println(<span class="string">&quot;执行每个方法前执行&quot;</span>);    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">divTest</span><span class="params">()</span>&#123;</span><br><span class="line">       TestCase.assertEquals(<span class="number">3</span>, Div.div(<span class="number">6</span>,<span class="number">2</span>));</span><br><span class="line">       System.out.println(<span class="string">&quot;预期值为3,实际值为3&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@After</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destory</span><span class="params">()</span>&#123;    System.out.println(<span class="string">&quot;执行每个方法后执行&quot;</span>);    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">destoryClass</span><span class="params">()</span>&#123;    System.out.println(<span class="string">&quot;执行完所有Test方法后执行&quot;</span>);    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="其他常用注释"><a href="#其他常用注释" class="headerlink" title="其他常用注释"></a>其他常用注释</h1><h2 id="Test"><a href="#Test" class="headerlink" title="@Test"></a>@Test</h2><ul>
<li><code>expected</code>：预期会抛出某个异常</li>
<li><code>timeout</code>：预期运行时间不超过<code>xx</code>毫秒</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DivTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test(expected = ArithmeticException.class, timeout = 2000)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">divTest</span><span class="params">()</span>&#123;</span><br><span class="line">        TestCase.assertEquals(<span class="number">3</span>, Div.div(<span class="number">6</span>,<span class="number">0</span>));</span><br><span class="line">        <span class="comment">//会抛出ArithmeticException异常，由于expected捕获了异常，所以不会抛出</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ignore"><a href="#Ignore" class="headerlink" title="@Ignore"></a>@Ignore</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DivTest</span> &#123;</span><br><span class="line">    <span class="meta">@Ignore</span></span><br><span class="line">    <span class="meta">@Test()</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">divTest</span><span class="params">()</span>&#123;</span><br><span class="line">        TestCase.assertEquals(<span class="number">3</span>, Div.div(<span class="number">6</span>,<span class="number">0</span>));</span><br><span class="line">        <span class="comment">//这个方法不执行，被忽略</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="测试套件的使用（多个测试类一起执行）"><a href="#测试套件的使用（多个测试类一起执行）" class="headerlink" title="测试套件的使用（多个测试类一起执行）"></a>测试套件的使用（多个测试类一起执行）</h1><p>有时候需要将几个测试类一起测试，需要用到测试套件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(Suite.class)</span><span class="comment">//修改JUnit的默认执行类,默认值为Suite.class</span></span><br><span class="line"><span class="meta">@Suite</span>.SuiteClasses(&#123;DivTest.class,DivTest.class&#125;)<span class="comment">//接收一个Class数组，表示要测试的类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SuiteTest</span> &#123;</span><br><span class="line">    <span class="comment">//空类体，本测试套件将执行DivTest两次</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参数化设置（编写测试用例）"><a href="#参数化设置（编写测试用例）" class="headerlink" title="参数化设置（编写测试用例）"></a>参数化设置（编写测试用例）</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(Parameterized.class)</span><span class="comment">//修改JUnit的默认执行类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ParameterizdTest</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">expected</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">input1</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">input2</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ParameterizdTest</span><span class="params">(<span class="type">int</span> expected, <span class="type">int</span> input1, <span class="type">int</span> input2)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.expected = expected;</span><br><span class="line">        <span class="built_in">this</span>.input1 = input1;</span><br><span class="line">        <span class="built_in">this</span>.input2 = input2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//实现一个被@Parameterized.Parameters注解修饰的返回Collection的方法</span></span><br><span class="line">    <span class="meta">@Parameterized</span>.Parameters</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Collection&lt;Object[]&gt; t()&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="keyword">new</span> <span class="title class_">Object</span>[][]&#123;</span><br><span class="line">                &#123;<span class="number">3</span>, <span class="number">6</span>, <span class="number">2</span>&#125;,</span><br><span class="line">                &#123;<span class="number">4</span>, <span class="number">4</span>, <span class="number">2</span>&#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">divTest</span><span class="params">()</span>&#123;</span><br><span class="line">        TestCase.assertEquals(expected, Div.div(input1, input2));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>JUnit</tag>
      </tags>
  </entry>
  <entry>
    <title>什么是Json Web Token</title>
    <url>/posts/What_is_Json_Web_Token?.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Jwt</code>全称<code>Json Web Token</code>, 是一种防篡改的数据格式, 可以明文, 可以加密. 我们可以用来存储简单的鉴权信息在<code>Jwt</code>之中.<br>现在主流的应用场景有单点登录, 替代<code>Session</code>, 一次性鉴权.</p>
<p>但是我发现了这篇文章<a href="http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/">Stop using JWT for sessions</a>, 作者说不要用<code>Jwt</code>来进行身份认证.<br>建议看完本文后, 再深入阅读这篇文章.</p>
<span id="more"></span>

<p><code>Jwt</code>只是一种数据格式, 就像<code>JSON</code>一样!<br><code>Jwt</code>只是一种数据格式, 就像<code>JSON</code>一样!<br><code>Jwt</code>只是一种数据格式, 就像<code>JSON</code>一样!<br>重要的话说<code>3</code>遍, 好了往下看.</p>
<h1 id="结构组成"><a href="#结构组成" class="headerlink" title="结构组成"></a>结构组成</h1><figure class="highlight text"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJKb2UifQ.gG3FV1r3HgYYUd04sTUh2asQbk68SjmkivuaBHCRhLo</span><br></pre></td></tr></table></figure>
<p>上面是一个<code>JWT</code>, 分为<code>3</code>个部分, <code>header</code>和<code>claims</code>都是用<code>base64</code>编码, <code>3</code>个部分用<code>.</code>连接起来.</p>
<ol>
<li><code>header</code>: 头部, 最少包含了签名算法.</li>
<li><code>claims</code>: 内容, 包含了你想要放进去的数据.</li>
<li><code>signature</code>: 签名</li>
</ol>
<p>用<code>base64</code>解码<code>header</code>和<code>claims</code>可得</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiJ9 ----&gt; &#123;&quot;alg&quot;:&quot;HS256&quot;&#125;</span><br><span class="line">eyJzdWIiOiJKb2UifQ   ----&gt; &#123;&quot;sub&quot;:&quot;Joe&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>后面的<code>gG3FV1r3HgYYUd04sTUh2asQbk68SjmkivuaBHCRhLo</code>是签名, 是不可读的, 签名算法就是<code>header</code>的<code>alg</code>字段的值<code>HS256</code>.<br>可以在<a href="https://jwt.io/"><code>Debugger</code>工具</a>测试.</p>
<p><code>Q1</code>: 为什么说<code>Jwt</code>是防篡改的?<br><code>A1</code>: 我们不知道签名的私钥, 不信你在<a href="https://jwt.io/"><code>Debugger</code>工具</a>试试, 用上面的<code>header</code>和<code>claims</code>, 在不知道私钥的情况下, 你能得到<code>gG3FV1r3HgYYUd04sTUh2asQbk68SjmkivuaBHCRhLo</code>吗? 我就告诉你私钥是<code>123456</code>了, 你猜的到吗?</p>
<p><code>Q2</code>: <code>Jwt</code>能用来替换<code>Session</code>吗?<br><code>A2</code>: 它们应该是组合使用, 而不是对立的. <a href="http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/">Stop using JWT for sessions</a></p>
<p><code>Q3</code>: 那我到底要在什么地方用<code>Jwt</code>?<br><code>A3</code>: 一般移动端用的比较多, 移动端不像浏览器有一套透明的<code>Cookie</code>方案.</p>
<h1 id="JJWT-应用"><a href="#JJWT-应用" class="headerlink" title="JJWT 应用"></a>JJWT 应用</h1><p>我们先来看一个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">verify</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">now</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 生成 jwt</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(<span class="string">&quot;signKey&quot;</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> Jwts.builder()</span><br><span class="line">            .setId(<span class="string">&quot;id&quot;</span>)                <span class="comment">// JWT_ID</span></span><br><span class="line">            .setAudience(<span class="string">&quot;audience&quot;</span>)    <span class="comment">// 接受者</span></span><br><span class="line">            .setSubject(<span class="string">&quot;subject&quot;</span>)      <span class="comment">// 主题</span></span><br><span class="line">            .setIssuer(<span class="string">&quot;issuer&quot;</span>)        <span class="comment">// 签发者</span></span><br><span class="line">            .addClaims(<span class="literal">null</span>)            <span class="comment">// 自定义属性</span></span><br><span class="line">            .setIssuedAt(<span class="keyword">new</span> <span class="title class_">Date</span>(now))        <span class="comment">// 签发时间</span></span><br><span class="line">            .setNotBefore(<span class="keyword">new</span> <span class="title class_">Date</span>(now - <span class="number">1</span>))   <span class="comment">// 生效时间</span></span><br><span class="line">            .setExpiration(<span class="keyword">new</span> <span class="title class_">Date</span>(now + <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>))  <span class="comment">// 过期时间</span></span><br><span class="line">            .signWith(SignatureAlgorithm.HS256, key); <span class="comment">// 签名算法以及密匙</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> builder.compact();</span><br><span class="line">        System.out.println(token);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 解析 jwt</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Jws&lt;Claims&gt; jws = Jwts.parser()</span><br><span class="line">                .setSigningKey(key)</span><br><span class="line">                .parseClaimsJws(token);</span><br><span class="line">            <span class="type">JwsHeader</span> <span class="variable">header</span> <span class="operator">=</span> jws.getHeader();</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> jws.getBody();</span><br><span class="line"></span><br><span class="line">            Assertions.assertEquals(SignatureAlgorithm.HS256.getValue(), header.getAlgorithm());</span><br><span class="line">            Assertions.assertEquals(<span class="string">&quot;id&quot;</span>, claims.getId());</span><br><span class="line">            Assertions.assertEquals(<span class="string">&quot;audience&quot;</span>, claims.getAudience());</span><br><span class="line">            Assertions.assertEquals(<span class="string">&quot;subject&quot;</span>, claims.getSubject());</span><br><span class="line">            Assertions.assertEquals(<span class="string">&quot;issuer&quot;</span>, claims.getIssuer());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ExpiredJwtException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JwtBuilder</code>使用<code>Builder</code>模式, 构建<code>header</code>和<code>claims</code>, 最后再调用<code>signWith</code>方法添加<code>signature</code>签名.<br>之后我们使用<code>Jwts.parser()</code>来解析<code>token</code>, 在<code>parseClaimsJws(token)</code>会抛出一堆<code>RuntimeException</code>, 用来校验<code>token</code>是否有效.<br>得到的<code>Claims</code>其实就是一个<code>Map</code>, 我们从中获取需要的数据即可.</p>
<h1 id="整合-Spring-Boot"><a href="#整合-Spring-Boot" class="headerlink" title="整合 Spring Boot"></a>整合 Spring Boot</h1><p>查看我在<code>Github</code>上的一个示例工程.<br><a href="https://github.com/Ahaochan/project/tree/master/ahao-spring-boot-jwt">https://github.com/Ahaochan/project/tree/master/ahao-spring-boot-jwt</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://jwt.io/">JSON Web Token</a></li>
<li><a href="http://cryto.net/~joepie91/blog/2016/06/13/stop-using-jwt-for-sessions/">Stop using JWT for sessions</a></li>
<li><a href="http://cryto.net/~joepie91/blog/2016/06/19/stop-using-jwt-for-sessions-part-2-why-your-solution-doesnt-work/">Stop using JWT for sessions, part 2: Why your solution doesn’t work</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Java SE</tag>
      </tags>
  </entry>
  <entry>
    <title>Java导出Excel出现emoji乱码</title>
    <url>/posts/Java_export_Excel_appears_emoji_garbled.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>做后端开发经常需要导出<code>Excel</code>, 一般有两种选择<code>POI</code>、<code>JXLS</code>和<code>easyexcel</code>.<br>其实底层都是使用<code>POI</code>来做的.</p>
<span id="more"></span>

<h1 id="三种框架分析"><a href="#三种框架分析" class="headerlink" title="三种框架分析"></a>三种框架分析</h1><ol>
<li><code>Apache</code>名下的<code>POI</code><ul>
<li>优点: 微软全家桶基本都可以做, 什么<code>Word</code>、<code>Excel</code>、<code>PPT</code>.</li>
<li>缺点: 所有格式都要通过代码完成, 代码又长又臭.</li>
</ul>
</li>
<li><code>JXLS</code>专门用来操作<code>Excel</code>, 使用<code>JXLS</code>模板语法可以书写<code>Excel</code>模板, 底层使用<code>org.jxls.transform.poi.PoiTransformer</code>和<code>POI</code>做对接.<ul>
<li>优点: 使用<code>JXLS</code>模板语法, 可以将格式和代码解耦, 快速开发, 代码精简.</li>
<li>缺点: 需要额外的学习成本学习<code>JXLS</code>模板语法(学什么不是学</li>
</ul>
</li>
<li><code>easyexcel</code>是阿里基于<code>POI</code>开发的<code>Excel</code>解析工具.<ul>
<li>优点: 据<a href="https://github.com/alibaba/easyexcel/blob/master/README.md"><code>README</code></a>说, 解决<code>POI</code>内存溢出问题.</li>
<li>缺点: 没用过不评价</li>
</ul>
</li>
</ol>
<h1 id="emoji乱码代码单元测试"><a href="#emoji乱码代码单元测试" class="headerlink" title="emoji乱码代码单元测试"></a>emoji乱码代码单元测试</h1><p>复现下测试环境, 依赖<code>pom.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.poi/poi --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">     <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.poi/poi-ooxml --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.poi<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>poi-ooxml<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.17<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!-- poi-ooxml 依赖 poi-ooxml-schemas, 依赖 xmlbeans 2.6.0 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.apache.xmlbeans/xmlbeans --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- &lt;dependency&gt;</span></span><br><span class="line"><span class="comment">        &lt;groupId&gt;org.apache.xmlbeans&lt;/groupId&gt;</span></span><br><span class="line"><span class="comment">        &lt;artifactId&gt;xmlbeans&lt;/artifactId&gt;</span></span><br><span class="line"><span class="comment">        &lt;version&gt;2.6.0&lt;/version&gt;</span></span><br><span class="line"><span class="comment">    &lt;/dependency&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>生成<code>Excel</code>的代码.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="comment">// 𤆕🔝biu～  better me人🌝</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">UNICODE</span> <span class="operator">=</span> <span class="string">&quot;\uD850\uDD95\uD83D\uDD1Dbiu～\t\uE110better me\uE110人\uD83C\uDF1D&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        createXLSX(<span class="string">&quot;C:/test.xlsx&quot;</span>);</span><br><span class="line">        createXLS(<span class="string">&quot;C:/test.xls&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createXLSX</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">XSSFWorkbook</span> <span class="variable">workbook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XSSFWorkbook</span>();</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filename)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">XSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> workbook.createSheet(<span class="string">&quot;TestSheet&quot;</span>);</span><br><span class="line">            <span class="type">XSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">            <span class="type">XSSFCell</span> <span class="variable">cell1</span> <span class="operator">=</span> row.createCell(<span class="number">0</span>);</span><br><span class="line">            cell1.setCellValue(UNICODE);</span><br><span class="line"></span><br><span class="line">            workbook.write(fos);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createXLS</span><span class="params">(String filename)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">HSSFWorkbook</span> <span class="variable">workbook</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HSSFWorkbook</span>();</span><br><span class="line">            <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span><span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filename)) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="type">HSSFSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> workbook.createSheet(<span class="string">&quot;TestSheet&quot;</span>);</span><br><span class="line">            <span class="type">HSSFRow</span> <span class="variable">row</span> <span class="operator">=</span> sheet.createRow(<span class="number">0</span>);</span><br><span class="line">            <span class="type">HSSFCell</span> <span class="variable">cell1</span> <span class="operator">=</span> row.createCell(<span class="number">0</span>);</span><br><span class="line">            cell1.setCellValue(UNICODE);</span><br><span class="line"></span><br><span class="line">            workbook.write(fos);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行完毕, 可以看到<code>xls</code>能正常输出<code>𤆕🔝biu～    better me人🌝</code>, 而<code>xlsx</code>只能输出<code>????biu～    better me人??</code>.<br><code>emoji</code>表情不能输出.</p>
<h1 id="解决方案-简单版"><a href="#解决方案-简单版" class="headerlink" title="解决方案(简单版)"></a>解决方案(简单版)</h1><p>解决方案有两种.</p>
<ol>
<li>升级<code>POI</code>为<code>4.0.0</code>以上.</li>
<li>替换<code>xmlbeans</code>为<code>3.0.0</code>以上.</li>
</ol>
<p>本质都是替换<code>xmlbeans</code>.</p>
<h1 id="问题原因"><a href="#问题原因" class="headerlink" title="问题原因"></a>问题原因</h1><p>为什么<code>xls</code>没问题, <code>xlsx</code>有问题?<br>因为<code>xls</code>的<code>HSSFRichTextString</code>使用了<code>UnicodeString</code>进行编码, 内联字符串, 没有重用字符串.<br>而<code>xlsx</code>为了解决内存问题, 将相同字符串先写入<code>sharedStrings.xml</code>, 重用字符串. </p>
<p>我们可以将一个<code>xlsx</code>改为<code>zip</code>解压, 在里面可以找到一个<code>sharedStrings.xml</code>文件, 里面就存储着我们的字符串.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sst</span> <span class="attr">count</span>=<span class="string">&quot;1&quot;</span> <span class="attr">uniqueCount</span>=<span class="string">&quot;1&quot;</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://schemas.openxmlformats.org/spreadsheetml/2006/main&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">si</span>&gt;</span><span class="tag">&lt;<span class="name">t</span>&gt;</span>????biu～  better me人??<span class="tag">&lt;/<span class="name">t</span>&gt;</span><span class="tag">&lt;/<span class="name">si</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sst</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>那很明显就是写入<code>xml</code>的时候出了问题.</p>
<p><a href="https://stackoverflow.com/a/38039869">Write 16 bits character to .xlsx file using Apache POI in Java</a>提到了<code>org.apache.xmlbeans.impl.store.Saver</code>的<code>isBadChar</code>方法.<br><a href="https://github.com/apache/xmlbeans/blob/2.6.0/src/store/org/apache/xmlbeans/impl/store/Saver.java#L1559-L1567">点击查看源码<code>L1559</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Saver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isBadChar</span><span class="params">(<span class="type">char</span> ch)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ! (</span><br><span class="line">            (ch &gt;= <span class="number">0x20</span> &amp;&amp; ch &lt;= <span class="number">0xD7FF</span> ) ||</span><br><span class="line">            (ch &gt;= <span class="number">0xE000</span> &amp;&amp; ch &lt;= <span class="number">0xFFFD</span>) ||</span><br><span class="line">            (ch &gt;= <span class="number">0x10000</span> &amp;&amp; ch &lt;= <span class="number">0x10FFFF</span>) ||</span><br><span class="line">            (ch == <span class="number">0x9</span>) || (ch == <span class="number">0xA</span>) || (ch == <span class="number">0xD</span>)</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以<code>🌝</code>这个字符为例, 它的<code>Unicode</code>编码为<code>\uD83C\uDF1D</code>, 一个<code>char</code>是存不下的, 要用两个<code>char</code>.<br>那么第一个<code>char</code>传入<code>isBadChar</code>, 得到<code>true</code>. 第二个<code>char</code>传入也得到<code>true</code>.<br>那么我们看下哪里有调用到这个<code>isBadChar</code>方法.<br><a href="https://github.com/apache/xmlbeans/blob/2.6.0/src/store/org/apache/xmlbeans/impl/store/Saver.java#L2310">点击查看源码<code>L2310</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Saver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">entitizeAndWriteCommentText</span><span class="params">(<span class="type">int</span> bufLimit)</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; bufLimit; i++) &#123;</span><br><span class="line">            <span class="type">char</span> <span class="variable">ch</span> <span class="operator">=</span> _buf[ i ];</span><br><span class="line">            <span class="keyword">if</span> (isBadChar(ch))</span><br><span class="line">                _buf[i] = <span class="string">&#x27;?&#x27;</span>;</span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有很多地方都有调用, 但是基本都是一个逻辑, 如果是<code>true</code>, 则替换为<code>?</code>, 所以我们才在<code>sharedStrings.xml</code>看到一堆<code>??</code>.<br>那这就是<code>xmlbeans</code>这个库的问题了, 不是我们代码的锅(甩锅大成功!</p>
<h1 id="xmlbeans-3-0-0-解决方案"><a href="#xmlbeans-3-0-0-解决方案" class="headerlink" title="xmlbeans 3.0.0 解决方案"></a>xmlbeans 3.0.0 解决方案</h1><p>再看看<code>xmlbeans 3.0.0</code>怎么解决的.<br><a href="https://github.com/apache/xmlbeans/blob/3.0.0/src/store/org/apache/xmlbeans/impl/store/Saver.java#L286-L287">点击查看源码<code>L286</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Saver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">isBadChar</span><span class="params">(<span class="type">char</span> ch)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> ! (</span><br><span class="line">            Character.isHighSurrogate(ch) ||</span><br><span class="line">            Character.isLowSurrogate(ch) ||</span><br><span class="line">            (ch &gt;= <span class="number">0x20</span> &amp;&amp; ch &lt;= <span class="number">0xD7FF</span> ) ||</span><br><span class="line">            (ch &gt;= <span class="number">0xE000</span> &amp;&amp; ch &lt;= <span class="number">0xFFFD</span>) ||</span><br><span class="line">            (ch &gt;= <span class="number">0x10000</span> &amp;&amp; ch &lt;= <span class="number">0x10FFFF</span>) ||</span><br><span class="line">            (ch == <span class="number">0x9</span>) || (ch == <span class="number">0xA</span>) || (ch == <span class="number">0xD</span>)</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以<code>🌝</code>这个字符为例, 它的<code>Unicode</code>编码为<code>\uD83C\uDF1D</code>, 一个<code>char</code>是存不下的, 要用两个<code>char</code>.<br>那么第一个<code>char</code>传入<code>isBadChar</code>, 得到<code>false</code>. 第二个<code>char</code>传入也得到<code>false</code>.<br>所以也就不会被替换成<code>?</code>, <code>bug</code> 解决.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/a/51852614">Writing Unicode plane 1 characters with Apache POI</a></li>
<li><a href="https://stackoverflow.com/a/38039869">Write 16 bits character to .xlsx file using Apache POI in Java</a></li>
<li><a href="https://www.yanghuandy.cn/2018/08/15/Java%E5%AF%BC%E5%87%BAExcel/">Java导出Excel</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Java SE</tag>
      </tags>
  </entry>
  <entry>
    <title>Java常量字符串过长</title>
    <url>/posts/constant_string_is_too_long.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在使用 <code>fastjson</code> 从 <code>url</code> 下载 <code>json</code> 解析时候, 出现了语法错误。<br>要排错, 于是将一堆 <code>json</code> 数据复制到 <code>String</code>。<br>结果报编译异常<strong>常量字符串过长</strong>。</p>
<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>使用 <code>Eclipse编译器</code> 解决问题。<br><code>IDEA 2017.1.5</code> 的操作流程:<br>File -&gt; Settings -&gt; Build,Execution,Deployment -&gt; Compiler -&gt; Java Compiler<br>点击 <code>Use Compiler</code>, 选择 <code>Eclipse</code>, 点击确定保存即可。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>IDEA</tag>
      </tags>
  </entry>
  <entry>
    <title>Java异常捕捉顺序</title>
    <url>/posts/The_capture_order_of_Java_Exception.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一直对异常捕捉都是<code>e.printStackTrace()</code>就完事了, 突然对异常捕捉顺序很好奇, 就做了个测试, 直接看代码。</p>
<span id="more"></span>

<h1 id="从小到大捕捉"><a href="#从小到大捕捉" class="headerlink" title="从小到大捕捉"></a>从小到大捕捉</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;文件没找到&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e)&#123;</span><br><span class="line">            <span class="comment">// 结果输出 ` FileNotFoundException `</span></span><br><span class="line">            System.out.println(<span class="string">&quot;FileNotFoundException &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="comment">// 不执行, 已被FileNotFoundException捕捉</span></span><br><span class="line">            System.out.println(<span class="string">&quot;IOException&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">// 不执行, 已被FileNotFoundException捕捉</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Exception &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">            <span class="comment">// 不执行, 已被FileNotFoundException捕捉</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Throwable &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="从大到小捕捉"><a href="#从大到小捕捉" class="headerlink" title="从大到小捕捉"></a>从大到小捕捉</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(<span class="string">&quot;文件没找到&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;Throwable &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException e)&#123;</span><br><span class="line">            <span class="comment">// 编译错误, 提示异常已被 Throwable 捕捉</span></span><br><span class="line">            System.out.println(<span class="string">&quot;FileNotFoundException &quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            <span class="comment">// 编译错误, 提示异常已被 Throwable 捕捉</span></span><br><span class="line">            System.out.println(<span class="string">&quot;IOException&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            <span class="comment">// 编译错误, 提示异常已被 Throwable 捕捉</span></span><br><span class="line">            System.out.println(<span class="string">&quot;Exception &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>Java异常捕捉顺序是</p>
<ol>
<li>从上到下</li>
<li>从小到大</li>
</ol>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Exception</tag>
      </tags>
  </entry>
  <entry>
    <title>Java解析XML</title>
    <url>/posts/Java_parsing_XML.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<a href="/posts/XML_syntax.html" title="XML语法详解">XML语法详解</a>
</blockquote>
<p>定义一个<code>xml</code>文档</p>
<span id="more"></span>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">store</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">book</span> <span class="attr">id</span>=<span class="string">&quot;01&quot;</span>&gt;</span>第一本书<span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">book</span> <span class="attr">id</span>=<span class="string">&quot;02&quot;</span>&gt;</span>第二本书<span class="tag">&lt;/<span class="name">book</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">store</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="原生解析"><a href="#原生解析" class="headerlink" title="原生解析"></a>原生解析</h1><h2 id="DOM解析"><a href="#DOM解析" class="headerlink" title="DOM解析"></a>DOM解析</h2><ul>
<li>优点：容易实现增删改操作</li>
<li>缺点：<code>xml</code>过大时容易造成内存溢出</li>
</ul>
<p><a href="http://tool.oschina.net/uploads/apidocs/jdk-zh/org/w3c/dom/Document.html">Document API文档</a> 和<code>js</code>中的DOM操作类似</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;./src/main/resources/1.xml&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">DocumentBuilderFactory</span> <span class="variable">factory</span> <span class="operator">=</span> DocumentBuilderFactory.newInstance();</span><br><span class="line">    <span class="type">DocumentBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> factory.newDocumentBuilder();</span><br><span class="line">    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> builder.parse(filePath);</span><br><span class="line">    <span class="type">NodeList</span> <span class="variable">books</span> <span class="operator">=</span> doc.getElementsByTagName(<span class="string">&quot;book&quot;</span>); <span class="comment">// 根据标签名获取标签</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; books.getLength(); i++) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">book</span> <span class="operator">=</span> books.item(i);</span><br><span class="line">        NamedNodeMap attr= book.getAttributes();</span><br><span class="line">        System.out.println(i+<span class="string">&quot;i:&quot;</span>+book.getTextContent()); <span class="comment">// 输出book标签的文本内容</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; attr.getLength(); j++)&#123;</span><br><span class="line">            System.out.println(j+<span class="string">&quot;j:&quot;</span>+attr.item(j)); <span class="comment">// 输出book标签的所有属性值</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 添加一个标签</span></span><br><span class="line">    <span class="type">Element</span> <span class="variable">newBook</span> <span class="operator">=</span> doc.createElement(<span class="string">&quot;book&quot;</span>);</span><br><span class="line">    newBook.setAttribute(<span class="string">&quot;id&quot;</span>, books.getLength()+<span class="number">1</span>+<span class="string">&quot;&quot;</span>); <span class="comment">// 设置属性</span></span><br><span class="line">    doc.getElementsByTagName(<span class="string">&quot;store&quot;</span>).item(<span class="number">0</span>).appendChild(newBook); <span class="comment">// 添加到内存document中，此时未写入磁盘</span></span><br><span class="line">    <span class="type">TransformerFactory</span> <span class="variable">tffactory</span> <span class="operator">=</span> TransformerFactory.newInstance();</span><br><span class="line">    <span class="type">Transformer</span> <span class="variable">tf</span> <span class="operator">=</span> tffactory.newTransformer(); </span><br><span class="line">    tf.transform(<span class="keyword">new</span> <span class="title class_">DOMSource</span>(doc), <span class="keyword">new</span> <span class="title class_">StreamResult</span>(filePath)); <span class="comment">// 将document通过流的形式写入磁盘</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SAX解析"><a href="#SAX解析" class="headerlink" title="SAX解析"></a>SAX解析</h2><ul>
<li>优点：不会造成内存溢出，适合查询</li>
<li>缺点：不能进行增删改操作</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSAX</span><span class="params">()</span> <span class="keyword">throws</span> ParserConfigurationException, SAXException, IOException &#123;</span><br><span class="line">    <span class="type">SAXParserFactory</span> <span class="variable">factory</span> <span class="operator">=</span> SAXParserFactory.newInstance();</span><br><span class="line">    <span class="type">SAXParser</span> <span class="variable">parser</span> <span class="operator">=</span> factory.newSAXParser();</span><br><span class="line">    parser.parse(<span class="keyword">new</span> <span class="title class_">File</span>(filePath), <span class="keyword">new</span> <span class="title class_">DefaultHandler</span>()&#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">startElement</span><span class="params">(String uri, String localName,String qName,Attributes attributes)</span></span><br><span class="line">                <span class="keyword">throws</span> SAXException&#123;</span><br><span class="line">            System.out.print(<span class="string">&quot;&lt;&quot;</span>+qName+<span class="string">&quot;&gt;&quot;</span>); <span class="comment">// 开始标签</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">characters</span><span class="params">(<span class="type">char</span>[] ch, <span class="type">int</span> start, <span class="type">int</span> length)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">            System.out.print(<span class="keyword">new</span> <span class="title class_">String</span>(ch, start, length)); <span class="comment">// 标签内容</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">endElement</span><span class="params">(String uri, String localName, String qName)</span> <span class="keyword">throws</span> SAXException &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;&lt;/&quot;</span>+qName+<span class="string">&quot;&gt;&quot;</span>); <span class="comment">// 结束标签</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="dom4j解析"><a href="#dom4j解析" class="headerlink" title="dom4j解析"></a>dom4j解析</h1><h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><p><a href="https://mvnrepository.com/artifact/dom4j/dom4j/1.6.1">maven项目</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>dom4j<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.6.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDOM4J</span><span class="params">()</span> <span class="keyword">throws</span> DocumentException, IOException &#123;</span><br><span class="line">    <span class="type">SAXReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> reader.read(<span class="keyword">new</span> <span class="title class_">File</span>(filePath));</span><br><span class="line">    <span class="type">Element</span> <span class="variable">root</span> <span class="operator">=</span> doc.getRootElement();</span><br><span class="line">    List&lt;Element&gt; books = root.elements(<span class="string">&quot;book&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(Element book : books)&#123;</span><br><span class="line">        List&lt;Element&gt; names = book.elements(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        System.out.print(<span class="string">&quot;bookID:&quot;</span>+book.attributeValue(<span class="string">&quot;id&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span>(Element name : names)&#123;</span><br><span class="line">            System.out.println(name.getText());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//写入操作</span></span><br><span class="line">    <span class="type">Element</span> <span class="variable">newBook</span> <span class="operator">=</span> root.addElement(<span class="string">&quot;book&quot;</span>);</span><br><span class="line">    newBook.addAttribute(<span class="string">&quot;id&quot;</span>, books.size()+<span class="number">1</span>+<span class="string">&quot;&quot;</span>); <span class="comment">// 添加属性</span></span><br><span class="line">    newBook.addElement(<span class="string">&quot;name&quot;</span>).setText(<span class="string">&quot;第&quot;</span>+(books.size()+<span class="number">1</span>)+<span class="string">&quot;本书&quot;</span>); <span class="comment">// 添加元素</span></span><br><span class="line">    <span class="type">XMLWriter</span> <span class="variable">writer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XMLWriter</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="keyword">new</span> <span class="title class_">File</span>(filePath)), <span class="comment">// 流</span></span><br><span class="line">            OutputFormat.createPrettyPrint()); <span class="comment">// 格式化写入</span></span><br><span class="line">    writer.write(doc);</span><br><span class="line">    writer.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="支持xpath"><a href="#支持xpath" class="headerlink" title="支持xpath"></a>支持xpath</h2><p>导入<a href="https://mvnrepository.com/artifact/jaxen/jaxen/1.1.6">maven项目</a></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>jaxen<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jaxen<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">//book 所有book标签</span></span><br><span class="line"><span class="comment">/store/book/name 所有store标签下的book标签下的name标签</span></span><br><span class="line"><span class="comment">/* 所有标签，通配符</span></span><br><span class="line"><span class="comment">/store/book[1]/name[last()] store标签下的第一个book标签下的最后一个name标签</span></span><br><span class="line"><span class="comment">//book[@id] 所有有id属性的book标签</span></span><br><span class="line"><span class="comment">//book[@id=&#x27;01&#x27;] 所有id属性值为01的book标签</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testXPath</span><span class="params">()</span> <span class="keyword">throws</span> DocumentException &#123;</span><br><span class="line">    <span class="type">SAXReader</span> <span class="variable">reader</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SAXReader</span>();</span><br><span class="line">    <span class="type">Document</span> <span class="variable">doc</span> <span class="operator">=</span> reader.read(<span class="keyword">new</span> <span class="title class_">File</span>(filePath));</span><br><span class="line">    <span class="type">XPath</span> <span class="variable">xPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultXPath</span>(<span class="string">&quot;//name&quot;</span>);</span><br><span class="line">    List&lt;Element&gt; names = xPath.selectNodes(doc);</span><br><span class="line">    <span class="keyword">for</span> (Element name : names) &#123;</span><br><span class="line">        System.out.println(name.getTextTrim());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>XML</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadLocal源码分析以及线程池下的使用问题</title>
    <url>/posts/ThreadLocal_source_code.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>如果我想要在多线程下, 同一个变量在不同线程下使用不同的值, 如何去做?<br>我可以声明一个<code>Map</code>, 线程作为<code>Key</code>(实际上并不是这样设计的), <code>Map</code>作为<code>value</code>, 存储当前线程下的键值对.<br>下面是一个简单的例子(生产不要这样用)</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadMap</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;Thread, Map&lt;String, Object&gt;&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(String key, Object value)</span> &#123;</span><br><span class="line">        map.get(Thread.currentThread()).put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">get</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> map.get(Thread.currentThread()).get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是不是很简单? 但是我们不需要去重复造轮子.<br><code>JDK</code>早就给我们实现了一套轮子, 本质和我写的这个<code>Demo</code>是一样的.</p>
<h1 id="ThreadLocal-实现线程隔离"><a href="#ThreadLocal-实现线程隔离" class="headerlink" title="ThreadLocal 实现线程隔离"></a>ThreadLocal 实现线程隔离</h1><h2 id="测试用例"><a href="#测试用例" class="headerlink" title="测试用例"></a>测试用例</h2><p>我们来看个简单的<a href="https://github.com/Ahaochan/project/blob/master/ahao-spring-boot-async/src/test/java/com/ahao/spring/boot/async/ThreadLocalTest.java">单元测试例子</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">threadLocal1</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        ThreadLocal&lt;String&gt; context = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        Assertions.assertNull(context.get());</span><br><span class="line">        <span class="type">String</span> <span class="variable">expectP</span> <span class="operator">=</span> <span class="string">&quot;hello &quot;</span> + DateHelper.getNow(DateHelper.yyyyMMdd_hhmmssSSS);</span><br><span class="line">        context.set(expectP);</span><br><span class="line">        </span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            Assertions.assertNull(context.get());</span><br><span class="line">            <span class="type">String</span> <span class="variable">expect</span> <span class="operator">=</span> <span class="string">&quot;hello &quot;</span> + DateHelper.getNow(DateHelper.yyyyMMdd_hhmmssSSS);</span><br><span class="line">            context.set(expect);</span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> context.get();</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot; get &quot;</span> + value);</span><br><span class="line">            Assertions.assertEquals(expect, value);</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread1.join();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> context.get();</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; get &quot;</span> + value);</span><br><span class="line">        Assertions.assertEquals(expectP, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行完毕输出</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Thread-1 get hello 2020-04-19 00:54:44:249</span><br><span class="line">Thread-2 get hello 2020-04-19 00:54:44:254</span><br><span class="line">main get hello 2020-04-19 00:54:44:230</span><br></pre></td></tr></table></figure>
<p>可以看到, 明明是同一个变量, 在不同线程下, 获取到的值却不一样.</p>
<h2 id="get-和-set-源码分析"><a href="#get-和-set-源码分析" class="headerlink" title="get 和 set 源码分析"></a>get 和 set 源码分析</h2><p>关键点就在于<code>set</code>和<code>get</code>方法. 我们现在先来看<code>set</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.ThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取当前线程内的 ThreadLocalMap</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">        <span class="comment">// 2. 往 Map 塞值, 以 ThreadLocal为key</span></span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>) map.set(<span class="built_in">this</span>, value);</span><br><span class="line">        <span class="keyword">else</span> createMap(t, value);</span><br><span class="line">    &#125;</span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到和我一开始写的一样, 就是往一个<code>Map</code>里塞数据.<br>再看看<code>get</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.ThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取当前线程内的 ThreadLocalMap</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">        <span class="comment">// 2. 根据 key 获取 value</span></span><br><span class="line">        <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> (T) e.value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4. 找不到就返回一个默认值, 默认为 null</span></span><br><span class="line">        <span class="keyword">return</span> setInitialValue();</span><br><span class="line">    &#125;</span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也一样, 就是从一个<code>Map</code>里, 把<code>ThreadLocal</code>作为<code>key</code>, 获取数据.</p>
<p>那么不同点来了, 就是这个<code>Map</code>的构造, 可以看到不是我用的<code>HashMap</code>.<br>而是当前线程里的<code>ThreadLocalMap</code>实例变量<code>threadLocals</code>.</p>
<h2 id="ThreadLocalMap-源码分析"><a href="#ThreadLocalMap-源码分析" class="headerlink" title="ThreadLocalMap 源码分析"></a>ThreadLocalMap 源码分析</h2><p><code>ThreadLocalMap</code>是<code>ThreadLocal</code>的静态内部类, 而每一个线程<code>Thread</code>都有各自的<code>ThreadLocalMap</code>成员变量.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.Thread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那我们继续来看<code>ThreadLocalMap</code>. 和普通的<code>HashMap</code>一样, 内部是一个节点数组.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.ThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalMap</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 节点数组</span></span><br><span class="line">        <span class="keyword">private</span> Entry[] table;</span><br><span class="line">        <span class="comment">// 2. 弱引用</span></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">            Object value;</span><br><span class="line">            Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">                <span class="built_in">super</span>(k);</span><br><span class="line">                value = v;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>ThreadLocalMap</code>是以<code>ThreadLocal</code>对象的弱引用为<code>Key</code>, <code>Object</code>为<code>Value</code>的<code>Map</code>集合.<br>而<code>Entry</code>继承了弱引用<code>WeakReference</code>, 所以当每次<code>GC</code>发生时, 扫描到这个对象时, <strong>如果没有强引用持有这个对象</strong>, 就会回收<code>ThreadLocal</code>. 但这里会导致一些内存问题, 这里后面讲.</p>
<p>接下来是<code>ThreadLocalMap</code>的<code>set</code>和<code>get</code>方法, 和普通的<code>HashMap</code>差不多, 无非就是扩容, <code>rehash</code>那一套.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalMap</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 对 key 进行 hash, 获取 Entry 节点的下标</span></span><br><span class="line">            Entry[] tab = table;</span><br><span class="line">            <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 如果 hash 冲突, 就 开放定址法 找到下一个下标</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; e != <span class="literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">                ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">                <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">                    e.value = value;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 2.1. 清除 null key 的节点</span></span><br><span class="line">                <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">                    replaceStaleEntry(key, value, i);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3. 往下标位置塞数据, 扩容, rehash </span></span><br><span class="line">            tab[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">            <span class="type">int</span> <span class="variable">sz</span> <span class="operator">=</span> ++size;</span><br><span class="line">            <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">                rehash();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 对 key 进行 hash, 获取 Entry 节点的下标</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// 2. 从节点数组获取数据</span></span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">            <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// 开放定址法获取数据</span></span><br><span class="line">                <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>值得注意的是, <code>ThreadLocalMap</code>的哈希冲突解决方案是<strong>开放定址法</strong>, 而不是<code>HashMap</code>的链表红黑树那套.</p>
<h2 id="ThreadLocal-为什么必须设置为-static"><a href="#ThreadLocal-为什么必须设置为-static" class="headerlink" title="ThreadLocal 为什么必须设置为 static ?"></a>ThreadLocal 为什么必须设置为 static ?</h2><p>经常会听到一种言论, <code>ThreadLocal</code>必须设置为<code>static</code>静态变量, 否则会浪费内存的问题.</p>
<p>我们先来看一个<a href="https://github.com/Ahaochan/project/blob/master/ahao-spring-boot-async/src/test/java/com/ahao/spring/boot/async/ThreadLocalTest.java">单元测试例子</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; staticContext = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">staticVerify</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 静态ThreadLocal 设置值</span></span><br><span class="line">        Assertions.assertNull(staticContext.get());</span><br><span class="line">        staticContext.set(Thread.currentThread().getName());</span><br><span class="line"></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">runnable</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            <span class="comment">// 2. 普通ThreadLocal 设置值</span></span><br><span class="line">            ThreadLocal&lt;String&gt; context = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line"></span><br><span class="line">            staticContext.set(thread.getName());</span><br><span class="line">            context.set(thread.getName());</span><br><span class="line"></span><br><span class="line">            System.out.println(thread.getName() + <span class="string">&quot; static get &quot;</span> + staticContext.get());</span><br><span class="line">            System.out.println(thread.getName() + <span class="string">&quot; get &quot;</span> + context.get()); <span class="comment">// 打断点</span></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread1.join();</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(runnable);</span><br><span class="line">        thread2.start();</span><br><span class="line">        thread2.join();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> staticContext.get();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; static get &quot;</span> + staticContext.get());</span><br><span class="line">        Assertions.assertEquals(thread.getName(), value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们打个断点看看<code>Thread</code>里的<code>ThreadLocalMap</code>的<code>Key</code>引用很容易就发现问题.</p>
<img data-src="/images/ThreadLocal%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%BB%A5%E5%8F%8A%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%B8%8B%E7%9A%84%E4%BD%BF%E7%94%A8%E9%97%AE%E9%A2%98_01.png" class="">

<p>当线程执行的时候, 线程的<code>ThreadLocalMap</code>持有两个<code>Entry</code>, 一个是静态的<code>ThreadLocal</code>, 一个是<code>new</code>出来的<code>ThreadLocal</code>.<br>可以看到，静态的<code>ThreadLocal</code>在<code>ThreadLocalMap</code>是固定的<code>hashcode</code>, 而另一个<code>ThreadLocal</code>是不同的<code>hashcode</code>，说明每次运行都会创建<code>ThreadLocal</code>。<br>虽然并不影响正常使用，但是用<code>static</code>修饰<code>ThreadLocal</code>可以减少对象的频繁创建，降低<code>GC</code>频率, 如果没有特殊要求, 还是用<code>static</code>最佳.</p>
<p>另外还有一点需要注意的是, <code>ThreadLocal</code>如果设置成<code>static</code>了, 就会被当前类对象强引用, 下面的内存泄漏问题会提到.</p>
<h2 id="ThreadLocal的-内存泄漏-问题"><a href="#ThreadLocal的-内存泄漏-问题" class="headerlink" title="ThreadLocal的 内存泄漏 问题"></a>ThreadLocal的 内存泄漏 问题</h2><p><img data-src="https://yuml.me/diagram/nofunky;dir:LR/class/[Thread%E5%BC%95%E7%94%A8]-%3E[Thread%E5%AF%B9%E8%B1%A1],[Thread%E5%AF%B9%E8%B1%A1]-%3E[ThreadLocalMap],[ThreadLocalMap]-%3E[Entry],[Entry]-%E5%BC%B1%E5%BC%95%E7%94%A8%3E[ThreadLocal%E5%AF%B9%E8%B1%A1],[Entry]-%3E[value],[ThreadLocal%E5%BC%95%E7%94%A8]-%E5%BC%BA%E5%BC%95%E7%94%A8%3E[ThreadLocal%E5%AF%B9%E8%B1%A1]" alt="ThreadLocal引用链"></p>
<p><code>ThreadLocalMap</code>的<code>Key</code>是<code>ThreadLocal</code>的弱引用对象.<br>不管<code>ThreadLocal</code>对象是否因为弱引用被<code>GC</code>回收, <code>Entry</code>节点都会持有<code>value</code>的强引用.<br>要回收掉<code>value</code>只有两种方法</p>
<ol>
<li>结束当前线程</li>
<li>手动释放<code>Key</code>为<code>null</code>的<code>Entry</code>, 常用的是<code>remove</code>方法</li>
</ol>
<p>在<code>ThreadLocal</code>的<code>set</code>、<code>get</code>、<code>remove</code>方法内都有对<code>Key</code>为<code>null</code>的<code>Entry</code>做清除引用的操作.</p>
<p>那为什么<code>Entry</code>的<code>Key</code>要做弱引用, 不直接强引用呢?<br>我们反推一下, 如果<code>Entry</code>的<code>Key</code>是强引用, 当<code>ThreadLocal</code>的外部强引用取消后, <code>ThreadLocalMap</code>内部的<code>Entry</code>还持有<code>ThreadLocal</code>的强引用.<br>那么<code>ThreadLocal</code>就一直不能被<code>GC</code>回收, 需要手动<code>remove</code>才能回收.<br>反之, 如果是弱引用, 那么<code>ThreadLocal</code>的外部强引用取消后, 因为<code>Entry</code>持有的是<code>ThreadLocal</code>的弱引用, 当发生<code>GC</code>时, 能及时回收掉<code>ThreadLocal</code>.<br>在下次<code>set</code>、<code>get</code>、<code>remove</code>方法做清除<code>key</code>为<code>null</code>的<code>value</code>的操作.</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><code>Thread</code>线程有一个<code>ThreadLocalMap</code>成员变量, 这是一个存储了以<code>ThreadLocal</code>为<code>Key</code>, 值为<code>Value</code>的<code>Map</code>集合.<br><code>ThreadLocal</code>的<code>set</code>和<code>get</code>方法, 本质是获取当前线程的<code>ThreadLocalMap</code>, 对这个<code>Map</code>进行操作, 做到线程隔离.</p>
<p>下面是一个简单的最佳实践.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;String&gt; local = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        local.set(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 业务操作</span></span><br><span class="line">        &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">            local.remove();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="InheritableThreadLocal-实现父子线程变量共享"><a href="#InheritableThreadLocal-实现父子线程变量共享" class="headerlink" title="InheritableThreadLocal 实现父子线程变量共享"></a>InheritableThreadLocal 实现父子线程变量共享</h1><p>那如果我想要创建一个线程, 然后子线程继承父线程的变量, 要怎么做呢?<br>你可以看到在上面的单元测试用例中, 我使用了一个断言<code>Assertions.assertNull(context.get());</code>.</p>
<p>也就是说, 如果单单使用<code>ThreadLocal</code>, 子线程是不能获取到父线程的变量的.<br>其实这也很好理解, 线程都不一样, 线程对象里面的<code>Map</code>变量当然也不一样.</p>
<p>如果让我们来实现, 也很容易. 只要在创建线程的时候, 将父线程的<code>ThreadLocalMap</code>复制一份到子线程即可.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ThreadFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Thread <span class="title function_">createThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">parentThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">childThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 复制 ThreadLocalMap</span></span><br><span class="line">        childThread.threadLocals = parentThread.threadLocals.clone();</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> childThread;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JDK</code>内部已经实现了, 我们只要直接使用<code>InheritableThreadLocal</code>即可.</p>
<h2 id="InheritableThreadLocal-源码分析"><a href="#InheritableThreadLocal-源码分析" class="headerlink" title="InheritableThreadLocal 源码分析"></a>InheritableThreadLocal 源码分析</h2><p><code>InheritableThreadLocal</code>继承了<code>ThreadLocal</code>, 并重写了<code>ThreadLocalMap</code>的相关方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.InheritableThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// java.lang.ThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到, <code>InheritableThreadLocal</code>就是换了个变量操作, 它操作的是<code>inheritableThreadLocals</code>变量. 避免和<code>ThreadLocal</code>操作的变量冲突.<br>代码就短短几行, 没有涉及到我们说的**复制<code>ThreadLocalMap</code>**的操作.<br>那我们继续看下<code>Thread</code>的创建过程.</p>
<h2 id="Thread-创建"><a href="#Thread-创建" class="headerlink" title="Thread 创建"></a>Thread 创建</h2><p>我们直接追源码, 这里省略部分非核心代码.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.Thread</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Thread</span><span class="params">()</span> &#123;</span><br><span class="line">        init(<span class="literal">null</span>, <span class="literal">null</span>, <span class="string">&quot;Thread-&quot;</span> + nextThreadNum(), <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name, <span class="type">long</span> stackSize)</span> &#123;</span><br><span class="line">        init(g, target, name, stackSize, <span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name, <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                      <span class="type">boolean</span> inheritThreadLocals)</span> &#123; <span class="comment">// 注意这个 inheritThreadLocals 变量, 默认为 true</span></span><br><span class="line">        <span class="comment">// 1. 获取创建Thread变量的线程, 作为父线程</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">parent</span> <span class="operator">=</span> currentThread();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 如果父线程有 inheritableThreadLocals 的值, 那么就复制一份到子线程</span></span><br><span class="line">        <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>)</span><br><span class="line">            <span class="built_in">this</span>.inheritableThreadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(parent.inheritableThreadLocals);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一目了然, 就是在<code>new Thread()</code>的时候, 从父线程中复制一份<code>ThreadLocalMap</code>到子线程.</p>
<h1 id="TransmittableThreadLocal-线程池子任务共享父线程的变量"><a href="#TransmittableThreadLocal-线程池子任务共享父线程的变量" class="headerlink" title="TransmittableThreadLocal 线程池子任务共享父线程的变量"></a>TransmittableThreadLocal 线程池子任务共享父线程的变量</h1><p><code>InheritableThreadLocal</code>解决了父子线程变量共享的问题, 但生产环境下, 我们一般都是用线程池来管理线程的.<br>这里就涉及到一个线程复用的问题.<br><code>InheritableThreadLocal</code>只有在创建线程的时候才会将父线程的变量复制给子线程, 但是线程池的线程是复用的.<br><code>new Thread()</code>之后, 可能会执行多个不同的任务. 这个时候就不能继承父线程的变量了.</p>
<p>还是老套路, 既然线程是复用的, 那我能不能在创建任务的时候, 存一份父线程数据, 在<code>run()</code>执行之前丢到子线程里去呢?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RunnableWrapper</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 创建一个 ThreadLocal, 用于暂存创建Runnable时父线程的数据, 在外部直接使用 RunnableWrapper.holder.set();</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> ThreadLocal&lt;Map&lt;String, Object&gt;&gt; holder = ThreadLocal.withInitial(HashMap::<span class="keyword">new</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, Object&gt; value;</span><br><span class="line">    <span class="keyword">private</span> Runnable runnable;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RunnableWrapper</span><span class="params">(Runnable runnable)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">        <span class="comment">// 2. 创建任务的时候, 暂存父线程的数据</span></span><br><span class="line">        <span class="built_in">this</span>.value = holder.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 3. 在子线程执行任务前, 将父线程的数据存入子线程</span></span><br><span class="line">        holder.set(value);</span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里<code>JDK</code>可没有提供轮子了, 但是<code>Alibaba</code>提供了一个<a href="https://github.com/alibaba/transmittable-thread-local"><code>transmittable-thread-local</code></a>的轮子.</p>
<h2 id="测试用例-1"><a href="#测试用例-1" class="headerlink" title="测试用例"></a>测试用例</h2><p>我们来看个<a href="https://github.com/Ahaochan/project/blob/master/ahao-spring-boot-async/src/test/java/com/ahao/spring/boot/async/TtlTest.java">单元测试例子</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TtlTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">wrapper</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 创建 线程池 和 TransmittableThreadLocal</span></span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">        TransmittableThreadLocal&lt;String&gt; context = <span class="keyword">new</span> <span class="title class_">TransmittableThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">expect</span> <span class="operator">=</span> <span class="string">&quot;hello &quot;</span> + DateHelper.getNow(DateHelper.yyyyMMdd_hhmmssSSS);</span><br><span class="line">        context.set(expect);</span><br><span class="line">        System.out.println(<span class="string">&quot;[parent thread] set &quot;</span> + context.get());</span><br><span class="line">        Assertions.assertEquals(expect, context.get());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 装饰 Runnable</span></span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;[child thread] get &quot;</span> + context.get() + <span class="string">&quot; in Runnable&quot;</span>);</span><br><span class="line">            Assertions.assertEquals(expect, context.get());</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">TtlRunnable</span> <span class="variable">ttlRunnable</span> <span class="operator">=</span> TtlRunnable.get(task);</span><br><span class="line">        executorService.submit(ttlRunnable).get();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 关闭线程池</span></span><br><span class="line">        executorService.shutdown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行完毕输出</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">[parent thread] set hello 2020-04-19 00:54:44:230</span><br><span class="line">[child thread] get hello 2020-04-19 00:54:44:230 in Runnable</span><br></pre></td></tr></table></figure>
<p>可以看到, 尽管是在线程池里复用线程的情况, 依然能获取到父线程的变量.<br>如果觉得我只用一个<code>Runnable</code>样本不够, 可以自己多创建几百个<code>Runnable</code>.</p>
<p>陌生的类只有两个, <code>TtlRunnable</code>和<code>TransmittableThreadLocal</code>.</p>
<h2 id="TransmittableThreadLocal-的-set-get-源码分析"><a href="#TransmittableThreadLocal-的-set-get-源码分析" class="headerlink" title="TransmittableThreadLocal 的 set get 源码分析"></a>TransmittableThreadLocal 的 set get 源码分析</h2><p>我们先来看看<code>set</code>方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.ttl.TransmittableThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">TtlCopier</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!disableIgnoreNullValueSemantics &amp;&amp; <span class="literal">null</span> == value) &#123;</span><br><span class="line">            <span class="comment">// may set null to remove value</span></span><br><span class="line">            remove();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 调用 InheritableThreadLocal 的 set 方法, 保证子线程也能拿到数据</span></span><br><span class="line">            <span class="built_in">super</span>.set(value);</span><br><span class="line">            <span class="comment">// 2. 添加到 holder, 保证子任务能拿到数据</span></span><br><span class="line">            addThisToHolder();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addThisToHolder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 判断 holder 没有当前 ThreadLocal 则 put 一份</span></span><br><span class="line">        <span class="keyword">if</span> (!holder.get().containsKey(<span class="built_in">this</span>)) &#123;</span><br><span class="line">            holder.get().put((TransmittableThreadLocal&lt;Object&gt;) <span class="built_in">this</span>, <span class="literal">null</span>); <span class="comment">// WeakHashMap supports null value.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 等价于 Map&lt;线程, Map&lt;ThreadLocal, null&gt;&gt;, 因为没有弱引用的Set, 所以用 WeakHashMap 代替</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> InheritableThreadLocal&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt; holder =</span><br><span class="line">     <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt;&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; initialValue() &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; childValue(WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, ?&gt; parentValue) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;(parentValue);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>holder</code>存储了当前线程下的所有<code>TransmittableThreadLocal</code>对象, 并用<code>Set</code>去重.<br>有人看到这里可能有疑问, 上面没看到<code>Set</code>关键字. 是因为<code>JDK</code>没有弱引用的<code>Set</code>, 所以用<code>WeakHashMap</code>代替.</p>
<p>再来看看<code>get</code>方法, 也只是多了个<code>addThisToHolder</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.ttl.TransmittableThreadLocal</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">TtlCopier</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">super</span>.get();</span><br><span class="line">        <span class="keyword">if</span> (disableIgnoreNullValueSemantics || <span class="literal">null</span> != value) addThisToHolder();</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="TtlRunnable-源码分析-保存快照"><a href="#TtlRunnable-源码分析-保存快照" class="headerlink" title="TtlRunnable 源码分析 保存快照"></a>TtlRunnable 源码分析 保存快照</h2><p>既然上面设置了参数, 下面就要获取这些参数了.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.ttl.TtlRunnable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TtlRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>, TtlWrapper&lt;Runnable&gt;, TtlEnhanced, TtlAttachments &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AtomicReference&lt;Object&gt; capturedRef;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Runnable runnable;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> releaseTtlValueReferenceAfterRun;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">TtlRunnable</span><span class="params">(<span class="meta">@NonNull</span> Runnable runnable, <span class="type">boolean</span> releaseTtlValueReferenceAfterRun)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 保存快照</span></span><br><span class="line">        <span class="built_in">this</span>.capturedRef = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;Object&gt;(TransmittableThreadLocal.Transmitter.capture());</span><br><span class="line">        <span class="built_in">this</span>.runnable = runnable;</span><br><span class="line">        <span class="built_in">this</span>.releaseTtlValueReferenceAfterRun = releaseTtlValueReferenceAfterRun;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 2. 获取快照</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">captured</span> <span class="operator">=</span> capturedRef.get();</span><br><span class="line">        <span class="keyword">if</span> (captured == <span class="literal">null</span> || releaseTtlValueReferenceAfterRun &amp;&amp; !capturedRef.compareAndSet(captured, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;TTL value reference is released after run!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 保存到当前线程</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">backup</span> <span class="operator">=</span> TransmittableThreadLocal.Transmitter.replay(captured);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            runnable.run();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            TransmittableThreadLocal.Transmitter.restore(backup);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>顺着开头提到的思路, 在<code>Runnable</code>创建时, 先对父线程的变量做一个快照, 在<code>run</code>执行时, 复制到新线程里.</p>
<p>那么第一步, 做快照, 关键就是这个<code>TransmittableThreadLocal.Transmitter.capture()</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">TtlCopier</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Transmitter</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">capture</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="comment">// 1. captureTtlValues() 对当前线程下的所有 TransmittableThreadLocal 做一个快照</span></span><br><span class="line">            <span class="comment">// 2. TODO captureThreadLocalValues() 这个操作的是另一个变量, 目前这个场景没用到 </span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(captureTtlValues(), captureThreadLocalValues());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; <span class="title function_">captureTtlValues</span><span class="params">()</span> &#123;</span><br><span class="line">            WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttl2Value = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">            <span class="keyword">for</span> (TransmittableThreadLocal&lt;Object&gt; threadLocal : holder.get().keySet()) &#123;</span><br><span class="line">                ttl2Value.put(threadLocal, threadLocal.copyValue()); <span class="comment">// 对当前线程下的所有 TransmittableThreadLocal 做一个快照</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> ttl2Value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Snapshot</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttl2Value;</span><br><span class="line">            <span class="keyword">final</span> WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; threadLocal2Value;</span><br><span class="line">            <span class="keyword">private</span> <span class="title function_">Snapshot</span><span class="params">(WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; ttl2Value, WeakHashMap&lt;ThreadLocal&lt;Object&gt;, Object&gt; threadLocal2Value)</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.ttl2Value = ttl2Value;</span><br><span class="line">                <span class="built_in">this</span>.threadLocal2Value = threadLocal2Value;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第二步, 执行<code>run</code>方法的时候, 取出快照, 并保存到当前线程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransmittableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">TtlCopier</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Transmitter</span> &#123;</span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">replay</span><span class="params">(<span class="meta">@NonNull</span> Object captured)</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Snapshot</span> <span class="variable">capturedSnapshot</span> <span class="operator">=</span> (Snapshot) captured;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Snapshot</span>(replayTtlValues(capturedSnapshot.ttl2Value), replayThreadLocalValues(capturedSnapshot.threadLocal2Value));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; <span class="title function_">replayTtlValues</span><span class="params">(<span class="meta">@NonNull</span> WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; captured)</span> &#123;</span><br><span class="line">            WeakHashMap&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; backup = <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt;();</span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 精华! 从快照中获取 ThreadLocal 再重新 set 到当前线程</span></span><br><span class="line">            <span class="keyword">for</span> (Map.Entry&lt;TransmittableThreadLocal&lt;Object&gt;, Object&gt; entry : captured.entrySet()) &#123;</span><br><span class="line">                TransmittableThreadLocal&lt;Object&gt; threadLocal = entry.getKey();</span><br><span class="line">                threadLocal.set(entry.getValue());</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">            <span class="keyword">return</span> backup;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>老实说, 看到这里的代码, 不由让我惊叹. 这个<code>for</code>循环, 太神了.<br>如此一来, 就将之前保存的<code>ThreadLocal</code>快照, 在执行这个<code>Runnable</code>的线程重新复制了一遍.</p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p><code>ThreadLocal</code>算是高频面试考点, 并且一个用的不小心就会造成线上生产问题. 使用的时候只要注意套模版就可以了.</p>
<ol>
<li><code>static</code>修饰<code>ThreadLocal</code></li>
<li><code>set</code>之后要用<code>try &#123;&#125; finally &#123;&#125;</code>做<code>remove</code>操作</li>
<li>线程池要用<code>TransmittableThreadLocal</code>来传递变量.</li>
</ol>
<p>另外, <code>Netty</code>还有一个<code>FastThreadLocal</code>的东西, 不过没有涉及本篇的线程变量传递的主题, 所以就不讲了.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://github.com/alibaba/transmittable-thread-local/issues/123">小伙伴同学们写的 TTL使用场景 与 设计实现解析的文章（写得都很好！ ）❤️</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
      </tags>
  </entry>
  <entry>
    <title>ThreadPoolExecutor源码分析</title>
    <url>/posts/ThreadPoolExecutor_source_code.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>ThreadPoolExecutor</code>是一个线程池的实现.<br><code>Java</code>提供了<code>Executors</code>工厂类来创建<code>ExecutorService</code>线程池实例。</p>
<span id="more"></span>

<p><img data-src="https://yuml.me/diagram/nofunky/class/[%3C%3CExecutor%3E%3E]^-.-[%3C%3CExecutorService%3E%3E],[%3C%3CExecutorService%3E%3E]^-.-[AbstractExecutorService],[AbstractExecutorService]^-[ThreadPoolExecutor]"></p>
<h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><p><code>ThreadPoolExecutor</code>的构造方法如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize, <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                              <span class="type">long</span> keepAliveTime, TimeUnit unit,</span></span><br><span class="line"><span class="params">                              BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                              ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                              RejectedExecutionHandler handler)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把线程池想象一个水壶, <code>corePoolSize</code>就相当于液面警戒线, 虽然满了还可以再加水, 但是不可能超过水壶的极限高度<code>maximumPoolSize</code>.<br><code>keepAliveTime</code>则是允许线程空闲下来的时间, <code>TimeUnit</code>是时间单位.<br><code>workQueue</code>是阻塞队列, 用于存储超过<code>corePoolSize</code>但是未满<code>maximumPoolSize</code>的线程.<br><code>threadFactory</code>用于创建线程池内的线程, 默认是<code>DefaultThreadFactory</code><br><code>handler</code>是拒绝策略, 用于回调执行添加线程失败的代码. </p>
<h1 id="线程池内部状态流转"><a href="#线程池内部状态流转" class="headerlink" title="线程池内部状态流转"></a>线程池内部状态流转</h1><p><code>Java</code>中的<code>int</code>类型有<code>32</code>位, <code>ThreadPoolExecutor</code>使用<code>ctl</code>的高<code>3</code>位表示线程池的运行状态, 低<code>29</code>位表示线程池中的线程数.<br>线程池的状态有:</p>
<ol>
<li><code>RUNNING</code>: 运行状态, 可以接收任务</li>
<li><code>SHUTDOWN</code>: 调用了<code>shutdown()</code>方法后的状态, 等待所有任务执行完毕后关闭线程池.</li>
<li><code>STOP</code>: 调用了<code>shutdownNow()</code>方法后的状态, 强制结束所有任务并关闭线程池.</li>
<li><code>TIDYING</code>: 空闲状态, 所有任务都执行完毕。</li>
<li><code>TERMINATED</code>: 终止状态，调用了<code>terminated()</code>方法后的状态.<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;      <span class="comment">// 29</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span>   <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>; <span class="comment">// 11111111111111111111111111111, 29位全1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// runState is stored in the high-order bits</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;    <span class="comment">// 111 </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;    <span class="comment">// 000</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;    <span class="comment">// 001</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;    <span class="comment">// 010</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;    <span class="comment">// 011</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Packing and unpacking ctl</span></span><br><span class="line">    <span class="comment">// 获取运行状态, 高3位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br><span class="line">    <span class="comment">// 获取线程数量, 低29位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br><span class="line">    <span class="comment">// 获取 ctl 变量, 组合 高3位 和 低29位</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
下面<code>3</code>个静态方法用于拆分和组合<strong>运行状态</strong>和<strong>线程数量</strong>.<br>假设线程池运行状态为<code>RUNING</code>, 线程池内有<code>2</code>个线程.<br>那么<code>ctl</code>变量的值的二进制形式就是<code>111 00000000000000000000000000010</code>.<br>根据<code>ctl</code>获取运行状态: <code>rs = runStateOf(ctl)   </code>得到<code>111 00000000000000000000000000000</code><br>根据<code>ctl</code>获取线程数量: <code>wc = workerCountOf(ctl)</code>得到<code>000 00000000000000000000000000010</code><br>如果之后需要根据<code>rs</code>和<code>wc</code>获取<code>ctl</code>, 则调用<code>ctl = ctlOf(rs, wc)</code>得到<code>111 00000000000000000000000000010</code></li>
</ol>
<h1 id="添加一个Runnable"><a href="#添加一个Runnable" class="headerlink" title="添加一个Runnable"></a>添加一个Runnable</h1><h2 id="execute-Runnable-command"><a href="#execute-Runnable-command" class="headerlink" title="execute(Runnable command)"></a>execute(Runnable command)</h2><p><code>ThreadPoolExecutor</code>实现了<code>Executor</code>接口的唯一一个方法<code>void execute(Runnable command)</code>;</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// 1. 判断当前线程数量 是否小于 核心线程数量, 尝试添加线程到核心线程池</span></span><br><span class="line">        <span class="comment">//    添加到核心线程池失败 或者 核心线程池满了, 则继续往下走</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">            <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            c = ctl.get();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 判断线程池状态是 RUNNING, 往阻塞队列添加这个 Runnable </span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">            <span class="comment">// 2.1. 判断线程池不是RUNNING, 则从队列删除这个 Runnable, 并调用 reject 回调方法</span></span><br><span class="line">            <span class="keyword">if</span> (! isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">                reject(command);</span><br><span class="line">            <span class="comment">// 2.2. 判断线程池内的线程数量如果为0, 则创建一个非核心线程</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">                addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 如果线程池状态不是 RUNNING, 或者阻塞队列添加失败</span></span><br><span class="line">        <span class="comment">//    尝试添加 Runnable 到非核心线程池, 如果还是失败, 则调用 reject 回调方法</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">            reject(command);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>只要<code>Core Pool</code>没有填满, 线程池就会一直创建线程到<code>Core Pool</code>中.</li>
<li>一旦<code>Core Pool</code>填满了, 就添加到阻塞队列(构造函数传入)中.<br> 2.2. 如果添加到阻塞队列成功, 且当前线程池的线程数为0, 则创建一个非<code>Core</code>线程.<ol start="3">
<li>  如果添加到阻塞队列失败, 尝试创建一个非<code>Core</code>线程, 仍然失败则调用<code>reject</code>处理器(构造函数传入)的回调函数.</li>
</ol>
</li>
</ol>
<p>简单点说, 线程池会先填满<code>corePoolSize</code>, 再填满队列, 再填满<code>maximumPoolSize</code>, 如果还有则调用<code>reject</code>回调方法.</p>
<h2 id="addWorker-Runnable-firstTask-boolean-core"><a href="#addWorker-Runnable-firstTask-boolean-core" class="headerlink" title="addWorker(Runnable firstTask, boolean core)"></a>addWorker(Runnable firstTask, boolean core)</h2><p>上面的代码一直围绕着<code>addWorker</code>方法, 这个方法可以创建<code>Core</code>线程和非<code>Core</code>线程.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 省略以上代码, 都是对状态进行判断, 判断是否可以添加 Worker, 不复杂, 就是绕</span></span><br><span class="line"></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 创建 Worker 实例, 线程池中的线程都是 Worker</span></span><br><span class="line">            w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread; <span class="comment">// 这个线程是用 ThreadFactory 创建的</span></span><br><span class="line">            <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 3. HashSet 不是线程安全的, 加锁, 添加到 HashSet 中</span></span><br><span class="line">                <span class="comment">// 省略部分代码</span></span><br><span class="line">                <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">                mainLock.lock();</span><br><span class="line">                workers.add(w);</span><br><span class="line">                mainLock.unlock();</span><br><span class="line">                <span class="comment">// 4. 执行线程</span></span><br><span class="line">                t.start();</span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">                addWorkerFailed(w);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> workerStarted;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面代码可以看出, <code>Core</code>线程和非<code>Core</code>线程本质都是一个<code>Worker</code>, 甚至这个<code>Worker</code>都没有属性来标识是否为<code>Core</code>线程, 而是通过一堆线程池状态来判断创建的是<code>Core</code>线程还是非<code>Core</code>线程.</p>
<p>创建完后就执行这个<code>Worker</code>线程, 从阻塞队列里不停的取任务来执行.</p>
<h2 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h2><p><code>Worker</code>是<code>ThreadPoolExecutor</code>的内部类. </p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> Thread thread; <span class="comment">// ThreadFactory 创建的线程</span></span><br><span class="line">        Runnable firstTask;  <span class="comment">// 提交到线程池里的任务</span></span><br><span class="line">        Worker(Runnable firstTask) &#123;</span><br><span class="line">            setState(-<span class="number">1</span>); <span class="comment">// inhibit interrupts until runWorker</span></span><br><span class="line">            <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">            <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            runWorker(<span class="built_in">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="runWorker-Worker-w"><a href="#runWorker-Worker-w" class="headerlink" title="runWorker(Worker w)"></a>runWorker(Worker w)</h2><p>间接调用了<code>ThreadPoolExecutor</code>的<code>runWorker</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">        w.firstTask = <span class="literal">null</span>;</span><br><span class="line">        w.unlock(); <span class="comment">// allow interrupts</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1. 先执行Worker的任务, 然后从队列中循环取出任务</span></span><br><span class="line">            <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">                w.lock();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    beforeExecute(wt, task); <span class="comment">// 交给子类扩展, 空方法体</span></span><br><span class="line">                    task.run();</span><br><span class="line">                    afterExecute(task, thrown); <span class="comment">// 交给子类扩展, 空方法体</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    task = <span class="literal">null</span>;</span><br><span class="line">                    w.completedTasks++;</span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            processWorkerExit(w, completedAbruptly);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接调用了<code>run</code>方法, 完成线程任务.</p>
<h2 id="getTask"><a href="#getTask" class="headerlink" title="getTask()"></a>getTask()</h2><p><code>getTask()</code>从阻塞队列中获取提交到线程池的任务.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadPoolExecutor</span> <span class="keyword">extends</span> <span class="title class_">AbstractExecutorService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timedOut</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// Did the last poll() time out?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Are workers subject to culling?</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 省略跳出循环的代码, timedOut 为 true 则 return null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">                    workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) :</span><br><span class="line">                    workQueue.take();</span><br><span class="line">                <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> r;</span><br><span class="line">                timedOut = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">                timedOut = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>poll</code>方法支持延迟从队列中获取元素, <code>take</code>则马上从队列中获取元素.<br>当超时后, <code>getTask()</code>返回<code>null</code>, 则<code>runWorker</code>方法的无限循环也跑不下去了, 自然就结束了这个线程.</p>
<p>一个交给线程池的线程就执行完毕了. 省略了很多状态转换的代码, 如果看不懂可以结合源码阅读。</p>
<h1 id="关闭线程池"><a href="#关闭线程池" class="headerlink" title="关闭线程池"></a>关闭线程池</h1><p>关闭线程池有两种方法<code>shutdown()</code>和<code>shutdownNow()</code>.<br>参考资料提到了一种优雅的关闭线程池的方法, 如下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">5</span>; i++) &#123;</span><br><span class="line">    pool.execute(<span class="keyword">new</span> <span class="title class_">Job</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">pool.shutdown();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (!pool.awaitTermination(<span class="number">1</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">    logger.info(<span class="string">&quot;线程还在执行。。。&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">logger.info(<span class="string">&quot;一共处理了【&#123;&#125;】&quot;</span>, (end - start));</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://github.com/crossoverJie/JCSprout/blob/master/MD/ThreadPoolExecutor.md">ThreadPoolExecutor</a></li>
<li><a href="https://blog.csdn.net/u010963948/article/details/80573898">深入理解Java线程池原理分析与使用（尤其当线程队列满了之后事项）</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
      </tags>
  </entry>
  <entry>
    <title>group()和group(i)的区别</title>
    <url>/posts/The_difference_between_group()_and_group(i).html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在做网络爬虫，需要用到正则表达式，所以学习一下。</p>
<h1 id="先看代码"><a href="#先看代码" class="headerlink" title="先看代码"></a>先看代码</h1><span id="more"></span>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">Line</span> <span class="operator">=</span> <span class="string">&quot;abcdefg&quot;</span>;  </span><br><span class="line">            <span class="type">String</span> <span class="variable">regular</span> <span class="operator">=</span> <span class="string">&quot;(b)([\\s\\S]+?)(f)&quot;</span>;  </span><br><span class="line">            System.out.println(getRegular(Line, regular).get(<span class="number">0</span>));  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title function_">getRegular</span><span class="params">(String line, String regular)</span> &#123;  </span><br><span class="line">            List&lt;String&gt; code = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;();  </span><br><span class="line"></span><br><span class="line">            <span class="type">Pattern</span> <span class="variable">pattern</span> <span class="operator">=</span> Pattern.compile(regular);  </span><br><span class="line">            <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> pattern.matcher(line);  </span><br><span class="line">            <span class="keyword">while</span>(matcher.find())&#123;  </span><br><span class="line">                    code.add(matcher.group(<span class="number">1</span>));<span class="comment">//看这里的group的参数  </span></span><br><span class="line">            &#125;  </span><br><span class="line">            <span class="keyword">return</span> code;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>我们的目的是获取字符串<code>Line</code>中的<code>cde</code>部分，也就是<code>ab</code>和<code>fg</code>之间的子字符串。<br>这里不详解<code>ab([\\s\\S]+?)fg</code>的含义，只要知道是满足上述要求的正则表达式即可。<br>在官方文档<code>jdk</code>中对<code>group()</code>的定义如下</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="left">String  group();</td>
<td align="left">返回由以前匹配操作所匹配的输入子序列。</td>
</tr>
<tr>
<td align="left">String  group(int group);</td>
<td align="left">返回在以前匹配操作期间由给定组捕获的输入子序列。</td>
</tr>
<tr>
<td align="left">int groupCount();</td>
<td align="left">返回此匹配器模式中的捕获组数。</td>
</tr>
</tbody></table>
<p>这里的捕获组数，简单来说就是，正则表达式中<strong>有多少个括号</strong>，通过<code>groupCount()</code>获取捕获组数</p>
<table>
<thead>
<tr>
<th align="left">函数</th>
<th align="left">获取数据组</th>
<th align="left"><code>(b)([\\s\\S]+?)(f)</code>对<code>abcdefg</code>正则结果</th>
</tr>
</thead>
<tbody><tr>
<td align="left">group()</td>
<td align="left">所有组</td>
<td align="left"><code>bcdef</code></td>
</tr>
<tr>
<td align="left">group(0)</td>
<td align="left">所有组</td>
<td align="left"><code>bcdef</code></td>
</tr>
<tr>
<td align="left">group(1)</td>
<td align="left">第1组</td>
<td align="left"><code>b</code></td>
</tr>
<tr>
<td align="left">group(2)</td>
<td align="left">第2组</td>
<td align="left"><code>cde</code></td>
</tr>
<tr>
<td align="left">group(3)</td>
<td align="left">第3组</td>
<td align="left"><code>f</code></td>
</tr>
</tbody></table>
<p>那么问题来了，如果<code>String regular = &quot;b([\\s\\S]+?)f&quot;;</code><br>把<code>b</code>和<code>f</code>的括号去掉，结果使用<code>groupCount()</code>获取的组数为<code>1</code>，而不是之前的<code>3</code>。<br>也就是说，<code>group(1)</code>获取的是<code>cde</code>，而不是之前的<code>b</code>。</p>
<p>值得注意的是<code>group()</code>会出现越界问题，要注意。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>正则表达式</tag>
      </tags>
  </entry>
  <entry>
    <title>java8函数式编程Lambda表达式</title>
    <url>/posts/java8_lambda_foundation.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在开发安卓的时候就通过<code>RxJava</code>进行过函数式编程。java源码中的建造者模式也是类似函数式编程的玩意。<br>举个例子</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> builder.baseUrl(url)</span><br><span class="line">                    .param(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                    .param(<span class="string">&quot;password&quot;</span>, <span class="string">&quot;admin&quot;</span>)</span><br><span class="line">                    .build();</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h1 id="Lambda表达式-使代码更简洁"><a href="#Lambda表达式-使代码更简洁" class="headerlink" title="Lambda表达式-使代码更简洁"></a>Lambda表达式-使代码更简洁</h1><p>通过<code>匿名内部类</code>，我们可以减少类的数量，并且逻辑更清晰。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;测试&quot;</span>);     </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是，这明显还不够简洁。<code>Runable</code>只有一个方法<code>run()</code>，每次都要重复相同的代码。<br>java8提供了Lambda表达式。用于满足这种<code>只有一个方法的接口</code>的简洁写法。<br>原本<code>5</code>行代码浓缩成了<code>1</code>行！</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; System.out.println(<span class="string">&quot;测试&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>常见的表达式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Runable</span> <span class="variable">noArguments</span> <span class="operator">=</span> () -&gt; System.out.println(<span class="string">&quot;无参Lambda&quot;</span>);</span><br><span class="line"><span class="type">ActionListener</span> <span class="variable">oneArguments</span> <span class="operator">=</span> event -&gt; System.out.println(<span class="string">&quot;含有一个参数的Lambda&quot;</span>);</span><br><span class="line"><span class="type">Runable</span> <span class="variable">multiStatement</span> <span class="operator">=</span> () -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;含有多行&quot;</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;代码的Lambda&quot;</span>);</span><br><span class="line">&#125;;</span><br><span class="line">BinaryOperator(Long) multiArgument = (x,y) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;含有多个参数的Lambda&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br><span class="line">BinaryOperator(Long) multiArgument = (Long x, Long y) -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;含有多个指定类型的参数的Lambda&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> x+y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Stream流-新的迭代方式"><a href="#Stream流-新的迭代方式" class="headerlink" title="Stream流-新的迭代方式"></a>Stream流-新的迭代方式</h1><p>在java8以前，迭代一般都是通过<code>for</code>或者<code>while</code>实现。<br>在java5，产生了<code>foreach</code>的迭代方式。<br>现在，java8提供了新的<code>Stream</code>的迭代方式。</p>
<h2 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h2><p><strong>collect(toList())创建集合</strong><br>通过``</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>).collect(Collectors.toList());</span><br><span class="line">    System.out.println(list);<span class="comment">//[1, 2, 3, 4, 5, 6, 7, 8, 9]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>filter()过滤</strong><br>有时候需要获取满足条件的集合元素。<br>比如大于5的元素</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>)</span><br><span class="line">            .filter(x -&gt; x&gt;<span class="number">5</span>)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    System.out.println(list);<span class="comment">//[6, 7, 8, 9]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>max()最大值与min()最小值</strong><br>这里的最大值最小值不只是指长度或数值上的大小。可以进行自定义排序的指标。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test() &#123;</span><br><span class="line">    String max = Stream.of(&quot;i&quot;,&quot;love&quot;,&quot;you&quot;).max(Comparator.comparing(String::length)).get();</span><br><span class="line">    String min = Stream.of(&quot;i&quot;,&quot;love&quot;,&quot;you&quot;).min(Comparator.comparing(String::length)).get();</span><br><span class="line">    System.out.println(max+&quot;,&quot;+min);// love, i</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Map转换"><a href="#Map转换" class="headerlink" title="Map转换"></a>Map转换</h2><p><strong>map()转换类型</strong><br>将<code>int</code>转换为<code>String</code>类型</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test() &#123;</span><br><span class="line">    List&lt;String&gt; list = Stream.of(1, 2, 3, 4, 5, 6, 7, 8, 9)</span><br><span class="line">            .map(x -&gt; &quot;数字&quot;+x)</span><br><span class="line">            .collect(Collectors.toList());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">    //[数字1, 数字2, 数字3, 数字4, 数字5, 数字6, 数字7, 数字8, 数字9]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>flatMap()转换类型</strong><br>将<code>多个Stream</code>压缩成<code>一个Stream</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; list1 = Stream.of(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>).collect(Collectors.toList());</span><br><span class="line">    List&lt;Character&gt; list2 = Stream.of(<span class="string">&#x27;a&#x27;</span>,<span class="string">&#x27;b&#x27;</span>,<span class="string">&#x27;c&#x27;</span>).collect(Collectors.toList());</span><br><span class="line">    </span><br><span class="line">    System.out.println(Stream.of(list1, list2)</span><br><span class="line">                                .flatMap(list -&gt; list.stream())</span><br><span class="line">                              <span class="comment">//.flatMap(Collection::stream) //方法引用</span></span><br><span class="line">                                .collect(Collectors.toList()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="reduce-一组数据生成一个数据"><a href="#reduce-一组数据生成一个数据" class="headerlink" title="reduce()一组数据生成一个数据"></a>reduce()一组数据生成一个数据</h2><p>上面的<code>max()</code>和<code>min()</code>都是<code>reduce操作</code><br>求和例子，</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test() &#123;</span><br><span class="line">    int sum = Stream.of(1, 2, 3, 4, 5, 6, 7, 8, 9)</span><br><span class="line">                    .reduce(0, (acc, element) -&gt; acc+element);</span><br><span class="line">//  long sum2 = Stream.of(1, 2, 3, 4, 5, 6, 7, 8, 9).mapToInt(x -&gt; x).summaryStatistics().getSum();                    </span><br><span class="line">//  开发时应使用这种方式求和</span><br><span class="line">    System.out.println(sum);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="方法引用"><a href="#方法引用" class="headerlink" title="::方法引用"></a>::方法引用</h1><p>上面的flatMap方法中，使用了<code>Collection::stream</code>，类似C++的语法。<br>等价于<code>list -&gt; list.stream()</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list1 = Stream.of(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;love&quot;</span>,<span class="string">&quot;you&quot;</span>).collect(Collectors.toList());</span><br><span class="line">    <span class="type">String</span> <span class="variable">max</span> <span class="operator">=</span> list1.stream().max(Comparator.comparing(String::length)).get();</span><br><span class="line">    System.out.println(max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="collect收集器的使用"><a href="#collect收集器的使用" class="headerlink" title="collect收集器的使用"></a>collect收集器的使用</h1><p>上面的例子中有一个<code>collect</code>方法，可以将<code>Stream</code>转化为<code>List</code>等集合对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;String&gt; list = Stream.of(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;love&quot;</span>,<span class="string">&quot;you&quot;</span>).collect(Collectors.toList());</span><br><span class="line">    System.out.println(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 转化为指定集合类型 **<br>有时候需要指定特定的集合比如<code>TreeSet</code>之类的。需要手动指定产生集合。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    Set&lt;String&gt; set = Stream.of(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;love&quot;</span>,<span class="string">&quot;you&quot;</span>)</span><br><span class="line">                .collect(Collectors.toCollection(TreeSet::<span class="keyword">new</span>));</span><br><span class="line">    System.out.println(set);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 转化为值 **<br>有时候需要按照某种顺序找到一个值。比如找一个最长的单词。<br>这个例子在实际开发中不使用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">max</span> <span class="operator">=</span> Stream.of(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;love&quot;</span>,<span class="string">&quot;you&quot;</span>)</span><br><span class="line">            .collect(Collectors.maxBy(</span><br><span class="line">                                Comparator.comparing(String::length)</span><br><span class="line">                    ))</span><br><span class="line">            .get();</span><br><span class="line">    System.out.println(max);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 集合生成字符串 **<br>有时候需要将集合的所有字符提取出来，组合在一起</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">str</span> <span class="operator">=</span> Stream.of(<span class="string">&quot;i&quot;</span>, <span class="string">&quot;love&quot;</span>,<span class="string">&quot;you&quot;</span>).collect(Collectors.joining(<span class="string">&quot;*&quot;</span>,<span class="string">&quot;(&quot;</span>,<span class="string">&quot;)&quot;</span>));</span><br><span class="line">    System.out.println(str);<span class="comment">//(i*love*you)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 数据分块分组 **<br><code>partitioningBy</code>将Stream分成两个部分，存储在一个Map中，以<code>true</code>和<code>false</code>为键。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test() &#123;</span><br><span class="line">    Map&lt;Boolean, List&lt;String&gt;&gt; map = Stream.of(&quot;i&quot;, &quot;love&quot;,&quot;you&quot;)</span><br><span class="line">            .collect(Collectors.partitioningBy(str-&gt;str.length()&gt;3));</span><br><span class="line">    for(Map.Entry entry : map.entrySet())&#123;</span><br><span class="line">        System.out.println(entry.getKey()+&quot;,&quot;+entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大部分情况需要分成不止两个部分，可能更多。<br><code>groupingBy</code>可以将Stream分成多个部分，下面的例子是将相同长度的字符串存储到一起。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test() &#123;</span><br><span class="line">    Map&lt;Integer, List&lt;String&gt;&gt; map = Stream.of(&quot;i&quot;, &quot;love&quot;,&quot;you&quot;, &quot;hhh&quot;)</span><br><span class="line">        .collect(Collectors.groupingBy(String::length));</span><br><span class="line">    for(Map.Entry entry : map.entrySet())&#123;</span><br><span class="line">        System.out.println(entry.getKey()+&quot;,&quot;+entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>** 下游收集器 **<br>使用<code>groupingBy</code>的时候发现有多个重载方法。<br><code>groupingBy(Function classifier, Collector downstream)</code>提供了一个下游收集器<code>downstream</code>。<br>可以将<code>classifier</code>收集的流，通过downstream转化。<br>如下面代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Test</span><br><span class="line">public void test()&#123;</span><br><span class="line">    List&lt;String&gt; list = Stream.of(&quot;i&quot;,&quot;love&quot;,&quot;you&quot;,&quot;too&quot;).collect(Collectors.toList());</span><br><span class="line">    Map&lt;Integer, Long&gt; map = list.stream().collect(</span><br><span class="line">        Collectors.groupingBy(String::length,   //根据字符串长度转化为map集合</span><br><span class="line">                                Collectors.counting()));    //处理上游的map集合，转化为集合的个数</span><br><span class="line">    for(Map.Entry entry : map.entrySet())&#123;</span><br><span class="line">        System.out.println(entry.getKey()+&quot;,&quot;+entry.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">    // 1, 1</span><br><span class="line">    // 3, 2</span><br><span class="line">    // 4, 1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Java8</tag>
      </tags>
  </entry>
  <entry>
    <title>toArray和toArray(T[])的不同</title>
    <url>/posts/Difference_between_toArray(T%5B%5Da)_and_toArray().html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Collection</code>接口有两个方法<code>Object[] toArray();</code>和<code>&lt;T&gt; T[] toArray(T[] a);</code>, 可以用来将集合转为数组。</p>
<span id="more"></span>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>一个返回<code>Object[]</code>, 一个返回<code>T[]</code>, 为了避免发生强制转化, 我们一般都是使用<code>&lt;T&gt; T[] toArray(T[] a);</code>。<br>而<code>&lt;T&gt; T[] toArray(T[] a);</code>传入的数组大小可以直接填<code>0</code>, 当然也可以直接填<code>source.size()</code>。<br>但是<a href="https://shipilev.net/blog/2016/arrays-wisdom-ancients/">arrays-wisdom-ancients</a>这篇文章做了分析, <code>JDK6</code>以后直接填<code>0</code>性能更好。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; source = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;String&gt;();</span><br><span class="line"><span class="comment">// 填充数据</span></span><br><span class="line">String[] array1 = (Object[]) source.toArray();</span><br><span class="line">String[] array2 = source.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">0</span>]);</span><br><span class="line">String[] array3 = source.toArray(<span class="keyword">new</span> <span class="title class_">String</span>[source.size()]);</span><br></pre></td></tr></table></figure>

<h1 id="查看ArrayList的实现"><a href="#查看ArrayList的实现" class="headerlink" title="查看ArrayList的实现"></a>查看ArrayList的实现</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ArrayList</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractList</span>&lt;E&gt;</span><br><span class="line">        <span class="keyword">implements</span> <span class="title class_">List</span>&lt;E&gt;, RandomAccess, Cloneable, java.io.Serializable</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> Object[] toArray() &#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.copyOf(elementData, size);</span><br><span class="line">    &#125;</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T[] toArray(T[] a) &#123;</span><br><span class="line">        <span class="keyword">if</span> (a.length &lt; size)</span><br><span class="line">            <span class="comment">// Make a new array of a&#x27;s runtime type, but my contents:</span></span><br><span class="line">            <span class="keyword">return</span> (T[]) Arrays.copyOf(elementData, size, a.getClass());</span><br><span class="line">        System.arraycopy(elementData, <span class="number">0</span>, a, <span class="number">0</span>, size);</span><br><span class="line">        <span class="keyword">if</span> (a.length &gt; size)</span><br><span class="line">            a[size] = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> a;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Arrays</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T[] copyOf(T[] original, <span class="type">int</span> newLength) &#123;</span><br><span class="line">        <span class="keyword">return</span> (T[]) copyOf(original, newLength, original.getClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T,U&gt; T[] copyOf(U[] original, <span class="type">int</span> newLength, Class&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>[]&gt; newType) &#123;</span><br><span class="line">        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">        T[] copy = ((Object)newType == (Object)Object[].class)</span><br><span class="line">            ? (T[]) <span class="keyword">new</span> <span class="title class_">Object</span>[newLength]</span><br><span class="line">            : (T[]) Array.newInstance(newType.getComponentType(), newLength);</span><br><span class="line">        System.arraycopy(original, <span class="number">0</span>, copy, <span class="number">0</span>,</span><br><span class="line">                         Math.min(original.length, newLength));</span><br><span class="line">        <span class="keyword">return</span> copy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们调用<code>ArrayList.toArray</code>方法的时候, 都会调用<code>Arrays.copyOf</code>方法, 最终调用<code>System.arraycopy</code>方法, 这是一个<code>native</code>方法。<br>当然, 不同的集合有不同的<code>toArray</code>实现方法。</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>如果传入的参数<code>toArray(T[] a)</code>小于本身的长度, 会<code>new</code>或者反射创建一个新的数组, 然后将元素复制进去。<br>但是<a href="https://shipilev.net/blog/2016/arrays-wisdom-ancients/">arrays-wisdom-ancients</a>这篇文章做了分析, <code>JDK6</code>以后直接填<code>0</code>性能更好。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>trim为什么失效了</title>
    <url>/posts/Why_did_trim_fail_execute.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一直以为<code>String#trim()</code>是去掉字符串两边空格的。但是以下代码却与预期不同。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(<span class="string">&quot;测试:[&quot;</span>+<span class="string">&quot;820000    &quot;</span>.trim()+<span class="string">&quot;]&quot;</span>); <span class="comment">// ASCII码 160 的空格</span></span><br><span class="line">System.out.println(<span class="string">&quot;测试:[&quot;</span>+<span class="string">&quot;　市辖区&quot;</span>+<span class="string">&quot;]&quot;</span>); <span class="comment">// ASCII码 12288 的空格</span></span><br><span class="line"><span class="comment">// 测试:[820000    ]</span></span><br><span class="line"><span class="comment">// 测试:[　市辖区]</span></span><br></pre></td></tr></table></figure>
<p>这段数字加空格是我从<a href="http://www.stats.gov.cn/tjsj/tjbz/xzqhdm/201703/t20170310_1471429.html">最新县及县以上行政区划代码</a>爬取的。</p>
<span id="more"></span>
<h1 id="查看源码"><a href="#查看源码" class="headerlink" title="查看源码"></a>查看源码</h1><p>很明显, 算法就是</p>
<ol>
<li>从前往后, 找到第一个非空格的字符</li>
<li>从后往前, 找到第一个非空格的字符</li>
<li>使用substring截取字符串</li>
<li>substring使用构造复制函数进行拷贝<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">trim</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> value.length;</span><br><span class="line">    <span class="type">int</span> <span class="variable">st</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span>[] val = value;    <span class="comment">/* avoid getfield opcode */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ((st &lt; len) &amp;&amp; (val[st] &lt;= <span class="string">&#x27; &#x27;</span>)) &#123;</span><br><span class="line">        st++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ((st &lt; len) &amp;&amp; (val[len - <span class="number">1</span>] &lt;= <span class="string">&#x27; &#x27;</span>)) &#123;</span><br><span class="line">        len--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ((st &gt; <span class="number">0</span>) || (len &lt; value.length)) ? substring(st, len) : <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">substring</span><span class="params">(<span class="type">int</span> beginIndex, <span class="type">int</span> endIndex)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">subLen</span> <span class="operator">=</span> endIndex - beginIndex;</span><br><span class="line">    <span class="keyword">return</span> ((beginIndex == <span class="number">0</span>) &amp;&amp; (endIndex == value.length)) ? <span class="built_in">this</span></span><br><span class="line">            : <span class="keyword">new</span> <span class="title class_">String</span>(value, beginIndex, subLen);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
明显没毛病, 要我写我也差不多是这样写。</li>
</ol>
<h1 id="断点调试"><a href="#断点调试" class="headerlink" title="断点调试"></a>断点调试</h1><p>给<code>trim</code>加上断点, 保险起见, 每条语句加上断点。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">trim</span><span class="params">()</span> &#123;</span><br><span class="line">·    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> value.length;</span><br><span class="line">·    <span class="type">int</span> <span class="variable">st</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">·    <span class="type">char</span>[] val = value;    <span class="comment">/* avoid getfield opcode */</span></span><br><span class="line">·</span><br><span class="line">·    <span class="keyword">while</span> ((st &lt; len) &amp;&amp; (val[st] &lt;= <span class="string">&#x27; &#x27;</span>)) &#123;</span><br><span class="line">·        st++;</span><br><span class="line">·    &#125;</span><br><span class="line">·    <span class="keyword">while</span> ((st &lt; len) &amp;&amp; (val[len - <span class="number">1</span>] &lt;= <span class="string">&#x27; &#x27;</span>)) &#123;</span><br><span class="line">·        len--;</span><br><span class="line">·    &#125;</span><br><span class="line">·    <span class="keyword">return</span> ((st &gt; <span class="number">0</span>) || (len &lt; value.length)) ? substring(st, len) : <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试结果如下, 代码走到第9行, 进不去这个<code>while</code>。<br>那明显是<code>(val[len - 1] &lt;= &#39; &#39;)</code>出了问题。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">len (slot_1) = 10</span><br><span class="line">st (slot_2) = 0</span><br><span class="line">value = &#123;</span><br><span class="line">    0 = &#x27;8&#x27; 56</span><br><span class="line">    1 = &#x27;2&#x27; 50</span><br><span class="line">    2 = &#x27;0&#x27; 48</span><br><span class="line">    3 = &#x27;0&#x27; 48</span><br><span class="line">    4 = &#x27;0&#x27; 48</span><br><span class="line">    5 = &#x27;0&#x27; 48</span><br><span class="line">    6 = &#x27; &#x27; 160</span><br><span class="line">    7 = &#x27; &#x27; 160</span><br><span class="line">    8 = &#x27; &#x27; 160</span><br><span class="line">    9 = &#x27; &#x27; 160</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这时候注意<code>value[9]</code>的ASCII码为<code>160</code>。<br>查阅<a href="http://ascii.911cha.com/">ASCII码表</a>可以知道, 空格的ASCII码应该为<code>32</code>。<br>可是这明显是空格啊! 为什么是160呢!</p>
<h1 id="为什么眼见不为实"><a href="#为什么眼见不为实" class="headerlink" title="为什么眼见不为实"></a>为什么眼见不为实</h1><p>web中有一个常识是, 要使用连续空格, 必须使用<code>&amp;nbsp;</code>。<br>如果只按住<code>space</code>输入空格的话, 会被压缩为<code>一个</code>空格。</p>
<p>很明显, 这个<code>&amp;nbsp;</code>的ASCII码就是<code>160</code>。<br>而<code>trim</code>方法只判断了ASCII码为<code>32</code>的空格。<br>就算是apache的<code>StringUtils#trim()</code>, 底层也是调用<code>String#trim()</code>的。</p>
<p>后来还发现了一个ASCII码为<code>12288</code>的空格, 一个汉字宽度的空格。</p>
<h1 id="自己动手丰衣足食"><a href="#自己动手丰衣足食" class="headerlink" title="自己动手丰衣足食"></a>自己动手丰衣足食</h1><p>参考源码, 进行改造</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringHelper</span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 去除字符串首尾空格</span></span><br><span class="line"><span class="comment">     * 32 为 普通空格</span></span><br><span class="line"><span class="comment">     * 160 为 html的空格 &amp;nbsp;</span></span><br><span class="line"><span class="comment">     * 12288 为 一个汉字宽度的空格</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> str</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">trim</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (str == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">char</span>[] val = str.toCharArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> val.length;</span><br><span class="line">        <span class="type">int</span> <span class="variable">st</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span> ((st &lt; len) &amp;&amp;</span><br><span class="line">                StringUtils.equalsAny(val[st] + <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        (<span class="type">char</span>) (<span class="number">32</span>) + <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        (<span class="type">char</span>) (<span class="number">160</span>) + <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        (<span class="type">char</span>) (<span class="number">12288</span>) + <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            st++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ((st &lt; len) &amp;&amp;</span><br><span class="line">                StringUtils.equalsAny(val[len - <span class="number">1</span>] + <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        (<span class="type">char</span>) (<span class="number">32</span>) + <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        (<span class="type">char</span>) (<span class="number">160</span>) + <span class="string">&quot;&quot;</span>,</span><br><span class="line">                        (<span class="type">char</span>) (<span class="number">12288</span>) + <span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">            len--;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ((st &gt; <span class="number">0</span>) || (len &lt; val.length)) ? str.substring(st, len) : str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>什么是链式调用</title>
    <url>/posts/what_is_Methods_Chaining_in_Java.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Java8流行的函数式编程使用的方式类似于<code>a.b().c().d()</code>, 仿佛能无穷无尽点下去。<br>其实这个代码很简单, 换一种写法大概就懂了<code>this.getClass().getSimpleName().length();</code>。<br>在wiki上也有介绍: <a href="https://en.wikipedia.org/wiki/Fluent_interface">Fluent_interface</a></p>
<span id="more"></span>

<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><p>其实链式调用很简单, 就是一个<code>return 对象;</code>的事情。<br>比如<code>return this;</code>等。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="title function_">create</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name; <span class="comment">// 普通的设置属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAge</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age; <span class="comment">// 普通的设置属性</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">name</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name; <span class="comment">// 链式的设置属性</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Student <span class="title function_">age</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name; <span class="comment">// 链式的设置属性</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用结果如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">        s1.setName(<span class="string">&quot;stu1&quot;</span>);</span><br><span class="line">        s1.setAge(<span class="number">12</span>);</span><br><span class="line">        <span class="comment">// 明显链式调用方法比较优雅</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> Student.create().name(<span class="string">&quot;stu2&quot;</span>).age(<span class="number">12</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="优势和缺陷"><a href="#优势和缺陷" class="headerlink" title="优势和缺陷"></a>优势和缺陷</h1><p>显而易见, 使用链式调用的代码更加简洁优雅, 方法间的关联度紧密。<br>同样缺陷也在这里, 每个方法都依赖上一个方法, 如果有一个返回空指针, 那么就会报错。需要代码编写人员的功底比较强。<br>当然, <code>return this;</code>是不可能空指针异常的。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>从Response读取XML字符串进行解析</title>
    <url>/posts/read_XML_string_from_Response_for_parsing.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>调用<code>WebService</code>接口返回了<code>XML</code>的数据, 需要解析并封装为一个<code>AjaxDto(status, msg, obj)</code>对象。<br>项目中已经依赖了<code>Apache</code>的<a href="https://mvnrepository.com/artifact/commons-configuration/commons-configuration">commons-configuration</a>, 所以就直接拿来用了。</p>
<span id="more"></span>

<h1 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h1><p>响应体</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;GBK&quot;</span> ?&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">response</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">code</span>&gt;</span>integer<span class="tag">&lt;/<span class="name">code</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">message</span>&gt;</span>String<span class="tag">&lt;/<span class="name">message</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">response</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>解析代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XmlParser</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(XmlParser.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">xml</span> <span class="operator">=</span> <span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;GBK\&quot; ?&gt; \n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;response&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;head&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;code&gt;integer&lt;/code&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;message&gt;String&lt;/message&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/head&gt;\n&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&lt;/response&gt;\n&quot;</span>;</span><br><span class="line">        <span class="type">XmlParser</span> <span class="variable">parser</span> <span class="operator">=</span> XmlParser.init(xml);</span><br><span class="line">        <span class="keyword">if</span>(parser == <span class="literal">null</span>)&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;创建失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(parser.getString(<span class="string">&quot;head.code&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> XMLConfiguration config;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> XmlParser <span class="title function_">init</span><span class="params">(String xml)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 字符串转为输入流</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(xml.getBytes());) &#123;</span><br><span class="line">            <span class="type">XmlParser</span> <span class="variable">parser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XmlParser</span>(in);</span><br><span class="line">            <span class="keyword">return</span> parser;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ConfigurationException e) &#123;</span><br><span class="line">            logger.error(<span class="string">&quot;加载xml错误&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">XmlParser</span><span class="params">(InputStream in)</span> <span class="keyword">throws</span> ConfigurationException &#123;</span><br><span class="line">        <span class="comment">// 2. 读取输入流数据</span></span><br><span class="line">        config = <span class="keyword">new</span> <span class="title class_">XMLConfiguration</span>();</span><br><span class="line">        config.load(in);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 3. 获取节点数据</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getString</span><span class="params">(String xpath)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> config.getString(xpath);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h1><p>注意以下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">System.out.println(parser.getString(<span class="string">&quot;response.head.code&quot;</span>));</span><br><span class="line">System.out.println(parser.getString(<span class="string">&quot;head.code&quot;</span>));</span><br></pre></td></tr></table></figure>
<p>我第一次使用的时候, 是使用第一行<code>response.head.code</code>代码的, 但是获取失败。<br>改成第二行<code>head.code</code>代码就行了。<br>后来想了下原因, <code>response</code>是根节点, 根节点<strong>有且只有</strong>一个。所以也就不需要特意去指定了。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>XML</tag>
      </tags>
  </entry>
  <entry>
    <title>从i++到CAS操作</title>
    <url>/posts/From_i++_to_CAS_operation.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>i++</code>不是一个原子操作, 原子操作的意思是, 执行代码的时候, 不会发生线程的切换.<br>即使<code>i++</code>只有一行代码, 但是也不是一个原子操作, 主要就是三件事情, 很惭愧, 就做了一点微小的工作(</p>
<ol>
<li>取值: 从内存中取值到寄存器.</li>
<li>自增: 寄存器进行<code>i+1</code>.</li>
<li>回写: 将自增后的值回写到内存中.</li>
</ol>
<span id="more"></span>

<h1 id="多线程下的问题"><a href="#多线程下的问题" class="headerlink" title="多线程下的问题"></a>多线程下的问题</h1><p><code>i++</code>不是一个原子操作, 那么就可能在多线程下出现问题.<br>比如发生以下操作.</p>
<ol>
<li><code>Thread 1</code>从内存中取值<code>i = 0</code>, 在寄存器中自增<code>i = 1</code>.</li>
<li><code>Thread 1</code>在回写到内存前, 时间片结束, 切换到<code>Thread 2</code>.</li>
<li><code>Thread 2</code>从内存中取值<code>i = 0</code>, 在寄存器中自增<code>i = 1</code>.</li>
<li><code>Thread 2</code>在回写到内存前, 时间片结束, 切换到<code>Thread 1</code>.</li>
<li><code>Thread 1</code>将寄存器中的<code>i = 1</code>回写到内存中, 内存中<code>i = 1</code>, 执行结束, 切换到<code>Thread 2</code>.</li>
<li><code>Thread 1</code>将寄存器中的<code>i = 1</code>回写到内存中, 内存中<code>i = 1</code>, 执行结束.</li>
</ol>
<p>最终结果, <code>i = 1</code>, 但是我们期望的是两个线程执行了<code>i++</code>, 最终结果应该是<code>i = 2</code>.<br>这时就轮到<code>java.util.concurrent</code>包出场了, 下面是一个简单的例子.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 加上 volatile 也没用</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">j</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExecutorService</span> <span class="variable">threadPool</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">128</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1_000_000</span>; i++) &#123;</span><br><span class="line">            threadPool.execute(() -&gt; Main.i++);</span><br><span class="line">            threadPool.execute(() -&gt; Main.j.incrementAndGet());</span><br><span class="line">        &#125;</span><br><span class="line">        threadPool.shutdown();</span><br><span class="line">        threadPool.awaitTermination(Long.MAX_VALUE, TimeUnit.NANOSECONDS);</span><br><span class="line">        System.out.println(Main.i); <span class="comment">// 999063</span></span><br><span class="line">        System.out.println(Main.j); <span class="comment">// 1000000</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>AtomicInteger</code>类可以在多线程下, 输出我们预期的结果, 而普通的<code>i++</code>, 则与预期结果不符.</p>
<h1 id="Unsafe-类的存在"><a href="#Unsafe-类的存在" class="headerlink" title="Unsafe 类的存在"></a>Unsafe 类的存在</h1><p>主要的代码就是<code>incrementAndGet</code>这个方法. 我们可以进去看看.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicInteger</span> <span class="keyword">extends</span> <span class="title class_">Number</span> <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Unsafe</span> <span class="variable">unsafe</span> <span class="operator">=</span> Unsafe.getUnsafe();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">incrementAndGet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> unsafe.getAndAddInt(<span class="built_in">this</span>, valueOffset, <span class="number">1</span>) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Unsafe</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">        <span class="keyword">if</span> (!VM.isSystemDomainLoader(caller.getClassLoader()))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SecurityException</span>(<span class="string">&quot;Unsafe&quot;</span>); <span class="comment">// 判断调用 Unsafe 的类是否是 BootstrapClassLoader 加载的类</span></span><br><span class="line">        <span class="keyword">return</span> theUnsafe;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><a href="https://github.com/bpupadhyaya/openjdk-8/blob/master/jdk/src/share/classes/sun/misc/Unsafe.java#L87-L92">源码<code>#L87-L92</code></a><br>可以看到, 里面借助了<code>sun.misc.Unsafe</code>这个类, 它是一个不安全的类, 可以绕过<code>JVM</code>直接操作本地内存.<br>所以为了不让人滥用, 调用<code>getUnsafe()</code>时会判断调用<code>Unsafe</code>的类是否是<code>BootstrapClassLoader</code>加载的类.<br>我们自己写的类是由<code>sun.misc.Launcher$AppClassLoader</code>加载的, 所以如果我们自己去调用<code>getUnsafe()</code>, 肯定会抛出<code>SecurityException</code>.<br>当然我们也可以通过反射获取.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeHelper</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title function_">getUnsafe</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">unsafeField</span> <span class="operator">=</span> Unsafe.class.getDeclaredFields()[<span class="number">0</span>];</span><br><span class="line">        unsafeField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> (Unsafe) unsafeField.get(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="深入-getAndAddInt"><a href="#深入-getAndAddInt" class="headerlink" title="深入 getAndAddInt"></a>深入 getAndAddInt</h1><p><a href="https://github.com/bpupadhyaya/openjdk-8/blob/master/jdk/src/share/classes/sun/misc/Unsafe.java#L1028-L1034">源码<code>#L1028-L1034</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Unsafe</span> &#123;</span><br><span class="line">    <span class="comment">// unsafe.getAndAddInt(this, valueOffset, 1) + 1;</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndAddInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> delta)</span> &#123;</span><br><span class="line">        <span class="type">int</span> v;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            v = getIntVolatile(o, offset);</span><br><span class="line">        &#125; <span class="keyword">while</span> (!compareAndSwapInt(o, offset, v, v + delta));</span><br><span class="line">        <span class="keyword">return</span> v;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">native</span> <span class="type">int</span> <span class="title function_">getIntVolatile</span><span class="params">(Object o, <span class="type">long</span> offset)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="type">boolean</span> <span class="title function_">compareAndSwapInt</span><span class="params">(Object o, <span class="type">long</span> offset, <span class="type">int</span> expected, <span class="type">int</span> x)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个核心就是<code>compareAndSwapInt</code>这个<code>CAS</code>操作. 整个方法的逻辑就是</p>
<ol>
<li>读取<code>Object</code>的<code>value</code>属性在内存中的偏移量地址<code>offset</code>, 写入变量<code>v</code>.</li>
<li><code>compareAndSwapInt</code>方法, 判断<code>Object</code>的地址<code>offset</code>的值, 是否为<code>v</code>, 是则将<code>v + delta</code>写入地址<code>offset</code>.</li>
<li>如果地址<code>offset</code>的值和变量<code>v</code>不相等, 说明有其他线程修改了, 那么就再循环一次, 回到步骤<code>1</code>.</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>再深入就是<code>c++</code>和汇编层次的代码了, 技术有限就不细说了<del>(太菜)</del>, 建议查看参考资料.<br>总的来说, <code>CAS</code>就是一个比较操作, 直接操作内存地址, 就不会发生寄存器的值来不及回写到内存中的问题.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.cnblogs.com/noKing/p/9094983.html">Java原子类中CAS的底层实现</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Java SE</tag>
      </tags>
  </entry>
  <entry>
    <title>从时空复杂度思考获取子集合问题</title>
    <url>/posts/think_about_the_problem_of_obtaining_sub_collection_from_the_perspective_of_complexity_in_time_and_space.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>需求: 需要从<code>List</code>根据条件获取子元素集合<code>subList</code>。</p>
<p>有两种方法</p>
<ol>
<li>时间优先: 添加到新的集合中。</li>
<li>空间优先: 使用<code>Iterator</code>迭代器进行删除。</li>
</ol>
<p>这里以<code>ArrayList</code>为例。</p>
<span id="more"></span>

<h1 id="测试数据"><a href="#测试数据" class="headerlink" title="测试数据"></a>测试数据</h1><p>现在需要把偶数取出来。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++)&#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="时间优先"><a href="#时间优先" class="headerlink" title="时间优先"></a>时间优先</h1><p>新建一个集合, 遍历参数集合, 将满足条件的数据插入新的集合, 再将新集合插入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(even1(list));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">even1</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="comment">// 添加到新的集合</span></span><br><span class="line">        List&lt;Integer&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(list.size());</span><br><span class="line">        <span class="keyword">for</span> (Integer i : list) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                result.add(i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="空间优先"><a href="#空间优先" class="headerlink" title="空间优先"></a>空间优先</h1><p>直接在已有集合上, 使用迭代器进行删除操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            list.add(i);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(even2(list));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">even2</span><span class="params">(List&lt;Integer&gt; list)</span> &#123;</span><br><span class="line">        <span class="comment">// 在已有集合进行删除</span></span><br><span class="line">        <span class="keyword">for</span> (Iterator&lt;Integer&gt; it = list.iterator(); it.hasNext(); ) &#123;</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">value</span> <span class="operator">=</span> it.next();</span><br><span class="line">            <span class="keyword">if</span> (value % <span class="number">2</span> != <span class="number">0</span>) &#123;</span><br><span class="line">                it.remove();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>如何选择最佳的获取子集合策略，取决于该集合的数据结构。<br>例如 <code>ArrayList</code> 的集合数据结构是数组, 删除、插入的效率是 <code>O(n)</code> , 查找的效率是 <code>O(1)</code>。<br>再综合考虑代码的复杂度, 个人观点, 如果不是空间非常紧张, 还是选<strong>时间优先</strong>的方案比较好。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>算法</tag>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>使用静态构造器取代new</title>
    <url>/posts/use_static_method_to_replace_new_object.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一般创建对象都是new出来的, Spring提供的是xml反射(或者使用注解)创建, 将创建对象的任务交给Spring完成。<br>不懂Spring可以将其理解为一个存储对象的容器。<br>控制反转并不是什么高大上的东西,  我们也可以做一个小的控制反转的例子。</p>
<span id="more"></span>

<h1 id="使用静态构造器取代new"><a href="#使用静态构造器取代new" class="headerlink" title="使用静态构造器取代new"></a>使用静态构造器取代new</h1><p>比如有个学生类, 将<code>构造函数</code>私有化, 同时创建一个静态的<code>create</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Student</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Student <span class="title function_">create</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样做有什么好处呢?<br>很明显, 我们能给构造函数<strong>命名</strong>了。<br>维护者不再需要去猜测<code>new Student(true)</code>是什么意思。</p>
<p>还体现了职责分离, 创建对象的具体过程交给了对象类自己完成, 外部调用者不需要关心创建对象的流程。<br>这里为了体现差异, 将方法名写为中文, 实际开发不推荐写中文。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span>&#123;</span><br><span class="line">    <span class="type">boolean</span> 优秀;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Student</span><span class="params">(<span class="type">boolean</span> status)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.优秀 = status;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Student 获得一个优秀学生()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Student 获得一个不好学生()&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>创建Utils工具类的最佳实践</title>
    <url>/posts/The_Best_practice_for_create_Utils_class.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>有些类我们不希望实例化, 比如 <code>ArrayUtils</code>。<br>实例化这些工具类是没有意义的。</p>
<span id="more"></span>

<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><ol>
<li>使用 <code>final</code> 、 <code>abstract</code> 修饰 <code>class</code>。</li>
<li>私有化构造函数</li>
<li>构造函数抛出异常<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// abstract类不能直接实例化, 只能由子类实例化</span></span><br><span class="line"><span class="comment">// final类不能实例化</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">ArrayUtils</span> &#123;</span><br><span class="line">    <span class="comment">// 私有化构造函数, 子类必须调用父类的构造函数, 但是又调用不了</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">ArrayUtils</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 防止反射创建, 抛出异常</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;工具类不允许实例化&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 工具方法</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">sort</span><span class="params">(Integer... arr)</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>初探Lombok并拒绝它</title>
    <url>/posts/learn_Lombok_and_reject_it.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在一个<code>GitHub</code>项目发现它使用了<code>Lombok</code>这个工具。没见过所以了解一下, 但是发现还是不太好用, 于是摒弃之。但好歹记录一下。</p>
<span id="more"></span>

<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><a href="https://projectlombok.org/">Lombok</a>是一个可以大量减少代码的工具, 通过<code>Pluggable Annotation Processing API</code>的方式解析注解, 在<strong>编译期</strong>为<code>class</code>文件注入<code>getter</code>或<code>setter</code>或<code>toString</code>等等诸如此类的代码。</p>
<h1 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h1><ol>
<li>开发工具<a href="https://www.jetbrains.com/idea/download/">IDEA</a></li>
<li>在IDEA中安装<a href="https://plugins.jetbrains.com/plugin/6317">Lombok Plugin</a>插件</li>
<li>导入<a href="https://mvnrepository.com/artifact/org.projectlombok/lombok">org.projectlombok.lombok</a></li>
</ol>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p><code>Lombok</code>通过注解生效, <a href="https://projectlombok.org/features/all">官方注解列表</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span>() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        System.out.println(<span class="string">&quot;自动生成的方法:&quot;</span> + user.getId() + <span class="string">&quot;,&quot;</span> + user.getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="为什么摒弃它"><a href="#为什么摒弃它" class="headerlink" title="为什么摒弃它"></a>为什么摒弃它</h1><ol>
<li><code>Lombok</code>具有太强的侵入性</li>
<li>失去了封装的意义</li>
</ol>
<h2 id="具有太强的侵入性"><a href="#具有太强的侵入性" class="headerlink" title="具有太强的侵入性"></a>具有太强的侵入性</h2><p>我在第一次接触到到带有<code>Lombok</code>项目的时候, 编译报错, 虽然我导入了<code>Lombok</code>的<code>maven</code>地址, 但是仍然提示找不到<code>getter</code>方法。<br>点进去一看, 发现根本没有<code>getter</code>方法, 只有一个<code>@Getter</code>注解。</p>
<p>也就是说, 一旦你使用了<code>Lombok</code>, 所有编译你代码的人都必须使用<code>Lombok</code>编译, 传染性、侵入性太强</p>
<h1 id="失去了封装的意义"><a href="#失去了封装的意义" class="headerlink" title="失去了封装的意义"></a>失去了封装的意义</h1><p>更重要的是, <strong>面向对象</strong>。<br>如果我们只是不想写<code>getter</code>和<code>setter</code>方法, 不如就直接将<code>field</code>设置成<code>public</code>。<br>长久的写重复的<code>getter</code>和<code>setter</code>方法已经让人不知道为什么要这样写, 只知道大家都是这样写, 以前都是这样写, 所以这样写。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span>(name) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;admin&quot;</span>: <span class="built_in">this</span>.name = <span class="string">&quot;I am admin:&quot;</span>+name; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;user&quot;</span> : <span class="built_in">this</span>.name = <span class="string">&quot;I am user:&quot;</span> +name; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第二个<code>setter</code>方法, 封装了逻辑操作, 和第一个方法不同, 这就是<code>setter</code>方法的意义。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Lombok</tag>
      </tags>
  </entry>
  <entry>
    <title>反射详解</title>
    <url>/posts/Java_Reflection.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>学习框架底层必须要掌握反射。</p>
<span id="more"></span>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="comment">/** 属性 */</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 构造器 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name, <span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">/** getter And Setter */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="获取类对象的三种方法"><a href="#获取类对象的三种方法" class="headerlink" title="获取类对象的三种方法"></a>获取类对象的三种方法</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testClass</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">c1</span> <span class="operator">=</span> Person.class;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">c2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>().getClass();</span><br><span class="line">    <span class="type">Class</span> <span class="variable">c3</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.ahao.javaeeDemo.Person&quot;</span>);</span><br><span class="line">    System.out.print(c1+<span class="string">&quot;\n&quot;</span>+c2+<span class="string">&quot;\n&quot;</span>+c3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="通过反射创建对象"><a href="#通过反射创建对象" class="headerlink" title="通过反射创建对象"></a>通过反射创建对象</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testNew</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException,</span><br><span class="line">    IllegalAccessException, InstantiationException,</span><br><span class="line">    NoSuchMethodException, InvocationTargetException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.ahao.javaeeDemo.Person&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line">    System.out.println(<span class="string">&quot;无参构造方法：&quot;</span>+p1.toString());</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p2</span> <span class="operator">=</span> (Person) clazz.getConstructor(String.class, <span class="type">int</span>.class).newInstance(<span class="string">&quot;张三&quot;</span>, <span class="number">12</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;有参构造方法：&quot;</span>+p2.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="操作Field"><a href="#操作Field" class="headerlink" title="操作Field"></a>操作Field</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testField</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException,</span><br><span class="line">    NoSuchFieldException,</span><br><span class="line">    IllegalAccessException, InstantiationException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.ahao.javaeeDemo.Person&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> clazz.getDeclaredField(<span class="string">&quot;name&quot;</span>);<span class="comment">//获取一个自己声明的Field，要访问父类Field要用getField()</span></span><br><span class="line">    name.setAccessible(<span class="literal">true</span>);<span class="comment">//默认只能操作public，如果要操作其他权限，需要使用这个方法</span></span><br><span class="line">    name.set(p1, <span class="string">&quot;张三&quot;</span>);<span class="comment">//相当于p1.name = &quot;张三&quot;</span></span><br><span class="line">    System.out.println(p1.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="操作Method"><a href="#操作Method" class="headerlink" title="操作Method"></a>操作Method</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testMethod</span><span class="params">()</span> <span class="keyword">throws</span> ClassNotFoundException,</span><br><span class="line">    IllegalAccessException, InstantiationException,</span><br><span class="line">    NoSuchMethodException, InvocationTargetException &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.ahao.javaeeDemo.Person&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> (Person) clazz.newInstance();</span><br><span class="line"></span><br><span class="line">    <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> clazz.getDeclaredMethod(<span class="string">&quot;setName&quot;</span>, String.class);<span class="comment">//获取一个自己声明的Method，要访问父类Field要用getMethod()</span></span><br><span class="line">    method.setAccessible(<span class="literal">true</span>);<span class="comment">//默认只能操作public，如果要操作其他权限，需要使用这个方法</span></span><br><span class="line">    method.invoke(p1, <span class="string">&quot;张三&quot;</span>);<span class="comment">//相当于p1.setName(&quot;张三&quot;)</span></span><br><span class="line">    System.out.println(p1.toString());</span><br><span class="line">    <span class="comment">//method.invoke(null, args);//当对象为null时，操作static方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>反射</tag>
      </tags>
  </entry>
  <entry>
    <title>复制构造函数与clone</title>
    <url>/posts/copy_constructor_and_clone_method.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>对一个对象的复制，通常实现<code>Cloneable</code>接口使用<code>clone</code>方法。<br>但这有一个设计缺陷。<code>Cloneable</code>没有<code>clone</code>方法，反而在<code>Object</code>里面调用了<code>native</code>修饰的<code>clone</code>方法。</p>
<span id="more"></span>

<h1 id="缺陷"><a href="#缺陷" class="headerlink" title="缺陷"></a>缺陷</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显看到，<code>Cloneable</code>是一个空接口，实现<code>Cloneable</code>只是为了在调用<code>clone</code>方法时，不抛出<code>CloneNotSupportedException</code>异常。<br>而且使用的是<code>native</code>修饰的<code>clone</code>方法，对应用开发者是透明的，开发者对<code>clone</code>方法不可控。</p>
<h1 id="使用复制构造函数解决"><a href="#使用复制构造函数解决" class="headerlink" title="使用复制构造函数解决"></a>使用复制构造函数解决</h1><p>Josh Bloch推荐使用复制构造函数来实现<code>clone</code>功能，实际上，<code>HashMap</code>也通过复制构造函数进行clone。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.util.HashMap</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashMap</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">AbstractMap</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Map</span>&lt;K,V&gt;, Cloneable, Serializable &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loadFactor = DEFAULT_LOAD_FACTOR;</span><br><span class="line">        putMapEntries(m, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.artima.com/intv/bloch13.html">Copy Constructor versus Cloning</a></li>
</ul>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>数据库查询出的数据转为树形结构</title>
    <url>/posts/The_database_records_converted_to_tree_structure..html</url>
    <content><![CDATA[<h1 id="数据准备"><a href="#数据准备" class="headerlink" title="数据准备"></a>数据准备</h1><p>假设有以下数据, 要建立树形结构</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">id    pid    name</span><br><span class="line">6      5     node6</span><br><span class="line">5      2     node5</span><br><span class="line">4      2     node4</span><br><span class="line">3      1     node3</span><br><span class="line">2      0     node2</span><br><span class="line">1      0     node1</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer pid;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    List&lt;TreeNode&gt; subTree;</span><br><span class="line">    <span class="comment">// 省略 getter 和 setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>数据库查出的都是<code>List</code>集合, 要转成树形结构只能用<code>Java</code>代码实现。<br>转化的方式有两种</p>
<ol>
<li>先查询出根节点, 再用<code>pid</code>递归查询数据库</li>
<li>一次性查出所有的记录, 然后用<code>Java</code>代码组装树形结构</li>
</ol>
<h1 id="递归查询数据库-不推荐-耗时长"><a href="#递归查询数据库-不推荐-耗时长" class="headerlink" title="递归查询数据库(不推荐, 耗时长)"></a>递归查询数据库(不推荐, 耗时长)</h1><p>这种方法编写方便, 但是要进行频繁的数据库<code>IO</code>, 所以不推荐使用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public interface DAO &#123;</span><br><span class="line">    List&lt;TreeNode&gt; getByPid(int pid);</span><br><span class="line">&#125;</span><br><span class="line">public class TestService &#123;</span><br><span class="line">    private DAO dao = new DAO();</span><br><span class="line">    public List&lt;TreeNode&gt; getTree() &#123;</span><br><span class="line">        return getTree(0);</span><br><span class="line">    &#125;</span><br><span class="line">    private List&lt;TreeNode&gt; getTree(int pid) &#123;</span><br><span class="line">        List&lt;TreeNode&gt; parent = dao.getByPid(pid);</span><br><span class="line">        for(TreeNode item : parent) &#123;</span><br><span class="line">            List&lt;TreeNode&gt; child = dao.getByPid(item.getId());</span><br><span class="line">            item.setSubTree(child);</span><br><span class="line">        &#125;</span><br><span class="line">        return parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果有<code>n</code>个节点, 那么就要查询<code>n</code>次数据库, 数量大了就会特别慢。</p>
<h1 id="一次性查询出所有记录"><a href="#一次性查询出所有记录" class="headerlink" title="一次性查询出所有记录"></a>一次性查询出所有记录</h1><p>既然数据库查询耗时长, 那么先一次性把所有数据查到内存中, 再自由组装树形结构。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer pid;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    List&lt;TreeNode&gt; subTree;</span><br><span class="line">    <span class="comment">// 省略 getter 和 setter</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;TreeNode&gt; <span class="title function_">source</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;TreeNode&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">6</span>, <span class="number">5</span>, <span class="string">&quot;node6&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">5</span>, <span class="number">2</span>, <span class="string">&quot;node5&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">4</span>, <span class="number">2</span>, <span class="string">&quot;node4&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">3</span>, <span class="number">1</span>, <span class="string">&quot;node3&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">2</span>, <span class="number">0</span>, <span class="string">&quot;node2&quot;</span>));</span><br><span class="line">        list.add(<span class="keyword">new</span> <span class="title class_">TreeNode</span>(<span class="number">1</span>, <span class="number">0</span>, <span class="string">&quot;node1&quot;</span>));</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里在内存中组装树形结构也有两种方法, 递归和循环。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        List&lt;TreeNode&gt; recursive = recursive(TreeNode.source());</span><br><span class="line">        List&lt;TreeNode&gt; loop = loop(TreeNode.source());</span><br><span class="line">        System.out.println(JSONObject.toJSONString(recursive));</span><br><span class="line">        System.out.println(JSONObject.toJSONString(loop));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= 循环构建 ======================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;TreeNode&gt; <span class="title function_">loop</span><span class="params">(List&lt;TreeNode&gt; source)</span> &#123;</span><br><span class="line">        List&lt;TreeNode&gt; topNodes = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TreeNode&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (TreeNode node : source) &#123;</span><br><span class="line">            <span class="comment">// 1. 获取 top 节点, 即没有 parent 节点的节点</span></span><br><span class="line">            <span class="keyword">if</span> (node.getPid() == <span class="number">0</span>) &#123;</span><br><span class="line">                topNodes.add(node);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 2. 寻找 是否有节点的 parent 节点 为当前节点, 有则加入</span></span><br><span class="line">            <span class="keyword">for</span> (TreeNode find : source) &#123;</span><br><span class="line">                <span class="keyword">if</span> (find.getPid().equals(node.getId())) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (node.getSubTree() == <span class="literal">null</span>) &#123;</span><br><span class="line">                        node.setSubTree(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TreeNode&gt;());</span><br><span class="line">                    &#125;</span><br><span class="line">                    node.getSubTree().add(find);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> topNodes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ================= 递归构建 ======================</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;TreeNode&gt; <span class="title function_">recursive</span><span class="params">(List&lt;TreeNode&gt; source)</span> &#123;</span><br><span class="line">        List&lt;TreeNode&gt; trees = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (TreeNode node : source) &#123;</span><br><span class="line">            <span class="comment">// 1. 获取 top 节点, 即没有 parent 节点的节点</span></span><br><span class="line">            <span class="keyword">if</span> (node.getPid() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// 2. 寻找 是否有节点的 parent 节点 为当前节点, 有则加入</span></span><br><span class="line">                trees.add(find(node, source));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> trees;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TreeNode <span class="title function_">find</span><span class="params">(TreeNode parent, List&lt;TreeNode&gt; treeNodes)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (TreeNode it : treeNodes) &#123;</span><br><span class="line">            <span class="keyword">if</span>(parent.getId().equals(it.getPid())) &#123;</span><br><span class="line">                <span class="keyword">if</span> (parent.getSubTree() == <span class="literal">null</span>) &#123;</span><br><span class="line">                    parent.setSubTree(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;TreeNode&gt;());</span><br><span class="line">                &#125;</span><br><span class="line">                parent.getSubTree().add(find(it,treeNodes));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><p>某篇CSDN博客, 后来找不到了</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
        <tag>业务设计</tag>
      </tags>
  </entry>
  <entry>
    <title>自动转型带来的NoSuchMethodError</title>
    <url>/posts/NoSuchMethodError_caused_by_Automatic_Type_Conversion.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>更新了<code>core</code>包里的通用方法, 结果本地代码没问题, 线上代码<code>500</code>, 看了下<code>localhost.log</code>, 发现报<code>NoSuchMethodError</code>. 特此记录下。</p>
<span id="more"></span>

<h1 id="重现步骤"><a href="#重现步骤" class="headerlink" title="重现步骤"></a>重现步骤</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Main.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">page</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">pageSize</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        Utils.test(page,pageSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> pageSize)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;page:&quot;</span>+page+<span class="string">&quot;, pageSize:&quot;</span>+pageSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译<code>javac Main.java Utils.java</code><br>运行<code>java Main</code>后输出<code>page:1, pageSize:10</code><br>修改<code>Utils</code>代码, 将<code>int</code>改为<code>long</code>, <code>Main</code>不用改动</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> page, <span class="type">int</span> pageSize)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;第&quot;</span>+page+<span class="string">&quot;页, 分页大小为&quot;</span>+pageSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只编译<code>Utils</code>, 执行<code>javac Utils.java</code><br>然后运行<code>java Main</code>, 抛出<code>NoSuchMethodError</code>.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; java.lang.NoSuchMethodError: Utils.test(II)V</span><br><span class="line">        at Main.main(Main.java:5)</span><br></pre></td></tr></table></figure>
<p>重新同时编译两个文件<code>javac Main.java Utils.java</code><br>运行<code>java Main</code>后又成功输出<code>page:1, pageSize:10</code></p>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先把修改前的<code>class</code>文件反编译, 得到如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Main.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Main</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] var0)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        Utils.test(var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Utils.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Utils</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> var0, <span class="type">int</span> var1)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;page:&quot;</span> + var0 + <span class="string">&quot;, pageSize:&quot;</span> + var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将<code>Utils</code>的<code>int</code>转为<code>long</code>之后进行反编译得到如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Main.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Main</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] var0)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        Utils.test(var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Utils.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Utils</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> var0, <span class="type">int</span> var2)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;page:&quot;</span> + var0 + <span class="string">&quot;, pageSize:&quot;</span> + var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>同时编译<code>Main.java</code>和<code>Utils.java</code>之后进行反编译得到如下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Main.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Main</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] var0)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">        Utils.test((<span class="type">long</span>)var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Utils.class</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Utils</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> var0, <span class="type">int</span> var2)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;page:&quot;</span> + var0 + <span class="string">&quot;, pageSize:&quot;</span> + var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对比可以看到, 正常执行的代码, <code>page</code>参数的类型是对应的, 自动转型其实是在编译的时候对其进行了强制转换.<br>当我们修改了方法参数类型后, 只编译部署<code>Utils.class</code>后, <code>Main</code>就找不到符合<code>test(int, int)</code>的方法, 因为<code>Utils.class</code>只有<code>test(long, int)</code>方法。<br>而当我们两个类都进行编译时, <code>Main</code>检测到<code>Utills.class</code>没有<code>test(int, int)</code>, 就会自动在调用的方法里加上强制类型转换<code>(long) var1</code>.</p>
<h1 id="发生的情景"><a href="#发生的情景" class="headerlink" title="发生的情景"></a>发生的情景</h1><p>一般发生在增量更新的项目里面, 本地编译了<code>class</code>文件, 只替换服务器上对应的文件, 如果是全量更新的项目, 则不会出现这个问题。</p>
<h1 id="如何避免"><a href="#如何避免" class="headerlink" title="如何避免"></a>如何避免</h1><p>有两种方法</p>
<ol>
<li>全量更新</li>
<li>保留旧的代码, 添加<code>@Deprecated</code>注解<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Utils.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Utils</span> &#123;</span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">int</span> page, <span class="type">int</span> pageSize)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;page:&quot;</span>+page+<span class="string">&quot;, pageSize:&quot;</span>+pageSize);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(<span class="type">long</span> page, <span class="type">int</span> pageSize)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;page:&quot;</span>+page+<span class="string">&quot;, pageSize:&quot;</span>+pageSize);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>自定义Annotation学习笔记</title>
    <url>/posts/how_to_custom_annotation.html</url>
    <content><![CDATA[<h1 id="JDK元注解"><a href="#JDK元注解" class="headerlink" title="JDK元注解"></a>JDK元注解</h1><p>对注解使用的注解又称为<strong>元注解</strong>。</p>
<span id="more"></span>

<h2 id="Retention"><a href="#Retention" class="headerlink" title="@Retention"></a>@Retention</h2><p><code>Retention</code>意思是保留，声明这个注解的生存时间，包含了一个<code>RetentionPolicy</code>的枚举类的<code>value</code>成员变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span><span class="comment">//1.3节知识</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span><span class="comment">//1.2节知识</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention &#123;</span><br><span class="line">    RetentionPolicy <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">RetentionPolicy枚举</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left">CLASS</td>
<td align="left">将Annotation记录在class文件中，运行时抛弃，这是默认值</td>
</tr>
<tr>
<td align="left">RUNTIME</td>
<td align="left">将Annotation记录在class文件中，运行时保留，可以使用反射</td>
</tr>
<tr>
<td align="left">SOURCE</td>
<td align="left">只将Annotation记录在java源代码中，用于编译提示报错</td>
</tr>
</tbody></table>
<h2 id="Target"><a href="#Target" class="headerlink" title="@Target"></a>@Target</h2><p><code>Target</code>意思是目标，表示这个注解可以用于<code>类</code>、<code>方法</code>、<code>Field</code>等不同地方。<br>可以看到<code>value</code>是一个<code>ElementType</code>枚举类的数组，即可以接收多个参数。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span><span class="comment">//1.3节知识</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span><span class="comment">//1.1节知识</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target &#123;</span><br><span class="line">    ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="left">ElementType枚举</th>
<th align="left">修饰范围</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ANNOTATION_TYPE</td>
<td align="left">注解Annotation</td>
</tr>
<tr>
<td align="left">PACKAGE</td>
<td align="left">包</td>
</tr>
<tr>
<td align="left">TYPE</td>
<td align="left">类、接口、注释、枚举</td>
</tr>
<tr>
<td align="left">CONSTRUCTOR</td>
<td align="left">类构造器</td>
</tr>
<tr>
<td align="left">METHOD</td>
<td align="left">方法</td>
</tr>
<tr>
<td align="left">FIELD</td>
<td align="left">成员变量</td>
</tr>
<tr>
<td align="left">LOCAL_VARIABLE</td>
<td align="left">局部变量</td>
</tr>
<tr>
<td align="left">PARAMETER</td>
<td align="left">形式参数</td>
</tr>
</tbody></table>
<h2 id="Documented"><a href="#Documented" class="headerlink" title="@Documented"></a>@Documented</h2><p><code>Documented</code>意思是文档，修饰的<code>Annotation</code>将被<code>javadoc</code>提取成文档</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Documented &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Inherited"><a href="#Inherited" class="headerlink" title="@Inherited"></a>@Inherited</h2><p><code>Inherited</code>意思是遗传，修饰的<code>Annotation</code>所修饰的类将具有继承性。即如果<code>A注解</code>被<code>@Inherited</code>修饰，那么被<code>A注解</code>修饰的<code>B类</code>的子类<code>C类</code>将默认被<code>A注解</code>修饰。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Inherited &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="自定义Annotation"><a href="#自定义Annotation" class="headerlink" title="自定义Annotation"></a>自定义Annotation</h1><p>有了元注解，就可以自定义注解</p>
<h2 id="声明"><a href="#声明" class="headerlink" title="声明"></a>声明</h2><p>和普通的类、接口声明一样，使用<code>@interface</code>关键字即可。还可以添加成员变量(以方法的形式)，指定默认值。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MyAnnotation&#123;</span><br><span class="line">    String <span class="title function_">name</span><span class="params">()</span>;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">age</span><span class="params">()</span> <span class="keyword">default</span> <span class="number">20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取注解信息"><a href="#获取注解信息" class="headerlink" title="获取注解信息"></a>获取注解信息</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="meta">@MyAnnotation(name = &quot;小明&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Test.test(Main.class);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@MyAnnotation(name = &quot;小行&quot;, age=12)</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="meta">@MyAnnotation(name=&quot;小明&quot;, age = 21)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">(Class c)</span>&#123;</span><br><span class="line">        <span class="keyword">for</span>(Method m : c.getMethods())&#123;</span><br><span class="line">            <span class="keyword">for</span>(Annotation a : m.getAnnotations())&#123;</span><br><span class="line">                <span class="keyword">if</span>(a <span class="keyword">instanceof</span> MyAnnotation)&#123;</span><br><span class="line">                    <span class="type">MyAnnotation</span> <span class="variable">ma</span> <span class="operator">=</span> (MyAnnotation) a;</span><br><span class="line">                    System.out.println(m.getName()+<span class="string">&quot;:&quot;</span>+ma.name()+<span class="string">&quot;,&quot;</span>+ma.age());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>Annotation</tag>
      </tags>
  </entry>
  <entry>
    <title>被忽视的初始化块</title>
    <url>/posts/Ignored_initialization_block.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>从学过初始化块之后, 就一直没用到, 今天学习<code>Mybatis</code>, 居然有一处语法没看懂。特此记录一下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PrivilegeProvider</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">selectById</span><span class="params">(<span class="keyword">final</span> Long id)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SQL</span>()&#123;</span><br><span class="line">            &#123;</span><br><span class="line">                SELECT(<span class="string">&quot;id, privilege_name, privilege_url&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;.toString();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="初始化块"><a href="#初始化块" class="headerlink" title="初始化块"></a>初始化块</h1><p>这可不是<code>Lambda</code>表达式, 因为环境是<code>JDK 1.7</code>。<br>而是<strong>初始化块</strong>。<br>我们自己创建个例子。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyList</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;E&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">// 链式编程, 返回this</span></span><br><span class="line">    <span class="keyword">public</span> MyList&lt;E&gt; <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">        list.add(e);</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        MyList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">MyList</span>&lt;String&gt;() &#123;</span><br><span class="line">            <span class="comment">// 初始化块</span></span><br><span class="line">            &#123;</span><br><span class="line">                add(<span class="string">&quot;test1&quot;</span>);</span><br><span class="line">                add(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">                    add(<span class="string">&quot;test3&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Assert.assertEquals(<span class="number">4</span>, list.list.size());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        MyList&lt;String&gt; list = <span class="keyword">new</span> <span class="title class_">MyList</span>&lt;String&gt;()</span><br><span class="line">                .add(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">                .add(<span class="string">&quot;test2&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">3</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            list.add(<span class="string">&quot;test3&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Assert.assertEquals(<span class="number">4</span>, list.list.size());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看<code>test1</code>方法, 是不是和上面的很熟悉, 其实就是使用了初始化块, 进行初始化。和下面<code>test2</code>方法是等价的。</p>
<p>而且也不会产生匿名内部类, 对于某些需要参数进行初始化, 而不得不将其设计为抽象类的类, 是一种很好的代码优化手段。</p>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>解析String为数字用valueOf还是parseXxx?</title>
    <url>/posts/valueOf_method_and_parseXxx_method.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>findBuds真是一个好插件, 找到了许多平时都不知道的高危bug。<br>在我解析字符串时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">getLong</span><span class="params">(String key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Long.valueOf(key == <span class="literal">null</span> ? <span class="string">&quot;0&quot;</span> : key.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p>给我爆了这个警告</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Boxing/unboxing to parse a primitive</span><br><span class="line">A boxed primitive is created from a String, just to extract the unboxed primitive value. It is more efficient to just call the static parseXXX method.</span><br></pre></td></tr></table></figure>

<p>意思是<code>一个包装类由字符串创建, 只是为了获取基本数据类型的值, 调用parseXxx更有效</code>。</p>
<h1 id="两个方法的返回值不同"><a href="#两个方法的返回值不同" class="headerlink" title="两个方法的返回值不同"></a>两个方法的返回值不同</h1><p>jdk7提供的自动拆装箱语法糖是很不错的。<br>但是过份依赖语法糖就会出现一些 <code>常识性</code> 问题。<br>两个方法如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">public static long parseLong(String s);</span><br><span class="line">public static Long valueOf(String s);</span><br></pre></td></tr></table></figure>
<p>先说结论</p>
<ul>
<li>要获取基本数据类型就使用 <code>parseXxx</code> </li>
<li>要获取包装数据类型就使用 <code>valueOf</code></li>
</ul>
<p>看返回类型就知道了, 滥用会导致一些性能问题, 毕竟拆装箱多了一步操作。</p>
<h1 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h1><p>我们先看 <code>valueOf</code> 的源码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.Long</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Long</span> <span class="keyword">extends</span> <span class="title class_">Number</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;Long&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">valueOf</span><span class="params">(String s)</span> <span class="keyword">throws</span> NumberFormatException &#123;</span><br><span class="line">        <span class="comment">// 调用 parseLong 方法解析字符串</span></span><br><span class="line">        <span class="keyword">return</span> Long.valueOf(parseLong(s, <span class="number">10</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Long <span class="title function_">valueOf</span><span class="params">(<span class="type">long</span> l)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">offset</span> <span class="operator">=</span> <span class="number">128</span>;</span><br><span class="line">        <span class="keyword">if</span> (l &gt;= -<span class="number">128</span> &amp;&amp; l &lt;= <span class="number">127</span>) &#123; <span class="comment">// 从缓存中获取</span></span><br><span class="line">            <span class="keyword">return</span> LongCache.cache[(<span class="type">int</span>)l + offset];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Long</span>(l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显 <code>valueOf</code> 是调用了 <code>parseLong</code> 方法的。<br>所以这个解析字符串的实现是交由 <code>parseLong</code> 完成的。<br>然后再从 <code>缓存</code> 中获取, 缓存中没有这个值的话, 再去 <code>new</code> 一个。</p>
<p>再看 <code>parseLong</code> 方法。<br>在此之前, 先复习下进制转换的算法。<br><img data-src="https://latex.codecogs.com/svg.latex?abc_%7B16%7D=10*16%5E2+11*16%5E1+12*16%5E0=2748" alt="abc_16=10*16^2+11*16^1+12*16^0=2748"><br>下面的算法公式为<br><img data-src="https://latex.codecogs.com/svg.latex?abc_%7B16%7D=-(((-10*16)-11)*16-12)=2748" alt="abc_16=-(((-10*16)-11)*16-12)=2748"><br>这项算法是<a href="https://zh.wikipedia.org/zh-hans/%E7%A7%A6%E4%B9%9D%E9%9F%B6%E7%AE%97%E6%B3%95">秦九韶公式</a><br>简单的说, 就是降低了多项式的计算复杂度(叹服古人的智慧, 居然应用到计算机领域)</p>
<p>为了避免溢出, 是基于 <code>负数</code> 进行运算的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.Long</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Long</span> <span class="keyword">extends</span> <span class="title class_">Number</span> <span class="keyword">implements</span> <span class="title class_">Comparable</span>&lt;Long&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">parseLong</span><span class="params">(String s, <span class="type">int</span> radix)</span> <span class="keyword">throws</span> NumberFormatException &#123;</span><br><span class="line">        <span class="comment">// 省略抛出异常的代码</span></span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">result</span> <span class="operator">=</span> <span class="number">0</span>; <span class="comment">// 结果值</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">negative</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// 是否为负数</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, len = s.length(); <span class="comment">// i 为字符串下标, len为字符串长度</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">limit</span> <span class="operator">=</span> -Long.MAX_VALUE; <span class="comment">// </span></span><br><span class="line">        <span class="type">long</span> multmin; <span class="comment">// </span></span><br><span class="line">        <span class="type">int</span> digit; <span class="comment">// 进制</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取第一个字符</span></span><br><span class="line">        <span class="type">char</span> <span class="variable">firstChar</span> <span class="operator">=</span> s.charAt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> (firstChar &lt; <span class="string">&#x27;0&#x27;</span>) &#123; <span class="comment">// 非数字和字母</span></span><br><span class="line">            <span class="keyword">if</span> (firstChar == <span class="string">&#x27;-&#x27;</span>) &#123; <span class="comment">// 判断是否为负号</span></span><br><span class="line">                negative = <span class="literal">true</span>; <span class="comment">// 标记为负数</span></span><br><span class="line">                limit = Long.MIN_VALUE;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstChar != <span class="string">&#x27;+&#x27;</span>)&#123;</span><br><span class="line">                <span class="comment">// 不是数字, 不是字母, 不是负号, 不是正号, 那肯定不是数字</span></span><br><span class="line">                <span class="keyword">throw</span> NumberFormatException.forInputString(s);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (len == <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="comment">// 字符串长度为1, 则只有一个符号, 不能解析</span></span><br><span class="line">                <span class="keyword">throw</span> NumberFormatException.forInputString(s);</span><br><span class="line">            &#125;</span><br><span class="line">            i++; <span class="comment">// 下标移到下一个字符</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        multmin = limit / radix; <span class="comment">// 设定不同进制下的极限值</span></span><br><span class="line">        <span class="keyword">while</span> (i &lt; len) &#123;</span><br><span class="line">            <span class="comment">// Accumulating negatively avoids surprises near MAX_VALUE</span></span><br><span class="line">            <span class="comment">// 负数运算避免大于MAX_VALUE发生溢出</span></span><br><span class="line">            digit = Character.digit(s.charAt(i++),radix); <span class="comment">// 获取radix进制下的值, 5=&gt;5, A=&gt;10</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// 秦九韶公式的核心算法</span></span><br><span class="line">            result *= radix;</span><br><span class="line">            result -= digit;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 最后把负数转为正数(或者负数转为正数)</span></span><br><span class="line">        <span class="keyword">return</span> negative ? result : -result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
        <tag>源码分析</tag>
      </tags>
  </entry>
  <entry>
    <title>阿里巴巴Java开发手册学习笔记</title>
    <url>/posts/Alibaba_Java_Development_Handbook.html</url>
    <content><![CDATA[<h1 id="下载地址"><a href="#下载地址" class="headerlink" title="下载地址"></a>下载地址</h1><p><a href="https://yq.aliyun.com/articles/69327">【Java编码规范】《阿里巴巴Java开发手册（正式版）》更新（v1.2.0版）——迄今最完善版本</a></p>
<span id="more"></span>

<h1 id="编程规约"><a href="#编程规约" class="headerlink" title="编程规约"></a>编程规约</h1><h2 id="命名风格"><a href="#命名风格" class="headerlink" title="命名风格"></a>命名风格</h2><ol>
<li><p>【强制】类名使用UpperCamelCase风格，类名使用 UpperCamelCase 风格，必须遵从驼峰形式。但以下情形例外。<br>但以下情形例外： <code>DO</code> /  <code>BO</code>  / <code>DTO</code> /  <code>VO</code> /  <code>AO</code><br>正例： MarcoPolo /  UserDO /  XmlService /  TcpUdpDeal /  TaPromotion<br>反例： macroPolo /  UserDo /  XMLService /  TCPUDPDeal /  TAPromotion</p>
</li>
<li><p>【强制】常量命名全部大写，单词间用下划线隔开，力求语义表达完整清楚，不要嫌名字长。<br>正例：  <code>MAX_STOCK_COUNT</code><br>反例：  <code>MAX_COUNT</code></p>
</li>
<li><p>【强制】抽象类命名使用 <code>Abstract</code> 或 <code>Base</code> 开头 ； 异常类命名使用 <code>Exception</code> 结尾 ； 测试类命名以它要测试的类的名称开始，以 <code>Test</code> 结尾。</p>
</li>
<li><p>【强制】 POJO 类中布尔类型的变量，都不要加 <code>is</code> ，否则部分框架解析会引起序列化错误。<br>反例：定义为基本数据类型 <code>Boolean isDeleted;</code> 的属性，它的方法也是 <code>isDeleted()</code> ，<br>RPC框架在反向解析的时候，“以为”对应的属性名称是 deleted ，导致属性获取不到，进而抛出异常。</p>
</li>
<li><p>【强制】包名统一使用小写，点分隔符之间有且仅有<code>一个</code>自然语义的英语单词。包名统一使用单数形式，但是类名如果有复数含义，类名可以使用复数形式。<br>正例： 应用工具类包名为 <code>com.alibaba.open.util</code> 、类名为 <code>MessageUtils</code>（ 此规则参考spring 的框架结构 ）</p>
</li>
<li><p>【参考】各层命名规约：</p>
<ul>
<li> 获取<code>单个</code>对象的方法用 <code>get</code> 做前缀。</li>
<li> 获取<code>多个</code>对象的方法用 <code>list</code> 做前缀。</li>
<li> 获取<code>统计值</code>的方法用 <code>count</code> 做前缀。</li>
<li> <code>插入</code>的方法用 <code>save</code>（ 推荐 ） 或 <code>insert</code> 做前缀。</li>
<li> <code>删除</code>的方法用 <code>remove</code>（ 推荐 ） 或 <code>delete</code> 做前缀。</li>
<li><code>修改</code>的方法用 <code>update</code> 做前缀。</li>
</ul>
</li>
<li><p>【参考】领域模型命名规约:</p>
<ul>
<li> 数据对象： xxxDO ， xxx 即为数据表名。</li>
<li> 数据传输对象： xxxDTO ， xxx 为业务领域相关的名称。</li>
<li> 展示对象： xxxVO ， xxx 一般为网页名称。</li>
<li> POJO 是 DO / DTO / BO / VO 的统称，禁止命名成 xxxPOJO 。</li>
</ul>
</li>
</ol>
<h2 id="常量定义"><a href="#常量定义" class="headerlink" title="常量定义"></a>常量定义</h2><ol>
<li><p>【强制】不允许任何魔法值 （ 即未经定义的常量 ） 直接出现在代码中。<br>反例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">key</span>  <span class="operator">=</span> <span class="string">&quot; Id # taobao_&quot;</span> +  tradeId;</span><br><span class="line">cache.put(key ,  value);</span><br></pre></td></tr></table></figure></li>
<li><p>【推荐】不要使用一个常量类维护所有常量，应该按常量功能进行归类，分开维护。<br>如：缓存相关的常量放在类： <code>CacheConsts</code> 下 ； 系统配置相关的常量放在类： <code>ConfigConsts</code> 下。<br>说明：大而全的常量类，非得使用查找功能才能定位到修改的常量，不利于理解和维护。</p>
<blockquote>
<p>一方库：本工程中的各模块的相互依赖<br>二方库：公司内部的依赖库，一般指公司内部的其他项目发布的jar包<br>三方库：公司之外的开源库， 比如apache、ibm、google等发布的依赖</p>
</blockquote>
</li>
</ol>
<h2 id="代码格式"><a href="#代码格式" class="headerlink" title="代码格式"></a>代码格式</h2><ol>
<li><p>【强制】单行字符数限制不超过 <code>120</code> 个，超出需要换行，换行时遵循如下原则：</p>
<ul>
<li> 第二行相对第一行缩进 <code>4 个空格</code>，从第三行开始，不再继续缩进。</li>
<li> 运算符与下文一起换行。</li>
<li> 方法调用的<code>点</code>符号与下文一起换行。</li>
<li> 在多个参数超长，在<code>逗号</code>后换行。</li>
<li>在括号前不要换行。</li>
</ul>
</li>
<li><p>【强制】 IDE 的 <code>text file encoding</code> 设置为 <code>UTF-8</code>; IDE 中文件的<code>换行符</code>使用 <code>Unix </code>格式，不要使用 windows 格式。</p>
</li>
<li><p>【推荐】没有必要增加若干空格来使某一行的字符与上一行对应位置的字符对齐。</p>
</li>
</ol>
<h2 id="OOP规约"><a href="#OOP规约" class="headerlink" title="OOP规约"></a>OOP规约</h2><ol>
<li><p>关于基本数据类型与包装数据类型的使用标准如下：</p>
<ul>
<li> 【强制】所有的 <code>POJO</code> 类属性必须使用包装数据类型。</li>
<li> 【强制】 <code>RPC</code> 方法的返回值和参数必须使用包装数据类型。</li>
<li>【推荐】所有的<code>局部变量</code>使用基本数据类型。<br>说明： POJO 类属性没有初值是提醒使用者在需要使用时，必须自己显式地进行赋值，任何<code>NPE</code> 问题，或者入库检查，都由使用者来保证。<br>正例：数据库的查询结果可能是 <code>null</code> ，因为自动拆箱，用基本数据类型接收有 <code>NPE</code> 风险。<br>反例：比如显示成交总额涨跌情况，即正负 <code>x %</code>， <code>x</code> 为基本数据类型，调用的 <code>RPC</code> 服务，<br>调用不成功时，返回的是默认值，页面显示：<code>0%</code>，这是不合理的，应该显示成中划线-。<br>所以包装数据类型的 <code>null</code> 值，能够表示额外的信息，如：远程调用失败，异常退出。</li>
</ul>
</li>
<li><p>【强制】定义 <code>DO / DTO / VO</code> 等 POJO 类时，不要设定任何属性默认值。<br>反例： POJO 类的 <code>gmtCreate</code> 默认值为 <code>new Date();</code><br> 但是这个属性在数据提取时并没有置入具体值，在更新其它字段时又附带更新了此字段，导致创建时间被修改成当前时间。</p>
</li>
<li><p>【强制】构造方法里面禁止加入任何业务逻辑，如果有初始化逻辑，请放在 <code>init</code> 方法中。</p>
</li>
<li><p>【推荐】 类内方法定义顺序依次是：<code>公有方法或保护方法</code> &gt; <code>私有方法</code> &gt;  <code>getter / setter方法</code>。<br>说明：公有方法是类的调用者和维护者最关心的方法，首屏展示最好 ； 保护方法虽然只是子类关心，也可能是“模板设计模式”下的核心方法 ；<br> 而私有方法外部一般不需要特别关心，是一个黑盒实现 ；<br> 因为方法信息价值较低，所有 Service 和 DAO 的 getter / setter 方法放在类体最后。</p>
</li>
</ol>
<h2 id="集合处理"><a href="#集合处理" class="headerlink" title="集合处理"></a>集合处理</h2><ol>
<li><p>【强制】泛型通配符<code>&lt;?  extends T &gt;</code>来接收返回的数据，此写法的泛型集合不能使用 <code>add</code> 方法，<br>而 <code>&lt;? super T&gt;</code> 不能使用 <code>get</code> 方法，做为接口调用赋值时易出错。<br>说明：扩展说一下 <code>PECS(Producer Extends Consumer Super) </code><br>原则：1）频繁往外读取内容的，适合用上界 <code>Extends</code> 。2）经常往里插入的，适合用下界 <code>Super</code> 。</p>
</li>
<li><p>【推荐】集合初始化时，指定集合初始值大小。<br>正例： <code>initialCapacity = (需要存储的元素个数 / 负载因子) + 1</code>。<br>注意负载因子（即loaderfactor）默认为 <code>0.75</code>， 如果暂时无法确定初始值大小，请设置为 <code>16</code>。</p>
</li>
</ol>
<h2 id="并行处理"><a href="#并行处理" class="headerlink" title="并行处理"></a>并行处理</h2><ol>
<li><p>【强制】线程池不允许使用 <code>Executors</code> 去创建，而是通过 <code>ThreadPoolExecutor</code> 的方式，这样的处理方式让写的同学更加明确线程池的运行规则，规避资源耗尽的风险。<br>说明： Executors 返回的线程池对象的弊端如下：</p>
<ul>
<li> <code>FixedThreadPool</code> 和 <code>SingleThreadPool</code> :允许的<code>请求队列</code>长度为 <code>Integer.MAX_VALUE</code> ，可能会堆积大量的请求，从而导致 OOM 。</li>
<li><code>CachedThreadPool</code> 和 <code>ScheduledThreadPool</code> :允许的<code>创建线程</code>数量为 <code>Integer.MAX_VALUE</code> ，可能会创建大量的线程，从而导致 OOM 。</li>
</ul>
</li>
<li><p>【强制】 <code>SimpleDateFormat</code> 是线程不安全的类，一般不要定义为 <code>static</code> 变量，如果定义为<code>static</code> ，必须<code>加锁</code>，或者使用 <code>DateUtils</code> 工具类。<br>正例：注意线程安全，使用 <code>DateUtils</code> 。<br>亦推荐如下处理：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;DateFormat&gt; df = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;DateFormat&gt;() &#123;</span><br><span class="line">    @ Override</span><br><span class="line">    <span class="keyword">protected</span> DateFormat <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>说明：如果是 JDK 8 的应用，可以使用 <code>Instant</code> 代替 <code>Date</code> ， <code>LocalDateTime</code> 代替 <code>Calendar</code> ，<br><code>DateTimeFormatter</code> 代替 <code>Simpledateformatter</code> ，官方给出的解释： simple beautiful strong immutable thread-safe 。</p>
</li>
<li><p>【强制】多线程并行处理定时任务时， <code>Timer</code> 运行多个 <code>TimeTask</code> 时，<br>只要其中之一没有捕获抛出的异常，其它任务便会自动终止运行，<br>使用 <code>ScheduledExecutorService</code> 则没有这个问题。</p>
</li>
</ol>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ol>
<li>【强制】后台输送给页面的变量必须加 <code>$!&#123;var&#125;</code> ——中间的感叹号。<br>说明：如果 <code>var = null</code> 或者<code>不存在</code>，那么 <code>$&#123;var&#125;</code> 会直接显示在页面上。</li>
</ol>
<h1 id="异常日志"><a href="#异常日志" class="headerlink" title="异常日志"></a>异常日志</h1><h2 id="日志规约"><a href="#日志规约" class="headerlink" title="日志规约"></a>日志规约</h2><ol>
<li><p>【强制】日志文件推荐至少保存 15 天，因为有些异常具备以“周”为频次发生的特点。</p>
</li>
<li><p>【强制】避免重复打印日志，浪费磁盘空间，务必在 <code>log4j.xml</code> 中设置 <code>additivity = false</code> 。<br>正例： <code>&lt;logger name=&quot;com.taobao.dubbo.config&quot; additivity=&quot;false&quot;&gt; </code></p>
</li>
</ol>
<h1 id="MySQL数据库"><a href="#MySQL数据库" class="headerlink" title="MySQL数据库"></a>MySQL数据库</h1><h2 id="建表规约"><a href="#建表规约" class="headerlink" title="建表规约"></a>建表规约</h2><ol>
<li><p>【强制】表达是与否概念的字段，必须使用 <code>is_xxx</code> 的方式命名，数据类型是 <code>unsigned tinyint</code>（ 1 表示是，0 表示否 ） 。</p>
</li>
<li><p>【强制】主键索引名为 <code>pk_字段名</code>；唯一索引名为 <code>uk_字段名</code> ； 普通索引名则为 <code>idx_字段名</code>。</p>
</li>
<li><p>【强制】小数类型为 <code>decimal</code> ，禁止使用 <code>float</code> 和 <code>double</code> 。<br>说明： <code>float</code> 和 <code>double</code> 在存储的时候，存在精度损失的问题，很可能在值的比较时，得到不正确的结果。<br>如果存储的数据范围超过 <code>decimal</code> 的范围，建议将数据拆成整数和小数分开存储。</p>
</li>
<li><p>【强制】表必备三字段： <code>id</code> ,  <code>gmt_create</code> ,  <code>gmt_modified</code>。<br>说明：其中 <code>id</code> 必为主键，类型为 <code>unsigned bigint</code> 、单表时自增、步长为 <code>1</code>。 <code>gmt_create</code> ,<code>gmt_modified</code> 的类型均为 <code>date_time</code> 类型。</p>
</li>
</ol>
<h2 id="索引规约"><a href="#索引规约" class="headerlink" title="索引规约"></a>索引规约</h2><ol>
<li><p>【强制】 超过三个表禁止 <code>join</code> 。需要 <code>join</code> 的字段，数据类型必须绝对一致 ；<br>多表关联查询时，保证被关联的字段需要有索引。<br>说明：即使双表 join 也要注意表索引、 SQL 性能。</p>
</li>
<li><p>【强制】在 varchar 字段上建立索引时，必须指定索引长度，没必要对全字段建立索引，根据实际文本区分度决定索引长度即可。<br>说明：索引的长度与区分度是一对矛盾体，一般对字符串类型数据，长度为 20 的索引，<br>区分度会高达 90%以上，可以使用 <code>count(distinct left( 列名, 索引长度 )) / count( * )</code> 的区分度来确定。</p>
</li>
<li><p>【强制】页面搜索严禁左模糊或者全模糊，如果需要请走搜索引擎来解决。<br>说明：索引文件具有 B-Tree 的最左前缀匹配特性，如果左边的值未确定，那么无法使用此索引。</p>
</li>
<li><p>【推荐】利用延迟关联或者子查询优化超多分页场景。<br>说明： MySQL 并不是跳过 offset 行，而是取 offset + N 行，然后返回放弃前 offset 行，返回N 行，<br>那当 offset 特别大的时候，效率就非常的低下，要么控制返回的总页数，要么对超过特定阈值的页数进行 SQL 改写。<br>正例：先快速定位需要获取的 id 段，然后再关联：<br><code>SELECT a.* FROM 表 1 a, (select id from 表 1 where 条件 LIMIT 100000,20 ) b where a.id=b.id</code></p>
</li>
<li><p>【推荐】建组合索引的时候，区分度最高的在最左边。<br>正例：如果 <code>where a =?  and b =?</code> ， a 列的几乎接近于唯一值，那么只需要单建 <code>idx_a</code> 索引即可。<br>说明：存在非等号和等号混合判断条件时，在建索引时，请把等号条件的列前置。如： <code>where a &gt;? and b =?</code><br>那么即使 a 的区分度更高，也必须把 b 放在索引的最前列。</p>
</li>
</ol>
<h2 id="SQL语句"><a href="#SQL语句" class="headerlink" title="SQL语句"></a>SQL语句</h2><ol>
<li><p>【强制】不要使用 <code>count(列名)</code> 或 <code>count(常量)</code> 来替代 <code>count(*)</code> ， <code>count(*)</code> 是SQL92定义的标准统计行数的语法，跟数据库无关，跟 NULL 和非 NULL 无关。<br>说明： <code>count(*)</code> 会统计值为 NULL 的行，而 <code>count(列名)</code> 不会统计此列为 NULL 值的行。</p>
</li>
<li><p>【强制】当某一列的值全是 <code>NULL</code> 时， <code>count(col)</code> 的返回结果为 <code>0</code>，但 <code>sum(col)</code> 的返回结果为NULL ，因此使用 sum() 时需注意 NPE 问题。<br>正例：可以使用如下方式来避免 sum 的 NPE 问题： <code>SELECT IF(ISNULL(SUM(g)) ,0, SUM(g)) FROM table;</code></p>
</li>
<li><p>【强制】不得使用外键与级联，一切外键概念必须在应用层解决。<br>说明： （ 概念解释 ） 学生表中的 student_id 是主键，那么成绩表中的 student_id 则为外键。<br>如果更新学生表中的 student_id ，同时触发成绩表中的 student_id 更新，则为级联更新。<br>外键与级联更新适用于单机低并发，不适合分布式、高并发集群 ； 级联更新是强阻塞，存在数据库更新风暴的风险；<br>外键影响数据库的插入速度。</p>
</li>
<li><p>【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</p>
</li>
<li><p>【强制】数据订正时，删除和修改记录时，要先 select ，避免出现误删除，确认无误才能执行更新语句。</p>
</li>
</ol>
]]></content>
      <categories>
        <category>Java SE</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
      </tags>
  </entry>
  <entry>
    <title>ApplicationContext的事件机制</title>
    <url>/posts/The_event_mechanism_of_ApplicationContext.html</url>
    <content><![CDATA[<h1 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h1><p>完成事件机制首先需要一个事件源和事件监听器<br><code>ApplicationEvent</code>事件和<code>ApplicationListener</code>监听器</p>
<span id="more"></span>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SayEvent</span> <span class="keyword">extends</span> <span class="title class_">ApplicationEvent</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">say</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getSource()+<span class="string">&quot; : hello world&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SayListener</span> <span class="keyword">implements</span> <span class="title class_">ApplicationListener</span>&lt;SayEvent&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onApplicationEvent</span><span class="params">(SayEvent sayEvent)</span> &#123;</span><br><span class="line">        sayEvent.say();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且要在<code>xml</code>文件中配置好<code>ApplicationListener</code>监听器</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.SayListener&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过<code>ApplicationContext</code>发布事件</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testEvent</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-bean.xml&quot;</span>);</span><br><span class="line">    <span class="type">SayEvent</span> <span class="variable">event</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SayEvent</span>(<span class="string">&quot;由testEvent()发出&quot;</span>);</span><br><span class="line">    ac.publishEvent(event);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Spring</code>的事件监听机制是<strong>观察者模式</strong>的实现。<br>监听器可以监听任何事件。<br>输出结果：<code>由testEvent()发出 : hello world</code></p>
<h1 id="内置事件"><a href="#内置事件" class="headerlink" title="内置事件"></a>内置事件</h1><p>Spring提供如下几个内置事件：</p>
<ol>
<li><p><code>ContextRefreshedEvent</code>：<code>ApplicationContext</code>容器初始化或刷新时触发该事件。此处的初始化是指：所有的<code>Bean</code>被成功装载，后处理<code>Bean</code>被检测并激活，所有<code>Singleton Bean</code> 被预实例化，<code>ApplicationContext</code>容器已就绪可用</p>
</li>
<li><p><code>ContextStartedEvent</code>：当使用<code>ConfigurableApplicationContext</code>(<code>ApplicationContext</code>的子接口）接口的<code>start()</code>方法启动<code>ApplicationContext</code>容器时触发该事件。容器管理声明周期的<code>Bean</code>实例将获得一个指定的启动信号，这在经常需要停止后重新启动的场合比较常见</p>
</li>
<li><p><code>ContextClosedEvent</code>：当使用<code>ConfigurableApplicationContext</code>接口的<code>close()</code>方法关闭<code>ApplicationContext</code>时触发该事件</p>
</li>
<li><p><code>ContextStoppedEvent</code>：当使用<code>ConfigurableApplicationContext</code>接口的<code>stop()</code>方法使<code>ApplicationContext</code>容器停止时触发该事件。此处的停止，意味着容器管理生命周期的<code>Bean</code>实例将获得一个指定的停止信号，被停止的<code>Spring</code>容器可再次调用<code>start()</code>方法重新启动</p>
</li>
<li><p><code>RequestHandledEvent</code>：<code>Web</code>相关事件，只能应用于使用<code>DispatcherServlet</code>的<code>Web</code>应用。在使用<code>Spring</code>作为前端的<code>MVC</code>控制器时，当<code>Spring</code>处理用户请求结束后，系统会自动触发该事件。</p>
</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://my.oschina.net/itblog/blog/203744">Spring中ApplicationContext的事件机制</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Environment详解</title>
    <url>/posts/Environment_of_Spring_MVC.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>HttpServletBean</code> 实现了 <code>EnvironmentCapable</code> 和 <code>EnvironmentAware</code> 接口。<br>Environment可以对一些应用变量进行初始化, 存储到内存中。方便 <code>Bean</code> 进行获取。</p>
<span id="more"></span>

<h1 id="Environment-初始化"><a href="#Environment-初始化" class="headerlink" title="Environment 初始化"></a>Environment 初始化</h1><p>查看 <code>DispatcherServlet</code> 的父类 <code>HttpServletBean</code> 的源码, 可以看到 <code>HttpServletBean</code> 的属性 <code>ConfigurableEnvironment</code> 接口的实现类是 <code>StandardServletEnvironment</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.HttpServletBean</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpServletBean</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentCapable</span>, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment environment;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.environment = (ConfigurableEnvironment) environment;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ConfigurableEnvironment <span class="title function_">getEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.environment == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.environment = createEnvironment();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.environment;</span><br><span class="line">    &#125;   </span><br><span class="line">    <span class="keyword">protected</span> ConfigurableEnvironment <span class="title function_">createEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 默认实现类是 StandardServletEnvironment</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StandardServletEnvironment</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>继承树</strong><br><img data-src="https://yuml.me/diagram/nofunky/class/[StandardEnvironment]^-[StandardServletEnvironment],[AbstractEnvironment]^-[StandardEnvironment],[%3C%3CConfigurableWebEnvironment%3E%3E;interface]^-[StandardServletEnvironment],[%3C%3CConfigurableEnvironment%3E%3E;interface]^-[%3C%3CConfigurableWebEnvironment%3E%3E;interface],[%3C%3CConfigurableEnvironment%3E%3E;interface]^-[AbstractEnvironment]" alt="Environment 继承树"></p>
<p>先明确一个概念, Environment 是用来装载 <code>属性</code> 的。<br> <code>StandardServletEnvironment</code> 的父类 <code>AbstractEnvironment</code><br> 里面的 <code>MutablePropertySources</code> 属性（可以看成 <code>LinkedHashMap&lt;String, String&gt;</code>）封装了 5 个属性(稍后说明为什么)</p>
<ul>
<li>ServletContext ( 封装 context-param )</li>
<li>ServletConfig ( 封装 init-param )</li>
<li>JndiProperty</li>
<li>系统环境变量</li>
<li>JVM 系统属性变量</li>
</ul>
<p>那么观察下子类 <code>StandardServletEnvironment</code> 的源码，以及父类<code>StandardEnvironment</code> 的源码, 发现主要的方法就是 <code>customizePropertySources() </code> , 也就是对 <code>MutablePropertySources</code> 属性进行操作</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.context.support.StandardServletEnvironment</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardServletEnvironment</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">StandardEnvironment</span> <span class="keyword">implements</span> <span class="title class_">ConfigurableWebEnvironment</span> &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizePropertySources</span><span class="params">(MutablePropertySources propertySources)</span> &#123;</span><br><span class="line">        <span class="comment">// propertySources 可以看成 LinkedHashMap</span></span><br><span class="line">        <span class="comment">// 装载 ServletConfig 的占位符, 延迟载入</span></span><br><span class="line">        propertySources.addLast(<span class="keyword">new</span> <span class="title class_">StubPropertySource</span>(<span class="string">&quot;servletConfigInitParams&quot;</span>));</span><br><span class="line">        <span class="comment">// 装载 ServletContext 的占位符, 延迟载入</span></span><br><span class="line">        propertySources.addLast(<span class="keyword">new</span> <span class="title class_">StubPropertySource</span>(<span class="string">&quot;servletContextInitParams&quot;</span>));</span><br><span class="line">        <span class="comment">// 装载 JndiProperties</span></span><br><span class="line">        <span class="keyword">if</span> (JndiLocatorDelegate.isDefaultJndiEnvironmentAvailable()) &#123;</span><br><span class="line">            propertySources.addLast(<span class="keyword">new</span> <span class="title class_">JndiPropertySource</span>(<span class="string">&quot;jndiProperties&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 父类StandardEnvironment 负责装载 系统环境变量 和 JVM 系统属性变量</span></span><br><span class="line">        <span class="built_in">super</span>.customizePropertySources(propertySources);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initPropertySources</span><span class="params">(ServletContext servletContext, ServletConfig servletConfig)</span> &#123;</span><br><span class="line">        <span class="comment">// FrameworkServlet 在刷新时调用, 延迟载入</span></span><br><span class="line">        <span class="comment">// 将ServletContext和ServletConfig注入PropertySources中</span></span><br><span class="line">        WebApplicationContextUtils.initServletPropertySources(getPropertySources(), servletContext, servletConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.core.env.StandardEnvironment</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardEnvironment</span> <span class="keyword">extends</span> <span class="title class_">AbstractEnvironment</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizePropertySources</span><span class="params">(MutablePropertySources propertySources)</span> &#123;</span><br><span class="line">        <span class="comment">// 装载 系统环境变量</span></span><br><span class="line">        propertySources.addLast(<span class="keyword">new</span> <span class="title class_">MapPropertySource</span>(<span class="string">&quot;systemEnvironment&quot;</span>, getSystemProperties()));</span><br><span class="line">        <span class="comment">// 装载 JVM 系统属性变量</span></span><br><span class="line">        propertySources.addLast(<span class="keyword">new</span> <span class="title class_">SystemEnvironmentPropertySource</span>(<span class="string">&quot;systemProperties&quot;</span>, getSystemEnvironment()));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getSystemProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Map) System.getProperties();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Map) <span class="keyword">new</span> <span class="title class_">ReadOnlySystemAttributesMap</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> String <span class="title function_">getSystemAttribute</span><span class="params">(String attributeName)</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> System.getProperty(attributeName);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title function_">getSystemEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (suppressGetenvAccess()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Collections.emptyMap();</span><br><span class="line">        &#125; <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Map) System.getenv();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> (Map) <span class="keyword">new</span> <span class="title class_">ReadOnlySystemAttributesMap</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> String <span class="title function_">getSystemAttribute</span><span class="params">(String attributeName)</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> System.getenv(attributeName);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (AccessControlException ex) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以猜测出方法的参数 <code>propertySources</code> 是一个装载 <code>属性</code> 的集合。那么 <code>customizePropertySources</code> 的参数 <code>propertySources</code> 一定不为 <code>null</code> , 也就是 <code>propertySources</code> 被初始化过。<br>初始化一般发生在 <code>构造方法</code> 或者 <code>field 直接 new</code> 中。<br>但是 <code>StandardServletEnvironment</code> 并没有构造方法, 其父类<br> <code>StandardEnvironment</code> 也没有构造方法。<br>那么只能看最顶层的父类 <code>AbstractEnvironment</code> 。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.core.env.AbstractEnvironment</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractEnvironment</span> <span class="keyword">implements</span> <span class="title class_">ConfigurableEnvironment</span> &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">MutablePropertySources</span> <span class="variable">propertySources</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePropertySources</span>(<span class="built_in">this</span>.logger);</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AbstractEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">        customizePropertySources(<span class="built_in">this</span>.propertySources);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">customizePropertySources</span><span class="params">(MutablePropertySources propertySources)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>又看到了熟悉的 <code>customizePropertySources()</code> 方法。<br>可以看到 <code>propertySources</code> 是在 field 直接 <code>new</code> 出来的。<br> <code>propertySources</code> 的实现类是 <code>MutablePropertySources</code> , 里面有一个<br> <code>CopyOnWriteArrayList</code> 集合，集合中的 <code>PropertySource</code> 是一个  <code>键值对</code> , 可以看成是 <code>Map.Entry</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.core.env.MutablePropertySources</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MutablePropertySources</span> <span class="keyword">implements</span> <span class="title class_">PropertySources</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;PropertySource&lt;?&gt;&gt; propertySourceList = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;PropertySource&lt;?&gt;&gt;();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.core.env.PropertySources</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PropertySources</span> <span class="keyword">extends</span> <span class="title class_">Iterable</span>&lt;PropertySource&lt;?&gt;&gt; &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(String name)</span>;</span><br><span class="line">    PropertySource&lt;?&gt; get(String name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.core.env.PropertySource</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">PropertySource</span>&lt;T&gt; &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 以 键值对 形式存储</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> String name;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> T source;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 省略 构造器 和 getter 和 setter 方法</span></span><br><span class="line">    <span class="comment">// hashcode 和 equals 只判断 name 属性</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">containsProperty</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (getProperty(name) != <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 交给内部类子类 StubPropertySource 和 ComparisonPropertySource 实现</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> Object <span class="title function_">getProperty</span><span class="params">(String name)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类似占位符, 在实际的属性不能被及时初始化时保留，并在 Context 刷新时进行替换</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">StubPropertySource</span> <span class="keyword">extends</span> <span class="title class_">PropertySource</span>&lt;Object&gt; &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">StubPropertySource</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(name, <span class="keyword">new</span> <span class="title class_">Object</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getProperty</span><span class="params">(String name)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 类似占位符, 在实际的属性不能被及时初始化时保留，并在 Context 刷新时进行替换</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ComparisonPropertySource</span> <span class="keyword">extends</span> <span class="title class_">StubPropertySource</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> PropertySource&lt;?&gt; named(String name) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ComparisonPropertySource</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结说, 就是 <code>AbstractEnvironment</code> 类的 <code>MutablePropertySources</code> 中的<br> <code>CopyOnWriteArrayList</code> 集合中, 装载了 5 个属性</p>
<ul>
<li>ServletContext ( StandardServletEnvironment 装载, 封装 context-param )</li>
<li>ServletConfig ( StandardServletEnvironment 装载, 封装 init-param )</li>
<li>JndiProperty ( StandardServletEnvironment 装载 )</li>
<li>系统环境变量 ( StandardEnvironment 装载 )</li>
<li>JVM 系统属性变量 ( StandardEnvironment 装载 )、</li>
</ul>
<p>需要注意的是，这里 <code>ServletContext</code> 和 <code>ServletConfig </code> 要等到<br> <code>FrameworkServlet</code> 刷新的时候调用 <code>StandardServletEnvironment</code> 的 <code>initPropertySources</code> 方法, 来刷新这两个属性。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.context.support.StandardServletEnvironment</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StandardServletEnvironment</span></span><br><span class="line">        <span class="keyword">extends</span> <span class="title class_">StandardEnvironment</span> <span class="keyword">implements</span> <span class="title class_">ConfigurableWebEnvironment</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initPropertySources</span><span class="params">(ServletContext servletContext, ServletConfig servletConfig)</span> &#123;</span><br><span class="line">        <span class="comment">// FrameworkServlet 在刷新时调用</span></span><br><span class="line">        <span class="comment">// 将ServletContext和ServletConfig注入PropertySources中</span></span><br><span class="line">        WebApplicationContextUtils.initServletPropertySources(getPropertySources(), servletContext, servletConfig);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.web.context.support.WebApplicationContextUtils</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">WebApplicationContextUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initServletPropertySources</span><span class="params">(</span></span><br><span class="line"><span class="params">        MutablePropertySources propertySources, ServletContext servletContext, ServletConfig servletConfig)</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        propertySources.replace(<span class="string">&quot;servletContextInitParams&quot;</span>,</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">ServletContextPropertySource</span>(<span class="string">&quot;servletContextInitParams&quot;</span>, servletContext));</span><br><span class="line">        propertySources.replace(<span class="string">&quot;servletConfigInitParams&quot;</span>,</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">ServletConfigPropertySource</span>(<span class="string">&quot;servletConfigInitParams&quot;</span>, servletConfig));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Environment-的使用"><a href="#Environment-的使用" class="headerlink" title="Environment 的使用"></a>Environment 的使用</h1><p><code>Spring</code> 开放了 <code>EnvironmentAware </code> 和 <code>EnvironmentCapable</code>接口。</p>
<ul>
<li><code>EnvironmentAware</code> 由 Spring 框架往 Bean 内 <code>注入Environment</code> </li>
<li><code>EnvironmentCapable</code>  通过 getEnvironment 往外面 <code>暴露Environment</code></li>
</ul>
<p>开发者只需要实现这两个接口，Spring就会自动注入。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- web.xml 省略部分代码 --&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>myConfig<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>hello<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">EnvironmentAware</span>, EnvironmentCapable &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> Environment environment;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getHello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> environment.getProperty(<span class="string">&quot;myConfig&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnvironment</span><span class="params">(Environment environment)</span> &#123;</span><br><span class="line">        <span class="comment">// 注入 Environment </span></span><br><span class="line">        <span class="built_in">this</span>.environment = environment;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Environment <span class="title function_">getEnvironment</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 暴露 Environment </span></span><br><span class="line">        <span class="keyword">return</span> environment;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Hibernate简单使用</title>
    <url>/posts/Hibernate_simple_use.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>使用IDEA+Maven进行搭建Hibernate5</p>
<span id="more"></span>

<h1 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h1><h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><p>在pom.mxl中加入maven项目</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.hibernate<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hibernate-search-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.5.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>6.0.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="创建配置文件"><a href="#创建配置文件" class="headerlink" title="创建配置文件"></a>创建配置文件</h2><p>在<code>/src/main/resources/hibernate.cfg.xml</code>中配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">hibernate-configuration</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;-//Hibernate/Hibernate Configuration DTD//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://www.hibernate.org/dtd/hibernate-configuration-3.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hibernate-configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">session-factory</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--访问数据库的url地址，带参数防止编译错误--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.url&quot;</span>&gt;</span>jdbc:mysql://localhost:3306/test?serverTimezone=GMT&amp;useUnicode=true&amp;characterEncoding=utf8<span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.driver_class&quot;</span>&gt;</span>com.mysql.jdbc.Driver<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--数据库的JDBC驱动--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.username&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--连接数据库的用户名--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;connection.password&quot;</span>&gt;</span>root<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--连接数据库的用户密码--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dialect&quot;</span>&gt;</span>org.hibernate.dialect.MySQLDialect<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--指定使用mysql数据库的方言--&gt;</span></span><br><span class="line">        </span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;show_sql&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--在控制台输出sql语句--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;format_sql&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--在控制台格式化sql语句--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;hbm2ddl.auto&quot;</span>&gt;</span>create<span class="tag">&lt;/<span class="name">property</span>&gt;</span><span class="comment">&lt;!--生成表结构的策略--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">resource</span>=<span class="string">&quot;students.hbm.xml&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mapping</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.Students&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">session-factory</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hibernate-configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="创建实体"><a href="#创建实体" class="headerlink" title="创建实体"></a>创建实体</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//Students.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> sid;</span><br><span class="line">    <span class="keyword">private</span> String sname;</span><br><span class="line">    <span class="comment">//构造器、getter和setter</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--students.hbm.xml--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;utf-8&#x27;?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">hibernate-mapping</span> <span class="keyword">PUBLIC</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;-//Hibernate/Hibernate Mapping DTD 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hibernate-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">class</span> <span class="attr">name</span>=<span class="string">&quot;com.ahao.javaeeDemo.Students&quot;</span> <span class="attr">table</span>=<span class="string">&quot;students&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">name</span>=<span class="string">&quot;sid&quot;</span> <span class="attr">type</span>=<span class="string">&quot;int&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;sid&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">generator</span> <span class="attr">class</span>=<span class="string">&quot;increment&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;java.lang.String&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">column</span> <span class="attr">name</span>=<span class="string">&quot;sname&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">hibernate-mapping</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<h2 id="编写测试代码"><a href="#编写测试代码" class="headerlink" title="编写测试代码"></a>编写测试代码</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ServiceRegistry serviceRegistry;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SessionFactory sessionFactory;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Session session;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Transaction transaction;</span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initClass</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//创建服务注册对象</span></span><br><span class="line">        serviceRegistry = <span class="keyword">new</span> <span class="title class_">StandardServiceRegistryBuilder</span>()</span><br><span class="line">                .configure(<span class="string">&quot;hibernate.cfg.xml&quot;</span>).build();</span><br><span class="line">        <span class="comment">//创建会话工厂对象</span></span><br><span class="line">        sessionFactory = <span class="keyword">new</span> <span class="title class_">MetadataSources</span>(serviceRegistry).buildMetadata().buildSessionFactory();</span><br><span class="line">        <span class="comment">//创建会话对象</span></span><br><span class="line">        session = sessionFactory.openSession();</span><br><span class="line">        <span class="comment">//开启事务</span></span><br><span class="line">        transaction = session.beginTransaction();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Students</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Students</span>();</span><br><span class="line">        s.setSname(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        s.setBirthday(<span class="keyword">new</span> <span class="title class_">java</span>.sql.Date(System.currentTimeMillis()));</span><br><span class="line">        session.save(s);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">destoryClass</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//提交事务</span></span><br><span class="line">        transaction.commit();</span><br><span class="line">        <span class="comment">//关闭会话</span></span><br><span class="line">        session.close();</span><br><span class="line">        <span class="comment">//关闭会话工厂</span></span><br><span class="line">        sessionFactory.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="操作"><a href="#操作" class="headerlink" title="操作"></a>操作</h1><h2 id="增"><a href="#增" class="headerlink" title="增"></a>增</h2><p>使用<code>save()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSave</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Students</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Students</span>();</span><br><span class="line">        s.setSname(<span class="string">&quot;zhangsan&quot;</span>);</span><br><span class="line">        s.setBirthday(<span class="keyword">new</span> <span class="title class_">java</span>.sql.Date(System.currentTimeMillis()));</span><br><span class="line">        session.save(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略销毁代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="改"><a href="#改" class="headerlink" title="改"></a>改</h2><p>使用<code>update()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testUpdate</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sid</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">Students</span> <span class="variable">s</span> <span class="operator">=</span> session.get(Students.class, sid);</span><br><span class="line">        s.setSname(<span class="string">&quot;Cat&quot;</span>);</span><br><span class="line">        session.update(s);</span><br><span class="line"><span class="comment">//        session.saveOrUpdate(s);</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略销毁代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="删"><a href="#删" class="headerlink" title="删"></a>删</h2><p>使用<code>delete()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testDelete</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sid</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">Students</span> <span class="variable">s</span> <span class="operator">=</span> session.get(Students.class, sid);</span><br><span class="line">        session.delete(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//省略销毁代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="查"><a href="#查" class="headerlink" title="查"></a>查</h2><h3 id="查询单个记录"><a href="#查询单个记录" class="headerlink" title="查询单个记录"></a>查询单个记录</h3><p>使用<code>get()</code>或<code>load()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainTest</span> &#123;</span><br><span class="line">    <span class="comment">//省略初始化代码</span></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testRead</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">sid</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">Students</span> <span class="variable">s1</span> <span class="operator">=</span> session.get(Students.class, sid);<span class="comment">//发送sql语句，获取Students对象</span></span><br><span class="line">        System.out.println(s1.toString());<span class="comment">//打印输出</span></span><br><span class="line">        <span class="type">Students</span> <span class="variable">s2</span> <span class="operator">=</span> session.load(Students.class, sid);<span class="comment">//不发送sql语句，获取一个代理对象</span></span><br><span class="line">        System.out.println(s2.toString());<span class="comment">//使用的时候才发送sql语句，获取Students对象</span></span><br><span class="line">    &#125;    <span class="comment">//省略销毁代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Hibernate</tag>
      </tags>
  </entry>
  <entry>
    <title>HttpServlet源码详解</title>
    <url>/posts/HttpServlet_source_code.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Servlet是Servlet+Applet的缩写，表示一个服务器应用。<br>Servlet是一个接口，是javaweb开发的一套规范。</p>
<span id="more"></span>

<h1 id="继承树"><a href="#继承树" class="headerlink" title="继承树"></a>继承树</h1><img data-src="https://yuml.me/diagram/nofunky/class/[<<ServletConfig>>;interface]^-[GenericServlet], [<<Servlet>>;interface]^-[GenericServlet], [GenericServlet]^-[HttpServlet]"/>

<h1 id="GenericServlet详解"><a href="#GenericServlet详解" class="headerlink" title="GenericServlet详解"></a>GenericServlet详解</h1><p>GenericServlet是与具体协议无关的。<br>可以看到<code>GenericServlet</code>是一个抽象类，实现了<code>Servlet</code>和<code>ServletConfig</code>接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GenericServlet</span> </span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Servlet</span>, ServletConfig, java.io.Serializable&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletConfig config;</span><br><span class="line">    <span class="comment">/** 省略部分代码 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Servlet接口在GenericServlet中的实现"><a href="#Servlet接口在GenericServlet中的实现" class="headerlink" title="Servlet接口在GenericServlet中的实现"></a>Servlet接口在GenericServlet中的实现</h2><p>先看<code>Servlet</code>接口，它实现了以下方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Servlet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span>;     <span class="comment">// Web容器调用时，初始化方法，只调用一次</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>;  <span class="comment">// 关闭Web容器时销毁，只调用一次</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span>;    <span class="comment">// 暴露获取ServletConfig对象的方法</span></span><br><span class="line">    <span class="comment">// 容器注入request和response，处理业务</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse res)</span>;  </span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span>; <span class="comment">// 获取Servlet的信息，如作者，版权等。</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据这些方法，在<code>GenericeServlet</code>中找到其实现。<br>主要是对<code>init</code>进行了实现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GenericServlet</span> </span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Servlet</span>, ServletConfig, java.io.Serializable&#123;</span><br><span class="line">    <span class="comment">/** 省略部分代码 */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletConfig config;</span><br><span class="line">    <span class="comment">// 在序列化时，不对transient修饰的field进行序列化。</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="built_in">this</span>.config = config;   <span class="comment">// 获取Web容器注入的ServletConfig对象</span></span><br><span class="line">        <span class="built_in">this</span>.init(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="comment">// 使用模板方法模式，自定义一个无参的init方法，并暴露给子类实现。</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> ServletConfig <span class="title function_">getServletConfig</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> config; <span class="comment">// 暴露获取ServletConfig对象的方法</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletInfo</span><span class="params">()</span> &#123;    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;  &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse res)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="ServletConfig接口在GenericServlet中的实现"><a href="#ServletConfig接口在GenericServlet中的实现" class="headerlink" title="ServletConfig接口在GenericServlet中的实现"></a>ServletConfig接口在GenericServlet中的实现</h2><p>先看<code>ServletConfig</code>接口，它实现了以下方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ServletConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletName</span><span class="params">()</span>; <span class="comment">// 获取Servlet的名字，即web.xml中&lt;servlet-name&gt;的值</span></span><br><span class="line">    <span class="keyword">public</span> ServletContext <span class="title function_">getServletContext</span><span class="params">()</span>;  <span class="comment">// 暴露获取ServletContext对象的方法</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInitParameter</span><span class="params">(String name)</span>;    <span class="comment">// 根据name获取初始化参数，即web.xml中&lt;context-param&gt;的键值对</span></span><br><span class="line">    <span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title function_">getInitParameterNames</span><span class="params">()</span>; <span class="comment">// 获取所有的&lt;context-param&gt;的键值对</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据这些方法，在<code>GenericeServlet</code>中找到其实现。<br>全部都是通过<code>ServletConfig</code>对象进行实现的，而<code>ServletConfig</code>是由Web容器注入的,由<a href="#Servlet%E6%8E%A5%E5%8F%A3%E5%9C%A8GenericServlet%E4%B8%AD%E7%9A%84%E5%AE%9E%E7%8E%B0">Servlet</a>实现。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">GenericServlet</span> </span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">Servlet</span>, ServletConfig, java.io.Serializable&#123;</span><br><span class="line">    <span class="comment">/** 省略部分代码 */</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getServletName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getServletName();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> ServletContext <span class="title function_">getServletContext</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getServletContext();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInitParameter</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getInitParameter(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title function_">getInitParameterNames</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getServletConfig().getInitParameterNames();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="HttpServlet详解"><a href="#HttpServlet详解" class="headerlink" title="HttpServlet详解"></a>HttpServlet详解</h1><p>很明显，GenericServlet只留下了<code>service</code>这个方法给HttpServlet进行重写。<br>并根据不同的请求类型，调用不同的<code>doXxx</code>方法。<br><code>doXxx</code>必须重写，否则在调用时会出现异常。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">HttpServlet</span> <span class="keyword">extends</span> <span class="title class_">GenericServlet</span>&#123;</span><br><span class="line">    <span class="comment">/** 省略部分代码 */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(ServletRequest req, ServletResponse res)</span>&#123;</span><br><span class="line">        <span class="type">HttpServletRequest</span>  <span class="variable">request</span> <span class="operator">=</span> (HttpServletRequest) req;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) res;</span><br><span class="line">        service(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** 核心方法 */</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">method</span> <span class="operator">=</span> req.getMethod(); <span class="comment">// 获取请求类型</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 根据请求类型，调用不同的doXxx方法</span></span><br><span class="line">        <span class="keyword">if</span> (method.equals(METHOD_GET)) &#123;</span><br><span class="line">            doGet(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_HEAD)) &#123;</span><br><span class="line">            doHead(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_POST)) &#123;</span><br><span class="line">            doPost(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_PUT)) &#123;</span><br><span class="line">            doPut(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_DELETE)) &#123;</span><br><span class="line">            doDelete(req, resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_OPTIONS)) &#123;</span><br><span class="line">            doOptions(req,resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (method.equals(METHOD_TRACE)) &#123;</span><br><span class="line">            doTrace(req,resp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">//</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Http的各种请求类型"><a href="#Http的各种请求类型" class="headerlink" title="Http的各种请求类型"></a>Http的各种请求类型</h2><table>
<thead>
<tr>
<th align="left">请求类型</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">Get</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Post</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Put</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Delete</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Head</td>
<td align="left">调用doGet方法，返回空body的Response</td>
</tr>
<tr>
<td align="left">Options</td>
<td align="left">调试工作，返回所有支持的处理类型的集合</td>
</tr>
<tr>
<td align="left">Trace</td>
<td align="left">调试工作，远程诊断服务器，将接收到的header原封不动地返回</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
        <tag>Servlet</tag>
      </tags>
  </entry>
  <entry>
    <title>JSP的Java Bean学习总结</title>
    <url>/posts/The_Java_Bean_of_JSP.html</url>
    <content><![CDATA[<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>预先创建<code>Person</code>类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span>()&#123;</span><br><span class="line">    string name;</span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="comment">//get方法、set方法、构造方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="普通方式使用"><a href="#普通方式使用" class="headerlink" title="普通方式使用"></a>普通方式使用</h2><p>并在<code>JSP</code>中使用，就像<code>Java</code>程序一样</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;@page import=&quot;包名.Person&quot;&gt;&lt;%--先导包--%&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span>&lt;%--省略--%&gt;<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">   &lt;%</span><br><span class="line">        Person p1 = new Person(&quot;小明&quot;,12);</span><br><span class="line">        out.println(&quot;姓名:&quot;+p1.getName()+&quot;，年龄:&quot;+p1.getAge());</span><br><span class="line">   %&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="通过JSP动作标签使用"><a href="#通过JSP动作标签使用" class="headerlink" title="通过JSP动作标签使用"></a>通过JSP动作标签使用</h2><p>使用<code>&lt;jsp:useBean&gt;</code>声明，<code>&lt;jsp:setProperty&gt;</code>设置属性，使用<code>&lt;jsp:getProperty&gt;</code>获取属性<br>并且不用<code>&lt;@page import=&quot;&quot;&gt;</code>导包</p>
<p>首先新建个<code>submit.jsp</code>页面，写一个<code>form</code>表单</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span>&lt;%--省略--%&gt;<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;submitForm&quot;</span> <span class="attr">action</span>=<span class="string">&quot;doSubmit.jsp&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>然后在<code>doSubmit.jsp</code>页面中获取<code>form</code>中传递的数据</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">head</span>&gt;</span>&lt;%--省略--%&gt;<span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:useBean</span> <span class="attr">id</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;包名.Person&quot;</span> <span class="attr">scope</span>=<span class="string">&quot;作用范围&quot;</span> /&gt;</span>&lt;%--相当于Person p2 = new Person();--%&gt;</span><br><span class="line">    &lt;%--scope默认值是page，可选page、request、session、application--%&gt;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;*&quot;</span> /&gt;</span>&lt;%--第一种方法--%&gt;</span><br><span class="line">    &lt;%--通配符*会自动将form中的name和JavaBean中的属性自动配对--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span>&lt;%--相当于p2.getName()--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span>&lt;%--相当于p2.getAge()--%&gt;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span>&lt;%--第二种方法--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span>&lt;%--将form中的name和JavaBean中的属性自动配对--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span>&lt;%--相当于p2.getName()--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span>&lt;%--相当于p2.getAge()--%&gt;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;小红&quot;</span> /&gt;</span>&lt;%--第三种方法--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10&quot;</span> /&gt;</span>&lt;%--手动设置属性--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span>&lt;%--相当于p2.getName()--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span>&lt;%--相当于p2.getAge()--%&gt;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> <span class="attr">param</span>=<span class="string">&quot;name&quot;</span> /&gt;</span>&lt;%--第四种方法--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:setProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> <span class="attr">param</span>=<span class="string">&quot;age&quot;</span>/&gt;</span>&lt;%--通过request获取传递参数--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span> /&gt;</span>&lt;%--相当于p2.getName()--%&gt;</span><br><span class="line">    <span class="tag">&lt;<span class="name">jsp:getProperty</span> <span class="attr">name</span>=<span class="string">&quot;p2&quot;</span> <span class="attr">property</span>=<span class="string">&quot;age&quot;</span> /&gt;</span>&lt;%--相当于p2.getAge()--%&gt;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><h2 id="使用普通方式和Java程序一样。"><a href="#使用普通方式和Java程序一样。" class="headerlink" title="使用普通方式和Java程序一样。"></a>使用普通方式和Java程序一样。</h2><h2 id="使用jsp-setProperty标签"><a href="#使用jsp-setProperty标签" class="headerlink" title="使用jsp:setProperty标签"></a>使用jsp:setProperty标签</h2><ol>
<li>运用通配符<code>*</code>实现完全匹配，表单<code>form</code>的<code>name</code>属性名、<code>JavaBean</code>的属性名要完全一致。</li>
<li>运用通配符<code>*</code>实现部分匹配，表单<code>form</code>的<code>name</code>属性名、<code>JavaBean</code>的属性名、<code>jsp:setProperty</code>的<code>property</code>属性值要完全一致。</li>
<li>手动设置，和表单<code>form</code>无关，和普通方式使用情景一样。</li>
<li>从<code>request</code>中获取，param的属性值只要和<code>request</code>的属性值一致即可，不用和<code>JavaBean</code>的属性值保持一致，无论<code>get</code>、<code>post</code>都可以。</li>
</ol>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>JSP</tag>
      </tags>
  </entry>
  <entry>
    <title>JSP的编译流程</title>
    <url>/posts/JSP_compile_and_load.html</url>
    <content><![CDATA[<h1 id="情景还原"><a href="#情景还原" class="headerlink" title="情景还原"></a>情景还原</h1><p>用<code>Spring Boot</code>简单搭建环境, 建一个<code>Controller</code>以及两个<code>JSP</code>页面。<br>发现<code>/test1</code>页面<code>404</code>不能访问, 而<code>/test2</code>可以访问。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;test1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/WEB-INF/views/IE10+.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;test2&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;/WEB-INF/views/IE10.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h1><p><code>JSP</code>是本质一个<code>Java</code>文件, 所以命名也需要遵循<code>Java</code>命名规则, <code>+</code>加号对<code>Java</code>命名规则来说是一个非法字符。<br>所以<code>IE10+.jsp</code>对应的<code>java</code>文件是不存在的, 自然也就<code>404</code>了。<br>我在<code>$CATALINA_BASE/work/Catalina/localhost/web/org/apache/jsp/WEB_002dINF/views/</code>下只看到了<code>IE10_jsp.java</code>和<code>IE10_jsp.class</code>这两个文件。</p>
<h1 id="JSP编译流程"><a href="#JSP编译流程" class="headerlink" title="JSP编译流程"></a>JSP编译流程</h1><ol>
<li>客户端请求<code>JSP</code>文件.</li>
<li><code>Servlet</code>容器将请求交给<code>org.apache.jasper.servlet.JspServlet</code>处理, 具体配置在<code>Tomcat</code>的<code>conf/web.xml</code>中.</li>
<li><code>JspServlet</code>生成<code>java</code>文件, 编译为<code>class</code>文件, 加载到<code>ClassLoader</code>, 加入缓存中.</li>
<li>调用生成的<code>Servlet</code>的<code>service</code>方法处理请求.</li>
</ol>
<h1 id="基于Tomcat-8-5-35的源码分析"><a href="#基于Tomcat-8-5-35的源码分析" class="headerlink" title="基于Tomcat 8.5.35的源码分析"></a>基于Tomcat 8.5.35的源码分析</h1><p>![继承树](<a href="https://yuml.me/diagram/nofunky/class/[">https://yuml.me/diagram/nofunky/class/[</a>&lt;<PeriodicEventListener>&gt;;interface]^-[JspServlet], [HttpServlet]^-[JspServlet])<br><code>JspServlet</code>继承了<code>HttpServlet</code>, 并实现了<code>PeriodicEventListener</code>接口, 这个接口暂时不管它, <code>HttpServlet</code>在我<a href="https://ahaochan.github.io/posts/HttpServlet_source_code.html">另一篇文章</a>中有做源码解析。</p>
<h2 id="重写了继承树上GenericServlet的方法"><a href="#重写了继承树上GenericServlet的方法" class="headerlink" title="重写了继承树上GenericServlet的方法"></a>重写了继承树上GenericServlet的方法</h2><p><code>JspServlet</code>重写了<code>GenericServlet</code>的两个方法.<br>默认情况下, 只做了一件事, 对<code>JspRuntimeContext</code>的实例进行初始化和销毁.</p>
<ol>
<li><code>public void init(ServletConfig config);</code> 初始化方法, 默认只初始化<code>JspRuntimeContext</code>的实例</li>
<li><code>public void destroy();</code> 销毁方法, 销毁<code>JspRuntimeContext</code>的实例<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.servlet.JspServlet</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> <span class="keyword">implements</span> <span class="title class_">PeriodicEventListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletContext context;</span><br><span class="line">    <span class="keyword">private</span> ServletConfig config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Options options;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> JspRuntimeContext rctxt;</span><br><span class="line">    <span class="keyword">private</span> String jspFile;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="built_in">super</span>.init(config);</span><br><span class="line">        <span class="built_in">this</span>.config = config;</span><br><span class="line">        <span class="built_in">this</span>.context = config.getServletContext();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 省略部分代码, 默认不执行的代码</span></span><br><span class="line">        options = <span class="keyword">new</span> <span class="title class_">EmbeddedServletOptions</span>(config, context);</span><br><span class="line">        rctxt = <span class="keyword">new</span> <span class="title class_">JspRuntimeContext</span>(context, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line">        rctxt.destroy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="重写了HttpServlet的service方法"><a href="#重写了HttpServlet的service方法" class="headerlink" title="重写了HttpServlet的service方法"></a>重写了HttpServlet的service方法</h2><p><code>service</code>方法是实际处理请求的逻辑方法。这里不对<code>include</code>等特殊情况做分析.<br>首先会判断请求参数是否携带<code>jsp_precompile</code>参数, 如果有的话就标记成预编译, 交给后面的核心代码使用.<br>然后再从缓存中获取<code>JspServletWrapper</code>实例, 没有则创建.<br>最后交给<code>JspServletWrapper</code>的<code>service</code>去执行核心代码.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.servlet.JspServlet</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> <span class="keyword">implements</span> <span class="title class_">PeriodicEventListener</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> ServletContext context;</span><br><span class="line">    <span class="keyword">private</span> ServletConfig config;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Options options;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> JspRuntimeContext rctxt;</span><br><span class="line">    <span class="keyword">private</span> String jspFile;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span> <span class="params">(HttpServletRequest request, HttpServletResponse response)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// jspFile may be configured as an init-param for this servlet instance</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jspUri</span> <span class="operator">=</span> request.getServletPath();</span><br><span class="line">        <span class="type">String</span> <span class="variable">pathInfo</span> <span class="operator">=</span> request.getPathInfo();</span><br><span class="line">        <span class="keyword">if</span> (pathInfo != <span class="literal">null</span>) &#123;</span><br><span class="line">            jspUri += pathInfo;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据 jsp_precompile 参数是否存在, 判断是否需要进行预编译</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">precompile</span> <span class="operator">=</span> preCompile(request);</span><br><span class="line">        <span class="comment">// 处理请求</span></span><br><span class="line">        serviceJspFile(request, response, jspUri, precompile);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">serviceJspFile</span><span class="params">(HttpServletRequest request, HttpServletResponse response, String jspUri, <span class="type">boolean</span> precompile)</span></span><br><span class="line">        <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 从 JspRuntimeContext 缓存中获取 JspServlet包装类, 双重锁避免高并发问题</span></span><br><span class="line">        <span class="type">JspServletWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> rctxt.getWrapper(jspUri);</span><br><span class="line">        <span class="keyword">if</span> (wrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">                wrapper = rctxt.getWrapper(jspUri);</span><br><span class="line">                <span class="keyword">if</span> (wrapper == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 判断请求的JSP是否存在, 避免创建无用的JspServletWwrapper</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="literal">null</span> == context.getResource(jspUri)) &#123;</span><br><span class="line">                        handleMissingResource(request, response, jspUri);</span><br><span class="line">                        <span class="keyword">return</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    wrapper = <span class="keyword">new</span> <span class="title class_">JspServletWrapper</span>(config, options, jspUri, rctxt);</span><br><span class="line">                    <span class="comment">// 加入 JspRuntimeContext 缓存</span></span><br><span class="line">                    rctxt.addWrapper(jspUri,wrapper);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 2. 核心处理代码</span></span><br><span class="line">            wrapper.service(request, response, precompile);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (FileNotFoundException fnfe) &#123;</span><br><span class="line">            handleMissingResource(request, response, jspUri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="生成Java文件并编译"><a href="#生成Java文件并编译" class="headerlink" title="生成Java文件并编译"></a>生成Java文件并编译</h2><p><code>options.getDevelopment()</code>这个变量是写在<code>web.xml</code>的<code>JspServlet</code>里, 通过<code>ServletConfig</code>的<code>getInitParameter(&quot;development&quot;)</code>方法获取. <code>web.xml</code>中没有进行配置, 所以默认为<code>true</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.servlet.JspServletWrapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspServletWrapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JspCompilationContext ctxt;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">mustCompile</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Options options;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="type">boolean</span> precompile)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException, FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="comment">// (1) 编译, mustCompile默认为true, options.getDevelopment()默认为true</span></span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="keyword">if</span> (options.getDevelopment() || mustCompile) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (options.getDevelopment() || mustCompile) &#123;</span><br><span class="line">                    <span class="comment">// The following sets reload to true, if necessary</span></span><br><span class="line">                    ctxt.compile();</span><br><span class="line">                    mustCompile = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ==================省略部分代码==================</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>JspServletWrapper</code>的<code>service</code>调用了<code>JspCompilationContext</code>的<code>compile</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.JspCompilationContext</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspCompilationContext</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">()</span> <span class="keyword">throws</span> JasperException, FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// 1. 获取编译器</span></span><br><span class="line">        createCompiler();</span><br><span class="line">        <span class="comment">// 2. 判断是否需要重新将 JSP 转为 java 文件, 并编译为 class 文件</span></span><br><span class="line">        <span class="keyword">if</span> (jspCompiler.isOutDated()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (isRemoved()) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FileNotFoundException</span>(jspUri);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3. 先删除上次生成的 class 文件, 后删除 java 文件</span></span><br><span class="line">            jspCompiler.removeGeneratedFiles();</span><br><span class="line">            jspLoader = <span class="literal">null</span>; <span class="comment">// 清空 ClassLoader, 为了进行 JSP 热部署</span></span><br><span class="line">            <span class="comment">// 4. 重新生成 java 文件, 后编译为 class 文件</span></span><br><span class="line">            jspCompiler.compile();</span><br><span class="line">            jsw.setReload(<span class="literal">true</span>); <span class="comment">// 设置重新加载 Servlet 的标识</span></span><br><span class="line">            jsw.setCompilationException(<span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 省略部分捕获异常的代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第一步, <code>createCompiler();</code>先获取编译器</p>
<ol>
<li>判断<code>web.xml</code>里的<code>JspServlet</code>有没有定义编译器的类名<code>compilerClassName</code>, 有则创建</li>
<li>判断<code>web.xml</code>里的<code>JspServlet</code>有没有定义<code>compiler</code>, 有则先创建<code>JDTCompiler</code>编译器, 否则先创建<code>AntCompiler</code>. 创建失败则尝试创建两者的另一个编译器.</li>
<li>都创建失败, 则抛出异常</li>
</ol>
<p>第二步, <code>jspCompiler.isOutDated()</code>比较<code>JSP</code>的最后修改时间和对应的<code>class</code>文件<br>最后修改时间, 过时则重新编译.  可以在<code>web.xml</code>里的<code>JspServlet</code>配置<code>modificationTestInterval</code>参数, 指定一定秒数内<code>return false</code>, 不进行重新编译.</p>
<p>第三步, 先删除上次生成的<code>class</code>文件, 后删除<code>java</code>文件。<br>第四步, 调用之前获取到的编译器的<code>compile</code>方法生成<code>java</code>文件, 并编译为<code>class</code>文件.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.compiler.Compiler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Compiler</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">()</span> <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception &#123;</span><br><span class="line">        compile(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">(<span class="type">boolean</span> compileClass)</span> <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception &#123;</span><br><span class="line">        compile(compileClass, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">compile</span><span class="params">(<span class="type">boolean</span> compileClass, <span class="type">boolean</span> jspcMode)</span> <span class="keyword">throws</span> FileNotFoundException, JasperException, Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 生成 java 文件</span></span><br><span class="line">        String[] smap = generateJava();</span><br><span class="line">        <span class="type">File</span> <span class="variable">javaFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(ctxt.getServletJavaFileName());</span><br><span class="line">        <span class="type">Long</span> <span class="variable">jspLastModified</span> <span class="operator">=</span> ctxt.getLastModified(ctxt.getJspFile());</span><br><span class="line">        javaFile.setLastModified(jspLastModified.longValue());</span><br><span class="line">        <span class="keyword">if</span> (compileClass) &#123;</span><br><span class="line">            <span class="comment">// 2. 编译为 class 文件, 交给子类实现, 如 AntCompiler、JDTCompiler</span></span><br><span class="line">            generateClass(smap);</span><br><span class="line">            <span class="comment">// Fix for bugzilla 41606</span></span><br><span class="line">            <span class="comment">// Set JspServletWrapper.servletClassLastModifiedTime after successful compile</span></span><br><span class="line">            <span class="type">File</span> <span class="variable">targetFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(ctxt.getClassFileName());</span><br><span class="line">            <span class="keyword">if</span> (targetFile.exists()) &#123;</span><br><span class="line">                targetFile.setLastModified(jspLastModified.longValue());</span><br><span class="line">                <span class="keyword">if</span> (jsw != <span class="literal">null</span>) &#123;</span><br><span class="line">                    jsw.setServletClassLastModifiedTime(</span><br><span class="line">                            jspLastModified.longValue());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取-Servlet"><a href="#获取-Servlet" class="headerlink" title="获取 Servlet"></a>获取 Servlet</h2><p>同样是<code>JspServletWrapper</code>的<code>service</code>方法, 在编译出了<code>class</code>文件后, 就应该要将<code>class</code>加载到<code>ClassLoader</code>里了。<br>在之前提到的<code>JspCompilationContext</code>的<code>compile</code>方法里, 将<code>JSP</code>的<code>ClassLoader</code>变量<code>jspLoader</code>设置为了<code>null</code>. 因为一个<code>ClassLoader</code>不能加载两个相同的类, 所以要一个新的<code>ClassLoader</code>进行热部署<code>JSP</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.servlet.JspServletWrapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspServletWrapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Servlet theServlet;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="type">boolean</span> precompile)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException, FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="comment">// (2) (重新)加载 servlet class 文件</span></span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> getServlet();</span><br><span class="line">        <span class="comment">// 如果请求参数 jsp_precompile 存在, 则不执行之后的代码</span></span><br><span class="line">        <span class="keyword">if</span> (precompile) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Servlet <span class="title function_">getServlet</span><span class="params">()</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="keyword">if</span> (getReloadInternal() || theServlet == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="comment">// Synchronizing on jsw enables simultaneous loading</span></span><br><span class="line">                <span class="comment">// of different pages, but not the same page.</span></span><br><span class="line">                <span class="keyword">if</span> (getReloadInternal() || theServlet == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// 1. 先销毁旧的 Servlet</span></span><br><span class="line">                    destroy();</span><br><span class="line">                    <span class="comment">// 2. 加载 class 并反射创建 Servlet, 这里的 JspLoader 在之前设置为 null, 所以这里会 new 一个 JspLoader</span></span><br><span class="line">                    <span class="type">InstanceManager</span> <span class="variable">instanceManager</span> <span class="operator">=</span> InstanceManagerFactory.getInstanceManager(config);</span><br><span class="line">                    <span class="comment">// fqcn 是  Full Qualified Class Name 的缩写</span></span><br><span class="line">                    <span class="type">Servlet</span> <span class="variable">servlet</span> <span class="operator">=</span> (Servlet) instanceManager.newInstance(ctxt.getFQCN(), ctxt.getJspLoader());</span><br><span class="line">                    <span class="comment">// 3. 初始化 Servlet</span></span><br><span class="line">                    servlet.init(config);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 4. JSP 重载数量+1</span></span><br><span class="line">                    <span class="keyword">if</span> (theServlet != <span class="literal">null</span>) &#123;</span><br><span class="line">                        ctxt.getRuntimeContext().incrementJspReloadCount();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    theServlet = servlet;</span><br><span class="line">                    reload = <span class="literal">false</span>; <span class="comment">// 编译时会重新设置为 true, 用于进入此 if</span></span><br><span class="line">                    <span class="comment">// Volatile &#x27;reload&#x27; forces in order write of &#x27;theServlet&#x27; and new servlet object</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> theServlet;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="限制-JSP-加载数量-选读"><a href="#限制-JSP-加载数量-选读" class="headerlink" title="限制 JSP 加载数量(选读)"></a>限制 JSP 加载数量(选读)</h2><p>默认不执行这段代码, 属于程序优化部分, 比较简单, 就是对一个队列进行先进先出的操作。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.servlet.JspServletWrapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspServletWrapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> unloadAllowed; <span class="comment">// web.xml 的 JspServlet 的 maxLoadedJsps  参数配置, 大于0则为true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> unloadByIdle;  <span class="comment">// web.xml 的 JspServlet 的 jspIdleTimeout 参数配置, 大于0则为true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> unloadByCount; <span class="comment">// 值为 unloadAllowed || unloadByIdle</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="type">boolean</span> precompile)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException, FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="comment">// (3) 限制 JSP 数量, 先进先出的队列</span></span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="keyword">if</span> (unloadAllowed) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (unloadByCount) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (unloadHandle == <span class="literal">null</span>) &#123;</span><br><span class="line">                        unloadHandle = ctxt.getRuntimeContext().push(<span class="built_in">this</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (lastUsageTime &lt; ctxt.getRuntimeContext().getLastJspQueueUpdate()) &#123;</span><br><span class="line">                        <span class="comment">// 核心代码, 移除队列中的 JSP 缓存</span></span><br><span class="line">                        ctxt.getRuntimeContext().makeYoungest(unloadHandle);</span><br><span class="line">                        lastUsageTime = System.currentTimeMillis();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (lastUsageTime &lt; ctxt.getRuntimeContext().getLastJspQueueUpdate()) &#123;</span><br><span class="line">                        lastUsageTime = System.currentTimeMillis();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="JSP-生成的-Servlet-进行处理请求"><a href="#JSP-生成的-Servlet-进行处理请求" class="headerlink" title="JSP 生成的 Servlet 进行处理请求"></a>JSP 生成的 Servlet 进行处理请求</h2><p>终于到了我们熟悉的环节, 调用创建的<code>Servlet</code>的<code>service</code>方法, 处理请求.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.apache.jasper.servlet.JspServletWrapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JspServletWrapper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> unloadAllowed; <span class="comment">// web.xml 的 JspServlet 的 maxLoadedJsps  参数配置, 大于0则为true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> unloadByIdle;  <span class="comment">// web.xml 的 JspServlet 的 jspIdleTimeout 参数配置, 大于0则为true</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> unloadByCount; <span class="comment">// 值为 unloadAllowed || unloadByIdle</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">service</span><span class="params">(HttpServletRequest request, HttpServletResponse response, <span class="type">boolean</span> precompile)</span></span><br><span class="line">            <span class="keyword">throws</span> ServletException, IOException, FileNotFoundException &#123;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="comment">// (4) 执行创建的 Servlet 的 service 方法</span></span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">        <span class="keyword">if</span> (servlet <span class="keyword">instanceof</span> SingleThreadModel) &#123;</span><br><span class="line">            <span class="comment">// sync on the wrapper so that the freshness</span></span><br><span class="line">            <span class="comment">// of the page is determined right before servicing</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                servlet.service(request, response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            servlet.service(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// =========================================</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="一个简单的Hello-world"><a href="#一个简单的Hello-world" class="headerlink" title="一个简单的Hello world"></a>一个简单的Hello world</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">        Hello world</span><br><span class="line">    <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<hr>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> org.apache.jsp.WEB_002dINF.views.upload;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.*;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.jsp.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">IE10_jsp</span> <span class="keyword">extends</span> <span class="title class_">org</span>.apache.jasper.runtime.HttpJspBase</span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">org</span>.apache.jasper.runtime.JspSourceDependent,</span><br><span class="line">                 org.apache.jasper.runtime.JspSourceImports &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> javax.servlet.jsp.<span class="type">JspFactory</span> <span class="variable">_jspxFactory</span> <span class="operator">=</span></span><br><span class="line">          javax.servlet.jsp.JspFactory.getDefaultFactory();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; _jspx_dependants;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_packages;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> java.util.Set&lt;java.lang.String&gt; _jspx_imports_classes;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;</span><br><span class="line">    _jspx_imports_packages = <span class="keyword">new</span> <span class="title class_">java</span>.util.HashSet&lt;&gt;();</span><br><span class="line">    _jspx_imports_packages.add(<span class="string">&quot;javax.servlet&quot;</span>);</span><br><span class="line">    _jspx_imports_packages.add(<span class="string">&quot;javax.servlet.http&quot;</span>);</span><br><span class="line">    _jspx_imports_packages.add(<span class="string">&quot;javax.servlet.jsp&quot;</span>);</span><br><span class="line">    _jspx_imports_classes = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> javax.el.ExpressionFactory _el_expressionfactory;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">volatile</span> org.apache.tomcat.InstanceManager _jsp_instancemanager;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.util.Map&lt;java.lang.String,java.lang.Long&gt; getDependants() &#123;</span><br><span class="line">    <span class="keyword">return</span> _jspx_dependants;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.util.Set&lt;java.lang.String&gt; getPackageImports() &#123;</span><br><span class="line">    <span class="keyword">return</span> _jspx_imports_packages;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.util.Set&lt;java.lang.String&gt; getClassImports() &#123;</span><br><span class="line">    <span class="keyword">return</span> _jspx_imports_classes;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> javax.el.ExpressionFactory <span class="title function_">_jsp_getExpressionFactory</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_el_expressionfactory == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_el_expressionfactory == <span class="literal">null</span>) &#123;</span><br><span class="line">          _el_expressionfactory = _jspxFactory.getJspApplicationContext(getServletConfig().getServletContext()).getExpressionFactory();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _el_expressionfactory;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> org.apache.tomcat.InstanceManager <span class="title function_">_jsp_getInstanceManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (_jsp_instancemanager == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (_jsp_instancemanager == <span class="literal">null</span>) &#123;</span><br><span class="line">          _jsp_instancemanager = org.apache.jasper.runtime.InstanceManagerFactory.getInstanceManager(getServletConfig());</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _jsp_instancemanager;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">_jspInit</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">_jspDestroy</span><span class="params">()</span> &#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">_jspService</span><span class="params">(<span class="keyword">final</span> javax.servlet.http.HttpServletRequest request, <span class="keyword">final</span> javax.servlet.http.HttpServletResponse response)</span></span><br><span class="line">      <span class="keyword">throws</span> java.io.IOException, javax.servlet.ServletException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> java.lang.<span class="type">String</span> <span class="variable">_jspx_method</span> <span class="operator">=</span> request.getMethod();</span><br><span class="line">    <span class="keyword">if</span> (!<span class="string">&quot;GET&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="string">&quot;POST&quot;</span>.equals(_jspx_method) &amp;&amp; !<span class="string">&quot;HEAD&quot;</span>.equals(_jspx_method) &amp;&amp; !javax.servlet.DispatcherType.ERROR.equals(request.getDispatcherType())) &#123;</span><br><span class="line">      response.sendError(HttpServletResponse.SC_METHOD_NOT_ALLOWED, <span class="string">&quot;JSPs only permit GET POST or HEAD&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> javax.servlet.jsp.PageContext pageContext;</span><br><span class="line">    javax.servlet.http.<span class="type">HttpSession</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">final</span> javax.servlet.ServletContext application;</span><br><span class="line">    <span class="keyword">final</span> javax.servlet.ServletConfig config;</span><br><span class="line">    javax.servlet.jsp.<span class="type">JspWriter</span> <span class="variable">out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">final</span> java.lang.<span class="type">Object</span> <span class="variable">page</span> <span class="operator">=</span> <span class="built_in">this</span>;</span><br><span class="line">    javax.servlet.jsp.<span class="type">JspWriter</span> <span class="variable">_jspx_out</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    javax.servlet.jsp.<span class="type">PageContext</span> <span class="variable">_jspx_page_context</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response.setContentType(<span class="string">&quot;text/html;charset=UTF-8&quot;</span>);</span><br><span class="line">      pageContext = _jspxFactory.getPageContext(<span class="built_in">this</span>, request, response,</span><br><span class="line">            <span class="literal">null</span>, <span class="literal">true</span>, <span class="number">8192</span>, <span class="literal">true</span>);</span><br><span class="line">      _jspx_page_context = pageContext;</span><br><span class="line">      application = pageContext.getServletContext();</span><br><span class="line">      config = pageContext.getServletConfig();</span><br><span class="line">      session = pageContext.getSession();</span><br><span class="line">      out = pageContext.getOut();</span><br><span class="line">      _jspx_out = out;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// =========================== 输出代码 =====================================</span></span><br><span class="line">      out.write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">      out.write(<span class="string">&quot;&lt;html&gt;\r\n&quot;</span>);</span><br><span class="line">      out.write(<span class="string">&quot;&lt;body&gt;\r\n&quot;</span>);</span><br><span class="line">      out.write(<span class="string">&quot;Hello world\r\n&quot;</span>);</span><br><span class="line">      out.write(<span class="string">&quot;&lt;/body&gt;\r\n&quot;</span>);</span><br><span class="line">      out.write(<span class="string">&quot;&lt;/html&gt;\r\n&quot;</span>);</span><br><span class="line">      <span class="comment">// =========================== 输出代码 =====================================</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.lang.Throwable t) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!(t <span class="keyword">instanceof</span> javax.servlet.jsp.SkipPageException))&#123;</span><br><span class="line">        out = _jspx_out;</span><br><span class="line">        <span class="keyword">if</span> (out != <span class="literal">null</span> &amp;&amp; out.getBufferSize() != <span class="number">0</span>)</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">              out.flush();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              out.clearBuffer();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (java.io.IOException e) &#123;&#125;</span><br><span class="line">        <span class="keyword">if</span> (_jspx_page_context != <span class="literal">null</span>) _jspx_page_context.handlePageException(t);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ServletException</span>(t);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      _jspxFactory.releasePageContext(_jspx_page_context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://shenzhang.github.io/blog/2013/06/26/recompile-and-redeploy-in-jsp/">Jsp的编译过程和热部署原理</a></li>
<li><a href="https://www.jianshu.com/p/01805c2a1036">JSP 热部署 源码解析</a></li>
<li><a href="https://blog.csdn.net/hwcptbtptp/article/details/78270243">FQCN是什么鬼</a></li>
<li><a href="https://stackoverflow.com/questions/53511441">Why Spring Boot cannot parse view with + symbol?</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
        <tag>Servlet</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Logback日志配置</title>
    <url>/posts/Logback_xml_configuration.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>回想以前都是用 <code>System.out.println</code> 作为调试的主要手段的, 但是当部署到服务器时, 我们不可能一直盯着控制台看, 并且这种方法也不能进行分级输出。 <code>System.out.println</code> 也就满足不了需求了。<br><code>Logback</code> 是一个 Java 领域的日志框架。它被认为是 <code>Log4J</code> 的继承人，实现了 <code>SLF4J</code> 标准。反正就是个特好用的东西。</p>
<span id="more"></span>

<h1 id="导入maven"><a href="#导入maven" class="headerlink" title="导入maven"></a>导入maven</h1><ul>
<li><a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api">slf4j-api</a></li>
<li><a href="https://mvnrepository.com/artifact/ch.qos.logback/logback-classic">logback-classic</a> : 包含了<a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-api">slf4j-api</a>、<a href="https://mvnrepository.com/artifact/ch.qos.logback/logback-core">logback-core</a></li>
<li><a href="https://mvnrepository.com/artifact/org.logback-extensions/logback-ext-spring">logback-ext-spring</a>: 提供的对Spring的支持</li>
<li><a href="https://mvnrepository.com/artifact/org.slf4j/jcl-over-slf4j">jcl-over-slf4j</a>: 打印Spring框架本身打印的日志</li>
</ul>
<h1 id="Spring-配置"><a href="#Spring-配置" class="headerlink" title="Spring 配置"></a>Spring 配置</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">listener</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>ch.qos.logback.ext.spring.web.LogbackConfigListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">listener</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">context-param</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>logbackConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>classpath:logback.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">context-param</span>&gt;</span>  </span><br></pre></td></tr></table></figure>

<p>Spring Boot直接放在 <code>resource/logback.xml</code>即可, 会自动配置加载。</p>
<h1 id="logback-xml"><a href="#logback-xml" class="headerlink" title="logback.xml"></a>logback.xml</h1><p>直接复制粘贴进去即可, 一些基本常识请看官方文档或下面的参考资料。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 上下文名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.context.name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MyApp&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- log编码 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.charset&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- log文件最大历史 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.history.max&quot;</span> <span class="attr">value</span>=<span class="string">&quot;30&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- log文件输出路径, 相对路径LOG在Tomcat 8.5\bin\LOG下, 绝对路径/LOG在D:\LOG下 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 推荐绝对路径 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.path&quot;</span> <span class="attr">value</span>=<span class="string">&quot;LOG&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- Log4j: [S][%d&#123;yyyyMMdd HH:mm:ss&#125;][%-5p][%C:%L] - %m%n --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.pattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.pattern.short&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%date&#123;yyyyMMdd HH:mm:ss.SSS&#125;-%msg%n&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 设置上下文名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>$&#123;log.context.name&#125;<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 输出到控制台 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- appender用于输出log日志, name是appender的唯一标识, class指定实现类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- encoder是编码器, charset指定编码格式 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 输出日志的格式, 在上面有提到 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT_SHORT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern.short&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 输出到文件 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- ERROR级别日志 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 滚动记录文件，先将日志记录到指定文件，当符合某个条件时，将日志记录到其他文件 RollingFileAppender--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_ERROR&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 过滤器，只记录ERROR级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>ERROR<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 匹配则处理这个日志, 不经过其他过滤器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 不匹配则抛弃这个日志 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 最常用的滚动策略，它根据时间来制定滚动策略.既负责滚动也负责出发滚动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志输出位置  可相对、和绝对路径 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/error/log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 可选节点，控制保留的归档文件的最大数量，超出数量就删除旧文件假设设置每个月滚动，且&lt;maxHistory&gt;是6，</span></span><br><span class="line"><span class="comment">            则只保存最近6个月的文件，删除之前的旧文件。注意，删除旧文件是，那些为了归档而创建的目录也会被删除--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>$&#123;log.history.max&#125;<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- WARN级别日志 appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_WARN&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 过滤器，只记录WARN级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>WARN<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 匹配则处理这个日志, 不经过其他过滤器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 不匹配则抛弃这个日志 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 最常用的滚动策略，它根据时间来制定滚动策略.既负责滚动也负责出发滚动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志输出位置  可相对、和绝对路径 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/warn/log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 可选节点，控制保留的归档文件的最大数量，超出数量就删除旧文件假设设置每个月滚动，且&lt;maxHistory&gt;是6，</span></span><br><span class="line"><span class="comment">            则只保存最近6个月的文件，删除之前的旧文件。注意，删除旧文件是，那些为了归档而创建的目录也会被删除--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>$&#123;log.history.max&#125;<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- INFO级别日志 appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_INFO&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 过滤器，只记录INFO级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>INFO<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 匹配则处理这个日志, 不经过其他过滤器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 不匹配则抛弃这个日志 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 最常用的滚动策略，它根据时间来制定滚动策略.既负责滚动也负责出发滚动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志输出位置  可相对、和绝对路径 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/info/log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 可选节点，控制保留的归档文件的最大数量，超出数量就删除旧文件假设设置每个月滚动，且&lt;maxHistory&gt;是6，</span></span><br><span class="line"><span class="comment">            则只保存最近6个月的文件，删除之前的旧文件。注意，删除旧文件是，那些为了归档而创建的目录也会被删除--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>$&#123;log.history.max&#125;<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- DEBUG级别日志 appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_DEBUG&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 过滤器，只记录DEBUG级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>DEBUG<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 匹配则处理这个日志, 不经过其他过滤器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 不匹配则抛弃这个日志 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 最常用的滚动策略，它根据时间来制定滚动策略.既负责滚动也负责出发滚动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志输出位置  可相对、和绝对路径 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/debug/log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 可选节点，控制保留的归档文件的最大数量，超出数量就删除旧文件假设设置每个月滚动，且&lt;maxHistory&gt;是6，</span></span><br><span class="line"><span class="comment">            则只保存最近6个月的文件，删除之前的旧文件。注意，删除旧文件是，那些为了归档而创建的目录也会被删除--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>$&#123;log.history.max&#125;<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- TRACE级别日志 appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_TRACE&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 过滤器，只记录TRACE级别的日志 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.filter.LevelFilter&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">level</span>&gt;</span>TRACE<span class="tag">&lt;/<span class="name">level</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 匹配则处理这个日志, 不经过其他过滤器 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMatch</span>&gt;</span>ACCEPT<span class="tag">&lt;/<span class="name">onMatch</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 不匹配则抛弃这个日志 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">onMismatch</span>&gt;</span>DENY<span class="tag">&lt;/<span class="name">onMismatch</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 最常用的滚动策略，它根据时间来制定滚动策略.既负责滚动也负责出发滚动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--日志输出位置  可相对、和绝对路径 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>$&#123;log.path&#125;/trace/log.%d&#123;yyyy-MM-dd&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 可选节点，控制保留的归档文件的最大数量，超出数量就删除旧文件假设设置每个月滚动，且&lt;maxHistory&gt;是6，</span></span><br><span class="line"><span class="comment">            则只保存最近6个月的文件，删除之前的旧文件。注意，删除旧文件是，那些为了归档而创建的目录也会被删除--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">maxHistory</span>&gt;</span>$&#123;log.history.max&#125;<span class="tag">&lt;/<span class="name">maxHistory</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 项目日志级别 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.apache.ibatis&quot;</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.Connection&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.Statement&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.PreparedStatement&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.ahao.project&quot;</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- root级别 INFO --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 文件输出 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_ERROR&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_INFO&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_WARN&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_DEBUG&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_TRACE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://justcode.ikeepstudying.com/wp-content/uploads/2017/04/logback-%E4%B8%AD%E6%96%87%E6%89%8B%E5%86%8C.pdf">logback 中文手册下载</a></li>
<li><a href="http://aub.iteye.com/blog/1101222">logback 常用配置详解（序）logback 简介</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Logback</tag>
      </tags>
  </entry>
  <entry>
    <title>Logback输出异常堆栈</title>
    <url>/posts/Logback_how_to_output_exception_stack.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天来到公司, 老大和我说SpringBoot的短信项目没有日志输出, 赶紧火急火燎的排错。</p>
<span id="more"></span>

<h1 id="先排查logback-xml"><a href="#先排查logback-xml" class="headerlink" title="先排查logback.xml"></a>先排查logback.xml</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- root级别 INFO --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 文件输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_TRACE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_DEBUG&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_INFO&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_WARN&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_ERROR&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>日志输出级别是 <code>INFO</code>, 按理是没什么问题的, 为了稳妥起见, 改为 <code>DEBUG</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- root级别 DEBUG --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 文件输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_TRACE&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_DEBUG&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_INFO&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_WARN&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_ERROR&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="检查application-yml"><a href="#检查application-yml" class="headerlink" title="检查application.yml"></a>检查application.yml</h1><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 日志 配置</span></span><br><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="attr">com.nine.rivers.galaxy:</span> <span class="string">info</span></span><br><span class="line">    <span class="attr">org.springframework:</span> <span class="string">warn</span></span><br></pre></td></tr></table></figure>
<p>发现了这一段, 估计是在摸石头过河阶段加入的, 后来用 <code>logback.xml</code> 的时候没有删除掉。<br>有句话说得好, 如果你自己都搞不清楚程序要做什么, 程序自己肯定也会搞糊涂<br>统一一个日志配置文件, 把 <code>application.yml</code> 中的这一段删掉。</p>
<h1 id="异常日志输出"><a href="#异常日志输出" class="headerlink" title="异常日志输出"></a>异常日志输出</h1><p>改完后发现普通的日志输出没有问题, 但是不能输出异常堆栈。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// do Something</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    e.printStackTrace(); <span class="comment">// 注意这里</span></span><br><span class="line">    logger.error(<span class="string">&quot;反射获取参数错误, 请检查field的权限修饰符:&quot;</span> + e.getMessage());</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>在使用 <code>System.out.println()</code> 输出日志的阶段, 我一直都是使用 <code>e.printStackTrace()</code> 输出的。<br>改用 <code>log</code> 输出日志之后, 没有意识到 <code>e.printStackTrace()</code> 其实是 <code>System.err.println()</code>, 没有输出到日志。<br>改为如下代码即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// do Something</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">    logger.error(<span class="string">&quot;反射获取参数错误, 请检查field的权限修饰符:&quot;</span>, e);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h2 id="初探源码"><a href="#初探源码" class="headerlink" title="初探源码"></a>初探源码</h2><p><code>e.printStackTrace()</code> 这个方法是在父类 <code>Throwable</code> 中实现的。<br>很明显看到 <code>System.err</code> 的字样。更深入异常的体系结构暂不分析。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// java.lang.Throwable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Throwable</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printStackTrace</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 是不是和System.out很像</span></span><br><span class="line">        <span class="comment">// 调用第9行的代码</span></span><br><span class="line">        printStackTrace(System.err);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">printStackTrace</span><span class="params">(PrintStream s)</span> &#123;</span><br><span class="line">        <span class="comment">// WrappedPrintStream 是 Throwable 的私有静态内部类, 包装了一个PrintStream对象</span></span><br><span class="line">        <span class="comment">// 调用第15行的代码</span></span><br><span class="line">        printStackTrace(<span class="keyword">new</span> <span class="title class_">WrappedPrintStream</span>(s));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">printStackTrace</span><span class="params">(PrintStreamOrWriter s)</span> &#123;</span><br><span class="line">        <span class="comment">// Guard against malicious overrides of Throwable.equals by</span></span><br><span class="line">        <span class="comment">// using a Set with identity equality semantics.</span></span><br><span class="line">        Set&lt;Throwable&gt; dejaVu = Collections.newSetFromMap(<span class="keyword">new</span> <span class="title class_">IdentityHashMap</span>&lt;Throwable, Boolean&gt;());</span><br><span class="line">        dejaVu.add(<span class="built_in">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">synchronized</span> (s.lock()) &#123;</span><br><span class="line">            <span class="comment">// 打印自身</span></span><br><span class="line">            s.println(<span class="built_in">this</span>);</span><br><span class="line">            StackTraceElement[] trace = getOurStackTrace();</span><br><span class="line">            <span class="keyword">for</span> (StackTraceElement traceElement : trace)</span><br><span class="line">                <span class="comment">// 打印当前的异常信息</span></span><br><span class="line">                s.println(<span class="string">&quot;\tat &quot;</span> + traceElement);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印被抑制（可能是try住的）的所有的异常信息</span></span><br><span class="line">            <span class="keyword">for</span> (Throwable se : getSuppressed())</span><br><span class="line">                se.printEnclosedStackTrace(s, trace, SUPPRESSED_CAPTION, <span class="string">&quot;\t&quot;</span>, dejaVu);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 打印异常的原因</span></span><br><span class="line">            <span class="type">Throwable</span> <span class="variable">ourCause</span> <span class="operator">=</span> getCause();</span><br><span class="line">            <span class="keyword">if</span> (ourCause != <span class="literal">null</span>)</span><br><span class="line">                ourCause.printEnclosedStackTrace(s, trace, CAUSE_CAPTION, <span class="string">&quot;&quot;</span>, dejaVu);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Logback</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis回写主键的值</title>
    <url>/posts/how_to_get_primary_key_in_Mybatis.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>每种数据库都有自己的主键生成方式，比如<code>MySQL</code>支持自增的主键, 在插入数据后自动生成主键, 比如<code>Oracle</code>通过序列的方式, 在插入数据之前生成主键, 再写去表中。</p>
<span id="more"></span>

<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">insert</span><span class="params">(User User)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    Long id;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="comment">// 省略构造函数和getter setter方法</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testInsert</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 1. 初始化 SqlSession</span></span><br><span class="line">        <span class="type">Reader</span> <span class="variable">reader</span> <span class="operator">=</span> Resources.getResourceAsReader(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">        <span class="type">SqlSessionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(reader);</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> factory.openSession())&#123;</span><br><span class="line">            <span class="comment">// 2.  获取Mapper</span></span><br><span class="line">            <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">            <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">            user.setName(<span class="string">&quot;测试用户&quot;</span>);</span><br><span class="line">            System.out.println(user);</span><br><span class="line">            <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> userMapper.insert(user);</span><br><span class="line">            Assert.assertEquals(<span class="number">1</span>, result);</span><br><span class="line">            <span class="comment">// 3. 判断主键回写成功</span></span><br><span class="line">            Assert.assertNotNull(user.getId());</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="使用JDBC的useGeneratedKeys获取主键值"><a href="#使用JDBC的useGeneratedKeys获取主键值" class="headerlink" title="使用JDBC的useGeneratedKeys获取主键值"></a>使用JDBC的useGeneratedKeys获取主键值</h1><p>只支持<strong>插入数据后</strong>生成主键的数据库。如<code>MySQL</code>和<code>SQLServer</code>。<br>底层是使用了<code>JDBC</code>的<code>statement.getGeneratedKeys()</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.ahao.demo.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span> <span class="attr">useGeneratedKeys</span>=<span class="string">&quot;true&quot;</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span>&gt;</span></span><br><span class="line">        insert sys_user(id, name) values (#&#123;id&#125;, #&#123;name&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用selectKey获取主键值"><a href="#使用selectKey获取主键值" class="headerlink" title="使用selectKey获取主键值"></a>使用selectKey获取主键值</h1><p><code>useGeneratedKeys</code>局限于主键自增的数据库, 不支持<code>Oracle</code>这种先<strong>生成主键</strong>, 再把主键插入数据库中的形式。<br><code>selectKey</code>两者都支持, 缺点就是比较笨重, 需要写多一点<code>xml</code>代码。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.ahao.demo.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">&quot;insert&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">selectKey</span> <span class="attr">keyProperty</span>=<span class="string">&quot;id&quot;</span> <span class="attr">keyColumn</span>=<span class="string">&quot;id&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Long&quot;</span> <span class="attr">order</span>=<span class="string">&quot;AFTER&quot;</span>&gt;</span></span><br><span class="line">        select LAST_INSERT_ID()</span><br><span class="line">        <span class="tag">&lt;/<span class="name">selectKey</span>&gt;</span></span><br><span class="line">        insert sys_user(id, name) values (#&#123;id&#125;, #&#123;name&#125;)</span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>keyProperty</code>指的是实体的<code>field</code>名称, <code>keyColumn</code>指的是数据表的<code>column</code>名称, <code>resultType</code>指定返回的<code>Java</code>类型。<br><code>order</code>分为<code>AFTER</code>和<code>BEFORE</code>, 因为<code>MySQL</code>中, 主键是在插入数据之后生成的, 所以选择<code>AFTER</code>。<code>Oracle</code>则要选<code>Before</code>。<br>需要注意的是, <code>selectKey</code>的位置不会影响结果, 最好是根据实际情况来选择放置位置, 比如<code>MySQL</code>就放在<code>SQL</code>之前, 表示先生成主键后插入数据。</p>
<h2 id="各数据库回写主键的SQL"><a href="#各数据库回写主键的SQL" class="headerlink" title="各数据库回写主键的SQL"></a>各数据库回写主键的SQL</h2><ul>
<li><a href="https://www.mysql.com/cn/">MySQL</a>： <code>SELECT LAST_INSERT_ID()</code></li>
<li><a href="https://www.microsoft.com/en-us/sql-server/sql-server-2017">Sql Server</a>：<code>SELECT SCOPE_IDENTITY()</code></li>
<li><a href="https://www.oracle.com/index.html">Oracle</a>：<code>SELECT SEQ_ID.nextval from dual</code></li>
<li><a href="https://www.ibm.com/analytics/us/en/db2/">Db2</a>： <code>VALUES IDENTITY_VAL_LOCAL()</code></li>
<li><a href="http://hsqldb.org/">HSQLDB</a>：<code>CALL IDENTITY()</code></li>
</ul>
<h1 id="不使用实体类获取主键"><a href="#不使用实体类获取主键" class="headerlink" title="不使用实体类获取主键"></a>不使用实体类获取主键</h1>]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Mybatis文件位置引发的mappedStatements为空</title>
    <url>/posts/Mybatis_mapper_xml_location_causes_mappedStatements_is_empty.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在不使用<code>Spring</code>进行初始化<code>Bean</code>, 单纯的使用<code>Mybatis</code>的时候, 遇到<code>xml</code>读取不到的问题。</p>
<span id="more"></span>

<h1 id="准备环境"><a href="#准备环境" class="headerlink" title="准备环境"></a>准备环境</h1><img data-src="/images/Mybatis%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E5%BC%95%E5%8F%91%E7%9A%84mappedStatements%E4%B8%BA%E7%A9%BA_01.png" class="">
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--==============================日志============================--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.slf4j<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>slf4j-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.7.25<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>ch.qos.logback<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>logback-classic<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--==============================日志============================--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.45<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="comment">-- MySQL数据库</span></span><br><span class="line"><span class="keyword">create</span> database test;</span><br><span class="line">use test;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">user</span>(</span><br><span class="line">    id <span class="type">int</span> <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(name) <span class="keyword">values</span> (<span class="string">&#x27;A&#x27;</span>), (<span class="string">&#x27;B&#x27;</span>), (<span class="string">&#x27;C&#x27;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- mybatis-config.xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">configuration</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">settings</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">setting</span> <span class="attr">name</span>=<span class="string">&quot;logImpl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;SLF4J&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">settings</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">environments</span> <span class="attr">default</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">environment</span> <span class="attr">id</span>=<span class="string">&quot;development&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">transactionManager</span> <span class="attr">type</span>=<span class="string">&quot;JDBC&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 配置数据库 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">transactionManager</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dataSource</span> <span class="attr">type</span>=<span class="string">&quot;UNPOOLED&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driver&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/test&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dataSource</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">environment</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">environments</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 注册mapper的三种方式 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.ahao.demo.mapper&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;mapper resource=&quot;UserMapper.xml&quot;/&gt;--&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--&lt;mapper class=&quot;com.ahao.demo.mapper.UserMapper&quot;/&gt;--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- UserMapper.xml --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span>  <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- namespace命名空间,作用就是对sql进行分类化管理,理解sql隔离 注意:使用mapper代理方法开发,namespace有特殊重要的作用,namespace等于mapper接口地址 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.ahao.demo.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;selectAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Map&quot;</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ahao.demo.mapper;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">selectAll</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.ahao.test;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.ahao.demo.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.io.Resources;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSession;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactory;</span><br><span class="line"><span class="keyword">import</span> org.apache.ibatis.session.SqlSessionFactoryBuilder;</span><br><span class="line"><span class="keyword">import</span> org.junit.BeforeClass;</span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.Logger;</span><br><span class="line"><span class="keyword">import</span> org.slf4j.LoggerFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Reader;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(MyTest.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SqlSessionFactory sqlSessionFactory;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 从 mybatis-config.xml 初始化 sqlSessionFactory</span></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Reader</span> <span class="variable">reader</span> <span class="operator">=</span> Resources.getResourceAsReader(<span class="string">&quot;mybatis-config.xml&quot;</span>);</span><br><span class="line">        sqlSessionFactory = <span class="keyword">new</span> <span class="title class_">SqlSessionFactoryBuilder</span>().build(reader);</span><br><span class="line">        reader.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testSelectAll</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 2. 读取并显示</span></span><br><span class="line">        <span class="keyword">try</span>(<span class="type">SqlSession</span> <span class="variable">sqlSession</span> <span class="operator">=</span> sqlSessionFactory.openSession()) &#123;</span><br><span class="line">            <span class="type">UserMapper</span> <span class="variable">userMapper</span> <span class="operator">=</span> sqlSession.getMapper(UserMapper.class);</span><br><span class="line">            System.out.println(userMapper);</span><br><span class="line">            <span class="type">List</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectAll();</span><br><span class="line">            System.out.println(user);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>运行过后抛出一个异常, <code>statement </code>没有找到。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">org.apache.ibatis.binding.BindingException: Invalid bound statement (not found): com.ahao.demo.mapper.UserMapper.selectAll</span><br></pre></td></tr></table></figure>

<p>通过<code>debug</code>看到<code>sqlSessionFactory</code>对象中的<code>Configuration</code>内有两个属性，<code>mapperRegistry</code>和<code>mappedStatements</code>看起来是存储<code>mapper</code>类和对应的<code>Statements</code>的两个属性。</p>
<img data-src="/images/Mybatis%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E5%BC%95%E5%8F%91%E7%9A%84mappedStatements%E4%B8%BA%E7%A9%BA_02.png" class="">
<img data-src="/images/Mybatis%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E5%BC%95%E5%8F%91%E7%9A%84mappedStatements%E4%B8%BA%E7%A9%BA_03.png" class="">
<p><code>mapperRegistry</code>注册成功了, 但是<code>mappedStatements</code>为空, 也就是<code>Class</code>加载成功了, <code>xml</code>加载失败。</p>
<p><code>xml</code>自动扫描配置是包扫描, 那么切换成别的可行吗?</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mappers</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Invalid bound statement (not found) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;com.ahao.demo.mapper&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 加载成功 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">resource</span>=<span class="string">&quot;UserMapper.xml&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Invalid bound statement (not found) --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mapper</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.demo.mapper.UserMapper&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mappers</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以看到只有直接指定<code>xml</code>才能加载成功。<br><strong>那就是通过<code>Class</code>自动去寻找对应<code>xml</code>的时候发生了异常。</strong><br>翻阅了<a href="http://www.mybatis.org/mybatis-3/zh/configuration.html#mappers">官方文档</a>, 并没有相关资料。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>然后检查<code>target</code>文件夹的时候, 发现<code>UserMapper.xml</code>和<code>UserMapper.class</code>没有在同一个文件夹内, 于是将<code>target</code>下的<code>UserMapper.xml</code>拖到<code>UserMapper.class</code>同级目录<br>。调试发现<code>mappedStatements</code>有数据。成功了, 推测应该是通过包名转文件路径进行扫描的。</p>
<img data-src="/images/Mybatis%E6%96%87%E4%BB%B6%E4%BD%8D%E7%BD%AE%E5%BC%95%E5%8F%91%E7%9A%84mappedStatements%E4%B8%BA%E7%A9%BA_04.png" class="">

<p>经过测试, 有两种解决方案</p>
<ol>
<li>手动移动<code>target</code>文件夹内的<code>mapper.xml</code>到对应的<code>mapper.class</code><strong>相同文件夹</strong><code>/WEB-INF/class/com/ahao/demo/mapper</code>下。</li>
<li>将<code>mapper.xml</code>放在<code>resource</code>文件夹内, 对应的文件<strong>目录结构</strong><code>/resource/com/ahao/demo/mapper</code>下。</li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><code>Mybatis</code>太坑, 没有个<code>file not found</code>提示。在<code>IDEA</code>下, 就算一开始将<code>mapper.xml</code>文件放在<code>src/java</code>文件夹下, 编译后也不会将<code>xml</code>放到<code>target</code>的相同目录下。<br>不过有<code>Spring</code>就不用担心了, <code>Spring</code>可以指定扫描<code>xml</code>文件位置。实际开发一般都是和<code>Spring</code>整合的吧。</p>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Mybatis</tag>
      </tags>
  </entry>
  <entry>
    <title>Quartz之cron表达式详解</title>
    <url>/posts/cron_expression_of_Quartz.html</url>
    <content><![CDATA[<h1 id="前言cron-expression"><a href="#前言cron-expression" class="headerlink" title="前言cron expression"></a>前言cron expression</h1><p>使用过 <code>Quartz</code> 定时调度框架的都知道常用的有两种触发器。 <code>SimpleTrigger</code> 和 <code>CronTrigger</code>, 本章的主角 <code>CronTrigger</code> 通过 <code>cron表达式</code> 来设置什么时候触发任务。</p>
<span id="more"></span>

<h1 id="表达式格式"><a href="#表达式格式" class="headerlink" title="表达式格式"></a>表达式格式</h1><p><code>crontab</code> 命令常见于 <code>Unix</code> 和 <code>类Unix</code> 的操作系统之中，用于设置周期性被执行的指令。 <code>CronTrigger</code> 使用的就是 <code>cron表达式</code>。<br>格式：<code>[秒] [分] [时] [日] [月] [周] [年] </code><br>共7个子表达式, 用空格隔开。</p>
<table>
<thead>
<tr>
<th align="center">字段</th>
<th align="center">是否必填</th>
<th align="center">允许值</th>
<th align="center">允许的特殊字符</th>
</tr>
</thead>
<tbody><tr>
<td align="center">秒</td>
<td align="center">是</td>
<td align="center">0~59</td>
<td align="center">,-*/</td>
</tr>
<tr>
<td align="center">分</td>
<td align="center">是</td>
<td align="center">0~59</td>
<td align="center">,-*/</td>
</tr>
<tr>
<td align="center">时</td>
<td align="center">是</td>
<td align="center">0~23</td>
<td align="center">,-*/</td>
</tr>
<tr>
<td align="center">日</td>
<td align="center">是</td>
<td align="center">1~31</td>
<td align="center">,-*?/LWC</td>
</tr>
<tr>
<td align="center">月</td>
<td align="center">是</td>
<td align="center">1~12或者JAN-DEC</td>
<td align="center">,-*/</td>
</tr>
<tr>
<td align="center">周</td>
<td align="center">是</td>
<td align="center">1~7或者SUN-SAT</td>
<td align="center">,-*?/LC#</td>
</tr>
<tr>
<td align="center">年</td>
<td align="center">否</td>
<td align="center">empty,1970~2099</td>
<td align="center">,-*/</td>
</tr>
</tbody></table>
<h1 id="特殊字符"><a href="#特殊字符" class="headerlink" title="特殊字符"></a>特殊字符</h1><ul>
<li>“?”字符：表示不确定的值</li>
<li>“,”字符：指定数个值</li>
<li>“-“字符：指定一个值的范围</li>
<li>“/“字符：指定一个值的增加幅度。n/m表示从n开始，每次增加m</li>
<li>“L”字符：用在日表示一个月中的最后一天，用在周表示该月最后一个星期X</li>
<li>“W”字符：指定离给定日期最近的工作日(周一到周五)</li>
<li>“#”字符：表示该月第几个周X。6#3表示该月第3个周五</li>
</ul>
<h1 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h1><ul>
<li> 每天10点15分: <code>0 15 10 ? * *</code></li>
<li>每天下午的2点到2点59分(整点开始, 每隔5分触发): <code>0 0/5 14 * * ?</code></li>
<li>周一到周五每天上午的10点15分: <code>0 15 10 ？ * MON-FRI</code></li>
<li>每月的第三周的星期五: <code>0 15 10 ? * 6#3</code></li>
<li>2016年到2017年每月最后一周的星期五的10点15分: <code>0 15 10 ？ * 6L 2016-2017</code></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Quartz</tag>
      </tags>
  </entry>
  <entry>
    <title>Quartz之整合Spring</title>
    <url>/posts/Quartz_and_Spring_combination.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为Web开发者, Spring是必不可少的一个框架, 自然需要把Quartz整合进去。所幸网上已有很多教程, 我这里也只是简单的整合一下, 用于以后项目的CV大法。<br><code>Quartz</code> 有调度器<code>Scheduler</code>、触发器 <code>Trigger</code>、任务 <code>JobDetail</code>三个组件。一个任务可以给多个调度器执行，触发器在指定时间运行任务，调度器操作触发器执行定时任务。</p>
<span id="more"></span>

<h1 id="maven配置"><a href="#maven配置" class="headerlink" title="maven配置"></a>maven配置</h1><p>这里的 <code>Spring</code> 版本是 <code>4.3.9.RELEASE</code> ,  <code>Quartz</code> 版本是 <code>2.3.0</code>。</p>
<ul>
<li><a href="https://mvnrepository.com/artifact/org.springframework/spring-tx">spring-tx</a>: 定时任务依赖于事务, 引入<a href="https://mvnrepository.com/artifact/org.springframework/spring-jdbc">spring-jdbc</a>即可, 自带<a href="https://mvnrepository.com/artifact/org.springframework/spring-tx">spring-tx</a></li>
<li><a href="https://mvnrepository.com/artifact/org.springframework/spring-context-support">spring-context-support</a>: 提供对Quartz定时任务的支持</li>
<li><a href="https://mvnrepository.com/artifact/org.quartz-scheduler/quartz">quartz</a>: 定时任务框架</li>
</ul>
<h1 id="创建任务JobDetail的两种方法"><a href="#创建任务JobDetail的两种方法" class="headerlink" title="创建任务JobDetail的两种方法"></a>创建任务JobDetail的两种方法</h1><ol>
<li>使用 <code>MethodInvokingJobDetailFactoryBean</code> 通过反射调用 <code>Bean的方法</code>。</li>
<li>使用 <code>JobDetailFactoryBean</code>, 必须搭配 <code>QuartzJobBean</code>。</li>
</ol>
<p>推荐用第一种方法, 低侵入式, 降低耦合性。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 第一种创建任务的方法, 不依赖框架的Java Bean形式</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">(String msg)</span>&#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass().getSimpleName()+<span class="string">&quot; : &quot;</span>+ DateFormatUtils.format(System.currentTimeMillis(),<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>)+<span class="string">&quot; : &quot;</span>+msg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 第二种创建任务的方法, 依赖spring-context-support</span></span><br><span class="line"><span class="comment">// org.springframework.scheduling.quartz.QuartzJobBean </span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyBean2</span> <span class="keyword">extends</span> <span class="title class_">QuartzJobBean</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String key;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">executeInternal</span><span class="params">(JobExecutionContext jobExecutionContext)</span> <span class="keyword">throws</span> JobExecutionException &#123;</span><br><span class="line">        System.out.println(<span class="built_in">this</span>.getClass().getSimpleName()+<span class="string">&quot; : &quot;</span>+ DateFormatUtils.format(System.currentTimeMillis(), <span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKey</span><span class="params">(String key)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.key = key;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBean1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.MyBean1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 反射调用Bean的某个方法, 传入arguments参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBeanJob1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetObject&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myBean1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetMethod&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hello&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;arguments&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hello World!<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 依赖QuartzJobBean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBeanJob2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.JobDetailFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- MyBean2必须继承QuartzJobBean --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.ahao.MyBean2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 参数通过setter方法注入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobDataAsMap&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;key&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 未绑定Trigger时不会抛出异常 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;durability&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="创建触发器Trigger的两种方法"><a href="#创建触发器Trigger的两种方法" class="headerlink" title="创建触发器Trigger的两种方法"></a>创建触发器Trigger的两种方法</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> &gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;trigger1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobDetail&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myBeanJob1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 延迟1秒启动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;startDelay&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1000&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 每2秒触发一次 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;repeatInterval&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;trigger2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.CronTriggerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobDetail&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myBeanJob2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- cron表达式 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cronExpression&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0/5 * * * * ?&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="创建调度器"><a href="#创建调度器" class="headerlink" title="创建调度器"></a>创建调度器</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;triggers&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;trigger1&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;trigger2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><p>启动Tomcat服务器, 看到控制台有输出即可。<br>完整的 <code>spring-quartz.xml</code>如下：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">       <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans</span></span></span><br><span class="line"><span class="string"><span class="tag">        http://www.springframework.org/schema/beans/spring-beans-4.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBean1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.MyBean1&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 反射调用Bean的某个方法, 传入arguments参数 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBeanJob1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetObject&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myBean1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;targetMethod&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hello&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;arguments&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>hello World!<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 依赖QuartzJobBean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;myBeanJob2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.JobDetailFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- MyBean2必须继承QuartzJobBean --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.ahao.MyBean2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 参数通过setter方法注入 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobDataAsMap&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;key&quot;</span> <span class="attr">value</span>=<span class="string">&quot;value&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 未绑定Trigger时不会抛出异常 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;durability&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;trigger1&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.SimpleTriggerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobDetail&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myBeanJob1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 延迟1秒启动 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;startDelay&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1000&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 每2秒触发一次 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;repeatInterval&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2000&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;trigger2&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.CronTriggerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jobDetail&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;myBeanJob2&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- cron表达式 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;cronExpression&quot;</span> <span class="attr">value</span>=<span class="string">&quot;0/5 * * * * ?&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.scheduling.quartz.SchedulerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;triggers&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;trigger1&quot;</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;trigger2&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring</tag>
        <tag>Quartz</tag>
      </tags>
  </entry>
  <entry>
    <title>使用SLF4J在多线程下输出到不同的日志文件</title>
    <url>/posts/Use_SLF4J_to_output_to_different_log_files_under_multi_threading.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近做了个数据传输的模块, 用到了线程池多线程, 要求将市平台的文章导入到公司的项目中进行管理, 每个栏目都有对应的文章, 但是打印日志时出现了日志混乱的问题。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">栏目A传输文章1: 开始</span><br><span class="line">栏目B传输文章2: 开始</span><br><span class="line">栏目B传输文章2: 成功</span><br><span class="line">栏目C传输文章3: 开始</span><br><span class="line">栏目A传输文章1: 成功</span><br><span class="line">栏目C传输文章3: 失败</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>每个线程输出到不同的日志文件下, 这个功能应该是可以做到的, 只要在初始化<code>Logger</code>时指定对应的文件名就可以了。</p>
<h1 id="Logback-的实现-版本号1-1-11"><a href="#Logback-的实现-版本号1-1-11" class="headerlink" title="Logback 的实现(版本号1.1.11)"></a>Logback 的实现(版本号1.1.11)</h1><p>除了<code>Logback</code>的基础模块, 需要追加引用<a href="https://mvnrepository.com/artifact/ch.qos.logback/logback-access"><code>logback-access</code></a>模块。</p>
<p><code>slf4j</code>提供了<code>Mapped Diagnostic Context (MDC)</code>这个工具, 来设置自定义变量。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">MDC.put(<span class="string">&quot;logName&quot;</span>, <span class="string">&quot;LogFile1&quot;</span>);</span><br><span class="line">logger.debug(<span class="string">&quot;Test&quot;</span> + System.currentTimeMillis());</span><br><span class="line">MDC.remove(<span class="string">&quot;logName&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在代码中这样使用, 即可在配置文件中取到<code>value</code>。<br><code>Logback</code>提供了<code>SiftingAppender</code>来进行日志记录, 并且可以读取<code>MDC</code>的值到日志路径的变量中。<br>下面代码是从我之前写的<code>Logback</code>日志配置中复制并加以微调的。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 使用 MDC 的 appender --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE_CUSTOM&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.classic.sift.SiftingAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- discriminator 的默认实现类 ch.qos.logback.classic.sift.MDCBasedDiscriminator --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">discriminator</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>logName<span class="tag">&lt;/<span class="name">key</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">defaultValue</span>&gt;</span>MyFile<span class="tag">&lt;/<span class="name">defaultValue</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">discriminator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sift</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 标准的文件输出 Appender, 文件名根据 MDC 动态生成  --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;FILE-$&#123;logName&#125;&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.RollingFileAppender&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">file</span>&gt;</span>自定义文件路径/$&#123;logName&#125;.log<span class="tag">&lt;/<span class="name">file</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!-- 最常用的滚动策略，它根据时间来制定滚动策略.既负责滚动也负责出发滚动 --&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">rollingPolicy</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.rolling.TimeBasedRollingPolicy&quot;</span>&gt;</span></span><br><span class="line">                    <span class="comment">&lt;!--日志输出位置  可相对、和绝对路径 --&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">fileNamePattern</span>&gt;</span>自定义文件路径/%d&#123;yyyy-MM-dd&#125;/$&#123;logName&#125;.log<span class="tag">&lt;/<span class="name">fileNamePattern</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">rollingPolicy</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sift</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- root级别 INFO --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 文件输出 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;FILE_CUSTOM&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="log4j的实现-版本号1-2-16"><a href="#log4j的实现-版本号1-2-16" class="headerlink" title="log4j的实现(版本号1.2.16)"></a>log4j的实现(版本号1.2.16)</h1><p><code>log4j</code>没有<code>SiftingAppender</code>, 并且也不能读取<code>MDC</code>到日志路径的变量中(但是可以读取到日志格式中)。</p>
<p>用编程的方式为每个对象示例初始化<code>Logger</code>, 然后为其添加<code>Appender</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTask</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> org.apache.log4j.Logger <span class="title function_">getLogger</span><span class="params">(<span class="type">int</span> id)</span>&#123;</span><br><span class="line">        org.apache.log4j.<span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> org.apache.log4j.Logger.getLogger(<span class="string">&quot;日志&quot;</span>+id);</span><br><span class="line">        logger.setLevel(Level.DEBUG);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注意要判断是否已存在Appender, 否则会重复创建</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">appenderName</span> <span class="operator">=</span> <span class="string">&quot;log&quot;</span>+id+<span class="string">&quot;Appender&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(logger.getAppender(appenderName) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">RollingFileAppender</span> <span class="variable">appender</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RollingFileAppender</span>();</span><br><span class="line">            appender.setName(appenderName);</span><br><span class="line">            appender.setFile(<span class="string">&quot;D:\\mylog\\&quot;</span>+id+<span class="string">&quot;.log&quot;</span>);</span><br><span class="line">            appender.setLayout(<span class="keyword">new</span> <span class="title class_">PatternLayout</span>(<span class="string">&quot;[S][%d&#123;yyyyMMdd HH:mm:ss&#125;][%-5p][%C:%L] - %m%n&quot;</span>));</span><br><span class="line">            appender.setMaxFileSize(<span class="string">&quot;10240KB&quot;</span>);</span><br><span class="line">            appender.setMaxBackupIndex(<span class="number">10</span>);</span><br><span class="line">            appender.activateOptions();</span><br><span class="line">            logger.addAppender(appender);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> logger;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.mkyong.com/logging/logback-different-log-file-for-each-thread">logback-different-log-file-for-each-thread</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>业务设计</tag>
        <tag>Logback</tag>
        <tag>SLF4J</tag>
        <tag>Log4j</tag>
      </tags>
  </entry>
  <entry>
    <title>Servlet3.0新特性</title>
    <url>/posts/Servlet3.0.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Servlet3.0</code>使用了注解来配置<code>web</code>应用，极大缩减了<code>web.xml</code>的配置。</p>
<span id="more"></span>

<h1 id="新增注解"><a href="#新增注解" class="headerlink" title="新增注解"></a>新增注解</h1><table>
<thead>
<tr>
<th align="left">注解</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>@WebServlet</code></td>
<td align="left">修饰一个<code>Servlet</code>类</td>
</tr>
<tr>
<td align="left"><code>@WebFilter</code></td>
<td align="left">修饰一个<code>Filter</code>类</td>
</tr>
<tr>
<td align="left"><code>@WebListener</code></td>
<td align="left">修饰一个<code>Listener</code>类</td>
</tr>
<tr>
<td align="left"><code>@WebInitParam</code></td>
<td align="left">为<code>Servlet</code>、<code>Filter</code>类配置参数</td>
</tr>
<tr>
<td align="left"><code>@MultipartConfig</code></td>
<td align="left">指定<code>Servlet</code>处理文件上传</td>
</tr>
</tbody></table>
<h1 id="对Web模块支持"><a href="#对Web模块支持" class="headerlink" title="对Web模块支持"></a>对Web模块支持</h1><p><code>Servlet3.0</code>不再要求所有<code>Web</code>组件全部写在<code>web.xml</code>中。</p>
<p>需要在<code>META-INF</code>中添加<code>Web</code>模块部署描述符<code>web-fragment.xml</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;GBK&quot;</span> ?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-fragment</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">              <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://java.sun.com/xml/ns/javaee</span></span></span><br><span class="line"><span class="string"><span class="tag">               http://java.sun.com/xml/ns/javaee/web-fragment_3_0.xsd</span></span></span><br><span class="line"><span class="string"><span class="tag">              version=&quot;</span><span class="attr">3.0</span>&quot;&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>模块名<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ordering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">after</span>&gt;</span><span class="comment">&lt;!-- 在哪些模块后加载 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>模块1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">others</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- others --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">after</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">before</span>&gt;</span><span class="comment">&lt;!-- 在哪些模块前加载 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>模块2<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">others</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- others --&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">before</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ordering</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 配置Servlet、Filter、Listener --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-fragment</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>也可以在<code>web.xml</code>中指定加载顺序</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">absolute-ordering</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>模块名<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">others</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">absolute-ordering</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="注解配置Web组件"><a href="#注解配置Web组件" class="headerlink" title="注解配置Web组件"></a>注解配置Web组件</h1><blockquote>
<p>不能在<code>web.xml</code>的<code>&lt;web-app/&gt;</code>指定<code>metadata-complete=&quot;true&quot;</code></p>
</blockquote>
<p>如果<code>metadata-complete</code>设置为<code>true</code>，部署工具必须必须忽略存在于应用的类文件中的所有<code>servlet</code>注解和<code>web fragments</code>。<br>如果<code>metadata-complete</code>属性没有指定或设置为<code>false</code>，部署工具必须检查应用的类文件的注解，并扫描<code>web fragments</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Servlet</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@WebFilter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@WebListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyListener</span> <span class="keyword">implements</span> <span class="title class_">ServletContextAttributeListener</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="动态注册Web组件"><a href="#动态注册Web组件" class="headerlink" title="动态注册Web组件"></a>动态注册Web组件</h1><p><code>Servlet3.0</code>提供了<code>ServletContext</code>添加组件的方式</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** 添加Servlet */</span> </span><br><span class="line"><span class="keyword">public</span> ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String servletName, </span></span><br><span class="line"><span class="params">    String className)</span>; </span><br><span class="line"><span class="keyword">public</span> ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String servletName, </span></span><br><span class="line"><span class="params">    Servlet servlet)</span>; </span><br><span class="line"><span class="keyword">public</span> ServletRegistration.Dynamic <span class="title function_">addServlet</span><span class="params">(String servletName, </span></span><br><span class="line"><span class="params">    Class&lt;? extends Servlet&gt; servletClass)</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 添加Filter */</span> </span><br><span class="line"><span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String filterName, </span></span><br><span class="line"><span class="params">    String className)</span>; </span><br><span class="line"><span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String filterName, Filter filter)</span>; </span><br><span class="line"><span class="keyword">public</span> FilterRegistration.Dynamic <span class="title function_">addFilter</span><span class="params">(String filterName, </span></span><br><span class="line"><span class="params">    Class&lt;? extends Filter&gt; filterClass)</span>; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 添加Listener */</span> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(String className)</span>; </span><br><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">EventListener</span>&gt; <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(T t)</span>; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addListener</span><span class="params">(Class&lt;? extends EventListener&gt; listenerClass)</span>;</span><br></pre></td></tr></table></figure>

<h2 id="通过ServletContextListener注册"><a href="#通过ServletContextListener注册" class="headerlink" title="通过ServletContextListener注册"></a>通过ServletContextListener注册</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//这里不用@Servlet注解配置</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InitListener</span> <span class="keyword">implements</span> <span class="title class_">ServletContextListener</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextDestroyed</span><span class="params">(ServletContextEvent event)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;服务器关闭时会调用该方法&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Override</span>  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent event)</span> &#123;  </span><br><span class="line">        System.out.println(<span class="string">&quot;服务器启动时会调用该方法&quot;</span>);  </span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">context</span> <span class="operator">=</span> contextEvent.getServletContext();  </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//注册一个没有使用@WebServlet注解的类为Servlet</span></span><br><span class="line">        <span class="type">ServletRegistration</span> <span class="variable">register</span> <span class="operator">=</span> context.addServlet(<span class="string">&quot;helloServlet&quot;</span>, HelloServlet.class);  </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//为动态注册的Servlet设定访问URL(可设定多个)  </span></span><br><span class="line">        register.addMapping(<span class="string">&quot;/hello&quot;</span>, <span class="string">&quot;/servlet/hello&quot;</span>);  </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//为动态注册的Servlet设定初始参数</span></span><br><span class="line">        <span class="comment">//相当于以前的&lt;init-param&gt;</span></span><br><span class="line">        register.setInitParameter(<span class="string">&quot;logPath&quot;</span>, <span class="string">&quot;/app/log&quot;</span>);  </span><br><span class="line">        register.setInitParameter(<span class="string">&quot;savePath&quot;</span>, <span class="string">&quot;/app/upload&quot;</span>);  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="通过ServletContainerInitializer注册"><a href="#通过ServletContainerInitializer注册" class="headerlink" title="通过ServletContainerInitializer注册"></a>通过ServletContainerInitializer注册</h2><p>添加<code>META-INF/services/javax.servlet.ServletContainerInitializer</code>文件。<br>文件内容为</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">com.ahao.demo.MyServletContainerInitializer</span><br></pre></td></tr></table></figure>
<p>指定自定义的<code>ServletContainerInitializer</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@HandlesTypes(&#123; WebApplicationInitializer.class &#125;)</span> </span><br><span class="line"><span class="comment">//@HandlesTypes(&#123; HttpServlet.class &#125;)</span></span><br><span class="line"><span class="comment">//实现或者继承HandlesTypes注解中的类的都会被加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span> &#123; </span><br><span class="line"></span><br><span class="line">    <span class="comment">//以Set集合的方式传递注解中指定的类型的所有子类(包括子接口、实现类等)的class对象</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; c, ServletContext servletContext)</span></span><br><span class="line">                            <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="comment">// 动态注册Servlet</span></span><br><span class="line">        <span class="type">ServletContext</span> <span class="variable">context</span> <span class="operator">=</span> sce.getServletContext();</span><br><span class="line">        ServletRegistration.<span class="type">Dynamic</span> <span class="variable">servlet</span> <span class="operator">=</span> context.addServlet(<span class="string">&quot;myServlet&quot;</span>, MyServlet.class); </span><br><span class="line">        dynamicServlet.addMapping(<span class="string">&quot;/myServlet&quot;</span>);</span><br><span class="line">        dynamicServlet.setAsyncSupported(<span class="literal">true</span>);</span><br><span class="line">        dynamicServlet.setLoadOnStartup(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 动态注册Filter</span></span><br><span class="line">        FilterRegistration.<span class="type">Dynamic</span> <span class="variable">filter</span> <span class="operator">=</span> context.addFilter(<span class="string">&quot;MyFilter&quot;</span>, MyFilter.class);</span><br><span class="line">        <span class="comment">// 动态注册Listener</span></span><br><span class="line">        context.addListener(<span class="string">&quot;com.ahao.demo.MyListener&quot;</span>);</span><br><span class="line">  &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p><code>HttpServletRequest</code>提供处理文件上传的支持。</p>
<ol>
<li><code>Part getPart(String name)</code></li>
<li><code>Collection&lt;Part&gt; getParts()</code></li>
</ol>
<p><code>Part</code>对应一个文件上传域，支持访问文件类型、大小、输入流等。<br>文件上传需要给<code>form</code>表单添加<code>enctype</code>属性，该属性有三个值：</p>
<table>
<thead>
<tr>
<th align="left">属性值</th>
<th align="left">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>application/x-www-form-urlencoded</code></td>
<td align="left">默认编码方式，对<code>form</code>的<code>value</code>属性进行<code>URL</code>编码</td>
</tr>
<tr>
<td align="left"><code>multipart/form-data</code></td>
<td align="left">二进制方式处理表单数据，上传文件用</td>
</tr>
<tr>
<td align="left"><code>text/plain</code></td>
<td align="left">适用于直接通过表单发送邮件</td>
</tr>
</tbody></table>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;upload&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;myfile&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>Servlet</code>中处理上传数据，使用<code>@MultipartConfig</code>修饰，或者在<code>web.xml</code>中<code>&lt;servlet&gt;</code>标签中添加<code>&lt;multipart-config/&gt;</code>子标签</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(name=&quot;upload&quot;,urlPatterns=&#123;&quot;/upload&quot;&#125;)</span></span><br><span class="line"><span class="meta">@MultipartConfig</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UploadServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="type">Part</span> <span class="variable">part</span> <span class="operator">=</span> request.getPart(<span class="string">&quot;myfile&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;文件类型:&quot;</span>+part.getContentType()+<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">        out.println(<span class="string">&quot;文件大小:&quot;</span>+part.getSize()+<span class="string">&quot;&lt;br/&gt;&quot;</span>);</span><br><span class="line">        part.write(getServletContext().getRealPath(<span class="string">&quot;/uploadFiles&quot;</span>)+<span class="string">&quot;/&quot;</span>+<span class="string">&quot;myfile&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="异步处理"><a href="#异步处理" class="headerlink" title="异步处理"></a>异步处理</h1><blockquote>
<p>支持<code>Servlet</code>、<code>Filter</code>。</p>
</blockquote>
<p>当<code>Servlet</code>执行耗时操作时，必须等完成操作才能生成响应。<br><code>Servlet3.0</code>允许<code>Servlet</code>创建一个线程去执行耗时操作。</p>
<h2 id="先要给Servlet配置允许异步操作"><a href="#先要给Servlet配置允许异步操作" class="headerlink" title="先要给Servlet配置允许异步操作"></a>先要给<code>Servlet</code>配置允许异步操作</h2><ul>
<li>在<code>xml</code>中配置：<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>MyServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">async-supported</span>&gt;</span>true<span class="tag">&lt;/<span class="name">async-supported</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>在注解中配置：<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPattern=&quot;/async&quot;,asyncSupported=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="通过ServletRequest创建AsyncContext对象"><a href="#通过ServletRequest创建AsyncContext对象" class="headerlink" title="通过ServletRequest创建AsyncContext对象"></a>通过ServletRequest创建AsyncContext对象</h2><p>通过<code>AsyncContext</code>类实现，重复调用创建方法得到同一个<code>AsyncContext</code>对象。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@WebServlet(urlPattern=&quot;/async&quot;,asyncSupported=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AsyncServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest request,HttpServletResponse response)</span>&#123;</span><br><span class="line">        <span class="type">AsyncContext</span> <span class="variable">actx</span> <span class="operator">=</span> request.startAsync();</span><br><span class="line">        <span class="comment">//AsyncContext actx = reuqets.startAsync(request,response);</span></span><br><span class="line">        actx.setTimeout(<span class="number">3000</span>);<span class="comment">//设置超时时间</span></span><br><span class="line">        actx.start(<span class="keyword">new</span> <span class="title class_">Executor</span>(actx));<span class="comment">//启用线程</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="异步监听"><a href="#异步监听" class="headerlink" title="异步监听"></a>异步监听</h2><p>当需要了解异步操作执行细节时，可以使用<code>AsyncListener</code>监听器。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//actx.addListener(new MyAsyncListener());</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAsyncListener</span> <span class="keyword">implements</span> <span class="title class_">AsyncListener</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartAsync</span><span class="params">(AsyncContext event)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;异步调用开始&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">(AsyncContext event)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;异步调用完成&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(AsyncContext event)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;异步调用异常&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimeout</span><span class="params">(AsyncContext event)</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;异步调用超时&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Servlet</tag>
      </tags>
  </entry>
  <entry>
    <title>Servlet基本使用</title>
    <url>/posts/Servlet_usage.html</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><code>Servlet</code>是用<code>Java</code>编写的服务器端程序。<br>其主要功能在于交互式地浏览和修改数据，生成动态<code>Web</code>内容。<br>狭义的<code>Servlet</code>是指<code>Java</code>语言实现的一个接口，广义的<code>Servlet</code>是指任何实现了这个<code>Servlet</code>接口的类，<br>一般情况下，人们将<code>Servlet</code>理解为后者。</p>
<span id="more"></span>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><ul>
<li>实现<code>javax.servlet.Servlet</code>接口</li>
<li>继承<code>javax.servlet.GenericServlet</code>抽象类（实现了<code>Servlet</code>接口）</li>
<li>继承<code>javax.servlet.http.HttpServlet</code>类（继承自<code>GenericServlet</code>类）（推荐）</li>
</ul>
<p>先写一个类继承自<code>HttpServlet</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//处理get请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="comment">//处理post请求</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并在<code>web.xml</code>中配置<code>Servlet</code>，对应在<code>ServletConfig</code>类中</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_3_1.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;3.1&quot;</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>myServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span>                                   <span class="comment">&lt;!--自己命名的Servlet名称--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>com.ahao.javaeeDemo.MyServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span> <span class="comment">&lt;!--Servlet所对应的类，用于反射创建--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>0<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span> <span class="comment">&lt;!--服务器开始就创建Servlet，整型数代表加载优先级--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span> <span class="comment">&lt;!--一个参数对应一个init-param标签--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>myParam<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span> <span class="comment">&lt;!--初始化参数名--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>第一个参数<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span> <span class="comment">&lt;!--初始化参数值--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>myServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span> <span class="comment">&lt;!--自己命名的Servlet名称--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/myServlet<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>      <span class="comment">&lt;!--访问Servlet的url路径，可以设置多个--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="web-xml介绍"><a href="#web-xml介绍" class="headerlink" title="web.xml介绍"></a>web.xml介绍</h1><p>所有项目的<code>web.xml</code>都有一个父的<code>web.xml</code>，位于<code>Tomcat/conf/web.xml</code><br>其中有两个默认的<code>Servlet</code></p>
<ul>
<li><code>default</code>：解析<code>/</code>的<code>url</code>地址，即所有<code>servlet</code>都不匹配时，执行<code>default</code>，返回<code>404</code>等各种错误</li>
<li><code>jsp</code>：解析<code>jsp</code>后缀的<code>url</code>地址</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--==================default Servlet======================--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.catalina.servlets.DefaultServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>debug<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>0<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>listings<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>default<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--==================default Servlet======================--&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--==================JSP Servlet======================--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.jasper.servlet.JspServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>fork<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>xpoweredBy<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>3<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>jsp<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jsp<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>*.jspx<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--==================JSP Servlet======================--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Servlet</tag>
      </tags>
  </entry>
  <entry>
    <title>Shiro用户登陆后会话标识未更新漏洞</title>
    <url>/posts/Shiro_not_update_session_id_after_login.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是我在以前遇到的问题了, 当时做的是政府项目, 对<code>Web</code>安全要求比较高.<br>使用<code>Shiro</code>的项目被安全准入检测出<strong>用户登陆后会话标识未更新漏洞</strong>.<br>意思是登录前的<code>Session</code>和登录后的<code>Session</code>一样。</p>
<span id="more"></span>

<h1 id="官方修复无望-自己打补丁"><a href="#官方修复无望-自己打补丁" class="headerlink" title="官方修复无望, 自己打补丁"></a>官方修复无望, 自己打补丁</h1><p><code>2010-05-24</code>提出的<a href="https://issues.apache.org/jira/browse/SHIRO-170">SHIRO-170</a>, 至今<code>2019-03-27</code>仍然未解决.<br>看来修复无望了, 但是勤劳的人民给出了临时性的解决方案.<br>那就是在登录时, 先销毁<code>session</code>, 再<code>login</code>.<br>主要步骤如下:</p>
<ol>
<li>获取<code>session</code>, 保存<code>session</code>中的属性<code>Map</code></li>
<li><code>session.stop()</code>销毁</li>
<li>进行登录<code>subject.login(token)</code></li>
<li>将之前保存的属性<code>Map</code>, 重新注入新的<code>session</code></li>
</ol>
<p>具体代码可以查看我的个人代码库<a href="https://github.com/Ahaochan/project/blob/master/ahao-web/src/main/java/com/ahao/rbac/shiro/LoginController.java#L91-L113">LoginController.java#L91-L113</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://issues.apache.org/jira/browse/SHIRO-170">Force New Session ID on Authentication</a></li>
<li><a href="https://blog.csdn.net/yycdaizi/article/details/45013397">解决shiro会话标识未更新问题</a></li>
<li><a href="https://stackoverflow.com/a/30672822/6335926">Shiro complaining “There is no session with id xxx” with DefaultSecurityManager</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>业务设计</tag>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring MVC同时支持驼峰和下划线</title>
    <url>/posts/Support_both_snake_case_and_camelCase_in_Spring_MVC.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>PHP</code>是下划线命名变量, <code>Java</code>是驼峰命名变量.<br>对于前端来说, 服务端有两种命名规则, 这是不合理的, 他们希望有一种统一的命名规则.</p>
<span id="more"></span>

<h1 id="歪路1-用ObjectMapper在Controller层做转换"><a href="#歪路1-用ObjectMapper在Controller层做转换" class="headerlink" title="歪路1: 用ObjectMapper在Controller层做转换"></a>歪路1: 用ObjectMapper在Controller层做转换</h1><p>为了赶进度, 我直接在<code>Controller</code>层做了转换.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/post1&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">post1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="type">MyObj</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObj</span>();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 创建一个 SNAKE_CASE 下划线风格的 ObjectMapper, 转为 Map</span></span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">om</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>();</span><br><span class="line">        om.setPropertyNamingStrategy(PropertyNamingStrategy.SNAKE_CASE);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> om.convertValue(result, <span class="keyword">new</span> <span class="title class_">TypeReference</span>&lt;Map&lt;String, Object&gt;&gt;() &#123;&#125;);</span><br><span class="line">        <span class="keyword">return</span> o;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题迎刃而解, 简单粗暴.<br>但是这里有个待优化的地方</p>
<ol>
<li>每个方法都要写一套转换代码, 就算转成<code>AOP</code>的实现, 也不够优雅</li>
<li>每次都要<code>new ObjectMapper()</code>和转换.</li>
</ol>
<h1 id="歪路2-Hack-ResponseBody-处理器"><a href="#歪路2-Hack-ResponseBody-处理器" class="headerlink" title="歪路2: Hack @ResponseBody 处理器"></a>歪路2: Hack @ResponseBody 处理器</h1><p><code>Jackson</code>提供了一个<code>@JsonNaming</code>的注解, 用于修饰<code>POJO</code>的序列化命名方式.<br>但是这个<code>@JsonNaming</code>注解只能修饰在类上, 不能修饰在方法级别.</p>
<p>我们猜测, 可以创建一个<code>@MyJsonNaming</code>的注解, 仿照<code>@ResponseBody</code>处理器对返回体做处理.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/post2&quot;)</span></span><br><span class="line">    <span class="meta">@MyJsonNaming(PropertyNamingStrategy.SnakeCaseStrategy.class)</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">post2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取数据</span></span><br><span class="line">        <span class="type">MyObj</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyObj</span>();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们看看<code>Spring MVC</code>是怎么拦截<code>@ResponseBody</code>注解的?</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerAdapter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestMappingHandlerAdapter</span> <span class="keyword">extends</span> <span class="title class_">AbstractHandlerMethodAdapter</span> <span class="keyword">implements</span> <span class="title class_">BeanFactoryAware</span>, InitializingBean &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterPropertiesSet</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 省略其他代码</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.returnValueHandlers == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 这里初始化一堆默认的返回值处理器, 其中就包括了 @ResponseBody 的处理器</span></span><br><span class="line">            List&lt;HandlerMethodReturnValueHandler&gt; handlers = getDefaultReturnValueHandlers();</span><br><span class="line">            <span class="built_in">this</span>.returnValueHandlers = <span class="keyword">new</span> <span class="title class_">HandlerMethodReturnValueHandlerComposite</span>().addHandlers(handlers);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> List&lt;HandlerMethodReturnValueHandler&gt; <span class="title function_">getDefaultReturnValueHandlers</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;HandlerMethodReturnValueHandler&gt; handlers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 省略其他代码</span></span><br><span class="line">        handlers.add(<span class="keyword">new</span> <span class="title class_">RequestResponseBodyMethodProcessor</span>(getMessageConverters(), <span class="built_in">this</span>.contentNegotiationManager, <span class="built_in">this</span>.requestResponseBodyAdvice));</span><br><span class="line">        <span class="comment">// WebMvcConfigurer 自定义处理器</span></span><br><span class="line">        <span class="keyword">if</span> (getCustomReturnValueHandlers() != <span class="literal">null</span>) &#123;</span><br><span class="line">            handlers.addAll(getCustomReturnValueHandlers());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> handlers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里就有个问题了, 我通过实现<code>WebMvcConfigurer</code>自定义的处理器, 它的优先级永远比<code>RequestResponseBodyMethodProcessor</code>处理器的优先级要低.<br>也就是说, 我如果想使用<code>@MyJsonNaming</code>注解覆盖<code>@ResponseBody</code>的处理逻辑, 只能这样做.</p>
<ol>
<li>所有代码里, 不允许使用<code>@ResponseBody</code>和<code>@RestController</code>, 只允许使用<code>@MyJsonNaming</code>. 这是不可能也不允许的事情.</li>
<li>使用<code>BeanPostProcessor</code>调整<code>RequestMappingHandlerAdapter</code>的<code>HandlerMethodReturnValueHandler</code>列表顺序. 看起来可行, 但总感觉走了弯路.</li>
</ol>
<p>并且这样也有弊端, 如果同一个接口, 前端想用下划线的命名格式, 另一个<code>Java</code>服务想用驼峰的命名格式.<br>使用这种方式也实现不了.</p>
<h1 id="正解-使用Accept请求头决定响应体是驼峰还是下划线"><a href="#正解-使用Accept请求头决定响应体是驼峰还是下划线" class="headerlink" title="正解: 使用Accept请求头决定响应体是驼峰还是下划线"></a>正解: 使用Accept请求头决定响应体是驼峰还是下划线</h1><p>换个思路, <code>Spring MVC</code>是支持<code>xml</code>和<code>json</code>的返回格式的.<br><code>Spring MVC</code>里面是怎么做到同一套代码支持不同的返回格式的? 本质上我们这个需求也是不同的返回格式.<br>我们前面已经知道, <code>@ResponseBody</code>的处理类是<code>RequestResponseBodyMethodProcessor</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestResponseBodyMethodProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractMessageConverterMethodProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line">        <span class="comment">// 调用父类的方法</span></span><br><span class="line">        <span class="built_in">super</span>.writeWithMessageConverters(returnValue, returnType, inputMessage, outputMessage);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractMessageConverterMethodProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractMessageConverterMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodReturnValueHandler</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; <span class="keyword">void</span> <span class="title function_">writeWithMessageConverters</span><span class="params">(T value, MethodParameter returnType, ServletServerHttpRequest inputMessage, ServletServerHttpResponse outputMessage)</span> <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line">        <span class="comment">// 省略其他代码</span></span><br><span class="line">        <span class="comment">// 1. 获取请求头的 Accept</span></span><br><span class="line">        <span class="type">MediaType</span> <span class="variable">selectedMediaType</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// 2. 遍历 messageConverters, 找到支持该 MediaType 的 HttpMessageConverter 实现</span></span><br><span class="line">        <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="built_in">this</span>.messageConverters) &#123;</span><br><span class="line">            <span class="type">GenericHttpMessageConverter</span> <span class="variable">genericConverter</span> <span class="operator">=</span> (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (genericConverter != <span class="literal">null</span> ? ((GenericHttpMessageConverter) converter).canWrite(targetType, valueType, selectedMediaType) : converter.canWrite(valueType, selectedMediaType)) &#123;</span><br><span class="line">               <span class="keyword">if</span> (genericConverter != <span class="literal">null</span>) &#123;</span><br><span class="line">                   genericConverter.write(body, targetType, selectedMediaType, outputMessage);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   ((HttpMessageConverter) converter).write(body, selectedMediaType, outputMessage);</span><br><span class="line">               &#125;</span><br><span class="line">                <span class="keyword">return</span>; <span class="comment">// 注意这里!!! 匹配上就直接return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最终请求头<code>Accept:application/json</code>会匹配到<code>MappingJackson2HttpMessageConverter</code>.<br>它支持<code>application/json</code>和<code>application/*+json</code>, 注意这个通配符, 它会导致下面我的自定义请求头失效.<br>因为 <code>HttpMessageConverter</code> 匹配到第一个就直接 <code>return</code> 了.</p>
<table>
<thead>
<tr>
<th align="center">请求头</th>
<th align="center">例子</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>application/vnd.snake.case+json</code></td>
<td align="center"><code>my_name</code></td>
</tr>
<tr>
<td align="center"><code>application/vnd.upper.camel.case+json</code></td>
<td align="center"><code>MyName</code></td>
</tr>
<tr>
<td align="center"><code>application/vnd.lower.camel.case+json</code></td>
<td align="center"><code>myName</code></td>
</tr>
<tr>
<td align="center"><code>application/vnd.lower.case+json</code></td>
<td align="center"><code>myname</code></td>
</tr>
<tr>
<td align="center"><code>application/vnd.kebab+json</code></td>
<td align="center"><code>my-name</code></td>
</tr>
<tr>
<td align="center"><code>application/vnd.lower.dot+json</code></td>
<td align="center"><code>my.name</code></td>
</tr>
</tbody></table>
<p>所以我们要做几个事情</p>
<ol>
<li>修改原有的<code>MappingJackson2HttpMessageConverter</code>, 让它只支持<code>application/json</code></li>
<li>在原有的<code>MappingJackson2HttpMessageConverter</code>后面追加我的自定义请求体的<code>MessageConverter</code>实现类.</li>
<li>在最后添加一个处理<code>application/*+json</code>的兜底<code>MessageConverter</code>实现类.</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://github.com/Ahaochan/ahao-common-utils/blob/master/src/main/java/com/ahao/spring/web/config/JacksonHttpMessageConvertersWebMvcConfigurer.java</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JacksonHttpMessageConvertersWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 覆盖 &#123;<span class="doctag">@link</span> JacksonHttpMessageConvertersConfiguration&#125; 的配置, 移除 application/*+json 的支持</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> JacksonHttpMessageConvertersConfiguration.MappingJackson2HttpMessageConverterConfiguration#mappingJackson2HttpMessageConverter(com.fasterxml.jackson.databind.ObjectMapper)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MappingJackson2HttpMessageConverter <span class="title function_">mappingJackson2HttpMessageConverter</span><span class="params">(ObjectMapper objectMapper)</span> &#123;</span><br><span class="line">        <span class="type">MappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MappingJackson2HttpMessageConverter</span>(objectMapper);</span><br><span class="line">        List&lt;MediaType&gt; mediaTypes = Arrays.asList(</span><br><span class="line">            MediaType.APPLICATION_JSON</span><br><span class="line">            <span class="comment">// new MediaType(&quot;application&quot;, &quot;*+json&quot;) // 移除 application/*+json 的支持</span></span><br><span class="line">        );</span><br><span class="line">        converter.setSupportedMediaTypes(mediaTypes);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureMessageConverters</span><span class="params">(List&lt;HttpMessageConverter&lt;?&gt;&gt; converters)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 找到插入位置</span></span><br><span class="line">        List&lt;MediaType&gt; exceptMediaTypes = Collections.singletonList(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; converters.size(); i++) &#123;</span><br><span class="line">            HttpMessageConverter&lt;?&gt; converter = converters.get(i);</span><br><span class="line">            <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> MappingJackson2HttpMessageConverter) &#123;</span><br><span class="line">                index = i;</span><br><span class="line">                List&lt;MediaType&gt; supportedMediaTypes = converter.getSupportedMediaTypes();</span><br><span class="line">                Assert.isTrue(Objects.equals(exceptMediaTypes, supportedMediaTypes), <span class="string">&quot;第 1 个 MappingJackson2HttpMessageConverter 支持的 MediaType:&quot;</span> + supportedMediaTypes + <span class="string">&quot;应为&quot;</span> + exceptMediaTypes);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        index++;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 补充多种 PropertyNamingStrategy</span></span><br><span class="line">        <span class="type">PropertyNamingStrategy</span> <span class="variable">strategy</span> <span class="operator">=</span> PropertyNamingStrategy.SNAKE_CASE;</span><br><span class="line">        <span class="type">ObjectMapper</span> <span class="variable">clone</span> <span class="operator">=</span> objectMapper.copy();</span><br><span class="line">        clone.setPropertyNamingStrategy(strategy);</span><br><span class="line"></span><br><span class="line">        <span class="type">MediaType</span> <span class="variable">mediaType</span> <span class="operator">=</span> ExtMappingJackson2HttpMessageConverter.createMediaType(strategy);</span><br><span class="line">        <span class="type">ExtMappingJackson2HttpMessageConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExtMappingJackson2HttpMessageConverter</span>(clone, mediaType);</span><br><span class="line"></span><br><span class="line">        converters.add(index, converter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此, 响应体已经能根据请求头<code>Accept</code>来判断返回的数据格式是下划线命名还是驼峰命名了.</p>
<h1 id="正解-使用Content-Type请求头决定请求体是驼峰还是下划线"><a href="#正解-使用Content-Type请求头决定请求体是驼峰还是下划线" class="headerlink" title="正解: 使用Content-Type请求头决定请求体是驼峰还是下划线"></a>正解: 使用Content-Type请求头决定请求体是驼峰还是下划线</h1><p>请求参数也一样可以根据请求头<code>Content-Type</code>来判断.<br>还是<code>RequestResponseBodyMethodProcessor</code>这个类来处理.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.RequestResponseBodyMethodProcessor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestResponseBodyMethodProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractMessageConverterMethodProcessor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleReturnValue</span><span class="params">(<span class="meta">@Nullable</span> Object returnValue, MethodParameter returnType, ModelAndViewContainer mavContainer, NativeWebRequest webRequest)</span> <span class="keyword">throws</span> IOException, HttpMediaTypeNotAcceptableException, HttpMessageNotWritableException &#123;</span><br><span class="line">        <span class="comment">// 调用父类的方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">arg</span> <span class="operator">=</span> readWithMessageConverters(inputMessage, parameter, paramType);</span><br><span class="line">        <span class="keyword">return</span> arg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.AbstractMessageConverterMethodProcessor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractMessageConverterMethodProcessor</span> <span class="keyword">extends</span> <span class="title class_">AbstractMessageConverterMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodReturnValueHandler</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; Object <span class="title function_">readWithMessageConverters</span><span class="params">(HttpInputMessage inputMessage, MethodParameter parameter, Type targetType)</span> <span class="keyword">throws</span> IOException, HttpMediaTypeNotSupportedException, HttpMessageNotReadableException &#123;</span><br><span class="line">        <span class="comment">// 省略其他代码</span></span><br><span class="line">        <span class="comment">// 1. 获取请求头的 Content-Type</span></span><br><span class="line">        <span class="type">MediaType</span> <span class="variable">contentType</span> <span class="operator">=</span> inputMessage.getHeaders().getContentType();</span><br><span class="line">       </span><br><span class="line">        <span class="comment">// 2. 遍历 messageConverters, 找到支持该 MediaType 的 HttpMessageConverter 实现</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">body</span> <span class="operator">=</span> NO_VALUE;</span><br><span class="line">        <span class="type">EmptyBodyCheckingHttpInputMessage</span> <span class="variable">message</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EmptyBodyCheckingHttpInputMessage</span>(inputMessage);</span><br><span class="line">        <span class="keyword">for</span> (HttpMessageConverter&lt;?&gt; converter : <span class="built_in">this</span>.messageConverters) &#123;</span><br><span class="line">            Class&lt;HttpMessageConverter&lt;?&gt;&gt; converterType = (Class&lt;HttpMessageConverter&lt;?&gt;&gt;) converter.getClass();</span><br><span class="line">            GenericHttpMessageConverter&lt;?&gt; genericConverter = (converter <span class="keyword">instanceof</span> GenericHttpMessageConverter ? (GenericHttpMessageConverter&lt;?&gt;) converter : <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">if</span> (genericConverter != <span class="literal">null</span> ? genericConverter.canRead(targetType, contextClass, contentType) : (targetClass != <span class="literal">null</span> &amp;&amp; converter.canRead(targetClass, contentType))) &#123;</span><br><span class="line">                <span class="keyword">if</span> (message.hasBody()) &#123;</span><br><span class="line">                    body = (genericConverter != <span class="literal">null</span> ? genericConverter.read(targetType, contextClass, msgToUse) : ((HttpMessageConverter&lt;T&gt;) converter).read(targetClass, msgToUse));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>; <span class="comment">// 注意这里!!! 匹配上就直接return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> body;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到和响应体的处理逻辑差不多, 也是筛选<code>MessageConverter</code>.<br>那么我们之前的配置, 也可以派上用场了. 直接在请求头<code>Content-Type</code>添加自定义的参数即可.</p>
<h1 id="自定义-MessageConverter-不能处理的情况"><a href="#自定义-MessageConverter-不能处理的情况" class="headerlink" title="自定义 MessageConverter 不能处理的情况"></a>自定义 MessageConverter 不能处理的情况</h1><p>现在的<code>Web</code>开发, 基本都是前后端分离的架构, 所以基本每个请求都是用<code>@ResponseBody</code>修饰的.<br>但是请求的话, 不一定都是<code>application/json</code>的请求, 也不一定都是<code>@RequestBody</code>修饰的请求参数.</p>
<p>对于客户端来说, 它可能会发送<code>GET</code>请求过来, 也可能发请求头为<code>application/x-www-form-urlencoded</code>的请求过来, 也可能发请求头为<code>application/json</code>的请求过来.</p>
<h2 id="GET-请求如何处理"><a href="#GET-请求如何处理" class="headerlink" title="GET 请求如何处理"></a>GET 请求如何处理</h2><p>对于<code>GET</code>请求, 会走<code>RequestParamMethodArgumentResolver</code>这个参数处理器.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.method.annotation.AbstractNamedValueMethodArgumentResolver</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractNamedValueMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">HandlerMethodArgumentResolver</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> NamedValueInfo <span class="title function_">getNamedValueInfo</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 交给子类实现, 从 @RequestParam 获取参数名</span></span><br><span class="line">        <span class="type">NamedValueInfo</span> <span class="variable">namedValueInfo</span> <span class="operator">=</span> createNamedValueInfo(parameter);</span><br><span class="line">        <span class="comment">// 2. 如果没有配置 @RequestParam, 就反射获取变量名</span></span><br><span class="line">        namedValueInfo = updateNamedValueInfo(parameter, namedValueInfo);</span><br><span class="line">        <span class="keyword">return</span> namedValueInfo;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> NamedValueInfo <span class="title function_">updateNamedValueInfo</span><span class="params">(MethodParameter parameter, NamedValueInfo info)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> info.name;</span><br><span class="line">        <span class="keyword">if</span> (info.name.isEmpty()) &#123;</span><br><span class="line">            name = parameter.getParameterName();</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">String</span> <span class="variable">defaultValue</span> <span class="operator">=</span> (ValueConstants.DEFAULT_NONE.equals(info.defaultValue) ? <span class="literal">null</span> : info.defaultValue);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">NamedValueInfo</span>(name, info.required, defaultValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.web.method.annotation.RequestParamMethodArgumentResolver</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestParamMethodArgumentResolver</span> <span class="keyword">extends</span> <span class="title class_">AbstractNamedValueMethodArgumentResolver</span> <span class="keyword">implements</span> <span class="title class_">UriComponentsContributor</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> NamedValueInfo <span class="title function_">createNamedValueInfo</span><span class="params">(MethodParameter parameter)</span> &#123;</span><br><span class="line">        <span class="comment">// 从 @RequestParam 获取参数名</span></span><br><span class="line">        <span class="type">RequestParam</span> <span class="variable">ann</span> <span class="operator">=</span> parameter.getParameterAnnotation(RequestParam.class);</span><br><span class="line">        <span class="keyword">return</span> (ann != <span class="literal">null</span> ? <span class="keyword">new</span> <span class="title class_">RequestParamNamedValueInfo</span>(ann) : <span class="keyword">new</span> <span class="title class_">RequestParamNamedValueInfo</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>GET</code> 请求并不会根据请求头<code>Content-Type</code>的不同而选择不同的命名规则. 代码里写的是什么就是什么.<br>如果想让<code>GET</code>请求也支持根据请求头<code>Content-Type</code>选择不同的命名规则, 只能写一个<strong>过滤器</strong>来处理了.<br>可以参考这个实现: <a href="https://gist.github.com/azhawkes/3db84b194b3e47423df2">https://gist.github.com/azhawkes/3db84b194b3e47423df2</a></p>
<h2 id="Content-Type-application-x-www-form-urlencoded-请求如何处理"><a href="#Content-Type-application-x-www-form-urlencoded-请求如何处理" class="headerlink" title="Content-Type: application/x-www-form-urlencoded 请求如何处理"></a>Content-Type: application/x-www-form-urlencoded 请求如何处理</h2><p><code>form data</code>的请求方式会走<code>ModelAttributeMethodProcessor</code>这个参数处理器.<br>同样的也不会受请求头<code>Content-Type</code>影响, 代码里写的是什么参数就是什么参数.<br>同样也只能写一个<strong>过滤器</strong>来处理.</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>从<code>RequestResponseBodyMethodProcessor</code>这个处理器的名字也可以看出, 它只支持<code>@RequestBody</code>和<code>@ResponseBody</code>.<br>其他格式的请求参数, 就只能用过滤器的形式<code>Hack</code>了.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.baeldung.com/spring-httpmessageconverter-rest">Http Message Converters with the Spring Framework</a></li>
<li><a href="https://stackoverflow.com/a/43085405">Hot to make jackson to use snake_case / camelCase on demand in a Spring Boot REST API?</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBean详解</title>
    <url>/posts/Spring_Bean.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在<code>Spring</code>中，类的创建不再由<code>new</code>进行，而是交给<code>Spring</code>通过<code>xml</code>文件进行反射创建，这种叫做控制反转<code>IoC</code>(<code>Inversion of Control</code>)，也叫做依赖注入<code>DI</code>(<code>Dependency Injection</code>)。</p>
<span id="more"></span>
<h1 id="简单的Bean例子"><a href="#简单的Bean例子" class="headerlink" title="简单的Bean例子"></a>简单的Bean例子</h1><p>导入<a href="https://mvnrepository.com/artifact/org.springframework/spring-context/4.3.6.RELEASE">maven项目</a><br>创建一个<code>Person</code>类，并在xml中配置bean信息</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;gbk&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns</span>=<span class="string">&quot;http://www.springframework.org/schema/beans&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;</span></span></span><br><span class="line"><span class="tag">&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;personId&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.Person&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;张三&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;age&quot;</span> <span class="attr">value</span>=<span class="string">&quot;12&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在测试类中通过<code>ApplicationContext</code>进行创建对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testGetPerson</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-bean.xml&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> ac.getBean(<span class="string">&quot;personId&quot;</span>, Person.class);</span><br><span class="line">    System.out.println(p1.getName()+<span class="string">&quot;,&quot;</span>+p1.getAge());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Bean的生命周期"><a href="#Bean的生命周期" class="headerlink" title="Bean的生命周期"></a>Bean的生命周期</h1><ol>
<li>Bean先new进行<code>实例化</code></li>
<li>然后<code>注入属性</code>。</li>
<li>若实现了<code>BeanNameAware</code>接口，将Bean的<code>ID</code>传入<code>setBeanName()</code>方法。</li>
<li>若实现了<code>BeanFactoryAware</code>接口，将BeanFactory容器实例传入<code>setBeanFactory()</code>方法。</li>
<li>若实现了<code>ApplicationContextAware</code>接口，通过<code>setApplicationContext()</code>方法获取应用上下文。</li>
<li>调用<code>BeanPostProcessor</code>后处理器的预初始化方法。</li>
<li>调用<code>InitializingBean</code>接口<code>afterPropertiesSet()</code>方法。</li>
<li>配置文件<code>bean</code>标签下的<code>init-method</code>属性指定的<code>方法</code>。</li>
<li>配置文件<code>beans</code>标签下的<code>default-init-method</code>全局属性指定的<code>方法</code>。</li>
<li>调用<code>BeanPostProcessor</code>后处理器的预初始化后方法。</li>
<li>使用Bean</li>
<li>调用<code>DisposableBean</code>接口<code>destory</code>方法。</li>
<li>配置文件<code>bean</code>标签下的<code>destory-method</code>属性指定的<code>方法</code>。</li>
<li>配置文件<code>beans</code>标签下的<code>default-destory-method</code>全局属性指定的<code>方法</code>。</li>
</ol>
<h1 id="Bean的创建"><a href="#Bean的创建" class="headerlink" title="Bean的创建"></a>Bean的创建</h1><p><code>Bean</code>的创建都交由<code>xml</code>配置文件执行，获取<code>Bean</code>实例都是通过<code>getBean</code>方法进行。</p>
<h2 id="普通new创建"><a href="#普通new创建" class="headerlink" title="普通new创建"></a>普通new创建</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.bean.Person&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="静态工厂创建"><a href="#静态工厂创建" class="headerlink" title="静态工厂创建"></a>静态工厂创建</h2><p>需要一个静态工厂类</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Person <span class="title function_">getPerson</span><span class="params">(String type)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(type.equals(<span class="string">&quot;chinese&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Chinese</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>xml</code>文件中配置，指定<code>factory-method</code>属性，获取实例用<code>getBean()</code>方法即可</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;chinese&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.factory.PersonFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getPerson&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;chinese&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;axe&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;steelAxe&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="实例工厂创建"><a href="#实例工厂创建" class="headerlink" title="实例工厂创建"></a>实例工厂创建</h2><p>需要一个工厂类，注意这里和静态工厂的不同是不用<code>static</code>修饰方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BeanFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">getPerson</span><span class="params">(String type)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(type.equals(<span class="string">&quot;chinese&quot;</span>))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Chinese</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>xml</code>文件中配置，指定<code>factory-method</code>属性，获取实例用<code>getBean()</code>方法即可</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;personFactory&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.factory.PersonFactory&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;chinese&quot;</span> <span class="attr">factory-bean</span>=<span class="string">&quot;personFactory&quot;</span> <span class="attr">factory-method</span>=<span class="string">&quot;getPerson&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">&quot;chinese&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;axe&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;steelAxe&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="工厂Bean创建"><a href="#工厂Bean创建" class="headerlink" title="工厂Bean创建"></a>工厂Bean创建</h2><p>工厂<code>Bean</code>继承自<code>FactoryBean</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PersonFactory</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Person&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> Person person;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Person <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span>(person == <span class="literal">null</span>)&#123;</span><br><span class="line">            person = <span class="keyword">new</span> <span class="title class_">Chinese</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> person;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getObjectType() &#123;</span><br><span class="line">        <span class="keyword">return</span> person.getClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSingleton</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>spring-bean.xml</code>中配置，获取<code>BeanFactory</code>时使用<code>&amp;chinese</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;chinese&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.factory.PersonFactory&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>和上面一样使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testEvent</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">ac</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathXmlApplicationContext</span>(<span class="string">&quot;spring-bean.xml&quot;</span>);</span><br><span class="line">    <span class="type">Person</span> <span class="variable">p1</span> <span class="operator">=</span> ac.getBean(<span class="string">&quot;chinese&quot;</span>, Person.class);</span><br><span class="line">    p1.setAxe(<span class="keyword">new</span> <span class="title class_">StoneAxe</span>());</span><br><span class="line">    p1.useAxe();</span><br><span class="line">    System.out.print(ac.getBean(<span class="string">&quot;&amp;chinese&quot;</span>));<span class="comment">//获取BeanFactory</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="scope作用域"><a href="#scope作用域" class="headerlink" title="scope作用域"></a>scope作用域</h1><p>在<code>bean</code>标签中的<code>scope</code>属性有五个值</p>
<ul>
<li><code>singleton</code>：单例模式，整个Spring容器中只有一个实例</li>
<li><code>prototype</code>：原型模式，每次通过getBean方法都将产生一个新的实例</li>
<li><code>request</code>：对每次request请求，都会产生一个新的实例</li>
<li><code>session</code>：对每次session会话，都会产生一个新的实例</li>
<li><code>global session</code>：<a href="https://stackoverflow.com/questions/15407038/spring-bean-scopes-session-and-globalsession">spring-bean-scopes-session-and-globalsession</a><br>其中<code>request</code>、<code>session</code><br>在<code>Servlet2.4</code>以上要在<code>web.xml</code>中配置<code>Listener</code><br>在<code>Servlet2.4</code>以下要在<code>web.xml</code>中配置<code>Filter</code><br>并且要导入<a href="https://mvnrepository.com/artifact/org.springframework/spring-web">maven项目</a><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span><span class="comment">&lt;!--Servlet2.4以上--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.request.RequestContextListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span><span class="comment">&lt;!--Servlet2.4以下--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>requestContextFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.RequestContextFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>requestContextFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="自动装配注入"><a href="#自动装配注入" class="headerlink" title="自动装配注入"></a>自动装配注入</h1><p>自动装配减少了配置文件的工作量，但降低了依赖关系的透明性和清晰性。<br>显示指定的依赖会覆盖自动装配的依赖</p>
<h2 id="byName规则"><a href="#byName规则" class="headerlink" title="byName规则"></a>byName规则</h2><p>在<code>bean</code>标签添加<code>autowire=&quot;byName&quot;</code>属性，当<code>A</code>类中有<code>setB</code>方法，且<code>beans</code>中有<code>id</code>为<code>b</code>的<code>bean</code>，则自动装配注入。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.bean.Person&quot;</span> <span class="attr">autoWire</span>=<span class="string">&quot;byName&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;axe&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.bean.StoneAxe&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="byType规则"><a href="#byType规则" class="headerlink" title="byType规则"></a>byType规则</h2><p>在<code>bean</code>标签添加<code>autowire=&quot;byType&quot;</code>属性，当<code>A</code>类中有<code>B</code>类型的<code>Field</code>，且<code>beans</code>中只有一个<code>B</code>类型或者<code>B</code>的子类型的<code>bean</code>，则自动装配注入。<br>如果有多个匹配的<code>bean</code>，则抛出异常，使用<code>autowire-candidate=&quot;false&quot;</code>即可忽略该<code>bean</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;person&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.bean.Person&quot;</span> <span class="attr">autoWire</span>=<span class="string">&quot;byType&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.bean.StoneAxe&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;steelAxe&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.bean.SteelAxe&quot;</span> <span class="attr">autowire-candidate</span>=<span class="string">&quot;false&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC支持跨域访问</title>
    <url>/posts/Cross_domain_access_in_Spring_MVC.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ajax的跨域访问, Spring MVC提供了使用AOP的解决方案。</p>
<span id="more"></span>

<h1 id="什么是跨域访问"><a href="#什么是跨域访问" class="headerlink" title="什么是跨域访问"></a>什么是跨域访问</h1><p>比如我现在在 <code>http://a.com</code> 中, 要访问 <code>http://b.com</code>, 这就是跨域访问。<br>而一般的 <code>AJAX</code> 是不允许跨域访问的。<br>网上关于跨域的说明有很多, 简单的说, 只要 <code>com</code> 之前的内容不一致, 就叫跨域访问。</p>
<h1 id="JSONP的解决方案-只支持GET"><a href="#JSONP的解决方案-只支持GET" class="headerlink" title="JSONP的解决方案(只支持GET)"></a>JSONP的解决方案(只支持GET)</h1><h2 id="Spring-MVC解决方案"><a href="#Spring-MVC解决方案" class="headerlink" title="Spring MVC解决方案"></a>Spring MVC解决方案</h2><p><strong>注意Spring MVC的版本要4.1以上</strong><br>先配置 <code>spring.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span> &gt;</span></span><br><span class="line">    <span class="comment">&lt;!--扫描aop相关的bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.nine.rivers.galaxy&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 只扫描aop --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.web.bind.annotation.ControllerAdvice&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>添加一个 <code>Advice</code> 和一个 <code>Controller</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice(basePackages = &quot;com.ahao.module.controller&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAdvice</span> <span class="keyword">extends</span> <span class="title class_">AbstractJsonpResponseBodyAdvice</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAdvice</span> <span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 和下面 ajax 的 jsonp 属性的值要一致</span></span><br><span class="line">        <span class="built_in">super</span>(<span class="string">&quot;callback&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// com.ahao.module.controller.TestController</span></span><br><span class="line"><span class="comment">// 注意在 MyAdvice 扫描的包下</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="comment">// 只支持GET, 使用 fastjson 方便输出</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/test&quot;, method = RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(&quot;size&quot;)</span> Integer size)</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            json.put(<span class="string">&quot;key&quot;</span>+i, <span class="string">&quot;value&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>可以看到 <code>Controller</code> 是一个很普通的 <code>Controller</code>, 那么主要的就是 <code>AbstractJsonpResponseBodyAdvice</code>。<br>从名字看就知道是和 <code>AOP</code> 有关。<br>值的注意的是, 如果把 <code>basePackages</code> 设置为 <code>com</code> 的话, 也就是很大范围的话,<br>那么该范围内所有的 <code>Controller</code> 都将支持 <code>JSONP</code>, 这样违背了<a href="https://zh.wikipedia.org/wiki/%E6%9C%80%E5%B0%8F%E6%9D%83%E9%99%90%E5%8E%9F%E5%88%99">最小权限原则</a>。<br>所以 <code>basePackages</code> 范围要尽可能小。<br>配置好后, 启动<code>Tomcat</code>, 新建一个静态页面使用 <code>AJAX</code> 请求。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    $.<span class="title function_">ajax</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">type</span>:<span class="string">&quot;get&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">dataType</span>:<span class="string">&quot;jsonp&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">url</span>:<span class="string">&quot;http://localhost:8080/test&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">jsonp</span>:<span class="string">&quot;callback&quot;</span>, <span class="comment">// 和 MyAdvice 配置的值要一致</span></span></span><br><span class="line"><span class="language-javascript">        <span class="attr">data</span>: &#123;<span class="attr">size</span>: <span class="string">&#x27;5&#x27;</span>&#125;,</span></span><br><span class="line"><span class="language-javascript">        success : <span class="keyword">function</span>(<span class="params">json</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">html</span>(<span class="string">&quot;成功:&quot;</span>+<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(json));</span></span><br><span class="line"><span class="language-javascript">        &#125;,</span></span><br><span class="line"><span class="language-javascript">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">xhr</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            $(<span class="string">&#x27;div&#x27;</span>).<span class="title function_">html</span>(<span class="string">&quot;失败:&quot;</span>+<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(xhr));</span></span><br><span class="line"><span class="language-javascript">        &#125;</span></span><br><span class="line"><span class="language-javascript">    &#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>结果</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>成功:&#123;&quot;key4&quot;:&quot;value4&quot;,&quot;key3&quot;:&quot;value3&quot;,&quot;key0&quot;:&quot;value0&quot;,&quot;key2&quot;:&quot;value2&quot;,&quot;key1&quot;:&quot;value1&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="为什么不支持POST"><a href="#为什么不支持POST" class="headerlink" title="为什么不支持POST"></a>为什么不支持POST</h3><p><strong>没有支持<code>post</code>的<code>script</code>标签!!!</strong><br><code>JSONP</code>的本质, 是通过<code>script</code>标签, 以函数传参的形式来调用。<br>从响应头<code>Content-Type: application/javascript;charset=utf-8</code>就可以看出。<br>如本例中的<code>JSONP</code>请求, 等价于</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&lt;script src=<span class="string">&quot;http://localhost:8080/szlh/sdlyzwgk/test?callback=jQuery33108767440327735769_1521685929769&amp;size=5&amp;_=1521685929770&quot;</span>&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>后台处理后, 将数据封装成一个<code>JSON对象</code>，返回一串函数</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title function_">jQuery33108767440327735769_1521685929769</span>(&#123;<span class="string">&quot;key4&quot;</span>:<span class="string">&quot;value4&quot;</span>,<span class="string">&quot;key3&quot;</span>:<span class="string">&quot;value3&quot;</span>,<span class="string">&quot;key0&quot;</span>:<span class="string">&quot;value0&quot;</span>,<span class="string">&quot;key2&quot;</span>:<span class="string">&quot;value2&quot;</span>,<span class="string">&quot;key1&quot;</span>:<span class="string">&quot;value1&quot;</span>&#125;);</span><br></pre></td></tr></table></figure>
<p>可以看到<code>jQuery33108767440327735769_1521685929769</code>是函数名, 后台返回的数据封装成了<code>JSON对象</code>参数, 然后浏览器会调用这个函数, 走到<code>success</code>这个方法里面。</p>
<h1 id="CORS的解决方案"><a href="#CORS的解决方案" class="headerlink" title="CORS的解决方案"></a>CORS的解决方案</h1><p><code>CORS</code>是一个<a href="https://developer.mozilla.org/zh/docs/Web/HTTP/Access_control_CORS">W3C标准</a>，全称是”跨域资源共享”(Cross-origin resource)</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 允许http://localhost:8081对本机发起CORS访问</span></span><br><span class="line"><span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Origin</span>: <span class="attr">http</span>:<span class="comment">//localhost:8081</span></span><br><span class="line"><span class="comment">// 3628800秒内，不需要再发送预检验请求，可以缓存该结果</span></span><br><span class="line"><span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Max</span>-<span class="title class_">Age</span>: <span class="number">3628800</span></span><br><span class="line"><span class="comment">// 允许各种方式的请求</span></span><br><span class="line"><span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Methods</span>: <span class="variable constant_">GET</span>, <span class="variable constant_">POST</span>, <span class="variable constant_">PUT</span>, <span class="variable constant_">DELETE</span></span><br><span class="line"><span class="comment">// 允许包含的请求头</span></span><br><span class="line"><span class="title class_">Access</span>-<span class="title class_">Control</span>-<span class="title class_">Allow</span>-<span class="title class_">Headers</span>: content-type</span><br></pre></td></tr></table></figure>

<h2 id="原生解决方案"><a href="#原生解决方案" class="headerlink" title="原生解决方案"></a>原生解决方案</h2><p>使用过滤器<code>Filter</code>解决, 注册这个过滤器即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.ahao.core.filter.CORSFilter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CORSFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> (HttpServletResponse) servletResponse;</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Origin&quot;</span>, <span class="string">&quot;*&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Methods&quot;</span>, <span class="string">&quot;POST, GET&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Max-Age&quot;</span>, <span class="string">&quot;3600&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Access-Control-Allow-Headers&quot;</span>, <span class="string">&quot;Content-Type, Access-Control-Allow-Headers, Authorization, X-Requested-With&quot;</span>);</span><br><span class="line">        filterChain.doFilter(servletRequest, servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="SpringMVC解决方案"><a href="#SpringMVC解决方案" class="headerlink" title="SpringMVC解决方案"></a>SpringMVC解决方案</h2><p><strong>注意Spring MVC的版本要4.2以上</strong><br>使用<code>CrossOrigin</code>注解, 指定允许进行跨域的远程地址<code>http://localhost:8081</code>。<br>如果不指定, 则默认允许所有外来地址跨域访问。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.ahao.module.controller.TestController</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span> &#123;</span><br><span class="line">    <span class="comment">// 支持GET、POST, 使用 fastjson 方便输出</span></span><br><span class="line">    <span class="meta">@CrossOrigin(origins = &quot;http://localhost:8081&quot;)</span></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/test&quot;, method = RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">test</span><span class="params">(<span class="meta">@RequestParam(&quot;size&quot;)</span> Integer size)</span> &#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">json</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>(size);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">            json.put(<span class="string">&quot;key&quot;</span>+i, <span class="string">&quot;value&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> json;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>CrossOrigin</code>注解可以加在类上, 也可以加在方法上。<br>如果需要全局都注解的话, 需要在<code>spring</code>配置文件上添加</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:cors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span> <span class="attr">allowed-origins</span>=<span class="string">&quot;http://localhost:8081&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:cors</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://spring.io/guides/gs/rest-service-cors/">CORS support in Spring Framework</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC检测异常链接</title>
    <url>/posts/detect_abnormal_url_in_SpringMVC.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>大型网站通常会因为开发人员的代码功底参差不齐, 在一段时间后, 因为接口关闭等一系列原因, 造成页面出现<code>500</code>或<code>404</code>等常见错误。而这些链接是隐藏极深, 难以去人工一一排除的。</p>
<p><a href="https://en.wikipedia.org/wiki/Xenu%27s_Link_Sleuth">Xenu Link Sleuth</a>是一个错链扫描工具, 可以检测到网页中的链接是否正常。<br>当然, 这个工具是需要自己手动点击才能自动扫描的。最好就是用户访问到的瞬间, 我们就能知道链接是否正常。</p>
<span id="more"></span>

<h1 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h1><p><code>Spring MVC</code>提供了<strong>拦截器</strong>和<strong>拦截器链</strong>。<br>推荐使用注解加载<code>Bean</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Ahaochan on 2017/9/21.</span></span><br><span class="line"><span class="comment"> * Spring拦截器的注解, 复制自&#123;<span class="doctag">@link</span> org.springframework.stereotype.Service&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Target(&#123;ElementType.TYPE&#125;)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Interceptor &#123;</span><br><span class="line">    String <span class="title function_">value</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Created by Ahaochan on 2017/9/21.</span></span><br><span class="line"><span class="comment"> * Web状态码拦截器, 拦截到异常或状态码不为200, 则进行处理</span></span><br><span class="line"><span class="comment"> * 写入数据库、日志, 或者短信提醒</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Interceptor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebStatusInterceptor</span> <span class="keyword">extends</span> <span class="title class_">HandlerInterceptorAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(WebExceptionResolver.class);</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 具体实现交由开发人员自行处理</span></span><br><span class="line">        <span class="keyword">if</span>(ex != <span class="literal">null</span> || response.getStatus() != HttpStatus.OK.value())&#123;</span><br><span class="line">            logger.error(<span class="string">&quot;异常链接:&quot;</span>+request.getRequestURI());</span><br><span class="line">            logger.error(<span class="string">&quot;状态码:&quot;</span>+response.getStatus());</span><br><span class="line">            logger.error(<span class="string">&quot;异常:&quot;</span>, ex);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring-aop.xml 省略部分代码--&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--扫描aop相关的bean --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ahao&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 扫描拦截器 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;com.ahao.annotation.Interceptor&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:aspectj-autoproxy</span> <span class="attr">proxy-target-class</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 拦截器链 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 对所有uri进行拦截 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">mvc:mapping</span> <span class="attr">path</span>=<span class="string">&quot;/**&quot;</span>/&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- 特定请求的拦截器只能有一个 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">&quot;webStatusInterceptor &quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">mvc:interceptor</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:interceptors</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><a href="https://en.wikipedia.org/wiki/Xenu%27s_Link_Sleuth">Xenu Link Sleuth</a>是比较强大的工具, 但是及时性不足, 扫描时间过长。<br><code>Spring MVC</code>提供了拦截器可以补充上面的缺陷, 但是缺点就是无法扫描外部链接。</p>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringMVC简单使用</title>
    <url>/posts/Spring_MVC_simple_use.html</url>
    <content><![CDATA[<h1 id="构建环境"><a href="#构建环境" class="headerlink" title="构建环境"></a>构建环境</h1><h2 id="导入maven"><a href="#导入maven" class="headerlink" title="导入maven"></a>导入maven</h2><ul>
<li><a href="https://mvnrepository.com/artifact/org.springframework/spring-webmvc">spring-webmvc</a></li>
<li><a href="https://mvnrepository.com/artifact/javax.servlet/jstl">jstl</a></li>
<li><a href="https://mvnrepository.com/artifact/org.slf4j/slf4j-log4j12">slf4j-log4j12</a></li>
<li><a href="https://mvnrepository.com/artifact/javax.servlet/servlet-api/3.0.1">servlet-api</a></li>
</ul>
<span id="more"></span>

<h2 id="配置web-xml"><a href="#配置web-xml" class="headerlink" title="配置web.xml"></a>配置web.xml</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>JavaeeDemo<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--spring--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/configs/spring/spring-bean.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.request.RequestContextListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">listener</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">listener-class</span>&gt;</span>org.springframework.web.context.ContextLoaderListener<span class="tag">&lt;/<span class="name">listener-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">listener</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--spring webmvc--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mvc-dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.springframework.web.servlet.DispatcherServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>contextConfigLocation<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>/WEB-INF/configs/spring/mvc-dispatcher-servlet.xml<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">load-on-startup</span>&gt;</span>1<span class="tag">&lt;/<span class="name">load-on-startup</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>mvc-dispatcher<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置spring的xml"><a href="#配置spring的xml" class="headerlink" title="配置spring的xml"></a>配置spring的xml</h2><p><code>/WEB-INF/configs/spring/mvc-dispatcher-servlet.xml</code>的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span><span class="comment">&lt;!--开启注解--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ahao.javaeeDemo&quot;</span>&gt;</span><span class="comment">&lt;!--扫描包下的Controller注解--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:annotation-driven</span>/&gt;</span><span class="comment">&lt;!--开启注解驱动--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--&lt;mvc:resources mapping=&quot;/resources/**&quot; location=&quot;/resources&quot;/&gt;--&gt;</span><span class="comment">&lt;!--导入静态资源css等--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置ViewResolver--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.InternalResourceViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;viewClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;org.springframework.web.servlet.view.JstlView&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;prefix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/WEB-INF/jsps/&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;suffix&quot;</span> <span class="attr">value</span>=<span class="string">&quot;.jsp&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1000&quot;</span>/&gt;</span><span class="comment">&lt;!--配置多个Resolver，InternalResourceViewResolver要排在最后--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>/WEB-INF/configs/spring/spring-bean.xml</code>的配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:annotation-config</span>/&gt;</span><span class="comment">&lt;!--开启注解--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ahao.javaeeDemo&quot;</span>&gt;</span><span class="comment">&lt;!--扫描包下的注解，排除Controller注解--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Controller&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="url映射"><a href="#url映射" class="headerlink" title="url映射"></a>url映射</h1><h2 id="get、post方式匹配"><a href="#get、post方式匹配" class="headerlink" title="get、post方式匹配"></a>get、post方式匹配</h2><p>使用<code>@RequestParam</code>注入参数，封装成对象再传入<code>model</code>，在<code>jsp</code>页面中用<code>EL</code>表达式获取即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span> <span class="comment">// 匹配http://localhost:8080/hello路径</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/mvc&quot;, method = RequestMethod.GET)</span> <span class="comment">// 匹配http://localhost:8080/hello/mvc，只接收get请求</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name, // 匹配http://localhost:<span class="number">8080</span>/hello/mvc?name=?</span></span><br><span class="line"><span class="params">                                Model model)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(name);</span><br><span class="line">        model.addAttribute(user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;home&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用ServletAPI"><a href="#使用ServletAPI" class="headerlink" title="使用ServletAPI"></a>使用ServletAPI</h2><p>直接注入<code>HttpServletRequest</code>或者<code>HttpSession</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/mvc&quot;, method=RequestMathod.GET)</span> <span class="comment">// 匹配http://localhost:8080/hello/mvc?</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(HttpServletRequest request)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;name&quot;</span>);  <span class="comment">// 从request中获得请求参数</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(name);</span><br><span class="line">        request.setAttribute(<span class="string">&quot;user&quot;</span>,user);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;home&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="restful方式匹配"><a href="#restful方式匹配" class="headerlink" title="restful方式匹配"></a>restful方式匹配</h2><p>使用<code>@PathVariable</code>注入参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/mvc/&#123;name&#125;&quot;, method=RequestMethod.GET)</span> <span class="comment">// 匹配http://localhost:8080/hello/mvc/hhh</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name, Map&lt;String,Object&gt; model)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(name);</span><br><span class="line">        model.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">        <span class="keyword">return</span> home;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="文件上传"><a href="#文件上传" class="headerlink" title="文件上传"></a>文件上传</h1><p>jsp提交页面</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">action</span>=<span class="string">&quot;&lt;%=request.getContextPath()%&gt;/hello/doUpload&quot;</span> <span class="attr">enctype</span>=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;file&quot;</span> <span class="attr">name</span>=<span class="string">&quot;file&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置spring</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;multipartResolver&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.multipart.commons.CommonsMultipartResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;maxUploadSize&quot;</span> <span class="attr">value</span>=<span class="string">&quot;209715200&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultEncoding&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;resolveLazily&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span><span class="comment">&lt;!--推迟文件解析，用以捕获文件大小异常--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/&#123;name&#125;&quot;, method=RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name, Model model)</span>&#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(name);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;home&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/doUpload&quot;,method=RequestMethod.POST)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">doUpload</span><span class="params">(<span class="meta">@RequestParam(&quot;file&quot;)</span> MultipartFile file)</span> <span class="keyword">throws</span> IOException&#123;</span><br><span class="line">        <span class="keyword">if</span>(!file.isEmpty())&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;文件名:&quot;</span>+file.getOriginalFilename());</span><br><span class="line">            FileUtils.copyInputStreamToFile(file.getInputStream(), <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;D:\\&quot;</span>, file.getOriginalFilename+<span class="string">&quot;.bak&quot;</span>));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:&quot;</span>+file.getOriginalFilename();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="返回json格式数据"><a href="#返回json格式数据" class="headerlink" title="返回json格式数据"></a>返回json格式数据</h1><p>配置spring</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;contentNegotiationManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.accept.ContentNegotiationManagerFactoryBean&quot;</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;ignoreAcceptHeader&quot;</span> <span class="attr">value</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;mediaTypes&quot;</span>&gt;</span></span><br><span class="line">           <span class="tag">&lt;<span class="name">map</span>&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;json&quot;</span> <span class="attr">value</span>=<span class="string">&quot;application/json&quot;</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;xml&quot;</span> <span class="attr">value</span>=<span class="string">&quot;application/xml&quot;</span>/&gt;</span></span><br><span class="line">               <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">&quot;htm&quot;</span> <span class="attr">value</span>=<span class="string">&quot;text/html&quot;</span>/&gt;</span></span><br><span class="line">           <span class="tag">&lt;/<span class="name">map</span>&gt;</span></span><br><span class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.ContentNegotiationViewResolver&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;order&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;contentNegotiationManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;contentNegotiationManager&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;defaultViews&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.web.servlet.view.json.MappingJackson2JsonView&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>配置Controller</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line">    <span class="meta">@RequestMapping(value=&quot;/json1/&#123;name&#125;&quot;, method=RequestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> User <span class="title function_">getUserJson1</span><span class="params">(<span class="meta">@PathVariable(&quot;name&quot;)</span> String name)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;value&quot;/json2/&#123;name&#125;&quot;, method=ReuqestMethod.GET)</span></span><br><span class="line">    <span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title function_">getUserJson2</span><span class="params">(<span class="meta">@PathVariable</span> String name)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ResponseEntity</span>&lt;User&gt;(<span class="keyword">new</span> <span class="title class_">User</span>(name), HttpStatus.OK)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h1><ul>
<li>实现<code>HandlerInterceptor</code>接口</li>
<li>实现<code>WebRequestInterceptor</code>接口 : 不能拦截请求</li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring MVC返回json乱码</title>
    <url>/posts/how_to_correctly_parsing_json_in_Spring_MVC.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>json又双叒叕返回乱码了!<br>乱码一般都是编码问题，比如一个字符串<code>你好世界</code>, 用<code>GBK</code>编码后, 再用<code>UTF-8</code>解码, 就会出现乱码问题。</p>
<span id="more"></span>

<h1 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/test&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;你好世界&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用CharacterEncodingFilter过滤器-没用"><a href="#使用CharacterEncodingFilter过滤器-没用" class="headerlink" title="使用CharacterEncodingFilter过滤器(没用)"></a>使用CharacterEncodingFilter过滤器(没用)</h1><p>在 web.xml 中加入<code>CharacterEncodingFilter</code>过滤器, 对request和response进行编码转换。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.springframework.web.filter.CharacterEncodingFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceRequestEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>forceResponseEncoding<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>encoding<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>


<p>源码很简单, 就是调用<code>setCharacterEncoding</code>方法设置编码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CharacterEncodingFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(</span></span><br><span class="line"><span class="params">      HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span></span><br><span class="line">      <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">encoding</span> <span class="operator">=</span> getEncoding();</span><br><span class="line">    <span class="keyword">if</span> (encoding != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (isForceRequestEncoding() || request.getCharacterEncoding() == <span class="literal">null</span>) &#123;</span><br><span class="line">        request.setCharacterEncoding(encoding);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isForceResponseEncoding()) &#123;</span><br><span class="line">        response.setCharacterEncoding(encoding);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    filterChain.doFilter(request, response);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="CV大法重写StringHttpMessageConverter类"><a href="#CV大法重写StringHttpMessageConverter类" class="headerlink" title="CV大法重写StringHttpMessageConverter类"></a>CV大法重写StringHttpMessageConverter类</h1><p>行吧, 自己解决不了, 上stackoverflow看看,<br>在使用<code>&lt;mvc:annotation-driven /&gt;</code>自动驱动的前提下,<br>发现<code>@ResponseBody</code>返回值是<code>String</code>类型的话。<br>会调用<code>StringHttpMessageConverter</code>这个类进行转换。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title class_">AbstractHttpMessageConverter</span>&lt;String&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">DEFAULT_CHARSET</span> <span class="operator">=</span> Charset.forName(<span class="string">&quot;ISO-8859-1&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Charset&gt; availableCharsets;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">writeAcceptCharset</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认是<code>ISO-8859-1</code>编码, 而且是<code>final</code>修饰的。这就意味这不能继承这个方法了。<br>那就用CV大法吧。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StringHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title class_">AbstractHttpMessageConverter</span>&lt;String&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">DEFAULT_CHARSET</span> <span class="operator">=</span> Charset.forName(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> List&lt;Charset&gt; availableCharsets;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">writeAcceptCharset</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>并且在<code>&lt;mvc:annotation-driven /&gt;</code>内注入这个Bean</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mvc:annotation-driven</span>&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">mvc:message-converters</span> <span class="attr">register-defaults</span>=<span class="string">&quot;true&quot;</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.chuanliu.platform.activity.basic.converter.MyStringHttpMessageConverter&quot;</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">mvc:message-converters</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">mvc:annotation-driven</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="使用produces属性完成"><a href="#使用produces属性完成" class="headerlink" title="使用produces属性完成"></a>使用produces属性完成</h1><p>使用CV大法是很不好的习惯,<br>【<a href="http://blog.csdn.net/lsx1984/article/details/8803296">解决spring-mvc @responseBody注解返回json 乱码问题</a>】这篇文章提出可以使用produces属性完成</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestController</span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(value = &quot;/test&quot;, produces=&quot;text/html;charset=UTF-8&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;你好世界&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>省了一大堆配置, 但还是要在每个<code>@ResponseBody</code>方法使用CV大法, 写入<code>produces=&quot;text/html;charset=UTF-8&quot;</code>。</p>
<h1 id="直接返回对象"><a href="#直接返回对象" class="headerlink" title="直接返回对象"></a>直接返回对象</h1><p>【<a href="http://josh-persistence.iteye.com/blog/2085015">（二）Java 中文乱码学习 与Spring @ResponseBody中的乱码 - Spring @ResponseBody中的乱码</a>】中提到<br>在使用<code>&lt;mvc:annotation-driven /&gt;</code>自动驱动的前提下,<br>如果直接返回String类型, 则会调用<code>StringHttpMessageConverter</code>。<br>如果直接返回对象类型, 则会调用<code>MappingJackson2HttpMessageConverter</code>。</p>
<p>在<code>MappingJackson2HttpMessageConverter</code>的父类<code>AbstractJackson2HttpMessageConverter</code>中。<br>可以看到使用了<code>UTF-8</code>编码。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractJackson2HttpMessageConverter</span> <span class="keyword">extends</span> <span class="title class_">AbstractGenericHttpMessageConverter</span>&lt;Object&gt; &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Charset</span> <span class="variable">DEFAULT_CHARSET</span> <span class="operator">=</span> Charset.forName(<span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.csdn.net/lsx1984/article/details/8803296">解决spring-mvc @responseBody注解返回json 乱码问题</a></li>
<li><a href="http://josh-persistence.iteye.com/blog/2085015">（二）Java 中文乱码学习 与Spring @ResponseBody中的乱码 - Spring @ResponseBody中的乱码</a>中提到</li>
<li><a href="https://my.oschina.net/alexgaoyh/blog/316314">springmvc 4.x 处理json 数据时中文乱码</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot在Tomcat上使用</title>
    <url>/posts/deploy_Spring_Boot_project_with_Tomcat.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>一般的教程都是直接运行<code>main</code>方法, 看似脱离了<code>Tomcat</code>运行<br>实际上是使用的是内嵌的<code>Tomcat</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<span id="more"></span>
<p>而且打包出来的是<code>jar</code>包, 虽然可以直接运行, 但是如果想放在外部的<code>Tomcat</code>下, 就不太好了。</p>
<h1 id="解决方案是"><a href="#解决方案是" class="headerlink" title="解决方案是"></a>解决方案是</h1><ol>
<li>继承 <code> SpringBootServletInitializer</code> 并重写 <code>configure</code> 方法<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">App</span> <span class="keyword">extends</span> <span class="title class_">SpringBootServletInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> SpringApplicationBuilder <span class="title function_">configure</span><span class="params">(SpringApplicationBuilder builder)</span> &#123;</span><br><span class="line">        <span class="comment">// 可有可无的方法, 之后有解释</span></span><br><span class="line">        <span class="keyword">return</span> builder.sources(getClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(App.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>在项目的 <code>pom.xml</code> 设置 <code>&lt;packaging&gt;war&lt;/packaging&gt;</code>, 注意, 多模块项目只需要在该模块的 <code>pom.xml</code> 设置即可</li>
<li>添加<a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-tomcat/">spring-boot-starter-tomcat依赖</a>, 并设置 <code>&lt;scope&gt;provided&lt;/scope&gt;</code> <figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li>打<code>war包</code>部署到<code>Tomcat</code></li>
</ol>
<h1 id="为什么要-继承SpringBootServletInitializer"><a href="#为什么要-继承SpringBootServletInitializer" class="headerlink" title="为什么要 继承SpringBootServletInitializer ?"></a>为什么要 继承SpringBootServletInitializer ?</h1><p><img data-src="https://yuml.me/diagram/nofunky/class/[WebApplicationInitializer]^-[SpringBootServletInitializer],[SpringBootServletInitializer]^-[%E6%88%91%E7%9A%84%E5%90%AF%E5%8A%A8%E7%B1%BB]" alt="继承树 "><br>首先明确一点, <code>Spring Boot </code>只是许多个<code>Spring</code>项目和其他项目整合起来, 并不是一个额外的项目, 你可以理解成一个封装了<code>Spring</code>、<code>SpringMVC</code>等项目的新项目。<br>那么, <code>Spring</code>有入口<code>ContextLoaderListener</code>、 <code>Spring MVC</code>有入口<code>DispatcherServlet</code>。那<code>Spring Boot</code>的入口当然就是<code>SpringBootServletInitializer</code>。<br>(当然如果你不用<code>war包</code>可以忽略这段话, 也不用看这篇文章)</p>
<p>看到熟悉的<code>ServletInitializer</code>, 这是<a href="https://ahaochan.github.io/Java/JavaWeb/JSP/Servlet3.0%E6%96%B0%E7%89%B9%E6%80%A7.html#%E9%80%9A%E8%BF%87ServletContainerInitializer%E6%B3%A8%E5%86%8C">Servlet3.0新特性</a>,  <code>Tomcat</code>会自动查找并运行实现了 <code>ServletContainerInitializer</code> 接口的类。<br>但是能自动加载的是 <code>ServletContainerInitializer</code> 及其子类, 和<code>SpringBootServletInitializer</code>及其父类<code>WebApplicationInitializer</code><br>可是丝毫没有联系的, 能想到的就是有<strong>另一个类</strong>连接了这两个类。<br>这个类就是<code>SpringServletContainerInitializer</code>, 它会去加载所有的<code>WebApplicationInitializer</code>及其子类<code>SpringBootServletInitializer</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.SpringServletContainerInitializer</span></span><br><span class="line"><span class="meta">@HandlesTypes(WebApplicationInitializer.class)</span></span><br><span class="line"><span class="comment">// 继承了 ServletContainerInitializer , 所以能自动加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpringServletContainerInitializer</span> <span class="keyword">implements</span> <span class="title class_">ServletContainerInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">// 1. 扫描HandlesTypes注解中的类或它的子类, 注入Set集合</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(Set&lt;Class&lt;?&gt;&gt; webAppInitializerClasses, ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        </span><br><span class="line">        List&lt;WebApplicationInitializer&gt; initializers = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;WebApplicationInitializer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Class&lt;?&gt; waiClass : webAppInitializerClasses) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!waiClass.isInterface() &amp;&amp; !Modifier.isAbstract(waiClass.getModifiers()) &amp;&amp;</span><br><span class="line">                    WebApplicationInitializer.class.isAssignableFrom(waiClass)) &#123;</span><br><span class="line">                initializers.add((WebApplicationInitializer) waiClass.newInstance());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        AnnotationAwareOrderComparator.sort(initializers);</span><br><span class="line">        <span class="keyword">for</span> (WebApplicationInitializer initializer : initializers) &#123;</span><br><span class="line">            <span class="comment">// 2. 核心方法, 调用WebApplicationInitializer的onStartup方法</span></span><br><span class="line">            initializer.onStartup(servletContext);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HandlesTypes</code> 注解中的 <code>WebApplicationInitializer</code> 被注入到 <code>Set集合</code>中, 然后调用 <code> WebApplicationInitializer</code>的<code>onStartup</code>方法。<br>至此, <code>SpringBootServletInitializer</code> 已经能随着<code>Tomcat</code>的启动而启动了。</p>
<h1 id="为什么不用重写configure方法"><a href="#为什么不用重写configure方法" class="headerlink" title="为什么不用重写configure方法"></a>为什么不用重写configure方法</h1><p>很多网上的文章, 都说要重写 <code>configure方法</code>, 但是这对我上面那个<code>Hello world</code>例子是不需要的, 从源码中可以窥视一二。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.boot.web.support.SpringBootServletInitializer</span></span><br><span class="line"><span class="comment">// 实现了 WebApplicationInitializer 接口, 所以也能间接的自动加载</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SpringBootServletInitializer</span> <span class="keyword">implements</span> <span class="title class_">WebApplicationInitializer</span> &#123;</span><br><span class="line">    <span class="comment">// 省略部分代码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartup</span><span class="params">(ServletContext servletContext)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        <span class="comment">// 1. 入口</span></span><br><span class="line">        <span class="type">WebApplicationContext</span> <span class="variable">rootAppContext</span> <span class="operator">=</span> createRootApplicationContext(servletContext);</span><br><span class="line">        <span class="keyword">if</span> (rootAppContext != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 由于 application context 已被初始化，因此无操作</span></span><br><span class="line">            <span class="comment">// 这里加载了 ContextLoaderListener , 所以也不能自己再去实现 ContextLoaderListener</span></span><br><span class="line">            servletContext.addListener(<span class="keyword">new</span> <span class="title class_">ContextLoaderListener</span>(rootAppContext) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">contextInitialized</span><span class="params">(ServletContextEvent event)</span> &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 创建 ApplicationContext</span></span><br><span class="line">    <span class="keyword">protected</span> WebApplicationContext <span class="title function_">createRootApplicationContext</span><span class="params">(ServletContext servletContext)</span> &#123;</span><br><span class="line">        <span class="comment">// 设计模式 之 建造器Builder模式</span></span><br><span class="line">        <span class="type">SpringApplicationBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> createSpringApplicationBuilder();</span><br><span class="line">        builder.main(getClass());</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">parent</span> <span class="operator">=</span> getExistingRootWebApplicationContext(servletContext);</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.logger.info(<span class="string">&quot;Root context already created (using as parent).&quot;</span>);</span><br><span class="line">            servletContext.setAttribute(</span><br><span class="line">                    WebApplicationContext.ROOT_WEB_APPLICATION_CONTEXT_ATTRIBUTE, <span class="literal">null</span>);</span><br><span class="line">            builder.initializers(<span class="keyword">new</span> <span class="title class_">ParentContextApplicationContextInitializer</span>(parent));</span><br><span class="line">        &#125;</span><br><span class="line">        builder.initializers(</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ServletContextApplicationContextInitializer</span>(servletContext));</span><br><span class="line">        builder.listeners(<span class="keyword">new</span> <span class="title class_">ServletContextApplicationListener</span>(servletContext));</span><br><span class="line">        builder.contextClass(AnnotationConfigEmbeddedWebApplicationContext.class);</span><br><span class="line">        <span class="comment">// 调用 configure 方法, 默认不操作builder</span></span><br><span class="line">        builder = configure(builder);</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">application</span> <span class="operator">=</span> builder.build();</span><br><span class="line">        <span class="comment">// 如果没有重写 configure 方法给 builder 添加 source </span></span><br><span class="line">        <span class="comment">// 即 application 的 source(Set集合) 为空</span></span><br><span class="line">        <span class="keyword">if</span> (application.getSources().isEmpty() &amp;&amp; AnnotationUtils</span><br><span class="line">                .findAnnotation(getClass(), Configuration.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 且继承 SpringBootServletInitializer 自身的子类添加了 Configuration 注解</span></span><br><span class="line">            <span class="comment">// 因为 SpringBootApplication 注解继承了 Configuration 注解</span></span><br><span class="line">            <span class="comment">// 所以不用重写 configure方法 也可以加入 source 中</span></span><br><span class="line">            application.getSources().add(getClass());</span><br><span class="line">        &#125;</span><br><span class="line">        Assert.state(!application.getSources().isEmpty(),</span><br><span class="line">                <span class="string">&quot;No SpringApplication sources have been defined. Either override the &quot;</span></span><br><span class="line">                        + <span class="string">&quot;configure method or add an @Configuration annotation&quot;</span>);</span><br><span class="line">        <span class="comment">// Ensure error pages are registered</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.registerErrorPageFilter) &#123;</span><br><span class="line">            application.getSources().add(ErrorPageFilterConfiguration.class);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> run(application);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认不操作builder</span></span><br><span class="line">    <span class="keyword">protected</span> SpringApplicationBuilder <span class="title function_">configure</span><span class="params">(SpringApplicationBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从<code>Configuration</code>注解的<strong>类</strong>可以注入 <code>source</code> 发现, 这个 <code>source</code> 就是存储<code>Spring</code>配置的, 当然, <strong>不是<code>xml</code></strong>, 而是<code>java</code>配置。<br>也就是说</p>
<ol>
<li>只有一个<code>Java</code>配置类, 则直接继承 <code> SpringBootServletInitializer</code> 即可。</li>
<li>如果有多个<code>Java</code>配置类, 则继承 <code> SpringBootServletInitializer</code> 之外，还要重写 <code>configure</code> 方法, 将配置类都注入进去, 包括 <code>SpringBootServletInitializer</code> 的子类。</li>
</ol>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>源码分析</tag>
        <tag>Tomcat</tag>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Boot彩色日志的配置</title>
    <url>/posts/Spring_Boot_color_log_configuration.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><img data-src="/images/SpringBoot%E5%BD%A9%E8%89%B2%E6%97%A5%E5%BF%97%E7%9A%84%E9%85%8D%E7%BD%AE_01.png" class="">

<span id="more"></span>
<p>Spring Boot提供了彩色日志的功能, 可以达到上面的效果</p>
<h1 id="logback-xml"><a href="#logback-xml" class="headerlink" title="logback.xml"></a>logback.xml</h1><p>在 <code>resource</code> 文件夹加入 <code>logback.xml</code>, Spring Boot 会自动去加载配置文件。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span> <span class="attr">debug</span>=<span class="string">&quot;false&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 设置上下文名称 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">contextName</span>&gt;</span>$&#123;log.context.name&#125;<span class="tag">&lt;/<span class="name">contextName</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--定义日志文件的存储地址 勿在 LogBack 的配置中使用相对路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;LOG_PATH&quot;</span> <span class="attr">value</span>=<span class="string">&quot;/LOG&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.context.name&quot;</span> <span class="attr">value</span>=<span class="string">&quot;MyApp&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.charset&quot;</span> <span class="attr">value</span>=<span class="string">&quot;UTF-8&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Log4j: [S][%d&#123;yyyyMMdd HH:mm:ss&#125;][%-5p][%C:%L] - %m%n --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--格式化输出：%d表示日期，%thread表示线程名，%-5level：级别从左显示5个字符宽度%msg：日志消息，%n是换行符--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.pattern&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%thread] %-5level %logger&#123;50&#125; - %msg%n&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.pattern.short&quot;</span> <span class="attr">value</span>=<span class="string">&quot;%date&#123;yyyyMMdd HH:mm:ss.SSS&#125;-%msg%n&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志格式 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;log.pattern.color&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;CONSOLE_LOG_PATTERN:-%clr(%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125;)&#123;faint&#125; %clr($&#123;LOG_LEVEL_PATTERN:-%5p&#125;) %clr($&#123;PID:- &#125;)&#123;magenta&#125; %clr(---)&#123;faint&#125; %clr([%15.15t])&#123;faint&#125; %clr(%-40.40logger&#123;39&#125;)&#123;cyan&#125; %clr(:)&#123;faint&#125; %m%n$&#123;LOG_EXCEPTION_CONVERSION_WORD:-%wEx&#125;&#125;&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 控制台输出 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT_SHORT&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern.short&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志 --&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 彩色日志依赖的渲染类 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">&quot;clr&quot;</span> <span class="attr">converterClass</span>=<span class="string">&quot;org.springframework.boot.logging.logback.ColorConverter&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">&quot;wex&quot;</span> <span class="attr">converterClass</span>=<span class="string">&quot;org.springframework.boot.logging.logback.WhitespaceThrowableProxyConverter&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">conversionRule</span> <span class="attr">conversionWord</span>=<span class="string">&quot;wEx&quot;</span> <span class="attr">converterClass</span>=<span class="string">&quot;org.springframework.boot.logging.logback.ExtendedWhitespaceThrowableProxyConverter&quot;</span> /&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- Console 输出设置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;STDOUT_COLOR&quot;</span> <span class="attr">class</span>=<span class="string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;$&#123;log.charset&#125;&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">pattern</span>&gt;</span>$&#123;log.pattern.color&#125;<span class="tag">&lt;/<span class="name">pattern</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">encoder</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--mybatis log configure--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;com.apache.ibatis&quot;</span> <span class="attr">level</span>=<span class="string">&quot;TRACE&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.Connection&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.Statement&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">logger</span> <span class="attr">name</span>=<span class="string">&quot;java.sql.PreparedStatement&quot;</span> <span class="attr">level</span>=<span class="string">&quot;DEBUG&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 日志输出级别 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;INFO&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;STDOUT_COLOR&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="在application-yml启用彩色日志"><a href="#在application-yml启用彩色日志" class="headerlink" title="在application.yml启用彩色日志"></a>在application.yml启用彩色日志</h1><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring.output.ansi.enabled:</span> <span class="string">detect</span></span><br></pre></td></tr></table></figure>
<p><code>spring.output.ansi.enabled</code> 有三个候选项</p>
<ol>
<li>NEVER：禁用ANSI-colored输出（默认项）</li>
<li>DETECT：会检查终端是否支持ANSI，是的话就采用彩色输出（推荐项）</li>
<li>ALWAYS：总是使用ANSI-colored格式输出，若终端不支持的时候，会有很多干扰信息，不推荐使用</li>
</ol>
<h1 id="Tomcat不支持彩色日志"><a href="#Tomcat不支持彩色日志" class="headerlink" title="Tomcat不支持彩色日志"></a>Tomcat不支持彩色日志</h1><p>直接运行 <code>main</code> 函数的话,日志可以彩色输出, 但是在IDEA部署到 <code>Tomcat </code> 的时候, IDEA的控制台没有彩色日志, 如果强制打开彩色日志, 则会出现很多干扰信息。</p>
<p>IDEA提供了个曲线救国的插件<a href="https://plugins.jetbrains.com/plugin/7125-grep-console">Grep Console</a>, 安装即可, 在IDEA的控制台渲染彩色日志, 在Tomcat不显示彩色日志。</p>
<img data-src="/images/SpringBoot%E5%BD%A9%E8%89%B2%E6%97%A5%E5%BF%97%E7%9A%84%E9%85%8D%E7%BD%AE_02.png" class="">

<p>如果在Linux上使用, 还有另一种曲线救国的方法。这种就不详细讨论了。<br><a href="https://github.com/cornet/ccze">Linux 日志高亮工具 CCZE</a></p>
<h1 id="有趣的Banner"><a href="#有趣的Banner" class="headerlink" title="有趣的Banner"></a>有趣的Banner</h1><p>使用过Spring Boot就会发现每次项目启动时，控制台都会有一个大大的<strong>Spring</strong>的字符画。<br>Spring Boot也提供了自定义的方法, 在 <code>resource/banner.txt</code> 写入想显示的字符画, 就可以自动加载并显示出来。<br><strong>注意Tomcat不支持彩色日志</strong></p>
<h2 id="佛祖保佑"><a href="#佛祖保佑" class="headerlink" title="佛祖保佑"></a>佛祖保佑</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">////////////////////////////////////////////////////////////////////</span><br><span class="line">//                          _ooOoo_                               //</span><br><span class="line">//                         o8888888o                              //</span><br><span class="line">//                         88&quot; . &quot;88                              //</span><br><span class="line">//                         (| ^_^ |)                              //</span><br><span class="line">//                         O\  =  /O                              //</span><br><span class="line">//                      ____/`---&#x27;\____                           //</span><br><span class="line">//                    .&#x27;  \\|     |//  `.                         //</span><br><span class="line">//                   /  \\|||  :  |||//  \                        //</span><br><span class="line">//                  /  _||||| -:- |||||-  \                       //</span><br><span class="line">//                  |   | \\\  -  /// |   |                       //</span><br><span class="line">//                  | \_|  &#x27;&#x27;\---/&#x27;&#x27;  |   |                       //</span><br><span class="line">//                  \  .-\__  `-`  ___/-. /                       //</span><br><span class="line">//                ___`. .&#x27;  /--.--\  `. . ___                     //</span><br><span class="line">//              .&quot;&quot; &#x27;&lt;  `.___\_&lt;|&gt;_/___.&#x27;  &gt;&#x27;&quot;&quot;.                  //</span><br><span class="line">//            | | :  `- \`.;`\ _ /`;.`/ - ` : | |                 //</span><br><span class="line">//            \  \ `-.   \_ __\ /__ _/   .-` /  /                 //</span><br><span class="line">//      ========`-.____`-.___\_____/___.-`____.-&#x27;========         //</span><br><span class="line">//                           `=---=&#x27;                              //</span><br><span class="line">//      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^        //</span><br><span class="line">//            佛祖保佑       永不宕机     永无BUG                  //</span><br><span class="line">////////////////////////////////////////////////////////////////////</span><br></pre></td></tr></table></figure>

<h2 id="jhipster-不支持Tomcat"><a href="#jhipster-不支持Tomcat" class="headerlink" title="jhipster(不支持Tomcat)"></a>jhipster(不支持Tomcat)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;AnsiColor.GREEN&#125;      ██╗$&#123;AnsiColor.RED&#125; ██╗   ██╗ ████████╗ ███████╗   ██████╗ ████████╗ ████████╗ ███████╗</span><br><span class="line">$&#123;AnsiColor.GREEN&#125;      ██║$&#123;AnsiColor.RED&#125; ██║   ██║ ╚══██╔══╝ ██╔═══██╗ ██╔════╝ ╚══██╔══╝ ██╔═════╝ ██╔═══██╗</span><br><span class="line">$&#123;AnsiColor.GREEN&#125;      ██║$&#123;AnsiColor.RED&#125; ████████║    ██║    ███████╔╝ ╚█████╗     ██║    ██████╗   ███████╔╝</span><br><span class="line">$&#123;AnsiColor.GREEN&#125;██╗   ██║$&#123;AnsiColor.RED&#125; ██╔═══██║    ██║    ██╔════╝   ╚═══██╗    ██║    ██╔═══╝   ██╔══██║</span><br><span class="line">$&#123;AnsiColor.GREEN&#125;╚██████╔╝$&#123;AnsiColor.RED&#125; ██║   ██║ ████████╗ ██║       ██████╔╝    ██║    ████████╗ ██║  ╚██╗</span><br><span class="line">$&#123;AnsiColor.GREEN&#125; ╚═════╝ $&#123;AnsiColor.RED&#125; ╚═╝   ╚═╝ ╚═══════╝ ╚═╝       ╚═════╝     ╚═╝    ╚═══════╝ ╚═╝   ╚═╝</span><br></pre></td></tr></table></figure>

<h2 id="彩虹猫-不支持Tomcat"><a href="#彩虹猫-不支持Tomcat" class="headerlink" title="彩虹猫(不支持Tomcat)"></a>彩虹猫(不支持Tomcat)</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████████████████████████████████████████████████████████████████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████████████████████████████████████████████████████████████████████</span><br><span class="line">$&#123;AnsiColor.RED&#125;██████████████████$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████$&#123;AnsiColor.BLACK&#125;██████████████████████████████$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████</span><br><span class="line">$&#123;AnsiColor.RED&#125;████████████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██████████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_RED&#125;████$&#123;AnsiColor.RED&#125;██████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.MAGENTA&#125;██████████████████████$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_RED&#125;██████████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.MAGENTA&#125;████████████████$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.MAGENTA&#125;██████$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.BRIGHT_BLUE&#125;██████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_RED&#125;██████████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.MAGENTA&#125;██████$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_YELLOW&#125;██████████████████$&#123;AnsiColor.BRIGHT_RED&#125;████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.MAGENTA&#125;██████$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_YELLOW&#125;██████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_YELLOW&#125;██████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;████████$&#123;AnsiColor.WHITE&#125;████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_YELLOW&#125;████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_YELLOW&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_GREEN&#125;██████████████████$&#123;AnsiColor.BRIGHT_YELLOW&#125;██$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;████████$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;██████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██</span><br><span class="line">$&#123;AnsiColor.BRIGHT_GREEN&#125;██████████████████████$&#123;AnsiColor.WHITE&#125;████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;██████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BRIGHT_YELLOW&#125;██$&#123;AnsiColor.WHITE&#125;██████████$&#123;AnsiColor.BRIGHT_YELLOW&#125;██$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██</span><br><span class="line">$&#123;AnsiColor.BRIGHT_GREEN&#125;██████████████████████$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;██████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██</span><br><span class="line">$&#123;AnsiColor.BLUE&#125;██████████████████$&#123;AnsiColor.BRIGHT_GREEN&#125;████████$&#123;AnsiColor.BLACK&#125;██████$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;██████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.MAGENTA&#125;████$&#123;AnsiColor.WHITE&#125;████████████████$&#123;AnsiColor.MAGENTA&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██</span><br><span class="line">$&#123;AnsiColor.BLUE&#125;██████████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.MAGENTA&#125;██████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;████████████$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;██████████████████$&#123;AnsiColor.BLUE&#125;████$&#123;AnsiColor.BLUE&#125;██████$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.MAGENTA&#125;██████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;██████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.WHITE&#125;████████████████████$&#123;AnsiColor.BLACK&#125;██████████████████$&#123;AnsiColor.BRIGHT_BLUE&#125;████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;██████$&#123;AnsiColor.BLACK&#125;████████████████████████████████$&#123;AnsiColor.WHITE&#125;██$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;██$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;████$&#123;AnsiColor.WHITE&#125;████$&#123;AnsiColor.BLACK&#125;██$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████████████████$&#123;AnsiColor.BLACK&#125;██████$&#123;AnsiColor.BRIGHT_BLUE&#125;████$&#123;AnsiColor.BLACK&#125;██████$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████$&#123;AnsiColor.BLACK&#125;██████$&#123;AnsiColor.BRIGHT_BLUE&#125;████$&#123;AnsiColor.BLACK&#125;██████$&#123;AnsiColor.BRIGHT_BLUE&#125;████████████</span><br><span class="line">████████████████████████████████████████████████████████████████████████████████</span><br><span class="line">$&#123;AnsiColor.BRIGHT_BLUE&#125;:: Meow :: Running Spring Boot $&#123;spring-boot.version&#125; :: \ö/$&#123;AnsiColor.BLACK&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://devops.datenkollektiv.de/banner.txt/index.html">Banner 生成器</a></li>
<li><a href="https://github.com/PierreBesson/generator-jhipster-banner/blob/master/generators/app/templates/_banner.txt">jhipster</a></li>
<li><a href="https://github.com/snicoll-demos/spring-boot-4tw-uni/blob/master/spring-boot-4tw-web/src/main/resources/banner.txt">彩虹猫</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring Boot</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring事务管理</title>
    <url>/posts/Spring_Transaction_Management.html</url>
    <content><![CDATA[<h1 id="接口介绍"><a href="#接口介绍" class="headerlink" title="接口介绍"></a>接口介绍</h1><ul>
<li>PlatformTransactionManager事务管理器</li>
<li>TransactionDefinition事务定义信息</li>
</ul>
<ul>
<li>ISOLATION隔离级别</li>
<li>PROPAGATION传播行为</li>
<li>TIMEOUT超时信息</li>
</ul>
<ul>
<li>TransactionStatus事务具体运行状态</li>
</ul>
<span id="more"></span>

<h1 id="编程式事务管理（很少应用）"><a href="#编程式事务管理（很少应用）" class="headerlink" title="编程式事务管理（很少应用）"></a>编程式事务管理（很少应用）</h1><p>通过<code>TransactionTemplate</code>手动管理事务，在<code>service</code>使用<code>TransactonTemplate</code>，依赖<code>DataSourceTransactionManager</code>，依赖<code>DataSource</code>构造<br><code>spring</code>配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据库连接池DataSource--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.mchange.v2.c3p0.ComboPooledDataSource&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClass&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.mysql.cj.jdbc.Driver&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;jdbcUrl&quot;</span> <span class="attr">value</span>=<span class="string">&quot;jdbc:mysql://localhost:3306/test?serverTimeZone=GMT&amp;useUnicode=true&amp;characterEncoding=utf8&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;user&quot;</span> <span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span><span class="attr">value</span>=<span class="string">&quot;root&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">&lt;!--在service层注入事务管理模板--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.service&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">id</span>=<span class="string">&quot;dao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;accountDao&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">id</span>=<span class="string">&quot;transactionTemplate&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;transactionTemplate&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置事务管理模板--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.transaction.support.TransactionTemplate&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span><span class="comment">&lt;!--注入事务管理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    </span><br><span class="line">    <span class="comment">&lt;!--配置事务管理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><span class="comment">&lt;!--注入数据库连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在<code>service</code>层编写<code>java</code>代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> AccountDao dao;</span><br><span class="line">    <span class="keyword">private</span> TransactionTemplate transactionTemplate;</span><br><span class="line">    <span class="comment">// getter And Setter</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span>&#123;</span><br><span class="line">        transactionTemplate.execute(<span class="keyword">new</span> <span class="title class_">TransactionCallbackWithoutResult</span>()&#123;</span><br><span class="line">            <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doInTransactionWithoutResult</span><span class="params">(TransactionStatus status)</span>&#123;</span><br><span class="line">                dao.outMoney(out, money);</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;<span class="comment">//引发异常，事务回滚</span></span><br><span class="line">                dao.inMoney (in, money);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="声明式事务管理"><a href="#声明式事务管理" class="headerlink" title="声明式事务管理"></a>声明式事务管理</h1><p>通过<code>XML</code>配置，代码侵入性小，通过<code>AOP</code>实现<br>需要导入</p>
<ul>
<li><a href="http://mvnrepository.com/artifact/aopalliance/aopalliance">http://mvnrepository.com/artifact/aopalliance/aopalliance</a></li>
<li><a href="http://mvnrepository.com/artifact/org.springframework/spring-aop">http://mvnrepository.com/artifact/org.springframework/spring-aop</a> </li>
</ul>
<h2 id="基于TransactionProxyFactoryBean的方式（很少应用）"><a href="#基于TransactionProxyFactoryBean的方式（很少应用）" class="headerlink" title="基于TransactionProxyFactoryBean的方式（很少应用）"></a>基于TransactionProxyFactoryBean的方式（很少应用）</h2><p>缺点是要为每个增强类添加一个<code>TransactionProxyFactoryBean</code>配置。<br><code>spring</code>配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据库连接池DataSource--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--service层--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.service&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">id</span>=<span class="string">&quot;dao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;accountDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--创建代理对象--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountServiceProxy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.transaction.interceptor.TransactionProxyFactoryBean&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;target&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;accountService&quot;</span>/&gt;</span><span class="comment">&lt;!--注入被增强的对象--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span><span class="comment">&lt;!--注入事务管理器--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;transactionAttributes&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">props</span>&gt;</span></span><br><span class="line">                <span class="comment">&lt;!--&lt;prop key&quot;save*表示以save开头的方法&quot;&gt;PROPAGATION(事务传播行为),ISOLATION(事务隔离级别),readOnly(只读),-Exception(发生某些异常回滚),+Exception(发生某些异常不回滚)&lt;/prop&gt;--&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;transfer&quot;</span>&gt;</span>PROPAGATION_REQUIRED<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">props</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span>    </span><br><span class="line">    <span class="comment">&lt;!--配置事务管理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><span class="comment">&lt;!--注入数据库连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="基于AspectJ的XML方式（推荐）"><a href="#基于AspectJ的XML方式（推荐）" class="headerlink" title="基于AspectJ的XML方式（推荐）"></a>基于AspectJ的XML方式（推荐）</h2><p>需要导入    </p>
<ul>
<li><a href="http://mvnrepository.com/artifact/org.aspectj/aspectjweaver">http://mvnrepository.com/artifact/org.aspectj/aspectjweaver</a> </li>
<li><a href="http://mvnrepository.com/artifact/org.springframework/spring-aop">http://mvnrepository.com/artifact/org.springframework/spring-aop</a></li>
</ul>
<p><code>spring</code>配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据库连接池DataSource--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--service层--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.service&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">id</span>=<span class="string">&quot;dao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;accountDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置事务的通知--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:advice</span> <span class="attr">id</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">tx:method</span> <span class="attr">name</span>=<span class="string">&quot;transfer&quot;</span> <span class="attr">propagation</span>=<span class="string">&quot;REQUIRED&quot;</span> <span class="attr">isolation</span>=<span class="string">&quot;DEFAULT&quot;</span> <span class="attr">read-only</span>=<span class="string">&quot;false&quot;</span> <span class="attr">no-rollback-for</span>=<span class="string">&quot;MyException1&quot;</span> <span class="attr">rollback-for</span>=<span class="string">&quot;MyException2&quot;</span> <span class="attr">timeout</span>=<span class="string">&quot;-1&quot;</span>/&gt;</span> </span><br><span class="line">        <span class="tag">&lt;/<span class="name">tx:attributes</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tx:advice</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置切面--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置切入点--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">&quot;pointcut&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;execution(* com.ahao.javaeeDemo.service.AccountService+.*(..))&quot;</span>/&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--配置切面--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">aop:advisor</span> <span class="attr">advice-ref</span>=<span class="string">&quot;txAdvice&quot;</span> <span class="attr">pointcut-ref</span>=<span class="string">&quot;pointcut&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--配置事务管理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><span class="comment">&lt;!--注入数据库连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="基于注解的方式（代码侵入性强，配置简单）"><a href="#基于注解的方式（代码侵入性强，配置简单）" class="headerlink" title="基于注解的方式（代码侵入性强，配置简单）"></a>基于注解的方式（代码侵入性强，配置简单）</h2><p><code>spring</code>配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置数据库连接池DataSource--&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--service层--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;accountService&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.javaeeDemo.service&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">id</span>=<span class="string">&quot;dao&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;accountDao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置注解驱动--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--配置事务管理器--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span><span class="comment">&lt;!--注入数据库连接池--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在类上添加注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Transactional(propagation = Propagation.REQUIRED, isolation = Isolation.DEFAULT,readOnly = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AccountServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">AccountService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> AccountDaoImpl dao;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDao</span><span class="params">(AccountDaoImpl dao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dao = dao;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(String out, String in, Double money)</span> &#123;</span><br><span class="line">        dao.outMoney(out, money);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line">        dao.inMoney(in, money);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring自动装配@Autowired的三种方式</title>
    <url>/posts/Spring_uses_@Autowired_in_three_ways.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在IDEA升级2017版后，发现以前使用的<code>@Autowired</code>出现了个警告<code>Field injection is not recommended</code>。<br>虽然不是异常，但就是看着不舒服，所以google了一下，发现了<a href="http://stackoverflow.com/questions/39890849/what-exactly-is-field-injection-and-how-to-avoid-it">stackoverflow</a> 已经有人提了这个问题，并得到了解答。</p>
<span id="more"></span>

<h1 id="Autowired的不推荐用法"><a href="#Autowired的不推荐用法" class="headerlink" title="@Autowired的不推荐用法"></a>@Autowired的不推荐用法</h1><p>在一个Bean内，可以使用<code>@Autowired</code>注入另一个Bean。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dependency</span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DI</span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> Dependency dependency;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>事实上，这就是我平常使用的方式，直接在<code>Field</code>上添加注解，简洁又好看。<br>但这是不推荐的使用方法。</p>
<h1 id="Autowired的三种使用方式"><a href="#Autowired的三种使用方式" class="headerlink" title="@Autowired的三种使用方式"></a>@Autowired的三种使用方式</h1><ol>
<li>通过构造器注入</li>
<li>通过setter方法注入</li>
<li>通过field反射注入</li>
</ol>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DI</span>&#123;</span><br><span class="line">    <span class="comment">//通过构造器注入</span></span><br><span class="line">    <span class="keyword">private</span> DependencyA a;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DI</span><span class="params">(DependencyA a)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.a = a;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过setter方法注入</span></span><br><span class="line">    <span class="keyword">private</span> DependencyB b;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDependencyB</span><span class="params">(DependencyB b)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.b = b;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//通过field反射注入</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DependencyC c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="弊端"><a href="#弊端" class="headerlink" title="弊端"></a>弊端</h1><p><strong>如果你使用的是构造器注入</strong><br>恭喜你，当你有十几个甚至更多对象需要注入时，你的构造函数的<code>参数个数</code>可能会长到无法想像。</p>
<p><strong>如果你使用的是field反射注入</strong><br>如果不使用Spring框架，这个属性只能通过反射注入，太麻烦了！这根本不符合<code>JavaBean</code>规范。<br>还有，当你不是用过<code>Spring</code>创建的对象时，还可能引起<code>NullPointerException</code>。<br>并且，你不能用<code>final</code>修饰这个属性。</p>
<p><strong>如果你使用的是setter方法注入</strong><br>那么你将不能将属性设置为<code>final</code>。</p>
<h1 id="两者取其轻"><a href="#两者取其轻" class="headerlink" title="两者取其轻"></a>两者取其轻</h1><p>Spring3.0官方文档建议使用setter注入覆盖构造器注入。<br>Spring4.0官方文档建议使用构造器注入。</p>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p>如果注入的属性是<code>必选</code>的属性，则通过构造器注入。<br>如果注入的属性是<code>可选</code>的属性，则通过setter方法注入。<br>至于field注入，不建议使用。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="http://vojtechruzicka.com/field-dependency-injection-considered-harmful/">Field Dependency Injection Considered Harmful</a></li>
<li><a href="http://stackoverflow.com/questions/39890849/what-exactly-is-field-injection-and-how-to-avoid-it">What exactly is Field Injection and how to avoid it?</a></li>
</ol>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring默认以包名加类名为BeanName解决命名冲突</title>
    <url>/posts/Spring_resolves_naming_conflicts_by_default_with_PackageName_ClassName_BeanName.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Spring</code>可以自动将<code>@Component</code>注解修饰的类加载为<code>Bean</code>.<br>比如<code>MyController</code>这个类, 就会加载为名称是<code>myController</code>的<code>Bean</code>.<br>但是, 如果在不同的模块下, 不同的包下, 有着相同文件名的类, 就会造成<code>BeanName</code>冲突。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">- com.ahao.project</span><br><span class="line">    -  moduleA</span><br><span class="line">        - IndexController.java</span><br><span class="line">        - moduleAService.java</span><br><span class="line">    - moduleB</span><br><span class="line">        - IndexController.java</span><br><span class="line">        - moduleBService.java</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>为什么我们使用<code>Java</code>类的时候不会发生冲突呢?<br>因为<code>import</code>将包名导入了, 否则我们需要输入<code>包名.类名</code>才能使用这个类。</p>
<p>引用这个思路, 将<code>BeanName</code>也设置成<code>包名.类名</code>的形式。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">beans</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ahao&quot;</span> <span class="attr">name-generator</span>=<span class="string">&quot;com.ahao.core.spring.bean.PackageBeanNameGenerator&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PackageBeanNameGenerator</span> <span class="keyword">extends</span> <span class="title class_">AnnotationBeanNameGenerator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(PackageBeanNameGenerator.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">generateBeanName</span><span class="params">(BeanDefinition definition, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">beanClassName</span> <span class="operator">=</span> Introspector.decapitalize(definition.getBeanClassName());</span><br><span class="line">        <span class="keyword">if</span>(StringUtils.startsWith(beanClassName, getPackageNamePrefix())) &#123;</span><br><span class="line">            logger.debug(<span class="string">&quot;初始化Bean: &quot;</span> + beanClassName);</span><br><span class="line">            <span class="keyword">return</span> beanClassName;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.generateBeanName(definition, registry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getPackageNamePrefix</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">separator</span> <span class="operator">=</span> <span class="string">&quot;.&quot;</span>;</span><br><span class="line">        String[] splits = StringUtils.split(<span class="built_in">this</span>.getClass().getPackage().getName(), separator);</span><br><span class="line">        <span class="type">String</span> <span class="variable">prefix</span> <span class="operator">=</span> Arrays.stream(splits).limit(<span class="number">3</span>)</span><br><span class="line">                .collect(Collectors.joining(separator));</span><br><span class="line">        <span class="keyword">return</span> prefix;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Mybatis使用BeanNameGenerator"><a href="#Mybatis使用BeanNameGenerator" class="headerlink" title="Mybatis使用BeanNameGenerator"></a>Mybatis使用BeanNameGenerator</h1><p>在<code>Spring</code>整合发现<code>Mybatis</code>的<code>BeanName</code>生成没有使用<code>BeanNameGenerator</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">&quot;com.ahao&quot;</span> <span class="attr">use-default-filters</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">name-generator</span>=<span class="string">&quot;com.ahao.core.beans.PackageBeanNameGenerator&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">&quot;annotation&quot;</span> <span class="attr">expression</span>=<span class="string">&quot;org.springframework.stereotype.Repository&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ModuleDAO</span> &#123;</span><br><span class="line">    List&lt;String&gt; <span class="title function_">getNames</span><span class="params">()</span>; <span class="comment">// 使用 ModuleMapper.xml</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在调试时，<code>Mybatis</code>的代理类没有使用<code>@Repository</code>注解，所以<code>include-filter</code>没有扫描到代理类。</p>
<p>在<code>Stack Overflow</code>提问也没人回。<br>后来自己找到了解决方法, 在配置<code>MapperScannerConfigurer</code>时注入<code>NameGenerator</code>即可。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 配置扫描Dao接口包,动态实现DAO接口,注入到spring容器 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--注入SqlSessionFactory--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;sqlSessionFactory&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 给出需要扫描的Dao接口--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;basePackage&quot;</span> <span class="attr">value</span>=<span class="string">&quot;com.ahao.**.dao&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;nameGenerator&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">&quot;com.ahao.core.spring.beans.PackageBeanNameGenerator&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Spring-Boot-基于注解的配置"><a href="#Spring-Boot-基于注解的配置" class="headerlink" title="Spring Boot 基于注解的配置"></a>Spring Boot 基于注解的配置</h1><p><code>Spring Boot</code>分为两种启动方式</p>
<ul>
<li>通过<code>main</code>方法启动内嵌<code>Tomcat</code></li>
<li>打包<code>war</code>包启动外置<code>Tomcat</code></li>
</ul>
<p>直接看代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1. main方法启动</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Application</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">SpringApplication</span> <span class="variable">app</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpringApplication</span>(Application.class);</span><br><span class="line">        app.setBeanNameGenerator(<span class="keyword">new</span> <span class="title class_">PackageBeanNameGenerator</span>());</span><br><span class="line">        app.run(args);</span><br><span class="line">        logger.info(<span class="string">&quot;Spring Boot 启动成功!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 外置Tomcat启动</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AppServletInitializer</span> <span class="keyword">extends</span> <span class="title class_">SpringBootServletInitializer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> SpringApplicationBuilder <span class="title function_">configure</span><span class="params">(SpringApplicationBuilder builder)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(Application.class)</span><br><span class="line">                .beanNameGenerator(<span class="keyword">new</span> <span class="title class_">PackageBeanNameGenerator</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同样的, <code>Mybatis</code>依然需要单独配置, 重点在<code>@MapperScan</code>注解</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnProperty(prefix = &quot;ahao.datasource&quot;, name = &quot;open&quot;, havingValue = &quot;false&quot;, matchIfMissing = true)</span></span><br><span class="line"><span class="meta">@EnableTransactionManagement</span></span><br><span class="line"><span class="meta">@MapperScan(basePackages = &#123;&quot;com.ahao.**.dao&quot;&#125;, nameGenerator = PackageBeanNameGenerator.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DataSourceConfig</span> &#123;</span><br><span class="line">    <span class="comment">// 数据源连接池配置, DruidProperties是自定义的配置类</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DruidDataSource <span class="title function_">dataSource</span><span class="params">(DruidProperties druidProperties)</span> &#123;</span><br><span class="line">        <span class="type">DruidDataSource</span> <span class="variable">dataSource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DruidDataSource</span>();</span><br><span class="line">        druidProperties.config(dataSource);</span><br><span class="line">        <span class="keyword">return</span> dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/5414215">automatically-assign-springs-bean-name-to-prevent-name-conflicts</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
        <tag>Spring</tag>
      </tags>
  </entry>
  <entry>
    <title>Struts2修改url后缀</title>
    <url>/posts/Struts2_how_to_custom_url_suffix.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>使用struts2的url一般为<code>http://localhost:8080/test.action</code><br>有时候需要改为<code>http://localhost:8080/test.html</code></p>
<span id="more"></span>

<h1 id="在struts-xml中配置"><a href="#在struts-xml中配置" class="headerlink" title="在struts.xml中配置"></a>在struts.xml中配置</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constant</span> <span class="attr">name</span>=<span class="string">&quot;struts.action.extension&quot;</span> <span class="attr">value</span>=<span class="string">&quot;html&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="在struts-properties中配置"><a href="#在struts-properties中配置" class="headerlink" title="在struts.properties中配置"></a>在struts.properties中配置</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">struts.action.extension=action,do,struts2,</span><br></pre></td></tr></table></figure>

<h1 id="在web-xml的filter中配置"><a href="#在web-xml的filter中配置" class="headerlink" title="在web.xml的filter中配置"></a>在web.xml的filter中配置</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>struts2<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>org.apache.struts2.dispatcher.ng.filter.StrutsPrepareAndExecuteFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>struts.action.extension<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>action,do,struts2,<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Struts2</tag>
      </tags>
  </entry>
  <entry>
    <title>Struts2学习总结</title>
    <url>/posts/Struts2_summarize.html</url>
    <content><![CDATA[<h1 id="Action搜索顺序"><a href="#Action搜索顺序" class="headerlink" title="Action搜索顺序"></a>Action搜索顺序</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;/test&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;myAction&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<p>访问<code>http://localhost:8080/test/aaa/bbb/ccc/myAction</code>时，先查找<code>ccc</code>命名空间的包下有没有<code>myAction</code>。没有再找到<code>bbb</code>，再找<code>aaa</code>。都找不到<code>myAction</code>。这时找到<code>test</code>命名空间的包下，找到了<code>myAction</code>，搜索结束。如果还是没有找到<code>myAction</code>，则往默认命名空间下找，找不到抛出。</p>
<h1 id="result的type属性"><a href="#result的type属性" class="headerlink" title="result的type属性"></a>result的type属性</h1><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span> <span class="attr">namespace</span>=<span class="string">&quot;/test&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;myAction&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">&quot;dispatcher&quot;</span>&gt;</span>/index.jsp<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">name</span>=<span class="string">&quot;error&quot;</span> <span class="attr">type</span>=<span class="string">&quot;redirect&quot;</span>&gt;</span>/index.jsp?username=$&#123;username&#125;<span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>默认情况下是转发（<code>dispatcher</code>）。</p>
<ul>
<li>重定向是<code>redirect</code>，可以用<code>$&#123;username&#125;</code>传递<code>Action</code>中的属性，中文记得使用<code>URLEncoder.encode(&quot;中文&quot;, &quot;UTF-8&quot;)</code>。</li>
<li>重定向<code>Action</code>是<code>redirectAction</code>，在<code>result</code>标签下的<code>namespace</code>标签可以指定其他命名空间的<code>Action</code>。</li>
<li>查看源码是<code>plainText</code>，中文要在<code>result</code>标签加上<code>&lt;param name=&quot;charSet&quot;&gt;UTF-8&lt;/param&gt;</code></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Struts2</tag>
      </tags>
  </entry>
  <entry>
    <title>Struts2接收参数</title>
    <url>/posts/Struts2_how_to_access_parameters.html</url>
    <content><![CDATA[<h1 id="使用Action的属性接收参数"><a href="#使用Action的属性接收参数" class="headerlink" title="使用Action的属性接收参数"></a>使用Action的属性接收参数</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--表单loginJSP.jsp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;myAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(getUsername()+<span class="string">&quot;:&quot;</span>+getPassword());</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//getter和setter方法，重要！Struts2是通过反射完成的！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="使用Domain-Model接收参数"><a href="#使用Domain-Model接收参数" class="headerlink" title="使用Domain Model接收参数"></a>使用Domain Model接收参数</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--表单loginJSP.jsp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;myAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user.username&quot;</span>/&gt;</span><span class="comment">&lt;!--指定对象名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;user.password&quot;</span> /&gt;</span><span class="comment">&lt;!--指定对象名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//getter和setter方法，重要！Struts2是通过反射完成的！</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(user.getUsername()+<span class="string">&quot;:&quot;</span>+user.getPassword());</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//getter和setter方法，重要！Struts2是通过反射完成的！</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="实现ModelDriven接口接收参数"><a href="#实现ModelDriven接口接收参数" class="headerlink" title="实现ModelDriven接口接收参数"></a>实现ModelDriven接口接收参数</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--表单loginJSP.jsp--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;myAction&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;username&quot;</span>/&gt;</span><span class="comment">&lt;!--不用指定对象名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span> <span class="attr">name</span>=<span class="string">&quot;password&quot;</span> /&gt;</span><span class="comment">&lt;!--不用指定对象名--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="comment">//getter和setter方法，重要！Struts2是通过反射完成的！</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAction</span> <span class="keyword">extends</span> <span class="title class_">ActionSupport</span> <span class="keyword">implements</span> <span class="title class_">ModelDriven</span>&lt;User&gt;&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">execute</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        System.out.println(user.getUsername()+<span class="string">&quot;:&quot;</span>+user.getPassword());</span><br><span class="line">        <span class="keyword">return</span> SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//去掉getter和setter方法，需自己new User</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getModel</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Struts2</tag>
      </tags>
  </entry>
  <entry>
    <title>Struts2自定义拦截器</title>
    <url>/posts/Struts2_how_to_Custom_interceptors.html</url>
    <content><![CDATA[<h1 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h1><h2 id="实现Interceptor接口"><a href="#实现Interceptor接口" class="headerlink" title="实现Interceptor接口"></a>实现Interceptor接口</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Interceptor</span> <span class="keyword">extends</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>;<span class="comment">//初始化拦截器所需资源</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>;<span class="comment">//释放在init()中分配的资源</span></span><br><span class="line">    String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">    <span class="comment">//实现拦截器功能</span></span><br><span class="line">    <span class="comment">//利用invocation.getAction()获取Action状态</span></span><br><span class="line">    <span class="comment">//返回result作为逻辑视图名，比如success</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="继承AbstractInterceptor抽象类"><a href="#继承AbstractInterceptor抽象类" class="headerlink" title="继承AbstractInterceptor抽象类"></a>继承AbstractInterceptor抽象类</h2><p><code>AbstractInterceptor</code>类实现了<code>Interceptor</code>接口</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AbstractInterceptor</span> <span class="keyword">implements</span> <span class="title class_">Interceptor</span>&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span>&#123;&#125;<span class="comment">//空实现</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span>&#123;&#125;<span class="comment">//空实现</span></span><br><span class="line">    String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><p>在<code>struts.xml</code>中注册拦截器</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">struts</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">&quot;default&quot;</span> <span class="attr">extends</span>=<span class="string">&quot;struts-default&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">interceptors</span>&gt;</span><span class="comment">&lt;!--注册拦截器--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interceptor</span> <span class="attr">name</span>=<span class="string">&quot;myInterceptor&quot;</span> <span class="attr">class</span>=<span class="string">&quot;包名.MyInterceptor&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">interceptors</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">&quot;myAction&quot;</span> <span class="attr">class</span>=<span class="string">&quot;包名.MyAction&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">&quot;myInterceptor&quot;</span> /&gt;</span><span class="comment">&lt;!--引用拦截器--&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">action</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">package</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">struts</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="内置拦截器"><a href="#内置拦截器" class="headerlink" title="内置拦截器"></a>内置拦截器</h1><p>在<code>struts-default.xml</code>中</p>
<table>
<thead>
<tr>
<th align="left">拦截器</th>
<th align="left">作用</th>
</tr>
</thead>
<tbody><tr>
<td align="left">params拦截器</td>
<td align="left">负责将请求参数设置为Action属性</td>
</tr>
<tr>
<td align="left">staticParams拦截器</td>
<td align="left">将配置文件中action元素的子元素param参数设置为Action属性</td>
</tr>
<tr>
<td align="left">servletConfig拦截器</td>
<td align="left">将源于ServletAPI的各种对象注入到Action，必须实现对应接口</td>
</tr>
<tr>
<td align="left">fileUpload拦截器</td>
<td align="left">对文件上传提供支持，将文件和元数据设置到对应的Action属性</td>
</tr>
<tr>
<td align="left">exception拦截器</td>
<td align="left">捕获异常，并且将异常映射到用户自定义的错误界面</td>
</tr>
<tr>
<td align="left">validation拦截器</td>
<td align="left">调用验证框架进行数据验证</td>
</tr>
</tbody></table>
<h1 id="简单功能"><a href="#简单功能" class="headerlink" title="简单功能"></a>简单功能</h1><h2 id="计算Action执行时间"><a href="#计算Action执行时间" class="headerlink" title="计算Action执行时间"></a>计算Action执行时间</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimerInterceptor</span> <span class="keyword">extends</span> <span class="title class_">AbstractInterceptor</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> invocation.invoke();<span class="comment">//执行下一个拦截器，如果没有拦截器就执行Action，返回视图名，如&quot;success&quot;</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;时间：&quot;</span>+(end-start)/<span class="number">1000</span>+<span class="string">&quot;s&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="权限校验"><a href="#权限校验" class="headerlink" title="权限校验"></a>权限校验</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthInterceptor</span> <span class="keyword">extends</span> <span class="title class_">AbstractInterceptor</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">ActionContext</span> <span class="variable">context</span> <span class="operator">=</span> ActionContext.getContext();</span><br><span class="line">        Map&lt;String, Object&gt; session = context.getSession();</span><br><span class="line">        <span class="keyword">if</span>(session.get(<span class="string">&quot;loginInfo&quot;</span>)!=<span class="literal">null</span>) &#123; <span class="comment">//已登录</span></span><br><span class="line">            <span class="keyword">return</span> invocation.invoke();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;<span class="comment">//未登录</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;<span class="comment">//需要登录</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Struts2</tag>
      </tags>
  </entry>
  <entry>
    <title>Struts2访问ServletAPI</title>
    <url>/posts/Struts2_how_to_aware_ServletAPI.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Servlet API就是HttpServletRequest(Request)、HttpSession(Session)、ServletContext(Application)</p>
<span id="more"></span>

<h1 id="通过ActionContext类访问"><a href="#通过ActionContext类访问" class="headerlink" title="通过ActionContext类访问"></a>通过ActionContext类访问</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ActionContext</span> <span class="variable">ctx</span> <span class="operator">=</span> ActionContext.getContext();<span class="comment">//单例模式</span></span><br><span class="line"><span class="comment">//访问application</span></span><br><span class="line">Map&lt;String, Object&gt; application = ctx.getApplication();<span class="comment">//Map对象模拟ServletContext实例</span></span><br><span class="line">application.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line"><span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> application.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">ctx.setApplication(map);<span class="comment">//传入一个新的Map</span></span><br><span class="line"><span class="comment">//访问Session</span></span><br><span class="line">Map&lt;String, Object&gt; session= ctx.getSession();<span class="comment">//Map对象模拟ServletContext实例</span></span><br><span class="line">application.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line"><span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> application.get(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">ctx.setSession(map);<span class="comment">//传入一个新的Map</span></span><br><span class="line"><span class="comment">//访问Request</span></span><br><span class="line">ctx.put(<span class="string">&quot;key&quot;</span>, value);<span class="comment">//类似调用request.putAttribute(&quot;key&quot;, value)</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> ctx.get(<span class="string">&quot;key&quot;</span>);<span class="comment">//类似调用request.getAttribute(&quot;key&quot;)</span></span><br><span class="line">Map&lt;String, Object&gt; request = ctx.getParameters();<span class="comment">//类似调用request.getParameterMap()</span></span><br></pre></td></tr></table></figure>

<h1 id="实现XxxAware接口"><a href="#实现XxxAware接口" class="headerlink" title="实现XxxAware接口"></a>实现XxxAware接口</h1><ol>
<li><code>ServletContextAware</code> ：直接访问<code>ServletContext(application)</code>  实例</li>
<li><code>ServletRequestAware</code> ：直接访问<code>HttpServletRequest(request)</code>  实例</li>
<li><code>ServletResponseAware</code>：直接访问<code>HttpServletResponse(response)</code>实例</li>
</ol>
<h1 id="通过ServletActionContext类访问"><a href="#通过ServletActionContext类访问" class="headerlink" title="通过ServletActionContext类访问"></a>通过ServletActionContext类访问</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">PageContext</span> <span class="variable">pageContext</span>      <span class="operator">=</span> ServletActionContext.getPageContext();</span><br><span class="line"><span class="type">HttpServletRequest</span> <span class="variable">request</span>   <span class="operator">=</span> ServletActionContext.getRequest();</span><br><span class="line"><span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> ServletActionContext.getResponse();</span><br><span class="line"><span class="type">ServletContext</span> <span class="variable">application</span>   <span class="operator">=</span> ServletActionContext.getServletContext();</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Struts2</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat常用操作</title>
    <url>/posts/Tomcat_common_setting.html</url>
    <content><![CDATA[<h1 id="更改端口号"><a href="#更改端口号" class="headerlink" title="更改端口号"></a>更改端口号</h1><p><code>Tomcat</code>默认端口号为<code>8080</code>，在<code>Tomcat</code>目录的<code>/conf/server.xml</code>中配置。<br>找到如下代码，将<code>8080</code>改为想要修改的端口号即可</p>
<span id="more"></span>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--省略无关代码--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Connector</span> <span class="attr">port</span>=<span class="string">&quot;8080&quot;</span> <span class="attr">protocol</span>=<span class="string">&quot;HTTP/1.1&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">connectionTimeout</span>=<span class="string">&quot;20000&quot;</span></span></span><br><span class="line"><span class="tag">               <span class="attr">redirectPort</span>=<span class="string">&quot;8443&quot;</span> /&gt;</span></span><br><span class="line"><span class="comment">&lt;!--省略无关代码--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="外部应用"><a href="#外部应用" class="headerlink" title="外部应用"></a>外部应用</h1><p><code>Tomcat</code>默认应用在<code>webapps</code>文件夹中，如果在外部编写<code>javaweb</code>应用，需要在<code>/conf/server.xml</code>编写代码，或者<code>/conf/Catalina/localhost</code>中创建<code>xml</code>文件。<br>在地址栏输入对应<code>url</code>即可访问。</p>
<h2 id="在server-xml中配置"><a href="#在server-xml中配置" class="headerlink" title="在server.xml中配置"></a>在server.xml中配置</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- &lt;Context path=&quot;url路径名&quot;　docBase=&quot;实际项目在磁盘中地址&quot; /&gt; --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;helloWorld&quot;</span>　<span class="attr">docBase</span>=<span class="string">&quot;C:/HelloWorld&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="在catalina-localhost中配置"><a href="#在catalina-localhost中配置" class="headerlink" title="在catalina/localhost中配置"></a>在catalina/localhost中配置</h2><p>创建一个以<code>url</code>路径名命名的<code>xml</code>文件<code>helloWorld.xml</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">docBase</span>=<span class="string">&quot;C:/HelloWorld&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="映射虚拟主机"><a href="#映射虚拟主机" class="headerlink" title="映射虚拟主机"></a>映射虚拟主机</h1><p>浏览器使用<code>80</code>端口，如<code>http://www.test.com</code>和<code>http://www.test.com:80</code>等价。<br>在<code>%windir%\system32\drivers\etc\hosts</code>中添加<code>127.0.0.1 http://www.test.com</code><br>在<code>server.xml</code>中配置新的<code>host</code>信息</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;www.test.com&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;C:/helloworld&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat自定义异常页面</title>
    <url>/posts/Customize_Tomcat_Exceptions_Page.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Tomcat</code>在抛出异常的时候会自动跳转到带有异常堆栈的错误页面, 这很容易暴露自己的代码。</p>
<span id="more"></span>

<h1 id="Tomcat的原生解决方案"><a href="#Tomcat的原生解决方案" class="headerlink" title="Tomcat的原生解决方案"></a>Tomcat的原生解决方案</h1><p>在项目的<code>/WEB-INF/web.xml</code>中指定自定义的默认页面即可, 并且该页面要与<code>WEB-INF</code>文件夹放在同一个目录下。<br>如果是<code>Servlet 2.5</code>, 还需要指定<code>Http</code>状态码。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 支持Servlet 2.5+, 如果要对状态码特别指定页面, 需要按顺序排列error-page标签  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>500<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/500.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!-- 支持Servlet 3  --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/Error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exception-type</span>&gt;</span>java.lang.Exception<span class="tag">&lt;/<span class="name">exception-type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/Error.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="SpringMVC的解决方案"><a href="#SpringMVC的解决方案" class="headerlink" title="SpringMVC的解决方案"></a>SpringMVC的解决方案</h1><p><code>Tomcat</code>的解决方案局限性太大, 也不能做逻辑处理记录到数据库之类的操作。</p>
<p>使用<code>ControllerAdvice</code>进行拦截, 并处理逻辑, 也可以重定向到其他页面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ErrorController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LoggerFactory.getLogger(ErrorController.class);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExceptionHandler(Exception.class)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleConflict</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Exception e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 如果使用@ResponseStatus注释异常，则重新抛出该异常并让框架处理该异常</span></span><br><span class="line">        <span class="keyword">if</span> (AnnotationUtils.findAnnotation(e.getClass(), ResponseStatus.class) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        logger.error(<span class="string">&quot;发生了错误&quot;</span>, e);</span><br><span class="line">        <span class="comment">// 逻辑操作, 记录到数据库等</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置状态码, 并输出错误信息</span></span><br><span class="line">        response.setStatus(<span class="number">500</span>);</span><br><span class="line">        response.getWriter().println(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://spring.io/blog/2013/11/01/exception-handling-in-spring-mvc">exception-handling-in-spring-mvc</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat部署web项目的方法</title>
    <url>/posts/The_ways_of_deploy_Web_project_with_Tomcat.html</url>
    <content><![CDATA[<h1 id="内部应用"><a href="#内部应用" class="headerlink" title="内部应用"></a>内部应用</h1><p>直接把war包复制粘贴到<code>Tomcat 8.5/webapps</code>目录下, 然后执行<code>Tomcat 8.5/bin/startup.bat</code>即可。</p>
<span id="more"></span>

<h1 id="外部应用"><a href="#外部应用" class="headerlink" title="外部应用"></a>外部应用</h1><ul>
<li>docBase: 项目文件夹实际的位置, 子目录为<code>WEB-INF</code>、<code>META-INF</code>的一个目录。</li>
<li>path: 虚拟路径, 浏览器访问本项目的路径, 上面例子为<code>http://本机地址:端口/hello</code></li>
</ul>
<h2 id="配置conf-server-xml-官方不推荐"><a href="#配置conf-server-xml-官方不推荐" class="headerlink" title="配置conf/server.xml(官方不推荐)"></a>配置conf/server.xml(官方不推荐)</h2><p>打开<code>Tomcat 8.5/conf/server.xml</code>, 在<code>&lt;Host&gt;</code>标签插入<code>&lt;Context&gt;</code>标签。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Service</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">Engine</span> <span class="attr">name</span>=<span class="string">&quot;Catalina&quot;</span> <span class="attr">defaultHost</span>=<span class="string">&quot;localhost&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">Host</span> <span class="attr">name</span>=<span class="string">&quot;localhost&quot;</span>  <span class="attr">appBase</span>=<span class="string">&quot;webapps&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">unpackWARs</span>=<span class="string">&quot;true&quot;</span> <span class="attr">autoDeploy</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- &lt;Context path=&quot;url路径名&quot;　docBase=&quot;实际项目在磁盘中地址&quot; /&gt; --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/hello&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;war包解压路径&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">privileged</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">Host</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">Engine</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Service</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置conf-context-xml"><a href="#配置conf-context-xml" class="headerlink" title="配置conf/context.xml"></a>配置conf/context.xml</h2><p>打开<code>conf/context.xml</code>可以看到里面已经配置了一个<code>Context</code>.<br>如果一个<code>Tomcat</code>只配置一个<code>Web</code>应用程序, 则可以直接修改这里的代码.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>改为</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/hello&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;war包解压路径&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">privileged</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>WEB-INF/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">WatchedResource</span>&gt;</span>$&#123;catalina.base&#125;/conf/web.xml<span class="tag">&lt;/<span class="name">WatchedResource</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="配置conf-enginename-hostname-test-xml-推荐"><a href="#配置conf-enginename-hostname-test-xml-推荐" class="headerlink" title="配置conf/enginename/hostname/test.xml(推荐)"></a>配置conf/enginename/hostname/test.xml(推荐)</h2><p>其实就是将<code>conf/server.xml</code>翻译一下。</p>
<p>打开<code>Tomcat 8.5/conf/Catalina/localhost</code>, 没有则自己创建目录, 新建一个<code>test.xml</code>文件。<br>这里的<code>Catalina</code>对应上面的<code>Engine</code>名, <code>localhost</code>对应上面的<code>Host</code>名.<br>访问路径为<code>http://localhost:8080/test</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;war包解压路径&quot;</span> <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">privileged</span>=<span class="string">&quot;true&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.csdn.net/wjx85840948/article/details/6749964">tomcat部署web项目的3种方法</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat部署外部应用最佳实践</title>
    <url>/posts/Best_Practices_of_deploys_Outside_Application_with_Tomcat.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Tomcat有一个扩展点, 可以配置环境变量<br><code>Tomcat 8.5\bin\setenv.sh</code>, 如果没有可以手动创建。</p>
<ul>
<li>Windows用 <code>bat</code> 后缀</li>
<li>Linux用 <code>sh</code> 后缀</li>
</ul>
<span id="more"></span>

<h1 id="配置setenv-bat"><a href="#配置setenv-bat" class="headerlink" title="配置setenv.bat"></a>配置setenv.bat</h1><p>在 <code>Tomcat\bin</code> 目录下新建 <code>setenv.bat</code>文件。<br>输入如下配置<br>Windows</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set JAVA_HOME=D:\Java\jdk1.8.0_112(替换为jdk的路径)</span><br><span class="line">set JAVA_OPTS=-Xmx512m</span><br><span class="line">set TITLE=自定义的标题</span><br></pre></td></tr></table></figure>

<p>Linux</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">JAVA_HOME=/opt/jdk/jdk1.8.0_181</span><br><span class="line">JAVA_OPTS=-Xmx512m</span><br><span class="line">CATALINA_PID=$CATALINA_HOME/bin/CATALINA_PID # shutdown.sh -force 必须参数</span><br></pre></td></tr></table></figure>

<h1 id="配置ahao-xml"><a href="#配置ahao-xml" class="headerlink" title="配置ahao.xml"></a>配置ahao.xml</h1><p>在 <code>Tomcat\conf\Catalina\localhost</code> 目录下(没有则创建), 创建 <code>ahao.xml</code> 文件。<br>输入如下配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">Context</span> <span class="attr">path</span>=<span class="string">&quot;/&quot;</span> <span class="attr">docBase</span>=<span class="string">&quot;F:\ahao&quot;</span> </span></span><br><span class="line"><span class="tag">        <span class="attr">reloadable</span>=<span class="string">&quot;true&quot;</span> <span class="attr">privileged</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">Context</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><code>docBase</code> 是 <code>war</code> 包的解压路径。<br>通俗讲, 就是包含子目录为 <code>WEB-INF</code> 、 <code>META-INF</code> 的一个目录。</p>
<h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h1><p>打开 <code>Tomcat\bin\startup.bat</code> 即可。<br>输入 <code>http://localhost:8080/ahao</code> 。<br>这里的项目名就是之前配置的 <code>xml</code> 的名称。</p>
<h1 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h1><p>在catalina.sh文件中会自动载入环境变量</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">if [ -r &quot;$CATALINA_BASE/bin/setenv.sh&quot; ]; then</span><br><span class="line">  . &quot;$CATALINA_BASE/bin/setenv.sh&quot;</span><br><span class="line">elif [ -r &quot;$CATALINA_HOME/bin/setenv.sh&quot; ]; then</span><br><span class="line">  . &quot;$CATALINA_HOME/bin/setenv.sh&quot;</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>最佳实践</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>currentRequestAttributes和getRequestAttributes获取HttpServletRequest对象</title>
    <url>/posts/use_currentRequestAttributes()_and_getRequestAttributes()_to_get_HttpServletRequest_object.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Spring</code>获取<code>HttpServletRequest</code>的方法有很多。<br>比较常用的是使用<code>@Autowired</code>或者直接在方法参数里面注入。</p>
<span id="more"></span>

<h1 id="问题场景"><a href="#问题场景" class="headerlink" title="问题场景"></a>问题场景</h1><p>从数据库<code>dao</code>层取出了<code>url</code>资源路径, 需要结合<code>ContextPath</code>进行补充。<br>比如访问<code>http://localhost:8080/project/userList</code>, 项目路径是<code>project</code>。<br>查询到以下数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id    name       avatar_url</span><br><span class="line">1     user1     /avatar1.jpg</span><br><span class="line">2     user2     /avatar2.jpg</span><br><span class="line">3     user3     /avatar3.jpg</span><br></pre></td></tr></table></figure>
<p>如果直接将<code>avatar_url</code>填入<code>&lt;img src=&quot;/avatar1.jpg&quot;/&gt;</code>中的话, 会出现<code>404</code>错误。<br>需要在前面添加项目路径<code>ContextPath</code>, 也就是<code>&lt;img src=&quot;/project/avatar1.jpg&quot;/&gt;</code>才能正常访问。</p>
<h1 id="尝试解决"><a href="#尝试解决" class="headerlink" title="尝试解决"></a>尝试解决</h1><p>现在的项目一般都是通过<code>MVC</code>完成的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyService myService;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyController</span><span class="params">(MyService myService)</span>&#123; <span class="built_in">this</span>.myService = myService; &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userList&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">userList</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> myService.getUserList();    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MyService</span>&#123; List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">getUserList</span><span class="params">()</span>; &#125;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">MyService</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> MyDao myDao;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyServiceImpl</span><span class="params">(MyDao myDao)</span> &#123; <span class="built_in">this</span>.myDao = myDao; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">getUserList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 给avatar_url添加contextPath前缀</span></span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; list = myDao.getUserList();</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, String&gt; user : list) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">url</span> <span class="operator">=</span> user.get(<span class="string">&quot;avatar_url&quot;</span>);</span><br><span class="line">            user.put(<span class="string">&quot;avatar_url&quot;</span>, contextPath+url);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDao</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">getUserList</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">// 模拟从数据库取出数据</span></span><br><span class="line">        List&lt;Map&lt;String, String&gt;&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)&#123;</span><br><span class="line">            Map&lt;String, String&gt; user = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">            user.put(<span class="string">&quot;id&quot;</span>, String.valueOf(i));</span><br><span class="line">            user.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;user&quot;</span>+i);</span><br><span class="line">            user.put(<span class="string">&quot;avatar_url&quot;</span>, <span class="string">&quot;/avatar&quot;</span>+i+<span class="string">&quot;.jpg&quot;</span>);</span><br><span class="line">            list.add(user);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="使用Spring自动注入"><a href="#使用Spring自动注入" class="headerlink" title="使用Spring自动注入"></a>使用Spring自动注入</h2><p>只要是实现了<code>@Component</code>注解(<code>@Controller</code>中包含<code>@Component</code>, 注意, 注解没有继承), <code>Spring</code>就可以自动为其注入<code>HttpServletRequest</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyController</span>&#123;</span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line"></span><br><span class="line">    HttpServletRequest request1; <span class="comment">// 1. 第一种方法</span></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/userList&quot;)</span></span><br><span class="line">    <span class="comment">// 2. 第二种方法</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Map&lt;String, String&gt;&gt; <span class="title function_">userList</span><span class="params">(HttpServletRequest request2)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> myService.getUserList();    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面两种都可以取得<strong>线程安全</strong>的<code>HttpServletRequest</code>对象。</p>
<p>但是有个弊端。<br>使用<code>HttpServletRequest</code>对象的类必须实现<code>@Component</code>注解。<br>如果我是在工具类<code>Utils</code>中使用, 则必须要为<code>Utils</code>中的静态方法提供一个<code>HttpServletRequest</code>参数。<br>如果函数调用链足够深, 则会污染整个函数调用链, 导致每个链上的每个函数都有一个<code>HttpServletRequest</code>参数。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>每一个<code>Request</code>请求都是属于一个线程, 那么就应该可以存放在<code>ThreadLocal</code>对象中。<br><code>RequestContextHolder</code>类里面就有<code>ThreadLocal</code>对象。<br>它有两个方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.context.request.RequestContextHolder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RequestContextHolder</span>  &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; requestAttributesHolder =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">NamedThreadLocal</span>&lt;RequestAttributes&gt;(<span class="string">&quot;Request attributes&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;RequestAttributes&gt; inheritableRequestAttributesHolder =</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">NamedInheritableThreadLocal</span>&lt;RequestAttributes&gt;(<span class="string">&quot;Request context&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RequestAttributes <span class="title function_">getRequestAttributes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">RequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> requestAttributesHolder.get();</span><br><span class="line">        <span class="keyword">if</span> (attributes == <span class="literal">null</span>) &#123; attributes = inheritableRequestAttributesHolder.get(); &#125;</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> RequestAttributes <span class="title function_">currentRequestAttributes</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException &#123;</span><br><span class="line">        <span class="comment">// 调用getRequestAttributes()方法</span></span><br><span class="line">        <span class="type">RequestAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> getRequestAttributes();</span><br><span class="line">        <span class="keyword">if</span> (attributes == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (jsfPresent) &#123;</span><br><span class="line">                attributes = FacesRequestAttributesFactory.getFacesRequestAttributes();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (attributes == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;异常信息&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> attributes;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>currentRequestAttributes</code>方法调用了<code>getRequestAttributes</code>方法。追加了对<code>JSF</code>的判断。</p>
<p>所以我们可以直接使用<code>currentRequestAttributes</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RequestHelper</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">RequestHelper</span><span class="params">()</span> &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(<span class="string">&quot;工具类不允许实例化&quot;</span>); &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> HttpServletRequest <span class="title function_">getRequest</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ((ServletRequestAttributes) RequestContextHolder</span><br><span class="line">                .currentRequestAttributes()).getRequest(); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getContextPath</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getRequest().getContextPath();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/47586707">what-is-the-difference-between-these-methods-of-requestcontextholder-currentre</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>shiro.ini异常Line argument must contain a key and a value.  Only one string token was found.</title>
    <url>/posts/Line_argument_must_contain_a_key_and_a_value._Only_one_string_token_was_found..html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在读取<a href="https://shiro.apache.org/">shiro.ini</a>的时候, 抛出了如下异常</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">user1</span>=password1</span><br><span class="line"><span class="attr">user2</span>=password2</span><br><span class="line"><span class="comment">;抛出Line argument must contain a key and a value.  Only one string token was found.</span></span><br></pre></td></tr></table></figure>
<p>不科学啊, 我这里都是有键值对的。怎么会说我没有完整的键值对呢?</p>
<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>在<a href="http://learningtogrowup.iteye.com/blog/2232917">这篇博客</a>找到了解决方案。<br>原来我的 <code>shiro.ini</code> 是 <code>UTF-8</code> 编码的, windows会自动给 <code>UTF-8</code> 编码加上 <code>BOM</code> 。<br>所以使用windows默认笔记本编辑的小伙伴就有福啦~, 被坑了。<br>用 <code>Notepad++</code> 打开, 点击 <code>编码-&gt;转为UTF-8无BOM编码格式</code> 即可。</p>
<h1 id="为什么改成-无BOM编码-就可以呢"><a href="#为什么改成-无BOM编码-就可以呢" class="headerlink" title="为什么改成 无BOM编码 就可以呢?"></a>为什么改成 无BOM编码 就可以呢?</h1><p>以下是引用或整合的一些信息。</p>
<ul>
<li>ANSI:<ol>
<li>ANSI编码表示英文字符时用一个字节，表示中文用两个或四个字节。</li>
<li>ANSI有很多个分支, 比较熟悉的有GB2312、GBK、GB18030、Big5, 这些使用多个字节表示一个字符的编码方式称为ANSI编码。</li>
<li>简体中文Windows是GBK编码。</li>
</ol>
</li>
<li>UTF-8 无BOM 和 UTF-8<ol>
<li>这里的BOM不是javascript的Browser Object Model浏览器对象模型。而是Byte Order Mark字节顺序标记</li>
<li>BOM会在文件的开头加入U+FEFF, 相当于一个【看不见的长度为0的空白字符】, 用于区分UTF-8和ASCII编码</li>
<li>windows会自动给UTF-8编码加上BOM。</li>
<li>UTF-8本身是没有字节序的问题的（因为它是以单个字节为最小单位）</li>
</ol>
</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://learningtogrowup.iteye.com/blog/2232917">java.lang.IllegalArgumentException: Line argument must contain a key and a value</a></li>
<li><a href="https://baike.baidu.com/item/ANSI">百度百科-ANSI</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E5%AD%97%E8%8A%82%E9%A1%BA%E5%BA%8F%E6%A0%87%E8%AE%B0">维基百科-字节顺序标记</a></li>
<li><a href="https://www.zhihu.com/question/20167122">「带 BOM 的 UTF-8」和「无 BOM 的 UTF-8」有什么区别？网页代码一般使用哪个？</a></li>
<li><a href="http://jimliu.net/2015/03/07/something-about-encoding-extra/">编码歪传——番外篇</a></li>
</ul>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>在已搭建的SSM环境直接执行sql语句</title>
    <url>/posts/execute_sql_statement_in_SSM_environment.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这几天遇到个需求, 需要用<code>Java</code>代码对数据处理后批量执行一些<code>SQL</code>语句, 这种是一次性的需求。<br>写一个<code>Mapper.xml</code>又显得太繁琐。自己写<code>JDBC</code>又要重新加载数据库驱动创建数据库连接，更累。</p>
<span id="more"></span>

<h1 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h1><p>编写<code>Class</code>代码不可取。缺点有二:</p>
<ol>
<li>修改<code>Class</code>需要重启<code>Tomcat</code>。</li>
<li>需要把<code>Class</code>设置为一个<code>Controller</code>。</li>
</ol>
<p>改为使用<code>JSP</code>。以上两个缺点都没了。</p>
<h1 id="使用JdbcTemplate"><a href="#使用JdbcTemplate" class="headerlink" title="使用JdbcTemplate"></a>使用JdbcTemplate</h1><p>因为是一次性的需求。写一个<code>Mapper.xml</code>又显得太繁琐。干脆就直接舍弃获取<code>Mybatis SqlSession</code>的方式。<br>使用<code>Spring Jdbc</code>自带的<code>JdbcTemplate</code>。</p>
<p>在<code>Spring</code>配置文件中添加<code>JdbcTemplate Bean</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;jdbcTemplate&quot;</span> <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.core.JdbcTemplate&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;dataSource&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在<code>JSP</code>页面获取这个<code>Bean</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%<span class="meta">@page</span> language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span> %&gt;</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="comment">// 1. 获取上下文</span></span><br><span class="line">    <span class="type">WebApplicationContext</span> <span class="variable">context</span> <span class="operator">=</span> WebApplicationContextUtils.getWebApplicationContext(getServletConfig().getServletContext());</span><br><span class="line">    <span class="comment">// 2. 获取Bean</span></span><br><span class="line">    <span class="type">JdbcTemplate</span> <span class="variable">template</span> <span class="operator">=</span> (JdbcTemplate) context.getBean(<span class="string">&quot;jdbcTemplate&quot;</span>);</span><br><span class="line">    <span class="comment">// 3. 执行sql语句 ( 使用fastjson转化为json格式 ) </span></span><br><span class="line">    <span class="type">List</span> <span class="variable">list</span> <span class="operator">=</span> template.queryForList(<span class="string">&quot;select * from mytable&quot;</span>);</span><br><span class="line">    out.print(<span class="string">&quot;测试:&quot;</span>+ JSONObject.toJSONString(list));</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>获取FlashMap的3种方法</title>
    <url>/posts/How_to_get_FlashMap_in_Spring_MVC.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>FlashMap</code> 是传递重定向参数的时候要用到的一个类。</p>
<span id="more"></span>

<h1 id="getAttributes-笨重-不推荐"><a href="#getAttributes-笨重-不推荐" class="headerlink" title="getAttributes(笨重, 不推荐)"></a>getAttributes(笨重, 不推荐)</h1><p>在源码 <code>DispatcherServlet</code> 的 <code>doService</code> 方法中注入了 <code>FlashMap</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.DispatcherServlet</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DispatcherServlet</span> <span class="keyword">extends</span> <span class="title class_">FrameworkServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doService</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FlashMap</span> <span class="variable">inputFlashMap</span> <span class="operator">=</span> <span class="built_in">this</span>.flashMapManager.retrieveAndUpdate(request, response);</span><br><span class="line">        <span class="keyword">if</span> (inputFlashMap != <span class="literal">null</span>) &#123;</span><br><span class="line">            request.setAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.INPUT_FLASH_MAP&quot;</span>, Collections.unmodifiableMap(inputFlashMap));</span><br><span class="line">        &#125;</span><br><span class="line">        request.setAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.OUTPUT_FLASH_MAP&quot;</span>, <span class="keyword">new</span> <span class="title class_">FlashMap</span>());</span><br><span class="line">        request.setAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.FLASH_MAP_MANAGER&quot;</span>, <span class="built_in">this</span>.flashMapManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以我们可以使用 <code>getAttributes</code> 获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/redirect&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">redirect</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">FlashMap</span> <span class="variable">redirectAttributes</span> <span class="operator">=</span> (FlashMap) ((ServletRequestAttributes) (RequestContextHolder.getRequestAttributes()))</span><br><span class="line">                .getRequest().getAttribute(<span class="string">&quot;org.springframework.web.servlet.DispatcherServlet.OUTPUT_FLASH_MAP&quot;</span>);</span><br><span class="line">        redirectAttributes.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/demo&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">demo</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="通过-RequestContextUtils-获取"><a href="#通过-RequestContextUtils-获取" class="headerlink" title="通过 RequestContextUtils 获取"></a>通过 RequestContextUtils 获取</h1><p><code>Spring</code>早已将上面的获取代码封装到 <code>RequestContextUtils</code> 中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/redirect&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">redirect</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">        <span class="type">FlashMap</span> <span class="variable">redirectAttributes</span> <span class="operator">=</span> RequestContextUtils.getOutputFlashMap(request);</span><br><span class="line">        redirectAttributes.put(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/demo&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">demo</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.web.servlet.support.RequestContextUtils</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RequestContextUtils</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> FlashMap <span class="title function_">getOutputFlashMap</span><span class="params">(HttpServletRequest request)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (FlashMap) request.getAttribute(DispatcherServlet.OUTPUT_FLASH_MAP_ATTRIBUTE);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Spring-MVC-在-Controller-注入形参"><a href="#Spring-MVC-在-Controller-注入形参" class="headerlink" title="Spring MVC 在 Controller 注入形参"></a>Spring MVC 在 Controller 注入形参</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/redirect&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">redirect</span><span class="params">(RedirectAttributes redirectAttributes)</span> &#123;</span><br><span class="line">        <span class="comment">// 和上面一样, 保存到 OUTPUT_FLASH_MAP 中</span></span><br><span class="line">        redirectAttributes.addFlashAttribute(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">        <span class="comment">// 不保存到 flashMap 中, 拼接到 url 中</span></span><br><span class="line">        redirectAttributes.addAttribute(<span class="string">&quot;key2&quot;</span>, <span class="string">&quot;value2&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;redirect:/demo&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/demo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">demo</span><span class="params">(Model model)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;view.jsp&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>记一次SpringMVC访问静态资源405错误修复</title>
    <url>/posts/why_Spring_MVC_ask_the_static_resource_return_405.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>访问静态资源出现405错误</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">警告 [http-nio-8080-exec-8] org.springframework.web.servlet.PageNotFound.handleHttpRequestMethodNotSupported Request method &#x27;GET&#x27; not supported</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">HTTP Status 405 - Request method &#x27;GET&#x27; not supported</span><br><span class="line">type Status report</span><br><span class="line">message Request method &#x27;GET&#x27; not supported</span><br><span class="line">description The specified HTTP method is not allowed for the requested resource.</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h1 id="stackoverflow解释"><a href="#stackoverflow解释" class="headerlink" title="stackoverflow解释"></a>stackoverflow解释</h1><p>开启<code>DefaultServletHandlerConfigurer</code><br>或者配置<code>ResourceHandler</code><br>二选一</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebConfig</span> <span class="keyword">extends</span> <span class="title class_">WebMvcConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configureDefaultServletHandling</span><span class="params">(DefaultServletHandlerConfigurer configurer)</span> &#123;</span><br><span class="line">        configurer.enable();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public void addResourceHandlers(ResourceHandlerRegistry registry) &#123;</span></span><br><span class="line"><span class="comment">//        registry.addResourceHandler(&quot;/static/**&quot;).addResourceLocations(&quot;/static/**&quot;);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/path&quot;, method = RequestMethod.GET)</span><br></pre></td></tr></table></figure>
<p>替换</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@RequestMapping(value = &quot;/path&quot;, method = RequestMethod.POST)</span><br></pre></td></tr></table></figure>


<p>问题是<br>第一步我明显配置好的了。<br>第二步我还不至于犯这么低级的错误(事实上就是这么低级的错误)</p>
<h1 id="修bug之路"><a href="#修bug之路" class="headerlink" title="修bug之路"></a>修bug之路</h1><ol>
<li>以为是IDEA的bug, 像Android Studio一样, 需要隔三差五的<code>ReBuild</code>一下。(405)</li>
<li>删除项目目录下的<code>out</code>和<code>target</code>文件夹, 重新编译运行。(405)</li>
<li>新建项目, 将<code>Initializer</code>、<code>WebConfig</code>复制到新项目, 编译运行。(成功)</li>
<li>将全部代码复制一遍到新目录。(405)</li>
<li>将所有<code>@Compontent</code>注释, 保留一个简单的HelloWorld的<code>@Controller</code>。(成功)</li>
<li>一个个<code>@Compontent</code>恢复，终于找到bug所在。</li>
</ol>
<h1 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h1><p>我在之前添加了个<code>PostMapping</code>, 加上了<code>TODO</code>后, 就忘记这件事了。<br>之后就开始出现访问静态资源<code>405</code>错误。页面能正常打开，就是样式丢失。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">    <span class="meta">@PostMapping()</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">addUser</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="comment">//TODO 增加用户</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原因就在这, <code>name</code>的默认值是<code>&quot;&quot;</code>，会拦截所有不经过其他<code>RequestMapping</code>的<code>url</code>。<br>静态资源也因此被拦截, 需要通过<code>Post</code>方式获取。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> PostMapping &#123;</span><br><span class="line">  <span class="meta">@AliasFor(annotation = RequestMapping.class)</span></span><br><span class="line">  String <span class="title function_">name</span><span class="params">()</span> <span class="keyword">default</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h1><p>将这段代码注释掉, 或者将<code>PostMapping</code>的<code>name</code>设置下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span>&#123;</span><br><span class="line">    <span class="comment">// 省略其他代码</span></span><br><span class="line"><span class="comment">//    @PostMapping(&quot;/admin/user&quot;)</span></span><br><span class="line"><span class="comment">//    public String addUser()&#123;</span></span><br><span class="line"><span class="comment">//        //TODO 增加用户</span></span><br><span class="line"><span class="comment">//        return &quot;&quot;;</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Java Web</category>
      </categories>
      <tags>
        <tag>Spring MVC</tag>
      </tags>
  </entry>
  <entry>
    <title>Shiro登录流程源码详解</title>
    <url>/posts/Shiro_login_process_source_code_explain.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本文假设读者能正常使用<code>Shiro</code>, 并对知道相关类是做什么用的.<br>这里截取部分代码来追踪, 为了尽可能的简单, 这里没有使用<code>Spring</code>等其他框架, 纯粹的<code>Shiro</code>代码.<br>本文使用<code>ini</code>配置, 但不解析<code>IniRealm</code>内部逻辑.</p>
<span id="more"></span>

<h1 id="单元测试例子"><a href="#单元测试例子" class="headerlink" title="单元测试例子"></a>单元测试例子</h1><p>具体可以看<a href="https://github.com/Ahaochan/project/blob/master/ahao-spring-boot-shiro/src/test/java/com/ahao/spring/boot/shiro/IniRealmTest.java"><code>IniRealmTest</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IniRealmTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 加载 ini 配置, 初始化 SecurityManager</span></span><br><span class="line">        Factory&lt;SecurityManager&gt; factory = <span class="keyword">new</span> <span class="title class_">IniSecurityManagerFactory</span>(<span class="string">&quot;classpath:shiro.ini&quot;</span>);</span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> factory.getInstance();</span><br><span class="line">        SecurityUtils.setSecurityManager(securityManager);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 获取 Subject</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> SecurityUtils.getSubject();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 3. 使用帐号密码登录, 并创建 Session</span></span><br><span class="line">        <span class="type">UsernamePasswordToken</span> <span class="variable">trueToken</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordToken</span>(<span class="string">&quot;username&quot;</span>, <span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            subject.login(trueToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AuthenticationException e) &#123;</span><br><span class="line">            Assertions.fail();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 角色判断</span></span><br><span class="line">        Assertions.assertTrue(subject.hasRole(<span class="string">&quot;role1&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 权限判断</span></span><br><span class="line">        Assertions.assertTrue(subject.isPermitted(<span class="string">&quot;permission1&quot;</span>));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 登出注销</span></span><br><span class="line">        subject.logout();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="section">[users]</span></span><br><span class="line"><span class="attr">username</span> = password,role1,role2</span><br><span class="line"></span><br><span class="line"><span class="section">[roles]</span></span><br><span class="line"><span class="attr">role1</span>=permission1,permission2</span><br><span class="line"><span class="attr">role2</span>=permission3,permission4</span><br></pre></td></tr></table></figure>
<p>登录逻辑就分为上述的六个步骤, 接下来一个个拆解.</p>
<h1 id="获取安全管理器-SecurityManager"><a href="#获取安全管理器-SecurityManager" class="headerlink" title="获取安全管理器 SecurityManager"></a>获取安全管理器 SecurityManager</h1><p>首先我们看<code>SecurityManager</code>的获取方法<code>factory.getInstance();</code>.<br><img data-src="https://yuml.me/diagram/nofunky;dir:LR/class/[IniSecurityManagerFactory]-%3E[IniFactorySupport],[IniFactorySupport]-%3E[AbstractFactory],[AbstractFactory]-%3E[%3C%3CFactory%3E%3E]" alt="IniSecurityManagerFactory继承树"></p>
<p>以下代码省略部分代码, 保留核心逻辑.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractFactory</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Factory</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> T singletonInstance;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 交由子类实现代码</span></span><br><span class="line">        singletonInstance = createInstance();</span><br><span class="line">        <span class="keyword">return</span> singletonInstance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title function_">createInstance</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">IniFactorySupport</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">AbstractFactory</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_INI_RESOURCE_PATH</span> <span class="operator">=</span> <span class="string">&quot;classpath:shiro.ini&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">createInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 从 classpath:shiro.ini 获取 ini 配置</span></span><br><span class="line">        <span class="type">Ini</span> <span class="variable">ini</span> <span class="operator">=</span> resolveIni();</span><br><span class="line">        <span class="comment">// 2. 根据 ini 配置初始化 SecurityManager</span></span><br><span class="line">        <span class="type">T</span> <span class="variable">instance</span> <span class="operator">=</span> createInstance(ini);</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title function_">createInstance</span><span class="params">(Ini ini)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">IniSecurityManagerFactory</span> <span class="keyword">extends</span> <span class="title class_">IniFactorySupport</span>&lt;SecurityManager&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MAIN_SECTION_NAME</span> <span class="operator">=</span> <span class="string">&quot;main&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">SECURITY_MANAGER_NAME</span> <span class="operator">=</span> <span class="string">&quot;securityManager&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">INI_REALM_NAME</span> <span class="operator">=</span> <span class="string">&quot;iniRealm&quot;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> SecurityManager <span class="title function_">createInstance</span><span class="params">(Ini ini)</span> &#123;</span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> createSecurityManager(ini);</span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> SecurityManager <span class="title function_">createSecurityManager</span><span class="params">(Ini ini)</span> &#123;</span><br><span class="line">        Ini.<span class="type">Section</span> <span class="variable">mainSection</span> <span class="operator">=</span> ini.getSection(MAIN_SECTION_NAME);</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isEmpty(mainSection)) &#123;</span><br><span class="line">            mainSection = ini.getSection(Ini.DEFAULT_SECTION_NAME);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> createSecurityManager(ini, mainSection);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> SecurityManager <span class="title function_">createSecurityManager</span><span class="params">(Ini ini, Ini.Section mainSection)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 创建默认的 DefaultSecurityManager 和 IniRealm, 保存到这个 Map 里</span></span><br><span class="line">        Map&lt;String, ?&gt; defaults = createDefaults(ini, mainSection);</span><br><span class="line">        <span class="comment">// 2. 初始化 ReflectionBuilder, 并往 Map 里塞了一个 DefaultEventBus</span></span><br><span class="line">        Map&lt;String, ?&gt; objects = buildInstances(mainSection, defaults);</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 3. 获取上面创建的 DefaultSecurityManager</span></span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">securityManager</span> <span class="operator">=</span> getSecurityManagerBean();</span><br><span class="line">    </span><br><span class="line">        <span class="comment">// 4. 获取上面的 IniRealm 注入到 DefaultSecurityManager 中</span></span><br><span class="line">        Collection&lt;Realm&gt; realms = getRealms(objects);</span><br><span class="line">        ((RealmSecurityManager) securityManager).setRealms(realms);</span><br><span class="line">    </span><br><span class="line">        <span class="keyword">return</span> securityManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, 创建<code>SecurityManager</code>的过程主要做了三件事</p>
<ol>
<li>创建默认的<code>DefaultSecurityManager</code></li>
<li>根据<code>shiro.ini</code>配置文件, 初始化<code>IniRealm</code></li>
<li>将<code>IniRealm</code>注入到<code>DefaultSecurityManager</code>中.</li>
</ol>
<h1 id="获取当前主体-Subject"><a href="#获取当前主体-Subject" class="headerlink" title="获取当前主体 Subject"></a>获取当前主体 Subject</h1><p>接下来获取<code>Subject</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SecurityUtils</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SecurityManager securityManager;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Subject <span class="title function_">getSubject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 从 ThreadLocal 获取 Subject, 第一次肯定获取不到, 需要去创建</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> ThreadContext.getSubject();</span><br><span class="line">        <span class="keyword">if</span> (subject == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 2. 初始化 Subject</span></span><br><span class="line">            subject = (<span class="keyword">new</span> <span class="title class_">Subject</span>.Builder()).buildSubject();</span><br><span class="line">            <span class="comment">// 3. 缓存到 ThreadLocal 中</span></span><br><span class="line">            ThreadContext.bind(subject);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> subject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Builder</span> &#123;</span><br><span class="line">         <span class="type">SubjectContext</span> <span class="variable">subjectContext</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSubjectContext</span>();</span><br><span class="line">         <span class="keyword">public</span> Subject <span class="title function_">buildSubject</span><span class="params">()</span> &#123;</span><br><span class="line">             <span class="keyword">return</span> SecurityUtils.securityManager.createSubject(<span class="built_in">this</span>.subjectContext);</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>第一次我们肯定获取不到<code>Subject</code>, 所以需要创建, 跟踪源码可以看到调用了安全管理器<code>SecurityManager</code>的<code>createSubject</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSecurityManager</span> <span class="keyword">extends</span> <span class="title class_">SessionsSecurityManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Subject <span class="title function_">createSubject</span><span class="params">(SubjectContext subjectContext)</span> &#123;</span><br><span class="line">        <span class="type">SubjectContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultSubjectContext</span>(subjectContext);</span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> subjectFactory.createSubject(context);</span><br><span class="line">        <span class="keyword">return</span> subject;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSubjectFactory</span> <span class="keyword">implements</span> <span class="title class_">SubjectFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Subject <span class="title function_">createSubject</span><span class="params">(SubjectContext context)</span> &#123;</span><br><span class="line"><span class="comment">//        return new DelegatingSubject(principals, authenticated, host, session, sessionCreationEnabled, securityManager);</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingSubject</span>(<span class="literal">null</span>, <span class="literal">false</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">true</span>, securityManager);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>找到最后, 是调用了一个<code>DefaultSubjectFactory</code>工厂, 来创建<code>DelegatingSubject</code>.<br>因为我们什么高大上的配置都没填, 所以就直接<code>null</code>和<code>false</code>来填充所需字段了.</p>
<h1 id="重头戏身份认证-login"><a href="#重头戏身份认证-login" class="headerlink" title="重头戏身份认证 login"></a>重头戏身份认证 login</h1><p>全部准备就绪了, 就开始登录吧<code>subject.login(trueToken)</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingSubject</span> <span class="keyword">implements</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">login</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">// 调用 SecurityManager</span></span><br><span class="line">        <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> securityManager.login(<span class="built_in">this</span>, token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSecurityManager</span> <span class="keyword">extends</span> <span class="title class_">SessionsSecurityManager</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Authenticator</span> <span class="variable">authenticator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ModularRealmAuthenticator</span>();</span><br><span class="line">    <span class="keyword">public</span> Subject <span class="title function_">login</span><span class="params">(Subject subject, AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="type">AuthenticationInfo</span> <span class="variable">info</span> <span class="operator">=</span> authenticate(token);</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        <span class="keyword">return</span> loggedIn;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> AuthenticationInfo <span class="title function_">authenticate</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">// 调用 ModularRealmAuthenticator 认证器</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authenticator.authenticate(token);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>login()</code>方法实际上是调用了<code>ModularRealmAuthenticator</code>类的<code>authenticate()</code>方法.<br><code>ModularRealmAuthenticator</code>认证器默认内置了<code>AtLeastOneSuccessfulStrategy</code>的认证策略.<br>看名字可以猜到, 只要有一个<code>Realm</code>验证通过, 那就验证通过了. 我们目前只有一个<code>IniRealm</code>, 所以不用管这个认证策略.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractAuthenticator</span> <span class="keyword">implements</span> <span class="title class_">Authenticator</span>, LogoutAware &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> AuthenticationInfo <span class="title function_">authenticate</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">// 交由 ModularRealmAuthenticator 实现</span></span><br><span class="line">        <span class="type">AuthenticationInfo</span> <span class="variable">info</span> <span class="operator">=</span> doAuthenticate(token);</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ModularRealmAuthenticator</span> <span class="keyword">extends</span> <span class="title class_">AbstractAuthenticator</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doAuthenticate</span><span class="params">(AuthenticationToken authenticationToken)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        Collection&lt;Realm&gt; realms = getRealms();</span><br><span class="line">        <span class="keyword">if</span> (realms.size() == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// 我们目前只有一个 IniRealm </span></span><br><span class="line">            <span class="keyword">return</span> doSingleRealmAuthentication(realms.iterator().next(), authenticationToken);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> doMultiRealmAuthentication(realms, authenticationToken);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> AuthenticationInfo <span class="title function_">doSingleRealmAuthentication</span><span class="params">(Realm realm, AuthenticationToken token)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!realm.supports(token)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedTokenException</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// !!!! 注意这里 !!!!</span></span><br><span class="line">        <span class="type">AuthenticationInfo</span> <span class="variable">info</span> <span class="operator">=</span> realm.getAuthenticationInfo(token);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownAccountException</span>(msg);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到我们调用了<code>Realm</code>的<code>getAuthenticationInfo()</code>方法, 但是这个方法和我们平常开发时重写的<code>doGetAuthenticationInfo()</code>方法不同.<br><code>getAuthenticationInfo()</code>内部肯定是调用了<code>doGetAuthenticationInfo()</code>方法. 我们继续往里面.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthenticatingRealm</span> <span class="keyword">extends</span> <span class="title class_">CachingRealm</span> <span class="keyword">implements</span> <span class="title class_">Initializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> AuthenticationInfo <span class="title function_">getAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">// 1. 获取缓存中的 Authentication, 第一次肯定获取不到</span></span><br><span class="line">        <span class="type">AuthenticationInfo</span> <span class="variable">info</span> <span class="operator">=</span> getCachedAuthenticationInfo(token);</span><br><span class="line">        <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 2. 自定义 Realm 的实现</span></span><br><span class="line">            info = doGetAuthenticationInfo(token);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 用户输入的密码和数据库中的密码进行比较, 可以在这里做加盐加密</span></span><br><span class="line">        <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">            assertCredentialsMatch(token, info);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> AuthenticationInfo <span class="title function_">doGetAuthenticationInfo</span><span class="params">(AuthenticationToken token)</span> <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">assertCredentialsMatch</span><span class="params">(AuthenticationToken token, AuthenticationInfo info)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">// 默认实现类 SimpleCredentialsMatcher</span></span><br><span class="line">        <span class="type">CredentialsMatcher</span> <span class="variable">cm</span> <span class="operator">=</span> getCredentialsMatcher();</span><br><span class="line">        <span class="keyword">if</span> (!cm.doCredentialsMatch(token, info)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncorrectCredentialsException</span>(<span class="string">&quot;错误&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>doGetAuthenticationInfo()</code>就是我们自定义<code>Realm</code>要实现的方法.<br>至此, 整个身份验证流程就走通了.<br><img data-src="https://yuml.me/diagram/nofunky;dir:LR/class/[DelegatingSubject.login]-%3E[DefaultSecurityManager.login],[DefaultSecurityManager.login]-%3E[ModularRealmAuthenticator.authenticate],[ModularRealmAuthenticator.doAuthenticate]-%3E[AuthenticatingRealm.doGetAuthenticationInfo]" alt="Subject.Login()调用链"></p>
<h1 id="权限认证"><a href="#权限认证" class="headerlink" title="权限认证"></a>权限认证</h1><p>我们重写<code>Realm</code>除了<code>doGetAuthenticationInfo()</code>还要重写<code>doGetAuthorizationInfo()</code>.<br>但是我们上面身份认证只执行了<code>doGetAuthenticationInfo()</code>. 可以很容易猜到, <code>Shiro</code>使用了懒加载的方式去加载角色权限.<br>还是老办法看源码, 看<code>subject.hasRole()</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingSubject</span> <span class="keyword">implements</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasRole</span><span class="params">(String roleIdentifier)</span> &#123;</span><br><span class="line">        <span class="comment">// 又是调用 SecurityManager</span></span><br><span class="line">        <span class="keyword">return</span> hasPrincipals() &amp;&amp; securityManager.hasRole(getPrincipals(), roleIdentifier);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthorizingSecurityManager</span> <span class="keyword">extends</span> <span class="title class_">AuthenticatingSecurityManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasRole</span><span class="params">(PrincipalCollection principals, String roleIdentifier)</span> &#123;</span><br><span class="line">        <span class="comment">// 又是调用 ModularRealmAuthenticator, 然后调用 AuthorizingRealm</span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.authorizer.hasRole(principals, roleIdentifier);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthorizingRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthenticatingRealm</span> <span class="keyword">implements</span> <span class="title class_">Authorizer</span>, Initializable, PermissionResolverAware, RolePermissionResolverAware &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasRole</span><span class="params">(PrincipalCollection principal, String roleIdentifier)</span> &#123;</span><br><span class="line">        <span class="comment">// !!!! 注意这里 !!!!</span></span><br><span class="line">        <span class="type">AuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> getAuthorizationInfo(principal);</span><br><span class="line">        <span class="keyword">return</span> hasRole(roleIdentifier, info);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">hasRole</span><span class="params">(String roleIdentifier, AuthorizationInfo info)</span> &#123;</span><br><span class="line">        <span class="comment">// 获取权限完毕后, 就判断有没有所需权限</span></span><br><span class="line">        <span class="keyword">return</span> info != <span class="literal">null</span> &amp;&amp; info.getRoles() != <span class="literal">null</span> &amp;&amp; info.getRoles().contains(roleIdentifier);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>鉴权就比较简单了, 我们直接一撸到底, 方法调来调去, 最后就是调用到<code>Realm</code>的<code>getAuthorizationInfo()</code>方法.<br>和之前一样, 内部肯定也是调用了<code>doGetAuthorizationInfo()</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AuthorizingRealm</span> <span class="keyword">extends</span> <span class="title class_">AuthenticatingRealm</span> <span class="keyword">implements</span> <span class="title class_">Authorizer</span>, Initializable, PermissionResolverAware, RolePermissionResolverAware &#123;</span><br><span class="line">    <span class="keyword">protected</span> AuthorizationInfo <span class="title function_">getAuthorizationInfo</span><span class="params">(PrincipalCollection principals)</span> &#123;</span><br><span class="line">        <span class="type">AuthorizationInfo</span> <span class="variable">info</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 从缓存中获取, 第一次肯定没有</span></span><br><span class="line">        Cache&lt;Object, AuthorizationInfo&gt; cache = getAvailableAuthorizationCache();</span><br><span class="line">        info = cache.get(key);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 调用 自定义 Realm 的 doGetAuthorizationInfo(), 然后缓存</span></span><br><span class="line">        <span class="keyword">if</span> (info == <span class="literal">null</span>) &#123;</span><br><span class="line">            info = doGetAuthorizationInfo(principals);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="注销-logout"><a href="#注销-logout" class="headerlink" title="注销 logout"></a>注销 logout</h1><p>注销也很简单, 就是把之前初始化的数据都清空就好了. 调用<code>Subject.logout()</code>注销.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingSubject</span> <span class="keyword">implements</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clearRunAsIdentitiesInternal();</span><br><span class="line">            <span class="built_in">this</span>.securityManager.logout(<span class="built_in">this</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.session = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">this</span>.principals = <span class="literal">null</span>;</span><br><span class="line">            <span class="built_in">this</span>.authenticated = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">//https://issues.apache.org/jira/browse/JSEC-22</span></span><br><span class="line">            <span class="comment">//this.securityManager = null;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DefaultSecurityManager</span> <span class="keyword">extends</span> <span class="title class_">SessionsSecurityManager</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logout</span><span class="params">(Subject subject)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 删除 remember me</span></span><br><span class="line">        beforeLogout(subject);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 清除缓存</span></span><br><span class="line">        <span class="type">PrincipalCollection</span> <span class="variable">principals</span> <span class="operator">=</span> subject.getPrincipals();</span><br><span class="line">        <span class="keyword">if</span> (principals != <span class="literal">null</span> &amp;&amp; !principals.isEmpty()) &#123;</span><br><span class="line">            <span class="type">Authenticator</span> <span class="variable">authc</span> <span class="operator">=</span> getAuthenticator();</span><br><span class="line">            <span class="keyword">if</span> (authc <span class="keyword">instanceof</span> LogoutAware) &#123;</span><br><span class="line">                ((LogoutAware) authc).onLogout(principals);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3. 从持久层删除 subject</span></span><br><span class="line">        delete(subject);</span><br><span class="line">        <span class="comment">// 4. 停止 session</span></span><br><span class="line">        stopSession(subject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>还有一些高级特性, 比如多<code>Realm</code>登陆, 单点登录, <code>Redis</code>持久化<code>Session</code>. 这里就不说了.<br><code>Shrio</code>源码比起<code>Spring</code>的简单多了, 用久了其实都知道的七七八八, 阅读源码也就是个查缺补漏.</p>
]]></content>
      <categories>
        <category>Shiro</category>
      </categories>
      <tags>
        <tag>Shiro</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Bench使用</title>
    <url>/posts/How_to_use_Apache_Bench.html</url>
    <content><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p><code>Apache Bench</code>简称<code>ab</code>工具, 是一款简单方便的测试工具.<br>安装方式</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">yum -y install httpd-tools</span><br><span class="line">apt -y install apache2-utils</span><br></pre></td></tr></table></figure>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>使用方式: <code>ab [options] [http[s]://]hostname[:port]/path</code><br>常用选项</p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>-n</code></td>
<td align="center">总请求次数, 最小默认为<code>1</code></td>
</tr>
<tr>
<td align="center"><code>-c</code></td>
<td align="center">并发次数, 最小默认为<code>1</code>, 且不能大于总请求次数. 例如, <code>10</code>个请求, <code>10</code>个并发，实际就是<code>1</code>人请求<code>1</code>次</td>
</tr>
<tr>
<td align="center"><code>-p</code></td>
<td align="center"><code>post</code> 参数文档路径（-p 和 -T 参数要配合使用）</td>
</tr>
<tr>
<td align="center"><code>-T</code></td>
<td align="center"><code>header</code>头内容类型</td>
</tr>
</tbody></table>
<h1 id="分析结果"><a href="#分析结果" class="headerlink" title="分析结果"></a>分析结果</h1><p>我们简单的对百度做个压测, <code>20</code>个用户同时发起请求, 总共请求<code>1000</code>次.</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">ab -n 1000 -c 20 &quot;https://www.baidu.com/s?wd=test&quot;</span><br></pre></td></tr></table></figure>
<p>结果马上就出来了, 我们主要看以下几个参数</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">完成所有请求花费的时间</span></span><br><span class="line">Time taken for tests:   5.058 seconds</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">吞吐率，指某个并发用户数下单位时间内处理的请求数</span></span><br><span class="line">Requests per second:    197.72 [#/sec] (mean)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用户平均请求等待时间 = 完成所有请求花费的时间 / (总请求数 / 并发用户数)</span></span><br><span class="line">Time per request:       101.155 [ms] (mean)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务器平均请求处理时间 = 完成所有请求花费的时间 / 总请求数</span></span><br><span class="line">Time per request:       5.058 [ms] (mean, across all concurrent requests)</span><br></pre></td></tr></table></figure>

<h1 id="常用例子"><a href="#常用例子" class="headerlink" title="常用例子"></a>常用例子</h1><figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. get请求, 20个用户同时发起请求, 总共请求1000次</span></span><br><span class="line">ab -n 1000 -c 20 -H &quot;header1:value1&quot; -H &quot;header1:value1&quot; &quot;https://www.baidu.com/s?wd=test&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. post请求, 将 post.txt 的内容作为请求参数发送出去</span></span><br><span class="line">ab -n 1000 -c 10 -p post.txt -T &quot;application/x-www-form-urlencoded&quot; &quot;https://www.baidu.com/s?wd=test&quot;</span><br><span class="line">ab -n 1000 -c 10 -p post.txt -T &quot;application/json&quot; &quot;https://www.baidu.com/s?wd=test&quot;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>测试</category>
      </categories>
      <tags>
        <tag>Apache Bench</tag>
      </tags>
  </entry>
  <entry>
    <title>HttpOnly详解</title>
    <url>/posts/What_is_HttpOnly.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Http</code>连接是无状态的, 也就是说, 即使你发送第一次<code>Http</code>请求, 传了个<code>param</code>参数给<code>Web</code>服务器。第二次<code>Http</code>请求想获取<code>param</code>参数, 是获取不到的, 因为<code>Web</code>服务器是不认识你的。<br>为了完成这个需求, 我们可以使用<code>Cookie</code>和<code>Session</code>进行存储数据, 在<code>Cookie</code>中存入本次会话的<code>SessionID</code>, 那<code>Web</code>服务器从<code>Cookie</code>中获取<code>SessionID</code>就可以知道你是哪个用户, 知道你之前存了什么数据。</p>
<span id="more"></span>

<h1 id="危险"><a href="#危险" class="headerlink" title="危险"></a>危险</h1><p>我们知道<code>Cookie</code>是明文存储的, 甚至就算是小白用户, 也可以通过浏览器直接查看。那么如果小明知道了小红的<code>Cookie</code>里的用户凭证, 然后将自己的<code>Cookie</code>的用户凭证改为小红的用户凭证, 那不就可以看到小红的信息了? </p>
<h1 id="HttpOnly"><a href="#HttpOnly" class="headerlink" title="HttpOnly"></a>HttpOnly</h1><p>比如我自己搭建一个服务器<code>http://localhost:8080</code>, 然后在要窃取<code>Cookie</code>页面按下<code>F12</code>打开<code>Console</code>控制台执行下面代码(<code>XSS</code>攻击)</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;http://localhost:8080?c=&#x27;</span>+<span class="variable language_">document</span>.<span class="property">cookie</span>);</span><br></pre></td></tr></table></figure>

<p>就可以将<code>Cookie</code>发送到我们自己的服务器。</p>
<p>那么, 只要不让<code>document</code>获取到敏感<code>Cookie</code>就好了。<br>为<code>Cookie</code>设置<code>HttpOnly</code>, 禁止<code>js</code>获取。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">test</span><span class="params">(HttpServletResponse response)</span>&#123;</span><br><span class="line">    <span class="type">Cookie</span> <span class="variable">cookie</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cookie</span>(<span class="string">&quot;key1&quot;</span>, <span class="string">&quot;value1&quot;</span>);</span><br><span class="line">    cookie.setHttpOnly(<span class="literal">true</span>); <span class="comment">// 设置HttpOnly</span></span><br><span class="line">    response.addCookie(cookie);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;test.jsp&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://segmentfault.com/q/1010000007347730">关于cookie的安全性问题</a></li>
</ul>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>Cookie</tag>
      </tags>
  </entry>
  <entry>
    <title>代理模式</title>
    <url>/posts/Proxy_Pattern.html</url>
    <content><![CDATA[<h1 id="什么是代理模式"><a href="#什么是代理模式" class="headerlink" title="什么是代理模式"></a>什么是代理模式</h1><p>代理模式分为</p>
<ul>
<li>远程代理：为不同地理的对象提供局域网代表对象</li>
<li>虚拟代理：将资源消耗大的对象进行延迟，需要的时候才创建</li>
<li>保护代理：控制对一个对象的访问权限</li>
<li>智能引用代理：提供对目标对象额外服务</li>
</ul>
<span id="more"></span>

<h1 id="JDK静态代理"><a href="#JDK静态代理" class="headerlink" title="JDK静态代理"></a>JDK静态代理</h1><p>感觉就是装饰模式+模版方法模式，代理类(<code>Driver</code>)和被代理类(<code>Boss</code>)实现相同的接口(<code>Drivable</code>)，并把被代理类(<code>Boss</code>)注入到代理类(<code>Driver</code>)中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Drivable</span>&#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> <span class="keyword">implements</span> <span class="title class_">Drivable</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;老板想开车&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Driver</span> <span class="keyword">implements</span> <span class="title class_">Drivable</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Drivable boss;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Driver</span><span class="params">(Drivable boss)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.boss = boss;<span class="comment">//注入被代理类</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;司机来开车&quot;</span>);</span><br><span class="line">        boss.drive();</span><br><span class="line">        System.out.println(<span class="string">&quot;司机已停车&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Boss</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Boss</span>();</span><br><span class="line">        <span class="type">Driver</span> <span class="variable">driver</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Driver</span>(boss);</span><br><span class="line">        driver.drive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="JDK动态代理"><a href="#JDK动态代理" class="headerlink" title="JDK动态代理"></a>JDK动态代理</h1><p>通过一个实现了<code>InvocationHandler</code>接口的类进行代理。在<code>invoke</code>方法中实现业务逻辑处理</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DriverHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">DriverHandler</span><span class="params">(Object target)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.target = target;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;司机来开车&quot;</span>);</span><br><span class="line">        method.invoke(target,args);</span><br><span class="line">        System.out.println(<span class="string">&quot;司机已停车&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Boss</span> <span class="variable">boss</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Boss</span>();</span><br><span class="line">        <span class="type">DriverHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DriverHandler</span>(boss);</span><br><span class="line">        <span class="type">Drivable</span> <span class="variable">drivable</span> <span class="operator">=</span> (Drivable) Proxy.newProxyInstance(</span><br><span class="line">               boss.getClass().getClassLoader(), boss.getClass().getInterfaces(), handler);</span><br><span class="line">        drivable.drive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="CGLIB动态代理"><a href="#CGLIB动态代理" class="headerlink" title="CGLIB动态代理"></a>CGLIB动态代理</h1><p><code>CGLIB</code>是通过继承实现的动态代理<br>先导入<code>maven</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/cglib/cglib-nodep --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>cglib<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>cglib-nodep<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.5<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>编写代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Boss</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">drive</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;老板想开车&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CglibProxy</span> <span class="keyword">implements</span> <span class="title class_">MethodInterceptor</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Enhancer</span> <span class="variable">enhancer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Enhancer</span>();</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getProxy</span><span class="params">(Class clazz)</span>&#123;</span><br><span class="line">        enhancer.setSuperclass(clazz);</span><br><span class="line">        enhancer.setCallback(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">return</span> enhancer.create();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">intercept</span><span class="params">(Object obj, Method method, Object[] args, MethodProxy proxy)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;司机来开车&quot;</span>);</span><br><span class="line">        proxy.invokeSuper(obj, args);</span><br><span class="line">        System.out.println(<span class="string">&quot;司机已停车&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">CglibProxy</span> <span class="variable">proxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CglibProxy</span>();</span><br><span class="line">        <span class="type">Boss</span> <span class="variable">boss</span> <span class="operator">=</span> (Boss) proxy.getProxy(Boss.class);</span><br><span class="line">        boss.drive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>单例模式</title>
    <url>/posts/Singleton_Pattern.html</url>
    <content><![CDATA[<h1 id="什么是单例模式？"><a href="#什么是单例模式？" class="headerlink" title="什么是单例模式？"></a>什么是单例模式？</h1><p>单例模式算是设计模式入门的最简单的一个模式, 由于 <code>Java</code> 语言的特性(指令重排序), 导致同时也是最难的一个模式。</p>
<p>所幸, 先驱者<code>Joshua Bloch</code>在<code>Google I/O 2008</code>上的新书<code>Effective Java</code>介绍了单例模式的最佳实践。这本神书我还没来的及看, 但在国外好像备受推崇, 所以有机会还是看看。</p>
<span id="more"></span>

<p>一个<code>android</code>应用程序的一个单例模式的类只能有且只有一个实例对象。<br>通俗的讲，就是构造方法私有化，并在类内创建唯一一个私有的类实例,提供一个用于获取唯一实例的公有方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> A instance;  <span class="comment">//创建唯一一个私有实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;              <span class="comment">//私有化构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> <span class="title class_">A</span>(); <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">return</span> instance;    <span class="comment">//返回唯一实例</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>单例模式分为以下两种类型</strong></p>
<ol>
<li>饿汉模式：类<strong>加载</strong>的时候便进行创建（加载类时较慢，运行时获取对象较快，线程安全）</li>
<li>懒汉模式：要<strong>使用</strong>的时候才进行创建（加载类时较快，运行时获取对象较慢，线程不安全）</li>
</ol>
<h1 id="饿汉模式"><a href="#饿汉模式" class="headerlink" title="饿汉模式"></a>饿汉模式</h1><h2 id="在Java-5-之前的最佳实践"><a href="#在Java-5-之前的最佳实践" class="headerlink" title="在Java 5 之前的最佳实践"></a>在Java 5 之前的最佳实践</h2><p>直接在声明的时候初始化, 当类加载时, <code>instance = new A()</code>就会执行.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">A</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>(); <span class="comment">//注意这里初始化的时机</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;                       <span class="comment">//私有化构造函数</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> instance;                 <span class="comment">//返回唯一实例</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Java-5-之后的最佳实践"><a href="#Java-5-之后的最佳实践" class="headerlink" title="Java 5 之后的最佳实践"></a>Java 5 之后的最佳实践</h2><p><code>enum</code> 作为枚举关键字, 很难想像到它和 <code>单例模式</code> 联系到一起。<br>但是换种思路, 枚举类只有一个元素, 不就是单例模式了吗?<br>枚举类还可以添加自定义的方法。完全可以当成一个类来使用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123; <span class="keyword">return</span> INSTANCE; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="懒汉模式"><a href="#懒汉模式" class="headerlink" title="懒汉模式"></a>懒汉模式</h1><blockquote>
<p>要使用的时候才进行创建</p>
</blockquote>
<h2 id="静态内部类-在Java-5-之前的最佳实践"><a href="#静态内部类-在Java-5-之前的最佳实践" class="headerlink" title="静态内部类 (在Java 5 之前的最佳实践)"></a>静态内部类 (在Java 5 之前的最佳实践)</h2><p>因为<code>Holder</code>是静态内部类, 只有<code>getInstance()</code>方法访问到<code>Holder</code>, 才会初始化静态内部类的<code>static</code>的变量.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Holder</span> &#123;  </span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">A</span> <span class="variable">instance</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">A</span>();  </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span> <span class="params">()</span>&#123;&#125;  </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;  </span><br><span class="line">        <span class="keyword">return</span> Holder.instance; </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="双重锁-volatile-在Java-5-之后的最佳实践"><a href="#双重锁-volatile-在Java-5-之后的最佳实践" class="headerlink" title="双重锁+volatile (在Java 5 之后的最佳实践)"></a>双重锁+volatile (在Java 5 之后的最佳实践)</h2><h3 id="双重锁的优化"><a href="#双重锁的优化" class="headerlink" title="双重锁的优化"></a>双重锁的优化</h3><p>上面提到，懒汉式是线程不安全的，对于多线程比较陌生的可能不太理解，先看代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;<span class="comment">// 一</span></span><br><span class="line">            instance = <span class="keyword">new</span> <span class="title class_">A</span>();<span class="comment">// 二</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;<span class="comment">// 三</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当我们获取调用<code>getInstance()</code>方法获取<code>A</code>的实例对象时，如果有多个线程调用<code>getInstance()方法</code>，就会出现线程不安全，怎么解释呢？</p>
<p>假设有两个线程同时调用了<code>getInstance()</code>方法.</p>
<ol>
<li>当线程1执行到<code>if(instance == null)</code>时, 判断为<code>true</code>, 进入<code>if</code>内, 此时线程1时间片结束, <code>CPU</code>切换到线程2.</li>
<li>此时线程2执行到<code>if(instance == null)</code>, 因为线程1还未来得及执行<code>instance = A()</code>, 所以<code>if</code>判断为<code>true</code>, 进入方法体, 此时线程2时间片结束, <code>CPU</code>切换到线程1.</li>
<li>此时线程1执行<code>instance = A()</code>, <code>instance</code>的<code>hashcode</code>为<code>850</code>, 然后<code>return</code>, 执行结束, 切换回线程2.</li>
<li>此时线程2在<code>if</code>内, 执行<code>instance = A()</code>, <code>instance</code>的<code>hashcode</code>为<code>851</code>, 然后<code>return</code>.</li>
</ol>
<p>看到了吗? 这样就创建了两个<code>A</code>的实例. 说好的单例模式呢?</p>
<p>那么改一下, 加上<code>synchronized</code>同步一下.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;          <span class="comment">// 一</span></span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;    <span class="comment">// 二</span></span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;  <span class="comment">// 三</span></span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>(); <span class="comment">// 四</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance; <span class="comment">// 五</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设有两个线程同时调用了<code>getInstance()</code>方法.</p>
<ol>
<li>当线程1执行到<code>if(instance == null)</code>时, 判断为<code>true</code>, 进入<code>if</code>内, 此时线程1时间片结束, <code>CPU</code>切换到线程2.</li>
<li>此时线程2执行到<code>if(instance == null)</code>, 因为线程1还未来得及执行<code>instance = A()</code>, 所以<code>if</code>判断为<code>true</code>, 进入方法体, 此时线程2时间片结束, <code>CPU</code>切换到线程1.</li>
<li>线程1拿到<code>A.class</code>锁, 进入<code>synchronized</code>, 此时就算切换回线程2, 线程2也会因为拿不到<code>A.class</code>锁对象, 阻塞在同步代码块外面.</li>
<li>线程1继续执行<code>if</code>, 执行<code>instance = A()</code>, <code>instance</code>的<code>hashcode</code>为<code>850</code>, 然后<code>return</code>, 执行结束, 切换回线程2.</li>
<li>此时线程2拿到<code>A.class</code>锁, 进入<code>synchronized</code>, <code>if</code>判断为<code>false</code>, 直接<code>return</code>.</li>
</ol>
<blockquote>
<p>为什么不把第一个<code>if</code>去掉, 直接留个<code>synchronized + if</code>呢?<br>因为<code>synchronized</code>耗时长, 消耗性能, 双重锁只要保证第一次并发不产生多个对象即可.</p>
</blockquote>
<p>你以为这样就线程安全了吗! <code>Java</code>还有个<strong>指令重排序</strong>的大招等着你呢.</p>
<h3 id="volatile-优化"><a href="#volatile-优化" class="headerlink" title="volatile 优化"></a>volatile 优化</h3><p><code>volatile</code>关键字用来解决指令重排序在多线程下的问题, 它有两个功能.</p>
<ol>
<li>保证内存可见性</li>
<li>防止指令重排序</li>
</ol>
<p>我们先看内存可见性(其实这已经被<code>synchronized</code>解决了)<br><code>Java</code>内存模型规定, 变量存储在主存中, 每个线程拥有该变量的一个拷贝副本在自己的工作内存中, 线程修改变量是修改自己工作内存中的变量, 而修改完毕后, 会将自己工作内存中的修改后的值回写到主存中.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;          <span class="comment">// 一</span></span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;    <span class="comment">// 二</span></span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;  <span class="comment">// 三</span></span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>(); <span class="comment">// 四</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance; <span class="comment">// 五</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>假设有两个线程同时调用了<code>getInstance()</code>方法.</p>
<ol>
<li>当线程1执行到<code>if(instance == null)</code>时, 判断为<code>true</code>, 进入<code>if</code>内, 拿到<code>A.class</code>锁, 进入<code>synchronized</code>, 继续执行<code>if</code>, 执行<code>instance = A()</code>, <code>instance</code>的<code>hashcode</code>为<code>850</code>, <strong>此时<code>instance</code>没有回写到主存</strong>, 切换回线程2.</li>
<li>线程2执行到第一个<code>if</code>, 因为线程1的值没有回写到主存, 所以还是会进入<code>if</code>内, 但是被<code>synchronized</code>阻塞了.</li>
<li>线程1将变量回写到主存, 并<code>return</code>.</li>
<li>此时线程2拿到<code>A.class</code>锁, 进入<code>synchronized</code>, <code>if</code>判断为<code>false</code>, 直接<code>return</code>.<br>所以就算没有使用<code>volatile</code>保证内存可见性, 也不会导致出错.<br>其实<code>synchronized</code>就有保证内存可见性的功能.<blockquote>
<p>在 <a href="https://docs.oracle.com/javase/7/docs/api/java/util/concurrent/locks/Lock.html">java.util.concurrent.locks.Lock</a> 接口的Javadoc中有这样一段话：<br>All Lock implementations must enforce the <strong>same memory synchronization semantics as provided by the built-in monitor lock</strong></p>
</blockquote>
</li>
</ol>
<p>再来看指令重排序<br><code>instance = A();</code> 这条命令并不是原子性的, 它包含3个操作.</p>
<ol>
<li>在堆内存申请<code>A</code>实例的内存空间.</li>
<li>初始化<code>A</code>实例.</li>
<li>将<code>instance</code>变量指向内存中的<code>A</code>实例的内存空间(执行完这步 <code>instance</code> 就为非 <code>null</code> 了)<br>由于<code>JVM</code>的指令重排序, 步骤<code>123</code>可能会变成<code>132</code>, 多线程下会导致出错.</li>
</ol>
<p>假设有两个线程同时调用了<code>getInstance()</code>方法. 指令顺序为<code>132</code>.</p>
<ol>
<li>当线程1执行到<code>if(instance == null)</code>时, 判断为<code>true</code>, 进入<code>if</code>内, 拿到<code>A.class</code>锁, 进入<code>synchronized</code>, 继续执行<code>if</code>, 执行<code>instance = A()</code>.</li>
<li>先在堆内存申请<code>A</code>实例的内存空间, 由于指令重排序, 将<code>instance</code>变量指向没有初始化的, 但是已经申请了的内存空间. 此时线程1时间片结束, CPU切换到线程2.</li>
<li>线程2执行到第一个<code>if</code>, 因为<code>instance</code>已经指向没有初始化的内存空间, 所以直接<code>return</code>. 这时调用这个单例, 因为还未初始化, 所以会导致错误出现.</li>
</ol>
<p>而<code>volatile</code>可以防止指令重排序, 让指令严格按照<code>123</code>的顺序执行.<br><strong>但是, 在<code>Java 5</code>之前, 因为<code>Java</code>内存模型的缺陷, <code>volatile</code>不能解决指令重排序的问题.</strong><br>所以最佳实践就是</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="破坏单例模式的攻击"><a href="#破坏单例模式的攻击" class="headerlink" title="破坏单例模式的攻击"></a>破坏单例模式的攻击</h1><h2 id="克隆-clone-攻击"><a href="#克隆-clone-攻击" class="headerlink" title="克隆 clone 攻击"></a>克隆 clone 攻击</h2><p>要用<code>clone</code>攻击单例模式只需要两步.</p>
<ol>
<li><code>A</code>类实现<code>Cloneable</code>接口, 虽然里面啥也没有, 主要时为了解决<code>CloneNotSupportedException</code>.</li>
<li>重写<code>Object</code>中的<code>protected native Object clone()</code>方法, 不然外部访问不了.<br>然后运行<code>main</code>方法, <code>a1==a2</code>得到<code>false</code>.<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> (A) <span class="built_in">super</span>.clone();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a1</span> <span class="operator">=</span> A.getInstance();</span><br><span class="line">        <span class="type">A</span> <span class="variable">a2</span> <span class="operator">=</span> (A) a1.clone();</span><br><span class="line">        System.out.println(a1 == a2); <span class="comment">// false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
要解决<code>clone</code>攻击也很简单, 既然是<code>clone</code>方法的问题, 那我们就直接在<code>clone</code>方法改动即可.<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="反射攻击"><a href="#反射攻击" class="headerlink" title="反射攻击"></a>反射攻击</h2><p>用<code>constructor.setAccessible(true);</code>破解私有构造函数.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">A</span> <span class="variable">a1</span> <span class="operator">=</span> A.getInstance();</span><br><span class="line">        <span class="type">A</span> <span class="variable">a2</span> <span class="operator">=</span> create(A.class);</span><br><span class="line">        System.out.println(a1 == a2); <span class="comment">// false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; T <span class="title function_">create</span><span class="params">(Class&lt;T&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Constructor&lt;T&gt; constructor = clazz.getDeclaredConstructor();</span><br><span class="line">            constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            <span class="keyword">return</span> constructor.newInstance();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InstantiationException | InvocationTargetException | NoSuchMethodException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那我们只能在构造函数体做文章了.<br>判断如果被初始化过了, 再次初始化则抛出异常即可.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> A instance;  <span class="comment">//创建唯一一个私有实例</span></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;               <span class="comment">//私有化构造函数</span></span><br><span class="line">        <span class="keyword">if</span>(instance != <span class="literal">null</span>) &#123;  <span class="comment">//避免反射创建</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;单例模式不允许再创建&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        instance = <span class="keyword">new</span> <span class="title class_">A</span>(); <span class="comment">//初始化</span></span><br><span class="line">        <span class="keyword">return</span> instance;    <span class="comment">//返回唯一实例</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="序列化攻击"><a href="#序列化攻击" class="headerlink" title="序列化攻击"></a>序列化攻击</h2><p>只要对<code>A</code>类实现<code>Serializable</code>接口, 即可进行对象序列化.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(<span class="string">&quot;serializable.txt&quot;</span>);</span><br><span class="line">        <span class="type">A</span> <span class="variable">a1</span> <span class="operator">=</span> A.getInstance();</span><br><span class="line">        <span class="comment">// 1. 序列化</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(file);</span><br><span class="line">             <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);) &#123;</span><br><span class="line">            oos.writeObject(a1);</span><br><span class="line">            oos.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 2. 反序列化</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">             <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);) &#123;</span><br><span class="line">            <span class="type">A</span> <span class="variable">a2</span> <span class="operator">=</span> (A) ois.readObject();</span><br><span class="line">            System.out.println(a1 == a2); <span class="comment">// false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要化解序列化攻击, 很简单, 我们先看<code>ois.readObject()</code>这个方法.<br><img data-src="https://yuml.me/diagram/nofunky/class/[readObject]-%3E[readObject0],[readObject0]-%3E[readOrdinaryObject]" alt="readObject调用链"><br>最终调用的是<code>readOrdinaryObject</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">InputStream</span> <span class="keyword">implements</span> <span class="title class_">ObjectInput</span>, ObjectStreamConstants &#123;</span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readOrdinaryObject</span><span class="params">(<span class="type">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        <span class="type">ObjectStreamClass</span> <span class="variable">desc</span> <span class="operator">=</span> readClassDesc(<span class="literal">false</span>);</span><br><span class="line">        desc.checkDeserialize();</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        Object obj;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// =============== !!注意这里!! ===============</span></span><br><span class="line">            obj = desc.isInstantiable() ? desc.newInstance() : <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// =============== !!注意这里!! ===============</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (IOException) <span class="keyword">new</span> <span class="title class_">InvalidClassException</span>(desc.forClass().getName(), <span class="string">&quot;unable to create instance&quot;</span>).initCause(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">null</span> &amp;&amp; handles.lookupException(passHandle) == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            desc.hasReadResolveMethod()) &#123; <span class="comment">// 注意这里, false</span></span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>desc.isInstantiable()</code>返回<code>true</code>之后, 反序列化会通过反射创建一个新的对象.<br>看下<code>isInstantiable()</code>的文档.</p>
<blockquote>
<p>Returns true if represented class is serializable/externalizable and can be instantiated by the serialization runtime–i.e., if it is externalizable and defines a public no-arg constructor, or if it is non-externalizable and its first non-serializable superclass defines an accessible no-arg constructor.  Otherwise, returns false.</p>
</blockquote>
<p>也就是说, 满足以下两种情况任意一种, 则返回<code>true</code></p>
<ol>
<li>类实现了<code>Externalizable</code>接口, 并定义了一个无参构造器</li>
<li>类没有实现<code>Externalizable</code>接口, 它的第一个非<code>Serializable</code>父类(如<code>Object</code>)定义了一个无参构造器.</li>
</ol>
<p>我们继续往下看, 根据方法名, 如果<code>A</code>类实现了<code>readResolve</code>方法, 就会调用<code>readResolve</code>方法, 并返回出去.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObjectInputStream</span> <span class="keyword">extends</span> <span class="title class_">InputStream</span> <span class="keyword">implements</span> <span class="title class_">ObjectInput</span>, ObjectStreamConstants &#123;</span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readOrdinaryObject</span><span class="params">(<span class="type">boolean</span> unshared)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        Object obj;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        <span class="keyword">if</span> (obj != <span class="literal">null</span> &amp;&amp; handles.lookupException(passHandle) == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            desc.hasReadResolveMethod()) &#123; <span class="comment">// 注意这里, true</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">rep</span> <span class="operator">=</span> desc.invokeReadResolve(obj);</span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">            <span class="keyword">if</span> (rep != obj) &#123;</span><br><span class="line">                <span class="comment">// 省略部分代码</span></span><br><span class="line">                obj = rep;</span><br><span class="line">                <span class="comment">// 省略部分代码</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以, 要化解序列化攻击, 只需要写一个<code>readResolve</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readResolve</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="究极无敌完全进化完美精华牛逼上天单例模式懒汉版"><a href="#究极无敌完全进化完美精华牛逼上天单例模式懒汉版" class="headerlink" title="究极无敌完全进化完美精华牛逼上天单例模式懒汉版"></a>究极无敌完全进化完美精华牛逼上天单例模式懒汉版</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">A</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span>, Cloneable &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">static</span> A instance;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">A</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance != <span class="literal">null</span>) &#123;  <span class="comment">// 化解反射攻击</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;单例模式不允许再创建&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 双重锁保证线程安全</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> A <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (A.class) &#123;</span><br><span class="line">                <span class="keyword">if</span>(instance == <span class="literal">null</span>) &#123;</span><br><span class="line">                    instance = <span class="keyword">new</span> <span class="title class_">A</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> instance;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 化解克隆攻击</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException &#123;</span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 化解序列化攻击</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object <span class="title function_">readResolve</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> getInstance();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/70689">What is an efficient way to implement a singleton pattern in Java?</a></li>
<li><a href="http://kanlei.github.io/design%20pattern/2017/04/16/double-checked-locking-is-broken">Double Checked Locking is Broken</a></li>
<li><a href="http://www.importnew.com/21141.html">如何正确地写出单例模式</a></li>
<li><a href="http://ifeve.com/java%E9%94%81%E6%98%AF%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E6%95%B0%E6%8D%AE%E5%8F%AF%E8%A7%81%E6%80%A7%E7%9A%84/">Java锁是如何保证数据可见性的</a></li>
</ul>
]]></content>
      <categories>
        <category>设计模式</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>原型模式</title>
    <url>/posts/Prototype_Pattern.html</url>
    <content><![CDATA[<h1 id="什么是原型模式"><a href="#什么是原型模式" class="headerlink" title="什么是原型模式"></a>什么是原型模式</h1><p>从一个对象再创建另外一个可定制对象，而且不需要知道创建的细节。<br>类似于僵尸母体，通过实现一个克隆的接口，将自身属性拷贝给其他僵尸，还可以进行基因突变。</p>
<span id="more"></span>

<img data-src="/images/%E5%8E%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F_01.png" class="">

<p><strong>拷贝方式分为</strong></p>
<ul>
<li>浅拷贝：仅仅复制所考虑的对象，而不复制它所引用的对象</li>
<li>深拷贝：将复制的对象引用的对象都复制一遍</li>
</ul>
<h2 id="浅拷贝"><a href="#浅拷贝" class="headerlink" title="浅拷贝"></a>浅拷贝</h2><blockquote>
<p>仅仅复制所考虑的对象，而不复制它所引用的对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zombie</span>&#123;<span class="comment">//一个僵尸类</span></span><br><span class="line">    <span class="keyword">public</span> String id;</span><br><span class="line">    <span class="keyword">public</span> Zombie <span class="title function_">cloneZombie</span><span class="params">()</span> &#123;<span class="comment">//实现克隆方法</span></span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">z</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zombie</span>();</span><br><span class="line">        z.id = <span class="built_in">this</span>.id;<span class="comment">//浅拷贝僵尸的id号</span></span><br><span class="line">        <span class="keyword">return</span> z;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">cz1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zombie</span>();</span><br><span class="line">        cz1.id=<span class="string">&quot;001&quot;</span>;</span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">cz2</span> <span class="operator">=</span> cz1.cloneZombie();</span><br><span class="line">        System.out.println((cz1==cz2)+<span class="string">&quot;:&quot;</span>+cz1.id+<span class="string">&quot;,&quot;</span>+cz2.id);<span class="comment">//输出false:001,001</span></span><br><span class="line">    &#125;</span><br><span class="line">｝ </span><br></pre></td></tr></table></figure>

<h2 id="深拷贝"><a href="#深拷贝" class="headerlink" title="深拷贝"></a>深拷贝</h2><blockquote>
<p>将复制的对象引用的对象都复制一遍</p>
</blockquote>
<h1 id="java中自带的java-lang-Object-clone-分析"><a href="#java中自带的java-lang-Object-clone-分析" class="headerlink" title="java中自带的java.lang.Object.clone()分析"></a>java中自带的java.lang.Object.clone()分析</h1><p>在研究原型模式的时候，我将接口中的拷贝方法命名为<code>clone()</code>，却发现<code>Java</code>内部已经有了一个<code>clone()</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Object</span> &#123;  </span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">native</span> Object <span class="title function_">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用<code>native</code>修饰，表示是有<code>JNI</code>实现，效率远高于非<code>native</code>方法<br>用<code>protected</code>修饰，表示要使用这个<code>clone()</code>必须要继承自<code>Object</code>类，<code>Java</code>中所有类都是继承自<code>Object</code>类。<br>返回<code>Object</code>对象，表示需要强制类型转换。</p>
<p><strong>Java对象中的<code>clone</code>步骤</strong></p>
<ol>
<li>原型类实现<code>Cloneable</code>接口</li>
<li>重写<code>clone</code>方法，并调用<code>super.clone()</code>方法</li>
<li>实现深拷贝</li>
</ol>
<h2 id="原型类实现Cloneable接口"><a href="#原型类实现Cloneable接口" class="headerlink" title="原型类实现Cloneable接口"></a>原型类实现Cloneable接口</h2><p><code>ctrl+左键</code>查看源码发现，这是一个空的接口。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Cloneable</span> &#123;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<p>但是如果原型类没有实现<code>Cloneable</code>接口而去调用<code>Object.clone()</code>方法，会抛出<code>CloneNotSupportedException</code>异常</p>
<h2 id="重写clone方法，并调用super-clone-方法"><a href="#重写clone方法，并调用super-clone-方法" class="headerlink" title="重写clone方法，并调用super.clone()方法"></a>重写clone方法，并调用super.clone()方法</h2><p>继承自<code>java.lang.Object.clone()</code>方法是浅拷贝。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZombieMSG</span> &#123;<span class="comment">//僵尸信息类</span></span><br><span class="line">    <span class="keyword">public</span> String id;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ZombieMSG</span><span class="params">(String id, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;(id:&quot;</span>+id+<span class="string">&quot;,name:&quot;</span>+name+<span class="string">&quot;)&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zombie</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span>&#123;<span class="comment">//僵尸类，实现Cloneable接口</span></span><br><span class="line">    <span class="keyword">public</span> String id;</span><br><span class="line">    <span class="keyword">public</span> ZombieMSG msg;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Zombie</span><span class="params">(String id,String name)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">        msg = <span class="keyword">new</span> <span class="title class_">ZombieMSG</span>(id, name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span>&#123;<span class="comment">//重写clone方法</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            obj = <span class="built_in">super</span>.clone();<span class="comment">//调用Object中的clone()方法</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">pz</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zombie</span>(<span class="string">&quot;000&quot;</span>,<span class="string">&quot;母体僵尸&quot;</span>);</span><br><span class="line">        System.out.println(pz.id+<span class="string">&quot;:&quot;</span>+pz.msg);<span class="comment">//输出000:(id:000,name:母体僵尸)</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">cz1</span> <span class="operator">=</span> (Zombie) pz.clone();</span><br><span class="line">        cz1.id=<span class="string">&quot;001&quot;</span>;</span><br><span class="line">        cz1.msg.id=<span class="string">&quot;001&quot;</span>;</span><br><span class="line">        cz1.msg.name=<span class="string">&quot;普通僵尸1号&quot;</span>;</span><br><span class="line">        System.out.println((pz==cz1)+<span class="string">&quot;-&quot;</span>+pz.id+<span class="string">&quot;:&quot;</span>+pz.msg+<span class="string">&quot;,&quot;</span>+cz1.id+<span class="string">&quot;:&quot;</span>+cz1.msg);</span><br><span class="line">        <span class="comment">//输出false-000:(id:001,name:普通僵尸1号),,001:(id:001,name:普通僵尸1号)，说明是浅拷贝</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>为什么我们在派生类中覆盖<code>Object的clone()</code>方法时，一定要调用<code>super.clone()</code>呢？<br>在运行时刻，<code>Object</code>中的<code>clone()</code>识别你要复制的是哪一个对象。<br>然后为此对象分配空间，并进行对象的复制，将原始对象的内容一一复制到新对象的存储空间中。</p>
<h2 id="实现深拷贝"><a href="#实现深拷贝" class="headerlink" title="实现深拷贝"></a>实现深拷贝</h2><p>克隆类和被克隆类之间不应该存在引用传递的。也就是说。<br>普通僵尸肯定不能影响母体僵尸的，那么就要实现深拷贝。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ZombieMSG</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span>&#123;<span class="comment">//僵尸信息类，实现Cloneable接口</span></span><br><span class="line">    <span class="comment">//其他代码不变，新增clone方法</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">ZombieMSG</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            obj = (ZombieMSG) <span class="built_in">super</span>.clone();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Zombie</span> <span class="keyword">implements</span> <span class="title class_">Cloneable</span>&#123;<span class="comment">//僵尸类，实现Cloneable接口</span></span><br><span class="line">    <span class="comment">//其他代码不变，修改clone()方法    </span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">clone</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            obj = (Zombie) <span class="built_in">super</span>.clone();</span><br><span class="line">            obj.msg = (ZombieMSG) <span class="built_in">this</span>.msg.clone();<span class="comment">//关键代码，将ZombieMSG也进行浅拷贝</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (CloneNotSupportedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;  </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">pz</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Zombie</span>(<span class="string">&quot;000&quot;</span>,<span class="string">&quot;母体僵尸&quot;</span>);</span><br><span class="line">        System.out.println(pz.id+<span class="string">&quot;:&quot;</span>+pz.msg);<span class="comment">//输出000:(id:000,name:母体僵尸)</span></span><br><span class="line">        </span><br><span class="line">        <span class="type">Zombie</span> <span class="variable">cz1</span> <span class="operator">=</span> (Zombie) pz.clone();</span><br><span class="line">        cz1.id=<span class="string">&quot;001&quot;</span>;</span><br><span class="line">        cz1.msg.id=<span class="string">&quot;001&quot;</span>;</span><br><span class="line">        cz1.msg.name=<span class="string">&quot;普通僵尸1号&quot;</span>;</span><br><span class="line">        System.out.println((pz==cz1)+<span class="string">&quot;-&quot;</span>+pz.id+<span class="string">&quot;:&quot;</span>+pz.msg+<span class="string">&quot;,&quot;</span>+cz1.id+<span class="string">&quot;:&quot;</span>+cz1.msg);</span><br><span class="line">        <span class="comment">//输出false-000:(id:000,name:母体僵尸),001:(id:001,name:普通僵尸1号)，说明是深拷贝</span></span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>工厂模式</title>
    <url>/posts/Factory_Pattern.html</url>
    <content><![CDATA[<h1 id="什么是工厂模式"><a href="#什么是工厂模式" class="headerlink" title="什么是工厂模式"></a>什么是工厂模式</h1><p>我们创建实例对象一般都是用<code>new</code>进行的，但是工厂模式将<code>new</code>的过程封装了起来，负责将大量实现了共同接口的类实例化。</p>
<span id="more"></span>

<p><strong>工厂模式又分为</strong></p>
<ol>
<li>简单工厂模式：在具体工厂类里面创建抽象的产品。</li>
<li>工厂方法模式：在抽象工厂类里面创建抽象的产品。</li>
<li>抽象工厂模式：在抽象工厂类里面创建某个族的抽象的产品。</li>
</ol>
<h2 id="简单工厂模式"><a href="#简单工厂模式" class="headerlink" title="简单工厂模式"></a>简单工厂模式</h2><blockquote>
<p>违背了开闭原则，不利于扩展</p>
</blockquote>
<img data-src="/images/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F_01.png" class="">


<p>创建抽象产品<code>IUser</code>，以及两个具体产品<code>MySQLUser</code>、<code>SQLServerUser</code>。<br>通过<code>SQLFactory</code>工厂类创建具体产品。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/** 客户端  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">db</span> <span class="operator">=</span> UserFactory.createUserDB(UserFactory.DB_MYSQL);</span><br><span class="line">        db.insertUser(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽象的产品接口  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUser</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的产品  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySQL插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLServer插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 简单工厂  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLFactory</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_MYSQL=<span class="string">&quot;MySQL&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_SQLSERVER=<span class="string">&quot;SQLServer&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IUser <span class="title function_">createUserDB</span><span class="params">(String name)</span>&#123;</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">db</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">switch</span>(key)&#123;<span class="comment">//通过key获取实例对象并返回</span></span><br><span class="line">            <span class="keyword">case</span> DB_MYSQL:db = <span class="keyword">new</span> <span class="title class_">MySQLUser</span>();<span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> DB_SQLSERVER:db = <span class="keyword">new</span> <span class="title class_">SQLServerUser</span>();<span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> db;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果需要新增子类，比如<code>Oracle</code>的用户类，那么就继承<code>IUser</code>类写一个子类，并在工厂中添加一个<code>case</code>分支。<br>但是缺点也在这里，每写一个子类，都要去修改已有的<code>UserFactory</code>工厂类，去新增<code>case</code>分支，这不符合开闭原则。</p>
<h2 id="工厂方法模式"><a href="#工厂方法模式" class="headerlink" title="工厂方法模式"></a>工厂方法模式</h2><blockquote>
<p>优化了简单工厂模式，但是大大增加了类的数量</p>
</blockquote>
<img data-src="/images/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F_02.png" class="">

<p>创建抽象产品<code>IUser</code>，以及两个具体产品<code>MySQLUser</code>、<code>SQLServerUser</code>。<br>创建抽象工厂<code>SQLFactory</code>，以及两个具体工厂<code>MySQLFactory</code>、<code>SQLServerFactory</code>。<br>使用多态的特性，创建具体工厂，用来生产具体产品。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123; <span class="comment">//客户端代码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">SQLfactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySQLFactory</span>();</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">userDB</span> <span class="operator">=</span> factory.createUserDB();</span><br><span class="line">        userDB.insertUser(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽象的产品接口  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUser</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的产品  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySQL插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLServer插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽象的工厂 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SQLFactory</span> &#123;<span class="comment">//一个抽象工厂的接口</span></span><br><span class="line">    <span class="keyword">public</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span>;<span class="comment">//创建工厂的工厂</span></span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的工厂 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLFactory</span> <span class="keyword">implements</span> <span class="title class_">SQLFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MySQLUser</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerFactory</span> <span class="keyword">implements</span> <span class="title class_">SQLFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SQLServerUser</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>在简单工厂模式的基础上，把工厂抽象出来，给每一个数据库添加一个工厂。<br>当需要添加新的数据库功能的时候，只要添加工厂或操作类即可。不用再去关注工厂中的判断分支（实际上已经没有判断分支了）。<br>缺点也在这，每添加一个子类功能的时候，都要创建两个类，工厂和操作类，增加了代码量。</p>
<h2 id="抽象工厂模式"><a href="#抽象工厂模式" class="headerlink" title="抽象工厂模式"></a>抽象工厂模式</h2><blockquote>
<p>代码冗余，过度设计</p>
</blockquote>
 <img data-src="/images/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F_03.png" class="">
<p>创建抽象产品<code>IUser</code>，以及两个具体产品<code>MySQLUser</code>、<code>SQLServerUser</code>。<br>创建抽象产品<code>IAuth</code>，以及两个具体产品<code>MySQLAuth</code>、<code>SQLServerAuth</code>。<br>创建抽象工厂<code>SQLFactory</code>，以及两个具体工厂<code>MySQLFactory</code>、<code>SQLServerFactory</code>。<br>使用多态的特性，创建具体工厂，用来生产具体产品。<br>和工厂方法模式类似，只是增加了不同的产品。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123; <span class="comment">//客户端代码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">SQLfactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySQLFactory</span>();</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">userDB</span> <span class="operator">=</span> factory.createUserDB();</span><br><span class="line">        userDB.insertUser(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        <span class="type">IAuth</span> <span class="variable">authDB</span> <span class="operator">=</span> factory.createAuthDB();</span><br><span class="line">        authDB.insertAuth(<span class="keyword">new</span> <span class="title class_">Auth</span>());</span><br><span class="line">    &#125; </span><br><span class="line"><span class="comment">/** 抽象的产品接口  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUser</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的产品  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySQL插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLServer插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/** 抽象的产品接口  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IAuth</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertAuth</span><span class="params">(Auth auth)</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的产品  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLAuth</span> <span class="keyword">implements</span> <span class="title class_">IAuth</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAuth</span><span class="params">(Auth auth)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySQL插入一条权限数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerAuth</span> <span class="keyword">implements</span> <span class="title class_">IAuth</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAuth</span><span class="params">(Auth auth)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLServer插入一条权限数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽象的工厂 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SQLFactory</span> &#123;<span class="comment">//一个抽象工厂的接口</span></span><br><span class="line">    <span class="keyword">public</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span>;<span class="comment">//创建工厂的工厂</span></span><br><span class="line">    <span class="keyword">public</span> IAuth <span class="title function_">createAuthDB</span><span class="params">()</span>;<span class="comment">//创建工厂的工厂</span></span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的工厂 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLFactory</span> <span class="keyword">implements</span> <span class="title class_">SQLFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span> &#123;   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MySQLUser</span>(); &#125;</span><br><span class="line">    <span class="keyword">public</span> IAuth <span class="title function_">createAuthDB</span><span class="params">()</span> &#123;   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MySQLAuth</span>(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerFactory</span> <span class="keyword">implements</span> <span class="title class_">SQLFactory</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span> &#123;   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SQLServerUser</span>(); &#125;</span><br><span class="line">    <span class="keyword">public</span> IAuth <span class="title function_">createAuthDB</span><span class="params">()</span> &#123;   <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SQLServerAuth</span>(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用简单工厂-反射-配置文件优化抽象工厂"><a href="#用简单工厂-反射-配置文件优化抽象工厂" class="headerlink" title="用简单工厂+反射+配置文件优化抽象工厂"></a>用简单工厂+反射+配置文件优化抽象工厂</h2><img data-src="/images/%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F_04.png" class="">

<p>删除<code>SQLFactory</code>、<code>MySQLFactory</code>、<code>SQLServerFactory</code>三个工厂。<br>融合成一个<code>SQLFactory类</code>，再通过<code>properties</code>配置文件加载类。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123; <span class="comment">//客户端代码</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">IUser</span> <span class="variable">userDB</span> <span class="operator">=</span> SQLFactory.createUserDB();</span><br><span class="line">        userDB.insertUser(<span class="keyword">new</span> <span class="title class_">User</span>());</span><br><span class="line">        <span class="type">IAuth</span> <span class="variable">authDB</span> <span class="operator">=</span> SQLFactory.createAuthDB();</span><br><span class="line">        authDB.insertAuth(<span class="keyword">new</span> <span class="title class_">Auth</span>());</span><br><span class="line">    &#125; </span><br><span class="line"><span class="comment">/** 抽象的产品接口  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IUser</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的产品  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySQL插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerUser</span> <span class="keyword">implements</span> <span class="title class_">IUser</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertUser</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLServer插入一条用户数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="comment">/** 抽象的产品接口  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IAuth</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">insertAuth</span><span class="params">(Auth auth)</span>;</span><br><span class="line">&#125;  </span><br><span class="line"><span class="comment">/** 具体的产品  */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MySQLAuth</span> <span class="keyword">implements</span> <span class="title class_">IAuth</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAuth</span><span class="params">(Auth auth)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;MySQL插入一条权限数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLServerAuth</span> <span class="keyword">implements</span> <span class="title class_">IAuth</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">insertAuth</span><span class="params">(Auth auth)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SQLServer插入一条权限数据&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">/** 抽象的工厂 */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SQLFactory</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String dbName;</span><br><span class="line">    <span class="comment">/** 从db.properties中获取数据库信息 */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>(<span class="type">InputStream</span> <span class="variable">in</span> <span class="operator">=</span> SQLFactory.class.getResourceAsStream(<span class="string">&quot;/db.properties&quot;</span>);) &#123;</span><br><span class="line">            <span class="type">Properties</span> <span class="variable">prop</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">            prop.load(in);</span><br><span class="line">            <span class="keyword">for</span> (Object key : prop.keySet()) &#123;</span><br><span class="line">                <span class="keyword">if</span>(key.equals(<span class="string">&quot;dbName&quot;</span>))&#123;</span><br><span class="line">                    dbName = prop.getProperty((String) key);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** 通过反射获取IUser产品 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IUser <span class="title function_">createUserDB</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(dbName+<span class="string">&quot;User&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (IUser) clazz.getConstructor().newInstance();;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** 通过反射获取IAuth产品 */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> IAuth <span class="title function_">createAuthDB</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">clazz</span> <span class="operator">=</span> Class.forName(dbName+<span class="string">&quot;Auth&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> (IAuth) clazz.getConstructor().newInstance();;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>模版方法模式</title>
    <url>/posts/Template_method.html</url>
    <content><![CDATA[<h1 id="什么是模版方法模式"><a href="#什么是模版方法模式" class="headerlink" title="什么是模版方法模式"></a>什么是模版方法模式</h1><p>把多个类公有的代码抽象出来成为一个父类，并开放接口将不同的代码交由子类来实现。<br> <span id="more"></span></p>
<img data-src="/images/%E6%A8%A1%E7%89%88%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F_01.png" class="">

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;<span class="comment">//学生父类</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">show</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;我的名字是:&quot;</span>+getName());<span class="comment">//把公有代码抽象出来，开放一个getName()方法交给子类实现</span></span><br><span class="line">        System.out.println(<span class="string">&quot;我的学号是:&quot;</span>+getNo());<span class="comment">//把公有代码抽象出来，开放一个getNo()方法交给子类实现</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title function_">getNo</span><span class="params">()</span>;<span class="comment">//交由子类实现</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">abstract</span> String <span class="title function_">getName</span><span class="params">()</span>;<span class="comment">//交由子类实现</span></span><br><span class="line">&#125; </span><br><span class="line"> </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentA</span> <span class="keyword">extends</span> <span class="title class_">Student</span> &#123;<span class="comment">//学生A</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getNo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;001&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;小A&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentB</span> <span class="keyword">extends</span> <span class="title class_">Student</span> &#123;<span class="comment">//学生B</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getNo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;002&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;小B&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">sa</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentA</span>();</span><br><span class="line">        sa.show();</span><br><span class="line">        <span class="type">Student</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StudentB</span>();</span><br><span class="line">        sb.show();</span><br><span class="line">    &#125; </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>观察者模式</title>
    <url>/posts/Observer_Pattern.html</url>
    <content><![CDATA[<h1 id="什么是观察者模式"><a href="#什么是观察者模式" class="headerlink" title="什么是观察者模式"></a>什么是观察者模式</h1><p>观察者模式又叫做发布订阅模式，类似于微信公众号，一个发布端，多个接收端。<br>观察者模式定义了对象之间的一对多的依赖，这样一来，当一个对象改变时，它的所有的依赖者都会收到通知并自动更新。<br>通俗的讲，就是在被观察类中，持有一个观察类的集合，然后在数据改变的时候，遍历所有观察类，调用更新方法。</p>
<span id="more"></span>

<h1 id="实现观察者模式"><a href="#实现观察者模式" class="headerlink" title="实现观察者模式"></a>实现观察者模式</h1><p><strong>建立观察者模式的步骤</strong></p>
<ol>
<li>编写观察者接口和被观察者的接口</li>
<li>实现观察者和被观察者</li>
<li>注册观察者</li>
<li>通知观察者</li>
</ol>
<h2 id="编写观察者接口和被观察者的接口"><a href="#编写观察者接口和被观察者的接口" class="headerlink" title="编写观察者接口和被观察者的接口"></a>编写观察者接口和被观察者的接口</h2><p><code>java</code>中已经准备了这两个接口，观察者接口<code>Observer</code>和被观察者类<code>Observable</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Observer</span> &#123;<span class="comment">//观察者的接口</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Observable observable, Object data)</span>;<span class="comment">//只有一个用于更新的方法</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Observable</span> &#123;<span class="comment">//被观察者类</span></span><br><span class="line">    List&lt;Observer&gt; observers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;Observer&gt;();<span class="comment">//内部持有一个观察者的List集合</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">changed</span> <span class="operator">=</span> <span class="literal">false</span>;<span class="comment">//数据是否改变的标志位</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Observable</span><span class="params">()</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObserver</span><span class="params">(Observer observer)</span> &#123;<span class="comment">//添加观察者</span></span><br><span class="line">        <span class="keyword">if</span> (observer == <span class="literal">null</span>) &#123;<span class="comment">//防止空指针异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(<span class="string">&quot;observer == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;<span class="comment">//同步锁</span></span><br><span class="line">            <span class="keyword">if</span> (!observers.contains(observer))<span class="comment">//判断是否已经添加观察者</span></span><br><span class="line">                observers.add(observer);<span class="comment">//如果没有就添加</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">clearChanged</span><span class="params">()</span> &#123;<span class="comment">//清空数据是否改变的标志位</span></span><br><span class="line">        changed = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">countObservers</span><span class="params">()</span> &#123;<span class="comment">//返回观察者的数量</span></span><br><span class="line">        <span class="keyword">return</span> observers.size();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">deleteObserver</span><span class="params">(Observer observer)</span> &#123;<span class="comment">//移除某个观察者</span></span><br><span class="line">        observers.remove(observer);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">deleteObservers</span><span class="params">()</span> &#123;<span class="comment">//移除所有观察者</span></span><br><span class="line">        observers.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasChanged</span><span class="params">()</span> &#123;<span class="comment">//获取数据是否改变的标志位</span></span><br><span class="line">        <span class="keyword">return</span> changed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">()</span> &#123;<span class="comment">//拉模式更新数据</span></span><br><span class="line">        notifyObservers(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyObservers</span><span class="params">(Object data)</span> &#123;<span class="comment">//推模式更新数据，推送data</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        Observer[] arrays = <span class="literal">null</span>;<span class="comment">//临时存放当前观察者的状态，参见备忘录模式</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (hasChanged()) &#123;<span class="comment">//数据是否发生改变</span></span><br><span class="line">                clearChanged();<span class="comment">//清空标志位</span></span><br><span class="line">                size = observers.size();</span><br><span class="line">                arrays = <span class="keyword">new</span> <span class="title class_">Observer</span>[size];</span><br><span class="line">                observers.toArray(arrays);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (arrays != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (Observer observer : arrays) &#123;</span><br><span class="line">                observer.update(<span class="built_in">this</span>, data);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setChanged</span><span class="params">()</span> &#123;<span class="comment">//设置数据发生改变</span></span><br><span class="line">        changed = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="实现观察者和被观察者"><a href="#实现观察者和被观察者" class="headerlink" title="实现观察者和被观察者"></a>实现观察者和被观察者</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Observer1</span> <span class="keyword">implements</span> <span class="title class_">Observer</span>&#123;<span class="comment">//观察者</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">update</span><span class="params">(Observable observable, Object data)</span> &#123;</span><br><span class="line">        Log.i(<span class="string">&quot;Observer1&quot;</span>, <span class="string">&quot;change&quot;</span>);    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Subject</span> <span class="keyword">extends</span> <span class="title class_">Observable</span>&#123;<span class="comment">//被观察者</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">change</span><span class="params">()</span>&#123;</span><br><span class="line">    setChanged();<span class="comment">//必须调用这个方法确认修改数据</span></span><br><span class="line">    notifyObservers();通知所有观察者</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="注册观察者"><a href="#注册观察者" class="headerlink" title="注册观察者"></a>注册观察者</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Subject</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Subject</span>();<span class="comment">//new一个被观察者</span></span><br><span class="line"><span class="type">Observer1</span> <span class="variable">o1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Observer1</span>();<span class="comment">//new一个观察者</span></span><br><span class="line">s.addObserver(o1);<span class="comment">//进行注册</span></span><br></pre></td></tr></table></figure>

<h2 id="通知观察者"><a href="#通知观察者" class="headerlink" title="通知观察者"></a>通知观察者</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">s.change();  <span class="comment">//调用被观察者的</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>编程杂谈</category>
      </categories>
      <tags>
        <tag>设计模式</tag>
      </tags>
  </entry>
  <entry>
    <title>社保卡办理</title>
    <url>/posts/apply_for_social_security_card.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>公司说要办社保卡，给了我个电脑号，叫我自己去银行办。然后就请了个假去办社保了。</p>
<span id="more"></span>

<h1 id="办理材料"><a href="#办理材料" class="headerlink" title="办理材料"></a>办理材料</h1><ol>
<li>身份证</li>
<li>数码照相回执(随便找个照相馆说要照社保卡的数码回执)</li>
<li>电脑号</li>
</ol>
<h1 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h1><p>请了一天假，跑到建行去办社保卡，结果说要4个月才能办成，推荐我到隔壁的招行去办理，1个月搞定。</p>
<img data-src="/posts/apply_for_social_security_card/01.png" class="">
<p>What ？？？ 你确定你不是招行派来的奸细 ？？？</p>
<p>然后跑到招行去，以为要拿号等好久，没想到前台叫我打开微信，找个 <strong>【电子社保卡】</strong> 的公众号。</p>
<p>没想到现在的银行竟然也支持微信办理社保卡了。</p>
<p>照着微信公众号的流程办理就好了。</p>
<img data-src="/posts/apply_for_social_security_card/01.png" class="">
<p>所以我请假过来是干嘛的？？？ 一天的工资就这样打水漂了。</p>
]]></content>
      <categories>
        <category>生活</category>
      </categories>
      <tags>
        <tag>生活</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux网络命名空间</title>
    <url>/posts/Linux_network_namespace.html</url>
    <content><![CDATA[<h1 id="network-namespace"><a href="#network-namespace" class="headerlink" title="network namespace"></a>network namespace</h1><p><code>Linux network namespace</code> 是 <code>Linux</code> 提供的网络虚拟化功能, 它能创建网络虚拟空间, 将容器(<code>Docker</code>)或虚拟机的网络隔离开来, 假装是一台独立的网络机器.<br><code>Docker</code>也使用了<code>Linux network namespace</code>来隔离网络空间.</p>
<span id="more"></span>

<h1 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h1><p>我们先建立起一个概念, 将网络命名空间看作是一台虚拟机, 添加删除网络命名空间, 就是添加删除一台虚拟机.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 添加网络命名空间</span></span><br><span class="line">ip netns add ns1</span><br><span class="line"><span class="comment"># 查看网络命名空间</span></span><br><span class="line">ip netns list</span><br><span class="line"><span class="comment"># 删除网络命名空间</span></span><br><span class="line">ip netns delete ns1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 ns1 里执行 ip link 命令</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip <span class="built_in">link</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK&gt; mtu 65536 qdisc noop state DOWN mode DEFAULT group default qlen 1</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 ns1 里执行 ip link set dev lo up 命令, 将 lo 网卡 up 起来</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip <span class="built_in">link</span> <span class="built_in">set</span> dev lo up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip <span class="built_in">link</span></span><br><span class="line"><span class="comment"># 1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1</span></span><br><span class="line"><span class="comment">#     link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span></span><br></pre></td></tr></table></figure>
<p>我们可以看到, 我们想在网络命名空间<code>ns1</code>里将<code>lo</code>网卡<code>up</code>起来, 但实际上却是从<code>DOWN</code>状态变成<code>UNKNOWN</code>状态, 并没有变成<code>UP</code>状态.<br>这也可以理解, 实际生活中, 我们给一台机器联网, 也不仅仅是将水晶头插入机器网卡上, 还要将另一头插入路由器.<br><img data-src="https://yuml.me/diagram/nofunky/class/[ns1]%3C-%3E[ns2]" alt="Veth pair"></p>
<h1 id="使用-Veth-pair-进行一对一通信"><a href="#使用-Veth-pair-进行一对一通信" class="headerlink" title="使用 Veth pair 进行一对一通信"></a>使用 Veth pair 进行一对一通信</h1><p>在<code>Linux</code>网络命名空间担任网线一职的, 是叫做<code>Veth pair</code>的东西.<br>我们先来做一个实际的例子, ；将两个网络命名空间连通起来.</p>
<p>相互连接的两个网络命名空间, 各自拥有一个<code>Veth pair</code>, <code>Veth pair</code>是成对存在的, 删掉一个另一个也会被删掉.</p>
<p>下面是简单的一个拉网线例子, 将两个网络命名空间<code>ns1</code>和<code>ns2</code>连通起来.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 添加2个network namespace</span></span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 添加一对 veth pair</span></span><br><span class="line"><span class="comment"># ip link add &lt;p1-name&gt; type veth peer name &lt;p2-name&gt;</span></span><br><span class="line">ip <span class="built_in">link</span> add veth-test1 <span class="built_in">type</span> veth peer name veth-test2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 绑定到对应的网络命名空间上</span></span><br><span class="line"><span class="comment"># ip link set &lt;Veth-pair&gt;  netns &lt;network-namespace&gt;</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-test1 netns ns1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-test2 netns ns2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 为不同网络命名空间下的 veth pair 添加 ip 地址</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip addr add 192.168.1.1/24  dev veth-test1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2       ip addr add 192.168.1.2/24  dev veth-test2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 启用 veth pair</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-test1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2       ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-test2 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. ping</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ping 192.168.1.2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2       ping 192.168.1.1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip <span class="built_in">link</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns2       ip <span class="built_in">link</span></span><br></pre></td></tr></table></figure>

<h1 id="使用-Bridge-进行多对多通信"><a href="#使用-Bridge-进行多对多通信" class="headerlink" title="使用 Bridge 进行多对多通信"></a>使用 Bridge 进行多对多通信</h1><p>如果有<code>100</code>台机器进行通信, 就需要<code>100*100=10000</code>个<code>Veth pair</code>. 这种拓扑结构明显是有问题的.<br>在实际生活中, 我们也不会在一台机器上部署<code>100</code>个网卡, 而是通过集线器或者路由器来实现多机通信.<br><code>Bridge</code>提供了一个桥梁, 相当于一个中转站, 这样要追加<code>1</code>台机器, 只需要<code>1</code>个<code>Veth pair</code>, 连接到<code>Bridge</code>, <code>Bridge</code>会转发到目标机器上.</p>
<h2 id="简单的-3-台机器通信例子"><a href="#简单的-3-台机器通信例子" class="headerlink" title="简单的 3 台机器通信例子"></a>简单的 3 台机器通信例子</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建 Bridge 并启动, 创建3个 network namespace</span></span><br><span class="line">ip <span class="built_in">link</span> add ahao-bridge <span class="built_in">type</span> bridge</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev ahao-bridge up</span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line">ip netns add ns3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建 3对 Veth pair</span></span><br><span class="line">ip <span class="built_in">link</span> add veth-bridge1 <span class="built_in">type</span> veth peer name veth-ns1</span><br><span class="line">ip <span class="built_in">link</span> add veth-bridge2 <span class="built_in">type</span> veth peer name veth-ns2</span><br><span class="line">ip <span class="built_in">link</span> add veth-bridge3 <span class="built_in">type</span> veth peer name veth-ns3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 绑定到各自的 network namespace</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-ns1 netns ns1</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-ns2 netns ns2</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> veth-ns3 netns ns3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 添加ip地址</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1       ip addr add 192.168.1.1/24 dev veth-ns1</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2       ip addr add 192.168.1.2/24 dev veth-ns2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns3       ip addr add 192.168.1.3/24 dev veth-ns3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 连接到bridge</span></span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-bridge1 master ahao-bridge</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-bridge2 master ahao-bridge</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-bridge3 master ahao-bridge</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 启用</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-ns1 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns2 ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-ns2 up</span><br><span class="line">ip netns <span class="built_in">exec</span> ns3 ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-ns3 up</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-bridge1 up</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-bridge2 up</span><br><span class="line">ip <span class="built_in">link</span> <span class="built_in">set</span> dev veth-bridge3 up</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. ping测试</span></span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ping 192.168.154.2</span><br><span class="line">ip netns <span class="built_in">exec</span> ns1 ping 192.168.154.3</span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO 跑不起来</span></span><br><span class="line">ip netns delete ns1</span><br><span class="line">ip netns delete ns2</span><br><span class="line">ip netns delete ns3</span><br><span class="line">ip <span class="built_in">link</span> delete ahao-bridge</span><br><span class="line">ip netns list</span><br><span class="line">ip <span class="built_in">link</span></span><br></pre></td></tr></table></figure>

<p>结果这<code>3</code>台机器都可以两两相互通信.<br>使用<code>bridge link</code>命令可以查看连接信息.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># brctl 命令需要安装依赖</span></span><br><span class="line">yum install -y bridge-utils</span><br><span class="line">bridge <span class="built_in">link</span></span><br><span class="line"><span class="comment"># 50: veth-bridge1 state UP @(null): &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master bridge-ns state forwarding priority 32 cost 2 </span></span><br><span class="line"><span class="comment"># 52: veth-bridge2 state UP @(null): &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master bridge-ns state forwarding priority 32 cost 2 </span></span><br><span class="line"><span class="comment"># 56: veth-bridge3 state UP @(null): &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 master bridge-ns state forwarding priority 32 cost 2 </span></span><br></pre></td></tr></table></figure>

<h1 id="使用-NAT-连接外网"><a href="#使用-NAT-连接外网" class="headerlink" title="使用 NAT 连接外网"></a>使用 NAT 连接外网</h1><p>待续</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>计算机网络</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux下的定时任务</title>
    <url>/posts/Timing_tasks_of_Linux.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>同步数据之类的工作需要定时去完成, 如果要人工去做, 那是费时费力的。<br>既然是定时, 有规律可循, 那就应该使用编程完成, 而不是依赖人力完成。<br><code>Java</code> 有 <code>Quartz</code> 可以完成。<code>Linux</code> 和 <code>Windows</code> 也有相同的工具。</p>
<span id="more"></span>

<h1 id="一次执行和多次执行"><a href="#一次执行和多次执行" class="headerlink" title="一次执行和多次执行"></a>一次执行和多次执行</h1><p>一次执行: <code>at</code>命令, 需要<code>atd</code>服务的支持。<br>多次执行: <code>crontab</code>命令, 需要<code>crond</code>服务的支持。</p>
<h1 id="只执行一次的定时任务"><a href="#只执行一次的定时任务" class="headerlink" title="只执行一次的定时任务"></a>只执行一次的定时任务</h1><h2 id="打开atd服务"><a href="#打开atd服务" class="headerlink" title="打开atd服务"></a>打开atd服务</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 确保打开 atd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># /etc/init.d/atd restart</span></span><br><span class="line">停止 atd：                                                 [确定]</span><br><span class="line">启动 atd：                                                 [确定]</span><br><span class="line"><span class="comment"># 将启动 atd 服务写入配置文件, 开机自动打开</span></span><br><span class="line">[root@localhost  ~]<span class="comment"># chkconfig atd on</span></span><br></pre></td></tr></table></figure>

<h2 id="指定允许使用at的用户"><a href="#指定允许使用at的用户" class="headerlink" title="指定允许使用at的用户"></a>指定允许使用at的用户</h2><p><code>at</code> 有两个重要的文件, 用来限制可以使用<code>at</code>定时任务的用户。<br>一个用户名占一行。<br><code>/etc/at.allow</code>白名单和<code>/etc/at.deny</code>黑名单。<br><code>at</code>根据文件是否存在判断使用白名单或者黑名单。</p>
<table>
<thead>
<tr>
<th align="center"><code>/etc/at.allow</code></th>
<th align="center"><code>/etc/at.deny</code></th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">√</td>
<td align="center">无论是否存在</td>
<td align="center">只允许<code>/etc/at.allow</code>的用户执行<code>at</code></td>
</tr>
<tr>
<td align="center">×</td>
<td align="center">√</td>
<td align="center">禁止<code>/etc/at.deny</code>的用户执行<code>at</code></td>
</tr>
<tr>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">只有<code>root</code>能执行<code>at</code></td>
</tr>
</tbody></table>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一次性的5分钟后创建文件的定时任务</span></span><br><span class="line">[root@localhost ~]<span class="comment"># at -m now + 5 minutes </span></span><br><span class="line">at&gt; <span class="built_in">cat</span> <span class="string">&#x27;now+5minutes file&#x27;</span> &gt; /tmp/now+5minutes.file</span><br><span class="line">at&gt; <span class="built_in">echo</span> <span class="string">&#x27;execute at task&#x27;</span> <span class="comment"># 使用 -m 选项可以将输出信息发送到email中</span></span><br><span class="line">at&gt; &lt;EOT&gt; <span class="comment"># 按Ctrl+D结束输入</span></span><br><span class="line">job 6 at 2017-10-19 04:31</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看at定时任务队列(queue), 或者 at -l</span></span><br><span class="line">[root@localhost ~]<span class="comment"># atq</span></span><br><span class="line">6  2017-10-19 04:31 a root</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查询定时任务的内容, -c 指定任务号</span></span><br><span class="line">[root@localhost ~]<span class="comment"># at -c 6</span></span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 省略一堆环境变量</span></span><br><span class="line"><span class="comment"># 进入创建定时任务时所在的文件夹</span></span><br><span class="line"><span class="built_in">cd</span> /root || &#123;</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">&#x27;Execution directory inaccessible&#x27;</span> &gt;&amp;2</span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">cat</span> <span class="string">&#x27;now+5minutes file&#x27;</span> &gt; /tmp/now+5minutes.file</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;execute at task&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 根据任务号6, 移除(remove)定时任务</span></span><br><span class="line">[root@localhost ~]<span class="comment"># atrm 6</span></span><br><span class="line"><span class="comment"># 5. 再次查看任务列表, 没有定时任务, 已经被删除了</span></span><br><span class="line">[root@localhost ~]<span class="comment"># atq</span></span><br></pre></td></tr></table></figure>

<h2 id="其他的时间格式"><a href="#其他的时间格式" class="headerlink" title="其他的时间格式"></a>其他的时间格式</h2><p>除了用<code>now + 5 minutes</code>指定时间外, 还有其他的时间格式</p>
<table>
<thead>
<tr>
<th align="center">时间格式</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">HH:MM</td>
<td align="center">在HH时MM分执行一次</td>
</tr>
<tr>
<td align="center">HH:MM YYYY-MM-DD</td>
<td align="center">在YYYY年MM月DD日HH时MM分执行一次</td>
</tr>
<tr>
<td align="center">HH:MM[am/pm] [Month] [Date]</td>
<td align="center">在Month月Date日早上/下午HH时MM分执行一次, 月份是<strong>英文</strong>表示</td>
</tr>
<tr>
<td align="center">HH:MM[am/pm] + number [minutes/hours/days/weeks]</td>
<td align="center">在早上/下午HH时MM分的number分钟/小时/天/周后执行一次</td>
</tr>
</tbody></table>
<h2 id="batch空闲时运行"><a href="#batch空闲时运行" class="headerlink" title="batch空闲时运行"></a>batch空闲时运行</h2><p><code>batch</code>可以控制在工作负载低于<code>0.8</code>的时候执行一次定时任务。<br>工作负载为1, 说明这个时间点有1个程序在运行。<br>工作负载为2, 说明这个时间点有2个程序在运行。<br>负载越高, 说明CPU单位时间内切换程序的次数越多。<br>当然, 程序不可能一直在运算, 所以也有低于1的情况产生。<br><code>batch</code>可以避免在程序繁忙的时候执行一些操作, 比如定时重启。让定时任务延后运行。<br>可以看到最后一行代码是执行了<code>at</code>命令, 只是附带了一些参数而已。<br>和<code>at</code>命令一样的用法。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># nl /usr/bin/batch</span></span><br><span class="line">42  <span class="built_in">exec</span> /usr/bin/at <span class="variable">$OPT_f</span> <span class="variable">$OPT_m</span> <span class="variable">$OPT_q</span> <span class="variable">$OPT_v</span> <span class="variable">$OPT_V</span> <span class="variable">$time_date_arg</span></span><br></pre></td></tr></table></figure>

<h1 id="多次执行的定时任务"><a href="#多次执行的定时任务" class="headerlink" title="多次执行的定时任务"></a>多次执行的定时任务</h1><p><code>Java</code>下有<code>Quartz</code>这个定时任务框架, 也使用到了<code>corn</code>表达式。<br><code>Linux</code>下的多次执行的定时任务是通过<code>cron</code>服务实现的。<br>检查<code>crontab</code>工具是否安装: <code>crontab -l</code><br>检查<code>crond</code>服务是否启动: <code>service  crond status</code></p>
<h2 id="指定允许使用cron的用户"><a href="#指定允许使用cron的用户" class="headerlink" title="指定允许使用cron的用户"></a>指定允许使用cron的用户</h2><p>和<code>at</code>一样, <code>cron</code>也有两个文件用来限制可以使用<code>cron</code>定时任务的用户。<br>一个用户名占一行。<br><code>/etc/cron.allow</code>白名单和<code>/etc/cron.deny</code>黑名单。</p>
<table>
<thead>
<tr>
<th align="center"><code>/etc/cron.allow</code></th>
<th align="center"><code>/etc/cron.deny</code></th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">√</td>
<td align="center">无论是否存在</td>
<td align="center">只允许<code>/etc/cron.allow</code>的用户执行<code>cron</code></td>
</tr>
<tr>
<td align="center">×</td>
<td align="center">√</td>
<td align="center">禁止<code>/etc/cron.deny</code>的用户执行<code>cron</code></td>
</tr>
<tr>
<td align="center">×</td>
<td align="center">×</td>
<td align="center">只有<code>root</code>能执行<code>cron</code></td>
</tr>
</tbody></table>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p><code>/etc/crontab</code>文件存储了<strong>系统</strong>的定时任务<br><code>/var/spool/cron/用户名</code>文件存储了各个<strong>用户</strong>的定时任务<br><code>/etc/cron.allow</code>文件指定了允许执行定时任务的<strong>白名单</strong><br><code>/etc/cron.deny</code>文件指定了允许执行定时任务的<strong>黑名单</strong></p>
<p>通过查看<code>/etc/crontab</code>可以看到看到<strong>系统</strong>的定时任务</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/crontab </span></span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">PATH=/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line">MAILTO=root</span><br><span class="line">HOME=/</span><br><span class="line"></span><br><span class="line"><span class="comment"># run-parts 后面跟一个目录, 可以执行目录下所有可执行文件</span></span><br><span class="line">01 * * * * root run-parts /etc/cron.hourly</span><br><span class="line">02 4 * * * root run-parts /etc/cron.daily</span><br><span class="line">22 4 * * 0 root run-parts /etc/cron.weekly</span><br><span class="line">42 4 1 * * root run-parts /etc/cron.monthly</span><br></pre></td></tr></table></figure>

<h1 id="cron表达式"><a href="#cron表达式" class="headerlink" title="cron表达式"></a>cron表达式</h1><p>从上可以看出cron表达式的格式如下</p>
<table>
<thead>
<tr>
<th align="center"></th>
<th align="center">分</th>
<th align="center">时</th>
<th align="center">日</th>
<th align="center">月</th>
<th align="center">星期几</th>
<th align="center">用户名</th>
<th align="center">命令</th>
</tr>
</thead>
<tbody><tr>
<td align="center">取值范围</td>
<td align="center">0~59</td>
<td align="center">0~23</td>
<td align="center">1~31</td>
<td align="center">1~12</td>
<td align="center">0~7(0或7都是星期天)</td>
<td align="center">可选</td>
<td align="center">命令</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># who</span></span><br><span class="line">ahao     pts/1        2017-10-19 06:40 (192.168.94.121)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 编辑任务, 每分钟输出一次hello到终端屏幕/dev/pts/1上</span></span><br><span class="line">[root@localhost ~]<span class="comment"># crontab -e</span></span><br><span class="line">*/1 * * * * <span class="built_in">echo</span> <span class="string">&#x27;hello&#x27;</span> &gt; /dev/pts/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 查看定时任务列表</span></span><br><span class="line">[root@localhost ~]<span class="comment"># crontab -l</span></span><br><span class="line">*/1 * * * * <span class="built_in">echo</span> <span class="string">&#x27;hello&#x27;</span> &gt; /dev/pts/1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 清空定时任务, 单项删除用 crontab -e 编辑</span></span><br><span class="line">[root@localhost ~]<span class="comment"># crontab -r</span></span><br></pre></td></tr></table></figure>

<h2 id="例子-1"><a href="#例子-1" class="headerlink" title="例子"></a>例子</h2><p>具体的用法, 只要看懂下面几个例子就行了</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 每天21:30重启apache</span></span><br><span class="line">30 21 * * * service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每月1、10、22日4:45重启apache, 逗号表示或</span></span><br><span class="line">45 4 1,10,22 * * service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每月的1-10日4:45重启apache, 横杠表示区间</span></span><br><span class="line">45 4 1-10 * * service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每隔2分钟重启apache, 斜杠表示每隔一段时间</span></span><br><span class="line">*/2 * * * * service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每天23点到7点每隔1小时重启apache</span></span><br><span class="line">0 23-7/1 * * * service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每天18:00到23:00每隔30分钟重启apache</span></span><br><span class="line">*/30 18-23 * * * service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4月的1-7号或每个星期日早晨1时59分重启apache</span></span><br><span class="line">59 1 1-7 * 4 0 service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4月的第1个星期日早晨1时59分重启apache, 第三个时间位置和第五个时间位置是【或】的关系</span></span><br><span class="line">59 1 1-7 4 * <span class="built_in">test</span> $(<span class="built_in">date</span> +%w) -eq 0 &amp;&amp; service httpd restart</span><br><span class="line"></span><br><span class="line"><span class="comment"># 每30秒重启apache, 通过sleep进行精确到秒级的操作, 注意要两个任务都存在</span></span><br><span class="line">*/1 * * * * service httpd restart</span><br><span class="line">*/1 * * * * <span class="built_in">sleep</span> 30s; service httpd restart</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://man.linuxde.net/at">at命令</a></li>
<li><a href="http://man.linuxde.net/crontab">crontab命令</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux为什么拥有w权限却不能删除文件</title>
    <url>/posts/Why_have_write_permission_but_can_not_delete_the_file.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Linux中万物皆文件, 目录是文件, 硬件是文件.<br>这里的文件和Windows的概念可完全不一样.<br>经常遇到的是, 对文件拥有w写权限, 可是却提示没有删除权限.</p>
<span id="more"></span>

<h1 id="初始化情景"><a href="#初始化情景" class="headerlink" title="初始化情景"></a>初始化情景</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[ahao@localhost ~]$ su -                    <span class="comment"># 切换为root用户</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">mkdir</span> testDir           <span class="comment"># 创建testDir目录</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">echo</span> 123 &gt; testDir/file <span class="comment"># 创建testDir目录下的file文件</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">chmod</span> 555 testDir/      <span class="comment"># 取消testDir目录的w写权限</span></span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">rm</span> testDir/file       <span class="comment"># 删除testDir目录下的file文件, 失败</span></span><br><span class="line"><span class="built_in">rm</span>: 无法删除<span class="string">&quot;testDir/file&quot;</span>: 权限不够</span><br></pre></td></tr></table></figure>

<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>先查看文件和文件夹的权限信息</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">dr-xr-xr-x. 2 ahao ahao 18 10月 31 23:30 testDir</span><br><span class="line">-rw-rw-r--. 1 ahao ahao  4 10月 31 23:30 file</span><br></pre></td></tr></table></figure>
<p><code>testDir目录文件</code>和<code>file文件</code>的拥有者和用户组毫无疑问是<code>ahao</code>.<br>那么对应的权限应该是<code>r-x</code>和<code>rw-</code>, 也就是<code>第2-4位</code>.</p>
<p>那么用户<code>ahao</code>对<code>file文件</code>是有<code>w</code>写权限的, 为什么不能删除呢?<br><strong>原因在于</strong><br>删除<code>file文件</code>, 是对<code>testDir目录文件</code>进行<code>w</code>写操作, 而不是对<code>file文件</code>进行<code>w</code>写操作.<br>对于<code>Windows</code>用户来说, 这是有点绕, 很难理解的.<br><img data-src="https://yuml.me/diagram/nofunky/class/[testDir%E7%9B%AE%E5%BD%95%E6%96%87%E4%BB%B6]-%3E[file%E6%96%87%E4%BB%B6],[file%E6%96%87%E4%BB%B6]-%3E[123%E5%AD%97%E7%AC%A6%E4%B8%B2]" alt="文件结构"><br><code>Linux</code>的<code>w</code>写权限的意思是, 允许对其<strong>子数据</strong>进行写入.<br><code>file文件</code>的w写权限是允许修改<code>123字符串</code>.<br><code>testDir目录文件</code>的<code>w</code>写权限是允许修改<code>file文件</code>.</p>
<p>从文件和文件夹的权限信息可以看出,<br><code>用户ahao</code>是没有<code>testDir目录文件</code>的<code>w</code>写权限的.<br>换句话说, 就是不能操作<code>testDir目录文件</code>下的<code>file文件</code>, 自然也就不能删除了。<br>但是, <code>用户ahao</code>有<code>file文件</code>的<code>w</code>写权限, 所以可以编辑<code>file文件</code>里的文本内容。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">dr-xr-xr-x. 2 ahao ahao 18 10月 31 23:30 testDir</span><br><span class="line">-rw-rw-r--. 1 ahao ahao 4 10月 31 23:30 file</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux之SSH协议</title>
    <url>/posts/Linux_SSH_protocol.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>SSH</code> 为 <code>Secure Shell</code> 的缩写。在使用远程工具连接 <code>Linux</code> 时使用的就是 <code>SSH协议</code>。<br><code>SSH协议</code> 使用的是非对称加密算法。<br>简单的说, 有一个管道, 用来传递数据, A和B在管道的两端, A和B各自拥有一把锁和一把钥匙。<br>B要传数据给A, 那么B先把自己的锁给A。<br>A用自己的A锁加上B锁给数据上锁, 这时候只有A的A钥匙和B的B钥匙能解开这个锁获取数据。<br>A和B使用不同的锁和钥匙, 这就是非对称加密。</p>
<span id="more"></span>

<h1 id="Linux下的SSH"><a href="#Linux下的SSH" class="headerlink" title="Linux下的SSH"></a>Linux下的SSH</h1><p>这里使用 <code>127.0.0.1</code> 回环地址进行测试。<br>除了远程操作之外, 还可以使用 <code>SSH</code> 进行文件的上传和下载。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[ahao@localhost ~]$ ssh username@IP             # 远程管理指定Linux服务器</span><br><span class="line">[ahao@localhost ~]$ ssh root@127.0.0.1           # 连接本机的root用户</span><br><span class="line">The authenticity of host &#x27;127.0.0.1 (127.0.0.1)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is 60:18:c3:85:f3:2e:f9:34:4d:2f:9a:0e:cf:e9:85:64.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes                  # 选择yes进行连接</span><br><span class="line">Warning: Permanently added &#x27;127.0.0.1&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">root@127.0.0.1&#x27;s password:                               # 输入密码</span><br><span class="line">Last login: Tue Oct 10 00:06:25 2017</span><br><span class="line">[root@localhost ~]# exit                                    # 退出</span><br><span class="line"></span><br><span class="line">[ahao@localhost ~]$ scp [-r] 用户名@IP:文件路径 本地路径       # 下载文件</span><br><span class="line">[ahao@localhost ~]$ scp [-r] 本地文件 用户名@IP:上传路径       # 上传文件</span><br></pre></td></tr></table></figure>

<h1 id="Windows下的SSH"><a href="#Windows下的SSH" class="headerlink" title="Windows下的SSH"></a>Windows下的SSH</h1><p>借助SSH工具<a href="https://www.netsarang.com/products/xsh_overview.html">xshell</a><br>使用 <code>ifconfig</code> 查看Linux的IP地址, 照着软件配置就好了, 百度很多使用教程。</p>
<h1 id="小知识"><a href="#小知识" class="headerlink" title="小知识"></a>小知识</h1><p>Linux的SSH公钥存储在 <code>~/.ssh/known_hosts</code>。<br>Windows的SSH公钥存储在 <code>%HOMEPATH%/.ssh/known_hosts</code>。</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux之awk流文本编辑器</title>
    <url>/posts/awk_of_Linux.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>awk</code>是<code>Unix</code>的行处理命令, 以<strong>行</strong>为单位, 依次读入文本的每行进行切片处理。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 复制测试文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /etc/passwd /tmp/passwd</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="使用格式"><a href="#使用格式" class="headerlink" title="使用格式"></a>使用格式</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk [option] &#x27;[BEGIN&#123;awk 操作命令&#125;]pattern&#123;awk 操作命令&#125;[END&#123;awk 操作命令&#125;]&#x27; file(s)</span><br></pre></td></tr></table></figure>
<p><code>BEGIN&#123;awk 操作命令&#125;</code>: 可选的, 前置操作, 在执行<code>pattern</code>循环之前执行。<br><code>END&#123;awk 操作命令&#125;</code>:   可选的, 后置操作, 在执行<code>pattern</code>循环之后执行。<br><code>pattern&#123;awk 操作命令&#125;</code>: 必选的, 对每行进行处理。<br><code>awk 操作命令</code>: 包括函数调用<code>printf()</code>, 控制指令<code>if else</code>等。</p>
<h1 id="切片处理"><a href="#切片处理" class="headerlink" title="切片处理"></a>切片处理</h1><p>所谓的<strong>切片处理</strong>, 举个例子就是<code>a:b:c</code>, 可以将<code>:</code>作为分隔符, 划分为<code>3</code>个片段。</p>
<p><code>-F separator</code>选项: 指定<code>separator</code>作为分隔符, 默认为空格<br><code>$n</code>变量: <code>$0</code>表示当前行的内容, <code>$n</code>表示当前行内, 以上面的<code>separator</code>分割的第<code>n</code>个片段<br><code>NR</code>变量: 每行的行号, <code>The total number of input records seen so far.</code><br><code>NF</code>变量: 分割的片段的数量, <code>The number of fields in the current input record.</code><br><code>FILENAME</code>变量: 正在处理的文件名</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 获取以 : 作为分隔符, 第3个片段, 即UID</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $3&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 2. 获取以 : 作为分隔符, 第1和3个片段, 即用户名和UID</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $1,$3&#125;&#x27;</span> /tmp/passwd</span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print $1&quot; &quot;$3&#125;&#x27;</span> /tmp/passwd</span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print &quot;USER:&quot;$1&quot;\tUID:&quot;$3&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 3. 输出每行的行号NR和片段数NF</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print NR&quot;\t&quot;NF&quot;\tUSER:&quot;$1&quot;\tUID:&quot;$3&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 4. 输出处理的文件名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print FILENAME&quot;\tUSER:&quot;$1&quot;\tUID:&quot;$3&#125;&#x27;</span> /tmp/passwd</span><br></pre></td></tr></table></figure>

<h1 id="pattern"><a href="#pattern" class="headerlink" title="pattern"></a>pattern</h1><p><code>pattern</code>是每行前的一个匹配表达式。分为两种。</p>
<ol>
<li><code>~</code>, <code>!~</code>: 匹配正则表达式</li>
<li><code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&gt;</code>: 判断逻辑表达式</li>
</ol>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 打印出匹配root的每行行号和内容</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;/root/&#123;print NR&quot;\t&quot;$0&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 2. 打印出UID为1开头的每行行号和UID和用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$3~/^1.*/&#123;print NR&quot;\t&quot;$3&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 3. 打印出UID不为1开头的每行行号和UID和用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$3!~/^1.*/&#123;print NR&quot;\t&quot;$3&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 打印出UID大于100的行号和UID和用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;if($3&gt;100) print NR&quot;\t&quot;$3&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$3&gt;100&#123;print NR&quot;\t&quot;$3&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 2. 打印出UID等于0的行号和UID和用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$3==0&#123;print NR&quot;\t&quot;$3&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br><span class="line"><span class="comment"># 3. 打印出UID不等于0的行号和UID和用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;$3!=0&#123;print NR&quot;\t&quot;$3&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br></pre></td></tr></table></figure>

<h1 id="函数调用"><a href="#函数调用" class="headerlink" title="函数调用"></a>函数调用</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 打印出行号和用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;print NR&quot;\t&quot;$1&#125;&#x27;</span> /tmp/passwd</span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;&#123;printf(&quot;%s\t%s\n&quot;, NR, $1)&#125;&#x27;</span> /tmp/passwd</span><br></pre></td></tr></table></figure>

<h1 id="逻辑计算"><a href="#逻辑计算" class="headerlink" title="逻辑计算"></a>逻辑计算</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">awk [option] &#x27;[BEGIN&#123;awk 操作命令&#125;]pattern&#123;awk 操作命令&#125;[END&#123;awk 操作命令&#125;]&#x27; file(s)</span><br></pre></td></tr></table></figure>
<p>这里的<code>BEGIN</code>和<code>END</code>可以进行一些初始化操作和结尾操作。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 统计 / 文件夹下所有文件的大小总和, BEGIN可以声明变量</span></span><br><span class="line">ll / | awk <span class="string">&#x27;BEGIN&#123;size=0&#125;&#123;size+=$5&#125;END&#123;print &quot;size:&quot;size/1024/1024&quot;M&quot;&#125;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 统计 /etc/passwd 下有多少个用户, 用正则表达式 ^$ 排除空行</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;BEGIN&#123;count=0&#125;$1!~/^$/&#123;count++&#125;END&#123;print &quot;count:&quot;count&#125;&#x27;</span> /etc/passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 打印出UID大于100的行号和用户名, 加上表头和表尾</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;BEGIN&#123;print &quot;NR\tUsername&quot;&#125;&#123;if($3&gt;100) print NR&quot;\t&quot;$1&#125;END&#123;print &quot;-------&quot;FILENAME&quot;-------&quot;&#125;&#x27;</span> /etc/passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 使用数组记录所有UID大于100的用户名</span></span><br><span class="line">awk -F <span class="string">&#x27;:&#x27;</span> <span class="string">&#x27;BEGIN&#123;count=0&#125;&#123;if($3&gt;100)name[count++]=$1&#125;END&#123;for(i=0;i&lt;count;i++) print i&quot;\t&quot;name[i]&#125;&#x27;</span> /etc/passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 分别统计LISTEN和CONNECTED的连接数量</span></span><br><span class="line">netstat -anp | awk <span class="string">&#x27;$6~/(LISTEN)|(CONNECTED)/&#123;sum[$6]++&#125;END&#123;for(i in sum) print i&quot; : &quot;sum[i]&#125;&#x27;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux之sed流文本编辑器</title>
    <url>/posts/sed_of_Linux.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>stream editor</code>是<code>Unix</code>的行处理命令, 以<strong>行</strong>为单位, 依次读入文本的每行进行处理。<br><code>sed</code><strong>一般</strong>不会对原文件进行操作, 当然, 有例外。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 复制测试文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cp /etc/passwd /tmp/passwd</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="打印内容"><a href="#打印内容" class="headerlink" title="打印内容"></a>打印内容</h1><p><code>p</code>参数: 前面接数字或正则表达式, 打印匹配内容<br><code>-n</code>参数: 不自动打印内容, 如果不和<code>p</code>一起使用, 则会输出两次相同内容<br><code>!</code>参数: 对之前的参数进行取反<br><code>a~b</code>参数: 从<code>a</code>行开始, 每隔<code>b</code>行执行操作</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 打印所有行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;p&#x27;</span></span><br><span class="line"><span class="comment"># 2. 打印所有行, 不使用 -n 会打印两次</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;p&#x27;</span></span><br><span class="line"><span class="comment"># 3. 打印第2行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;2p&#x27;</span></span><br><span class="line"><span class="comment"># 4. 打印匹配正则表达式为 root 的一行</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;/root/p&#x27;</span></span><br><span class="line"><span class="comment"># 5. 打印第2-10行的内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;2,10p&#x27;</span></span><br><span class="line"><span class="comment"># 6. 打印匹配正则表达式为 root 和 ahao 之间的行的内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;/root/,/ahao/p&#x27;</span></span><br><span class="line"><span class="comment"># 7. 打印除了第2-10行的所有行内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;2,10!p&#x27;</span></span><br><span class="line"><span class="comment"># 8. 打印第2行开始, 每3行的所有行内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed -n &#x27;2~3p&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="增删-不影响原文件"><a href="#增删-不影响原文件" class="headerlink" title="增删(不影响原文件)"></a>增删(不影响原文件)</h1><p><code>na string</code>参数: 表示在第<code>n</code>行后面追加(<code>append</code>)一行<code>string</code><br><code>ni string</code>参数: 表示在第<code>n</code>行前面插入(<code>insert</code>)一行<code>string</code><br><code>nd</code>参数: 将第<code>n</code>行或匹配正则表达式<code>n</code>的一行删除(<code>delete</code>)</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在第5行后面追加(append)一行内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;5a HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH&#x27;</span></span><br><span class="line"><span class="comment"># 2. 在第2-5行每行后面追加(append)一行内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;2,5a HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 在第5行前面插入(insert)一行内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;5i HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH&#x27;</span></span><br><span class="line"><span class="comment"># 4. 在第2-5行每行前面插入(insert)一行内容</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;2,5i HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 将第2-5行的内容删除(delete)</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;2,5d&#x27;</span></span><br><span class="line"><span class="comment"># 6. 将匹配正则表达式 root 的行内容删除(delete)</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;/root/d&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h1><p><code>nc string</code>参数: 将第<code>n</code>行替换(<code>replace</code>)为<code>string</code><br><code>s/regexp/replacement/</code>参数: 将每行第一个匹配<code>regexp</code>正则表达式的替换为<code>replacement</code><br><code>s/regexp/replacement/g</code>参数: 将每行所有匹配<code>regexp</code>正则表达式的替换为<code>replacement</code><br><code>s/regexp/str1 &amp; str2/g</code>参数: <code>&amp;</code>参数表示正则表达式匹配的值<br><code>s/regexp/\u&amp;/g</code>参数: <code>\u</code>首字母大写, <code>\U</code>所有字母大写<br><code>sed -i &quot;s/regexp/\u&amp;/g&quot;</code>: <code>\u</code>首字母大写, 回写到原文件<br><code>()</code>参数: 括号捕获多个值, 用<code>\1</code>、<code>\2</code>等表示捕获的第几个值</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 将第5行替换(replace)为指定字符串</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;5c HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH&#x27;</span></span><br><span class="line"><span class="comment"># 2. 将第2-5行替换(replace)为指定字符串</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;2,5c HHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHHH&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 将每行第1个匹配正则表达式 : 的内容替换为 %</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;s/:/%/&#x27;</span></span><br><span class="line"><span class="comment"># 4. 将每行所有匹配正则表达式 : 的内容替换为 %, g 全局替换</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;s/:/%/g&#x27;</span></span><br><span class="line"><span class="comment"># 5. 将每行所有匹配正则表达式 : 的内容替换为 %包裹的字符串, &amp;表示匹配的字符串</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;s/:/%&amp;%/g&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 将匹配到的单词首字母转为大写, \u转为大写</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;s/[a-z]*/\u&amp;/g&#x27;</span></span><br><span class="line"><span class="comment"># 7. 将匹配到的单词所有字母转为大写, \U转为大写</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;s/[a-z]*/\U&amp;/g&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 8. 使用()获取用户名, UID, GID, -r 不用加转义符</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /tmp/passwd | sed &#x27;s/^\([a-z_-]\+\):x:\([0-9]\+\):\([0-9]\+\):.*$/USER:\1  UID:\2  GID:\3/&#x27;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cat /tmp/passwd | sed -r &#x27;s/^([a-z_-]+):x:([0-9]+):([0-9]+):.*$/USER:\1  UID:\2  GID:\3/&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="退出"><a href="#退出" class="headerlink" title="退出"></a>退出</h1><p><code>q</code>参数: 退出<code>sed</code>命令</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 到第3行就退出(quit)sed</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;3q&#x27;</span></span><br><span class="line"><span class="comment"># 2. 找到匹配 root 正则就退出(quit)sed</span></span><br><span class="line">[root@localhost ~]<span class="comment"># nl /tmp/passwd | sed &#x27;/root/q&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="读写原文件-修改原文件"><a href="#读写原文件-修改原文件" class="headerlink" title="读写原文件(修改原文件)"></a>读写原文件(修改原文件)</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建一个文件</span></span><br><span class="line">[root@localhost ~]<span class="comment">#  echo -e &#x27;123\n456\n789&#x27; &gt; hello.txt</span></span><br><span class="line"><span class="comment"># 2. 将/tmp/passwd插入 读入(read)的hello.txt文件的第1行后面打印输出, 不修改hello.txt</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;1r /tmp/passwd&#x27; hello.txt</span></span><br><span class="line"><span class="comment"># 3. 将 hello.txt 写入(write)覆盖 /tmp/passwd, 修改/tmp/passwd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;w /tmp/passwd&#x27; </span></span><br><span class="line"><span class="comment"># 4. 将 hello.txt 的第2行写入(write)覆盖 /tmp/passwd</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sed &#x27;2w /tmp/passwd&#x27; hello.txt</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux之sudo权限</title>
    <url>/posts/sudo_permissions_of_Linux.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>sudo权限, 是可以临时把用户变成另一个用户(比如root)去执行某个命令。</p>
<span id="more"></span>

<h1 id="添加sudo权限"><a href="#添加sudo权限" class="headerlink" title="添加sudo权限"></a>添加sudo权限</h1><p>使用<code>visudo</code>命令。即可修改<code>/etc/sudoers</code>文件。<br>切换到最后一行。输入命令即可。<br>格式如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">用户名  允许sudo的远程ip=(可使用的身份) 授权命令(绝对路径)</span><br><span class="line">%组名   允许sudo的远程ip=(可使用的身份) 授权命令(绝对路径)</span><br></pre></td></tr></table></figure>

<p>比如<code>shutdown -r now</code>重启命令, 不能被普通用户执行。<br>现在要赋予<code>ahao</code>用户重启服务器的权限。<br>命令越详细, 权限越小。最好写绝对路劲。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ahao    ALL=(ALL)       /sbin/shutdown -r now</span><br></pre></td></tr></table></figure>
<p>这里的<code>ALL=(ALL)</code>的意思是</p>
<ol>
<li>左边的ALL, 表示被管理的主机的地址, 即是哪个<strong>远程主机</strong>或<strong>ip</strong>登录的这台服务器。</li>
<li>右边的ALL, 表示用户可使用的身份, <strong>省略的话会赋予root权限</strong>。</li>
</ol>
<p>下面是个简单的例子</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 临时切换为 root , 执行 visudo</span></span><br><span class="line">[ahao@localhost ~]$ su -c <span class="string">&quot;/usr/sbin/visudo&quot;</span> root</span><br><span class="line">    ahao    ALL=(ALL)       /sbin/shutdown -r now</span><br><span class="line"><span class="comment"># 2. 查看可用sudo命令</span></span><br><span class="line">[ahao@localhost ~]$ sudo -l </span><br><span class="line">用户 ahao 可以在该主机上运行以下命令：</span><br><span class="line">    (ALL) /sbin/shutdown -r now</span><br><span class="line"><span class="comment"># 3. 普通用户执行sudo赋予的命令</span></span><br><span class="line">[ahao@localhost ~]$ sudo /sbin/shutdown -r now </span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. root用户可以随意切换用户, 随意执行sudo命令</span></span><br><span class="line"><span class="comment"># 下面root以user1的身份创建/tmp/hello文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># sudo -u user1 touch /tmp/hello</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ls -l /tmp/hhh </span></span><br><span class="line">-rw-r--r-- 1 user1 user1 0 10-18 08:29 /tmp/hello</span><br></pre></td></tr></table></figure>

<h1 id="sudo支持正则、取反"><a href="#sudo支持正则、取反" class="headerlink" title="sudo支持正则、取反"></a>sudo支持正则、取反</h1><p>添加以下规则</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ahao    ALL=/usr/sbin/useradd # 赋予用户创建角色的权限</span><br><span class="line">ahao    ALL=/usr/bin/passwd   # 赋予用户修改密码的权限, 危险!!</span><br></pre></td></tr></table></figure>
<p>为<code>ahao</code>用户添加<strong>创建角色</strong>的权限, 还要添加<strong>修改密码</strong>的权限, 才能真正使用创建的用户。<br>但是如果使用上述规则, 则会允许<code>ahao</code>执行<code>/usr/bin/passwd root</code>修改<code>root</code>的密码, 这样很<strong>不安全</strong>。</p>
<p>修改为以下规则</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ahao    ALL=/usr/sbin/useradd</span><br><span class="line">ahao    ALL=/usr/bin/passwd [A-Za-z]*, !/usr/bin/passwd &quot;&quot;, !/usr/bin/passwd root</span><br><span class="line"># 使用正则表达式限定用户名为字母的用户, 使用 ! 取反, 不允许修改root的密码</span><br></pre></td></tr></table></figure>

<h1 id="sudo的别名"><a href="#sudo的别名" class="headerlink" title="sudo的别名"></a>sudo的别名</h1><p>调用<code>visudo</code>命令, 插入别名, 别名名称必须大写, 多个值用逗号分隔。</p>
<ul>
<li>用户别名: <code>User_Alias MYUSER = user1, user2, user3</code></li>
<li>主机别名: <code>Host_Alias MYHOST = 192.168.0.1, 192.168.0.2</code></li>
<li>命令别名: <code>Cmnd_Alias MYCMD = !/usr/bin/passwd, /usr/bin/passwd [A-Za-z]*, !/usr/bin/passwd root</code></li>
</ul>
<h1 id="警告"><a href="#警告" class="headerlink" title="警告"></a>警告</h1><p><code>sudo</code>很容易造成不安全的行为, 如同上面的修改密码的权限。<br>所以在使用的时候一定要注意安全问题。</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux以不同方式执行Shell导致的变量生命周期问题</title>
    <url>/posts/Linux_performs_variable_life_cycle_issues_caused_by_the_shell_in_different_ways.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在<code>Tomcat/bin/catalina.sh</code>中有一段代码如下</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 判断setenv.sh是否存在, 存在就执行</span></span><br><span class="line"><span class="keyword">if</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>/bin/setenv.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  . <span class="string">&quot;<span class="variable">$CATALINA_BASE</span>/bin/setenv.sh&quot;</span> <span class="comment"># 以点、空格、Shell的方式执行Shell</span></span><br><span class="line"><span class="keyword">elif</span> [ -r <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>/bin/setenv.sh&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  . <span class="string">&quot;<span class="variable">$CATALINA_HOME</span>/bin/setenv.sh&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="不同的执行shell方式"><a href="#不同的执行shell方式" class="headerlink" title="不同的执行shell方式"></a>不同的执行shell方式</h1><p>先添加一个<code>setenv.sh</code>文件</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> JAVA_HOME=/opt/jdk/jdk1.8.0_151</span><br><span class="line"><span class="built_in">export</span> JAVA_OPTS=-Xmx512m</span><br></pre></td></tr></table></figure>

<p>执行以下代码</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查找当前shell中的JAVA变量, 没找到</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># set | grep JAVA</span></span><br><span class="line"><span class="comment"># 1.1. 以开启子shell的方式执行setenv.sh</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># sh /opt/tomcat/tomcat-test/bin/setenv.sh </span></span><br><span class="line"><span class="comment"># 1.2. setenv.sh的变量生命周期在子shell中, 不影响当前shell, 所以没找到JAVA变量</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># set | grep JAVA</span></span><br><span class="line"><span class="comment"># 2.1. 在当前shell执行的方式, 点+空格+shell的格式执行</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># . /opt/tomcat/tomcat-test/bin/setenv.sh </span></span><br><span class="line"><span class="comment"># 2.2. 变量生命周期在当前shell, 找到了JAVA变量</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># set | grep JAVA</span></span><br><span class="line">JAVA_HOME=/opt/jdk/jdk1.8.0_151</span><br><span class="line">JAVA_OPTS=-Xmx512m</span><br><span class="line"><span class="comment"># 3.1. 退出shell重新打开shell, 清除之前的变量</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># exit</span></span><br><span class="line">[ahao@127.0.0.1 ~]$ su -</span><br><span class="line"><span class="comment"># 3.2. 确认JAVA变量已经清除</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># set | grep JAVA</span></span><br><span class="line"><span class="comment"># 3.3. 使用source在当前shell执行, 和方式2等价</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># source /opt/tomcat/tomcat-test/bin/setenv.sh </span></span><br><span class="line"><span class="comment"># 3.4. 变量生命周期在当前shell, 找到了JAVA变量</span></span><br><span class="line">[root@127.0.0.1 ~]<span class="comment"># set | grep JAVA</span></span><br><span class="line">JAVA_HOME=/opt/jdk/jdk1.8.0_151</span><br><span class="line">JAVA_OPTS=<span class="string">&#x27;-Xms2000m -Xmx2000m&#x27;</span></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ol>
<li>有三种执行shell脚本的语法, 实际上只有两种执行shell的方式, 一种在当前shell执行, 一种在子shell中执行。</li>
<li><code>. /opt/tomcat/tomcat-test/bin/setenv.sh</code>和<code>source /opt/tomcat/tomcat-test/bin/setenv.sh </code>等价。</li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>Shell</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux前后台程序管理</title>
    <url>/posts/Linux_front_end_program_management.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>比如我打开电脑登录了<code>administrator</code>用户, 打开<code>QQ</code>, 微信, 然后开始下载游戏, 看视频。<br>我在看视频, 那么这个视频就是在前台运行的, 而下载游戏, 我不需要看它是怎么下载的, 所以放到后台执行, 这个就是前后台的应用场景。</p>
<span id="more"></span>

<h1 id="相关命令"><a href="#相关命令" class="headerlink" title="相关命令"></a>相关命令</h1><ol>
<li><code>命令; Ctrl+z</code>: 执行命令后, 按住<code>Ctrl+z</code>,将命令切换到后台<strong>暂停</strong>。</li>
<li><code>命令 &gt; /tmp/log.txt 2&gt;&amp;1 &amp;</code>: 将命令放到后台执行, 注意要将输出信息重定向, 否则会污染前台操作</li>
<li><code>bg %jobNumber</code>: 将某个后台程序放到后台<strong>运行</strong>。</li>
<li><code>jobs -l</code>: 查看所有的后台程序, <code>-l</code>显示PID。</li>
<li><code>fg %jobNumber</code>: 将某个后台程序放到前台运行。</li>
<li><code>kill -9 %jobNumber</code>: 将某个后台程序<strong>强制</strong>结束运行。</li>
<li><code>kill -15 %jobNumber</code>: 将某个后台程序<strong>正常</strong>结束运行。</li>
<li><code>nohup 命令 &amp;</code>: 将某个后台程序放到系统后台运行, 注销登录不会终止程序。</li>
</ol>
<h1 id="jobs-l"><a href="#jobs-l" class="headerlink" title="jobs -l"></a>jobs -l</h1><p><code>$ jobs [-lrs]</code>可以查看所有的后台程序。<br>选项与参数：<br><code>-l</code>  ：除了列出 <code>job number</code> 与命令串之外，同时列出 <code>PID</code> 的号码；<br><code>-r</code>  ：仅列出正在背景 <code>run</code> 的工作；<br><code>-s</code>  ：仅列出正在背景当中暂停 (<code>stop</code>) 的工作。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">$ <span class="built_in">jobs</span> -l</span><br><span class="line">[1]- 10314 Stopped                 vim ~/.bashrc</span><br><span class="line">[2]+ 10833 Stopped                 find / -<span class="built_in">print</span></span><br></pre></td></tr></table></figure>
<p><code>[1]</code>和<code>[2]</code>表示的是<code>jobNumber</code>, 作为<code>fg</code>、<code>bg</code>、<code>kill</code>命令的参数。<br><code>+</code>表示最近一个暂停的程序, <code>-</code>表示倒数第二个暂停的任务, 其他的不显示<code>+</code>和<code>-</code>。</p>
<h1 id="样例"><a href="#样例" class="headerlink" title="样例"></a>样例</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. Ctrl+Z跳到后台暂停</span></span><br><span class="line">$ vim ~/test.txt</span><br><span class="line">123</span><br><span class="line"><span class="comment"># 按Ctrl+z</span></span><br><span class="line">[1]+  已停止               vim ~/test.tx<span class="comment"># 2. vim跳到前台执行</span></span><br><span class="line">$ <span class="built_in">fg</span> %1</span><br><span class="line"><span class="comment"># 3. 后台执行</span></span><br><span class="line">$ tar -zpcvf /tmp/etc.tar.gz /etc &gt; /tmp/log.txt 2&gt;&amp;1 &amp;</span><br><span class="line">[1] 5143</span><br><span class="line"><span class="comment"># 一段时间后, 执行完毕</span></span><br><span class="line">[1]+  完成                  tar -zpcvf /tmp/etc.tar.gz /etc &gt; /tmp/log.txt 2&gt;&amp;1</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux命令提示符</title>
    <url>/posts/Linux_command.html</url>
    <content><![CDATA[<h1 id="命令提示符"><a href="#命令提示符" class="headerlink" title="命令提示符"></a>命令提示符</h1><h2 id="用户及主机名-root-localhost"><a href="#用户及主机名-root-localhost" class="headerlink" title="用户及主机名:[root@localhost ~]"></a>用户及主机名:[root@localhost ~]</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]#</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<p><code>root</code>：当前登录用户<br><code>localhost</code>：主机名<br><code>~</code>：<code>/root</code><br><code>#</code>：超级用户<br><code>$</code>：普通用户</p>
<h2 id="查询目录中的内容：ls"><a href="#查询目录中的内容：ls" class="headerlink" title="查询目录中的内容：ls"></a>查询目录中的内容：ls</h2><p><code>list</code>的缩写</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ls -a    //显示全部文件，包括隐藏文件</span><br><span class="line">ls -d    //查看目录属性</span><br><span class="line">ls -l    //查询详细信息，ls -l可缩写为ll</span><br><span class="line">ls -h    //显示为人们容易看的格式</span><br><span class="line">ls -i    //显示inode，节点号</span><br></pre></td></tr></table></figure>

<h2 id="建立目录：mkdir"><a href="#建立目录：mkdir" class="headerlink" title="建立目录：mkdir"></a>建立目录：mkdir</h2><p><code>make directories</code>的缩写<br><code>-p</code>：递归创建</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir -p dir1/dir2    //创建dir1目录，并在dir之下创建dir2目录</span><br></pre></td></tr></table></figure>

<h2 id="切换目录：cd"><a href="#切换目录：cd" class="headerlink" title="切换目录：cd"></a>切换目录：cd</h2><p><code>change directory</code>的缩写<br>按两次<code>tab</code>可以补全命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cd ~   //进入当前用户的家目录</span><br><span class="line">cd      //进入当前用户的家目录</span><br><span class="line">cd -    //进入上次目录</span><br><span class="line">cd ..   //进入上一级目录(相对路径使用)</span><br><span class="line">cd .    //进入当前目录(相对路径使用)</span><br></pre></td></tr></table></figure>

<h2 id="查询所在目录位置：pwd"><a href="#查询所在目录位置：pwd" class="headerlink" title="查询所在目录位置：pwd"></a>查询所在目录位置：pwd</h2><p><code>print working directory</code>的缩写</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">pwd    //显示当前所在位置</span><br></pre></td></tr></table></figure>

<h2 id="删除文件或目录：rmdir和rm"><a href="#删除文件或目录：rmdir和rm" class="headerlink" title="删除文件或目录：rmdir和rm"></a>删除文件或目录：rmdir和rm</h2><p><code>rm</code>是<code>remove</code>的缩写，常用<br><code>rmdir</code>是<code>remove empty directories</code>的缩写，比rm更严格，只能删除空目录。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">rm -rf [文件]    //-r删除目录，-f强制删除</span><br></pre></td></tr></table></figure>

<h2 id="复制命令：cp"><a href="#复制命令：cp" class="headerlink" title="复制命令：cp"></a>复制命令：cp</h2><p><code>copy</code>的缩写</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cp -r [原文件][新文件]    //-r复制目录</span><br><span class="line">cp -p [原文件][新文件]    //-p连属性一起复制</span><br><span class="line">cp -d [原文件][新文件]    //-d若源文件是链接文件，则复制链接属性</span><br><span class="line">cp -a [原文件][新文件]    //-a上面三个一起选中，即-pdr</span><br></pre></td></tr></table></figure>

<h2 id="剪切或改名命令：mv"><a href="#剪切或改名命令：mv" class="headerlink" title="剪切或改名命令：mv"></a>剪切或改名命令：mv</h2><p><code>move</code>的缩写，在相同目录下为改名，不同目录为剪切</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mv [原文件名] [新文件名]</span><br></pre></td></tr></table></figure>

<h2 id="链接命令：ln"><a href="#链接命令：ln" class="headerlink" title="链接命令：ln"></a>链接命令：ln</h2><p><code>link</code>的缩写，生成链接文件<br>硬链接可以看成复制，拥有相同的i节点和存储<code>block</code>块，不能跨分区，不能针对目录使用。删除原文件对硬链接文件没影响。<br>软链接可以看成快捷方式，拥有自己的<code>i</code>节点和存储<code>block</code>块，<code>block</code>块中存储原文件的<code>i</code>节点和文件名删除原文件对软链接文件有影响。<br>软链接文件权限固定为<code>lrwxrwxrwx</code>，真实权限要看原文件，创建软链接文件要写绝对路径。</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">link -s [原文件][目标文件]    //-s创建软链接(soft)</span><br></pre></td></tr></table></figure>

<h2 id="搜索命令：locate，find，whereis，whoami，whatis，which，grep"><a href="#搜索命令：locate，find，whereis，whoami，whatis，which，grep" class="headerlink" title="搜索命令：locate，find，whereis，whoami，whatis，which，grep"></a>搜索命令：locate，find，whereis，whoami，whatis，which，grep</h2><p><code>locate</code>搜索速度快，在后台数据库<code>/var/lib/mlocate</code>中按文件名搜索，只能按照文件名搜索<br><code>find</code>进行精确查询，要模糊查询使用<code>*</code>通配符<br><code>whoami</code>搜索当前用户<br><code>whatis</code>搜索命令的作用<br><code>whereis</code>只能搜索系统命令的所在位置，搜索命令的所在位置和帮助文档<br><code>which</code>搜索命令所在位置和别名</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">locate[文件名]    //创建新文件后，必须要updatedb更新数据库，才能找到新文件</span><br><span class="line">find [位置] -name [文件名]</span><br><span class="line">find [位置] -iname [文件名]    //不区分大小写</span><br><span class="line">find [位置] -user [文件名]    //按照所有者搜索</span><br><span class="line">find [位置] -nouser [文件名]    //查找没有所有者的文件</span><br><span class="line">find [位置] -mtime +10    //查找10天前修改内容的文件，+10十天前，10十天当天，-10十天内</span><br><span class="line">find [位置] -ctime +10    //查找10天前修改属性的文件</span><br><span class="line">find [位置] -atime +10    //查找10天前访问过的文件</span><br><span class="line">find [位置] -size 25k    //查找大小为25KB的文件，+25大于25KB，25等于25KB，-25小于25KB，k小写，M大写</span><br><span class="line">find [位置] -size +25k -a -size -100k   //查找大于25k小于100k的文件，-a逻辑与，-o逻辑或</span><br><span class="line">find [位置] -size +25k -a -size -100k -exec [命令] &#123;&#125; \    //对满足条件的文件执行命令</span><br><span class="line">find [位置] -inum 123456    //查找i节点为123456的文件</span><br><span class="line">whoami</span><br><span class="line">whatis [命令]</span><br><span class="line">whereis -bm[命令]     -b只查找可执行文件，-m只查找帮助文档</span><br><span class="line">which [命令]</span><br><span class="line">grep -iv [字符串] [文件名]    //在文件当中匹配符合的字符串，匹配使用正则表达式，-i忽略大小写，-v排除指定字符串(取反)</span><br></pre></td></tr></table></figure>
<p>根据<code>/etc/updatedb.conf</code>配置文件进行搜索</p>
<table>
<thead>
<tr>
<th align="left">prune_bind_mounts=”yes”</th>
<th align="left">开启搜索限制</th>
</tr>
</thead>
<tbody><tr>
<td align="left">prunefs</td>
<td align="left">搜索时，不搜索的文件系统</td>
</tr>
<tr>
<td align="left">prunenames</td>
<td align="left">搜索时，不搜索的文件类型（后缀）</td>
</tr>
<tr>
<td align="left">prunepaths</td>
<td align="left">搜索时，不搜索的文件路径</td>
</tr>
</tbody></table>
<h2 id="帮助命令：man，help，info"><a href="#帮助命令：man，help，info" class="headerlink" title="帮助命令：man，help，info"></a>帮助命令：man，help，info</h2><p><code>manul</code>的缩写</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">man -f [命令]    //相当于whatis，查看命令的作用</span><br><span class="line">man -k [命令]    //相当于apropos，查看命令的所有帮助</span><br><span class="line">ls --help    //命令的帮助</span><br><span class="line">help [命令]    //help是专门获取shell内部命令的帮助命令</span><br><span class="line">info [命令]    //-回车进入子帮助页面，-u进入上层页面，-n进入下一个帮助小节，-p进入上一个帮助小节，-q退出</span><br></pre></td></tr></table></figure>

<h2 id="压缩命令：zip，unzip，gzip，gunzip，bzip2，bunzip2，tar"><a href="#压缩命令：zip，unzip，gzip，gunzip，bzip2，bunzip2，tar" class="headerlink" title="压缩命令：zip，unzip，gzip，gunzip，bzip2，bunzip2，tar"></a>压缩命令：zip，unzip，gzip，gunzip，bzip2，bunzip2，tar</h2><p>常见压缩格式：<code>.zip</code>，<code>.gz</code>，<code>.bz2</code>，<code>.tar.gz</code>，<code>.tar.bz2</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zip [压缩文件名] [原文件]    //-r压缩目录</span><br><span class="line">unzip [压缩文件]    //解压缩</span><br><span class="line"></span><br><span class="line">gzip [原文件]    //自动压缩生成源文件.gz，并且删除原文件</span><br><span class="line">gzip -r [原文件]    //-r压缩目录下的所有子文件，但不压缩目录</span><br><span class="line">gzip -c [原文件] &gt; [压缩文件]    //压缩文件，但不删除原文件</span><br><span class="line">gzip -d [压缩文件]    //解压缩</span><br><span class="line">gunzip [压缩文件]    //解压缩</span><br><span class="line"></span><br><span class="line">bzip2 -k [原文件]   //-k保留原文件，不能压缩目录</span><br><span class="line">bzip2 -d [压缩文件]   //-k保留压缩文件，解压缩</span><br><span class="line">bunzip2 [压缩文件]   //解压缩</span><br><span class="line"></span><br><span class="line">tar -cvf [压缩文件] [原文件]    //-c打包，-v显示过程，-f指定打包后的文件名，解决不能压缩目录的问题</span><br><span class="line">tar -xvf [压缩文件]     //-x解打包，-v显示过程，-f指定打包后的文件名</span><br><span class="line">tar -zcvf [压缩文件] [原文件1] [原文件2]    //-z压缩gz格式，可以压缩多个文件</span><br><span class="line">tar -jcvf [压缩文件]  [原文件1] [原文件2]    //-j压缩bz2格式，可以压缩多个文件</span><br><span class="line">tar -zxvf [压缩文件]     //-x解压缩</span><br><span class="line">tar -jxvf [压缩文件] -c [新文件名]     //-x解压缩，并重命名</span><br><span class="line">tar -ztvf [压缩文件] -c [新文件名]     //-t查看压缩内容，不解压</span><br></pre></td></tr></table></figure>

<h2 id="关机和重启命令：shutdown，halt，poweroff，init-0"><a href="#关机和重启命令：shutdown，halt，poweroff，init-0" class="headerlink" title="关机和重启命令：shutdown，halt，poweroff，init 0"></a>关机和重启命令：shutdown，halt，poweroff，init 0</h2><p><code>halt</code>，<code>poweroff</code>，<code>init 0</code>关机不安全，不能保存数据<br><code>reboot</code>，<code>init 6</code>重启不安全</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">shutdown -c    //-c取消前一个关机命令</span><br><span class="line">shutdown -h [时间]    </span><br><span class="line">shutdown -h now    //-h关机，现在关机</span><br><span class="line">shutdown -r 05:30 &amp;  //-r重启，&amp;放入后台，凌晨5点30分重启</span><br></pre></td></tr></table></figure>
<p><code>init</code>相关命令</p>
<img data-src="/images/%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6_01.png" class="">

<h2 id="退出登录命令：logout"><a href="#退出登录命令：logout" class="headerlink" title="退出登录命令：logout"></a>退出登录命令：logout</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">logout</span><br></pre></td></tr></table></figure>

<h2 id="挂载与卸载命令：mount，umount"><a href="#挂载与卸载命令：mount，umount" class="headerlink" title="挂载与卸载命令：mount，umount"></a>挂载与卸载命令：mount，umount</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mount    //查询挂载点</span><br><span class="line">mount -a    //根据/etc/fstab的内容，自动挂载</span><br><span class="line">mount -t [文件系统] -o [特殊选项] [设备文件名] [挂载点]    //进行挂载</span><br><span class="line"></span><br><span class="line">umount [设备文件名或挂载点]    //卸载命令</span><br></pre></td></tr></table></figure>
<p><code>-o</code>特殊选项</p>
<img data-src="/images/%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6_02.png" class="">

<h3 id="挂载光盘"><a href="#挂载光盘" class="headerlink" title="挂载光盘"></a>挂载光盘</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">mkdir /mnt/cdrom    //先建立挂载点</span><br><span class="line">mount -t iso9660 /dev/sr0 /mnt/cdrom    //然后进行挂载</span><br></pre></td></tr></table></figure>
<h3 id="挂载U盘"><a href="#挂载U盘" class="headerlink" title="挂载U盘"></a>挂载U盘</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">fdisk -l    //查看U盘设备名</span><br><span class="line">mkdir /mnt/usb    //先建立挂载点</span><br><span class="line">mount -t vfat /dev/sdb1 /mnt/usb    //进行挂载</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux常见目录作用</title>
    <url>/posts/Linux_base_directory.html</url>
    <content><![CDATA[<h1 id="常见目录作用"><a href="#常见目录作用" class="headerlink" title="常见目录作用"></a>常见目录作用</h1><h2 id="命令目录-bin，-sbin，-usr-bin，-usr-sbin"><a href="#命令目录-bin，-sbin，-usr-bin，-usr-sbin" class="headerlink" title="命令目录/bin，/sbin，/usr/bin，/usr/sbin"></a>命令目录/bin，/sbin，/usr/bin，/usr/sbin</h2><p>用来保存系统命令<br><code>bin</code>中的命令普通用户就可以执行<br><code>sbin</code>中的命令只有root用户才可以执行</p>
<span id="more"></span>

<h2 id="启动目录-boot"><a href="#启动目录-boot" class="headerlink" title="启动目录/boot"></a>启动目录/boot</h2><p><code>/boot</code> 存放内核以及启动所需的文件等<br>保存用户的启动数据，不能写满</p>
<h2 id="设备文件保存目录-dev"><a href="#设备文件保存目录-dev" class="headerlink" title="设备文件保存目录/dev"></a>设备文件保存目录/dev</h2><p>存放硬件文件</p>
<h2 id="配置文件目录-etc"><a href="#配置文件目录-etc" class="headerlink" title="配置文件目录/etc"></a>配置文件目录/etc</h2><p>保存系统配置文件</p>
<h2 id="普通用户家目录-home"><a href="#普通用户家目录-home" class="headerlink" title="普通用户家目录/home"></a>普通用户家目录/home</h2><h2 id="root用户家目录-root"><a href="#root用户家目录-root" class="headerlink" title="root用户家目录/root"></a>root用户家目录/root</h2><h2 id="系统函数库保存目录-lib"><a href="#系统函数库保存目录-lib" class="headerlink" title="系统函数库保存目录/lib"></a>系统函数库保存目录/lib</h2><h2 id="外接存储目录-misc，-media，-mnt"><a href="#外接存储目录-misc，-media，-mnt" class="headerlink" title="外接存储目录/misc，/media，/mnt"></a>外接存储目录/misc，/media，/mnt</h2><p><code>/misc</code> 挂载外接磁带机<br><code>/media</code> 挂载光盘<br><code>/mnt</code> 挂载U盘等移动硬盘</p>
<h2 id="内存目录-proc，-sys"><a href="#内存目录-proc，-sys" class="headerlink" title="内存目录/proc，/sys"></a>内存目录/proc，/sys</h2><p>不能直接操作，保存内存的挂载点（内存的盘符）</p>
<h2 id="临时目录-tmp"><a href="#临时目录-tmp" class="headerlink" title="临时目录/tmp"></a>临时目录/tmp</h2><p>存放临时数据</p>
<h2 id="保存系统相关文档目录-var"><a href="#保存系统相关文档目录-var" class="headerlink" title="保存系统相关文档目录/var"></a>保存系统相关文档目录/var</h2>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux打包压缩tar常用命令</title>
    <url>/posts/Linux_package_compression_common_tar_commands.html</url>
    <content><![CDATA[<h1 id="打包存在的意义"><a href="#打包存在的意义" class="headerlink" title="打包存在的意义"></a>打包存在的意义</h1><p>打包是把多个文件变成一个文件。<br>压缩是把一个大文件变成小文件。<br>那么要把多个文件压缩成小文件, 就只能曲线救国, 先把多个文件打包成一个文件, 然后再对这个文件进行压缩。</p>
<span id="more"></span>

<h1 id="常用命令"><a href="#常用命令" class="headerlink" title="常用命令"></a>常用命令</h1><h2 id="tar"><a href="#tar" class="headerlink" title=".tar"></a>.tar</h2><p>解包：<code>tar xvf FileName.tar</code><br>打包：<code>tar cvf FileName.tar DirName</code></p>
<h2 id="gz"><a href="#gz" class="headerlink" title=".gz"></a>.gz</h2><p>解压1：<code>gunzip FileName.gz</code><br>解压2：<code>gzip -d FileName.gz</code><br>压缩：<code>gzip FileName</code></p>
<h2 id="tar-gz-和-tgz"><a href="#tar-gz-和-tgz" class="headerlink" title=".tar.gz 和 .tgz"></a>.tar.gz 和 .tgz</h2><p>解压：<code>tar zxvf FileName.tar.gz</code><br>压缩：<code>tar zcvf FileName.tar.gz DirName</code></p>
<h2 id="bz2"><a href="#bz2" class="headerlink" title=".bz2"></a>.bz2</h2><p>解压1：<code>bzip2 -d FileName.bz2</code><br>解压2：<code>bunzip2 FileName.bz2</code><br>压缩： <code>bzip2 -z FileName</code></p>
<h2 id="tar-bz2"><a href="#tar-bz2" class="headerlink" title=".tar.bz2"></a>.tar.bz2</h2><p>解压：<code>tar jxvf FileName.tar.bz2</code><br>压缩：<code>tar jcvf FileName.tar.bz2 DirName</code></p>
<h2 id="Z"><a href="#Z" class="headerlink" title=".Z"></a>.Z</h2><p>安装：<code>yum install -y ncompress</code><br>解压：<code>uncompress FileName.Z</code><br>压缩：<code>compress FileName</code></p>
<h2 id="tar-Z"><a href="#tar-Z" class="headerlink" title=".tar.Z"></a>.tar.Z</h2><p>安装：<code>yum install -y ncompress</code><br>解压：<code>tar Zxvf FileName.tar.Z</code><br>压缩：<code>tar Zcvf FileName.tar.Z DirName</code></p>
<h2 id="zip"><a href="#zip" class="headerlink" title=".zip"></a>.zip</h2><p>安装：<code>yum install -y zip</code><br>解压：<code>unzip FileName.zip</code><br>压缩：<code>zip FileName.zip DirName</code></p>
<h2 id="rar"><a href="#rar" class="headerlink" title=".rar"></a>.rar</h2><p>解压：<code>rar x FileName.rar</code><br>压缩：<code>rar a FileName.rar DirName</code></p>
<h2 id="rpm"><a href="#rpm" class="headerlink" title=".rpm"></a>.rpm</h2><p>解包：<code>rpm2cpio FileName.rpm | cpio -div</code></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.cnblogs.com/eoiioe/archive/2008/09/20/1294681.html">linux下解压命令大全</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux文件权限</title>
    <url>/posts/Linux_File_Permissions.html</url>
    <content><![CDATA[<h1 id="查看文件权限"><a href="#查看文件权限" class="headerlink" title="查看文件权限"></a>查看文件权限</h1><p>在Linux使用 <code>ll -ah</code> 可以看到以下命令。<br>文件权限就存储在 <code>drwxr-xr-x</code> 这十个字符之中。</p>
<span id="more"></span>

<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">drwx------ 21 ahao ahao 4.0K 09-22 04:06 .</span><br><span class="line">drwxr-xr-x  4 root root 4.0K 09-21 19:26 ..</span><br><span class="line">-rw-------  1 ahao ahao 2.0K 09-22 02:59 .bash_history</span><br><span class="line">-rw-r--r--  1 ahao ahao   33 2009-01-22 .bash_logout</span><br><span class="line">-rw-r--r--  1 ahao ahao  176 2009-01-22 .bash_profile</span><br><span class="line">-rw-r--r--  1 ahao ahao  124 2009-01-22 .bashrc</span><br><span class="line">drwx------  2 ahao ahao 4.0K 09-21 19:29 .chewing</span><br><span class="line">drwxr-xr-x  2 ahao ahao 4.0K 09-21 19:42 Desktop</span><br></pre></td></tr></table></figure>

<h1 id="权限分析"><a href="#权限分析" class="headerlink" title="权限分析"></a>权限分析</h1><p>Linux的文件权限分为<code>用户权限user</code> 、 <code>用户所在群组权限group</code> 、 <code>其他用户权限other</code>。<br>分别对应各个权限对这个文件的权限。<br>权限也分为 <code>读r</code> 、<code>写w</code> 、 <code>执行x</code> 三种。<br>所以<code>3*3=9</code>, 对应 <code>drwxr-xr-x</code> 后面九个字符。<br>最前面的字符, 则对应着文件的类型, <code>Linux</code>不是以文件后缀名来确定文件类型的。</p>
<ol>
<li>第1位是文件类型</li>
</ol>
<table>
<thead>
<tr>
<th align="center">文件类型</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">d</td>
<td align="center">Directory、目录、文件夹</td>
</tr>
<tr>
<td align="center">-</td>
<td align="center">普通文件</td>
</tr>
<tr>
<td align="center">l</td>
<td align="center">软链接文件, Link快捷方式</td>
</tr>
<tr>
<td align="center">b</td>
<td align="center">区块(block)文件, 储存数据, 以提供系统随机存取的接口设备</td>
</tr>
<tr>
<td align="center">c</td>
<td align="center">字符(character)设备文件, 一些串行端口的接口设备, 例如键盘、鼠标(一次性读取装置)</td>
</tr>
<tr>
<td align="center">s</td>
<td align="center">数据接口文件(sockets), 通常被用在网络上的数据传输</td>
</tr>
<tr>
<td align="center">f</td>
<td align="center">数据输送文件(FIFO, pipe), 解决多个程序同时存取一个文件所造成的错误问题</td>
</tr>
</tbody></table>
<ol start="2">
<li>后面九个字符, 三个为一组, 分别是 <code>用户权限user</code> 、 <code>用户所在群组权限group</code> 、 <code>其他用户权限other</code>。每一组有三个权限 <code>读r</code> 、<code>写w</code> 、 <code>执行x</code>, 如果没有权限, 则用 <code>-</code> 代替。</li>
</ol>
<p>比如 <code>drwxr-xr-x</code><br>说明这是一个目录, 文件所有者有读、写、执行的权限。<br>文件拥有者所在的群组有读、执行权限, 没有写的权限。<br>不在文件拥有者所在群组的用户具有读、执行权限, 没有写的权限。</p>
<h1 id="普通权限"><a href="#普通权限" class="headerlink" title="普通权限"></a>普通权限</h1><h2 id="修改群组和拥有者"><a href="#修改群组和拥有者" class="headerlink" title="修改群组和拥有者"></a>修改群组和拥有者</h2><ul>
<li>修改群组change group, <code>chgrp [选项] 群组名 文件名</code>, 群组必须在 <code>/etc/group</code> 中存在。 使用 <code>-R</code> 可以递归recursive修改。</li>
<li>修改拥有者change owner, <code>chown [选项] 用户名 文件名</code>, 用户必须在 <code>/etc/passwd</code> 中存在。 使用 <code>-R</code> 可以递归recursive修改。</li>
</ul>
<h2 id="修改文件权限-数字形式"><a href="#修改文件权限-数字形式" class="headerlink" title="修改文件权限(数字形式)"></a>修改文件权限(数字形式)</h2><p>经常可以看到 <code>chmod [选项] 770 文件名</code>这种形式。 使用 <code>-R</code> 可以递归recursive修改。<br><code>Linux</code>将读、写、执行的权限赋予了权值。<code>读4</code> 、 <code>写2</code> 、 <code>执行1</code>。<br>为什么这样赋值, 这和二进制有关。<code>1</code>为<code>001</code>, <code>2</code>为<code>010</code>, <code>4</code>为<code>100</code>。组合后不会产生冲突。<br>比如说<code>drwxr-xr-x</code></p>
<ol>
<li> <code>rwx</code> , 读写执行, <code>r+w+x=4+2+1=7</code></li>
<li><code>r-x</code> , 读执行, <code>r+x=4+1=5</code></li>
</ol>
<p>所以修改权限的命令为 <code>chmod 755 文件名</code>。</p>
<h2 id="修改文件权限-字符形式"><a href="#修改文件权限-字符形式" class="headerlink" title="修改文件权限(字符形式)"></a>修改文件权限(字符形式)</h2><p>有人说算术记不住, Linux还提供了字符的形式赋予权限。<br>范围有 <code>用户u</code>、<code>用户所在群组g</code>、<code>其他用户o</code>、<code>以上三个a</code>。<br>权限有 <code>读r</code> 、<code>写w</code> 、 <code>执行x</code>。<br>操作运算符有 <code>新增+</code>、<code>移除-</code> 、 <code>赋予=</code>。<br>比如，要设定 <code>drwx------</code> 为 <code>dr-xr-xr-x</code>。<br>则使用<code> chomd u-w,g+rx,o=rx 文件名</code></p>
<h1 id="默认权限"><a href="#默认权限" class="headerlink" title="默认权限"></a>默认权限</h1><p>使用<code>umask</code>命令查看或修改默认权限掩码。默认权限掩码影响创建文件时赋予的默认权限。<br><code>umask</code>命令是临时修改重启失效, 永久修改在<code>/etc/profile</code>文件中修改。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[ahao@localhost ~]$ <span class="built_in">umask</span> </span><br><span class="line">0002</span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">touch</span> file1</span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">mkdir</span> <span class="built_in">dir</span></span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">umask</span> 0022 &amp;&amp; <span class="built_in">touch</span> file2</span><br><span class="line">[ahao@localhost tmp]$ ll</span><br><span class="line">总用量 2</span><br><span class="line">drwxrwxr-x. 2 ahao ahao   6 11月  4 16:17 <span class="built_in">dir</span></span><br><span class="line">-rw-rw-r--. 1 ahao ahao   0 11月  4 16:16 file1</span><br><span class="line">-rw-r--r--. 1 ahao ahao   0 11月  4 16:16 file2</span><br></pre></td></tr></table></figure>
<p>这里的<code>0002</code>的第一位代表特殊权限(稍后介绍), 后三位代表读写执行的权限掩码。<br>先看后<code>3</code>位。</p>
<ol>
<li>文件默认权限最大为<code>666</code>, 也就是<code>rw-rw-rw-</code>, 不能被执行。出于安全性考虑。</li>
<li>目录默认权限最大为<code>777</code>, 也就是<code>rwxrwxrwx</code>, 可以被执行, 也就是进入目录。</li>
<li><code>umask</code>权限用来和最大权限换算成字母后进行相减运算, <code>-</code>位不允许再减。</li>
</ol>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">比如文件默认最大权限为666, umask为022</span><br><span class="line">换算成字母, 666(rw-rw-rw-) 减去 022(----w--w-) 得到默认权限 644(rw-r--r--)</span><br><span class="line"></span><br><span class="line">比如文件默认最大权限为666, umask为033</span><br><span class="line">换算成字母, 666(rw-rw-rw-) 减去 033(---wx-wx-) 得到默认权限 644(rw-r--r--)</span><br></pre></td></tr></table></figure>
<p>所以可以看到上面的运算, 不能简单的使用数字运算, 需要转为字母进行运算, 或者进行二进制的不借位减法。</p>
<h1 id="特殊权限-不安全"><a href="#特殊权限-不安全" class="headerlink" title="特殊权限(不安全)"></a>特殊权限(不安全)</h1><p><strong>特殊权限尽量少修改! 不安全!</strong><br>给执行该文件的用户临时赋予另一个用户(组)的权限, 比如<code>root</code>权限。<br>特殊权限也有<code>421</code>的值, <code>4</code>为<code>SUID</code>, <code>2</code>为<code>SGID</code>, <code>1</code>为<code>SBIT</code>。</p>
<h2 id="SUID-SET-USER-ID"><a href="#SUID-SET-USER-ID" class="headerlink" title="SUID(SET USER ID)"></a>SUID(SET USER ID)</h2><ol>
<li><code>SUID</code>权限仅对二进制程序有效</li>
<li>执行者对于该程序需要具有<code>x</code>的可执行权限</li>
<li>本权限仅在执行该程序的过程中有效</li>
<li>执行者将具有该程序<strong>所有者</strong>的权限</li>
</ol>
<p>比如<strong>设置密码</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[ahao@localhost tmp]$ ll /etc/shadow /usr/bin/passwd </span><br><span class="line">----------. 1 root root  1232 10月  6 05:47 /etc/shadow</span><br><span class="line">-rwsr-xr-x. 1 root root 27832 6月  10 2014 /usr/bin/passwd</span><br></pre></td></tr></table></figure>
<p><code>/etc/shadow</code>文件只能被<code>root</code>用户修改。<br>但是执行<code>passwd</code>二进制文件的普通用户, 可以临时变成<code>passwd</code>拥有者<code>root</code>, 来修改<code>/etc/shadow</code>文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建两个文件</span></span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">touch</span> file1 file2</span><br><span class="line">[ahao@localhost tmp]$ ll</span><br><span class="line">总用量 0</span><br><span class="line">-rw-rw-r--. 1 ahao ahao 0 11月 21 21:13 file1</span><br><span class="line">-rw-rw-r--. 1 ahao ahao 0 11月 21 21:13 file2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建脚本打印文件, 添加SUID权限, 或者chmod u+s  file</span></span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">chmod</span> 4755 file1 </span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">chmod</span> 4655 file2</span><br><span class="line">[ahao@localhost tmp]$ ll</span><br><span class="line">总用量 0</span><br><span class="line">-rwsr-xr-x. 1 root root 0 11月  6 23:53 file1</span><br><span class="line">-rwSr-xr-x. 1 root root 0 11月  6 23:54 file2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 取消SUID权限, 或者chmod u-s  file</span></span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">chmod</span> 0755 file1</span><br><span class="line">[ahao@localhost tmp]$ <span class="built_in">chmod</span> 0655 file2</span><br></pre></td></tr></table></figure>
<p>可以看到<code>x</code>执行权限的位置被<code>s</code>替换了。<br><code>4755</code>和<code>4655</code>的区别在于文件本身有没有<code>x</code>执行权限。<br>并且可以得知<code>s=S+x</code>。大写<code>S</code>是没有意义的。<br>只有小写<code>s</code>才能正确设定<code>SUID</code>权限。</p>
<h2 id="SGID-SET-GROUP-ID"><a href="#SGID-SET-GROUP-ID" class="headerlink" title="SGID(SET GROUP ID)"></a>SGID(SET GROUP ID)</h2><p>和<code>SUID</code>一样, 区别在于用户会临时赋予文件所属用户组<code>group</code>的身份, 而不是用户<code>user</code>身份。</p>
<ol>
<li><code>SGID</code>对二进制程序有用</li>
<li>程序执行者对该程序需具备<code>x</code>权限</li>
<li>执行者在执行过程中会获得该程序<strong>用户组</strong>的支持</li>
</ol>
<p>比如<strong>locate命令</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># ll /usr/bin/locate /var/lib/mlocate/mlocate.db </span></span><br><span class="line">-rwx--s--x. 1 root slocate   40512 11月  5 2016 /usr/bin/locate</span><br><span class="line">-rw-r-----. 1 root slocate 3678432 11月 21 23:21 /var/lib/mlocate/mlocate.db</span><br></pre></td></tr></table></figure>
<p><code>/var/lib/mlocate/mlocate.db</code>文件只能被<code>slocate</code>组查看。<br>但是借助<code>locate</code>命令, 普通用户可以临时变成<code>slocate</code>**(<code>s</code>在group权限的范围)**来查看<code>/var/lib/mlocate/mlocate.db </code>文件。</p>
<p>除了和<code>SUID</code>差不多的功能外。<br><code>SGID</code>对目录还有另一个功能。<br>就是<strong>进入该目录后</strong>, 用户的用户组会变成<strong>SGID对应的用户组</strong>。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. root用户创建test目录并赋予777权限</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir ~ahao/test</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 777 ~ahao/test</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll -d ~ahao/test</span></span><br><span class="line">drwxrwxrwx. 2 root root 6 11月 21 23:39 /home/ahao/test</span><br><span class="line">[root@localhost ~]<span class="comment"># exit</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ahao用户在test目录下创建file1</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">touch</span> ~ahao/test/file1</span><br><span class="line">[ahao@localhost ~]$ ll ~ahao/test/file1</span><br><span class="line">总用量 0</span><br><span class="line">-rw-rw-r--. 1 ahao ahao 0 11月 21 23:43 file1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. root用户为test目录赋予SGID权限</span></span><br><span class="line">[ahao@localhost <span class="built_in">test</span>]$ su -c <span class="string">&quot;chmod 2777 ~ahao/test&quot;</span> root</span><br><span class="line">[ahao@localhost <span class="built_in">test</span>]$ ll -d ~ahao/test/</span><br><span class="line">drwxrwsrwx. 2 root root 19 11月 21 23:43 /home/ahao/test/</span><br><span class="line">      ^</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. ahao用户在赋予SGID的test目录下创建file2</span></span><br><span class="line">[ahao@localhost <span class="built_in">test</span>]$ <span class="built_in">touch</span> file2</span><br><span class="line">[ahao@localhost <span class="built_in">test</span>]$ ll</span><br><span class="line">总用量 0</span><br><span class="line">-rw-rw-r--. 1 ahao ahao 0 11月 21 23:43 file1</span><br><span class="line">-rw-rw-r--. 1 ahao root 0 11月 21 23:45 file2</span><br></pre></td></tr></table></figure>
<p>可以看到赋予<code>SGID</code>后, <code>ahao</code>用户创建的<code>file2</code>的所属组是<code>root</code>。</p>
<h2 id="SBIT-sticky-bit"><a href="#SBIT-sticky-bit" class="headerlink" title="SBIT(sticky bit)"></a>SBIT(sticky bit)</h2><p>除了<code>user</code>的<code>SUID</code>、<code>group</code>的<code>SGID</code>外, 还有<code>other</code>的<code>sticky bit</code>。</p>
<p><code>sticky bit</code>有两个要求</p>
<ol>
<li>只对目录有效。</li>
<li>文件权限为<code>rwxrwxrwx</code>, 也就是<code>777</code>的权限。<br>比如<code>/tmp</code>目录。</li>
</ol>
<p>那么任何用户都能对目录下的文件进行读写执行操作, 这是很不安全的。<br>比如一个目录, 允许用户(<code>other</code>)创建文件(写权限), 拥有了写权限的用户也同样拥有了删除权限。<br>也就是说在<code>777</code>权限的目录下, A用户创建的文件可能被B用户删除。<br><code>sticky bit</code>就是为了解决这个问题。<br>赋予目录<code>sticky bit</code>后。</p>
<ol>
<li>只有<code>root</code>有删除权限。</li>
<li>其他用户只能删除自己创建的文件。</li>
<li>其他用户拥有写权限。</li>
</ol>
<p>下面举个例子</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. root用户创建test目录并赋予777权限</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir ~ahao/test</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 777 ~ahao/test/</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll -d ~ahao/test/</span></span><br><span class="line">drwxrwxrwx. 2 root root 6 11月 22 23:23 /home/ahao/test/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. root用户创建file文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo &quot;hello&quot; &gt; ~ahao/test/file</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll ~ahao/test/</span></span><br><span class="line">总用量 4</span><br><span class="line">-rw-r--r--. 1 root root 6 11月 22 23:26 file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ahao用户删除file文件成功, 因为ahao用户对test目录有w写权限</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">rm</span> -rf ~ahao/test/file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. root用户对test目录赋予sticky bit权限</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 0777 ~ahao/test/ # 取消sticky bit, 或chmod o-t ~ahao/test/</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 1777 ~ahao/test/ # 赋予sticky bit, 或chmod o+t ~ahao/test/</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll -d ~ahao/test/</span></span><br><span class="line">drwxrwxrwt. 2 root root 6 11月 22 23:27 /home/ahao/test/</span><br><span class="line">         ^</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. root用户创建file文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo &quot;hello&quot; &gt; ~ahao/test/file</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll ~ahao/test/</span></span><br><span class="line">总用量 4</span><br><span class="line">-rw-r--r--. 1 root root 6 11月 22 23:32 file</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. ahao用户删除file文件失败, 即使ahao用户对test目录有w写权限</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">rm</span> -rf ~ahao/test/file</span><br><span class="line"><span class="built_in">rm</span>: 无法删除<span class="string">&quot;/home/ahao/test/file&quot;</span>: 不允许的操作</span><br></pre></td></tr></table></figure>

<h2 id="检查系统新增的SUID和SGID文件"><a href="#检查系统新增的SUID和SGID文件" class="headerlink" title="检查系统新增的SUID和SGID文件"></a>检查系统新增的SUID和SGID文件</h2><p>特殊权限太危险了, 当有人使用特殊权限, 需要及时的发现。<br>将以下脚本加入定时任务中, 即可及时发现新增的特殊权限文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 先查找所有拥有SUID(4)和SGID(2)的文件</span></span><br><span class="line">find / -perm -4000 -o -perm -2000 &gt; /tmp/suid.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 编写Shell脚本</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 2.1 查找所有拥有SUID(4)或SGID(2)的文件, 并保存到临时文件suid.check中</span></span><br><span class="line">find / -perm -4000 -o -perm -2000 &gt; /tmp/suid.check</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> $(<span class="built_in">cat</span> /tmp/suid.check)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 2.3 遍历临时文件suid.check中的记录, 和最初查找到的文件/tmp/suid.list进行比较。</span></span><br><span class="line">    grep <span class="variable">$line</span> /tmp/suid.list &gt; /dev/null</span><br><span class="line">    <span class="comment"># 2.4 不存在则写入log文件中</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;$?&quot;</span> != <span class="string">&quot;0&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$i</span> isn&#x27;t in listfile! &quot;</span> &gt;&gt; /tmp/suid_log_$(<span class="built_in">date</span> +%F)</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">rm</span> -rf /tmp/suid.check</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/tmp/suid_log_<span class="subst">$(date +%F)</span>&quot;</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/suid_log_$(<span class="built_in">date</span> +%F)</span><br></pre></td></tr></table></figure>

<h1 id="隐藏权限-chattr"><a href="#隐藏权限-chattr" class="headerlink" title="隐藏权限 chattr"></a>隐藏权限 chattr</h1><p><code>SBIT</code>只是防止删除的情况。<br>但是不排除被篡改文件的情况出现。</p>
<p>如果用户对文件有<code>w</code>写权限, 即使加了<code>SBIT</code>权限, 用户依然可以把文件内容清空, 虽然没删除, 但也和删除的情况差不多了。</p>
<p>如果对<strong>文件</strong>设置<code>i</code>属性, 那么不允许对文件进行删除、改名, 也不能添加和删除数据;<br>如果对<strong>目录</strong>设置<code>i</code>属性, 那么只能修改目录下文件的数据, 但不允许建立和删除文件。</p>
<p>如果对<strong>文件</strong>设置<code>a</code>属性, 那么只能在文件中增加数据, 但是不能删除也不能修改数据;<br>如果对<strong>目录</strong>设置<code>a</code>属性, 那么只允许目录中建立和修改文件, 但是不允许删除。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建隐藏权限文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># touch ~ahao/test/file1</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chattr +i ~ahao/test/file1 </span></span><br><span class="line">[root@localhost ~]<span class="comment"># lsattr ~ahao/test/file1 </span></span><br><span class="line">----i----------- /home/ahao/test/file1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. root也不能修改文件</span></span><br><span class="line">[root@localhost ~]<span class="comment"># echo &quot;hello&quot; &gt;&gt; ~ahao/test/file1 </span></span><br><span class="line">-bash: /home/ahao/test/file1: 权限不够</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 去掉隐藏权限</span></span><br><span class="line">[root@localhost ~]<span class="comment"># chattr -i ~ahao/test/file1 </span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://cn.linux.vbird.org/linux_basic/0210filepermission_2.php">鸟哥的Linux私房菜 - 第六章、Linux 的文件权限与目录配置</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux权限管理之ACL权限</title>
    <url>/posts/ACL_permissions_for_Linux_rights_management.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>ACL权限 Access Control List<br>适用于当一个用户不满足所有者<code>owner</code>, 所属组<code>group</code>, 其他人<code>other</code>的情况。<br>比如一个家庭账本权限为<code>-rwxrwx---</code>, 所有者<code>owner</code>是我, 所属组<code>group</code>是直系亲属, 其他人<code>other</code>是陌生人。<br>现在三姑六婆想阅读这个家庭账本, 要求权限为<code>r--</code>, 不满足拥有者(我), 所属组(直系亲属), 其他人(陌生人), 这时候就是使用ACL权限的时候。</p>
<span id="more"></span>

<h1 id="开启ACL权限"><a href="#开启ACL权限" class="headerlink" title="开启ACL权限"></a>开启ACL权限</h1><p>执行以下<code>shell</code>脚本, 查看是否已经开启了<code>ACL</code>权限。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">[[ <span class="variable">$UID</span> != <span class="string">&quot;0&quot;</span> ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;you must be root&quot;</span> &amp;&amp; <span class="built_in">exit</span> 1;</span><br><span class="line"></span><br><span class="line">filesystem=$(mount | grep <span class="string">&quot; / &quot;</span> | <span class="built_in">cut</span> -d <span class="string">&quot; &quot;</span> -f 5)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$&#123;filesystem&#125;</span> == <span class="string">&quot;ext3&quot;</span> ]];<span class="keyword">then</span></span><br><span class="line">    /sbin/dumpe2fs -h /dev/sda2 | grep <span class="string">&quot;acl&quot;</span></span><br><span class="line">    [[ $? == <span class="string">&quot;0&quot;</span> ]] &amp;&amp; <span class="built_in">echo</span> <span class="string">&quot;enabled acl&quot;</span> || <span class="built_in">echo</span> <span class="string">&quot;disabled acl&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>

<p>一般默认开启, 如果没有开启, 进行以下配置即可</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 临时配置, 重新挂载/根目录, 加入ACL权限</span></span><br><span class="line">[ahao@localhost ~]$ mount -o remount,acl /</span><br><span class="line"><span class="comment"># 2. 永久配置, 写入/etc/fstab文件, 重启生效</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/fstab </span></span><br><span class="line">LABEL=/                 /                       ext3    defaults,acl        1 1</span><br></pre></td></tr></table></figure>

<h1 id="查看和设置文件ACL权限"><a href="#查看和设置文件ACL权限" class="headerlink" title="查看和设置文件ACL权限"></a>查看和设置文件ACL权限</h1><p>设置ACL权限用<code>setfacl -m [u|g]:[用户名|组名]:权限 文件名</code>命令。<br>查看ACL权限用<code>getfacl 文件名</code></p>
<table>
<thead>
<tr>
<th align="center">选项</th>
<th align="center">说明</th>
<th align="center">使用</th>
</tr>
</thead>
<tbody><tr>
<td align="center">m</td>
<td align="center">设置ACL权限</td>
<td align="center">setfacl -m [u&#124;g]:[用户名&#124;组名]:权限 文件名</td>
</tr>
<tr>
<td align="center">x</td>
<td align="center">删除指定ACL权限</td>
<td align="center">setfacl -x [u&#124;g]:[用户名&#124;组名] 文件名</td>
</tr>
<tr>
<td align="center">b</td>
<td align="center">删除全部ACL权限</td>
<td align="center">setfacl -b 文件名</td>
</tr>
<tr>
<td align="center">d</td>
<td align="center">设定默认ACL权限(子文件继承目录ACL权限)</td>
<td align="center">setfacl -m d:[u&#124;g]:[用户名&#124;组名]:权限 文件名</td>
</tr>
<tr>
<td align="center">k</td>
<td align="center">删除默认ACL权限(子文件继承目录ACL权限)</td>
<td align="center">setfacl -m</td>
</tr>
<tr>
<td align="center">R</td>
<td align="center">递归设置ACL权限(容易给文件x权限)</td>
<td align="center">setfacl -m [u&#124;g]:[用户名&#124;组名]:权限 -R 目录名</td>
</tr>
</tbody></table>
<p>这是一个例子。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建权限为drwxrwx---, 用户和用户组为root的dir目录</span></span><br><span class="line">[root@localhost ~]<span class="comment"># mkdir ~ahao/dir </span></span><br><span class="line">[root@localhost ~]<span class="comment"># chmod 770 ~ahao/dir</span></span><br><span class="line">[root@localhost ~]<span class="comment"># ll ~ahao</span></span><br><span class="line">总用量 0</span><br><span class="line">drwxrwx---. 2 root root 6 11月  4 22:32 <span class="built_in">dir</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 操作1: ahao用户尝试进入dir目录失败, 权限不足</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">cd</span> <span class="built_in">dir</span></span><br><span class="line">-bash: <span class="built_in">cd</span>: <span class="built_in">dir</span>: 权限不够</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. root用户设置ACL权限, 给ahao用户赋予rx权限</span></span><br><span class="line">[root@localhost ~]<span class="comment"># setfacl -m u:ahao:rx ~ahao/dir</span></span><br><span class="line">[ahao@localhost ~]$ ll</span><br><span class="line">总用量 0</span><br><span class="line">drwxrwx---+ 2 root root 6 11月  4 22:32 <span class="built_in">dir</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 操作2: ahao用户尝试进入dir目录成功, dir的+权限位代表ACL权限</span></span><br><span class="line">[ahao@localhost ~]$ <span class="built_in">cd</span> <span class="built_in">dir</span></span><br><span class="line">[ahao@localhost <span class="built_in">dir</span>]$ <span class="comment"># 成功进入dir目录 </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 操作3: 查看ACL权限</span></span><br><span class="line">[ahao@localhost <span class="built_in">dir</span>]$ getfacl ~ahao/dir/ </span><br><span class="line">getfacl: Removing leading <span class="string">&#x27;/&#x27;</span> from absolute path names</span><br><span class="line"><span class="comment"># file: home/ahao/dir/</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rwx</span><br><span class="line">user:ahao:r-x <span class="comment"># ACL权限</span></span><br><span class="line">group::rwx</span><br><span class="line">mask::rwx</span><br><span class="line">other::---</span><br></pre></td></tr></table></figure>

<h1 id="mask掩码"><a href="#mask掩码" class="headerlink" title="mask掩码"></a>mask掩码</h1><p>上面的例子在使用<code>getfacl dir</code>之后, 可以看到有一项是<code>mask</code>。<br>这个和默认权限<code>umask</code>差不多, 也是一个权限掩码, 表示所能赋予的权限最大值。<br>这里的<code>mask</code>和<code>ACL权限</code>进行<code>&amp;与</code>运算, 得到的才是真正的<code>ACL权限</code>。<br>用人话讲, 就是</p>
<blockquote>
<p>你考一百分是因为实力只有一百分<br>我考一百分是因为总分只有一百分</p>
</blockquote>
<p><code>mask</code>限制了权限的最高值。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 修改ACL权限mask为r-x</span></span><br><span class="line">[root@localhost ~]<span class="comment"># setfacl -m m:rx ~ahao/tmp/av </span></span><br><span class="line">[root@localhost ~]<span class="comment"># getfacl ~ahao/tmp/av</span></span><br><span class="line">getfacl: Removing leading <span class="string">&#x27;/&#x27;</span> from absolute path names</span><br><span class="line"><span class="comment"># file: home/ahao/tmp/av</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rwx</span><br><span class="line">group::r-x</span><br><span class="line">mask::r-x <span class="comment"># 修改ACL权限mask为r-x</span></span><br><span class="line">other::---</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 为用户ahao添加ACL权限rwx</span></span><br><span class="line">[root@localhost ~]<span class="comment"># setfacl -m u:ahao:rwx ~ahao/tmp/av/ </span></span><br><span class="line">[root@localhost ~]<span class="comment"># getfacl ~ahao/tmp/av</span></span><br><span class="line">getfacl: Removing leading <span class="string">&#x27;/&#x27;</span> from absolute path names</span><br><span class="line"><span class="comment"># file: home/ahao/tmp/av</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rwx</span><br><span class="line">user:ahao:rwx</span><br><span class="line">group::r-x</span><br><span class="line">mask::rwx <span class="comment"># 注意, 这里的mask掩码会改变, 因为赋予的ACL权限大于mask</span></span><br><span class="line">other::---</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 修改ACL权限mask为r-x</span></span><br><span class="line">[root@localhost ~]<span class="comment"># setfacl -m m:rx ~ahao/tmp/av</span></span><br><span class="line">[root@localhost ~]<span class="comment"># getfacl ~ahao/tmp/av</span></span><br><span class="line">getfacl: Removing leading <span class="string">&#x27;/&#x27;</span> from absolute path names</span><br><span class="line"><span class="comment"># file: home/ahao/tmp/av</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rwx</span><br><span class="line">user:ahao:rwx      <span class="comment">#effective:r-x # 这里会提示真实的ACL权限为r-x</span></span><br><span class="line">group::r-x</span><br><span class="line">mask::r-x <span class="comment"># 这里mask不会再改变</span></span><br><span class="line">other::---</span><br></pre></td></tr></table></figure>

<ol>
<li><code>mask</code> 会限制 <code>ACL</code> 权限的最大值。</li>
<li>赋予<code>ACL</code> 权限大于 <code>mask</code> 的时候, 会将 <code>mask</code> <strong>撑大</strong>。</li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux用户管理之配置文件</title>
    <url>/posts/configuration_file_of_user_management.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Linux 用户管理涉及到几个文件</p>
<ol>
<li><code>/etc/passwd</code> 存储用户账号信息</li>
<li><code>/etc/shadow</code> 存储用户密码信息</li>
<li><code>/etc/group</code>存储用户组信息</li>
<li><code>/etc/gshadow</code>存储用户组管理员密码信息</li>
</ol>
<span id="more"></span>

<h1 id="文件结构"><a href="#文件结构" class="headerlink" title="文件结构"></a>文件结构</h1><h2 id="etc-passwd文件结构"><a href="#etc-passwd文件结构" class="headerlink" title="/etc/passwd文件结构"></a>/etc/passwd文件结构</h2><p><code>/etc/passwd</code>是存储账号的文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/passwd | grep -E &quot;ahao|root&quot;</span></span><br><span class="line">ahao:x:500:500:ahao:/home/ahao:/bin/bash</span><br><span class="line">root:x:0:0:root:/root:/bin/bash</span><br></pre></td></tr></table></figure>
<p>以冒号分割, 分为7个部分。</p>
<ol>
<li>ahao: 用户名。</li>
<li>x: 以前存储密码的字段, 现在改为<code>/etc/shadow</code>文件。</li>
<li>500: 第一个500是<code>uid</code>用户id。</li>
<li>500: 第二个500是<code>gid</code>群组id, 在<code>/etc/group</code>文件中。</li>
<li>ahao: 这个是用户信息说明栏, 用来解释这个账号的意义。</li>
<li>/home/ahao: 家目录</li>
<li>/bin/bash: 默认使用<code>Bash</code></li>
</ol>
<p>用户uid的编码规则</p>
<table>
<thead>
<tr>
<th align="center">id 范围</th>
<th align="center">该 ID 使用者特性</th>
</tr>
</thead>
<tbody><tr>
<td align="center">0</td>
<td align="center">root用户, 系统管理员</td>
</tr>
<tr>
<td align="center">1~99</td>
<td align="center">系统id, 由 distributions 自行创建的系统账号, 启动系统服务使用该账号</td>
</tr>
<tr>
<td align="center">100~499</td>
<td align="center">系统id, 若用户有系统账号需求时, 可以使用的账号UID, 启动系统服务使用该账号</td>
</tr>
<tr>
<td align="center">500~65535</td>
<td align="center">可登陆账号, 一般用户使用</td>
</tr>
</tbody></table>
<h2 id="etc-shadow-文件结构"><a href="#etc-shadow-文件结构" class="headerlink" title="/etc/shadow 文件结构"></a>/etc/shadow 文件结构</h2><p><code>/etc/shadow</code>是存储密码的文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/shadow | grep -E &quot;ahao|root&quot;</span></span><br><span class="line">ahao:$1$eoG3CKlq<span class="variable">$D8deyAR</span>.qvEws9kA5pFLd1:17431:0:99999:7:::</span><br><span class="line">root:$1<span class="variable">$zQeO</span>.jbw<span class="variable">$ZyXVaa7yPIb2K</span>/3BopdSa.:17431:0:99999:7:::</span><br></pre></td></tr></table></figure>
<p>以冒号分割, 分为8个部分。</p>
<ol>
<li>ahao: 用户名</li>
<li><code>$1$eoG3CKlq$D8deyAR.qvEws9kA5pFLd1</code>: 加密后的密码</li>
<li>17431: 最近改密码的日期距离1970年1月1日的天数。</li>
<li>0: 只有0天后密码才能再次修改。</li>
<li>99999: 必须在99999天后修改密码, 否则账号标记为过期。</li>
<li>7: 警告该账号, 还有7天不修改密码的话, 账号就会过期。</li>
<li>null: 在账号标识为过期后, 还有null天宽限期可以登录该账号, 登录后会强制让用户修改密码。</li>
<li>null: 1970年1月1日的null天后账号失效, 和过期不同。</li>
<li>null: 保留字段, 暂时没用。</li>
</ol>
<h2 id="etc-group文件结构"><a href="#etc-group文件结构" class="headerlink" title="/etc/group文件结构"></a>/etc/group文件结构</h2><p><code>/etc/group</code>是存储用户组的文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/group | grep -E &quot;ahao|root&quot;</span></span><br><span class="line">root:x:0:root</span><br><span class="line">ahao:x:500:</span><br></pre></td></tr></table></figure>
<ol>
<li>ahao: 用户组名, 在不指定用户组的情况下，创建用户并指定密码后会默认创建同名用户组。</li>
<li>x: 用户组密码, 改存储到<code>/etc/gshadow</code>文件。</li>
<li>500: 用户组ID, 对应<code>/etc/passwd</code>第四个字段。</li>
<li>null: 用户组支持的账号, 一个账号可以有多个用户组, 比如<code>ahao</code>用户要加入<code>root</code>用户组, 则编辑为<code>root:x:0:root,ahao</code>即可。</li>
</ol>
<h2 id="etc-gshadow文件结构"><a href="#etc-gshadow文件结构" class="headerlink" title="/etc/gshadow文件结构"></a>/etc/gshadow文件结构</h2><p><code>/etc/gshadow</code>是存储用户组密码的文件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># cat /etc/gshadow | grep -E &quot;ahao|root&quot;</span></span><br><span class="line">root:::root</span><br><span class="line">ahao:!!::</span><br></pre></td></tr></table></figure>
<ol>
<li>ahao: 用户组名, 在不指定用户组的情况下，创建用户并指定密码后会默认创建同名用户组。</li>
<li>!!: 用户组密码。**!**表示没有密码, 即没有用户组管理员。</li>
<li>null: 用户组管理员的账号。</li>
<li>null: 用户组的下属账号</li>
</ol>
<h1 id="命令操作"><a href="#命令操作" class="headerlink" title="命令操作"></a>命令操作</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># useradd user1 # 新增用户user1</span></span><br><span class="line">[root@localhost ~]<span class="comment"># passwd user1  # 设置user1的密码, 创建用户后必须设置密码才能登录。 </span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># usermod -L user1  # 锁定user1的用户(仅改 /etc/shadow的密码部分)</span></span><br><span class="line">[root@localhost ~]<span class="comment"># usermod -U user1  # 解锁user1的用户(仅改 /etc/shadow的密码部分)</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># userdel -r user1 # 删除用户, -r连同家目录</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># groupadd -r oldGroup1 # 新增用户组oldGroup1, -r创建系统用户组, 即GID&lt;500</span></span><br><span class="line">[root@localhost ~]<span class="comment"># groupmod -g 201 -n group1 oldGroup1 # 修改用户组oldGroup1的GID为201, 修改组名为group1</span></span><br><span class="line">[root@localhost ~]<span class="comment"># gpasswd group1 # 设置用户组group1的群组管理员密码</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># gpasswd -A user1 group1 # 设置用户user1为用户组group1的管理员</span></span><br><span class="line">[user1@localhost ~]$ gpasswd -a user2 group1 <span class="comment"># 群组管理员user1将用户user2加入用户组group1</span></span><br><span class="line">[user1@localhost ~]$ gpasswd -d user2 group1 <span class="comment"># 群组管理员user1将用户user2移出用户组group1</span></span><br><span class="line">[root@localhost ~]<span class="comment"># gpasswd -M user2 group1 # 用户root将用户user2加入用户组group1</span></span><br><span class="line"></span><br><span class="line">[root@localhost ~]<span class="comment"># groupdel group1 # 删除用户组group1</span></span><br></pre></td></tr></table></figure>
<p>不指定其他选项的情况下, <code>useradd</code>和<code>passwd</code>命令默认完成以下步骤, 默认配置文件在<code>/etc/default/useradd</code>中。</p>
<ol>
<li><code>/etc/passwd</code>新增一行用户信息, 包括创建UID/GID/家目录等。</li>
<li><code>/etc/shadow</code>新增一行密码信息。</li>
<li><code>/etc/group</code> 新增一个和用户名同名的用户组。</li>
</ol>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux的资源限制ulimit命令</title>
    <url>/posts/ulimit_Command_of_Linux.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>ulimit</code>是一个<code>Linux</code>命令, 用于限制<code>shell</code>进程及其子进程的系统资源使用。通俗且不严谨的讲，就是限制登录用户能一次性打开多少个进程，多少个文件等等。</p>
<blockquote>
<p>假设有这样一种情况，当一台 Linux 主机上同时登陆了 10 个人，在系统资源无限制的情况下，这 10 个用户同时打开了 500 个文档，而假设每个文档的大小有 10M，这时系统的内存资源就会受到巨大的挑战。</p>
</blockquote>
<span id="more"></span>

<h1 id="参数说明"><a href="#参数说明" class="headerlink" title="参数说明"></a>参数说明</h1><p><code>ulimit</code>限制分为<code>soft</code>软上限和<code>hard</code>硬上限, 使用<code>ulimit</code>命令默认修改<code>soft</code>软上限。</p>
<ul>
<li><code>soft</code>软上限: 任何进程都可以修改软上限，但是软上限不能超过硬上限</li>
<li><code>hard</code>硬上限: 普通进程可以降低硬上限，只有<code>root</code>可以提高硬上限</li>
</ul>
<p>命令格式: <code>ulimit [options] [limit]</code></p>
<table>
<thead>
<tr>
<th align="center"><code>options</code>参数</th>
<th align="center">含义</th>
<th align="center">例子</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>-H</code></td>
<td align="center">设置硬资源限制, 一旦设置不能增加。</td>
<td align="center"><code>ulimit -Hs 64</code> 限制硬资源, 线程栈大小为 64K。</td>
</tr>
<tr>
<td align="center"><code>-S</code></td>
<td align="center">设置软资源限制, 设置后可以增加, 但是不能超过硬资源设置。</td>
<td align="center"><code>ulimit -Sn 32</code> 限制软资源, 32 个文件描述符。</td>
</tr>
<tr>
<td align="center"><code>-a</code></td>
<td align="center">显示当前所有的 limit 信息, 默认显示软上限。</td>
<td align="center"><code>ulimit -a</code> 显示当前所有的 limit 信息。</td>
</tr>
<tr>
<td align="center"><code>-c</code></td>
<td align="center">最大的 core 文件的大小, 以 blocks 为单位。</td>
<td align="center"><code>ulimit -c unlimited</code>  对生成的 core 文件的大小不进行限制。</td>
</tr>
<tr>
<td align="center"><code>-d</code></td>
<td align="center">进程最大的数据段的大小, 以 Kbytes 为单位。</td>
<td align="center"><code>ulimit -d unlimited</code> 对进程的数据段大小不进行限制。</td>
</tr>
<tr>
<td align="center"><code>-f</code></td>
<td align="center">进程可以创建文件的最大值, 以 blocks 为单位。</td>
<td align="center"><code>ulimit -f 2048</code> 限制进程可以创建的最大文件大小为 2048 blocks。</td>
</tr>
<tr>
<td align="center"><code>-l</code></td>
<td align="center">最大可加锁内存大小, 以 Kbytes 为单位。</td>
<td align="center"><code>ulimit -l 32</code> 限制最大可加锁内存大小为 32 Kbytes。</td>
</tr>
<tr>
<td align="center"><code>-m</code></td>
<td align="center">最大内存大小, 以 Kbytes 为单位。</td>
<td align="center"><code>ulimit -m unlimited</code> 对最大内存不进行限制。</td>
</tr>
<tr>
<td align="center"><code>-n</code></td>
<td align="center">可以打开最大文件描述符的数量。</td>
<td align="center"><code>ulimit -n 128</code> 限制最大可以使用 128 个文件描述符。</td>
</tr>
<tr>
<td align="center"><code>-p</code></td>
<td align="center">管道缓冲区的大小, 以 Kbytes 为单位。</td>
<td align="center"><code>ulimit -p 512</code> 限制管道缓冲区的大小为 512 Kbytes。</td>
</tr>
<tr>
<td align="center"><code>-s</code></td>
<td align="center">线程栈大小, 以 Kbytes 为单位。</td>
<td align="center"><code>ulimit -s 512</code> 限制线程栈的大小为 512 Kbytes。</td>
</tr>
<tr>
<td align="center"><code>-t</code></td>
<td align="center">最大的 CPU 占用时间, 以秒为单位。</td>
<td align="center"><code>ulimit -t unlimited</code> 对最大的 CPU 占用时间不进行限制。</td>
</tr>
<tr>
<td align="center"><code>-u</code></td>
<td align="center">用户最大可用的进程数。</td>
<td align="center"><code>ulimit -u 64</code> 限制用户最多可以使用 64 个进程。</td>
</tr>
<tr>
<td align="center"><code>-v</code></td>
<td align="center">进程最大可用的虚拟内存, 以 Kbytes 为单位。</td>
<td align="center"><code>ulimit -v 200000</code> 限制最大可用的虚拟内存为 200000 Kbytes。</td>
</tr>
</tbody></table>
<h1 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h1><p><strong>对登录用户进行限制</strong></p>
<ol>
<li>在<code>/etc/profile</code>、<code>/etc/bashrc</code>、<code>~/.bash_profile</code>、<code>~/.bashrc</code>文件中写入<code>ulimit</code>命令。</li>
<li>直接在控制台输入<code>ulimit</code>命令, 这是临时配置, 重启失效。</li>
</ol>
<p><strong>对应用程序进行限制</strong></p>
<ol>
<li>对<code>Tomcat</code>进行限制, 编写启动脚本<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ulimit</span> -s 512;</span><br><span class="line">startup.sh</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>对多个用户或用户组进行限制</strong></p>
<ol>
<li>在<code>/etc/security/limits.conf</code>中输入<code>&lt;domain&gt; &lt;type&gt; &lt;item&gt; &lt;value&gt;</code>, 每一行一个限制。<blockquote>
<p>domain 表示用户或者组的名字，还可以使用 * 作为通配符。Type 可以有两个值，soft 和 hard。Item 则表示需要限定的资源，可以有很多候选值，如 stack，cpu，nofile 等等，分别表示最大的堆栈大小，占用的 cpu 时间，以及打开的文件数。通过添加对应的一行描述，则可以产生相应的限制</p>
</blockquote>
</li>
</ol>
<p><strong>对系统全局的进程进行限制</strong></p>
<ol>
<li>修改<code>/proc</code>下的文件</li>
</ol>
<h1 id="常用例子"><a href="#常用例子" class="headerlink" title="常用例子"></a>常用例子</h1><ol>
<li><code>ulimit -a</code>: 查看当前 <code>shell</code> 的所有资源限制，默认显示软限制</li>
<li><code>ulimit -Sa</code>: 查看当前 <code>shell</code> 的所有资源限制，<code>-S</code> 表示显示软限制</li>
<li><code>ulimit -Ha</code>: 查看当前 <code>shell</code> 的所有资源限制，<code>-H</code> 表示显示硬限制</li>
<li><code>ulimit -n</code>: 显示当前可打开的文件描述符数量，软限制</li>
<li><code>ulimit -Hn</code>: 显示当前可打开的文件描述符数量，硬限制</li>
<li><code>ulimit -n 10240</code>: 修改可打开的文件描述符数为 <code>10240</code>，默认软限制，除非指明参数 <code>H</code></li>
<li><code>ulimit -Hn 51200</code>: 修改可打开的文件描述符数为 <code>51200</code>，硬限制(如果是提高硬限制，则需要 <code>root</code> 权限)</li>
<li><code>ulimit -s 102400</code>: 修改堆栈大小的软限制为 <code>102400 kbytes</code> 即 <code>100 MB</code></li>
<li><code>ulimit -Hs unlimited</code>: 修改堆栈大小的硬限制为 <code>unlimited</code>，即不限制上限</li>
</ol>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-ulimit/index.html">通过 ulimit 改善系统性能</a></li>
<li><a href="https://www.zfl9.com/ulimit.html">Linux ulimit详解</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux软件安装之RPM包详解</title>
    <url>/posts/RPM_package_installation_of_Linux_software.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>RPM</code>包管理员是在Linux下广泛使用的软件包管理器。</p>
<span id="more"></span>

<h1 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h1><p><code>RPM</code>包一般在系统光盘里就有。不同系统的<code>RPM</code>包在不同的路径下。<br><code>CentOS5</code>在<code>CentOS</code>目录下。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 先装入系统安装光盘, 切换到 root 用户</span></span><br><span class="line">[ahao@locathost /]$ su -</span><br><span class="line"><span class="comment"># 2. 挂载光盘到 /mnt/cdrom 目录, 目录需要手动创建</span></span><br><span class="line">[root@locathost /]<span class="comment"># mount -t auto /dev/cdrom /mnt/cdrom</span></span><br><span class="line"><span class="comment"># 3. 查看 RPM 包目录, 不同光盘的 RPM 包目录不同</span></span><br><span class="line">[root@locathost /]<span class="comment"># ll /mnt/cdrom/CentOS</span></span><br><span class="line"><span class="comment"># 4. 在用完之后记得卸载光盘</span></span><br><span class="line">[root@locathost /]<span class="comment"># umount /mnt/cdrom</span></span><br></pre></td></tr></table></figure>

<h1 id="RPM包命名规则"><a href="#RPM包命名规则" class="headerlink" title="RPM包命名规则"></a>RPM包命名规则</h1><p>这里以<code>Apache</code>的<code>httpd</code>包为例</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># ll /mnt/cdrom/CentOS | grep &#x27;httpd&#x27;</span></span><br><span class="line">-rw-r--r-- 2 root root  1280858 2009-03-17 httpd-2.2.3-22.el5.centos.x86_64.rpm</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">httpd</th>
<th align="center">2.2.3</th>
<th align="center">22</th>
<th align="center">el5.centos</th>
<th align="center">x86_64</th>
<th align="center">rpm</th>
</tr>
</thead>
<tbody><tr>
<td align="center">软件包名</td>
<td align="center">软件版本</td>
<td align="center">软件发布次数</td>
<td align="center">适合的Linux平台</td>
<td align="center">适合的硬件平台</td>
<td align="center">rpm包扩展名</td>
</tr>
</tbody></table>
<h1 id="RPM查询"><a href="#RPM查询" class="headerlink" title="RPM查询"></a>RPM查询</h1><p>包和包之间可能存在依赖关系, 比如<strong>软件<code>A</code><strong>需要调用</strong>软件<code>B</code></strong>, 那么安装<strong>软件<code>A</code><strong>之前就必须安装</strong>软件<code>B</code></strong>, 否则可能会出现找不到<strong>软件<code>B</code><strong>的某个</strong>函数</strong>的问题。<br>这叫做<strong>树形依赖</strong>, 其他还有其他依赖。</p>
<ol>
<li>树形依赖: a -&gt; b -&gt; c, 安装c需要先安装b, 安装b需要先安装a, 卸载的时候要先卸载a, 再卸载b, 最后卸载c</li>
<li>环形依赖: a -&gt; b -&gt; c -&gt; a, 用一条命令同时安装, <code>rpm -ivh a b c</code></li>
<li>模块依赖: 依赖另一个包的某个so库文件模块, 查询模块对应的软件: <a href="www.rpmfind.net">www.rpmfind.net</a></li>
</ol>
<p>以<code>httpd</code>包为例, 已安装的软件包在<code>/var/lib/rpm/</code>数据库中, 只用输入包名即可。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装httpd软件包, -i 安装, -v 显示详细信息, -h 显示进度, </span></span><br><span class="line"><span class="comment">#    会发现安装失败, 需要解决依赖性问题, 将依赖的包依次安装即可</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -ivh /mnt/cdrom/CentOS/httpd-2.2.3-22.el5.centos.x86_64.rpm </span></span><br><span class="line"><span class="comment"># 2. 查询所有已安装的RPM包, -q 查询, -a 查询所有</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -qa</span></span><br><span class="line"><span class="comment"># 3. 查询包信息, -i 包信息, -p 未安装的包</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -qi httpd</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -qip /mnt/cdrom/CentOS/httpd-2.2.3-22.el5.centos.x86_64.rpm </span></span><br><span class="line"><span class="comment"># 4. 查询包所有文件安装位置</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -ql httpd</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -qlp /mnt/cdrom/CentOS/httpd-2.2.3-22.el5.centos.x86_64.rpm</span></span><br><span class="line"><span class="comment"># 5. 查询文件名属于哪个包</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -qf /etc/httpd/</span></span><br><span class="line">httpd-2.2.3-22.el5.centos</span><br><span class="line"><span class="comment"># 6. 升级httpd包, 除非是重大安全漏洞, 避免升级</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -U httpd</span></span><br><span class="line"><span class="comment"># 7. 卸载http包, 需要解决依赖性问题</span></span><br><span class="line">[root@localhost /]<span class="comment"># rpm -e httpd</span></span><br></pre></td></tr></table></figure>

<h1 id="RPM验证"><a href="#RPM验证" class="headerlink" title="RPM验证"></a>RPM验证</h1><p>有时候网络波动或网络攻击会导致文件缺失或者文件被植入木马等问题, 就需要验证下载下来的文件和RPM包的文件是否一致。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 修改 httpd 包的配置文件 httpd.conf, 随便添加几个字符</span></span><br><span class="line">[root@localhost ~]<span class="comment"># vim /etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="comment"># 2. verify 校验RPM包中的文件, 发现被修改过了, S.5....T 对应表一, c 对应表二</span></span><br><span class="line">[root@localhost ~]<span class="comment"># rpm -V httpd</span></span><br><span class="line">S.5....T  c /etc/httpd/conf/httpd.conf</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th align="center">S(Size)</th>
<th align="center">M(Mode)</th>
<th align="center">5(MD5)</th>
<th align="center">D(Device)</th>
<th align="center">L(Link)</th>
<th align="center">U(User)</th>
<th align="center">G(Group )</th>
<th align="center">T(mTime)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">文件大小</td>
<td align="center">文件类型或文件权限</td>
<td align="center">MD5校验</td>
<td align="center">设备主从代码</td>
<td align="center">文件路径</td>
<td align="center">文件所有者</td>
<td align="center">文件所属组</td>
<td align="center">文件修改时间</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="center">c(config)</th>
<th align="center">d(documentation)</th>
<th align="center">g(ghost)</th>
<th align="center">L(license)</th>
<th align="center">r(readme)</th>
</tr>
</thead>
<tbody><tr>
<td align="center">配置文件</td>
<td align="center">普通文件</td>
<td align="center">不在RPM包的幽灵文件</td>
<td align="center">授权文件</td>
<td align="center">描述文件</td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 3. 使用 rpm2cpio 将 rpm 包中转为 cpio, 再通过 cpio 提取其中的 ./etc/httpd/conf/httpd.conf 文件, 保存到 /tmp 目录下</span></span><br><span class="line"><span class="comment"># -i copy-in模式还原, -d 还原时自动新建目录, -v verbose 显示还原过程</span></span><br><span class="line">[root@localhost ~]<span class="comment"># cd /tmp</span></span><br><span class="line">[root@localhost /tmp]<span class="comment"># rpm2cpio /mnt/cdrom/CentOS/httpd-2.2.3-22.el5.centos.x86_64.rpm | cpio -idv ./etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="comment"># 4. 覆盖被改变的 httpd.conf</span></span><br><span class="line">[root@localhost /tmp]<span class="comment"># cp /tmp/etc/httpd/conf/httpd.conf /etc/httpd/conf/httpd.conf</span></span><br><span class="line"><span class="comment"># 5. 再次校验RPM包, 发现没有异常, 只有时间被修改了</span></span><br><span class="line">[root@localhost tmp]<span class="comment"># rpm -V httpd</span></span><br><span class="line">.......T  c /etc/httpd/conf/httpd.conf</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux软件安装</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux软件安装之Yum详解</title>
    <url>/posts/Yum_installation_of_Linux_software.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Yum(Yellow dog Updater, Modified)</code>是一个基于<code>RPM</code>包管理的字符前端软件包管理器。<br>能够从指定的服务器自动下载RPM包并且安装，可以自动处理<strong>依赖性</strong>关系，并且一次安装所有依赖的软件包，无须繁琐地一次次下载、安装。<br>不支持<code>RPM</code>查询和校验。</p>
<span id="more"></span>

<h1 id="Yum配置文件"><a href="#Yum配置文件" class="headerlink" title="Yum配置文件"></a>Yum配置文件</h1><p>配置文件在<code>/etc/yum.repos.d/</code>目录下</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># cat /etc/yum.repos.d/CentOS-Base.repo </span></span><br><span class="line">[容器名]</span><br><span class="line">name=容器说明</span><br><span class="line">mirrorlist=镜像站点, 当baseurl无法访问时启用</span><br><span class="line"><span class="comment">#baseurl=Yum服务器地址</span></span><br><span class="line">enabled=0禁用, 1启用, 默认启用</span><br><span class="line">gpgcheck=0表示RPM数字证书失效, 1表示生效</span><br><span class="line">gpgkey=数字证书的公钥文件保存位置</span><br><span class="line"></span><br><span class="line">[base]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Base</span><br><span class="line">mirrorlist=http://mirrorlist.centos.org/?release=<span class="variable">$releasever</span>&amp;<span class="built_in">arch</span>=<span class="variable">$basearch</span>&amp;repo=os</span><br><span class="line"><span class="comment">#baseurl=http://mirror.centos.org/centos/$releasever/os/$basearch/</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 省略其他容器</span></span><br></pre></td></tr></table></figure>

<p>使用阿里云<code>Yum</code>源: <a href="https://mirrors.aliyun.com/help/centos">CentOS</a><br>配置好<code>repo</code>文件后, 清空缓存即可。<br><strong>注意, CentOS5已经过时, 很多网站都放弃了CentOS5的Yum源</strong></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">[root@localhost /]<span class="comment"># yum clean all</span></span><br><span class="line">[root@localhost /]<span class="comment"># yum makecache</span></span><br></pre></td></tr></table></figure>

<h1 id="使用系统光盘创建本地Yum源"><a href="#使用系统光盘创建本地Yum源" class="headerlink" title="使用系统光盘创建本地Yum源"></a>使用系统光盘创建本地Yum源</h1><p><code>Yum(Yellow dog Updater, Modified)</code>是一个基于<code>RPM</code>包管理的字符前端软件包管理器。<br>系统光盘自带了一堆<code>RPM</code>包, 也就是说, 使用系统光盘也可以创建一个本地的无需联网的<code>Yum</code>源。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 移除Yum网络源</span></span><br><span class="line">[root@localhost /]<span class="comment"># mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak</span></span><br><span class="line"><span class="comment"># 2. 挂载光盘到 /mnt/cdrom 路径下</span></span><br><span class="line">[root@locathost /]<span class="comment"># mount -t auto /dev/cdrom /mnt/cdrom</span></span><br><span class="line"><span class="comment"># 2. 将挂载后的系统光盘路径设置为本地Yum源地址</span></span><br><span class="line">[root@localhost /]<span class="comment"># vim /etc/yum.repos.d/CentOS-Media.repo</span></span><br><span class="line">[c5-media]</span><br><span class="line">name=CentOS-<span class="variable">$releasever</span> - Media</span><br><span class="line">baseurl=file:///mnt/cdrom/ <span class="comment"># 光盘挂载点</span></span><br><span class="line"><span class="comment"># 只保留一个, 其他注释掉</span></span><br><span class="line"><span class="comment">#        file:///media/cdrom/</span></span><br><span class="line"><span class="comment">#        file:///media/cdrecorder/</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">enabled=1</span><br><span class="line">gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-5</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 查看Yum列表, c5-media 为容器名, 说明本地Yum源设置成功</span></span><br><span class="line">[root@localhost /]<span class="comment"># yum list</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum list | grep &#x27;httpd&#x27;</span></span><br><span class="line">httpd.x86_64                              2.2.3-22.el5.centos          c5-media</span><br><span class="line">httpd-manual.x86_64                       2.2.3-22.el5.centos          c5-media</span><br><span class="line">system-config-httpd.noarch                5:1.3.3.3-1.el5              installed</span><br></pre></td></tr></table></figure>

<h1 id="Yum常用命令"><a href="#Yum常用命令" class="headerlink" title="Yum常用命令"></a>Yum常用命令</h1><p><code>Yum</code>安装等操作不用再使用包全名, 使用包名即可。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装, -y 自动回答yes</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum -y install httpd</span></span><br><span class="line"><span class="comment"># 2. 升级, 注意! 如果未加包名, 会更新所有软件, 包括系统内核!</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum -y update httpd</span></span><br><span class="line"><span class="comment"># 3. 卸载</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum -y remove httpd</span></span><br><span class="line"><span class="comment"># 4. 搜索, 或者使用 yum list | grep &#x27;httpd&#x27;</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum search httpd</span></span><br><span class="line">Loaded plugins: fastestmirror</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">========================== Matched: httpd =============================</span><br><span class="line">mod_ssl.x86_64 : Apache HTTP 服务器的 SSL/TLS 模块</span><br><span class="line">system-config-httpd.noarch : Apache 配置工具。</span><br><span class="line">httpd.x86_64 : Apache HTTP 服务器</span><br><span class="line">httpd-manual.x86_64 : Apache HTTP 服务器的文档。</span><br></pre></td></tr></table></figure>

<h1 id="Yum-软件组"><a href="#Yum-软件组" class="headerlink" title="Yum 软件组"></a>Yum 软件组</h1><p>软件组, 顾名思义, 就是一组软件。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 先将系统语言改为英文</span></span><br><span class="line">[root@localhost ~]<span class="comment"># LANG=en_US</span></span><br><span class="line"><span class="comment"># 2. 列出所有可用的软件组列表</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum grouplist</span></span><br><span class="line"><span class="comment"># 3. 安装 MySQL 软件组, 组名必须要英文, 第1步已经修改了系统语言</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum groupinstall &quot;MySQL Server&quot;</span></span><br><span class="line"><span class="comment"># 4. 卸载软件组</span></span><br><span class="line">[root@localhost ~]<span class="comment"># yum groupremove &quot;MySQL Server&quot;</span></span><br><span class="line"><span class="comment"># 5. 将系统语言改为中文UTF8</span></span><br><span class="line">[root@localhost ~]<span class="comment"># LANG=zh-CN.utf8</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux软件安装</tag>
      </tags>
  </entry>
  <entry>
    <title>Linux软件安装之源码包详解</title>
    <url>/posts/source_code_installation_of_Linux_software.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>源代码包则主要适用于自由软件的安装，用户需要自己编译它们。<br>通常从软件的官方网站获取下载。<br>就是开发者写的代码, 需要自己手动编译。</p>
<span id="more"></span>

<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>以 <code>Apache</code> 的 <code>httpd</code> 包为例。<a href="http://archive.apache.org/dist/httpd/">httpd各版本下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装 gcc 编译器, 源码包必须安装编译器</span></span><br><span class="line">[root@localhost /]<span class="comment"># yum -y install gcc</span></span><br><span class="line"><span class="comment"># 2. 下载 Apache 的 httpd 源码包, -C 断点续传, -o 指定输出文件</span></span><br><span class="line">[root@localhost /]<span class="comment"># curl -C -o /opt/httpd-2.2.9.tar.gz http://archive.apache.org/dist/httpd/httpd-2.2.9.tar.gz</span></span><br><span class="line"><span class="comment"># 3. 解压缩, 并进去该目录, -z 使用gzip压缩, -x 解压缩, -v 显示操作过程, -f 指定操作的文件, -C 解压在指定目录下</span></span><br><span class="line">[root@localhost /]<span class="comment"># tar -zxvf /opt/httpd-2.2.9.tar.gz -C /opt</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.1. 进入解压缩后的目录, 必须!!!</span></span><br><span class="line">[root@localhost /]<span class="comment"># cd /opt/httpd-2.2.9</span></span><br><span class="line"><span class="comment"># 4.2. 软件配置, 生成Makefile文件, 保存定义好的功能选项和检测系统环境的信息, 用于后续的安装</span></span><br><span class="line"><span class="comment">#        安装到 /opt/apache 目录下</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># ./configure --prefix=/opt/apache</span></span><br><span class="line"><span class="comment"># 4.3. make是用来编译的，它从Makefile中读取指令，然后编译。</span></span><br><span class="line"><span class="comment">#        如果报错, 需要执行 make clean 清除缓存和临时文件。</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># make</span></span><br><span class="line"><span class="comment"># 4.4. make install是用来安装的，它也从Makefile中读取指令，安装到指定的位置。</span></span><br><span class="line"><span class="comment">#        如果报错, 需要执行 make clean 清除缓存和临时文件, 并删除/opt/apache目录。</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># make install</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 编辑html, 启动apache, 关闭防火墙, 在浏览器输入服务器的 ip 地址即可访问</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># vim /opt/apache/htdocs/index.html</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># /opt/apache/bin/apachectl start</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># systemctl stop firewalld.service</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 卸载直接删除目录即可</span></span><br><span class="line">[root@localhost httpd-2.2.9]<span class="comment"># cd / &amp;&amp; rm -rf /opt/http* /opt/apache</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux软件安装</tag>
      </tags>
  </entry>
  <entry>
    <title>使用rsync同步两台服务器的文件</title>
    <url>/posts/use_rsync_to_sync_file_between_two_unix_system.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>rsync</code>是<code>unix</code>文件同步和传送工具。使用方法也很简单, 和<code>cp</code>类似。<br>首先安装<code>rsync</code>程序。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt install -y rsync</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="简单例子"><a href="#简单例子" class="headerlink" title="简单例子"></a>简单例子</h1><p>先做一个简单的例子测试下, 稍后再解释参数用法。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 初始化必要的文件</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/dir1 /opt/dir2 -p</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /opt/dir1/file1</span><br><span class="line"><span class="comment"># 2. 现在 dir1 有 file1 文件, dir2 没有</span></span><br><span class="line">ll /opt/dir1/ /opt/dir2/</span><br><span class="line"><span class="comment"># dir1/:</span></span><br><span class="line"><span class="comment"># -rw-r--r--. 1 root root 2 9月  18 10:12 file1</span></span><br><span class="line"><span class="comment"># dir2/:</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 同步两个文件夹, 这里只会同步一次, 不会持续同步</span></span><br><span class="line">rsync -avzP /opt/dir1/ /opt/dir2/</span><br><span class="line"><span class="comment"># sending incremental file list</span></span><br><span class="line"><span class="comment"># ./</span></span><br><span class="line"><span class="comment"># file1</span></span><br><span class="line"><span class="comment">#               2 100%    0.00kB/s    0:00:00 (xfr#1, to-chk=0/2)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># sent 107 bytes  received 38 bytes  290.00 bytes/sec</span></span><br><span class="line"><span class="comment"># total size is 2  speedup is 0.01</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 现在 dir1/file1 已经同步到 dir2 中了</span></span><br><span class="line">ll /opt/dir1/ /opt/dir2/</span><br><span class="line"><span class="comment"># dir1/:</span></span><br><span class="line"><span class="comment"># -rw-r--r--. 1 root root 2 9月  18 10:12 file1</span></span><br><span class="line"><span class="comment"># dir2/:</span></span><br><span class="line"><span class="comment"># -rw-r--r--. 1 root root 2 9月  18 10:12 file1</span></span><br></pre></td></tr></table></figure>

<h1 id="命令选项"><a href="#命令选项" class="headerlink" title="命令选项"></a>命令选项</h1><table>
<thead>
<tr>
<th align="center">选项缩写</th>
<th align="center">选项全称</th>
<th align="center">选项说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>-a</code></td>
<td align="center"><code>--archive</code></td>
<td align="center">完全的复制, 等于<code>-rlptgoD</code>。</td>
</tr>
<tr>
<td align="center"><code>-v</code></td>
<td align="center"><code>--verbose</code></td>
<td align="center">输出详细日志</td>
</tr>
<tr>
<td align="center"><code>-q</code></td>
<td align="center"><code>--quiet</code></td>
<td align="center">输出简单日志</td>
</tr>
<tr>
<td align="center"><code>-r</code></td>
<td align="center"><code>--recursive</code></td>
<td align="center">递归处理所有子目录</td>
</tr>
<tr>
<td align="center"><code>-z</code></td>
<td align="center"><code>--compress</code></td>
<td align="center">对备份的文件在传输时进行压缩处理</td>
</tr>
<tr>
<td align="center"><code>-P</code></td>
<td align="center"><code>--partial</code></td>
<td align="center">保留那些因故没有完全传输的文件, 用于加快随后的再次传输</td>
</tr>
</tbody></table>
<p>更多选项查看: <a href="https://man.linuxde.net/rsync"><code>rsync命令</code></a></p>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p><code>rsync</code>有三个配置文件</p>
<ol>
<li><code>rsyncd.conf</code>是<code>rsync</code>服务器主要配置文件.</li>
<li><code>rsyncd.secrets</code>是登录<code>rsync</code>服务器的密码文件.</li>
<li><code>rsyncd.motd</code>是定义<code>rysnc</code>服务器信息的, 也就是用户登录信息. 非必须.</li>
</ol>
<h2 id="rsyncd-conf"><a href="#rsyncd-conf" class="headerlink" title="rsyncd.conf"></a>rsyncd.conf</h2><p>配置文件<a href="https://download.samba.org/pub/rsync/rsyncd.conf.html">官方<code>example</code></a><br>如果<code>/etc/rsync.conf</code>不存在, 就手动创建。</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 全局通用配置</span></span><br><span class="line"><span class="comment">## 指定该模块以指定的 UID 传输文件。</span></span><br><span class="line"><span class="attr">uid</span> = <span class="number">0</span></span><br><span class="line"><span class="comment">## 指定该模块以指定的 GID 传输文件。</span></span><br><span class="line"><span class="attr">gid</span> = <span class="number">0</span></span><br><span class="line"><span class="comment">## 不使用 chroot 修改根的位置</span></span><br><span class="line">use <span class="attr">chroot</span> = <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 存放 rsync 后台守护进程的 pid 的值的文件</span></span><br><span class="line">pid <span class="attr">file</span> = /var/run/rsyncd.pid</span><br><span class="line"><span class="comment">## 存放 rsync 的日志文件</span></span><br><span class="line">log <span class="attr">file</span> = /var/log/rsyncd.log</span><br><span class="line">lock <span class="attr">file</span> = /var/run/rsyncd.lock</span><br><span class="line"><span class="comment">## 存放远程服务器的用户名和密码, username:password 的形式</span></span><br><span class="line">secrets <span class="attr">file</span> = /etc/rsyncd.passwd</span><br><span class="line"></span><br><span class="line"><span class="comment">## 最大并发连接数为4</span></span><br><span class="line">max <span class="attr">connections</span> = <span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 某个模块的配置</span></span><br><span class="line"><span class="section">[module_test1]</span></span><br><span class="line">auth <span class="attr">users</span> = root</span><br><span class="line"><span class="attr">path</span> = /opt/dir1</span><br><span class="line"><span class="attr">comment</span> = rsync test1 logs</span><br><span class="line">read <span class="attr">only</span> = <span class="literal">no</span></span><br><span class="line"></span><br><span class="line"><span class="section">[module_test2]</span></span><br><span class="line">auth <span class="attr">users</span> = root</span><br><span class="line"><span class="attr">path</span> = /opt/dir1</span><br><span class="line"><span class="attr">comment</span> = rsync test2 logs</span><br><span class="line">read <span class="attr">only</span> = <span class="literal">no</span></span><br></pre></td></tr></table></figure>

<h2 id="rsyncd-secrets"><a href="#rsyncd-secrets" class="headerlink" title="rsyncd.secrets"></a>rsyncd.secrets</h2><p>将远程服务器用户名密码存入<code>/etc/rsyncd.passwd</code>文件, 重启服务</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 存放用户名密码</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;root:root&quot;</span> &gt; /etc/rsyncd.passwd</span><br><span class="line"><span class="built_in">chown</span> root.root /etc/rsyncd.passwd</span><br><span class="line"><span class="built_in">chmod</span> 600 /etc/rsyncd.passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 以daemon方式重启服务</span></span><br><span class="line">service rsync stop</span><br><span class="line">rsync --daemon --config=/etc/rsync.conf</span><br></pre></td></tr></table></figure>

<h1 id="自动同步"><a href="#自动同步" class="headerlink" title="自动同步"></a>自动同步</h1><p>自动同步有两种方案</p>
<ol>
<li>使用<code>crontab</code>定时调用</li>
<li>使用<code>inotifytools</code>监控文件变化, 请参照另一篇文章<strong>使用<code>inotifytools</code>监控文件</strong></li>
</ol>
<p>这里提供一个简单的<code>shell</code>脚本</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 1. 声明一个同步函数, rs(remoteIp, path)</span></span><br><span class="line"><span class="keyword">function</span> <span class="function"><span class="title">rs</span></span>() &#123;</span><br><span class="line">    rsync -azP --delete <span class="variable">$3</span> rsync://<span class="variable">$1</span>/<span class="variable">$2</span>  --password-file=/etc/rsyncd.passwd</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 2. 声明项目路径, 后面要加 / , 否则会连目录也一起传输过去</span></span><br><span class="line">path=/opt/dir1/</span><br><span class="line">module=module_test2</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;开始同步到远程机器&quot;</span></span><br><span class="line"><span class="comment"># 3. 开始传输</span></span><br><span class="line"><span class="comment">## B机器ip,格式：用户名@ip</span></span><br><span class="line">rs root@192.168.154.128 <span class="variable">$&#123;module&#125;</span> <span class="variable">$&#123;path&#125;</span></span><br><span class="line"><span class="comment">## C机器ip,格式：用户名@ip</span></span><br><span class="line">rs root@192.168.154.129 <span class="variable">$&#123;module&#125;</span> <span class="variable">$&#123;path&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;结束同步&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">## TODO 这个同步到远程的操作一直失败, 应该是哪里配错了, 等以后有机会再来改改吧</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://rsync.samba.org/examples.html">官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>使用inotifytools监控文件</title>
    <url>/posts/Monitor_files_with_inotifytools.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>监控文件变化是一个很常用的功能, 比如监控密码文件, <code>html</code>文件, 如果被恶意修改, 那就发送一个请求给服务器, 发送短信给管理员。<br>这里使用<code>inotify-tools</code>来监控文件变化, 安装命令如下:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt install -y inotify-tools</span><br></pre></td></tr></table></figure>
<p><code>inotify-tools</code>提供了两个命令: </p>
<ol>
<li><code>inotifywait</code>, 它是用来监控文件或目录的变化</li>
<li><code>inotifywatch</code>, 它是用来统计文件系统访问的次数</li>
</ol>
<span id="more"></span>

<h1 id="默认内核参数"><a href="#默认内核参数" class="headerlink" title="默认内核参数"></a>默认内核参数</h1><p>参数以文件形式存储</p>
<table>
<thead>
<tr>
<th align="center">文件路径</th>
<th align="center">默认值</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>/proc/sys/fs/inotify/max_queued_events</code></td>
<td align="center">16384</td>
<td align="center">表示调用<code>inotify_init</code>时分配给<code>inotify instance</code>中可排队的<code>event</code>的数目的最大值，超出这个值的事件被丢弃，但会触发<code>IN_Q_OVERFLOW</code>事件。</td>
</tr>
<tr>
<td align="center"><code>/proc/sys/fs/inotify/max_user_instances</code></td>
<td align="center">128</td>
<td align="center">表示每一个real user <a href="http://man.linuxde.net/id" title="id命令">id</a>可创建的<code>inotify instatnces</code>的数量上限</td>
</tr>
<tr>
<td align="center"><code>/proc/sys/fs/inotify/max_user_watches</code></td>
<td align="center">8192</td>
<td align="center">表示每个<code>inotify instatnces</code>可监控的最大目录数量。如果监控的文件数目巨大，需要根据情况，适当增加此值的大小。</td>
</tr>
</tbody></table>
<p>如修改每个<code>inotify instatnces</code>可监控的最大目录数量为<code>104857600 </code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> 104857600 &gt; /proc/sys/fs/inotify/max_user_watches</span><br><span class="line"><span class="built_in">cat</span> /proc/sys/fs/inotify/max_queued_events</span><br><span class="line"><span class="built_in">cat</span> /proc/sys/fs/inotify/max_user_instances</span><br><span class="line"><span class="built_in">cat</span> /proc/sys/fs/inotify/max_user_watches</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="inotifywait监控文件变化"><a href="#inotifywait监控文件变化" class="headerlink" title="inotifywait监控文件变化"></a>inotifywait监控文件变化</h1><p><strong>部分常用参数说明</strong></p>
<table>
<thead>
<tr>
<th align="center">参数</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>-m, --monitor</code></td>
<td align="center">一直监听, 不指定则默认在第一个事件发生后结束</td>
</tr>
<tr>
<td align="center"><code>-r, --recursive</code></td>
<td align="center">使用递归形式监视目录, 注意监视文件的数量最多为<code>8192</code>, 要修改数量需要修改<code>max_user_watches</code>文件</td>
</tr>
<tr>
<td align="center"><code>-q, --quiet</code></td>
<td align="center">指定一次减少输出信息(仅打印事件), 指定两次不输出非错误信息</td>
</tr>
<tr>
<td align="center"><code>--timefmt</code></td>
<td align="center">指定时间的输出格式, 显示在<code>--format</code>的<code>%T</code>中, 格式参考<a href="http://www.cplusplus.com/reference/ctime/strftime/">strftime函数</a></td>
</tr>
<tr>
<td align="center"><code>--format</code></td>
<td align="center">指定日志输出格式, <code>%w</code>表示发生事件的目录, <code>%f</code>表示发生事件的文件, <code>%e</code>表示发生的事件, <code>%Xe</code>事件名以<code>X</code>分隔, <code>%T</code>使用由<code>--timefmt</code>定义的时间格式</td>
</tr>
<tr>
<td align="center"><code>--event</code></td>
<td align="center">只监听某些事件, 事件参考<a href="http://man.linuxde.net/inotifywait">可监听的事件</a></td>
</tr>
</tbody></table>
<p>先来个简单的例子, 监控<code>test</code>文件夹下的变化。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 在终端1开启inotifywait, -r表示递归监视, -m表示持续监视, -q表示只输出事件</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/test -p</span><br><span class="line">inotifywait -rmq /opt/test/</span><br><span class="line"><span class="comment"># 2. 在终端2写入文件</span></span><br><span class="line"><span class="built_in">echo</span> 123 &gt; /opt/test/123.txt</span><br><span class="line"><span class="comment"># 3. 终端1显示如下信息</span></span><br><span class="line"><span class="comment"># test/ CREATE 123.txt</span></span><br><span class="line"><span class="comment"># test/ OPEN 123.txt</span></span><br><span class="line"><span class="comment"># test/ MODIFY 123.txt</span></span><br><span class="line"><span class="comment"># test/ CLOSE_WRITE,CLOSE 123.txt</span></span><br></pre></td></tr></table></figure>

<p>下面来一个复杂点的例子, 后台监控<code>test</code>文件夹变化, 并将变化内容发送到邮箱。(注意! 这种注释方式会<a href="https://stackoverflow.com/a/12797512/6335926">损耗性能</a>! 这里只是为了直观才加的注释)</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装依赖</span></span><br><span class="line">apt install mailutils -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在终端1操作</span></span><br><span class="line">vim inotify.sh</span><br><span class="line"><span class="comment"># #/bin/bash</span></span><br><span class="line"><span class="comment"># /usr/bin/inotifywait -rmq               `# 1. -r表示递归监视, -m表示持续监视, -q表示只输出事件` \</span></span><br><span class="line"><span class="comment">#    --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27;        `# 2. 时间格式为 2018-08-15 16:16:12` \</span></span><br><span class="line"><span class="comment">#    --format  &#x27;%T %w%f %e&#x27;               `# 3. 输出格式为: 时间 目录 文件 事件` \</span></span><br><span class="line"><span class="comment">#    --event modify,attrib,create,delete  `# 4. 只监控特定事件` \</span></span><br><span class="line"><span class="comment">#    /opt/test/                           `# 5. 监控test文件夹` \</span></span><br><span class="line"><span class="comment">#    | while read log; do echo $log | mail -s &#x27;文件改变&#x27; root; done; `# 6. 读取管道流, 执行发送邮件给 root 的命令`</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">chmod</span> 755 inotify.sh</span><br><span class="line"><span class="built_in">nohup</span> inotify.sh &gt;&gt; /dev/null 2&gt;&amp;1 &amp;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在终端2操作</span></span><br><span class="line"><span class="built_in">echo</span> 123 &gt; /opt/test/123.txt</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在终端3操作, ctrl+D结束查看邮件</span></span><br><span class="line">mail</span><br><span class="line"><span class="comment"># &quot;/var/mail/root&quot;: 1 message 1 new</span></span><br><span class="line"><span class="comment">#  &gt;N   1 root               日 5月 24 13:1  13/451   文件改变</span></span><br><span class="line"><span class="comment"># ? 1</span></span><br><span class="line"><span class="comment"># Return-Path: &lt;root@ahao-vm&gt;</span></span><br><span class="line"><span class="comment"># X-Original-To: root@ahao-vm</span></span><br><span class="line"><span class="comment"># Delivered-To: root@ahao-vm</span></span><br><span class="line"><span class="comment"># Received: by ahao-vm.localdomain (Postfix, from userid 0)</span></span><br><span class="line"><span class="comment">#   id AB4CBA3D5E; Sun, 24 May 2020 13:17:25 +0800 (CST)</span></span><br><span class="line"><span class="comment"># Subject: 文件改变</span></span><br><span class="line"><span class="comment"># To: &lt;root@ahao-vm&gt;</span></span><br><span class="line"><span class="comment"># X-Mailer: mail (GNU Mailutils 2.99.99)</span></span><br><span class="line"><span class="comment"># Message-Id: &lt;20200524051725.AB4CBA3D5E@ahao-vm.localdomain&gt;</span></span><br><span class="line"><span class="comment"># Date: Sun, 24 May 2020 13:17:25 +0800 (CST)</span></span><br><span class="line"><span class="comment"># From: root@ahao-vm (root)</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># 2020-05-24 13:17:25 /opt/test/123.txt MODIFY</span></span><br></pre></td></tr></table></figure>

<h1 id="inotifywatch统计访问次数"><a href="#inotifywatch统计访问次数" class="headerlink" title="inotifywatch统计访问次数"></a>inotifywatch统计访问次数</h1><p>一个简单的例子, 监控<code>test</code>文件夹下<code>60s</code>内的变化次数</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">inotifywatch -v -e modify,delete,create,attrib,move,open,close,access -e modify -t 60 -r <span class="built_in">test</span>/</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.cnblogs.com/martinzhang/p/4126907.html">inotifywait命令</a></li>
<li><a href="http://linux.51yip.com/search/inotifywatch">inotifywatch</a></li>
</ul>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>基于shadowsocks-libev+simple-obfs的单机多用户搭建</title>
    <url>/posts/multi_user_of_shadowsocks_libev.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>你好啊，感谢你阅读本文。<br><code>18</code>年的时候，我发布了这篇文章，介绍了如何部署一套我当时以为安全的流量混淆和多用户限流工具。</p>
<p>转眼到了<code>22</code>年，现在我遇到了几个问题</p>
<ol>
<li>我的<code>Linux</code>虚拟机迫切需要使用科学上网，但是当时这篇文章里没有介绍关于<code>Linux Client</code>的使用。</li>
<li>我的<code>shadowsocks-libev</code>版本过于老旧，不知道是否会有安全漏洞，需要更新。</li>
<li><code>simple-obfs</code>混淆插件已经停止维护，拙劣的混淆可能会暴露自己。</li>
</ol>
<p>随后我在搜索引擎上找到了一篇文章，<a href="https://gfw.report/blog/ss_tutorial/zh/">如何部署一台抗封锁的<code>Shadowsocks-libev</code>服务器</a> 。<br><strong>PS：在写这篇文章的时候，根据上文进行配置，第二天就被封<code>IP</code>了，建议大家还是开上<code>simple obfs</code>等混淆插件，不要裸奔。</strong></p>
<p>本文基于<code>Ubuntu 18.04</code>在虚拟机中进行操作, 并于<code>VPS</code>上测试成功。</p>
<span id="more"></span>

<h1 id="允许root远程登录（仅限虚拟机，请勿用于生产环境）"><a href="#允许root远程登录（仅限虚拟机，请勿用于生产环境）" class="headerlink" title="允许root远程登录（仅限虚拟机，请勿用于生产环境）"></a>允许root远程登录（仅限虚拟机，请勿用于生产环境）</h1><p>建议使用<code>root</code>避免各种权限问题。<br>实际使用时应该登录普通用户后<code>sudo -s</code>切换到<code>root</code>用户。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 设置root用户的密码为root，并允许root用户远程登录</span></span><br><span class="line">sudo passwd root</span><br><span class="line">sudo sed -i <span class="string">&#x27;s/#PermitRootLogin prohibit-password/PermitRootLogin yes/&#x27;</span> /etc/ssh/sshd_config</span><br><span class="line">sudo service sshd restart</span><br></pre></td></tr></table></figure>

<h1 id="shadowsocks-libev-服务端安装配置"><a href="#shadowsocks-libev-服务端安装配置" class="headerlink" title="shadowsocks-libev 服务端安装配置"></a>shadowsocks-libev 服务端安装配置</h1><p>服务端使用<a href="https://github.com/shadowsocks/shadowsocks-libev"><code>shadowsocks-libev</code></a><br><a href="https://github.com/shadowsocks/shadowsocks-libev/blob/master/doc/shadowsocks-libev.asciidoc#config-file">配置文件官方文档</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装 shadowsocks-libev</span></span><br><span class="line">apt update -y</span><br><span class="line">apt install shadowsocks-libev -y <span class="comment"># 安装或升级</span></span><br><span class="line">dpkg -l | grep shadowsocks       <span class="comment"># 查看版本号</span></span><br></pre></td></tr></table></figure>
<p><strong>建议使用<code>openssl rand -base64 16</code>来生成强密码</strong></p>
<h2 id="单用户配置"><a href="#单用户配置" class="headerlink" title="单用户配置"></a>单用户配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 添加单用户配置文件</span></span><br><span class="line">vim /etc/shadowsocks-libev/config.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;server&quot;</span>:[<span class="string">&quot;::0&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>],</span><br><span class="line">    <span class="string">&quot;server_port&quot;</span>: 8452,</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;chacha20-ietf-poly1305&quot;</span>,</span><br><span class="line">    <span class="string">&quot;password&quot;</span>: <span class="string">&quot;Zqx465gr5snppXlYWMEKZQ==&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;tcp_and_udp&quot;</span>,</span><br><span class="line">    <span class="string">&quot;fast_open&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 启动服务端</span></span><br><span class="line">ss-server</span><br><span class="line">systemctl start   shadowsocks-libev.service <span class="comment"># 启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span>  shadowsocks-libev.service <span class="comment"># 开机自启</span></span><br><span class="line">systemctl status  shadowsocks-libev.service <span class="comment"># 查看状态</span></span><br><span class="line">systemctl restart shadowsocks-libev.service <span class="comment"># 重启</span></span><br></pre></td></tr></table></figure>

<h2 id="多用户配置"><a href="#多用户配置" class="headerlink" title="多用户配置"></a>多用户配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 添加多用户配置文件</span></span><br><span class="line">vim /etc/shadowsocks-libev/config.json</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;server&quot;</span>:[<span class="string">&quot;::0&quot;</span>,<span class="string">&quot;0.0.0.0&quot;</span>],</span><br><span class="line">  <span class="string">&quot;port_password&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;8452&quot;</span>: <span class="string">&quot;Zqx465gr5snppXlYWMEKZQ==&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;method&quot;</span>: <span class="string">&quot;chacha20-ietf-poly1305&quot;</span>,</span><br><span class="line">  <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;tcp_and_udp&quot;</span>,</span><br><span class="line">  <span class="string">&quot;fast_open&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 2. 启动服务端</span></span><br><span class="line">ss-manager -c /etc/shadowsocks-libev/config.json</span><br></pre></td></tr></table></figure>

<h2 id="测试使用"><a href="#测试使用" class="headerlink" title="测试使用"></a>测试使用</h2><p>客户端连接上, 然后开启全局模式, 执行如下操作</p>
<ol>
<li>访问<code>www.baidu.com</code>, 访问成功</li>
<li>关闭服务端, 访问<code>www.baidu.com</code>, 访问失败</li>
</ol>
<p>则说明<code>shadowsocks-libev</code>已经成功配置。</p>
<h1 id="配置-simple-obfs-混淆插件"><a href="#配置-simple-obfs-混淆插件" class="headerlink" title="配置 simple-obfs 混淆插件"></a>配置 simple-obfs 混淆插件</h1><p><a href="https://github.com/shadowsocks/simple-obfs"><code>simple-obfs</code></a> 是一个简单的混淆插件, 可以伪装成 <code>http</code> 流量。</p>
<h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 从 Github 下载源码进行编译</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line">apt-get install --no-install-recommends build-essential autoconf libtool libssl-dev libpcre3-dev libev-dev asciidoc xmlto automake -y</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/shadowsocks/simple-obfs.git</span><br><span class="line"><span class="built_in">cd</span> simple-obfs</span><br><span class="line">git submodule update --init --recursive</span><br><span class="line">./autogen.sh &amp;&amp; ./configure &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 添加配置文件, 添加 plugin 和 plugin_opts 参数</span></span><br><span class="line">vim /etc/shadowsocks-libev/config.json</span><br><span class="line">&#123;</span><br><span class="line">  ...省略其他配置</span><br><span class="line">  <span class="string">&quot;plugin&quot;</span>:<span class="string">&quot;obfs-server&quot;</span>,</span><br><span class="line">  <span class="string">&quot;plugin_opts&quot;</span>:<span class="string">&quot;obfs=http;failover=apps.bdimg.com&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重启 shadowsocks-libev</span></span><br><span class="line">systemctl restart shadowsocks-libev.service <span class="comment"># 重启</span></span><br></pre></td></tr></table></figure>

<h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><p><code>win</code>: <a href="https://github.com/shadowsocks/simple-obfs/releases">https://github.com/shadowsocks/simple-obfs/releases</a><br>复制到客户端同一目录下, 并配置以下参数<br>插件程序: <code>obfs-local</code><br>插件选项: <code>obfs=http;obfs-host=apps.bdimg.com</code></p>
<p><code>android</code>: <a href="https://github.com/shadowsocks/simple-obfs-android/releases">https://github.com/shadowsocks/simple-obfs-android/releases</a></p>
<p>没有苹果设备, 不做研究。</p>
<h1 id="配置-v2ray-混淆插件（暂未落地）"><a href="#配置-v2ray-混淆插件（暂未落地）" class="headerlink" title="配置 v2ray 混淆插件（暂未落地）"></a>配置 v2ray 混淆插件（暂未落地）</h1><p>地址：<a href="https://github.com/shadowsocks/v2ray-plugin">https://github.com/shadowsocks/v2ray-plugin</a></p>
<h1 id="流量统计（暂未落地）"><a href="#流量统计（暂未落地）" class="headerlink" title="流量统计（暂未落地）"></a>流量统计（暂未落地）</h1><p><del><a href="https://github.com/shadowsocks/shadowsocks-manager">shadowsocks-manager</a>要部署邮箱才行, 放弃.</del><br><del><a href="https://github.com/shadowsocks/shadowsocks-hub">shadowsocks-hub</a>依赖于<a href="https://github.com/shadowsocks/shadowsocks-restful-api">shadowsocks-restful-api</a>, 也是依赖于原生的<code>manager API</code>接口.(虽然我跑<code>docker</code>失败了)</del></p>
<p><code>shadowsocks-libev</code>提供了原生的<code>manager API</code>接口, 可以统计流量使用情况.接口文档在这里<a href="https://github.com/shadowsocks/shadowsocks-libev/blob/master/doc/ss-manager.asciidoc#protocol">protocol</a>.</p>
<h1 id="优化"><a href="#优化" class="headerlink" title="优化"></a>优化</h1><h2 id="开启BBR"><a href="#开启BBR" class="headerlink" title="开启BBR"></a>开启BBR</h2><p><code>BBR</code>需要内核<code>4.9</code>以上.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 查看内核</span></span><br><span class="line"><span class="built_in">uname</span> -r</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 启动BBR</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.core.default_qdisc=fq&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;net.ipv4.tcp_congestion_control=bbr&quot;</span> &gt;&gt; /etc/sysctl.conf</span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 如果以下两条命令都有bbr说明开启成功</span></span><br><span class="line">sysctl net.ipv4.tcp_available_congestion_control</span><br><span class="line">lsmod | grep bbr</span><br></pre></td></tr></table></figure>

<h2 id="部署一个正常的网站到80端口"><a href="#部署一个正常的网站到80端口" class="headerlink" title="部署一个正常的网站到80端口"></a>部署一个正常的网站到80端口</h2><p>也可以用来部署一些自己的<code>web</code>应用</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">apt install nginx -y</span><br><span class="line">nginx reload</span><br></pre></td></tr></table></figure>

<h2 id="备用端口"><a href="#备用端口" class="headerlink" title="备用端口"></a>备用端口</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 配置端口转发</span></span><br><span class="line">iptables -t nat -A PREROUTING -p tcp --dport 18452 -j REDIRECT --to-port 8452</span><br><span class="line">iptables -t nat -A PREROUTING -p udp --dport 18452 -j REDIRECT --to-port 8452</span><br><span class="line">iptables -t nat -L PREROUTING -nv --line-number <span class="comment"># 查看状态</span></span><br><span class="line"><span class="comment"># iptables -t nat -D PREROUTING 1 # 删除num为1的规则 </span></span><br></pre></td></tr></table></figure>

<h2 id="开启防火墙"><a href="#开启防火墙" class="headerlink" title="开启防火墙"></a>开启防火墙</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">apt update &amp;&amp; sudo apt install -y ufw</span><br><span class="line">ufw allow ssh</span><br><span class="line">ufw allow 8452 <span class="comment"># 这里配置堆外暴露的端口号</span></span><br><span class="line">ufw allow 80</span><br><span class="line">ufw <span class="built_in">enable</span></span><br><span class="line">ufw status <span class="comment"># 查看状态</span></span><br></pre></td></tr></table></figure>

<h2 id="封禁恶意访问IP"><a href="#封禁恶意访问IP" class="headerlink" title="封禁恶意访问IP"></a>封禁恶意访问IP</h2><p>使用 <code>fail2ban</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装 fail2ban</span></span><br><span class="line">apt install fail2ban -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ssh 安全规则</span></span><br><span class="line">vim /etc/fail2ban/jail.d/ssh.conf</span><br><span class="line">[ssh-iptables]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">filter     = sshd</span><br><span class="line">action   = iptables[name=SSH, port=ssh, protocol=tcp]</span><br><span class="line">logpath = /var/log/secure</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 重启服务</span></span><br><span class="line">service fail2ban restart</span><br></pre></td></tr></table></figure>

<h1 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h1><p>吐槽下, <code>libev</code>关于<code>config.json</code>的配置没有一个完整的<code>example</code>, 也没有<code>wiki</code>页, 还是我翻了下<code>issue</code>才发现了文档位置. 并且有些参数配置在<code>config.json</code>还没有对应位置.</p>
<p>开发者觉得我弄出来能用就好了, 不懂就去看源码全在那.<br>小白则是素质三连, 怎么用不了了, 报错了, 打不开怎么办.</p>
<p>开源不易, 珍惜每个用心写文档的开发者和每个用心写复现步骤的小白.</p>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
        <tag>shadowsocks</tag>
      </tags>
  </entry>
  <entry>
    <title>文件特殊权限SUID和SGID和SBIT</title>
    <url>/posts/File_permissions_SUID_and_SGID_and_SBIT.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>特殊权限尽量少修改! 不安全!<br>(很久以前写的一篇学习笔记, 一直没有整理</p>
<h1 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h1><p>给执行该文件的用户临时赋予另一个用户(组)的权限。</p>
<span id="more"></span>

<p>比如<strong>设置密码</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ll /etc/shadow /usr/bin/passwd </span><br><span class="line">----------. 1 root root  1232 10月  6 05:47 /etc/shadow</span><br><span class="line">-rwsr-xr-x. 1 root root 27832 6月  10 2014 /usr/bin/passwd</span><br></pre></td></tr></table></figure>
<p><code>/etc/shadow</code>文件只能被<code>root</code>用户修改。<br>但是借助<code>passwd</code>命令, 普通用户可以临时变成<code>root</code>来执行这个<code>passwd</code>命令,<br>进而修改<code>/etc/shadow</code>文件。</p>
<h1 id="切换用户-SUID"><a href="#切换用户-SUID" class="headerlink" title="切换用户 SUID"></a>切换用户 SUID</h1><p>只有可以执行的二进制程序才能设定<code>SUID</code>权限。<br><code>SUID</code>可以看成是<code>Switch User ID</code><del>(一个瞎猜）</del>, 就是切换用户<code>ID</code>.</p>
<ol>
<li>创建两个文件<code>file1</code>和<code>file2</code></li>
<li>添加<code>SUID</code>权限, 或者<code>chmod u+s file</code></li>
<li>取消<code>SUID</code>权限, 或者<code>chmod u-s file</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建两个文件</span></span><br><span class="line"><span class="built_in">touch</span> file1 file2 &amp;&amp; ll</span><br><span class="line"><span class="comment"># -rw-rw-r--. 1 ahao ahao 0 11月 21 21:13 file1</span></span><br><span class="line"><span class="comment"># -rw-rw-r--. 1 ahao ahao 0 11月 21 21:13 file2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 添加SUID权限, 或者chmod u+s  file</span></span><br><span class="line"><span class="built_in">chmod</span> 4755 file1 &amp;&amp; <span class="built_in">chmod</span> 4655 file2 &amp;&amp; ll</span><br><span class="line"><span class="comment"># -rwsr-xr-x. 1 ahao ahao 0 11月 21 21:13 file1</span></span><br><span class="line"><span class="comment"># -rwSr-xr-x. 1 ahao ahao 0 11月 21 21:13 file2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 取消SUID权限, 或者chmod u-s  file</span></span><br><span class="line"><span class="built_in">chmod</span> 0755 file1 &amp;&amp; <span class="built_in">chmod</span> 0655 file2 &amp;&amp; ll</span><br><span class="line"><span class="comment"># -rwxr-xr-x. 1 ahao ahao 0 11月 21 21:13 file1</span></span><br><span class="line"><span class="comment"># -rw-r-xr-x. 1 ahao ahao 0 11月 21 21:13 file2</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到<code>x</code>执行权限的位置被<code>s</code>替换了。<br><code>4755</code>和<code>4655</code>的区别在于文件本身有没有<code>x</code>执行权限。<br>并且可以得知<code>s=S+x</code>, 并且注意!!! 大写<code>S</code>是没有意义的。<br>只有小写<code>s</code>才能被执行, 才能正确设定<code>SUID</code>权限。</p>
<h1 id="切换用户组-SGID"><a href="#切换用户组-SGID" class="headerlink" title="切换用户组 SGID"></a>切换用户组 SGID</h1><p>和<code>SUID</code>一样, 区别在于用户会临时赋予文件所属用户组<code>group</code>的身份, 而不是用户<code>user</code>身份。<del>Switch Group ID</del></p>
<p>比如**<code>locate</code>命令**</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ll /usr/bin/locate /var/lib/mlocate/mlocate.db </span><br><span class="line"><span class="comment"># -rwx--s--x. 1 root slocate   40512 11月 21 23:21 /usr/bin/locate</span></span><br><span class="line"><span class="comment"># -rw-r-----. 1 root slocate 3678432 11月 21 23:21 /var/lib/mlocate/mlocate.db</span></span><br></pre></td></tr></table></figure>
<p><code>/var/lib/mlocate/mlocate.db</code>文件只能被<code>slocate</code>组查看。<br>但是借助<code>locate</code>命令, 普通用户可以临时变成<code>slocate</code>来执行这个<code>locate</code>命令,<br>进而查看<code>/var/lib/mlocate/mlocate.db</code>文件。</p>
<p>除了和<code>SUID</code>差不多的功能外。<br><code>SGID</code>对目录还有另一个功能。<br>就是<strong>进入该目录后</strong>, 用户的用户组会变成<strong>SGID对应的用户组</strong>。</p>
<ol>
<li><code>root</code>用户创建<code>test</code>目录并赋予<code>777</code>权限</li>
<li><code>ahao</code>用户在<code>test</code>目录下创建<code>file1</code></li>
<li><code>root</code>用户为<code>test</code>目录赋予<code>SGID</code>权限</li>
<li><code>ahao</code>用户在赋予<code>SGID</code>的<code>test</code>目录下创建<code>file2</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. root用户创建test目录并赋予777权限</span></span><br><span class="line"><span class="built_in">mkdir</span> ~ahao/test &amp;&amp; <span class="built_in">chmod</span> 777 ~ahao/test &amp;&amp; ll -d ~ahao/test</span><br><span class="line"><span class="comment"># drwxrwxrwx. 2 root root 6 11月 21 23:39 /home/ahao/test</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. ahao用户在test目录下创建file1</span></span><br><span class="line">su - ahao</span><br><span class="line"><span class="built_in">touch</span> ~ahao/test/file1 &amp;&amp; ll ~ahao/test</span><br><span class="line"><span class="comment"># -rw-rw-r--. 1 ahao ahao 0 11月 21 23:43 file1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. root用户为test目录赋予SGID权限, 或者chmod g+s  file</span></span><br><span class="line">su -</span><br><span class="line"><span class="built_in">chmod</span> 2777 ~ahao/test &amp;&amp; ll -d ~ahao/test/</span><br><span class="line"><span class="comment"># drwxrwsrwx. 2 root root 19 11月 21 23:43 /home/ahao/test/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. ahao用户在赋予SGID的test目录下创建file2</span></span><br><span class="line">su - ahao</span><br><span class="line"><span class="built_in">touch</span> ~ahao/test/file2 &amp;&amp; ll ~ahao/test</span><br><span class="line"><span class="comment"># -rw-rw-r--. 1 ahao ahao 0 11月 21 23:43 file1</span></span><br><span class="line"><span class="comment"># -rw-rw-r--. 1 ahao root 0 11月 21 23:45 file2</span></span><br></pre></td></tr></table></figure>
<p>可以看到赋予<code>SGID</code>后, <code>ahao</code>用户创建的<code>file2</code>的所属组是<code>root</code>。</p>
<h1 id="防止被删除-sticky-bit-SBIT"><a href="#防止被删除-sticky-bit-SBIT" class="headerlink" title="防止被删除 sticky bit ( SBIT )"></a>防止被删除 sticky bit ( SBIT )</h1><p>除了<code>user</code>的<code>SUID</code>、<code>group</code>的<code>SGID</code>外, 还有<code>other</code>的<code>sticky bit</code>。</p>
<p><code>sticky bit</code>有两个要求</p>
<ol>
<li>只对目录有效。</li>
<li>文件权限为<code>rwxrwxrwx</code>, 也就是<code>777</code>的权限。<br>比如<code>/tmp</code>目录。</li>
</ol>
<p>那么任何用户都能对目录下的文件进行读写执行操作, 这是很不安全的。<br>比如一个目录, 允许用户(<code>other</code>)创建文件(写权限), 拥有了写权限的用户也同样拥有了删除权限。<br>也就是说在<code>777</code>权限的目录下, <code>A</code>用户创建的文件可能被<code>B</code>用户删除。<br><code>sticky bit</code>就是为了解决这个问题。<br>赋予目录<code>sticky bit</code>后。</p>
<ol>
<li>只有<code>root</code>有删除权限。</li>
<li>其他用户只能删除自己创建的文件。</li>
<li>其他用户拥有写权限。</li>
</ol>
<p>下面举个例子</p>
<ol>
<li><code>root</code>用户创建<code>test</code>目录并赋予<code>777</code>权限。</li>
<li><code>root</code>用户创建<code>file</code>文件。</li>
<li><code>ahao</code>用户删除<code>file</code>文件成功, 因为<code>ahao</code>用户对<code>test</code>目录有w写权限。</li>
<li><code>root</code>用户对<code>test</code>目录赋予<code>sticky bit</code>权限。</li>
<li><code>root</code>用户创建<code>file</code>文件。</li>
<li><code>ahao</code>用户删除<code>file</code>文件失败, 即使<code>ahao</code>用户对<code>test</code>目录有w写权限。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. root用户创建test目录并赋予777权限</span></span><br><span class="line"><span class="built_in">mkdir</span> ~ahao/test &amp;&amp; <span class="built_in">chmod</span> 777 ~ahao/test/ &amp;&amp; ll -d ~ahao/test/</span><br><span class="line"><span class="comment"># drwxrwxrwx. 2 root root 6 11月 22 23:23 /home/ahao/test/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. root用户创建file文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; ~ahao/test/file &amp;&amp; ll ~ahao/test/</span><br><span class="line"><span class="comment"># -rw-r--r--. 1 root root 6 11月 22 23:26 file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. ahao用户删除file文件成功, 因为ahao用户对test目录有w写权限</span></span><br><span class="line">su - ahao &amp;&amp; <span class="built_in">rm</span> -rf ~ahao/test/file &amp;&amp; ll ~ahao/test/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. root用户对test目录赋予sticky bit权限</span></span><br><span class="line">su -</span><br><span class="line"><span class="comment"># chmod 0777 ~ahao/test/ # 取消sticky bit, 或chmod o-t ~ahao/test/</span></span><br><span class="line"><span class="built_in">chmod</span> 1777 ~ahao/test/ <span class="comment"># 赋予sticky bit, 或chmod o+t ~ahao/test/</span></span><br><span class="line">ll -d ~ahao/test/</span><br><span class="line">drwxrwxrwt. 2 root root 6 11月 22 23:27 /home/ahao/test/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. root用户创建file文件</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hello&quot;</span> &gt; ~ahao/test/file &amp;&amp; ll ~ahao/test/</span><br><span class="line"><span class="comment"># -rw-r--r--. 1 root root 6 11月 22 23:32 file</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. ahao用户删除file文件失败, 即使ahao用户对test目录有w写权限</span></span><br><span class="line">su - ahao</span><br><span class="line"><span class="built_in">rm</span> -rf ~ahao/test/file</span><br><span class="line"><span class="comment"># rm: 无法删除&quot;/home/ahao/test/file&quot;: 不允许的操作</span></span><br></pre></td></tr></table></figure>
<p>如果不能删除, 那我能不能覆盖掉呢? <code>echo &#39;&#39; &gt; file</code><br>我在<code>Ubuntu</code>尝试了不能, 但是以前在<code>CentOS</code>试过好像可以.</p>
<h1 id="检查系统新增的SUID和SGID文件"><a href="#检查系统新增的SUID和SGID文件" class="headerlink" title="检查系统新增的SUID和SGID文件"></a>检查系统新增的SUID和SGID文件</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 先查找所有拥有SUID(4)和SGID(2)的文件</span></span><br><span class="line">find / -perm -4000 -o -perm -2000 &gt; /tmp/suid.list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 编写Shell脚本</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 2.1 查找所有拥有SUID(4)或SGID(2)的文件, 并保存到临时文件suid.check中</span></span><br><span class="line">find / -perm -4000 -o -perm -2000 &gt; /tmp/suid.check</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> $(<span class="built_in">cat</span> /tmp/suid.check)</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">    <span class="comment"># 2.3 遍历临时文件suid.check中的记录, 和最初查找到的文件/tmp/suid.list进行比较。</span></span><br><span class="line">    grep <span class="variable">$line</span> /tmp/suid.list &gt; /dev/null</span><br><span class="line">    <span class="comment"># 2.4 不存在则写入log文件中</span></span><br><span class="line">    <span class="keyword">if</span> [ <span class="string">&quot;$?&quot;</span> != <span class="string">&quot;0&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$i</span> isn&#x27;t in listfile! &quot;</span> &gt;&gt; /tmp/suid_log_$(<span class="built_in">date</span> +%F)</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"><span class="built_in">rm</span> -rf /tmp/suid.check</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;/tmp/suid_log_<span class="subst">$(date +%F)</span>&quot;</span></span><br><span class="line"><span class="built_in">cat</span> /tmp/suid_log_$(<span class="built_in">date</span> +%F)</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Linux</category>
      </categories>
      <tags>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>dependencyManagement和dependencies的不同</title>
    <url>/posts/differences_between_dependencymanagement_and_dependencies_in_maven.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>随着<code>Spring</code>全家桶越做越大，和其他框架的结合的机会也越来越多，现在做<code>Web</code>基本是起手就是一个<code>Spring</code>。这就会出现版本号冲突的问题，比如新的<code>Spring</code>和旧的<code>Quartz</code>不兼容之类的情况。</p>
<span id="more"></span>

<h1 id="Spring-framework-bom"><a href="#Spring-framework-bom" class="headerlink" title="Spring framework bom"></a>Spring framework bom</h1><p>为了解决这个问题，<code>Spring</code>推出了<a href="https://mvnrepository.com/artifact/org.springframework/spring-framework-bom/4.2.0.RELEASE"><code>spring-framework-bom</code></a>。<code>Spring Boot</code>有对应的<a href="https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-dependencies"><code>spring-boot-dependencies</code></a>。<br>只需要将以下<code>pom.xml</code>加入我们项目的<code>pom.xml</code>，就不用在<code>dependencies</code>标签中写版本号。<code>dependencyManagement</code>会自动帮我们引入版本号。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-framework-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们可以看下<code>spring-framework-bom</code>的源码，可以看到它已经默认为我们填好了版本号。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span> <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-framework-bom<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Framework (Bill of Materials)<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span>Spring Framework (Bill of Materials)<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">        https://github.com/spring-projects/spring-framework</span><br><span class="line">    <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">organization</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring IO<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://projects.spring.io/spring-framework<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">organization</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">licenses</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">license</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>The Apache Software License, Version 2.0<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">url</span>&gt;</span>http://www.apache.org/licenses/LICENSE-2.0.txt<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">distribution</span>&gt;</span>repo<span class="tag">&lt;/<span class="name">distribution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">license</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">licenses</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">developers</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developer</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>jhoeller<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">name</span>&gt;</span>Juergen Hoeller<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">email</span>&gt;</span>jhoeller@pivotal.io<span class="tag">&lt;/<span class="name">email</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">developer</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">developers</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scm</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">connection</span>&gt;</span></span><br><span class="line">            scm:git:git://github.com/spring-projects/spring-framework</span><br><span class="line">        <span class="tag">&lt;/<span class="name">connection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">            scm:git:git://github.com/spring-projects/spring-framework</span><br><span class="line">        <span class="tag">&lt;/<span class="name">developerConnection</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span></span><br><span class="line">            https://github.com/spring-projects/spring-framework</span><br><span class="line">        <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">scm</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">issueManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">system</span>&gt;</span>Jira<span class="tag">&lt;/<span class="name">system</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://jira.springsource.org/browse/SPR<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">issueManagement</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--===================注意这里===================--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-aspects<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-beans<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-context-support<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-expression<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-instrument<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-instrument-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-messaging<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-orm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-oxm<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-tx<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-webmvc-portlet<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--===================注意这里===================--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><code>dependencyManagement</code>是一个版本号管理器，官方说法是<strong>中央依赖版本管理</strong>。<br><code>dependencyManagement</code>子标签中的<code>dependency</code>声明的版本号，可以被引用了该<code>dependencyManagement</code>的<code>pom.xml</code>继承，但是需要在<code>pom.xml</code>中声明<code>dependency</code>而不必声明版本号。<br>简单地说，就是自己的<code>pom.xml</code>不用再写<code>dependencyManagement</code>中拥有的<code>dependency</code>的版本号了，但是要写<code>dependency</code>的<strong>名称</strong>(这里的名称只是形象的说法)</p>
<p><strong>!!注意!!</strong><br><code>dependencyManagement</code>并不会产生继承关系，引用了<code>dependencyManagement</code>的新项目的<code>pom.xml</code>，仍需要<strong>手动声明</strong>引用的<code>dependency</code>，只是不用再写版本号。</p>
<p>如果需要继承的话，就使用<code>parent</code>标签，这里不赘述。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>ahao-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.ahao.core<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://maven.apache.org/guides/introduction/introduction-to-dependency-mechanism.html#Dependency_Management">Apache官方文档 Dependency_Management 小节</a></li>
<li><a href="https://stackoverflow.com/questions/2619598">differences-between-dependencymanagement-and-dependencies-in-maven</a></li>
</ul>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>maven打包war包时出现了pom不存在的jar包</title>
    <url>/posts/maven_will_import_WEB-INF_lib_jar_to_war.html</url>
    <content><![CDATA[<p>标题是有点绕。<br>这几天在搞一个 <code>SpringBoot</code> 的短信项目, 在打包 <code>war</code> 包的时候,<br>发现war包中的 <code>commons-lang</code> 包有两个版本, 一个 <code>1.0.1</code> , 一个 <code>2.6</code> 。<br>在 <code>pom.xml</code> 中我只导入了 <code>2.6</code> 的版本, 那么 <code>1.0.1</code> 的jar包是从哪来的呢?</p>
<span id="more"></span>

<h1 id="先说结论"><a href="#先说结论" class="headerlink" title="先说结论"></a>先说结论</h1><p><code>maven</code> 的 <code>package</code> 命令会把 <code>WEB-INF/lib</code> 中的jar包也打包进war包中。</p>
<h1 id="排错"><a href="#排错" class="headerlink" title="排错"></a>排错</h1><ol>
<li><p>首先先看maven的依赖, 使用的是IDEA。<br>点击 <code>View -&gt; Tool Windows -&gt; Maven Projects</code>, 在右边出现的窗口, 点击 <code>Show Dependencies</code>。<br>点击<code>Alt</code>可以打开放大镜。<br>并没有找到<code>commons-lang 1.0.1</code>。</p>
</li>
<li><p>接下来把<code>pom.xml</code>的依赖全部注释掉, 只留下 <code>spring-boot-starter-web</code><br>运行<code>Hello world</code> 成功。<br>打包, 还是发现了<code>commons-lang 1.0.1</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>手动排除<code>commons-lang</code>, 打包, 还是有<code>commons-lang 1.0.1</code>。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-lang<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>发现war包的<code>commons-lang 1.0.1</code>是在<code>WEB-INF/lib</code>下的<br>于是在<code>src/main/webapp/WEB-INF/lib</code>下, 果然发现了<code>commons-lang 1.0.1</code>的包</p>
</li>
</ol>
<h1 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h1><p><code>maven</code> 的 <code>package</code> 命令会把 <code>WEB-INF/lib</code> 中的jar包也会打包进war包中。</p>
]]></content>
      <categories>
        <category>Maven</category>
      </categories>
      <tags>
        <tag>Maven</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ延迟队列的两种实现方式</title>
    <url>/posts/Two_implementations_of_the_RabbitMQ_delay_queue.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>RabbitMQ</code>是没有延迟队列, 但是我们可以通过<code>TTL</code>和死信队列间接来实现.</p>
<ol>
<li>将<code>Message</code>指定<code>TTL</code>后放入队列中.</li>
<li>等超时后, <code>Message</code>放入死信队列.</li>
<li>死信队列将<code>Message</code>转发到目标队列.</li>
</ol>
<p>很麻烦.<br>幸运的是, <code>RabbitMQ</code>官方提供了一个<code>rabbitmq-delayed-message-exchange</code>延迟消息插件.<br>本文基于<code>Spring Boot AMQP</code>来操作.</p>
<span id="more"></span>

<h1 id="使用官方延迟插件-rabbitmq-delayed-message-exchange"><a href="#使用官方延迟插件-rabbitmq-delayed-message-exchange" class="headerlink" title="使用官方延迟插件 rabbitmq-delayed-message-exchange"></a>使用官方延迟插件 rabbitmq-delayed-message-exchange</h1><p>要求版本 <code> &gt;= 3.5.8</code>.<br><code>GitHub</code>地址: <a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a><br>下载地址: <a href="https://www.rabbitmq.com/community-plugins.html">https://www.rabbitmq.com/community-plugins.html</a></p>
<p>我这里用的是<code>3.6.x</code>的版本.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 下载 plugin</span></span><br><span class="line"><span class="built_in">cd</span> /opt/</span><br><span class="line">wget https://dl.bintray.com/rabbitmq/community-plugins/3.6.x/rabbitmq_delayed_message_exchange/rabbitmq_delayed_message_exchange-20171215-3.6.x.zip</span><br><span class="line">unzip rabbitmq_delayed_message_exchange-20171215-3.6.x.zip </span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 移动到 plugins 文件夹内, 不同操作系统 plugins 位置不同</span></span><br><span class="line"><span class="built_in">cd</span> /usr/lib/rabbitmq/lib/rabbitmq_server-3.6.10/plugins/</span><br><span class="line"><span class="built_in">cp</span> /opt/rabbitmq_delayed_message_exchange-20171215-3.6.x.ez ./</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 启动延时插件</span></span><br><span class="line">rabbitmq-plugins list | grep delayed</span><br><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_delayed_message_exchange</span><br></pre></td></tr></table></figure>

<p>然后再声明一个延迟交换机<code>Exchange</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRabbit</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ahao_delayed_exchange&quot;</span>;</span><br><span class="line">    <span class="meta">@Bean(DELAY_EXCHANGE_NAME)</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        args.put(<span class="string">&quot;x-delayed-type&quot;</span>, <span class="string">&quot;direct&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">CustomExchange</span>(DELAY_EXCHANGE_NAME, <span class="string">&quot;x-delayed-message&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们需要将<code>Queue</code>队列绑定到交换机上</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRabbit</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ahao_queue&quot;</span>;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(QUEUE_NAME);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">binding</span><span class="params">(Queue queue, CustomExchange exchange)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(queue).to(exchange).with(QUEUE_NAME).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>绑定后, 就可以直接发送消息了.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitService</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DELAY_EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ahao_delayed_exchange&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doSendDelay</span><span class="params">(String queueName, Object data, <span class="type">long</span> delayMilliSeconds)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="keyword">if</span>(delayMilliSeconds &gt; <span class="number">0xffffffffL</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;超时过长, 只支持 &lt; 4294967296 的延时值&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">CorrelationData</span> <span class="variable">correlationId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">        rabbitTemplate.convertAndSend(DELAY_EXCHANGE_NAME, queueName, data, message -&gt; &#123;</span><br><span class="line">            <span class="type">MessageProperties</span> <span class="variable">messageProperties</span> <span class="operator">=</span> message.getMessageProperties();</span><br><span class="line">            messageProperties.getHeaders().put(<span class="string">&quot;x-delay&quot;</span>, delayMilliSeconds);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;, correlationId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="坑点1-延时最长为-2-32-1-毫秒"><a href="#坑点1-延时最长为-2-32-1-毫秒" class="headerlink" title="坑点1 延时最长为 2^32-1 毫秒"></a>坑点1 延时最长为 2^32-1 毫秒</h2><p>根据<a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange#performance-impact">官方文档</a>来看, 本插件的延时时长最长为<code>2^32-1</code>毫秒, 也就是<code>0xffffffff</code>毫秒.<br>换算一下, 大约是<code>49</code>天.<br>如果超过<code>2^32-1</code>毫秒, 那么延时值就会溢出, 也就是会立即消费.</p>
<p><a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/issues/122#issuecomment-486385307"><code>Issue#122</code></a>也有提到.<br>这应该是<code>Erlang</code>本身的限制.</p>
<blockquote>
<p>In Erlang a timer can be set up to (2^32)-1 milliseconds in the future</p>
</blockquote>
<h2 id="坑点2-队列需要和延时-Exchange-绑定"><a href="#坑点2-队列需要和延时-Exchange-绑定" class="headerlink" title="坑点2 队列需要和延时 Exchange 绑定"></a>坑点2 队列需要和延时 Exchange 绑定</h2><p>之前以为指定了<code>x-delayed-type</code>为<code>direct</code>, 就可以不用绑定<code>Queue</code>到这个延时<code>Exchange</code>交换机上.<br>结果发的消息接收不到, 还是需要绑定一下.</p>
<h1 id="使用原生死信队列实现延时队列"><a href="#使用原生死信队列实现延时队列" class="headerlink" title="使用原生死信队列实现延时队列"></a>使用原生死信队列实现延时队列</h1><p>原生方法就是利用死信队列.</p>
<ol>
<li>将<code>Message</code>指定<code>TTL</code>后放入队列中.</li>
<li>等超时后, <code>Message</code>放入死信队列.</li>
<li>死信队列将<code>Message</code>转发到目标队列.</li>
</ol>
<p>我们先设计下消息流转流程图<br><img data-src="https://yuml.me/diagram/nofunky;dir:LR/activity/(start)-Msg%3E(delay_exchange)-fanout%3E(delay_queue)-dead%3E(biz_exchange)-%3E%3Ca%3E[key1]-%3E(biz_queue1)-%3E(consumer),%3Ca%3E[key2]-%3E(biz_queue2)-%3E(consumer)-%3E(end)" alt="消息流转流程图"></p>
<ol>
<li>用户发送带着<code>RoutingKey</code>为<code>biz_queue1</code>的一条消息到延时交换机<code>delay_exchange</code>上(注意, 这个延时交换机就是一个普通交换机).</li>
<li>延时交换机<code>delay_exchange</code>将消息<code>fanout</code>到队列<code>delay_queue</code>, 这个队列配置了一堆死信参数.</li>
<li>等待消息在<code>delay_queue</code>超时, 然后将消息转发到该队列的死信交换机<code>biz_exchange</code>上.</li>
<li>因为<code>delay_queue</code>没有指定<code>x-dead-letter-routing-key</code>, 所以使用的还是原来的<code>biz_queue1</code>. 路由到<code>biz_queue1</code>队列上.</li>
<li>延时消费成功.</li>
</ol>
<p>设计完毕开始编码实战. 我们需要初始化交换机<code>Exchange</code>和队列<code>Queue</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableRabbit</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RabbitMQConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">delayExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FanoutExchange</span>(<span class="string">&quot;delay_exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">delayQueue</span><span class="params">()</span> &#123;</span><br><span class="line">        Map&lt;String, Object&gt; args = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        args.put(<span class="string">&quot;x-dead-letter-exchange&quot;</span>, bizExchange().getName()); <span class="comment">// 声明死信交换机</span></span><br><span class="line"><span class="comment">//        args.put(&quot;x-dead-letter-routing-key&quot;, &quot;&quot;);                 // 声明死信路由键</span></span><br><span class="line">        args.put(<span class="string">&quot;x-message-ttl&quot;</span>, <span class="number">10000</span>);                            <span class="comment">// 所有消息的默认超时时间</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;delay_queue&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, args);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">delayBinding</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(delayQueue()).to(delayExchange()).with(delayQueue().getName()).noargs();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">bizExchange</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DirectExchange</span>(<span class="string">&quot;biz_exchange&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bizQueue1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;biz_queue1&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bizBinding1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bizQueue1()).to(bizExchange()).with(bizQueue1().getName()).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">bizQueue2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(<span class="string">&quot;biz_queue2&quot;</span>, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Binding <span class="title function_">bizBinding2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BindingBuilder.bind(bizQueue2()).to(bizExchange()).with(bizQueue2().getName()).noargs();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后写一个单元测试, 我用的<code>Junit5</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectConsumer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;biz_queue1&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object value;</span><br><span class="line">    <span class="meta">@RabbitListener(queuesToDeclare = @Queue(QUEUE_NAME))</span></span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">directQueue</span><span class="params">(String msg)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息接收时间:&quot;</span>+sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">        System.out.println(<span class="string">&quot;接收到的消息:&quot;</span>+msg);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        value = msg;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = &#123;RabbitMQConfig.class, RabbitAutoConfiguration.class, SpringContextHolder.class, DirectConsumer.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectProducerTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DirectConsumer consumer;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Assert.assertNotNull(rabbitTemplate);</span><br><span class="line">        Assert.assertNotNull(consumer);</span><br><span class="line">        </span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送时间:&quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;send()&quot;</span>;</span><br><span class="line"></span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;delay_exchange&quot;</span>, DirectConsumer.QUEUE_NAME, msg, message -&gt; &#123;</span><br><span class="line">            <span class="type">MessageProperties</span> <span class="variable">messageProperties</span> <span class="operator">=</span> message.getMessageProperties();</span><br><span class="line">            messageProperties.setExpiration(<span class="string">&quot;3000&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Assert.assertNull(DirectConsumer.value);</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        Assert.assertEquals(msg, DirectConsumer.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以给队列设置<code>x-message-ttl</code>, 也可以给每条消息设置<code>expiration</code>, <code>RabbitMQ</code>会取两者最小值作为消息过期时间.</p>
<p>用死信队列来实现延迟队列, 只要套多几个死信队列, 就可以绕过官方延时插件的只能延时<code>2^32-1</code>毫秒的<code>bug</code>.<br>但是和官方延时插件一样, 还是得每个队列都绑定到延时交换机上.</p>
<p>并且! 推荐给队列设置<code>x-message-ttl</code>, 而不是给消息设置<code>expiration</code>.</p>
<h2 id="坑点-同一队列的延时时长不一样导致消息阻塞"><a href="#坑点-同一队列的延时时长不一样导致消息阻塞" class="headerlink" title="坑点 同一队列的延时时长不一样导致消息阻塞"></a>坑点 同一队列的延时时长不一样导致消息阻塞</h2><p>我们先看下面这个单元测试, 比起上面那个单元测试, 就是连续发送了两条消息.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringJUnit4ClassRunner.class)</span></span><br><span class="line"><span class="meta">@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.NONE)</span></span><br><span class="line"><span class="meta">@ContextConfiguration(classes = &#123;RabbitMQConfig.class, RabbitAutoConfiguration.class, SpringContextHolder.class, DirectConsumer.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DirectProducerTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RabbitTemplate rabbitTemplate;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DirectConsumer consumer;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendFailure</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        Assert.assertNotNull(rabbitTemplate);</span><br><span class="line">        Assert.assertNotNull(consumer);</span><br><span class="line">        </span><br><span class="line">        <span class="type">SimpleDateFormat</span> <span class="variable">sdf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;消息发送时间:&quot;</span> + sdf.format(<span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">msg1</span> <span class="operator">=</span> <span class="string">&quot;sendFailure(1)&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;delay_exchange&quot;</span>, DirectConsumer.QUEUE_NAME, msg1, message -&gt; &#123;</span><br><span class="line">            <span class="type">MessageProperties</span> <span class="variable">messageProperties</span> <span class="operator">=</span> message.getMessageProperties();</span><br><span class="line">            messageProperties.setExpiration(<span class="string">&quot;1000000&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg2</span> <span class="operator">=</span> <span class="string">&quot;sendFailure(2)&quot;</span>;</span><br><span class="line">        rabbitTemplate.convertAndSend(<span class="string">&quot;delay_exchange&quot;</span>, DirectConsumer.QUEUE_NAME, msg2, message -&gt; &#123;</span><br><span class="line">            <span class="type">MessageProperties</span> <span class="variable">messageProperties</span> <span class="operator">=</span> message.getMessageProperties();</span><br><span class="line">            messageProperties.setExpiration(<span class="string">&quot;3000&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Assert.assertNull(DirectConsumer.value);</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        Assert.assertNull(msg, DirectConsumer.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行后可以发现, <code>5000</code>毫秒后, 消费者仍然不能接受到<code>sendFailure(2)</code>这条消息.<br>因为消息队列是先进先出的, 当第一条消息没有被消费, 后面的消息也会阻塞不能消费.</p>
<p>所以推荐还是使用给队列设置<code>x-message-ttl</code>的形式来设置延时时长. 当然, 官方延时插件就没这个问题了.</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>使用官方插件</p>
<ul>
<li>优点: <ol>
<li>使用简单</li>
<li>不会出现因为前一条消息没有消费, 导致后面的消息阻塞的情况</li>
</ol>
</li>
<li>缺点:<ol>
<li>延时时长不能超过<code>2^32-1</code>毫秒, 大约<code>49</code>天.</li>
</ol>
</li>
</ul>
<p>使用原生死信队列</p>
<ul>
<li>优点:<ol>
<li>使用死信队列套死信队列, 可以突破<code>2^32-1</code>毫秒的官方插件限制.</li>
</ol>
</li>
<li>缺点:<ol>
<li>实现复杂.</li>
<li>如果给每条消息设置<code>expiration</code>, 则前一条消息会阻塞后一条消息.</li>
</ol>
</li>
</ul>
<p>然后我写了个工具类<a href="https://github.com/Ahaochan/ahao-common-utils/blob/master/src/main/java/com/ahao/util/spring/mq/RabbitMQHelper.java"><code>RabbitMQHelper</code></a>可以拿来用下.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.lbanyan.com/rabbitmq_delay/">RabbitMQ 延迟队列插件 x-delay Bug</a></li>
<li><a href="https://my.oschina.net/10000000000/blog/1626278">springboot rabbitmq 之死信队列（延迟消费消息）</a></li>
<li><a href="https://blog.csdn.net/qq_15071263/article/details/89636161">通过RabbitMQ 死信队列实现延迟MQ消息，消息延迟，MQ延迟队列</a></li>
</ul>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ概念入门</title>
    <url>/posts/Getting_started_with_RabbitMQ.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>RabbitMQ</code>是一个<code>Erlang</code>实现的开源消息中间件, 实现了<code>Advanced Message Queuing Protocol(AMQP)</code>协议.<br><code>AMQP</code>协议是一个抽象协议, 定义了一系列的接口, 而<code>RabbitMQ</code>等消息中间件实现了这些接口.</p>
<p>本文使用原生<code>RabbitMQ</code>的<code>API</code>来进行调用, 不使用<code>Spring AMQP</code>.</p>
<span id="more"></span>

<h1 id="AMQP核心概念"><a href="#AMQP核心概念" class="headerlink" title="AMQP核心概念"></a>AMQP核心概念</h1><p><code>Server</code>: 又称为<code>Broker</code>, 其实就是<code>RabbitMQ</code>的服务端, 接收客户端的连接, 实现<code>AMQP</code>协议.<br><code>Connection</code>: 连接, 应用程序与<code>Broker</code>的连接.<br><code>Channel</code>: 网络信道, 生产消费消息都在<code>Channel</code>进行, 一个客户端可以建立多个<code>Channel</code>.</p>
<p><code>Message</code>: 消息, 应用程序和<code>Broker</code>之间传送的数据, 由<code>Properties</code>属性和<code>Body</code>消息体组成.</p>
<p><code>Virtual Host</code>: 虚拟地址, 用于逻辑隔离. 一般用于区分<code>dev</code>环境, <code>test</code>环境.<br><code>Exchange</code>: 交换机, 接收消息, 根据消息的路由<code>Key</code>和绑定规则, 投递到对应的<code>Queue</code>队列中.<br><code>Binding</code>: <code>Exchange</code>交换机和<code>Queue</code>队列之间的绑定规则.<br><code>Queue</code>: 队列, 保存消息并转发给消费者.</p>
<h1 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a>Broker</h1><p><code>Broker</code>服务端直接用<code>docker</code>启动就好了, 使用默认参数.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker run -it --<span class="built_in">rm</span> --name rabbitmq -p 5672:5672 -p 15672:15672 rabbitmq:3-management</span><br></pre></td></tr></table></figure>
<p>然后访问<code>http://虚拟机IP:15672</code>.<br>除了单节点的启动, <code>RabbitMQ</code>还支持集群部署.</p>
<h1 id="Connection、Channel"><a href="#Connection、Channel" class="headerlink" title="Connection、Channel"></a>Connection、Channel</h1><p>接下来是<code>Connection</code>和<code>Channel</code>, 和数据库连接类似, 我们可以对比下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mq</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 建立连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 获取连接, 获取 Channel</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">             <span class="type">Channel</span> <span class="variable">channel1</span> <span class="operator">=</span> connection.createChannel();</span><br><span class="line">             <span class="type">Channel</span> <span class="variable">channel2</span> <span class="operator">=</span> connection.createChannel();) &#123;</span><br><span class="line">            <span class="comment">// 3. 使用 Channel 创建 Exchange、Queue, 生产消息</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">db</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 获取连接, 获取 Statement</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(url, username, password);</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">statement1</span> <span class="operator">=</span> connection.prepareStatement(SQL);</span><br><span class="line">             <span class="type">PreparedStatement</span> <span class="variable">statement2</span> <span class="operator">=</span> connection.prepareStatement(SQL);) &#123;</span><br><span class="line">            <span class="comment">// 2. 执行语句    </span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般一个应用程序共享一个<code>Connection</code>, 每个线程创建自己的<code>Channel</code>.<br>所有的操作, 包括<code>Exchange</code>、<code>Queue</code>的创建绑定, 消息的生产消费, 都是在<code>Channel</code>上执行的.</p>
<img data-src="/images/RabbitMQ%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8_01.png" class="">

<h1 id="Virtual-Host、Exchange、Binding、Queue"><a href="#Virtual-Host、Exchange、Binding、Queue" class="headerlink" title="Virtual Host、Exchange、Binding、Queue"></a>Virtual Host、Exchange、Binding、Queue</h1><img data-src="/images/RabbitMQ%E6%A6%82%E5%BF%B5%E5%85%A5%E9%97%A8_02.png" class="">
<p><code>Virtual Host</code>用来区分<code>dev</code>环境和<code>test</code>环境, 避免两个环境的数据混淆在一起.</p>
<p>从图中可以看到, 生产者只管投递到<code>Exchange</code>上, 消费者也只管从<code>Queue</code>消费消息, 其中它们是怎么路由的, 生产者和消费者不需要关心.<br>而<code>Exchange</code>和<code>Queue</code>之间的路由规则, 就是根据<code>Message</code>消息提供的<code>RoutingKey</code>, 以及<code>Exchange</code>和<code>Queue</code>之间的<code>BindingKey</code>, 两者匹配上, 路由成功就投递到<code>Queue</code>队列上.</p>
<h1 id="Demo-例子"><a href="#Demo-例子" class="headerlink" title="Demo 例子"></a>Demo 例子</h1><p>概念讲完, 这里提供简单的一个<a href="https://github.com/Ahaochan/project/blob/master/ahao-spring-boot-rabbitmq/src/test/java/com/ahao/spring/boot/rabbitmq/NativeTest.java">单元测试</a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NativeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">EXCHANGE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ahao-exchange&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ROUTING_KEY</span> <span class="operator">=</span> <span class="string">&quot;ahao-routing-key&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">QUEUE_NAME</span> <span class="operator">=</span> <span class="string">&quot;ahao-queue&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">producer</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 建立连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="built_in">this</span>.initFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 获取连接, 获取 Channel</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">             <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建 Exchange 和 Queue 并绑定</span></span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">            channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, ROUTING_KEY, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 发送消息</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;现在时间&quot;</span>+ LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="line">            channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumer</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 1. 建立连接工厂</span></span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="built_in">this</span>.initFactory();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 获取连接, 获取 Channel</span></span><br><span class="line">        <span class="keyword">try</span> (<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> factory.newConnection();</span><br><span class="line">             <span class="type">Channel</span> <span class="variable">channel</span> <span class="operator">=</span> connection.createChannel();) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 创建 Exchange 和 Queue 并绑定</span></span><br><span class="line">            channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT);</span><br><span class="line">            channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">            channel.queueBind(QUEUE_NAME, EXCHANGE_NAME, ROUTING_KEY, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 4. 消费消息</span></span><br><span class="line">            <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">            channel.basicQos(<span class="number">64</span>);</span><br><span class="line">            channel.basicConsume(QUEUE_NAME, <span class="literal">true</span>, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;接受到:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                    latch.countDown();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5. 等待消息消费后, 再关闭资源</span></span><br><span class="line">            latch.await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> ConnectionFactory <span class="title function_">initFactory</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">ConnectionFactory</span> <span class="variable">factory</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConnectionFactory</span>();</span><br><span class="line">        factory.setHost(<span class="string">&quot;MQ地址&quot;</span>);</span><br><span class="line">        factory.setPort(<span class="number">5672</span>);</span><br><span class="line">        factory.setVirtualHost(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        factory.setUsername(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        factory.setPassword(<span class="string">&quot;guest&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> factory;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>RabbitMQ消息的可靠性投递</title>
    <url>/posts/How_to_ensure_the_reliable_delivery_of_RabbitMQ.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>消息中间件<code>MQ</code>主要的工作流程如下</p>
<ol>
<li>生产端<code>Producer</code>发送消息给消息中间件<code>MQ</code></li>
<li>消息中间件<code>MQ</code>接收到消息, 告诉生产者<code>Producer</code>消息已经收到</li>
<li>消息中间件<code>MQ</code>将消息路由<code>Routing</code>后, 投递给消费者<code>Consumer</code></li>
<li>消费者告诉<code>MQ</code>消息是否消费成功</li>
</ol>
<img data-src="/images/RabbitMQ%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92_01.png" class="">

<span id="more"></span>

<p>但是, 现实世界是不可能如此理想的. 如果在某个阶段发生了异常.</p>
<p>比如消息中间件<code>MQ</code>接收到消息后, 所在的服务器重启了, 没能告诉生产者<code>Producer</code>消息接收成功, 也没能将消息投递给消费者<code>Consumer</code>, 这时候就应该让生产者<code>Producer</code>重新投递.<br>比如发生了重放攻击, 生产者<code>Producer</code>连续发送了两条相同的消息, 那么消费者<code>Consumer</code>应该判断此消息是否消费过, 不应该重复消费.</p>
<p>业界有两种方案保证消息的可靠性投递</p>
<ol>
<li>消息落库, 对消息状态进行打标</li>
<li>消息延迟投递, 做二次确认, 回调检查</li>
</ol>
<p>两种方案都需要做消息的落库处理, 这里提供一个简单的消息表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> rabbitmq (</span><br><span class="line">`id`          <span class="type">bigint</span>(<span class="number">20</span>) unsigned <span class="keyword">not</span> <span class="keyword">null</span> auto_increment comment <span class="string">&#x27;消息ID&#x27;</span>,</span><br><span class="line">`msg`         <span class="type">varchar</span>(<span class="number">4096</span>) <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;消息&#x27;</span>,</span><br><span class="line">`status`      tinyint unsigned <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;状态, 0:未投递, 1:已投递, 2:已确认, 3:已消费, 4: 失败&#x27;</span>,</span><br><span class="line">`retry_count` tinyint unsigned <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">default</span> <span class="number">0</span> comment <span class="string">&#x27;重试次数&#x27;</span>,</span><br><span class="line">`create_time` datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;创建时间&#x27;</span>,</span><br><span class="line">`update_time` datetime <span class="keyword">not</span> <span class="keyword">null</span> comment <span class="string">&#x27;更新时间&#x27;</span>,</span><br><span class="line"><span class="keyword">primary</span> key (`id`)</span><br><span class="line">) engine <span class="operator">=</span> InnoDB <span class="keyword">default</span> charset <span class="operator">=</span> utf8mb4 comment<span class="operator">=</span><span class="string">&#x27;消息表&#x27;</span>;</span><br></pre></td></tr></table></figure>

<h1 id="方案一-消息落库-对状态打标"><a href="#方案一-消息落库-对状态打标" class="headerlink" title="方案一: 消息落库, 对状态打标"></a>方案一: 消息落库, 对状态打标</h1><p>以电商下单为场景</p>
<img data-src="/images/RabbitMQ%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92_02.png" class="">
<p>主要的步骤如图</p>
<ol>
<li>下单请求<code>Request</code>发送到订单系统<code>Order Center</code></li>
<li>将订单数据落库<code>DB</code>, 将消息落库<code>DB</code>, 状态为<code>1 已投递</code></li>
<li>发送消息给消息中间件<code>MQ</code></li>
<li>消息中间件<code>MQ</code>告诉订单系统<code>Order Center</code>消息接收到了</li>
<li>订单系统<code>Order Center</code>接收到消息中间件<code>MQ</code>的确认信息<code>confirm</code>, 更新<code>DB</code>中的消息状态为<code>2 已确认</code></li>
<li>消息中间件<code>MQ</code>将消息投递给结算系统<code>Settlement-Center</code></li>
<li>结算系统<code>Settlement-Center</code>收到消息, 更新<code>DB</code>中的消息状态为<code>3 已消费</code></li>
<li>分布式定时任务扫描那些超过一天还没消费的消息, 重新投递</li>
</ol>
<p>这算是一个比较完整的解决方案, 不管哪个步骤出问题, 只要状态没有流转到<code>3 已消费</code>, 那么分布式定时任务就会抓取消息, 重新投递, 超过特定次数就不再自动投递.<br>这里就会带来几个问题.</p>
<ol>
<li>订单落库和消息落库, 是否要加事务?</li>
<li>定时任务必须要是分布式的.</li>
</ol>
<h2 id="保证生产者和消息中间件的之间的可靠性投递"><a href="#保证生产者和消息中间件的之间的可靠性投递" class="headerlink" title="保证生产者和消息中间件的之间的可靠性投递"></a>保证生产者和消息中间件的之间的可靠性投递</h2><p>订单落库和消息落库, 我们可以看成是两次<code>insert</code>写库操作, 如果订单库和消息库在同一个<code>DB</code>实例下, 直接开启本地事务保存即可.<br>但是如果订单库和消息库在不同的<code>DB</code>实例下, 我们要使用分布式事务吗? 业务是否能接受分布式事务带来的性能损耗吗?</p>
<p>如果体量小的项目, 用分布式事务是可以的, 但如果碰到了海量请求的情况下. 我们也可以通过快速失败的方式, 来保证两个消息落库成功.<br>但是如果遇到更大的流量请求, 就要通过方案二来解决了.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">order</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 1. 生成订单号</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 订单落库</span></span><br><span class="line">        <span class="comment">// 2. 消息落库</span></span><br><span class="line">        <span class="comment">// 3. 发送MQ</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="comment">// 4. 根据订单号做回滚操作 或者 根据定时任务扫描失败的记录</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;下单失败&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果订单落库失败, 或着消息落库失败, 那么就直接返回客户端下单失败的提醒. 后续定时任务轮询, 根据业务做回滚操作.<br>如果订单落库成功, 消息落库成功, 但是发送消息失败, 此时消息库应该有一条消息记录, 状态是<code>1:已投递</code>, 后续定时任务轮询重新投递.<br>如果订单落库成功, 消息落库成功, 消息发送成功, 但是**<code>MQ</code>想要告诉生产者发送成功**的这个动作失败了, 消息记录的状态是<code>1:已投递</code>, 后续定时任务轮询重新投递.<br>如果上述的操作都成功了, 那么消息的状态变更为<code>2:已确认</code>, 生产者和消费者之间的可靠性投递就算保证了.</p>
<p>那么怎么判断消息发送成功呢?<br><code>RabbitMQ</code>有两套机制保证, <code>Confirm</code>机制和<code>Return</code>机制.</p>
<h3 id="Confirm-确认消息"><a href="#Confirm-确认消息" class="headerlink" title="Confirm 确认消息"></a>Confirm 确认消息</h3><p><img data-src="https://yuml.me/diagram/nofunky/class/[%E7%94%9F%E4%BA%A7%E8%80%85]-1.%E6%B6%88%E6%81%AF%3E[%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6],[%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6]-2.Confirm%3E[%E7%94%9F%E4%BA%A7%E8%80%85]" alt="Confirm消息确认机制"></p>
<ol>
<li>生产者发送消息给消息中间件</li>
<li>消息中间件应答, 发送<code>Confirm</code>消息给生产者, 告诉生产者发送成功与否.</li>
</ol>
<p><code>RabbitMQ</code>通过调用<code>channel.confirmSelect()</code>开启<code>Confirm</code>消息确认机制.</p>
<h4 id="普通confirm"><a href="#普通confirm" class="headerlink" title="普通confirm"></a>普通confirm</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">simpleConfirm</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1. 开启确认模式</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="comment">// 2. 发送消息</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;deliveryTag: &quot;</span> + deliveryTag + <span class="string">&quot;, 现在时间&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="comment">// 3. 同步 confirm</span></span><br><span class="line">        <span class="keyword">if</span> (!channel.waitForConfirms()) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;消息[&quot;</span> + msg + <span class="string">&quot;]发送失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 4. 批量同步 confirm</span></span><br><span class="line">    <span class="comment">// if (!channel.waitForConfirms()) &#123;</span></span><br><span class="line">    <span class="comment">//     System.out.println(&quot;消息[&quot; + msg + &quot;]发送失败&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Channel</code>提供了一个<code>waitForConfirms</code>方法. 会阻塞等待服务器端<code>confirm</code>.</p>
<blockquote>
<p>Wait until all messages published since the last call have been either ack’d or nack’d by the broker</p>
</blockquote>
<p><code>waitForConfirms</code>还支持批量<code>confirm</code>, 放在<code>for</code>循环外面即可.<br>当超时或返回<code>false</code>时, 需要自己编写业务代码重发消息.</p>
<h4 id="异步confirm"><a href="#异步confirm" class="headerlink" title="异步confirm"></a>异步confirm</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">asyncConfirm</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1. 开启确认模式</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">    TreeSet&lt;Long&gt; confirmSet = <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;(); <span class="comment">// 记录未确认的 deliveryTag</span></span><br><span class="line"></span><br><span class="line">    channel.confirmSelect();</span><br><span class="line">    <span class="comment">// 添加异步监听器</span></span><br><span class="line">    channel.addConfirmListener(<span class="keyword">new</span> <span class="title class_">ConfirmListener</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleAck</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(multiple) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;消息唯一标识:&quot;</span> + deliveryTag + <span class="string">&quot; 之前的消息都 ACK&quot;</span>);</span><br><span class="line">                    confirmSet.headSet(deliveryTag-<span class="number">1</span>).clear();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;消息唯一标识:&quot;</span> + deliveryTag + <span class="string">&quot; 消息 ACK&quot;</span>);</span><br><span class="line">                    confirmSet.remove(deliveryTag);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleNack</span><span class="params">(<span class="type">long</span> deliveryTag, <span class="type">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(multiple) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;消息唯一标识:&quot;</span> + deliveryTag + <span class="string">&quot; 之前的消息都 NACK&quot;</span>);</span><br><span class="line">                    confirmSet.headSet(deliveryTag-<span class="number">1</span>).clear();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;消息唯一标识:&quot;</span> + deliveryTag + <span class="string">&quot; 消息 NACK&quot;</span>);</span><br><span class="line">                    confirmSet.remove(deliveryTag);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(confirmSet.contains(deliveryTag)) &#123;</span><br><span class="line">                    <span class="comment">// 从数据库捞记录重发消息</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                latch.countDown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 发送消息</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> channel.getNextPublishSeqNo();</span><br><span class="line">        <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;deliveryTag: &quot;</span>+deliveryTag+<span class="string">&quot;, 现在时间&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="line">        channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        confirmSet.add(deliveryTag);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>); <span class="comment">// 延迟, 保证 multiple 为 false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    latch.await();</span><br><span class="line">    Assertions.assertTrue(confirmSet.isEmpty());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当生产者接受到<code>confirm</code>通知时, 会回调监听器的两个方法, <code>handleAck</code>和<code>handleNack</code>.</p>
<ol>
<li><code>handleAck</code>表示成功处理的消息</li>
<li><code>handleNack</code>表示<code>Broker</code>丢失了消息. <strong>但是</strong>, 即使返回<code>Nack</code>, 也有可能已经将消息投递给了消费者.</li>
</ol>
<p><code>handleAck</code>和<code>handleNack</code>有两个参数, 消息标识<code>deliveryTag</code>和批量标识<code>multiple</code>.</p>
<ol>
<li><code>deliveryTag</code>用于表示一个<code>Channel</code>下的消息的唯一<code>Id</code>, 可以通过<code>channel.getNextPublishSeqNo()</code>来获取接下来要发送的消息的<code>deliveryTag</code>.</li>
<li><code>multiple</code>用于表示当前的<code>ACK</code>或<code>NACK</code>是否批量操作, 如果是批量操作, 那么小于<code>deliveryTag</code>的消息都要处理.</li>
</ol>
<h4 id="Spring-Boot-实现-confirm"><a href="#Spring-Boot-实现-confirm" class="headerlink" title="Spring Boot 实现 confirm"></a>Spring Boot 实现 confirm</h4><p>首先要在配置文件里面开启<code>confirm</code>模式</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-confirm-type:</span> <span class="string">correlated</span> <span class="comment"># confirm模式</span></span><br></pre></td></tr></table></figure>
<p>然后设置<code>ConfirmCallback</code>, 多线程跑一下.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">confirm</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;sendString()&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">    rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收: &quot;</span> + correlationData + <span class="string">&quot;, ack:[&quot;</span> + ack + <span class="string">&quot;], cause:[&quot;</span> + cause + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 不能在这里设置 ConfirmCallback</span></span><br><span class="line">            <span class="type">CorrelationData</span> <span class="variable">correlationId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">            System.out.println(<span class="string">&quot;发送:&quot;</span> + msg + <span class="string">&quot;, correlationId: &quot;</span> + correlationId);</span><br><span class="line">            rabbitTemplate.convertAndSend(DirectConsumer.QUEUE_NAME, (Object) msg, correlationId);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> latch.await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    Assertions.assertTrue(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一点需要注意下, 一个<code>RabbitTemplate</code>只能有一个<code>ConfirmCallback</code>. 这里看下源码.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.amqp.rabbit.core.RabbitTemplate#setConfirmCallback</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setConfirmCallback</span><span class="params">(ConfirmCallback confirmCallback)</span> &#123;</span><br><span class="line">    Assert.state(<span class="built_in">this</span>.confirmCallback == <span class="literal">null</span> || <span class="built_in">this</span>.confirmCallback == confirmCallback, <span class="string">&quot;Only one ConfirmCallback is supported by each RabbitTemplate&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.confirmCallback = confirmCallback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果业务要求需要对不同的生产者执行不同的<code>ConfirmCallback</code>逻辑, 那么再应该<code>new</code>一个<code>RabbitTemplate</code>.</p>
<h3 id="Return-不可达消息"><a href="#Return-不可达消息" class="headerlink" title="Return 不可达消息"></a>Return 不可达消息</h3><p><img data-src="https://yuml.me/diagram/nofunky/class/[%E7%94%9F%E4%BA%A7%E8%80%85]-1.%E6%B6%88%E6%81%AF%3E[%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6],[%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6]-2.%E6%B2%A1%E6%89%BE%E5%88%B0%3E[%E7%94%9F%E4%BA%A7%E8%80%85]" alt="Return不可达消息"></p>
<blockquote>
<p><a href="https://www.rabbitmq.com/confirms.html">https://www.rabbitmq.com/confirms.html</a><br>For unroutable messages, the broker will issue a confirm once the exchange verifies a message won’t route to any queue (returns an empty list of queues).<br>If the message is also published as mandatory, the basic.return is sent to the client before basic.ack.<br>The same is true for negative acknowledgements (basic.nack).</p>
</blockquote>
<p>当生产者生产一条消息, 投递到<code>MQ</code>消息中间件中, 但是<code>MQ</code>消息中间件判定投递失败<code>unroutable</code>, 比如没有对应的路由<code>Key</code>, 就会触发<code>return</code>机制.<br>在生产消息时, 如果指定<code>Mandatory</code>是<code>true</code>, 则监听器会接收到路由不可达的消息, 交由<code>ReturnListener</code>进行后续处理. 如果为false, 那么<code>MQ</code>消息中间件会自动删除这条消息.</p>
<h4 id="原生-API-方式"><a href="#原生-API-方式" class="headerlink" title="原生 API 方式"></a>原生 API 方式</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">_return</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="comment">// 1. 开启 return</span></span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">mandatory</span> <span class="operator">=</span> <span class="literal">true</span>; <span class="comment">// true监听不可达消息, false则自动删除消息</span></span><br><span class="line"></span><br><span class="line">    channel.addReturnListener((replyCode, replyText, exchange, routingKey, properties, body) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;replyCode:[&quot;</span> + replyCode + <span class="string">&quot;], replyText:[&quot;</span> + replyText + <span class="string">&quot;], exchange:[&quot;</span> + exchange + <span class="string">&quot;], routingKey:[&quot;</span> + routingKey + <span class="string">&quot;], BasicProperties:[&quot;</span> + properties + <span class="string">&quot;], body:[&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body, StandardCharsets.UTF_8) + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 发送消息</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">deliveryTag</span> <span class="operator">=</span> channel.getNextPublishSeqNo();</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;deliveryTag: &quot;</span> + deliveryTag + <span class="string">&quot;, 现在时间&quot;</span> + LocalDateTime.now().format(DateTimeFormatter.ofPattern(<span class="string">&quot;yyyy-MM-dd hh:mm:ss&quot;</span>));</span><br><span class="line">    channel.basicPublish(EXCHANGE_NAME, <span class="string">&quot;NULL_KEY&quot;</span>, mandatory, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">    <span class="comment">// channel.basicPublish(&quot;NULL_EXCHANGE&quot;, ROUTING_KEY, mandatory, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes(StandardCharsets.UTF_8));</span></span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> latch.await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    Assertions.assertTrue(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上, 如果传递一个未声明的<code>Exchange</code>过去, 不会触发<code>return</code>. 而传递不可路由的<code>RoutingKey</code>, 则可以触发<code>return</code>.</p>
<h4 id="Spring-Boot-实现-return"><a href="#Spring-Boot-实现-return" class="headerlink" title="Spring Boot 实现 return"></a>Spring Boot 实现 return</h4><p>首先要在配置文件里面开启<code>return</code>模式</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">publisher-returns:</span> <span class="literal">true</span> <span class="comment"># return机制</span></span><br><span class="line">    <span class="attr">template:</span></span><br><span class="line">      <span class="attr">mandatory:</span> <span class="literal">true</span> <span class="comment"># 与 return 机制结合配置次属性</span></span><br></pre></td></tr></table></figure>
<p>然后设置<code>ReturnCallback</code>, 多线程跑一下.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">_return</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> <span class="string">&quot;sendString()&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(size);</span><br><span class="line">    rabbitTemplate.setReturnCallback((message, replyCode, replyText, exchange, routingKey) -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;接收: &quot;</span> + message + <span class="string">&quot;, replyCode:[&quot;</span> + replyCode + <span class="string">&quot;], replyText:[&quot;</span> + replyText + <span class="string">&quot;], exchange:[&quot;</span> + exchange + <span class="string">&quot;], routingKey:[&quot;</span> + routingKey + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// 不能在这里设置 ReturnCallback</span></span><br><span class="line">            <span class="type">CorrelationData</span> <span class="variable">correlationId</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorrelationData</span>(UUID.randomUUID().toString());</span><br><span class="line">            System.out.println(<span class="string">&quot;发送:&quot;</span> + msg + <span class="string">&quot;, correlationId: &quot;</span> + correlationId);</span><br><span class="line">            rabbitTemplate.convertAndSend(<span class="string">&quot;UNKNOWN&quot;</span>, (Object) msg, correlationId);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">success</span> <span class="operator">=</span> latch.await(<span class="number">10</span>, TimeUnit.SECONDS);</span><br><span class="line">    Assertions.assertTrue(success);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一点需要注意下, 和<code>Callback</code>一样, 一个<code>RabbitTemplate</code>只能有一个<code>ReturnCallback</code>. 这里看下源码.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.amqp.rabbit.core.RabbitTemplate#setReturnCallback</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setReturnCallback</span><span class="params">(ReturnCallback returnCallback)</span> &#123;</span><br><span class="line">    Assert.state(<span class="built_in">this</span>.returnCallback == <span class="literal">null</span> || <span class="built_in">this</span>.returnCallback == returnCallback, <span class="string">&quot;Only one ReturnCallback is supported by each RabbitTemplate&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.returnCallback = returnCallback;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果业务要求需要对不同的生产者执行不同的<code>ReturnCallback</code>逻辑, 那么再应该<code>new</code>一个<code>RabbitTemplate</code>.</p>
<h3 id="我们需要判断消息发送成功吗"><a href="#我们需要判断消息发送成功吗" class="headerlink" title="我们需要判断消息发送成功吗?"></a>我们需要判断消息发送成功吗?</h3><p>如果我们只管投递消息, 不管是否投递成功, 会有什么情况?<br>投递成功当然是最好的, 投递失败的话, 订单状态会一直处于<code>1:已投递</code>, 而不会变成<code>2:已确认</code>.<br>这样的话, 定时任务扫描到这条处于<code>1:已投递</code>的消息, 就会重新发送.</p>
<p>看起来似乎用不用<code>confirm</code>和<code>return</code>都可以保证消息投递成功了.<br>我能想象到使用<code>confirm</code>和<code>return</code>的业务场景有两种情况</p>
<ol>
<li>投递失败时, 尽快重新投递, 不等定时任务扫描.</li>
<li>监控投递流程, 单位时间内投递失败消息超过一定数量就报警.</li>
</ol>
<h2 id="保证消息中间件的持久化存储-避免消息丢失"><a href="#保证消息中间件的持久化存储-避免消息丢失" class="headerlink" title="保证消息中间件的持久化存储, 避免消息丢失"></a>保证消息中间件的持久化存储, 避免消息丢失</h2><p>经过上面的操作, 消息已经存储到消息中间件了. 为了保证消息不丢失, 消息中间件应该将消息做持久化处理.<br>否则当消息中间件宕机的时候, 在内存中的消息就会丢失.</p>
<p><code>RabbitMQ</code>可持久化的东西有三样, <code>Exchange</code>、<code>Queue</code>、消息.<br>持久化也很简单, 只要调用<code>API</code>传参即可.</p>
<h3 id="原生-API-方式-1"><a href="#原生-API-方式-1" class="headerlink" title="原生 API 方式"></a>原生 API 方式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">create</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="comment">// Exchange.DeclareOk exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments);</span></span><br><span class="line">    channel.exchangeDeclare(EXCHANGE_NAME, BuiltinExchangeType.DIRECT, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Queue.DeclareOk queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments) throws IOException;</span></span><br><span class="line">    channel.queueDeclare(QUEUE_NAME, <span class="literal">true</span>, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// public BasicProperties(String contentType, String contentEncoding, Map&lt;String,Object&gt; headers, Integer deliveryMode, </span></span><br><span class="line">    <span class="comment">//                          Integer priority, String correlationId, String replyTo, String expiration, String messageId,</span></span><br><span class="line">    <span class="comment">//                          Date timestamp, String type, String userId, String appId, String clusterId)</span></span><br><span class="line">    <span class="comment">// new BasicProperties(&quot;text/plain&quot;, null, null, 2, 0, null, null, null, null, null, null, null, null, null)</span></span><br><span class="line">    channel.basicPublish(EXCHANGE_NAME, ROUTING_KEY, MessageProperties.PERSISTENT_TEXT_PLAIN, msg.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>Exchange</code>和<code>Queue</code>的持久化只要在声明的时候, 指定<code>durable</code>为<code>true</code>即可.<br>而消息的持久化, 需要在发送消息的时候, 指定<code>BasicProperties</code>属性, 将<code>deliveryMode</code>设置为<code>2</code>持久化.</p>
<h3 id="Spring-Boot-实现"><a href="#Spring-Boot-实现" class="headerlink" title="Spring Boot 实现"></a>Spring Boot 实现</h3><p><code>Spring Boot</code>可以通过使用<code>Bean</code>声明<code>Exchange</code>和<code>Queue</code>来实现持久化.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyConfig</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">durable</span> <span class="operator">=</span> <span class="literal">true</span>; <span class="comment">// 持久化</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Exchange <span class="title function_">exchange</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TopicExchange</span>(EXCHANGE_NAME, durable, <span class="literal">false</span>, <span class="literal">null</span>); &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Queue <span class="title function_">queue</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Queue</span>(QUEUE_NAME, durable, <span class="literal">false</span>, <span class="literal">false</span>, <span class="literal">null</span>); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也可以使用注解的形式声明<code>Exchange</code>和<code>Queue</code>实现持久化.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitListener(bindings = @QueueBinding(key = &quot;#&quot;,</span></span><br><span class="line"><span class="meta">            exchange = @Exchange(type = ExchangeTypes.TOPIC, name = EXCHANGE_NAME, durable = &quot;true&quot;),</span></span><br><span class="line"><span class="meta">            value = @Queue(name = QUEUE_NAME, durable = &quot;true&quot;)))</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumer</span><span class="params">(<span class="meta">@Payload</span> String msg, Channel channel, <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="type">long</span> tag,</span></span><br><span class="line"><span class="params">                         <span class="meta">@Headers</span> Map&lt;String, Object&gt; header)</span> &#123;</span><br><span class="line">        <span class="comment">// 消费消息</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息的持久化也是在发消息时通过指定<code>MessageProperties</code>实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String exchange, String routingKey, String msg)</span> &#123;</span><br><span class="line">    <span class="type">MessageProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageProperties</span>();</span><br><span class="line">    properties.setDeliveryMode(MessageDeliveryMode.PERSISTENT); <span class="comment">// 指定持久化消息</span></span><br><span class="line">    </span><br><span class="line">    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> MessageBuilder.withBody(msg.getBytes(StandardCharsets.UTF_8)).andProperties(properties).build();</span><br><span class="line">    rabbitTemplate.send(exchange, routingKey, message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="保证消息中间件的消费可靠性"><a href="#保证消息中间件的消费可靠性" class="headerlink" title="保证消息中间件的消费可靠性"></a>保证消息中间件的消费可靠性</h2><p><code>RabbitMQ</code>要保证消息消费的可靠性, 就必须开启手动<code>ACK</code>.<br>默认情况下, 消费者是开启自动<code>ACK</code>的. 也就是说一条消息过来, 不管有没有执行成功, 都会告诉<code>RabbitMQ</code>消费成功. 如果出现异常, 也告诉<code>RabbitMQ</code>消费成功. 这明显是不合理的.</p>
<h3 id="原生-API-手动-ACK"><a href="#原生-API-手动-ACK" class="headerlink" title="原生 API 手动 ACK"></a>原生 API 手动 ACK</h3><p>可以看到, 自动<code>ACK</code>的配置, 是在创建消费者的时候就声明的.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">consumer</span><span class="params">(Channel channel)</span> &#123;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">autoAck</span> <span class="operator">=</span> <span class="literal">false</span>; <span class="comment">// 声明自动 ACK</span></span><br><span class="line">    channel.basicConsume(QUEUE_NAME, autoAck, <span class="keyword">new</span> <span class="title class_">DefaultConsumer</span>(channel) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleDelivery</span><span class="params">(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, <span class="type">byte</span>[] body)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;接受到:&quot;</span> + <span class="keyword">new</span> <span class="title class_">String</span>(body));</span><br><span class="line">                <span class="comment">// channel.basicAck(envelope.getDeliveryTag(), false);</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                <span class="comment">// channel.basicNack(envelope.getDeliveryTag(), false, false);</span></span><br><span class="line">                <span class="comment">// channel.basicReject(envelope.getDeliveryTag(), false);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果设置成手动<code>ACK</code>, 那么就要手动调用几个方法来通知<code>MQ</code>消息的消费情况.</p>
<ol>
<li><code>channel.basicAck(long deliveryTag, boolean multiple)</code>, 表示正确处理这条消息.</li>
<li><code>channel.basicNack(long deliveryTag, boolean multiple, boolean requeue)</code>, 表示消息处理失败, 决定是否重回队列.</li>
<li><code>channel.basicReject(long deliveryTag, boolean requeue)</code>, 表示消息处理失败, 决定是否重回队列.</li>
</ol>
<p><code>basicNack</code>和<code>basicReject</code>有点像, 看了下文档, 区别就是能否支持<code>multiple</code>.</p>
<h3 id="Spring-Boot-手动-ACK"><a href="#Spring-Boot-手动-ACK" class="headerlink" title="Spring Boot 手动 ACK"></a>Spring Boot 手动 ACK</h3><p>首先在配置文件里设置</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">listener:</span></span><br><span class="line">      <span class="attr">simple:</span></span><br><span class="line">        <span class="attr">acknowledge-mode:</span> <span class="string">manual</span> <span class="comment"># 手动ack</span></span><br></pre></td></tr></table></figure>
<p>然后在消费者那里手动调用原生<code>API</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RabbitListener(queuesToDeclare = @Queue(queueName))</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Consumer</span> &#123;</span><br><span class="line">    <span class="meta">@RabbitHandler</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">directQueue</span><span class="params">(<span class="meta">@Payload</span> String msg, Channel channel, <span class="meta">@Header(AmqpHeaders.DELIVERY_TAG)</span> <span class="type">long</span> tag)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;接收到的消息:&quot;</span> + msg);</span><br><span class="line">            channel.basicAck(tag, <span class="literal">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            channel.basicNack(tag, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定时任务处理极端情况下的消息处理异常"><a href="#定时任务处理极端情况下的消息处理异常" class="headerlink" title="定时任务处理极端情况下的消息处理异常"></a>定时任务处理极端情况下的消息处理异常</h2><p>保证了消息发送、中间件存储、消息消费的可靠性.<br>但还是防止不了极端情况, 这些无法预料的情况, 必须有个兜底策略来处理.</p>
<p>比如用分布式定时任务扫描那些超过一天还没有流转到<code>3 已消费</code>的消息, 重新投递.</p>
<p>至于为什么要用<strong>分布式的</strong>定时任务, 是避免同一条消息, 在同一时刻重复投递.<br>从源头避免并发消息的产生.<br>当然, 消息的幂等性处理要由消费者来保证.</p>
<h1 id="方案二-消息延迟投递-做二次确认-回调检查"><a href="#方案二-消息延迟投递-做二次确认-回调检查" class="headerlink" title="方案二: 消息延迟投递, 做二次确认, 回调检查"></a>方案二: 消息延迟投递, 做二次确认, 回调检查</h1><p>方案一有一个问题, 消息发送之前, 需要落库两次, 业务库和消息库.<br>在海量高并发下, 每次磁盘<code>IO</code>的耗时, 都是不可忽视的. 在这种情况下, 要保证高性能, 将一致性降级为最终一致性.</p>
<p>和方案一相比, 方案二多了一个回调系统, 少了一步落库的操作.<br>要注意的是, 这里没有使用<code>RabbitMQ</code>的<code>Confirm</code>和<code>Return</code>机制.</p>
<img data-src="/images/RabbitMQ%E6%B6%88%E6%81%AF%E7%9A%84%E5%8F%AF%E9%9D%A0%E6%80%A7%E6%8A%95%E9%80%92_03.png" class="">

<ol>
<li>下单请求<code>Request</code>发送到订单系统<code>Order Center</code></li>
<li>将订单数据落库<code>DB</code>, 发送一条业务消息, 发送一条延时消息(用于检查第一条消息是否处理成功)</li>
<li>结算系统<code>Settlement-Center</code>收到消息, 处理成功后, 发送一条确认消息</li>
<li>回调系统消费这条确认消息, 这个时候再进行消息落库</li>
<li>过了几分钟, 回调系统消费了订单系统发送的延迟消息, 去消息库里检查是否存在这条信息.</li>
<li>如果没有, 就调用订单系统的接口, 重投消息.</li>
<li>分布式定时任务扫描那些超过一天还没消费的消息, 重新投递.</li>
</ol>
<p>以上都是流程正常的情况.<br>那万一中间哪一步出现异常, 要怎么保证消息再次重发呢? 关键点就在于这个用于<strong>检查</strong>的延迟消息.</p>
<p>这个用于检查的延迟消息, 消息体带上订单号等业务信息, 会在一段时间, 比如十分钟后投递到<code>MQ</code>消息中间件, 然后回调系统消费这条消息, 去检查消息库.<br>如果看到这条订单消息没有被处理, 那么就调用订单系统的接口, 让订单系统重新投递这条消息.</p>
<p>这里有个大问题, 如果这条延迟消息丢失了怎么办?<br>只能通过定时任务来补偿了.</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><a href="https://coding.imooc.com/class/262.html">RabbitMQ消息中间件技术精讲</a></li>
<li><a href="https://www.javazhiyin.com/47715.html">消息中间件——RabbitMQ（七）高级特性全在这里!（上）</a></li>
</ul>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>精通RabbitMQ的单节点和集群安装</title>
    <url>/posts/RabbitMQ_single_and_cluster_installation.html</url>
    <content><![CDATA[<h1 id="使用-Docker-单节点安装"><a href="#使用-Docker-单节点安装" class="headerlink" title="使用 Docker 单节点安装"></a>使用 Docker 单节点安装</h1><p>官方提供了一个<code>Docker</code>镜像, 直接执行下面命令即可.</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">mkdir -p /opt/rabbitmq/config &amp;&amp; touch /opt/rabbitmq/config/rabbitmq.config</span><br><span class="line">docker run -it --name rabbitmq -p 5672:5672 -p 15672:15672 \</span><br><span class="line">    -v /opt/rabbitmq/config/rabbitmq.config:/etc/rabbitmq/rabbitmq.config \</span><br><span class="line">    --hostname my-rabbit \</span><br><span class="line">    rabbitmq:3-management</span><br></pre></td></tr></table></figure>
<p><code>rabbitmq:3-management</code>镜像整合了控制台插件, 访问<code>http://虚拟机IP:15672</code>就可以看到控制台了.</p>
<span id="more"></span>

<h1 id="集群安装"><a href="#集群安装" class="headerlink" title="集群安装"></a>集群安装</h1><h2 id="HAProxy-实现主备集群-Warren模式"><a href="#HAProxy-实现主备集群-Warren模式" class="headerlink" title="HAProxy 实现主备集群(Warren模式)"></a>HAProxy 实现主备集群(Warren模式)</h2><p>当主节点宕机的时候, <code>HAProxy</code>能够将备节点升级为主节点, 继续提供服务.<br>本质上还是<code>HAProxy</code>下的一个节点在提供服务, 所以一般在并发和数据量不高的情况下使用.<br>![Warren模式](<a href="https://yuml.me/diagram/nofunky;dir:UD/class/[HAProxy]-&gt;[RabbitMQ">https://yuml.me/diagram/nofunky;dir:UD/class/[HAProxy]-&gt;[RabbitMQ</a> master],[HAProxy]-&gt;[RabbitMQ backup])</p>
<p><code>HAProxy</code>是免费开源的高可用解决方案, 可以将请求分散到多个服务器上, 为基于<code>TCP</code>和<code>HTTP</code>的应用程序提供负载均衡和代理功能.<br>我们先创建一个简单的<code>HAProxy</code>配置文件<code>haproxy.cfg</code></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line">listen rabbitmq_cluster</span><br><span class="line">    # 监听端口</span><br><span class="line">    bind 0.0.0.0:5672</span><br><span class="line">    # 配置TCP模式</span><br><span class="line">    mode tcp</span><br><span class="line">    # 轮询策略, 顺序轮询</span><br><span class="line">    balance roundrobin</span><br><span class="line">    # 主节点, 绑定rabbitmq-master容器的5672端口, 每5秒检测一次心跳, 2次正确证明服务可用, 2次失败证明服务不可用</span><br><span class="line">    server rabbit-master rabbitmq-master:5672        check inter 5000 rise 2 fall 2</span><br><span class="line">    # 备节点, 绑定rabbitmq-backup容器的5672端口, 每5秒检测一次心跳, 2次正确证明服务可用, 2次失败证明服务不可用</span><br><span class="line">    server rabbit-backup rabbitmq-backup:5672 backup check inter 5000 rise 2 fall 2</span><br></pre></td></tr></table></figure>
<p>这里用<code>Docker Compose</code>搭建一套一主一备的集群</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">haproxy:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">haproxy</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">5672</span><span class="string">:5672</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./haproxy:/usr/local/etc/haproxy:ro</span> <span class="comment"># HAProxy 的配置文件路径</span></span><br><span class="line">  <span class="attr">rabbitmq-master:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rabbitmq:3-alpine</span></span><br><span class="line">  <span class="attr">rabbitmq-backup:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">rabbitmq:3-alpine</span></span><br></pre></td></tr></table></figure>

<p>然后启动一下, 就可以在本地搭建好一个<code>Warren</code>模式的主备集群了. 为了简单, 这里是在单机用<code>Docker</code>部署的.<br>如果不用<code>Docker</code>部署也差不多, 最主要的就是<code>HAProxy</code>的配置</p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 创建配置文件</span></span><br><span class="line">mkdir -p /opt/rabbit-haproxy/haproxy &amp;&amp; cd /opt/rabbit-haproxy</span><br><span class="line">vim ./docker-compose.yml</span><br><span class="line">vim ./haproxy/haproxy.cfg</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 启动</span></span><br><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<h2 id="Shovel模式"><a href="#Shovel模式" class="headerlink" title="Shovel模式"></a>Shovel模式</h2><p><img data-src="https://yuml.me/diagram/nofunky;dir:lr/class/[%E7%94%A8%E6%88%B7]-%3E[RabbitMQ%E5%8D%8E%E5%8D%97],[RabbitMQ%E5%8D%8E%E5%8D%97]-%E5%90%8C%E6%AD%A5%3E[RabbitMQ%E5%8D%8E%E5%8C%97]" alt="Shovel模式"><br><code>Shovel</code>是<code>RabbitMQ</code>的一个插件, 本质上就是一个消费者, 消费当前节点的某个队列里的消息, 然后生产消息发送到目标节点的<code>Exchange</code>上, 使用<code>confirm</code>机制保证消息的可靠性投递.</p>
<p>这里先创建一个简单的<code>Docker</code>镜像, 官方并没有提供开启了<code>Shovel</code>的<code>RabbitMQ</code>镜像.</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> rabbitmq:<span class="number">3.7</span>-management</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> rabbitmq-plugins <span class="built_in">enable</span> --offline rabbitmq_shovel rabbitmq_shovel_management</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5672</span> <span class="number">15672</span></span><br><span class="line"><span class="comment"># docker build -t rabbitmq-shovel .</span></span><br><span class="line"><span class="comment"># docker run -it --name rabbitmq1 -p 5672:5672 -p 15672:15672 rabbitmq-shovel</span></span><br></pre></td></tr></table></figure>

<p><code>Shovel</code>分为静态配置和动态配置</p>
<table>
<thead>
<tr>
<th align="center">静态<code>Shovels</code></th>
<th align="center">动态<code>Shovels</code></th>
</tr>
</thead>
<tbody><tr>
<td align="center">在配置文件中设置</td>
<td align="center">在命令行中设置</td>
</tr>
<tr>
<td align="center">修改后要重启</td>
<td align="center">修改后不需要重启</td>
</tr>
</tbody></table>
<p>具体部署参阅官方文档</p>
<ul>
<li><a href="https://www.rabbitmq.com/shovel-static.html">静态<code>Shovel</code>官方文档</a></li>
<li><a href="https://www.rabbitmq.com/shovel-dynamic.html">动态<code>Shovel</code>官方文档</a></li>
</ul>
<h2 id="镜像集群-Mirror模式"><a href="#镜像集群-Mirror模式" class="headerlink" title="镜像集群(Mirror模式)"></a>镜像集群(Mirror模式)</h2><p><img data-src="https://yuml.me/diagram/nofunky;dir:ud/class/[%E5%BA%94%E7%94%A8]-VIP%3E[HAProxy&KeepAlived1],[%E5%BA%94%E7%94%A8]-VIP%3E[HAProxy&KeepAlived2],[HAProxy&KeepAlived1]-%3E[RabbitMQ1],[HAProxy&KeepAlived1]-%3E[RabbitMQ2],[HAProxy&KeepAlived1]-%3E[RabbitMQ3],[HAProxy&KeepAlived2]-%3E[RabbitMQ1],[HAProxy&KeepAlived2]-%3E[RabbitMQ2],[HAProxy&KeepAlived2]-%3E[RabbitMQ3]" alt="Mirror模式"></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/pardahlman/docker-rabbitmq-cluster</span></span><br><span class="line">git clone https://github.com/pardahlman/docker-rabbitmq-cluster.git</span><br><span class="line">cd docker-rabbitmq-cluster</span><br><span class="line">docker-compose up</span><br></pre></td></tr></table></figure>

<h2 id="异地多集群-多活模式"><a href="#异地多集群-多活模式" class="headerlink" title="异地多集群(多活模式)"></a>异地多集群(多活模式)</h2><p><img data-src="https://yuml.me/diagram/nofunky;dir:ud/class/[%E5%BA%94%E7%94%A8]-%3E[LBS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A11],[%E5%BA%94%E7%94%A8]-%3E[LBS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A12],[LBS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A11]-%3E[RabbitMQ1,RabbitMQ2,RabbitMQ3],[LBS%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A12]-%3E[RabbitMQ3,RabbitMQ4,RabbitMQ5]" alt="多活模式"></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.rabbitmq.com/shovel.html"><code>Shovel</code>官方文档</a></li>
<li><a href="https://www.rabbitmq.com/shovel-static.html">静态<code>Shovel</code>官方文档</a></li>
<li><a href="https://www.rabbitmq.com/shovel-dynamic.html">动态<code>Shovel</code>官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>消息队列</category>
      </categories>
      <tags>
        <tag>RabbitMQ</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx日志配置</title>
    <url>/posts/Nginx_log_configuration.html</url>
    <content><![CDATA[<h1 id="日志输出配置"><a href="#日志输出配置" class="headerlink" title="日志输出配置"></a>日志输出配置</h1><p><code>nginx</code>的日志有两种</p>
<ol>
<li><code>error_log</code>: 记录服务器错误, 配置在<strong>全局</strong>范围</li>
<li><code>access_log</code>: 记录每一次请求访问, 配置在<code>http</code>范围</li>
</ol>
<span id="more"></span>

<p>日志配置</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 1. error.log日志配置</span><br><span class="line"># error_log  日志存储位置  错误日志级别;</span><br><span class="line">error_log  /var/log/nginx/error.log warn;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    # 2. access.log日志配置</span><br><span class="line">    # access_log  日志存储位置  日志格式名;</span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line">    # log_format 日志格式名 [escape=default|json] 参数字符串;</span><br><span class="line">    log_format  main  &#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span><br><span class="line">                      &#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h1><p>语法: <code>log_format 日志格式名 [escape=default|json] string ...;</code><br>日志格式可以携带一些内置的变量, 如<code>IP地址</code>之类的。</p>
<h2 id="HTTP请求变量"><a href="#HTTP请求变量" class="headerlink" title="HTTP请求变量"></a>HTTP请求变量</h2><ol>
<li><code>arg_PARANERER</code>: 请求参数</li>
<li><code>http_HEADER</code>: 请求头</li>
<li><code>sent_HEADER</code>: 响应头</li>
</ol>
<p><code>Nginx</code>支持参数、请求头和响应头, 只要把字母转成小写, 横线转为下划线, 再加上<code>arg</code>、<code>http</code>或<code>sent</code>的前缀即可。<br>比如请求头的<code>User-Agent</code>, 对应的变量为<code>http_user_agent</code>。 </p>
<h2 id="内置变量"><a href="#内置变量" class="headerlink" title="内置变量"></a>内置变量</h2><p><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#variables">Nginx http core模块的变量</a><br>这里只介绍<code>nginx.conf</code>中默认配置的变量</p>
<ol>
<li><code>$remote_addr</code>: 客户端地址, 如<code>192.168.1.7</code></li>
<li><code>$remote_user</code>: 随基本身份验证提供的用户名</li>
<li><code>$time_local</code>: 通用日志格式的本地时间, 如<code>07/Jul/2018:15:33:14 +0800</code></li>
<li><code>$request</code>: 完整原始的请求行, 如<code>GET / HTTP/1.1</code></li>
<li><code>$status</code>: 响应状态码, 如<code>200</code>、<code>404</code></li>
<li><code>$body_bytes_sent</code>: 发送到客户端的字节数，不包括响应头</li>
</ol>
<h2 id="自定义变量"><a href="#自定义变量" class="headerlink" title="自定义变量"></a>自定义变量</h2><p><code>set</code>只能配置在<code>server</code>、<code>location</code>和<code>if</code>中。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    set $变量名 &quot;变量值&quot;</span><br><span class="line">    location / &#123;</span><br><span class="line">        set $变量名 &quot;变量值&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx的location配置</title>
    <url>/posts/Nginx_location_configuration.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>location</code>匹配到的<code>url</code>可以执行特定的操作, 比如拦截, 转发。</p>
<span id="more"></span>

<h1 id="url匹配"><a href="#url匹配" class="headerlink" title="url匹配"></a>url匹配</h1><p>语法:<br><code>location [=|~|~*|^~|@] uri &#123; 配置 &#125;</code><br><code>location</code>的<code>url</code>匹配遵循最长匹配原则。</p>
<table>
<thead>
<tr>
<th align="center">modifier</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">=</td>
<td align="center">精确匹配, 和这个<code>url</code>完全一样的会被匹配到</td>
</tr>
<tr>
<td align="center">^~</td>
<td align="center">前缀匹配, 以这个<code>url</code>开头都会被匹配到</td>
</tr>
<tr>
<td align="center">~</td>
<td align="center">表示执行一个正则匹配，区分大小写</td>
</tr>
<tr>
<td align="center">~*</td>
<td align="center">表示执行一个正则匹配，不区分大小写</td>
</tr>
<tr>
<td align="center"></td>
<td align="center">什么都没有, 就说明以这个<code>uri</code>开头的都会被匹配到</td>
</tr>
<tr>
<td align="center">@</td>
<td align="center">“@” 定义一个命名的 location，使用在内部定向时使用，例如 error_page, try_files</td>
</tr>
</tbody></table>
<p>匹配步骤:</p>
<ol>
<li>将所有的非正则匹配规则放入<strong>排序三叉树</strong>中, 正则匹配规则放入一个顺序队列(按配置文件书写顺序排序)中。</li>
<li>在三叉树中匹配<code>url</code>。如果匹配到<code>location =</code>就停止搜索。如果是前缀匹配<code>location ^~</code>或默认规则<code>location </code>则找到最长匹配。</li>
<li>再在正则匹配规则队列中匹配<code>url</code>, 如果有, 则使用这个正则匹配, 没有则使用三叉树中找到的匹配规则。</li>
</ol>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><p>上面说这么多, 还是得看例子来理解, 等看完例子再回过头去看上面的详细说明。<br><a href="https://detailyang.github.io/nginx-location-match-visible/">nginx-location-match-visible</a>提供了一个可视化的匹配步骤。<br>将下面规则复制到其中, 即可查看匹配步骤和匹配结果。</p>
<h2 id="和-none-的区别"><a href="#和-none-的区别" class="headerlink" title="= 和 none 的区别"></a>= 和 none 的区别</h2><p>匹配规则</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">location / &#123;&#125;      # A</span><br><span class="line">location = / &#123;&#125;    # B</span><br><span class="line">location = /123 &#123;&#125; # C</span><br></pre></td></tr></table></figure>
<p>测试用例</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">/      # 匹配B</span><br><span class="line">/123   # 匹配C</span><br></pre></td></tr></table></figure>

<h2 id="正则-区分大小写"><a href="#正则-区分大小写" class="headerlink" title="~ 正则(区分大小写)"></a>~ 正则(区分大小写)</h2><p>匹配规则</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">location / &#123;&#125;                           # A</span><br><span class="line">location ~ \.(gif|jpg|png|js|css)$ &#123;&#125;   # B</span><br><span class="line">location ~ \.(GIF|JPG|PNG|JS|CSS)$ &#123;&#125;   # C</span><br></pre></td></tr></table></figure>
<p>测试用例</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">/       # 匹配A</span><br><span class="line">/a.jpg  # 匹配B</span><br><span class="line">/a.JPG  # 匹配C</span><br></pre></td></tr></table></figure>

<h2 id="正则-不区分大小写"><a href="#正则-不区分大小写" class="headerlink" title="~ 正则(不区分大小写)"></a>~ 正则(不区分大小写)</h2><p>匹配规则</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">location / &#123;&#125;                            # A</span><br><span class="line">location ~* \.(gif|jpg|png|js|css)$ &#123;&#125;   # B</span><br></pre></td></tr></table></figure>
<p>测试用例</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">/       # 匹配A</span><br><span class="line">/a.jpg  # 匹配B</span><br><span class="line">/a.JPG  # 匹配B, 注意!! nginx-location-match-visible 有误! 实际是匹配到B的!</span><br></pre></td></tr></table></figure>

<h2 id=""><a href="#" class="headerlink" title="@"></a>@</h2><p><code>@</code>常用于内部跳转</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">location ~* \.(gif|jpg|png|js|css)$ &#123;</span><br><span class="line">    error_page 404 @img_err</span><br><span class="line">&#125;</span><br><span class="line">location @img_err &#123;</span><br><span class="line">    # 规则</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="复合"><a href="#复合" class="headerlink" title="复合"></a>复合</h2><p>匹配规则</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">location = / &#123;&#125;                         # A</span><br><span class="line">location = /login &#123;&#125;                    # B</span><br><span class="line">location ^~ /static/ &#123;&#125;                 # C</span><br><span class="line">location ~ \.(gif|jpg|png|js|css)$ &#123;&#125;   # D</span><br><span class="line">location ~* \.png$ &#123;&#125;                   # E</span><br><span class="line">location / &#123;&#125;                           # F</span><br></pre></td></tr></table></figure>
<p>测试用例</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">/                   # 匹配F</span><br><span class="line">/login              # 匹配B</span><br><span class="line">/static             # 匹配F</span><br><span class="line">/static/a           # 匹配C</span><br><span class="line">/test.png           # 匹配D</span><br><span class="line">/static.png         # 匹配D</span><br><span class="line">/test.PNG           # 匹配E, 注意!! nginx-location-match-visible 有误! 实际是匹配到E的!</span><br><span class="line">/static/a.png       # 匹配C</span><br><span class="line">/static/a.gif       # 匹配C</span><br></pre></td></tr></table></figure>

<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><p>一般把<code>Nginx</code>作为负载均衡服务器, 静态资源可以存在<code>Nginx</code>服务器。<br>负载均衡配置本文不详细讲, 简单的说就像是买卖房屋的中介, 给你(客户端)介绍一个好的(连接的上的)房屋(服务端)。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream tomcats &#123;</span><br><span class="line">        server 192.168.0.100:8080;</span><br><span class="line">        server 192.168.0.101:8080;</span><br><span class="line">        server example.com:8080;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        # 1. 静态文件处理 参照另一篇文章, 这里简单的列举一下</span><br><span class="line">        location ^~ /static/ &#123;</span><br><span class="line">            root /webroot/static/;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~* \.(gif|jpg|jpeg|png|css|js|ico)$ &#123;</span><br><span class="line">            root /webroot/res/;</span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        # 2. 负载均衡, 首页单独处理, 加快速度</span><br><span class="line">        location = / &#123;</span><br><span class="line">            proxy_pass http://tomcats/index</span><br><span class="line">        &#125;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://tomcats</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx的负载均衡配置</title>
    <url>/posts/Nginx_Server_load_balancing_configuration.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>负载均衡本质就是一个反向代理。<br>通俗点讲, 就类似<code>10086</code>客服电话, 如果只有一个通话员, 那全国十几亿人肯定处理不过来, 这时候就多招聘一堆通话员, 做负载均衡, 这样就减少了通话员的压力。</p>
<span id="more"></span>

<h1 id="SLB和GSLB"><a href="#SLB和GSLB" class="headerlink" title="SLB和GSLB"></a>SLB和GSLB</h1><p>负载均衡又分为</p>
<ol>
<li><code>GSLB(Global Server Load Balance)</code>全局负载均衡</li>
<li><code>SLB(Server load balancing)</code>负载均衡</li>
</ol>
<p>还是以<code>10086</code>为例, 如果只有北京开设了一个通话员中心(<code>SLB</code>), 即使通话员(<code>server</code>)的数量足够, 但是广东省的要打电话过去, 西藏的要打电话过去, 路途遥远。那么就设立多个通话员中心(<code>SLB</code>), 广东省的打广东省的<code>10086</code>, 西藏的打西藏的<code>10086</code>, 如果解决不了问题, 再上升到北京的<code>10086</code>。<br><img data-src="https://yuml.me/diagram/nofunky/class/[1%E5%B9%BF%E4%B8%9C%E7%94%A8%E6%88%B7]-%3E[1%E5%B9%BF%E4%B8%9C10086],[2%E8%A5%BF%E8%97%8F%E7%94%A8%E6%88%B7]-%3E[2%E8%A5%BF%E8%97%8F10086],[1%E5%B9%BF%E4%B8%9C10086]-%3E[3%E5%8C%97%E4%BA%AC10086],[2%E8%A5%BF%E8%97%8F10086]-%3E[3%E5%8C%97%E4%BA%AC10086]"><br>也就是说, 多个<code>SLB</code>组成了<code>GSLB</code>。</p>
<h1 id="OSI模型上的负载均衡"><a href="#OSI模型上的负载均衡" class="headerlink" title="OSI模型上的负载均衡"></a>OSI模型上的负载均衡</h1><p>学过计算机网络的应该都知道<a href="https://zh.wikipedia.org/wiki/OSI%E6%A8%A1%E5%9E%8B"><code>OSI</code>模型</a>, 分为物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。<br>比如数据链路层是根据<code>mac</code>地址进行数据包发送的, 那么就可以在这里做负载均衡。（一般是用虚拟<code>mac</code>地址方式，外部对虚拟<code>mac</code>地址请求，负载均衡接收后分配后端实际的<code>mac</code>地址响应）。</p>
<p>最常用的就是<br><strong>四层负载均衡(<code>IP + port</code>)</strong><br><strong>七层负载均衡(<code>IP + port + URL</code>)</strong><br><code>Nginx</code>是应用层, 也就是七层负载均衡。</p>
<h1 id="基本配置"><a href="#基本配置" class="headerlink" title="基本配置"></a>基本配置</h1><p>假设我们有三台机器<code>192.168.0.100</code>、<code>192.168.0.101</code>、<code>example.com</code>。<br>下面是一个简单的配置方法, <code>upstream</code>块必须在<code>http</code>块内。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    upstream tomcats &#123;</span><br><span class="line">        server 192.168.0.100:8080;</span><br><span class="line">        server 192.168.0.101:8080;</span><br><span class="line">        server example.com:8080;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        # 1. 负载均衡, 首页单独处理, 加快速度</span><br><span class="line">        location = / &#123;</span><br><span class="line">            proxy_pass http://tomcats/index</span><br><span class="line">        &#125;</span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://tomcats</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认是以请求次数做轮询条件, 比如第一次请求, 则分配到<code>192.168.0.100:8080</code>, 第二次请求, 则分配到<code>192.168.0.101:8080</code>, 以此类推。</p>
<h2 id="额外配置"><a href="#额外配置" class="headerlink" title="额外配置"></a>额外配置</h2><p>追加到<code>server</code>后面</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    server 192.168.0.100:8080;</span><br><span class="line">    server 192.168.0.101:8080 weight=2;</span><br><span class="line">    server example.com:8080 down;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th align="center">配置</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>weight=2</code></td>
<td align="center">权重越高, 越容易被轮询到</td>
</tr>
<tr>
<td align="center"><code>down</code></td>
<td align="center">暂不参与负载均衡</td>
</tr>
<tr>
<td align="center"><code>backup</code></td>
<td align="center">预留的备份服务器, 当其他所有服务挂了的时候启用</td>
</tr>
<tr>
<td align="center"><code>max_fails=1</code></td>
<td align="center">允许请求失败的次数</td>
</tr>
<tr>
<td align="center"><code>fail_timeout=10s</code></td>
<td align="center">经过<code>max_fails</code>失败后, <code>server</code>暂停的时间, 默认<code>10s</code></td>
</tr>
<tr>
<td align="center"><code>max_conns=10</code></td>
<td align="center">限制最大的接收连接数</td>
</tr>
</tbody></table>
<h1 id="负载均衡策略"><a href="#负载均衡策略" class="headerlink" title="负载均衡策略"></a>负载均衡策略</h1><p>除了默认的轮询策略, 还有其他的负载均衡策略, 配置到<code>upstream</code>内即可。</p>
<table>
<thead>
<tr>
<th align="center">轮询策略</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">轮询(默认)</td>
<td align="center">按请求顺序分配到不同的<code>server</code></td>
</tr>
<tr>
<td align="center">加权轮询</td>
<td align="center"><code>weight</code>值越大, 分配到的访问几率越高(最常用)</td>
</tr>
<tr>
<td align="center"><code>ip_hash</code></td>
<td align="center">每个请求按访问<code>IP</code>的<code>hash</code>结果分配, 同一个<code>IP</code>固定访问一个<code>server</code></td>
</tr>
<tr>
<td align="center"><code>url_hash</code></td>
<td align="center">按照访问的<code>URL</code>的<code>hash</code>结果分配, 同一个<code>URL</code>固定访问一个<code>server</code></td>
</tr>
<tr>
<td align="center"><code>least_conn</code></td>
<td align="center">最少链接数, 哪个<code>server</code>连接数少就分配给谁</td>
</tr>
<tr>
<td align="center"><code>hash关键数值</code></td>
<td align="center"><code>hash</code>自定义的<code>key</code>, <code>url_hash</code>是具体实现, 在<code>Nginx 1.7.2</code>后可用</td>
</tr>
<tr>
<td align="center"><code>fair</code></td>
<td align="center">响应时间短的服务器优先分配</td>
</tr>
</tbody></table>
<p>下面只简单介绍下应用场景</p>
<h2 id="ip-hash"><a href="#ip-hash" class="headerlink" title="ip_hash"></a>ip_hash</h2><p>保证同一个用户访问同一台服务器, 并且不用对项目做多大改动.<br>用于需要对<code>Session</code>或<code>Cookie</code>保持一致的情况.</p>
<p>但是不能保证平均负载.<br>并且如果多台机器走同一个代理服务器, <code>Nginx</code>根据代理服务器的<code>IP</code>做<code>Hash</code>, 会导致多台服务器走的都是同一个<code>server</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    server 192.168.0.100:8080;</span><br><span class="line">    server 192.168.0.101:8080;</span><br><span class="line">    server example.com:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="url-hash"><a href="#url-hash" class="headerlink" title="url_hash"></a>url_hash</h2><p>能保证同一个服务, 同一个<code>url</code>访问同一个服务器.<br>这种负载均衡策略也不能保证平均负载, 请求频繁的<code>url</code>会请求到同一个服务器上.</p>
<p><code>url_hash</code>是将<code>$request_uri</code>作为自定义<code>hash</code>的<code>key</code>。<br>注意, 自定义<code>hash key</code>只有在<code>Nginx 1.7.2</code>后可用。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">upstream tomcats &#123;</span><br><span class="line">    hash $request_uri;</span><br><span class="line">    server 192.168.0.100:8080;</span><br><span class="line">    server 192.168.0.101:8080;</span><br><span class="line">    server example.com:8080;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h2><p>没有最佳实践, 具体场景具体分析.<br>但是实际上解决<code>Session</code>同步问题, 一般都用<code>Redis</code>做分布式<code>Session</code>.<br>这里就不展开讲了, 和<code>Nginx</code>无关.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.51cto.com/dmwing/1896879">四层和七层负载均衡 - 详细总结</a></li>
</ul>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx连接限制和访问控制</title>
    <url>/posts/Nginx_connection_restrictions_and_access_control.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Nginx</code>自带的模块支持对并发请求数进行限制, 还有对请求来源进行限制。可以用来防止<code>DDOS</code>攻击。<br>阅读本文须知道<code>nginx</code>的配置文件结构和语法。</p>
<span id="more"></span>

<h1 id="连接限制-limit-conn-module"><a href="#连接限制-limit-conn-module" class="headerlink" title="连接限制 limit_conn_module"></a>连接限制 limit_conn_module</h1><p><code>limit_conn_module</code>: <code>TCP</code>连接频率限制, 一次<code>TCP</code>连接可以建立多次<code>HTTP</code>请求。<br>配置语法: </p>
<table>
<thead>
<tr>
<th align="center"><code>limit_conn_module</code>语法</th>
<th align="center">范围</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>limit_conn_zone 标识 zone=空间名:空间大小;</code></td>
<td align="center"><code>http</code></td>
<td align="center">用于声明一个存储空间</td>
</tr>
<tr>
<td align="center"><code>limit_conn 空间名 并发限制数;</code></td>
<td align="center"><code>http</code>、<code>server</code>或<code>location</code></td>
<td align="center">用于限制某个存储空间的并发数量</td>
</tr>
<tr>
<td align="center"><code>limit_conn_log_level 日志等级;</code></td>
<td align="center"><code>http</code>、<code>server</code>或<code>location</code></td>
<td align="center">当达到最大限制连接数后, 记录日志的等级</td>
</tr>
<tr>
<td align="center"><code>limit_conn_status 状态码;</code></td>
<td align="center"><code>http</code>、<code>server</code>或<code>location</code></td>
<td align="center">当超过限制后，返回的响应状态码，默认是<code>503</code></td>
</tr>
</tbody></table>
<p><code>limit_conn_zone</code>会声明一个<code>zone</code>空间来记录连接状态, 才能限制数量。<br><code>zone</code>是存储连接状态的空间, 以键值对存储, 通常以客户端地址<code>$binary_remote_addr</code>作为<code>key</code>来标识每一个连接。<br>当<code>zone</code>空间被耗尽，服务器将会对后续所有的请求返回<code>503(Service Temporarily Unavailable)</code> 错误。</p>
<h1 id="请求限制-limit-req-mudule"><a href="#请求限制-limit-req-mudule" class="headerlink" title="请求限制 limit_req_mudule"></a>请求限制 limit_req_mudule</h1><p><code>limit_req_mudule</code>: <code>HTTP</code>请求频率限制, 一次<code>TCP</code>连接可以建立多次<code>HTTP</code>请求。<br> 配置语法:</p>
<table>
<thead>
<tr>
<th align="center"><code>limit_req_mudule</code>语法</th>
<th align="center">范围</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>limit_req_zone key zone=空间名:空间大小 rate=每秒请求数;</code></td>
<td align="center"><code>http</code></td>
<td align="center">用于声明一个存储空间</td>
</tr>
<tr>
<td align="center"><code>limit_req zone=空间名 [burst=队列数] [nodelay];</code></td>
<td align="center"><code>http</code>、<code>server</code>或<code>location</code></td>
<td align="center">用于限制某个存储空间的并发数量</td>
</tr>
<tr>
<td align="center">这里的<code>zone</code>也是用来存储连接的一个空间。</td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h2 id="burst和nodelay"><a href="#burst和nodelay" class="headerlink" title="burst和nodelay"></a>burst和nodelay</h2><p><code>burst</code>和<code>nodelay</code>对并发请求设置了一个缓冲区和是否延迟处理的策略。<br>先假设有如下<code>zone</code>配置。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    limit_req_zone $binan_remote_addr zone=req_zone:1m rate=10r/s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>情况1: <code>limit_req zone=req_zone;</code></p>
<ol>
<li>第<code>1</code>秒发送<code>10</code>个请求, 正常响应。</li>
<li>第<code>1</code>秒发送<code>13</code>个请求, 前<code>10</code>个请求正常响应, 后<code>3</code>个请求返回<code>503(Service Temporarily Unavailable)</code>。</li>
</ol>
<p>不加<code>brust</code>和<code>nodelay</code>的情况下, <code>rate=10r/s</code>每秒只能执行<code>10</code>次请求, 多的直接返回<code>503</code>错误。</p>
<hr>
<p>情况2: <code>limit_req zone=req_zone brust=5;</code></p>
<ol>
<li>第<code>1</code>秒发送<code>10</code>个请求, 正常响应。</li>
<li>第<code>1</code>秒发送<code>13</code>个请求, 前<code>10</code>个请求正常响应, 后<code>3</code>个请求放入<code>brust</code>等待响应。</li>
<li>第<code>1</code>秒发送<code>20</code>个请求, 前<code>10</code>个请求正常响应, 后<code>5</code>个请求放入<code>brust</code>等待响应, 最后<code>5</code>个请求返回<code>503(Service Temporarily Unavailable)</code>, 第<code>2</code>秒执行<code>brust</code>中的<code>5</code>个请求。</li>
<li>第<code>1</code>秒发送<code>20</code>个请求, 前<code>10</code>个请求正常响应, 后<code>5</code>个请求放入<code>brust</code>等待响应, 最后<code>5</code>个请求返回<code>503(Service Temporarily Unavailable)</code>, 第<code>2</code>秒发送<code>6</code>个请求, 执行<code>brust</code>中的<code>5</code>个请求, 将<code>5</code>个请求放入<code>brust</code>等待响应, 剩下的<code>1</code>个请求返回<code>503(Service Temporarily Unavailable)</code>。</li>
</ol>
<p>加<code>brust=5</code>不加<code>nodelay</code>的情况下, 有一个容量为<code>5</code>的缓冲区, <code>rate=10r/s</code>每秒只能执行<code>10</code>次请求, 多的放到缓冲区中, 如果缓冲区满了, 就直接返回<code>503</code>错误。而缓冲区在下一个时间段会取出请求进行响应, 如果还有请求进来, 则继续放缓冲区, 多的就返回<code>503</code>错误。</p>
<hr>
<p>情况3: <code>limit_req zone=req_zone brust=5 nodelay;</code></p>
<ol>
<li>第<code>1</code>秒发送<code>10</code>个请求, 正常响应。</li>
<li>第<code>1</code>秒发送<code>13</code>个请求, <code>13</code>个请求正常响应。</li>
<li>第<code>1</code>秒发送<code>20</code>个请求, 前<code>15</code>个请求正常响应, 后<code>5</code>个请求返回<code>503(Service Temporarily Unavailable)</code>。</li>
<li>第<code>1</code>秒发送<code>20</code>个请求, 前<code>15</code>个请求正常响应, 后<code>5</code>个请求返回<code>503(Service Temporarily Unavailable)</code>, 第<code>2</code>秒发送<code>6</code>个请求, 正常响应。</li>
</ol>
<p>加<code>brust=5</code>和<code>nodelay</code>的情况下, 有一个容量为<code>5</code>的缓冲区, <code>rate=10r/s</code>每秒能执行<code>15</code>次请求, <code>15=10+5</code>。多的直接返回<code>503</code>错误。 </p>
<hr>
<h1 id="基于IP的访问控制"><a href="#基于IP的访问控制" class="headerlink" title="基于IP的访问控制"></a>基于IP的访问控制</h1><p><code>http_access_module</code>: 基于<code>IP</code>的访问控制, 通过代理可以绕过限制, 防君子不防小人。</p>
<table>
<thead>
<tr>
<th align="center"><code>http_access_module</code>语法</th>
<th align="center">范围</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>allow IP地址 &amp;#124; CIDR网段 &amp;#124; unix: &amp;#124; all;</code></td>
<td align="center"><code>http</code>、<code>server</code>、<code>location</code>和<code>limit_except</code></td>
<td align="center">允许<code>IP地址</code>、<code>CIDR</code>格式的网段、<code>unix</code>套接字或所有来源访问</td>
</tr>
<tr>
<td align="center"><code>deny IP地址 &amp;#124; CIDR网段 &amp;#124; unix: &amp;#124; all;</code></td>
<td align="center"><code>http</code>、<code>server</code>、<code>location</code>和<code>limit_except</code></td>
<td align="center">禁止<code>IP地址</code>、<code>CIDR</code>格式的网段、<code>unix</code>套接字或所有来源访问</td>
</tr>
</tbody></table>
<p><code>allow </code>和<code>deny</code>会按照顺序, 从上往下, 找到第一个匹配规则, 判断是否允许访问, 所以一般把<code>all</code>放最后。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">    deny  192.168.1.1;</span><br><span class="line">    allow 192.168.1.0/24;</span><br><span class="line">    allow 10.1.1.0/16;</span><br><span class="line">    allow 2001:0db8::/32;</span><br><span class="line">    deny  all;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="基于用户密码的访问控制"><a href="#基于用户密码的访问控制" class="headerlink" title="基于用户密码的访问控制"></a>基于用户密码的访问控制</h1><p><code>http_auth_basic_module</code>: 基于文件匹配用户密码的登录</p>
<table>
<thead>
<tr>
<th align="center"><code>http_auth_basic_module</code>语法</th>
<th align="center">范围</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>auth_basic 请输入你的帐号密码 &amp;#124; off;</code></td>
<td align="center"><code>http</code>、<code>server</code>、<code>location</code>和<code>limit_except</code></td>
<td align="center">显示用户登录提示(有些浏览器不显示提示)</td>
</tr>
<tr>
<td align="center"><code>auth_basic_user_file 存储帐号密码的文件路径;</code></td>
<td align="center"><code>http</code>、<code>server</code>、<code>location</code>和<code>limit_except</code></td>
<td align="center">从文件中匹配帐号密码</td>
</tr>
</tbody></table>
<p>密码文件可以通过<code>htpasswd</code>生成, <code>htpasswd</code>需要安装<code>yum install -y httpd-tools</code>。</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># -c 创建新文件, -b在参数中直接输入密码</span></span><br><span class="line">$ htpasswd -bc /etc/nginx/conf.d/passwd user1 pw1</span><br><span class="line">Adding password <span class="keyword">for</span> user user1</span><br><span class="line">$ htpasswd -b /etc/nginx/conf.d/passwd user2 pw2</span><br><span class="line">Adding password <span class="keyword">for</span> user user2</span><br><span class="line">$ <span class="built_in">cat</span> /etc/nginx/conf.d/passwd </span><br><span class="line">user1:$apr1<span class="variable">$7v</span>/m0.IF<span class="variable">$2kpM9NVVxbAv</span>.jSUvUQr01</span><br><span class="line">user2:$apr1$XmoO4Zzy<span class="variable">$Df76U0Gzxbd7</span>.5vXE0UsE0</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ol>
<li><a href="http://nginx.org/en/docs/http/ngx_http_limit_conn_module.html">limit_conn_module</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_limit_req_module.html">limit_req_mudule</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_access_module.html">http_access_module</a></li>
<li><a href="http://nginx.org/cn/docs/http/ngx_http_auth_basic_module.html">http_auth_basic_module</a></li>
</ol>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx配置多个域名</title>
    <url>/posts/Nginx_configures_multiple_server_name.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>解决<code>Cookie</code>跨域请求的时候, 发现这样一个<a href="https://scripts.cmbuckley.co.uk/cookies.php">网站scripts.cmbuckley.co.uk</a>, 它拥有无限的子域名, 比如<code>a.scripts.cmbuckley.co.uk</code>、<code>b.scripts.cmbuckley.co.uk</code>、<code>hhhhh.scripts.cmbuckley.co.uk</code>.</p>
<span id="more"></span>

<h1 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h1><p>这里用本地环境测试, 在虚拟机搭建一个<code>Nginx</code>服务器.<br><code>Nginx</code>的<code>server_name</code>在<code>server</code>块里面配置, 用于配置基于名称的虚拟主机。<br>比如<code>/etc/nginx/conf.d/default.conf</code>中配置的就是<code>localhost</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen       80;</span><br><span class="line">    server_name  localhost;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们修改<code>hosts</code>, 把<code>localhost</code>指向服务器的<code>IP</code>, 然后访问<code>http://localhost:80</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">192.168.94.189 localhost</span><br></pre></td></tr></table></figure>
<p>浏览器发送的请求头会携带一个<code>Host</code>参数<code>localhost</code>, <code>Nginx</code>根据这个<code>Host</code>将请求分发到名为<code>localhost</code>的<code>server</code>进行处理。<br>如果有多个<code>server</code>, 则会按从上到下的顺序一个个匹配, 如果都匹配不到, 则默认交给第一个请求, 或者也可以指定<code>default_server</code>.</p>
<h1 id="各种server-name"><a href="#各种server-name" class="headerlink" title="各种server_name"></a>各种server_name</h1><p><code>server_name</code>支持精确匹配, 支持通配符匹配, 支持正则匹配</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">server_name  domain.com  www.domain.com;</span><br><span class="line">server_name  *.domain.com;</span><br><span class="line">server_name  domain.*;</span><br><span class="line">server_name  ~^(?.+)\.domain\.com$;</span><br></pre></td></tr></table></figure>
<p>很明显, 上面提到的无限子域名的网站, 是通过<code>*.domain.com</code>的方式实现的.<br><code>Nginx</code>配好后, 记得<code>hosts</code>文件也要改, 手头没有域名, 就只能改<code>hosts</code>了.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://blog.51cto.com/onlyzq/535279">关于Nginx的server_name</a></li>
</ul>
]]></content>
      <categories>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Nginx</tag>
      </tags>
  </entry>
  <entry>
    <title>FeignClient 出现 Ambiguous mapping 重复映射</title>
    <url>/posts/FeignClient_and_Ambiguous_mapping.html</url>
    <content><![CDATA[<h1 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h1><p>依赖:</p>
<ol>
<li><code>Spring Boot 2.1.6.RELEASE</code></li>
<li><code>Eureka Client 2.1.0.RELEASE</code></li>
<li><code>OpenFeign 2.1.0.RELEASE</code></li>
</ol>
<p>我们创建两个项目, <code>ahao-server</code>服务提供方和<code>ahao-client</code>服务调用方.<br><code>Eureka</code>可以使用我弄的一个<a href="https://github.com/Ahaochan/project/tree/master/ahao-spring-cloud-eureka">开箱即用<code>Eureka</code></a></p>
<span id="more"></span>

<p>在<code>ahao-server</code>创建一个显示当前时间的<code>controller</code>, 同时注册到<code>eureka</code>上.<br>假设端口为<code>http://localhost:8080</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">nowTime</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;现在时间是:&quot;</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy年MM月dd日 hh时mm分ss秒&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ahao-client</code>创建一个<code>controller</code>和一个<code>feign</code>客户端, 同时注册到<code>eureka</code>上.<br>假设端口为<code>http://localhost:8081</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TimeApi timeApi;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">now</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> timeApi.nowTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TimeApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/now&quot;)</span></span><br><span class="line">    String <span class="title function_">nowTime</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行<code>ahao-client</code>报错<code>java.lang.IllegalStateException: Ambiguous mapping.</code><br>我们改一下<code>ahao-client</code>的<code>controller</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TimeApi timeApi;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/my-now&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">now</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> timeApi.nowTime();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再运行<code>ahao-client</code>就可以了.<br>我们访问<code>http://localhost:8081/ahao/my-now</code>可以得到<code>ahao-server</code>提供的时间服务, 但是访问<code>http://localhost:8081/ahao/now</code>就是<code>404</code>了.<br>那为什么会出现<code>java.lang.IllegalStateException: Ambiguous mapping.</code>呢?</p>
<h1 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h1><p>我们看下<code>RequestMappingHandlerMapping</code>映射注册器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RequestMappingHandlerMapping</span> <span class="keyword">extends</span> <span class="title class_">RequestMappingInfoHandlerMapping</span> <span class="keyword">implements</span> <span class="title class_">MatchableHandlerMapping</span>, EmbeddedValueResolverAware &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHandler</span><span class="params">(Class&lt;?&gt; beanType)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (AnnotatedElementUtils.hasAnnotation(beanType, Controller.class) ||</span><br><span class="line">                AnnotatedElementUtils.hasAnnotation(beanType, RequestMapping.class));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>也就是, 只要<code>Bean</code>类上有<code>@Controller</code>注解<strong>或者</strong><code>@RequestMapping</code>注解, 那就会解析<code>url</code>映射.<br>我们的<code>TimeApi</code>上刚好有一个<code>@RequestMapping</code>注解. 所以<code>TimeApi</code>和<code>TimeController</code>才会出现<code>url</code>映射冲突.</p>
<p>我们改造成<code>my-now</code>后, 就会有两个映射关系</p>
<ol>
<li><code>/ahao/my-now</code>: 正常的访问<code>ahao-server</code>服务</li>
<li><code>/ahao/now</code>: 访问失败<code>404</code></li>
</ol>
<p>看到这里肯定有疑问了, 为什么<code>/ahao/now</code>有<code>url</code>映射关系, 访问却<code>404</code>?<br>我们再改造下<code>TimeApi</code>. 加个<code>@ResponseBody</code>注解, 看到这里应该就知道<code>Spring MVC</code>做了多大的一件蠢事.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TimeApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/now&quot;)</span></span><br><span class="line">    String <span class="title function_">nowTime</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在两个<code>url</code>都可以正常访问了</p>
<ol>
<li><code>/ahao/my-now</code>: 正常的访问<code>ahao-server</code>服务</li>
<li><code>/ahao/now</code>: 正常的访问<code>ahao-server</code>服务</li>
</ol>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>这是<code>Spring MVC</code>的锅, <code>Feign</code>是不可能改的了, 而且<code>Spring MVC</code>也不可能改, 因为要兼容以前版本的使用者.</p>
<h2 id="最简单的方法"><a href="#最简单的方法" class="headerlink" title="最简单的方法"></a>最简单的方法</h2><p>不要把<code>@RequestMapping</code>和<code>@FeignClient</code>一起用, 直接把链接拼接到方法级的<code>@RequestMapping</code>上</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TimeApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/ahao/now&quot;)</span></span><br><span class="line">    String <span class="title function_">nowTime</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者用<code>@FeignClient</code>的<code>path</code>属性</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;, path = &quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TimeApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/now&quot;)</span></span><br><span class="line">    String <span class="title function_">nowTime</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="装逼用方法"><a href="#装逼用方法" class="headerlink" title="装逼用方法"></a>装逼用方法</h2><p>来源: <a href="https://github.com/spring-cloud/spring-cloud-netflix/issues/466#issuecomment-257043631">https://github.com/spring-cloud/spring-cloud-netflix/issues/466#issuecomment-257043631</a><br>但是失去了自动装配的一些特性, 不推荐使用</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123;Feign.class&#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FeignMappingDefaultConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> WebMvcRegistrations <span class="title function_">feignWebRegistrations</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WebMvcRegistrationsAdapter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> RequestMappingHandlerMapping <span class="title function_">getRequestMappingHandlerMapping</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FeignFilterRequestMappingHandlerMapping</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FeignFilterRequestMappingHandlerMapping</span> <span class="keyword">extends</span> <span class="title class_">RequestMappingHandlerMapping</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHandler</span><span class="params">(Class&lt;?&gt; beanType)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.isHandler(beanType) &amp;&amp; (AnnotationUtils.findAnnotation(beanType, FeignClient.class) == <span class="literal">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://github.com/spring-cloud/spring-cloud-netflix/issues/466#issuecomment-257043631">@FeignClient with top level @RequestMapping annotation is also registered as Spring MVC handler</a></li>
<li><a href="https://github.com/spring-projects/spring-framework/issues/22154">@RequestMapping without @Controller registered as handler SPR-17622</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring Cloud</category>
      </categories>
      <tags>
        <tag>Feign</tag>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>Feign之重复出现的FeignClientSpecification</title>
    <url>/posts/Repeated_FeignClientSpecification_of_Feign.html</url>
    <content><![CDATA[<h1 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h1><p>依赖:</p>
<ol>
<li><code>Spring Boot 2.1.6.RELEASE</code></li>
<li><code>Eureka Client 2.1.0.RELEASE</code></li>
<li><code>OpenFeign 2.1.0.RELEASE</code></li>
</ol>
<p>我们创建两个项目, <code>ahao-server</code>服务提供方和<code>ahao-client</code>服务调用方.<br><code>Eureka</code>可以使用我弄的一个<a href="https://github.com/Ahaochan/project/tree/master/ahao-spring-cloud-eureka">开箱即用<code>Eureka</code></a></p>
<span id="more"></span>

<p>在<code>ahao-server</code>创建一个显示当前时间的<code>controller</code>, 同时注册到<code>eureka</code>上.<br>假设端口为<code>http://localhost:8080</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/date&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">date</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="string">&quot;现在日期是:&quot;</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy年MM月dd日&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()); &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/time&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">time</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="string">&quot;现在时间是:&quot;</span> + <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;hh时mm分ss秒&quot;</span>).format(<span class="keyword">new</span> <span class="title class_">Date</span>()); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>ahao-client</code>创建一个<code>controller</code>和两个<code>feign</code>客户端, 同时注册到<code>eureka</code>上.<br>假设端口为<code>http://localhost:8081</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TimeController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> DateApi dateApi;</span><br><span class="line">    <span class="meta">@Autowired</span> <span class="keyword">private</span> TimeApi timeApi;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/date&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">date</span><span class="params">()</span> &#123; <span class="keyword">return</span> dateApi.date(); &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/time&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">time</span><span class="params">()</span> &#123; <span class="keyword">return</span> timeApi.time(); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;, path = &quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DateApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/date&quot;)</span> String <span class="title function_">date</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;, path = &quot;/ahao&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TimeApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/time&quot;)</span> String <span class="title function_">time</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行<code>ahao-client</code>报错</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">***************************</span><br><span class="line">APPLICATION FAILED TO START</span><br><span class="line">***************************</span><br><span class="line">Description:</span><br><span class="line">The bean &#x27;AHAO-SERVER.FeignClientSpecification&#x27;, defined in null, could not be registered. A bean with that name has already been defined in null and overriding is disabled.</span><br><span class="line"></span><br><span class="line">Action:</span><br><span class="line">Consider renaming one of the beans or enabling overriding by setting spring.main.allow-bean-definition-overriding=true</span><br><span class="line"></span><br><span class="line">Process finished with exit code 1</span><br></pre></td></tr></table></figure>
<p>这个叫做<code>AHAO-SERVER.FeignClientSpecification</code>的<code>Bean</code>是从哪来的???</p>
<h1 id="问题所在"><a href="#问题所在" class="headerlink" title="问题所在"></a>问题所在</h1><p><code>Spring</code>打印出了异常堆栈. 我们跟进去看一下.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerClientConfiguration</span><span class="params">(BeanDefinitionRegistry registry, Object name, Object configuration)</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        registry.registerBeanDefinition(name + <span class="string">&quot;.&quot;</span> + FeignClientSpecification.class.getSimpleName(), builder.getBeanDefinition());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到, 这里注册了一个<code>Bean</code>, 名字就是<code>AHAO-SERVER.FeignClientSpecification</code>.<br>这个<code>name</code>是从外部传进来的.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerFeignClients</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        Map&lt;String, Object&gt; attributes = annotationMetadata.getAnnotationAttributes(FeignClient.class.getCanonicalName());</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getClientName(attributes);</span><br><span class="line">        registerClientConfiguration(registry, name, attributes.get(<span class="string">&quot;configuration&quot;</span>));</span><br><span class="line"></span><br><span class="line">        registerFeignClient(registry, annotationMetadata, attributes);</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到, <code>name</code>应该是从注解中的属性取值来的, 再看看<code>getClientName()</code>方法.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getClientName</span><span class="params">(Map&lt;String, Object&gt; client)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String) client.get(<span class="string">&quot;contextId&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(value)) &#123; value = (String) client.get(<span class="string">&quot;value&quot;</span>); &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(value)) &#123; value = (String) client.get(<span class="string">&quot;name&quot;</span>); &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(value)) &#123; value = (String) client.get(<span class="string">&quot;serviceId&quot;</span>); &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(value)) &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Either &#x27;name&#x27; or &#x27;value&#x27; must be provided in @&quot;</span> + FeignClient.class.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一目了然了, 我们声明<code>@FeignClient</code>注解时, 只使用了<code>value</code>属性, 所以产生了冲突, 只要加上<code>contextId</code>就好了.</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>加上<code>contextId</code>属性即可.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;, path = &quot;/ahao&quot;, contextId = &quot;AHAO-SERVER-DATE&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">DateApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/date&quot;)</span> String <span class="title function_">date</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@FeignClient(value = &quot;AHAO-SERVER&quot;, path = &quot;/ahao&quot;, contextId = &quot;AHAO-SERVER-TIME&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TimeApi</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/time&quot;)</span> String <span class="title function_">time</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Spring-Boot-Cloud-2-0-x-版本"><a href="#Spring-Boot-Cloud-2-0-x-版本" class="headerlink" title="Spring Boot/Cloud 2.0.x 版本"></a>Spring Boot/Cloud 2.0.x 版本</h1><p>我们切换到<code>Spring Boot/Cloud 2.0.x</code>版本, 发现没有<code>contextId</code>属性, 但是启动的时候可以正常启动, 不会报错<code>Bean</code>冲突.<br>看下<code>Spring Boot/Cloud 2.0.x</code>版本的源码.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getClientName</span><span class="params">(Map&lt;String, Object&gt; client)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (client == <span class="literal">null</span>) &#123; <span class="keyword">return</span> <span class="literal">null</span>; &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> (String) client.get(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(value)) &#123; value = (String) client.get(<span class="string">&quot;name&quot;</span>); &#125;</span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(value)) &#123; value = (String) client.get(<span class="string">&quot;serviceId&quot;</span>); &#125;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(value)) &#123; <span class="keyword">return</span> value; &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;Either &#x27;name&#x27; or &#x27;value&#x27; must be provided in @&quot;</span> + FeignClient.class.getSimpleName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看下<code>getClientName()</code>方法, 里面也没有使用<code>contextId</code>. 也就是会创建两个同名<code>AHAO-SERVER.FeignClientSpecification</code>的<code>Bean</code>.<br>后来翻了下<code>issue</code>发现了答案.</p>
<blockquote>
<p>spring boot 2.0.x<br>spring.main.allow-bean-definition-overriding default value is “true”<br>spring boot 2.1.x default value changed to “false”</p>
</blockquote>
<p>原来是允许<code>Bean</code>重复定义所以才没有报错. 关键在<code>spring.main.allow-bean-definition-overriding</code>这个属性.</p>
<ul>
<li><code>Spring Boot 2.0.x</code> 默认是 <code>true</code>.</li>
<li><code>Spring Boot 2.1.x</code> 默认是 <code>false</code>.</li>
</ul>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://github.com/spring-cloud/spring-cloud-openfeign/pull/90/commits/82fa5181fdd2e23e7414521f468ecea88e17d157">Support Multiple Clients Using The Same Service</a></li>
<li><a href="https://github.com/spring-cloud/spring-cloud-openfeign/issues/81#issuecomment-447188550">BeanDefinitionOverrideException in FeignClientsRegistrar in tests with customized Spring context</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring Cloud</category>
      </categories>
      <tags>
        <tag>Feign</tag>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>Feign 源码分析之初始化和执行</title>
    <url>/posts/source_code_of_feign_and_init_and_execute.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Feign</code>是一个面向对象的<code>http</code>客户端, 这里主要介绍<code>Feign</code>是如何初始化的, 并如何进行<code>http</code>请求的.<br>省略部分不重要的代码. 剥离了<code>hystrix</code>和<code>ribbon</code>的相关逻辑.<br>读完这篇源码解析, 之前写的**<code>SpringCloud-Feign</code>之重复出现的<code>FeignClientSpecification</code>**也可以再复习下.</p>
<span id="more"></span>

<h1 id="FeignClientsRegistrar-创建-FactoryBean"><a href="#FeignClientsRegistrar-创建-FactoryBean" class="headerlink" title="FeignClientsRegistrar 创建 FactoryBean"></a>FeignClientsRegistrar 创建 FactoryBean</h1><p>要启用<code>Feign</code>, 首先要使用<code>@EnableFeignClients</code>注解.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Import(FeignClientsRegistrar.class)</span> <span class="comment">// 引入 FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableFeignClients &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>@EnableFeignClients</code>注解引入了<code>FeignClientsRegistrar</code>, 类实现了<code>ImportBeanDefinitionRegistrar</code>接口, 然后重写了<code>registerBeanDefinitions</code>方法.<br>说明加入到了<code>Spring</code>生命周期的管理中.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="comment">// 实现了 ImportBeanDefinitionRegistrar 接口, 注册到 Spring 生命周期中</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 将声明了 @EnableFeignClients 的类, 注册到名为 default.配置类名.FeignClientSpecification 的 FeignClientSpecification 实例中</span></span><br><span class="line">        registerDefaultConfiguration(metadata, registry);</span><br><span class="line">        <span class="comment">// 2. 创建 FeignClientFactoryBean 注入到 Spring 容器中</span></span><br><span class="line">        registerFeignClients(metadata, registry);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>registerBeanDefinitions</code>方法主要做了两件事</p>
<ol>
<li>将声明了<code>@EnableFeignClients</code>的类, 注册到一个新的<code>FeignClientSpecification</code>实例<code>Bean</code>中. 作为默认<code>Feign</code>配置.</li>
<li>将<code>@EnableFeignClients</code>的声明的包下的所有<code>@FeignClient</code>修饰的接口, 注册到新的<code>FeignClientFactoryBean</code>工厂中, 用于创建<code>JDK</code>动态代理.</li>
</ol>
<h2 id="registerDefaultConfiguration-注册默认配置"><a href="#registerDefaultConfiguration-注册默认配置" class="headerlink" title="registerDefaultConfiguration 注册默认配置"></a>registerDefaultConfiguration 注册默认配置</h2><p>第一行语句注册了一个名为<code>default.配置类名.FeignClientSpecification</code>的<code>FeignClientSpecification</code>实例为<code>Bean</code>.<br>作为之后创建的<code>Feign</code>动态代理的默认配置.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">registerDefaultConfiguration</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 获取 EnableFeignClients 中的属性</span></span><br><span class="line">        Map&lt;String, Object&gt; defaultAttrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName(), <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">if</span> (defaultAttrs != <span class="literal">null</span> &amp;&amp; defaultAttrs.containsKey(<span class="string">&quot;defaultConfiguration&quot;</span>)) &#123; <span class="comment">// 永远为 true</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;default.&quot;</span> + metadata.getClassName();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 注册一个 default.类名.FeignClientSpecification 的 Bean, 作为默认Feign配置</span></span><br><span class="line">            <span class="type">BeanDefinitionBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> BeanDefinitionBuilder.genericBeanDefinition(FeignClientSpecification.class);</span><br><span class="line">            builder.addConstructorArgValue(name);</span><br><span class="line">            builder.addConstructorArgValue(configuration);</span><br><span class="line">            registry.registerBeanDefinition(name + <span class="string">&quot;.&quot;</span> + FeignClientSpecification.class.getSimpleName(), builder.getBeanDefinition());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="registerFeignClients-注册-FactoryBean"><a href="#registerFeignClients-注册-FactoryBean" class="headerlink" title="registerFeignClients 注册 FactoryBean"></a>registerFeignClients 注册 FactoryBean</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientsRegistrar</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientsRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span>, ResourceLoaderAware, EnvironmentAware &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerFeignClients</span><span class="params">(AnnotationMetadata metadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">        <span class="type">ClassPathScanningCandidateComponentProvider</span> <span class="variable">scanner</span> <span class="operator">=</span> getScanner();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 根据 @EnableFeignClients 的 clients 属性或者 value、basePackages、basePackageClasses 属性初始化 basePackages 变量</span></span><br><span class="line">        Map&lt;String, Object&gt; attrs = metadata.getAnnotationAttributes(EnableFeignClients.class.getName());</span><br><span class="line">        Class&lt;?&gt;[] clients = attrs.get(<span class="string">&quot;clients&quot;</span>);</span><br><span class="line">        Set&lt;String&gt; basePackages;</span><br><span class="line">        <span class="keyword">if</span> (clients == <span class="literal">null</span> || clients.length == <span class="number">0</span>) &#123;</span><br><span class="line">            scanner.addIncludeFilter(annotationTypeFilter); <span class="comment">// scanner 的过滤器, 只扫描 @FeignClient 注解修饰的类</span></span><br><span class="line">            <span class="comment">// 1.1. 将 value、basePackages、basePackageClasses 属性的包名做并集, 如果都为空, 那就取配置类所在的包名</span></span><br><span class="line">            basePackages = getBasePackages(metadata);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 1.2. 将 clients 中的类的包名加入 basePackages, 并且 scanner 只扫描 clients 中的类以及 @FeignClient 注解修饰的类</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 扫描 basePackage 包下的所有被 @FeignClient 注解修饰的接口</span></span><br><span class="line">        <span class="keyword">for</span> (String basePackage : basePackages) &#123;</span><br><span class="line">            Set&lt;BeanDefinition&gt; candidateComponents = scanner.findCandidateComponents(basePackage);</span><br><span class="line">            <span class="keyword">for</span> (BeanDefinition candidateComponent : candidateComponents) &#123;</span><br><span class="line">                <span class="keyword">if</span> (candidateComponent <span class="keyword">instanceof</span> AnnotatedBeanDefinition) &#123;</span><br><span class="line">                    <span class="comment">// 2.1. 校验是否是接口</span></span><br><span class="line">                    <span class="type">AnnotatedBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> (AnnotatedBeanDefinition) candidateComponent;</span><br><span class="line">                    <span class="type">AnnotationMetadata</span> <span class="variable">annotationMetadata</span> <span class="operator">=</span> beanDefinition.getMetadata();</span><br><span class="line">                    Assert.isTrue(annotationMetadata.isInterface(), <span class="string">&quot;@FeignClient can only be specified on an interface&quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 2.2. 获取 FeignClient 的参数</span></span><br><span class="line">                    Map&lt;String, Object&gt; attributes = annotationMetadata.getAnnotationAttributes(FeignClient.class.getCanonicalName());</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 2.3. 按 contextId、value、name、serviceId 的优先级顺序获取 name, 用来做下面 bean name 的前缀</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> getClientName(attributes);</span><br><span class="line">                    <span class="comment">// 2.4. 将 @FeignClient 的 configuration 属性中的类, 注册为 FeignClientSpecification 类的实例 Bean</span></span><br><span class="line">                    registerClientConfiguration(registry, name, attributes.get(<span class="string">&quot;configuration&quot;</span>));</span><br><span class="line">                    <span class="comment">// 2.5. 根据 @FeignClient 的属性, 注册 FeignClientFactoryBean 类的实例 Bean</span></span><br><span class="line">                    <span class="comment">//      Bean 名称规则为, 按 contextId、serviceId、name、value 的优先级顺序获取 name, 后面加上 FeignClient 字符串</span></span><br><span class="line">                    registerFeignClient(registry, annotationMetadata, attributes);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="FeignClientFactoryBean-创建-JDK-动态代理"><a href="#FeignClientFactoryBean-创建-JDK-动态代理" class="headerlink" title="FeignClientFactoryBean 创建 JDK 动态代理"></a>FeignClientFactoryBean 创建 JDK 动态代理</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientFactoryBean</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Object&gt;, InitializingBean, ApplicationContextAware &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> getTarget();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; T <span class="title function_">getTarget</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 初始化 FeignAutoConfiguration 中的 FeignContext, 将刚才声明的一堆 FeignClientSpecification 注入到 FeignContext 中</span></span><br><span class="line">        <span class="type">FeignContext</span> <span class="variable">context</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContext.getBean(FeignContext.class);</span><br><span class="line">        <span class="comment">// 2. 根据 @FeignClient 里的 configuration 配置, 获取 builder</span></span><br><span class="line">        Feign.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> feign(context);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 如果 @FeignClient 没有配置 url, 就用 ribbon 做负载均衡</span></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(<span class="built_in">this</span>.url)) &#123;</span><br><span class="line">            <span class="keyword">return</span> (T) loadBalance(builder, context, <span class="keyword">new</span> <span class="title class_">HardCodedTarget</span>&lt;&gt;(<span class="built_in">this</span>.type, <span class="built_in">this</span>.name, <span class="built_in">this</span>.url));</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 4. 生成 @FeignClient 接口的 JDK 代理实现, 这里返回的是 ReflectiveFeign$FeignInvocationHandler 类的 JDK 动态代理</span></span><br><span class="line">        <span class="type">Client</span> <span class="variable">client</span> <span class="operator">=</span> getOptional(context, Client.class);</span><br><span class="line">        <span class="keyword">if</span> (client != <span class="literal">null</span>) &#123;</span><br><span class="line">            builder.client(client);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 5. 最终是调用 ReflectiveFeign 的 newInstance 方法, 创建 FeignInvocationHandler 的 JDK 动态代理</span></span><br><span class="line">        <span class="type">Targeter</span> <span class="variable">targeter</span> <span class="operator">=</span> get(context, Targeter.class);</span><br><span class="line">        <span class="keyword">return</span> (T) targeter.target(<span class="built_in">this</span>, builder, context, <span class="keyword">new</span> <span class="title class_">HardCodedTarget</span>&lt;&gt;(<span class="built_in">this</span>.type, <span class="built_in">this</span>.name, url));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// feign.ReflectiveFeign</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectiveFeign</span> <span class="keyword">extends</span> <span class="title class_">Feign</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> &lt;T&gt; T <span class="title function_">newInstance</span><span class="params">(Target&lt;T&gt; target)</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 根据方法初始化 MethodHandler 实例, 内部封装执行 http 请求的代码, 执行时根据 method 路由</span></span><br><span class="line">        Map&lt;Method, MethodHandler&gt; methodToHandler = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;Method, MethodHandler&gt;();</span><br><span class="line">        <span class="comment">// 2. 创建 FeignInvocationHandler 动态代理</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> factory.create(target, methodToHandler);</span><br><span class="line">        <span class="type">T</span> <span class="variable">proxy</span> <span class="operator">=</span> (T) Proxy.newProxyInstance(target.type().getClassLoader(), <span class="keyword">new</span> <span class="title class_">Class</span>&lt;?&gt;[] &#123;target.type()&#125;, handler);</span><br><span class="line">        <span class="keyword">return</span> proxy;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FeignInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">            <span class="comment">// 根据 method 路由到 MethodHandler 中</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>初始化完毕后, 就可以<code>@Autowired</code>声明的<code>Feign</code>接口了.</p>
<h1 id="Feign-调用"><a href="#Feign-调用" class="headerlink" title="Feign 调用"></a>Feign 调用</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// feign.ReflectiveFeign</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ReflectiveFeign</span> <span class="keyword">extends</span> <span class="title class_">Feign</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">FeignInvocationHandler</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Method, MethodHandler&gt; dispatch;</span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> dispatch.get(method).invoke(args);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// feign.SynchronousMethodHandler</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SynchronousMethodHandler</span> <span class="keyword">implements</span> <span class="title class_">MethodHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object[] argv)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 1. 用原型模式, 构造 http 请求客户端</span></span><br><span class="line">        <span class="type">RequestTemplate</span> <span class="variable">template</span> <span class="operator">=</span> buildTemplateFromArgs.create(argv);</span><br><span class="line">        <span class="comment">// 2. 如果参数中没有 Options, 就返回默认的 Options </span></span><br><span class="line">        <span class="type">Options</span> <span class="variable">options</span> <span class="operator">=</span> findOptions(argv);</span><br><span class="line">        <span class="comment">// 3. FeignClientsConfiguration 会初始化一个默认的 Retryer.NEVER_RETRY</span></span><br><span class="line">        <span class="type">Retryer</span> <span class="variable">retryer</span> <span class="operator">=</span> <span class="built_in">this</span>.retryer.clone();</span><br><span class="line">        <span class="comment">// 4. while 是为了做重试</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 5. 业务请求</span></span><br><span class="line">                <span class="keyword">return</span> executeAndDecode(template, options);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (RetryableException e) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    retryer.continueOrPropagate(e);  <span class="comment">// 重试策略</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RetryableException th) &#123;</span><br><span class="line">                    <span class="type">Throwable</span> <span class="variable">cause</span> <span class="operator">=</span> th.getCause();</span><br><span class="line">                    <span class="keyword">if</span> (propagationPolicy == UNWRAP &amp;&amp; cause != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> cause; <span class="comment">// 中断重试</span></span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">throw</span> th; <span class="comment">// 中断重试</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (logLevel != Logger.Level.NONE) &#123;</span><br><span class="line">                    logger.logRetry(metadata.configKey(), logLevel);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的时候会根据<code>method</code>路由到各自的<code>MethodHandler</code>中.<br>然后<code>MethodHandler</code>会创建新的<code>http</code>客户端, 进行请求操作, 失败的时候做重试.</p>
<h1 id="executeAndDecode-执行http请求并解码响应体"><a href="#executeAndDecode-执行http请求并解码响应体" class="headerlink" title="executeAndDecode 执行http请求并解码响应体"></a>executeAndDecode 执行http请求并解码响应体</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// feign.SynchronousMethodHandler</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SynchronousMethodHandler</span> <span class="keyword">implements</span> <span class="title class_">MethodHandler</span> &#123;</span><br><span class="line">    Object <span class="title function_">executeAndDecode</span><span class="params">(RequestTemplate template, Options options)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">// 1. 经过拦截器处理, 根据 template 创建出 Request 对象</span></span><br><span class="line">        <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> targetRequest(template);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 2. 真正发起 http 请求</span></span><br><span class="line">        Response response;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 默认是使用 HttpURLConnection 连接, 可以自己实现 Client 接口并注册为 Bean</span></span><br><span class="line">            response = client.execute(request, options);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> errorExecuting(request, e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 解析 http 响应体</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 3.1. 如果方法声明返回体是 Response 就直接返回</span></span><br><span class="line">            <span class="keyword">if</span> (Response.class == metadata.returnType()) &#123;</span><br><span class="line">                <span class="keyword">return</span> response;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 3.2. 如果状态码是 200 或者 404 就解码</span></span><br><span class="line">            <span class="keyword">if</span> (response.status() &gt;= <span class="number">200</span> &amp;&amp; response.status() &lt; <span class="number">300</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> decoder.decode(response, metadata.returnType());</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (decode404 &amp;&amp; response.status() == <span class="number">404</span> &amp;&amp; <span class="keyword">void</span>.class != metadata.returnType()) &#123;</span><br><span class="line">                <span class="keyword">return</span> decoder.decode(response, metadata.returnType());</span><br><span class="line">            &#125; </span><br><span class="line">            <span class="comment">// 3.3. 否则使用错误解码器</span></span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> errorDecoder.decode(metadata.configKey(), response);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            <span class="comment">// 3.3. 然后跑出异常</span></span><br><span class="line">            <span class="keyword">throw</span> errorReading(request, response, e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            ensureClosed(response.body());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="拦截器的注入时机"><a href="#拦截器的注入时机" class="headerlink" title="拦截器的注入时机"></a>拦截器的注入时机</h2><p>拦截器是在创建<code>Feign.Builder</code>时初始化的, 具体代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.openfeign.FeignClientFactoryBean#configureFeign</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FeignClientFactoryBean</span> <span class="keyword">implements</span> <span class="title class_">FactoryBean</span>&lt;Object&gt;, InitializingBean, ApplicationContextAware &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configureFeign</span><span class="params">(FeignContext context, Feign.Builder builder)</span> &#123;</span><br><span class="line">        <span class="type">FeignClientProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="built_in">this</span>.applicationContext.getBean(FeignClientProperties.class);</span><br><span class="line">        <span class="comment">// FeignAutoConfiguration 里注入了, 必定为 true</span></span><br><span class="line">        <span class="keyword">if</span> (properties != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 默认也是 true, 这里主要是配置优先级不同</span></span><br><span class="line">            <span class="keyword">if</span> (properties.isDefaultToProperties()) &#123;</span><br><span class="line">                configureUsingConfiguration(context, builder);</span><br><span class="line">                <span class="comment">// @EnableFeignClients#defaultConfiguration 自定义全局默认配置</span></span><br><span class="line">                configureUsingProperties(properties.getConfig().get(properties.getDefaultConfig()), builder);</span><br><span class="line">                <span class="comment">// @FeignClient#configuration 单个Feign接口局部配置</span></span><br><span class="line">                configureUsingProperties(properties.getConfig().get(<span class="built_in">this</span>.contextId), builder);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// @EnableFeignClients#defaultConfiguration 自定义全局默认配置</span></span><br><span class="line">                configureUsingProperties(properties.getConfig().get(properties.getDefaultConfig()), builder);</span><br><span class="line">                <span class="comment">// @FeignClient#configuration 单个Feign接口局部配置</span></span><br><span class="line">                configureUsingProperties(properties.getConfig().get(<span class="built_in">this</span>.contextId), builder);</span><br><span class="line">                <span class="comment">// 去 Spring 容器中找配置</span></span><br><span class="line">                configureUsingConfiguration(context, builder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 去 Spring 容器中找配置</span></span><br><span class="line">            configureUsingConfiguration(context, builder);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>默认情况下, <code>Feign</code>会依次从<code>Spring</code>容器、<code>@EnableFeignClients#defaultConfiguration</code>、<code>@FeignClient#configuration</code>寻找相关配置.<br>值得注意的一点是, 不要将<code>@EnableFeignClients#defaultConfiguration</code>、<code>@FeignClient#configuration</code>的配置声明为<code>Bean</code>.<br>因为<code>Feign</code>已经将配置注册到<code>FeignClientSpecification</code>类的实例<code>Bean</code>中了. 在上面也有提到.</p>
<h1 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h1><p><img data-src="https://yuml.me/diagram/nofunky;dir:UD/class/[@EnableFeignClients]-%3E[FeignClientsRegistrar],[FeignClientsRegistrar]-%3E[FeignClientFactoryBean],[FeignClientFactoryBean]-%3E[ReflectiveFeign$FeignInvocationHandler]" alt="feign流程"></p>
]]></content>
      <categories>
        <category>Spring Cloud</category>
      </categories>
      <tags>
        <tag>Feign</tag>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>Spring Cloud Gateway 聚合 swagger 3.0.0</title>
    <url>/posts/integrate_swagger_3_in_spring_cloud_gateway.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>网上关于<code>zuul</code>聚合各个微服务的<code>swagger</code>已经有很多文章了, 但是没有一个完整的关于<code>spring cloud gateway</code>的聚合教程.<br>研究了一天, 写了个<code>demo</code>, 然后写篇文章记录一下.</p>
<span id="more"></span>

<h1 id="Swagger引入"><a href="#Swagger引入" class="headerlink" title="Swagger引入"></a>Swagger引入</h1><p><code>Springfox</code>现在已经更新到<code>3.0.0</code>了, 并且也支持了<code>starter</code>方式.<br>直接<a href="https://mvnrepository.com/artifact/io.springfox/springfox-boot-starter">引入</a>, 不需要加任何注解.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.springfox<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springfox-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="聚合Swagger"><a href="#聚合Swagger" class="headerlink" title="聚合Swagger"></a>聚合Swagger</h1><p>和<code>zuul</code>的套路一样, 我们要实现<code>SwaggerResourcesProvider</code>接口, 然后根据各个服务的服务名拼接<code>uri</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SwaggerConfig</span> <span class="keyword">implements</span> <span class="title class_">SwaggerResourcesProvider</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RouteDefinitionLocator routeDefinitionLocator; <span class="comment">// 获取路由定义</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;SwaggerResource&gt; <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;SwaggerResource&gt; swaggerResourceList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        routeDefinitionLocator.getRouteDefinitions()</span><br><span class="line">            .map(<span class="built_in">this</span>::swaggerResource)           <span class="comment">// 转化为 SwaggerResource 对象</span></span><br><span class="line">            .subscribe(swaggerResourceList::add); <span class="comment">// Flux 转化为 List 对象</span></span><br><span class="line">        <span class="keyword">return</span> swaggerResourceList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SwaggerResource <span class="title function_">swaggerResource</span><span class="params">(RouteDefinition definition)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">location</span> <span class="operator">=</span> definition.getPredicates().stream()</span><br><span class="line">            .filter(predicate -&gt; <span class="string">&quot;Path&quot;</span>.equalsIgnoreCase(predicate.getName()))</span><br><span class="line">            .findFirst() <span class="comment">// 获取第一个名为 Path 的 predicate, 里面含有路由规则</span></span><br><span class="line">            .map(PredicateDefinition::getArgs) </span><br><span class="line">            <span class="comment">// 如果是从注册中心的路由规则, key 就是 pattern, 否则就是 _genkey_0</span></span><br><span class="line">            .map(map -&gt; map.getOrDefault(<span class="string">&quot;pattern&quot;</span>, map.get(NameUtils.GENERATED_NAME_PREFIX + <span class="string">&quot;0&quot;</span>)))</span><br><span class="line">            <span class="comment">// 拼接 url</span></span><br><span class="line">            .map(pattern -&gt; StringUtils.substringBefore(pattern, <span class="string">&quot;*&quot;</span>))</span><br><span class="line">            .map(pattern -&gt; pattern + <span class="string">&quot;v2/api-docs&quot;</span>)</span><br><span class="line">            .orElse(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">SwaggerResource</span> <span class="variable">swaggerResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SwaggerResource</span>();</span><br><span class="line">        swaggerResource.setName(definition.getId());</span><br><span class="line">        swaggerResource.setLocation(location);</span><br><span class="line">        <span class="keyword">return</span> swaggerResource;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整个执行流程很简单, 就是从<strong>路由定义</strong>里面获取<strong>路由规则</strong>, 拼接成<code>swagger</code>的地址, 丢到<code>SwaggerResource</code>里面.<br>但是中间有一些比较坑的地方.</p>
<h2 id="Flux-转化为-List-对象"><a href="#Flux-转化为-List-对象" class="headerlink" title="Flux 转化为 List 对象"></a>Flux 转化为 List 对象</h2><p>不懂<code>Mono</code>和<code>Flux</code>的去搜索, 自己实现一个<code>webflux</code>的<code>hello world</code>程序.<br><code>Mono</code>和<code>Flux</code>都是支持泛型的类. 可以简单地认为, <code>Mono</code>是包装了一个对象的对象, <code>Flux</code>是包装了一堆对象的集合.<br>要进行转换有两种方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;SwaggerResource&gt; swaggerResourceList1 = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">routeDefinitionLocator.getRouteDefinitions()</span><br><span class="line">        .map(<span class="built_in">this</span>::swaggerResource)</span><br><span class="line">        .subscribe(swaggerResourceList1::add);</span><br><span class="line">    </span><br><span class="line">List&lt;SwaggerResource&gt; swaggerResourceList2 = routeDefinitionLocator.getRouteDefinitions()</span><br><span class="line">        .map(<span class="built_in">this</span>::swaggerResource)</span><br><span class="line">        .collectList()</span><br><span class="line">        .block(Duration.ofSeconds(<span class="number">10</span>));</span><br></pre></td></tr></table></figure>

<p>但是我们只能用第一种, 第二种方法会抛出<code>IllegalStateException</code>异常.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// reactor.core.publisher.Mono</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Mono</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">CorePublisher</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">block</span><span class="params">(Duration timeout)</span> &#123;</span><br><span class="line">        BlockingMonoSubscriber&lt;T&gt; subscriber = <span class="keyword">new</span> <span class="title class_">BlockingMonoSubscriber</span>&lt;&gt;();</span><br><span class="line">        subscribe((Subscriber&lt;T&gt;) subscriber);</span><br><span class="line">        <span class="keyword">return</span> subscriber.blockingGet(timeout.toMillis(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reactor.core.publisher.BlockingSingleSubscriber</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BlockingSingleSubscriber</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">CountDownLatch</span> <span class="keyword">implements</span> <span class="title class_">InnerConsumer</span>&lt;T&gt;, Disposable &#123;</span><br><span class="line">    <span class="keyword">final</span> T <span class="title function_">blockingGet</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (Schedulers.isInNonBlockingThread()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalStateException</span>(<span class="string">&quot;block()/blockFirst()/blockLast() are blocking, which is not supported in thread &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// reactor.core.scheduler.Schedulers</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">Schedulers</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isInNonBlockingThread</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread() <span class="keyword">instanceof</span> NonBlocking;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="获取路由规则"><a href="#获取路由规则" class="headerlink" title="获取路由规则"></a>获取路由规则</h2><p><code>gateway</code>会从注册中心获取服务的相关信息, 初始化路由规则.<br><code>GatewayDiscoveryClientAutoConfiguration</code>会为<code>DiscoveryLocatorProperties</code>属性生成一个初始化的<code>PredicateDefinition</code>集合, 有点像原型模式.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GatewayDiscoveryClientAutoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> List&lt;PredicateDefinition&gt; <span class="title function_">initPredicates</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;PredicateDefinition&gt; definitions = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> add a predicate that matches the url at /serviceId?</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// add a predicate that matches the url at /serviceId/**</span></span><br><span class="line">        <span class="type">PredicateDefinition</span> <span class="variable">predicate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PredicateDefinition</span>();</span><br><span class="line">        predicate.setName(<span class="string">&quot;Path&quot;</span>); <span class="comment">// 所以上面才要根据 Path 进行过滤</span></span><br><span class="line">        predicate.addArg(<span class="string">&quot;pattern&quot;</span>, <span class="string">&quot;&#x27;/&#x27;+serviceId+&#x27;/**&#x27;&quot;</span>); <span class="comment">// 所以上面才要根据 pattern 进行过滤</span></span><br><span class="line">        definitions.add(predicate);</span><br><span class="line">        <span class="keyword">return</span> definitions;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> DiscoveryLocatorProperties <span class="title function_">discoveryLocatorProperties</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">DiscoveryLocatorProperties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DiscoveryLocatorProperties</span>();</span><br><span class="line">        properties.setPredicates(initPredicates());</span><br><span class="line">        properties.setFilters(initFilters());</span><br><span class="line">        <span class="keyword">return</span> properties;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.cloud.gateway.discovery.DiscoveryClientRouteDefinitionLocator</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscoveryClientRouteDefinitionLocator</span> <span class="keyword">implements</span> <span class="title class_">RouteDefinitionLocator</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Flux&lt;RouteDefinition&gt; <span class="title function_">getRouteDefinitions</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 省略部分代码</span></span><br><span class="line">        <span class="keyword">return</span> serviceInstances.filter(instances -&gt; !instances.isEmpty())</span><br><span class="line">                .map(instances -&gt; instances.get(<span class="number">0</span>)).filter(includePredicate)</span><br><span class="line">                .map(instance -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 1. 获取服务名</span></span><br><span class="line">                    <span class="type">String</span> <span class="variable">serviceId</span> <span class="operator">=</span> instance.getServiceId();</span><br><span class="line"></span><br><span class="line">                    <span class="type">RouteDefinition</span> <span class="variable">routeDefinition</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RouteDefinition</span>();</span><br><span class="line">                    routeDefinition.setId(<span class="built_in">this</span>.routeIdPrefix + serviceId);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> urlExpr.getValue(evalCtxt, instance, String.class);</span><br><span class="line">                    routeDefinition.setUri(URI.create(uri));</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">final</span> <span class="type">ServiceInstance</span> <span class="variable">instanceForEval</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DelegatingServiceInstance</span>(instance, properties);</span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 2. 获取 GatewayDiscoveryClientAutoConfiguration 初始化的默认 Predicate</span></span><br><span class="line">                    <span class="keyword">for</span> (PredicateDefinition original : <span class="built_in">this</span>.properties.getPredicates()) &#123;</span><br><span class="line">                        <span class="comment">// 3. 为服务初始化它自己的 Predicate 定义. 包括路由规则</span></span><br><span class="line">                        <span class="type">PredicateDefinition</span> <span class="variable">predicate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PredicateDefinition</span>();</span><br><span class="line">                        predicate.setName(original.getName());</span><br><span class="line">                        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : original.getArgs().entrySet()) &#123;</span><br><span class="line">                            <span class="comment">// 将 &#x27;/&#x27;+serviceId+&#x27;/**&#x27; 表达式替换成真正的路由规则</span></span><br><span class="line">                            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> parser.parseExpression(entry.getValue()).getValue(evalCtxt, instanceForEval, String.class);</span><br><span class="line">                            predicate.addArg(entry.getKey(), value);</span><br><span class="line">                        &#125;</span><br><span class="line">                        routeDefinition.getPredicates().add(predicate);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">return</span> routeDefinition;</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="genkey-0是从哪来的"><a href="#genkey-0是从哪来的" class="headerlink" title="_genkey_0是从哪来的?"></a>_genkey_0是从哪来的?</h2><p>在上面的源码分析里已经看到了<code>pattern</code>这个<code>key</code>是从哪里生成的了.<br>但是为什么还有一个<code>_genkey_0</code>呢?</p>
<p>因为如果是手动在配置文件里面配置服务的话, <code>gateway</code>会自动生成<code>key</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.gateway.support.NameUtils</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">NameUtils</span> &#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GENERATED_NAME_PREFIX</span> <span class="operator">=</span> <span class="string">&quot;_genkey_&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">generateName</span><span class="params">(<span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> GENERATED_NAME_PREFIX + i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// org.springframework.cloud.gateway.handler.predicate.PredicateDefinition</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PredicateDefinition</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">PredicateDefinition</span><span class="params">(String text)</span> &#123; <span class="comment">// 解析配置文件里的规则, 如 Path=/api/**</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">eqIdx</span> <span class="operator">=</span> text.indexOf(<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (eqIdx &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ValidationException</span>(<span class="string">&quot;Unable to parse PredicateDefinition text &#x27;&quot;</span> + text + <span class="string">&quot;&#x27;&quot;</span> + <span class="string">&quot;, must be of the form name=value&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        setName(text.substring(<span class="number">0</span>, eqIdx));</span><br><span class="line"></span><br><span class="line">        String[] args = tokenizeToStringArray(text.substring(eqIdx + <span class="number">1</span>), <span class="string">&quot;,&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">            <span class="comment">// 注意这里</span></span><br><span class="line">            <span class="built_in">this</span>.args.put(NameUtils.generateName(i), args[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到这, 你就会发现, 我写的代码其实有一个问题, 如果配置文件里有多个<code>predicate</code>.<br>那么一定要保证<code>Path</code>是第<code>0</code>个, 否则就获取不到路由规则. 目前也没想到什么好办法, 就这样将就用吧.</p>
<h2 id="服务id特别长怎么办"><a href="#服务id特别长怎么办" class="headerlink" title="服务id特别长怎么办"></a>服务id特别长怎么办</h2><p>有的同学会发现, 注册中心生成的服务<code>id</code>特别长, 不美观.<br><del>我只想安安静静做一个美男子</del><br>我只想要显示服务名, 可以把前缀都去掉吗?</p>
<img data-src="/images/SpringCloudGateway%E8%81%9A%E5%90%88swagger3_01.png" class="">

<p>答案是不行.<br>在配置文件中加入配置项<code>spring.cloud.gateway.discovery.locator.route-id-prefix: &quot;你想要的前缀&quot;</code>即可.<br>但是不能填空字符串.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.gateway.discovery.DiscoveryClientRouteDefinitionLocator</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DiscoveryClientRouteDefinitionLocator</span> <span class="keyword">implements</span> <span class="title class_">RouteDefinitionLocator</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">DiscoveryClientRouteDefinitionLocator</span><span class="params">(String discoveryClientName, DiscoveryLocatorProperties properties)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.properties = properties;</span><br><span class="line">        <span class="comment">// 如果判断是空字符串, 就用默认的前缀了</span></span><br><span class="line">        <span class="keyword">if</span> (StringUtils.hasText(properties.getRouteIdPrefix())) &#123;</span><br><span class="line">            routeIdPrefix = properties.getRouteIdPrefix();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 默认的 discoveryClientName 是 discoveryClient.getClass().getSimpleName()</span></span><br><span class="line">            routeIdPrefix = discoveryClientName + <span class="string">&quot;_&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        evalCtxt = SimpleEvaluationContext.forReadOnlyDataBinding().withInstanceMethods().build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>实际的例子可以看我在<code>github</code>上的项目<a href="https://github.com/Ahaochan/project/tree/master/ahao-spring-cloud-gateway"><code>ahao-spring-cloud-gateway</code></a></p>
]]></content>
      <categories>
        <category>Spring Cloud</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>异构语言接入Java微服务</title>
    <url>/posts/Polyglot_support_with_Sidecar.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>作为微服务体系, 应该是不限语言的, 不管是<code>php</code>、<code>nodejs</code>、<code>python</code>、<code>java</code>, 都可以是一个微服务.<br>本文将说明如何将<code>php</code>、<code>nodejs</code>、<code>python</code>接入<code>Java</code>微服务体系下.</p>
<span id="more"></span>

<h1 id="Sidecar"><a href="#Sidecar" class="headerlink" title="Sidecar"></a>Sidecar</h1><p>目前<code>Spring Cloud</code>主流使用的是<code>Sidecar</code>方式.</p>
<img data-src="/images/%E5%BC%82%E6%9E%84%E8%AF%AD%E8%A8%80%E6%8E%A5%E5%85%A5Java%E5%BE%AE%E6%9C%8D%E5%8A%A1_01.png" class="">

<p><code>Sidecar</code>作为一个中转服务, 和<code>PHP</code>服务存在同一个服务器上, 做到低延迟通信.<br>当<code>PHP</code>服务启动完毕后, 启动<code>Sidecar</code>服务.<br>此时<code>Sidecar</code>会做三件事.</p>
<ol>
<li><code>Sidecar</code>会将<code>PHP</code>服务所在服务器的<code>IP</code>和端口, 注册到注册中心, 成为一个微服务.</li>
<li><code>Sidecar</code>会定时检测<code>PHP</code>服务的健康状态, 也就是调用一下<code>PHP</code>服务的接口, 看有没有返回数据, 没有就从注册中心注销<code>PHP</code>服务</li>
<li><code>PHP</code>服务想要调用其他微服务接口需要通过<code>Sidecar</code>中转, <code>Sidecar</code>会将来自<code>PHP</code>的请求路由到其他微服务.</li>
</ol>
<p>接下来讲一下<code>Spring</code>主流的具体实现.</p>
<h1 id="Spring-Cloud-Netflix-Sidecar"><a href="#Spring-Cloud-Netflix-Sidecar" class="headerlink" title="Spring Cloud Netflix Sidecar"></a>Spring Cloud Netflix Sidecar</h1><p>一代目的<code>Spring Cloud</code>全家桶, 也可以叫<code>Netflix</code>全家桶, 理所当然的, 它提供的<code>Sidecar</code>, 只支持了自家的<code>Eureka</code>.</p>
<h2 id="第一步-注册到注册中心"><a href="#第一步-注册到注册中心" class="headerlink" title="第一步, 注册到注册中心"></a>第一步, 注册到注册中心</h2><p>先来看看入口<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/2.2.x/spring-cloud-netflix-sidecar/src/main/java/org/springframework/cloud/netflix/sidecar/SidecarAutoConfiguration.java"><code>SidecarAutoConfiguration</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.netflix.sidecar.SidecarAutoConfiguration</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SidecarAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(EurekaClientConfig.class)</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EurekaInstanceConfigBeanConfiguration</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">        <span class="keyword">public</span> EurekaInstanceConfigBean <span class="title function_">eurekaInstanceConfigBean</span><span class="params">(ManagementMetadataProvider managementMetadataProvider)</span> &#123;</span><br><span class="line">            <span class="type">EurekaInstanceConfigBean</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">EurekaInstanceConfigBean</span>(inetUtils);</span><br><span class="line">            <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="built_in">this</span>.sidecarProperties.getPort();</span><br><span class="line">            config.setNonSecurePort(port);</span><br><span class="line">            <span class="type">String</span> <span class="variable">ipAddress</span> <span class="operator">=</span> <span class="built_in">this</span>.sidecarProperties.getIpAddress();</span><br><span class="line">            config.setIpAddress(ipAddress);</span><br><span class="line">            <span class="keyword">return</span> config;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以看到<code>SidecarAutoConfiguration</code>注册了一个<code>EurekaInstanceConfigBean</code>.<br>我们再看看客户端的配置<code>EurekaClientAutoConfiguration</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.netflix.eureka.SidecarAutoConfiguration</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EurekaClientAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean(value = EurekaInstanceConfig.class, search = SearchStrategy.CURRENT)</span></span><br><span class="line">    <span class="keyword">public</span> EurekaInstanceConfigBean <span class="title function_">eurekaInstanceConfigBean</span><span class="params">(InetUtils inetUtils, ManagementMetadataProvider managementMetadataProvider)</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里也有一个<code>EurekaInstanceConfigBean</code>.<br>也就是说<code>SidecarAutoConfiguration</code>的<code>EurekaInstanceConfigBean</code>覆盖了<code>EurekaClientAutoConfiguration</code>的<code>EurekaInstanceConfigBean</code>.<br>将<code>PHP</code>服务注册到注册中心, 具体怎么注册的, 涉及<code>Eureka</code>的源码, 这里就不细讲.</p>
<h2 id="第二步-定时任务检查健康状态"><a href="#第二步-定时任务检查健康状态" class="headerlink" title="第二步, 定时任务检查健康状态"></a>第二步, 定时任务检查健康状态</h2><p>继续看入口<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/2.2.x/spring-cloud-netflix-sidecar/src/main/java/org/springframework/cloud/netflix/sidecar/SidecarAutoConfiguration.java"><code>SidecarAutoConfiguration</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.springframework.cloud.netflix.sidecar.SidecarAutoConfiguration</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SidecarAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LocalApplicationHealthIndicator <span class="title function_">localApplicationHealthIndicator</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LocalApplicationHealthIndicator</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line">    <span class="meta">@ConditionalOnClass(EurekaClientConfig.class)</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">EurekaInstanceConfigBeanConfiguration</span> &#123;</span><br><span class="line">        <span class="meta">@Bean</span></span><br><span class="line">        <span class="keyword">public</span> HealthCheckHandler <span class="title function_">healthCheckHandler</span><span class="params">(<span class="keyword">final</span> LocalApplicationHealthIndicator healthIndicator)</span> &#123;</span><br><span class="line">            <span class="comment">// 注入上面的 LocalApplicationHealthIndicator</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LocalApplicationHealthCheckHandler</span>(healthIndicator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// org.springframework.cloud.netflix.sidecar.LocalApplicationHealthCheckHandler</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LocalApplicationHealthCheckHandler</span> <span class="keyword">implements</span> <span class="title class_">HealthCheckHandler</span> &#123;</span><br><span class="line">    <span class="comment">// 注入进来的 LocalApplicationHealthIndicator</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> HealthIndicator healthIndicator;</span><br><span class="line">    LocalApplicationHealthCheckHandler(HealthIndicator healthIndicator) &#123;</span><br><span class="line">        <span class="built_in">this</span>.healthIndicator = healthIndicator;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> InstanceStatus <span class="title function_">getStatus</span><span class="params">(InstanceStatus currentStatus)</span> &#123;</span><br><span class="line">        <span class="comment">// 具体的心跳检测逻辑</span></span><br><span class="line">        <span class="type">Status</span> <span class="variable">status</span> <span class="operator">=</span> healthIndicator.health().getStatus();</span><br><span class="line">        <span class="keyword">if</span> (status.equals(Status.UP)) &#123; <span class="keyword">return</span> UP; &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (status.equals(Status.OUT_OF_SERVICE)) &#123; <span class="keyword">return</span> OUT_OF_SERVICE; &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (status.equals(Status.DOWN)) &#123; <span class="keyword">return</span> DOWN; &#125;</span><br><span class="line">        <span class="keyword">return</span> UNKNOWN;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到<code>LocalApplicationHealthCheckHandler</code>是一个<code>LocalApplicationHealthIndicator</code>的装饰类.<br>主要是调用<code>LocalApplicationHealthIndicator</code>来进行心跳检测. <code>LocalApplicationHealthIndicator</code>实现了<code>Eureka</code>的<code>HealthCheckHandler</code>接口.</p>
<h2 id="第三步-Sidecar会将来自PHP的请求路由到其他微服务"><a href="#第三步-Sidecar会将来自PHP的请求路由到其他微服务" class="headerlink" title="第三步, Sidecar会将来自PHP的请求路由到其他微服务"></a>第三步, Sidecar会将来自PHP的请求路由到其他微服务</h2><p>我们看<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/2.2.x/spring-cloud-netflix-sidecar/pom.xml"><code>pom.xml</code></a>的依赖.<br>可以看到主要依赖了<code>Zuul</code>.<br><code>Zuul</code>的默认转发规则是<code>/微服务名称/具体uri</code>.<br>所以如果<code>PHP</code>服务要调用其他微服务, 只要访问<code>http://127.0.0.1:$&#123;Sidecar端口&#125;/$&#123;微服务名称&#125;/hello</code>即可.</p>
<h1 id="Spring-Cloud-Alibaba-Sidecar"><a href="#Spring-Cloud-Alibaba-Sidecar" class="headerlink" title="Spring Cloud Alibaba Sidecar"></a>Spring Cloud Alibaba Sidecar</h1><p>接下来是二代目的<code>Spring Cloud</code>全家桶, 也可以叫<code>Alibaba</code>全家桶, 除了支持自家的<code>Nacos</code>, 还支持了<code>consul</code>.</p>
<h2 id="第一步-注册到注册中心-1"><a href="#第一步-注册到注册中心-1" class="headerlink" title="第一步, 注册到注册中心"></a>第一步, 注册到注册中心</h2><p>这里以<code>Nacos</code>为例.<br>继续看入口<a href="https://github.com/alibaba/spring-cloud-alibaba/tree/v2.2.0.RELEASE/spring-cloud-alibaba-sidecar/src/main/java/com/alibaba/cloud/sidecar/nacos/SidecarNacosAutoConfiguration.java"><code>SidecarNacosAutoConfiguration</code></a><br>这里比<a href="https://github.com/spring-cloud/spring-cloud-netflix/blob/2.2.x/spring-cloud-netflix-sidecar/src/main/java/org/springframework/cloud/netflix/sidecar/SidecarAutoConfiguration.java"><code>Netflix Sidecar</code></a>的简单多了.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.cloud.sidecar.nacos.SidecarNacosAutoConfiguration</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SidecarNacosAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConditionalOnMissingBean</span></span><br><span class="line">    <span class="keyword">public</span> SidecarDiscoveryClient <span class="title function_">sidecarDiscoveryClient</span><span class="params">(SidecarNacosDiscoveryProperties sidecarNacosDiscoveryProperties)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SidecarNacosDiscoveryClient</span>(sidecarNacosDiscoveryProperties);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// com.alibaba.cloud.sidecar.nacos.SidecarNacosDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SidecarNacosDiscoveryClient</span> <span class="keyword">implements</span> <span class="title class_">SidecarDiscoveryClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SidecarNacosDiscoveryProperties sidecarNacosDiscoveryProperties;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerInstance</span><span class="params">(String applicationName, String ip, Integer port)</span> &#123;</span><br><span class="line">        <span class="comment">// 注册逻辑</span></span><br><span class="line">        <span class="built_in">this</span>.sidecarNacosDiscoveryProperties.namingServiceInstance().registerInstance(applicationName, ip, port);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">deregisterInstance</span><span class="params">(String applicationName, String ip, Integer port)</span> &#123;</span><br><span class="line">        <span class="comment">// 注销逻辑</span></span><br><span class="line">        <span class="built_in">this</span>.sidecarNacosDiscoveryProperties.namingServiceInstance().deregisterInstance(applicationName, ip, port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一目了然, 注册和注销的方法, 调用的都是<code>Nacos</code>提供的<code>API</code>.</p>
<h2 id="第二步-定时任务检查健康状态-1"><a href="#第二步-定时任务检查健康状态-1" class="headerlink" title="第二步, 定时任务检查健康状态"></a>第二步, 定时任务检查健康状态</h2><p>我们看<a href="https://github.com/alibaba/spring-cloud-alibaba/tree/v2.2.0.RELEASE/spring-cloud-alibaba-sidecar/src/main/java/com/alibaba/cloud/sidecar/SidecarAutoConfiguration.java"><code>SidecarAutoConfiguration</code></a></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// com.alibaba.cloud.sidecar.SidecarAutoConfiguration</span></span><br><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SidecarAutoConfiguration</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SidecarHealthChecker <span class="title function_">sidecarHealthChecker</span><span class="params">(SidecarDiscoveryClient sidecarDiscoveryClient, SidecarHealthIndicator sidecarHealthIndicator, SidecarProperties sidecarProperties, ConfigurableEnvironment environment)</span> &#123;</span><br><span class="line">        <span class="type">SidecarHealthChecker</span> <span class="variable">cleaner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SidecarHealthChecker</span>(sidecarDiscoveryClient, sidecarHealthIndicator, sidecarProperties, environment);</span><br><span class="line">        cleaner.check();</span><br><span class="line">        <span class="keyword">return</span> cleaner;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// com.alibaba.cloud.sidecar.SidecarHealthChecker</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SidecarHealthChecker</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">check</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 1. 开启一个定时任务</span></span><br><span class="line">        Schedulers.single().schedulePeriodically(() -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">ip</span> <span class="operator">=</span> sidecarProperties.getIp();</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">port</span> <span class="operator">=</span> sidecarProperties.getPort();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2. 调用 http 请求</span></span><br><span class="line">            <span class="type">Status</span> <span class="variable">status</span> <span class="operator">=</span> healthIndicator.health().getStatus();</span><br><span class="line">            <span class="type">String</span> <span class="variable">applicationName</span> <span class="operator">=</span> environment.getProperty(<span class="string">&quot;spring.application.name&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3. 健康则续期, 否则注销</span></span><br><span class="line">            <span class="keyword">if</span> (status.equals(Status.UP)) &#123;</span><br><span class="line">                <span class="built_in">this</span>.sidecarDiscoveryClient.registerInstance(applicationName, ip, port);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="built_in">this</span>.sidecarDiscoveryClient.deregisterInstance(applicationName, ip, port);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, sidecarProperties.getHealthCheckInterval(), TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还是老套路, <code>Sidecar</code>通过<code>http</code>定时检测<code>PHP</code>服务的健康状态.<br>如果健康则继续续期, 否则从注册中心注销.</p>
<h2 id="第三步-Sidecar会将来自PHP的请求路由到其他微服务-1"><a href="#第三步-Sidecar会将来自PHP的请求路由到其他微服务-1" class="headerlink" title="第三步, Sidecar会将来自PHP的请求路由到其他微服务"></a>第三步, Sidecar会将来自PHP的请求路由到其他微服务</h2><p>我们看<a href="https://github.com/alibaba/spring-cloud-alibaba/tree/v2.2.0.RELEASE/spring-cloud-alibaba-sidecar/pom.xml"><code>pom.xml</code></a><br>可以看到依赖了<code>Spring Cloud Gateway</code>.<br>和<code>Zuul</code>一样. 只要访问<code>http://127.0.0.1:$&#123;Sidecar端口&#125;/$&#123;微服务名称&#125;/hello</code>即可调用其他微服务.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://cloud.spring.io/spring-cloud-netflix/multi/multi__polyglot_support_with_sidecar.html">Polyglot support with Sidecar</a></li>
</ul>
]]></content>
      <categories>
        <category>Spring Cloud</category>
      </categories>
      <tags>
        <tag>Spring Cloud</tag>
      </tags>
  </entry>
  <entry>
    <title>MongoDB学习笔记</title>
    <url>/posts/MongoDB_simple_use.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>mongodb</code>是一个<code>NoSQL</code>数据库, 可以分词查询, 可以基于地理位置查询, 记录以<code>JSON</code>形式存储.<br><code>mongodb</code>的数据表又叫做数据集合, 关键字为<code>collection</code>.<br><code>mongodb</code>是不存在<code>join</code>这个概念的, 所以一切的关联查询都得通过外部程序来做.</p>
<span id="more"></span>

<h1 id="安装配置-基于v3-4-18"><a href="#安装配置-基于v3-4-18" class="headerlink" title="安装配置(基于v3.4.18)"></a>安装配置(基于v3.4.18)</h1><p>安装教程: <a href="https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/">Install MongoDB Community Edition on Red Hat Enterprise or CentOS Linux</a>(国内可以用阿里云<code>yum</code>镜像).</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 安装</span></span><br><span class="line">yum install -y mongodb-org</span><br><span class="line"><span class="comment"># 2. 初始化</span></span><br><span class="line"><span class="built_in">mkdir</span> -p /opt/mongodb/data/db /opt/mongodb/log</span><br><span class="line"><span class="built_in">cp</span> /etc/mongod.conf /opt/mongodb/mongod.conf</span><br><span class="line"><span class="comment"># 3. 修改配置文件</span></span><br><span class="line">sed -i <span class="string">&#x27;s#/var/log/mongodb/mongod.log#/opt/mongodb/log/mongod.log#g&#x27;</span> /opt/mongodb/mongod.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#/var/lib/mongo#/opt/mongodb/data/db#g&#x27;</span> /opt/mongodb/mongod.conf</span><br><span class="line">sed -i <span class="string">&#x27;s#/var/run/mongodb/mongod.pid#/opt/mongodb/mongod.pid#g&#x27;</span> /opt/mongodb/mongod.conf</span><br><span class="line"><span class="comment"># 4. 查看版本号</span></span><br><span class="line">mongod --version</span><br><span class="line"><span class="comment"># 5. 启动</span></span><br><span class="line">mongod -f /opt/mongodb/mongod.conf</span><br><span class="line"><span class="comment"># 6. 关闭</span></span><br><span class="line">mongo 127.0.0.1:27071/test</span><br><span class="line">use admin <span class="comment"># 使用 admin 数据库</span></span><br><span class="line">db.shutdownServer()</span><br></pre></td></tr></table></figure>

<h1 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h1><h2 id="auth-用户名密码登录"><a href="#auth-用户名密码登录" class="headerlink" title="auth 用户名密码登录"></a>auth 用户名密码登录</h2><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 创建用户</span></span><br><span class="line">db.createUser(&#123;</span><br><span class="line">  user: <span class="string">&quot;ahao&quot;</span>,</span><br><span class="line">  <span class="built_in">pwd</span>: <span class="string">&quot;ahao&quot;</span>,</span><br><span class="line">  customData: &#123;msg:<span class="string">&quot;我是一个新用户&quot;</span>&#125;,</span><br><span class="line">  roles:[&#123;role:<span class="string">&quot;dbOwner&quot;</span>, db:<span class="string">&quot;admin&quot;</span>&#125;]</span><br><span class="line">&#125;)</span><br><span class="line">角色类型: <span class="built_in">read</span>、readWrite、dbAdmin、dbOwner、userAdmin</span><br><span class="line">dbOwner = <span class="built_in">read</span> + readWrite + dbAdmin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 开启auth验证, 修改 /opt/mongodb/mongodb.conf</span></span><br><span class="line">system:</span><br><span class="line">  authorization: enabled</span><br><span class="line">  </span><br><span class="line"><span class="comment"># 3. 启动, 查询所有用户</span></span><br><span class="line">mongod -f /opt/mongodb/mongodb.conf</span><br><span class="line">mongo 127.0.0.1:12345 -u ahao -p ahao</span><br><span class="line">use admin</span><br><span class="line">db.system.users.find()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 创建角色</span></span><br><span class="line">db.createRole(&#123;</span><br><span class="line">  _id: <span class="string">&quot;唯一id&quot;</span>,</span><br><span class="line">  role: <span class="string">&quot;角色名&quot;</span>,</span><br><span class="line">  db: <span class="string">&quot;数据库名&quot;</span>,</span><br><span class="line">  privileges: [</span><br><span class="line">    &#123; resource:&#123;db:<span class="string">&quot;数据库名&quot;</span>, collection:<span class="string">&quot;集合名&quot;</span>, actions:[允许执行的操作]&#125;&#125;</span><br><span class="line">  ]</span><br><span class="line">  roles: [继承哪些角色]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="集群keyfile"><a href="#集群keyfile" class="headerlink" title="集群keyfile"></a>集群keyfile</h2><p>keyfile文件认证</p>
<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p><code>mongodb</code>数据库不用新建, 直接<code>use</code>, 数据库会在插入记录的时候自动创建数据库及数据集合.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 新建数据库(插入记录时自动创建数据库及数据集合)</span></span><br><span class="line">use test_db</span><br><span class="line">db.test_collection.insert(&#123;x:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 显示数据库</span></span><br><span class="line">show dbs</span><br><span class="line">  admin   0.000GB</span><br><span class="line">  <span class="built_in">local</span>   0.000GB</span><br><span class="line">  test_db 0.000GB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除数据库</span></span><br><span class="line">use test_db</span><br><span class="line">db.dropDatabase()</span><br></pre></td></tr></table></figure>

<h1 id="表collection"><a href="#表collection" class="headerlink" title="表collection"></a>表collection</h1><p>同样, 数据表也是在插入时自动创建.<br>和关系型数据库不同, 不需要提前设置字段.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 切换到 test 数据库</span></span><br><span class="line">use test_db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 创建数据表(插入记录时自动创建)</span></span><br><span class="line">show collections <span class="comment"># 没有表</span></span><br><span class="line">db.test_collection.insert(&#123;x:1&#125;)</span><br><span class="line">show collections</span><br><span class="line">  test_collection</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除数据表</span></span><br><span class="line">&gt; db.test_collection.drop()</span><br></pre></td></tr></table></figure>

<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>在<code>v3.0.0</code>后, <a href="https://docs.mongodb.com/manual/reference/method/db.collection.ensureIndex/">官方文档</a>提到创建索引的函数<code>createIndex()</code>替换掉了<code>ensureIndex()</code>. 当然非要使用<code>ensureIndex()</code>也是可以的.<br>创建索引的格式: <code>db.集合名.createIndex(&#123;索引值&#125;, &#123;索引属性&#125;)</code></p>
<table>
<thead>
<tr>
<th align="center">索引属性</th>
<th align="center">语法</th>
<th align="center">默认</th>
</tr>
</thead>
<tbody><tr>
<td align="center">名称</td>
<td align="center"><code>db.集合名.createIndex(&#123;索引值&#125;, &#123;name:&quot;索引名称&quot;&#125;)</code></td>
<td align="center"><code>字段名_1</code>或<code>字段名_-1</code></td>
</tr>
<tr>
<td align="center">唯一性</td>
<td align="center"><code>db.集合名.createIndex(&#123;索引值&#125;, &#123;unique:[true or false]&#125;)</code></td>
<td align="center"><code>false</code></td>
</tr>
<tr>
<td align="center">稀疏性</td>
<td align="center"><code>db.集合名.createIndex(&#123;索引值&#125;, &#123;sparse:[true or false]&#125;)</code></td>
<td align="center"><code>true</code>, 避免为插入记录不存在的字段创建索引</td>
</tr>
<tr>
<td align="center">是否定时删除</td>
<td align="center"><code>db.集合名.createIndex(&#123;索引值&#125;, &#123;expireAfterSeconds:秒数&#125;)</code></td>
<td align="center">不删除</td>
</tr>
</tbody></table>
<h2 id="没有属性的普通索引"><a href="#没有属性的普通索引" class="headerlink" title="没有属性的普通索引"></a>没有属性的普通索引</h2><table>
<thead>
<tr>
<th align="center">索引类型</th>
<th align="center">说明</th>
<th align="center">创建方法(1为正序, -1为逆序)</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>_id</code>索引</td>
<td align="center">自动创建的索引, 作为记录的唯一主键</td>
<td align="center"><code>db.test_collection.insert(&#123;name:1&#125;)</code></td>
</tr>
<tr>
<td align="center">单键索引</td>
<td align="center">为一个字段创建的索引, 字段值为<strong>单个</strong>元素</td>
<td align="center"><code>db.test_collection.createIndex(&#123;name:1&#125;)</code></td>
</tr>
<tr>
<td align="center">多键索引</td>
<td align="center">为一个字段创建的索引, 字段值为<strong>数组</strong>元素</td>
<td align="center"><code>db.test_collection.createIndex(&#123;class:1&#125;)</code></td>
</tr>
<tr>
<td align="center">复合索引</td>
<td align="center">为<strong>多个</strong>字段创建的索引</td>
<td align="center"><code>db.test_collection.createIndex(&#123;name:1, age:1&#125;)</code></td>
</tr>
</tbody></table>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 使用 test 数据库</span></span><br><span class="line">use test_db</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. 查看索引, 格式: db.数据集合.getIndexes()</span></span><br><span class="line">db.test_collection.getIndexes()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. _id索引自动创建, 每条插入的数据都会自动生成一个`_id`字段, 作为`key`.</span></span><br><span class="line">db.test_collection.insert(&#123;name:<span class="string">&quot;Tom&quot;</span>, age:12, friends:[<span class="string">&quot;Sum&quot;</span>, <span class="string">&quot;Kim&quot;</span>]&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 创建索引, 格式: db.数据表.createIndex(&#123;索引字段: [1|-1]&#125;), 1为正序, -1为逆序</span></span><br><span class="line"><span class="comment">## 单个元素的单键索引</span></span><br><span class="line">db.test_collection.createIndex(&#123;name:1&#125;)</span><br><span class="line"><span class="comment">## 多个元素的多键索引</span></span><br><span class="line">db.test_collection.createIndex(&#123;friends:1&#125;)</span><br><span class="line"><span class="comment">## 多个字段的复合索引</span></span><br><span class="line">db.test_collection.createIndex(&#123;name:1, age:1&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 删除索引</span></span><br><span class="line">db.test_collection.dropIndex(<span class="string">&quot;索引名&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="过期索引TTL"><a href="#过期索引TTL" class="headerlink" title="过期索引TTL"></a>过期索引TTL</h2><p>一定时间后会过期的索引, 存储的值必须是时间类型, 如<code>new Date()</code>. 如果是数组, 则取最小的时间.<br>一个字段不能同时有过期索引和复合索引. </p>
<p>当数据过期时, 对应的数据会自动删除. 但是<code>mongodb</code>删除任务<code>60</code>秒执行一次, 所以过期时间最好不要小于<code>60</code>秒.<br>适用于登录信息、日志信息、缓存等不重要的信息.<br>创建语法: <code>db.数据集合.createIndex(&#123;时间字段:1&#125;, &#123;expireAfterSeconds:秒数&#125;)</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 初始化数据</span></span><br><span class="line">use test_db</span><br><span class="line">db.login_info.insert(&#123;name:<span class="string">&quot;Tom&quot;</span>, login_time:new Date()&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建索引, 10秒后过期</span></span><br><span class="line">db.login_info.createIndex(&#123;login_time:1&#125;, &#123;expireAfterSeconds:10&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待过期后, 查询不到过期数据</span></span><br><span class="line">db.login_info.find()</span><br></pre></td></tr></table></figure>

<h2 id="文本索引"><a href="#文本索引" class="headerlink" title="文本索引"></a>文本索引</h2><p>说是文本索引, 其实就是对选择的字段进行分词索引. 所选的字段可以一个, 也可以多个.<br>一个数据集只有一个文本索引, 且只能是字符串类型的字段.<br>查询文本索引时, 不允许使用<code>hint()</code>指定索引进行查询.<br>创建语法: <code>db.数据集合.createIndex(&#123;字段:&quot;text&quot;&#125;)</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 单个字段的文本索引</span></span><br><span class="line">db.test_collection.createIndex(&#123;name:<span class="string">&quot;text&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># 多个字段的文本索引</span></span><br><span class="line">db.test_collection.createIndex(&#123;name:<span class="string">&quot;text&quot;</span>, address:<span class="string">&quot;text&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># 所有字段的文本索引</span></span><br><span class="line">db.test_collection.createIndex(&#123;<span class="string">&quot;$**&quot;</span>:<span class="string">&quot;text&quot;</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>查询语法, 多个关键字用空格分隔, 默认为<code>or</code>查询.</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">语法</span><br><span class="line">db.test_collection.find(&#123;</span><br><span class="line">  <span class="variable">$text</span>: &#123;</span><br><span class="line">    <span class="variable">$search</span>: 搜索字符串, </span><br><span class="line">    <span class="variable">$language</span>: 指定语言(社区版不支持中文),</span><br><span class="line">    <span class="variable">$caseSensitive</span>: 是否大小写敏感(默认<span class="literal">false</span>),</span><br><span class="line">    <span class="variable">$diacriticSensitive</span>: 是否区别发音符号(默认<span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询单个关键词, 匹配包含hello或world的文本</span></span><br><span class="line">db.test_collection.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;hello world&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment"># 查询单个关键词, 匹配包含hello world的文本</span></span><br><span class="line">db.test_collection.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;\&quot;hello world\&quot;&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment"># 查询多个关键词, 匹配包含hello且不包含world的文本</span></span><br><span class="line">db.test_collection.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;hello -world&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment"># 查询多个关键词, 查询包含ssl certificate 且 包含authority或key或ssl或certificate中任意一个 的文本</span></span><br><span class="line">db.test_collection.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;\&quot;ssl certificate\&quot; authority key&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment"># 文本相似度排序</span></span><br><span class="line">db.test_collection.find(&#123;<span class="variable">$text</span>:&#123;<span class="variable">$search</span>:<span class="string">&quot;hello&quot;</span>&#125;&#125;, &#123;score:&#123;<span class="variable">$meta</span>:<span class="string">&quot;textScore&quot;</span>&#125;&#125;).<span class="built_in">sort</span>(&#123;score:&#123;<span class="variable">$meta</span>:<span class="string">&quot;textScore&quot;</span>&#125;&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="2d地理位置索引-平面"><a href="#2d地理位置索引-平面" class="headerlink" title="2d地理位置索引(平面)"></a>2d地理位置索引(平面)</h2><p>插入语法: <code>db.数据集合.insert(&#123;字段名:[经度(-180,180), 纬度(-90,90)]&#125;)</code><br>创建语法: <code>db.数据集合.createIndex(&#123;字段:&quot;2d&quot;&#125;,&#123;min:最小值,max:最大值,bits:精度(默认26) &#125;)</code></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># $near查询距离(10,20)最近的点</span></span><br><span class="line">db.test_location.find(&#123;loc:&#123;<span class="variable">$near</span>:[10,20]&#125;&#125;)</span><br><span class="line"><span class="comment"># $near查询距离(10,20)最近的10个点</span></span><br><span class="line">db.test_location.find(&#123;loc:&#123;<span class="variable">$near</span>:[10,20]&#125;&#125;).<span class="built_in">limit</span>(10)</span><br><span class="line"><span class="comment"># $near查询距离(10,20)最大距离为10的点</span></span><br><span class="line">db.test_location.find(&#123;loc:&#123;<span class="variable">$near</span>:[10,20], <span class="variable">$maxDistance</span>:10&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># $geoWithin 查询某个形状内的点</span></span><br><span class="line"><span class="comment"># 查询对角坐标为(1,2),(3,4)组成的矩形内的点</span></span><br><span class="line">db.test_location.find(&#123;loc:&#123;<span class="variable">$geoWithin</span>:&#123;<span class="variable">$box</span>:[[1,2],[3,4]]&#125;&#125;&#125;)</span><br><span class="line"><span class="comment"># 查询圆心坐标为(1,2), 半径为3的圆内的点</span></span><br><span class="line">db.test_location.find(&#123;loc:&#123;<span class="variable">$geoWithin</span>:&#123;<span class="variable">$center</span>:[[1,2], 3]&#125;&#125;&#125;)</span><br><span class="line"><span class="comment"># 查询坐标为(1,2),(1,10),(2,10),(1,5)组成的多边形内的点</span></span><br><span class="line">db.test_location.find(&#123;loc:&#123;<span class="variable">$geoWithin</span>:&#123;<span class="variable">$polygon</span>:[[1,2], [1,10], [2,10], [1,5]]&#125;&#125;&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回更多数据的查询</span></span><br><span class="line">db.runCommand(&#123;</span><br><span class="line">    geoNear: 集合名,</span><br><span class="line">    near: [x,y],</span><br><span class="line">    minDistance: 最小距离(对2d索引无效, 对2dsphere索引有效),</span><br><span class="line">    maxDistance: 最大距离</span><br><span class="line">    num: 数量</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h2 id="2dsphere地理位置索引-球面"><a href="#2dsphere地理位置索引-球面" class="headerlink" title="2dsphere地理位置索引(球面)"></a>2dsphere地理位置索引(球面)</h2><p>插入语法: <code>db.数据集合.insert(&#123;字段名:&#123;type:&quot;Point&quot;,coordinates:[经度(-180,180), 纬度(-90,90)]&#125;&#125;)</code><br>创建语法: <code>db.数据集合.createIndex(&#123;字段:&quot;2dsphere&quot;&#125;)</code><br>点用<code>GeoJSON</code>的形式表示, 参考<a href="https://docs.mongodb.com/manual/reference/geojson/">GeoJSON Objects</a></p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 返回更多数据的查询</span></span><br><span class="line">db.runCommand(&#123;</span><br><span class="line">    geoNear: 集合名,</span><br><span class="line">    near: GeoJSON形式的值,</span><br><span class="line">    minDistance: 最小距离(对2d索引无效, 对2dsphere索引有效),</span><br><span class="line">    maxDistance: 最大距离</span><br><span class="line">    num: 数量</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="插入更新删除"><a href="#插入更新删除" class="headerlink" title="插入更新删除"></a>插入更新删除</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 插入数据, 格式: db.数据表.insert(json);</span></span><br><span class="line"><span class="comment"># 插入单条数据</span></span><br><span class="line">&gt; db.test_collection.insert(&#123;name:<span class="string">&quot;小明&quot;</span>, age: 10&#125;)</span><br><span class="line"><span class="comment"># 插入多条数据</span></span><br><span class="line">&gt; <span class="keyword">for</span>(i=1;i&lt;3;i++) db.test_collection.insert(&#123;name:<span class="string">&quot;name&quot;</span>+i, age:i&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 更新数据, 格式: db.数据表.update(查询条件, 修改后的值, 是否不存在则插入, 是否批量更新);</span></span><br><span class="line"><span class="comment">## 会覆盖所有字段, age 字段会删除</span></span><br><span class="line">&gt; db.test_collection.update(&#123;name:<span class="string">&quot;小明&quot;</span>&#125;, &#123;name:<span class="string">&quot;新名字&quot;</span>&#125;)</span><br><span class="line"><span class="comment">## 只更新 name 字段, age 字段不会更新</span></span><br><span class="line">&gt; db.test_collection.update(&#123;name:<span class="string">&quot;小明&quot;</span>&#125;, &#123;<span class="variable">$set</span>&#123;name:<span class="string">&quot;新名字&quot;</span>&#125;&#125;)</span><br><span class="line"><span class="comment">## 不存在则插入数据</span></span><br><span class="line">&gt; db.test_collection.update(&#123;name:<span class="string">&quot;小红&quot;</span>&#125;, &#123;name:<span class="string">&quot;新小红&quot;</span>, age: 11&#125;, <span class="literal">true</span>)</span><br><span class="line"><span class="comment">## 批量更新</span></span><br><span class="line">&gt; db.test_collection.update(&#123;age:10&#125;, &#123;<span class="variable">$set</span>&#123;age: 21&#125;&#125;, <span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 删除数据</span></span><br><span class="line">&gt; db.test_collection.remove(&#123;age:21&#125;)</span><br></pre></td></tr></table></figure>

<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查询所有数据</span></span><br><span class="line">db.test_collection.find()</span><br><span class="line"><span class="comment"># 查询总数</span></span><br><span class="line">db.test_collection.find().count()</span><br><span class="line"><span class="comment"># 查询第4条到第7条数据, 按name倒序排序</span></span><br><span class="line">db.test_collection.find().skip(3).<span class="built_in">limit</span>(4).<span class="built_in">sort</span>(&#123;name: -1&#125;)</span><br><span class="line"><span class="comment"># 查询一条数据</span></span><br><span class="line">db.test_collection.findOne(&#123;name:<span class="string">&quot;小明&quot;</span>&#125;)</span><br><span class="line"><span class="comment"># 查询存在某个字段的记录</span></span><br><span class="line">&gt; db.test_collection.find(&#123;x:&#123;<span class="variable">$exists</span>:<span class="literal">true</span>&#125;&#125;)</span><br><span class="line"><span class="comment"># 按写入顺序逆序10条记录</span></span><br><span class="line">&gt; db.test_collection.find().<span class="built_in">sort</span>(&#123;<span class="variable">$natural</span>:-1&#125;).<span class="built_in">limit</span>(10)</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>MongoDB</category>
      </categories>
      <tags>
        <tag>MongoDB</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL常用语句</title>
    <url>/posts/common_MySQL_command.html</url>
    <content><![CDATA[<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>本文记录常用MySQL语句</p>
<span id="more"></span>

<h1 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 创建用户, 用户通过指定ip地址登录 </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> 用户名<span class="variable">@ip</span>_address identified <span class="keyword">by</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"># 创建用户, 用户通过任意ip地址登录 </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">user</span> 用户名@<span class="string">&#x27;%&#x27;</span>        identified <span class="keyword">by</span> <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mysql.user(Host,<span class="keyword">User</span>,Password) <span class="keyword">values</span> (<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="string">&#x27;用户名&#x27;</span>, password(<span class="string">&#x27;密码&#x27;</span>))</span><br><span class="line"></span><br><span class="line"># 删除用户user1</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">user</span> user1<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span>; </span><br><span class="line"># 删除匿名用户</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mysql.user <span class="keyword">where</span> <span class="keyword">user</span><span class="operator">=</span><span class="string">&#x27;&#x27;</span>; </span><br><span class="line"></span><br><span class="line"># 分配mydb所有表的指定权限给user1</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">create</span>,<span class="keyword">alter</span>,<span class="keyword">drop</span>,<span class="keyword">insert</span>,<span class="keyword">update</span>,<span class="keyword">delete</span>,<span class="keyword">select</span> <span class="keyword">on</span> mydb.<span class="operator">*</span> <span class="keyword">to</span> user1<span class="variable">@localhost</span>; </span><br><span class="line"># 分配mydb数据库所有表的所有权限给user2</span><br><span class="line"><span class="keyword">grant</span> <span class="keyword">all</span> <span class="keyword">on</span> mydb.<span class="operator">*</span> <span class="keyword">to</span> user2<span class="variable">@localhost</span>; </span><br><span class="line"></span><br><span class="line"># 撤销user1对mydb所有表的<span class="keyword">create</span>权限 </span><br><span class="line"><span class="keyword">revoke</span> <span class="keyword">create</span> <span class="keyword">on</span> mydb.<span class="operator">*</span> <span class="keyword">from</span> user1<span class="variable">@localhost</span>; </span><br><span class="line"></span><br><span class="line"># 查看user1的权限 </span><br><span class="line"><span class="keyword">show</span> grants <span class="keyword">for</span> user1<span class="variable">@localhost</span>; </span><br><span class="line"></span><br><span class="line"># 修改用户密码, 需要指定用户名和登录ip</span><br><span class="line"><span class="keyword">set</span> password <span class="keyword">for</span> root<span class="variable">@127</span><span class="number">.0</span><span class="number">.0</span><span class="number">.1</span><span class="operator">=</span>password(<span class="string">&#x27;新密码&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 创建数据库</span><br><span class="line"><span class="keyword">create</span> database [if <span class="keyword">not</span> <span class="keyword">exists</span>] db_name [charset<span class="operator">=</span>utf8] [<span class="keyword">collate</span> utf8_general_ci];</span><br><span class="line"></span><br><span class="line"># 删除数据库</span><br><span class="line"><span class="keyword">drop</span> database [if <span class="keyword">exists</span>] db_name;</span><br><span class="line"></span><br><span class="line"># 修改数据库编码</span><br><span class="line"><span class="keyword">alter</span> database db_name <span class="type">character</span> <span class="keyword">set</span> utf8</span><br></pre></td></tr></table></figure>

<h1 id="表"><a href="#表" class="headerlink" title="表"></a>表</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 常用建表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> [模式名.]表名</span><br><span class="line">(</span><br><span class="line">    <span class="comment">/* 可以有多个列定义 */</span></span><br><span class="line">    <span class="comment">/* 列名 数据类型 [列级约束] */</span></span><br><span class="line">    columnName1 datatype [<span class="keyword">default</span> expr]</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4 COMMENT<span class="operator">=</span><span class="string">&#x27;备注&#x27;</span>;</span><br><span class="line"></span><br><span class="line"># 子查询建表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> [模式名.]表名</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">subquery # 如 <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> 表</span><br><span class="line"></span><br><span class="line"># 修改表结构</span><br><span class="line">## 表改名</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 rename <span class="keyword">to</span> 新表名</span><br><span class="line"></span><br><span class="line">## 添加列</span><br><span class="line">## 新增列不可指定非空约束，除非有默认约束</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名</span><br><span class="line"><span class="keyword">add</span></span><br><span class="line">(</span><br><span class="line">    <span class="comment">/* 可以有多个列定义 */</span></span><br><span class="line">    <span class="comment">/* 列名 数据类型 [列级约束] */</span></span><br><span class="line">    columnName1 datatype [<span class="keyword">default</span> expr]</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">## 修改列</span><br><span class="line">## modify一次只能修改一列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 modify 列名 [新列名] 数据类型 [<span class="keyword">default</span> expr] [<span class="keyword">first</span><span class="operator">|</span>after 列名]</span><br><span class="line"></span><br><span class="line">## 删除列</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> 表名 <span class="keyword">drop</span> 列名</span><br><span class="line"></span><br><span class="line"># 删除表, 表数据、约束、索引也被删除</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> 表名</span><br><span class="line"></span><br><span class="line"># 清空数据，保留表结构</span><br><span class="line"><span class="keyword">truncate</span> 表名</span><br></pre></td></tr></table></figure>

<h1 id="索引"><a href="#索引" class="headerlink" title="索引"></a>索引</h1><p>索引是存放在<code>模式</code>中的一个数据库对象，在数据字典中独立存放，属于某个表，作用是加速对表的查询。</p>
<p><strong>创建的两种方式</strong></p>
<ol>
<li>自动：当在表上定义主键约束、唯一约束、外键约束时，会自动创建</li>
<li>手动：通过<code>create index index_name on table_name(column[,column]...)</code>语句创建</li>
</ol>
<p><strong>删除的两种方式</strong></p>
<ol>
<li>自动：数据表被删除时，该表的索引被删除</li>
<li>手动：通过<code>drop index index_name on table_name</code>语句删除</li>
</ol>
<h1 id="插入更新删除"><a href="#插入更新删除" class="headerlink" title="插入更新删除"></a>插入更新删除</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 插入</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name [ ( <span class="keyword">column</span> [, column...] ) ]</span><br><span class="line"><span class="keyword">values</span> ( <span class="keyword">value</span> [, value...]);</span><br><span class="line"></span><br><span class="line"># 使用子查询插入数据，要求插入数据列和数据类型匹配</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> table_name [ ( <span class="keyword">column</span> [, column...] ) ]</span><br><span class="line">subquery</span><br><span class="line"></span><br><span class="line"># 更新</span><br><span class="line"><span class="keyword">update</span> table_name</span><br><span class="line"><span class="keyword">set</span> column1 <span class="operator">=</span> value1 [ , column2 <span class="operator">=</span> value2 ]...</span><br><span class="line">[<span class="keyword">where</span> <span class="keyword">condition</span>];</span><br><span class="line"></span><br><span class="line"># 删除</span><br><span class="line"><span class="keyword">delete</span> <span class="keyword">from</span> table_name [<span class="keyword">where</span> <span class="keyword">condition</span>];</span><br></pre></td></tr></table></figure>

<h1 id="查询"><a href="#查询" class="headerlink" title="查询"></a>查询</h1><p><strong>单表查询</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 查找不重复姓名的学生信息</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span> sname <span class="keyword">from</span> stu;</span><br><span class="line"></span><br><span class="line"># <span class="keyword">not</span>取反</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> sname <span class="keyword">where</span> <span class="keyword">not</span> sid<span class="operator">=</span><span class="number">2</span>; # 查找sid不等于<span class="number">2</span>的学生信息</span><br><span class="line"></span><br><span class="line"># between...and之间</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sid <span class="keyword">between</span> <span class="number">2</span> <span class="keyword">and</span> <span class="number">4</span>; # 查找学号在[<span class="number">2</span>,<span class="number">4</span>]区间中的学生信息</span><br><span class="line"></span><br><span class="line"># <span class="keyword">in</span>集合</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sid <span class="keyword">in</span> (<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>); # 查找学号在(<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>)集合中的学生信息</span><br><span class="line"></span><br><span class="line"># <span class="keyword">like</span>模糊查询</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sname <span class="keyword">like</span> <span class="string">&#x27;张_&#x27;</span>;  # 查找姓名为两个字开头为张的学生信息 </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sname <span class="keyword">like</span> <span class="string">&#x27;张%&#x27;</span>;  # 查找姓名为张开头的学生信息 </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sname <span class="keyword">like</span> <span class="string">&#x27;张\%&#x27;</span>; # 查找姓名为张<span class="operator">%</span>的学生信息，转义字符，标准<span class="keyword">SQL</span>中没有转义字符 </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sname <span class="keyword">like</span> <span class="string">&#x27;张\%&#x27;</span> <span class="keyword">escape</span> <span class="string">&#x27;\&#x27;</span>;   #<span class="string">&#x27;# 标准SQL使用escape声明转义字符</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># limit限制查询数量</span></span><br><span class="line"><span class="string">select * from stu limit 0, 5; # 查询stu表中从第0行开始的5条记录 </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># 外连接查询</span></span><br><span class="line"><span class="string">select s.*,t.* from stu s left  outer join teacher t on s.tid=t.tid; # 左外连接，左表为基础，右表数据可为null </span></span><br><span class="line"><span class="string">select s.*,t.* from stu s right outer join teacher t on s.tid=t.tid; # 右外连接，右表为基础，左表数据可为null </span></span><br><span class="line"><span class="string">select s.*,t.* from stu s full  outer join teacher t on s.tid=t.tid; # 全外连接，MySQL不支持 </span></span><br></pre></td></tr></table></figure>
<h1 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h1><p>不得使用外键与级联, 一切外键概念必须在应用层解决。<br>外键与级联更新适用于单机低并发, 不适合分布式、高并发集群;<br>级联更新是强阻塞, 存在数据库更新风暴的风险;<br>外键影响数据库的插入速度。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># <span class="keyword">not</span> <span class="keyword">null</span>约束</span><br><span class="line"># 非空约束，确保指定列不为空，只能作为列级约束。</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu ( sid <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span> );   <span class="comment">/* 建表时指定非空约束   */</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu modify sid <span class="type">int</span> <span class="keyword">not</span> <span class="keyword">null</span>; <span class="comment">/* 修改表时指定非空约束 */</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu modify sid <span class="type">int</span> <span class="keyword">null</span>;     <span class="comment">/* 修改表时取消非空约束 */</span></span><br><span class="line"></span><br><span class="line"># <span class="keyword">unique</span>约束</span><br><span class="line"># 唯一约束，确保指定列或多列组合不允许出现重复值，可作为表级约束和列级约束。</span><br><span class="line"># 多列唯一约束只能用表级约束语法。</span><br><span class="line"># 创建唯一约束时，`MySQL`会对应创建唯一索引，默认与列名相同。</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu ( sid <span class="type">int</span> <span class="keyword">unique</span> ); <span class="comment">/* 建表时指定列级唯一约束 */</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu (</span><br><span class="line">    sid <span class="type">int</span>,</span><br><span class="line">    <span class="comment">/* 使用表级约束语法建立唯一约束 */</span></span><br><span class="line">    <span class="keyword">unique</span> (sid),</span><br><span class="line">    <span class="comment">/* 使用表级约束语法建立唯一约束并指定约束名 */</span></span><br><span class="line">    <span class="comment">/* constraint uk_1 unique (sid), */</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> <span class="keyword">unique</span>(sid);       <span class="comment">/* 修改表结构增加唯一约束 */</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu modify sid <span class="type">int</span> <span class="keyword">unique</span>; <span class="comment">/* 修改表结构增加唯一约束 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">drop</span> index 约束名;     <span class="comment">/* 修改表结构删除唯一约束 */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="keyword">primary</span> key约束</span><br><span class="line"># 主键约束<span class="operator">=</span>非空约束<span class="operator">+</span>唯一约束，唯一标识一条记录，可作为表级约束和列级约束。</span><br><span class="line"># 多列主键约束只能用表级约束语法。</span><br><span class="line"># 可以为主键约束指定约束名，但没有用，最后`MySQL`都改为`<span class="keyword">PRIMARY</span>`。</span><br><span class="line"># 还可以设置为自增长`auto_increment`</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu ( sid <span class="type">int</span> <span class="keyword">primary</span> key auto_increment ); <span class="comment">/* 建表时指定列级主键约束 */</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu (</span><br><span class="line">    sid <span class="type">int</span>,</span><br><span class="line">    <span class="comment">/* 使用表级约束语法建立主键约束 */</span></span><br><span class="line">    <span class="keyword">primary</span> key ( sid ),</span><br><span class="line">    <span class="comment">/* 使用表级约束语法建立主键约束并指定约束名，对MySQL无效，最后都为PRIMARY */</span></span><br><span class="line">    <span class="comment">/* constraint pk_1 primary key ( sid ) */</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> <span class="keyword">primary</span> key(sid);       <span class="comment">/* 修改表结构增加主键约束 */</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu modify sid <span class="type">int</span> <span class="keyword">primary</span> key; <span class="comment">/* 修改表结构增加主键约束 */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">drop</span> <span class="keyword">primary</span> key; <span class="comment">/* 修改表结构删除主键约束 */</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># <span class="keyword">foreign</span> key约束</span><br><span class="line"># 外键确保了两个表之间的参照完整性。MySQL只支持表级约束</span><br><span class="line"># <span class="keyword">on</span> <span class="keyword">delete</span> cascade ：级联删除，删除所有表的相关的记录</span><br><span class="line"># <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">set</span> <span class="keyword">null</span>：置空删除，将所有表的相关记录的对应字段置<span class="keyword">null</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu (</span><br><span class="line">    sid <span class="type">int</span> unsigned <span class="keyword">primary</span> key auto_increment,</span><br><span class="line">    <span class="comment">/* 列级约束，MySQL支持，但不生效 */</span></span><br><span class="line">    <span class="comment">/* tid int reference teacher(tid) # stu.tid参照teacher.tid */</span></span><br><span class="line">    tid <span class="type">int</span>,</span><br><span class="line">    <span class="comment">/* 使用表级约束建立外键约束，默认为 表名_ibfk_n，n是从1开始的整数 */</span></span><br><span class="line">    <span class="keyword">foreign</span> key (tid) <span class="keyword">references</span> teacher(tid) <span class="keyword">on</span> <span class="keyword">delete</span> <span class="keyword">set</span> <span class="keyword">null</span></span><br><span class="line">    <span class="comment">/* 使用表级约束建立外键约束并指定约束名stu_tea_fk */</span></span><br><span class="line">    <span class="comment">/* constraint stu_tea_fk foreign key (tid) references teacher(tid) */</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">/* 修改表结构增加外键约束 */</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> stu <span class="keyword">add</span> <span class="keyword">foreign</span> key (tid) <span class="keyword">references</span> teacher(tid); </span><br><span class="line"></span><br><span class="line"><span class="comment">/* 删除外键约束 */</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">drop</span> <span class="keyword">foreign</span> key 约束名; </span><br><span class="line"></span><br><span class="line"># <span class="keyword">check</span>约束</span><br><span class="line">`MySQL`无效</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> stu(</span><br><span class="line">    sid <span class="type">int</span>,</span><br><span class="line">    age <span class="type">int</span>,</span><br><span class="line">    <span class="keyword">check</span>(age<span class="operator">&gt;</span><span class="number">0</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h1 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h1><p><strong>字符函数</strong></p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">concat(var… args)</td>
<td align="left">将所有字符串连接成一个字符串</td>
</tr>
<tr>
<td align="left">concat_ws(var delimiter, var… args)</td>
<td align="left">将所有字符串连接成一个字符串，子串之间用delimiter分割</td>
</tr>
<tr>
<td align="left">format(var num, var decimal)</td>
<td align="left">将数字格式化，四舍五入保留decimal位小数</td>
</tr>
<tr>
<td align="left">lower(var str)</td>
<td align="left">将所有字符转化为小写</td>
</tr>
<tr>
<td align="left">upper(var str)</td>
<td align="left">将所有字符转化为大写</td>
</tr>
<tr>
<td align="left">left(var str, var left)</td>
<td align="left">取字符串前left个字符</td>
</tr>
<tr>
<td align="left">right(var str, var right)</td>
<td align="left">取字符串后right个字符</td>
</tr>
<tr>
<td align="left">length(var str)</td>
<td align="left">计算字符串的长度</td>
</tr>
<tr>
<td align="left">ltrim(var str)</td>
<td align="left">删除字符串前导空格</td>
</tr>
<tr>
<td align="left">rtrim(var str)</td>
<td align="left">删除字符串后续空格</td>
</tr>
<tr>
<td align="left">trim(var str)</td>
<td align="left">删除字符串前导和后续空格，不能删除中间空格</td>
</tr>
<tr>
<td align="left">substring(var str, var start, var length)</td>
<td align="left">截取字符串从start个字符开始长度为length的字符<br/>start负值为倒数，length默认全部</td>
</tr>
<tr>
<td align="left">replace(var str, var old, var new)</td>
<td align="left">将字符串中的old字符串替换为new字符串</td>
</tr>
</tbody></table>
<p><strong>数值运算函数</strong></p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">ceil(var num)</td>
<td align="left">向上取整，2.6得3，2.1得3</td>
</tr>
<tr>
<td align="left">div</td>
<td align="left">整数除法，4/3==1，select 4 div 3;</td>
</tr>
<tr>
<td align="left">floor()</td>
<td align="left">向下取整，2.6得2，2.1得2</td>
</tr>
<tr>
<td align="left">mod</td>
<td align="left">取余数，5%3==2，select 5 mod 3;</td>
</tr>
<tr>
<td align="left">power(var base, var exponent)</td>
<td align="left">幂运算，2^3==8</td>
</tr>
<tr>
<td align="left">round(var num, var decimal)</td>
<td align="left">四舍五入保留decimal位小数，默认保留整数</td>
</tr>
<tr>
<td align="left">truncate(var num, var decimal)</td>
<td align="left">不四舍五入，直接截断保留decimal位小数，负数往前截断</td>
</tr>
</tbody></table>
<p><strong>日期时间函数</strong></p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">now()</td>
<td align="left">当前的日期和时间，2016-12-20 17:08:31</td>
</tr>
<tr>
<td align="left">curdate()</td>
<td align="left">当前日期，2016-12-20</td>
</tr>
<tr>
<td align="left">curtime()</td>
<td align="left">当前时间，17:08:31</td>
</tr>
<tr>
<td align="left">date_add(var now, interval var datetime)</td>
<td align="left">日期增减(正负)datetime单位时间，select date_add(‘2016-12-20’,interval 3 day)</td>
</tr>
<tr>
<td align="left">datediff(var now, var diff)</td>
<td align="left">计算now-diff的时间差，以天为单位</td>
</tr>
<tr>
<td align="left">date_format(var now, var format)</td>
<td align="left">日期格式转换为format格式<br/>select date_format(now(),’%Y年%m月%d日%H时%i分%s秒’);</td>
</tr>
</tbody></table>
<p><strong>数据库信息函数</strong></p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">connection_id()</td>
<td align="left">连接ID</td>
</tr>
<tr>
<td align="left">database()</td>
<td align="left">当前数据库名称</td>
</tr>
<tr>
<td align="left">last_insert_id()</td>
<td align="left">最后插入的记录的ID</td>
</tr>
<tr>
<td align="left">user()</td>
<td align="left">当前用户和地址</td>
</tr>
<tr>
<td align="left">version()</td>
<td align="left">版本号</td>
</tr>
</tbody></table>
<p><strong>加密函数</strong></p>
<table>
<thead>
<tr>
<th align="left">名称</th>
<th align="left">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="left">md5(var msg)</td>
<td align="left">信息摘要算法加密</td>
</tr>
<tr>
<td align="left">password(var msg)</td>
<td align="left">密码算法加密</td>
</tr>
</tbody></table>
<p><strong>自定义函数</strong></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 删除函数</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">function</span> 函数名;</span><br><span class="line"></span><br><span class="line"># 创建无参函数</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> now_cn() <span class="keyword">returns</span> <span class="type">varchar</span>(<span class="number">30</span>)</span><br><span class="line"><span class="keyword">return</span> date_format(now(), <span class="string">&#x27;%Y年%m月%d日 %H时%i分%s秒&#x27;</span>);</span><br><span class="line"></span><br><span class="line"># 创建有参函数</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> <span class="built_in">avg</span>(num1 <span class="type">int</span>, num2 <span class="type">int</span>) <span class="keyword">returns</span> <span class="type">float</span>(<span class="number">10</span>,<span class="number">2</span>)</span><br><span class="line"><span class="keyword">return</span> (num1<span class="operator">+</span>num2)<span class="operator">/</span><span class="number">2</span>;</span><br><span class="line"></span><br><span class="line"># 创建复合结构函数体的函数</span><br><span class="line"># 首先以`<span class="operator">/</span><span class="operator">/</span>`为结尾，替换;</span><br><span class="line"># 再在`<span class="keyword">begin</span>`和`<span class="keyword">end</span>`之间编写函数体</span><br><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> adduser(user_name <span class="type">varchar</span>(<span class="number">30</span>)) <span class="keyword">returns</span> <span class="type">int</span></span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(username) <span class="keyword">values</span>(user_name);</span><br><span class="line"><span class="keyword">return</span> last_insert_id();</span><br><span class="line"><span class="keyword">end</span><span class="operator">/</span><span class="operator">/</span></span><br></pre></td></tr></table></figure>

<h1 id="集合运算"><a href="#集合运算" class="headerlink" title="集合运算"></a>集合运算</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># <span class="keyword">union</span>并运算</span><br><span class="line"># 查找名字为张三的学生和年龄大于<span class="number">10</span>的学生的并集</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> sname<span class="operator">=</span><span class="string">&#x27;张三&#x27;</span> <span class="keyword">union</span> <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"># minus减运算</span><br><span class="line"># 查找年龄大于<span class="number">15</span>但不大于<span class="number">20</span>的学生的集合</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">15</span> minus <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">20</span> </span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">15</span> <span class="keyword">and</span> age <span class="keyword">not</span> <span class="keyword">in</span> (<span class="keyword">select</span> age <span class="keyword">from</span> stu <span class="keyword">where</span> age<span class="operator">&gt;</span><span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"># <span class="keyword">intersect</span>交运算</span><br><span class="line"># MySQL不支持，可用多表连接查询实现</span><br></pre></td></tr></table></figure>

<h1 id="视图"><a href="#视图" class="headerlink" title="视图"></a>视图</h1><p>视图可以看成是一个依赖一个或多个表的只读表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 创建</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">or</span> replace <span class="keyword">view</span> view_name</span><br><span class="line"><span class="keyword">as</span></span><br><span class="line">subquery</span><br><span class="line"><span class="keyword">with</span> <span class="keyword">check</span> option <span class="comment">/* 指定不允许修改该视图的数据 */</span></span><br><span class="line"></span><br><span class="line"># 删除</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">view</span> view_name</span><br></pre></td></tr></table></figure>

<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><ul>
<li>原子性（<code>Atomicity</code>）：是应用的最小执行单位，不可再分。</li>
<li>一致性（<code>Consistency</code>）：事务执行结果使数据库从一个一致性状态变为另一个一致性状态，通过原子性实现。</li>
<li>隔离性（<code>Isolation</code>）：各个事务相互独立互不干扰。</li>
<li>持续性（<code>Durability</code>）：事务一旦提交，所有更改都记录到永久存储器中。<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">begin</span>;                 # 临时开启事务 </span><br><span class="line"># <span class="keyword">start</span> transaction;   # 临时开启事务 </span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu(sname) <span class="keyword">values</span>(&quot;stu1&quot;);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu(sname) <span class="keyword">values</span>(&quot;stu2&quot;);</span><br><span class="line"># <span class="keyword">savepoint</span> a;         # 设置事务中间点 </span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> stu(sname) <span class="keyword">values</span>(&quot;stu3&quot;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu;   # 三条插入数据显示</span><br><span class="line"><span class="keyword">rollback</span>;            # 回滚事务 </span><br><span class="line"># <span class="keyword">rollback</span> <span class="keyword">to</span> a;     # 回滚到之前声明的事务中间点a </span><br><span class="line"># <span class="keyword">commit</span>;            # 或者显式提交事务 </span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> stu;   # 三条插入数据没有插入，回滚事务 </span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="存储过程-开发不建议使用"><a href="#存储过程-开发不建议使用" class="headerlink" title="存储过程(开发不建议使用)"></a>存储过程(开发不建议使用)</h1><p>存储过程是SQL语句和控制语句的预编译集合，减少了语法分析和编译的过程，提高执行效率。<br>存储过程难以调试和扩展，更没有移植性。</p>
<p>参数类型：</p>
<ul>
<li><code>IN</code>：表示该参数的值必须在调用存储过程时指定</li>
<li><code>OUT</code>：表示该参数的值可以被存储过程改变，并且可以返回</li>
<li><code>INOUT</code>：表示该参数的调用时指定，并且可以被改变和返回</li>
</ul>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"># 删除存储过程</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> 存储过程名;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">procedure</span> if <span class="keyword">exists</span> 存储过程名;</span><br><span class="line"></span><br><span class="line"># 创建无参存储过程</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pd_get_version()</span><br><span class="line"><span class="keyword">select</span> version();</span><br><span class="line"></span><br><span class="line"># 创建有参存储过程</span><br><span class="line">delimiter <span class="operator">/</span><span class="operator">/</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> pd_adduser(<span class="keyword">IN</span> user_name <span class="type">varchar</span>(<span class="number">20</span>), <span class="keyword">OUT</span> all_nums <span class="type">int</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> <span class="keyword">user</span>(username) <span class="keyword">values</span>(user_name);</span><br><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="operator">*</span>) <span class="keyword">from</span> <span class="keyword">user</span> <span class="keyword">into</span> all_nums;</span><br><span class="line"><span class="keyword">end</span><span class="operator">/</span><span class="operator">/</span></span><br><span class="line"></span><br><span class="line">delimiter ;</span><br><span class="line"># 使用存储过程</span><br><span class="line"><span class="keyword">call</span> 存储过程名(变量...);</span><br><span class="line"><span class="keyword">call</span> pd_adduser(<span class="string">&#x27;Tom&#x27;</span>, <span class="variable">@nums</span>);</span><br><span class="line"><span class="keyword">select</span> <span class="variable">@nums</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>MySQL获取字段注释comment</title>
    <url>/posts/MySQL_how_to_get_comment_of_table.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>web开发经常需要用到<code>&lt;table&gt;</code>显示数据。而<code>&lt;th&gt;</code>经常使用的是硬编码方式写死在代码中。<br>MySQL支持将添加字段注释，可获取注释信息，用来动态修改<code>&lt;th&gt;</code>的标题。</p>
<span id="more"></span>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p>现在有一张学生表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> student(</span><br><span class="line">    sid <span class="type">int</span> comment <span class="string">&#x27;student_id&#x27;</span>,</span><br><span class="line">    name <span class="type">varchar</span>(<span class="number">20</span>) comment <span class="string">&#x27;student_name&#x27;</span></span><br><span class="line">    tid <span class="type">int</span> comment <span class="string">&#x27;teacher_id&#x27;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>需要获取字段注释</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">List&lt;String&gt; comments = studentDao.getComments();</span><br><span class="line">//[student_id, student_name, teacher_id]</span><br></pre></td></tr></table></figure>

<p>通过以下sql语句即可完成</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> column_comment</span><br><span class="line"><span class="keyword">from</span> information_schema.columns</span><br><span class="line"><span class="keyword">where</span> table_schema <span class="operator">=</span> database()</span><br><span class="line"><span class="keyword">and</span> table_name <span class="operator">=</span> <span class="string">&#x27;student&#x27;</span>;</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>MySQL</category>
      </categories>
      <tags>
        <tag>MySQL</tag>
      </tags>
  </entry>
  <entry>
    <title>Redission在debug模式下抛出解锁异常</title>
    <url>/posts/not_locked_by_current_thread_by_node_id_in_debug_mode.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近用<code>Redission</code>出现一个很有趣的问题，在线上环境加锁解锁没有问题，但是一旦进行<code>debug</code>调试，就会抛出异常。</p>
<span id="more"></span>

<h1 id="场景复现"><a href="#场景复现" class="headerlink" title="场景复现"></a>场景复现</h1><p>编写以下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AhaoTest</span> &#123;</span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">unlockDebug</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">RLock</span> <span class="variable">lock</span> <span class="operator">=</span> redissonClient.getLock(REDIS_KEY);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> lock.tryLock();</span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            Assertions.fail(<span class="string">&quot;加锁失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 打断点30秒以上</span></span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">        Assertions.assertEquals(<span class="number">0</span>, lock.getHoldCount());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后以<code>debug</code>模式执行，在断点处停留<code>30</code>秒以上。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">java.lang.IllegalMonitorStateException: attempt to unlock lock, not locked by current thread by node id: e8f58212-5f8e-43db-94ba-606e07e9d984 thread-id: 1</span><br><span class="line">  at org.redisson.RedissonBaseLock.lambda$unlockAsync$1(RedissonBaseLock.java:312)</span><br><span class="line">  at org.redisson.misc.RedissonPromise.lambda$onComplete$0(RedissonPromise.java:187)</span><br><span class="line">  ...</span><br><span class="line">  at org.redisson.misc.RedissonPromise.trySuccess(RedissonPromise.java:82)</span><br><span class="line">  at org.redisson.RedissonBaseLock.lambda$evalWriteAsync$0(RedissonBaseLock.java:224)</span><br><span class="line">  at org.redisson.misc.RedissonPromise.lambda$onComplete$0(RedissonPromise.java:187)</span><br><span class="line">  ...</span><br><span class="line">  at io.netty.util.concurrent.DefaultPromise.trySuccess(DefaultPromise.java:104)</span><br><span class="line">  at org.redisson.misc.RedissonPromise.trySuccess(RedissonPromise.java:82)</span><br><span class="line">  at org.redisson.command.CommandBatchService.lambda$executeAsync$7(CommandBatchService.java:326)</span><br><span class="line">  at org.redisson.misc.RedissonPromise.lambda$onComplete$0(RedissonPromise.java:187)</span><br><span class="line">  ...</span><br><span class="line">  at org.redisson.misc.RedissonPromise.trySuccess(RedissonPromise.java:82)</span><br><span class="line">  at org.redisson.command.RedisCommonBatchExecutor.handleResult(RedisCommonBatchExecutor.java:130)</span><br><span class="line">  at org.redisson.command.RedisExecutor.checkAttemptPromise(RedisExecutor.java:447)</span><br><span class="line">  at org.redisson.command.RedisExecutor.lambda$execute$3(RedisExecutor.java:169)</span><br><span class="line">  at org.redisson.misc.RedissonPromise.lambda$onComplete$0(RedissonPromise.java:187)</span><br><span class="line">  ...</span><br><span class="line">  at org.redisson.misc.RedissonPromise.trySuccess(RedissonPromise.java:82)</span><br><span class="line">  at org.redisson.client.handler.CommandDecoder.decodeCommandBatch(CommandDecoder.java:293)</span><br><span class="line">  at org.redisson.client.handler.CommandDecoder.decodeCommand(CommandDecoder.java:188)</span><br><span class="line">  at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:116)</span><br><span class="line">  at org.redisson.client.handler.CommandDecoder.decode(CommandDecoder.java:101)</span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>

<p>可以看到，这个异常堆栈很诡异，异常堆栈里没有任何我编写的代码的痕迹，全是<code>Redisson</code>和<code>Netty</code>的代码。</p>
<h1 id="排查问题"><a href="#排查问题" class="headerlink" title="排查问题"></a>排查问题</h1><h2 id="求助搜索引擎"><a href="#求助搜索引擎" class="headerlink" title="求助搜索引擎"></a>求助搜索引擎</h2><p>网上大部分都是锁使用方式不对，测试代码已经是最简化的了，正常执行的情况下不会有任何报错。</p>
<h2 id="异常信息里有node-id和thread-id"><a href="#异常信息里有node-id和thread-id" class="headerlink" title="异常信息里有node id和thread id"></a>异常信息里有node id和thread id</h2><p>先解释下这里的两个参数</p>
<ul>
<li><code>node id</code>是构造锁对象时，拿到的连接管理器<code>id</code></li>
<li><code>thread id</code>是当前线程<code>id</code></li>
</ul>
<p>所以我开始怀疑是否是因为<code>debug</code>模式下，导致这两个<code>id</code>发生了变化。</p>
<p><code>thread id</code>好拿，使用<code>Thread.currentThread().getId()</code>就拿到了。<br><code>node id</code>要去构造函数里面获取。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.redisson.RedissonBaseLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RedissonBaseLock</span> <span class="keyword">extends</span> <span class="title class_">RedissonExpirable</span> <span class="keyword">implements</span> <span class="title class_">RLock</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">RedissonBaseLock</span><span class="params">(CommandAsyncExecutor commandExecutor, String name)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(commandExecutor, name);</span><br><span class="line">        <span class="built_in">this</span>.commandExecutor = commandExecutor;</span><br><span class="line">        <span class="built_in">this</span>.id = commandExecutor.getConnectionManager().getId();</span><br><span class="line">        <span class="comment">// 这里打断点, 得到node id为ef35f099-4f38-48c2-93d6-2136b8c160aa</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一通折腾完，发现<code>node id</code>和<code>thread id</code>根本没变。</p>
<h2 id="分析异常堆栈"><a href="#分析异常堆栈" class="headerlink" title="分析异常堆栈"></a>分析异常堆栈</h2><p>查看最顶层的异常堆栈位置<br><code>at org.redisson.RedissonBaseLock.lambda$unlockAsync$1(RedissonBaseLock.java:312)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.redisson.RedissonBaseLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RedissonBaseLock</span> <span class="keyword">extends</span> <span class="title class_">RedissonExpirable</span> <span class="keyword">implements</span> <span class="title class_">RLock</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> RFuture&lt;Void&gt; <span class="title function_">unlockAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">        RPromise&lt;Void&gt; result = <span class="keyword">new</span> <span class="title class_">RedissonPromise</span>&lt;&gt;();</span><br><span class="line">        RFuture&lt;Boolean&gt; future = unlockInnerAsync(threadId);</span><br><span class="line">        future.onComplete((opStatus, e) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">            <span class="keyword">if</span> (opStatus == <span class="literal">null</span>) &#123; <span class="comment">// 关注这里</span></span><br><span class="line">                <span class="type">IllegalMonitorStateException</span> <span class="variable">cause</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>(<span class="string">&quot;attempt to unlock lock, not locked by current thread by node id: &quot;</span> + id + <span class="string">&quot; thread-id: &quot;</span> + threadId);</span><br><span class="line">                result.tryFailure(cause);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 省略部分代码</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显，只有<code>opStatus</code>为<code>null</code>时才会进入这个<code>if</code>判断里。<br>这个<code>onComplete</code>明显是<code>unlockInnerAsync</code>异步解锁完成后的回调函数，那么是哪里调用了这个回调函数呢？<br>我们在这个<code>if</code>判断这里打个断点。里面有一些<code>netty</code>的代码，先跳过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.redisson.RedissonBaseLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">RedissonBaseLock</span> <span class="keyword">extends</span> <span class="title class_">RedissonExpirable</span> <span class="keyword">implements</span> <span class="title class_">RLock</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> &lt;T&gt; RFuture&lt;T&gt; <span class="title function_">evalWriteAsync</span><span class="params">(String key, Codec codec, RedisCommand&lt;T&gt; evalCommandType, String script, List&lt;Object&gt; keys, Object... params)</span> &#123;</span><br><span class="line">        <span class="type">CommandBatchService</span> <span class="variable">executorService</span> <span class="operator">=</span> createCommandBatchService();</span><br><span class="line">        <span class="comment">// redis异步执行lua脚本</span></span><br><span class="line">        RFuture&lt;T&gt; result = executorService.evalWriteAsync(key, codec, evalCommandType, script, keys, params);</span><br><span class="line">        <span class="keyword">if</span> (commandExecutor <span class="keyword">instanceof</span> CommandBatchService) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        RPromise&lt;T&gt; r = <span class="keyword">new</span> <span class="title class_">RedissonPromise</span>&lt;&gt;();</span><br><span class="line">        RFuture&lt;BatchResult&lt;?&gt;&gt; future = executorService.executeAsync();</span><br><span class="line">        future.onComplete((res, ex) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (ex != <span class="literal">null</span>) &#123;</span><br><span class="line">                r.tryFailure(ex);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 关注这里，这里的result.getNow()就是上面拿到的opStatus</span></span><br><span class="line">            r.trySuccess(result.getNow());</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们猜，这里的<code>result.getNow()</code>就是上面回调函数的入参<code>opStatus</code>，实际上如果你跟着我打断点，可以确定这个猜想是正确的。<br>这个<code>result</code>是<code>Redis</code>异步执行解锁<code>Lua</code>脚本的时候返回的。我们看看解锁脚本</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// org.redisson.RedissonLock</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RedissonLock</span> <span class="keyword">extends</span> <span class="title class_">RedissonBaseLock</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> RFuture&lt;Boolean&gt; <span class="title function_">unlockInnerAsync</span><span class="params">(<span class="type">long</span> threadId)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> evalWriteAsync(getRawName(), LongCodec.INSTANCE, RedisCommands.EVAL_BOOLEAN,</span><br><span class="line">                <span class="string">&quot;if (redis.call(&#x27;hexists&#x27;, KEYS[1], ARGV[3]) == 0) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil;&quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;local counter = redis.call(&#x27;hincrby&#x27;, KEYS[1], ARGV[3], -1); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;if (counter &gt; 0) then &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;pexpire&#x27;, KEYS[1], ARGV[2]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 0; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;else &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;del&#x27;, KEYS[1]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;redis.call(&#x27;publish&#x27;, KEYS[2], ARGV[1]); &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return 1; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;end; &quot;</span> +</span><br><span class="line">                        <span class="string">&quot;return nil;&quot;</span>,</span><br><span class="line">                Arrays.asList(getRawName(), getChannelName()), LockPubSub.UNLOCK_MESSAGE, internalLockLeaseTime, getLockName(threadId));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到<code>hexists</code>不存在的时候才会返回<code>null</code>。也就是<code>Redis</code>锁数据丢失了。<br>使用<code>redis-cli -h 127.0.0.1</code>命令上去看看，果然<code>get</code>不到数据了。<br>所以是因为<code>Redis</code>锁数据丢失，才导致异步解锁失败，抛出了异常。</p>
<h1 id="问题根因"><a href="#问题根因" class="headerlink" title="问题根因"></a>问题根因</h1><p>那么很奇怪，为什么加的锁为什么在<code>debug</code>模式会丢失数据呢？为什么不打断点就不会丢数据，而打断点就会丢失数据呢？</p>
<p>这里就涉及了<code>Redission</code>锁的自动续期机制，叫做<code>watch dog</code>。<br>简单的说，<code>Redission</code>默认加锁的存活时间是<code>30秒</code>，然后后台会有一个定时任务给这个<code>Redis Key</code>续期。</p>
<p>当我们打了断点后，<code>watch dog</code>就暂停了，无法对锁进行续期，导致加的锁在超出一定时间后就自动过期失效了。<br>后面放开断点，再去解锁，就解锁异常了。</p>
<p>线上环境是不允许打断点的，所以不会有这个问题。</p>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis学习笔记</title>
    <url>/posts/Redis_simple_use.html</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><code>Redis</code>是一种NoSQL(No Only SQL) 非关系型数据库，是高性能<code>键值对</code>数据库。<br>常用于缓存、分布式Session分离，或者任务队列，网站访问统计。<br><code>Redis</code>建议运行于<code>Linux</code>上。Java推荐<code>JRedis</code></p>
<span id="more"></span>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><p><code>/usr/local/redis/bin</code>有以下可执行文件</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">性能测试工具</span></span><br><span class="line">redis-benchmark</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF文件修复工具</span></span><br><span class="line">redis-check-aof</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RDB文件检查工具</span></span><br><span class="line">redis-check-dump</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">命令行客户端</span></span><br><span class="line">redis-cli</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">redis服务器启动命令</span></span><br><span class="line">redis-server</span><br></pre></td></tr></table></figure>

<p>在<code>/usr/local/redis/redis.conf</code>中修改配置信息</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许后台启动</span></span><br><span class="line">daemonize yes</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置服务启动端口为 6379</span></span><br><span class="line">port 6379</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置密码为 foobared</span></span><br><span class="line">requirepass foobared</span><br></pre></td></tr></table></figure>
<p>常用命令</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过配置信息启动Redis, 后台启动redis</span></span><br><span class="line">/usr/local/redis/bin/redis-server /usr/local/redis/redis.conf --port 6379</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入redis控制台</span></span><br><span class="line">/usr/local/redis/bin/redis-cli -p 6379 -h 127.0.0.1 -a 密码</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭redis</span></span><br><span class="line">/usr/local/redis/bin/redis-cli -p 6379 -h 127.0.0.1 -a 密码 shutdown</span><br></pre></td></tr></table></figure>


<h1 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h1><p>Redis有<code>string</code>、<code>hash</code>、<code>list</code>、<code>set</code>、<code>sorted-set</code>五种存储方式.</p>
<h2 id="字符串存储"><a href="#字符串存储" class="headerlink" title="字符串存储"></a>字符串存储</h2><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">set mykey value1 // 存储键值对</span><br><span class="line"></span><br><span class="line">get mykey // 输出value1</span><br><span class="line">getset mykey value2 // 输出value1，存入value2</span><br><span class="line"></span><br><span class="line">del mykey // 删除键为mykey的键值对，返回nil</span><br><span class="line"></span><br><span class="line">incr mykey // 自增1，若mykey不存在，则创建key为0，并自增1</span><br><span class="line">decr mykey // 自减1，若mykey不存在，则创建key为0，并自减1</span><br><span class="line">incrby mykey 5 // 自增5</span><br><span class="line">decrby mykey 5 // 自减5</span><br><span class="line"></span><br><span class="line">append mykey value // 在字符串末尾追加value</span><br></pre></td></tr></table></figure>

<h2 id="hash存储"><a href="#hash存储" class="headerlink" title="hash存储"></a>hash存储</h2><p>Hash存储一个对象，对象中可以创建属性。类似<code>Map&lt;Object, Collection&lt;Object&gt;&gt;</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">hset mykey field1 value1</span><br><span class="line">hmset mykey field1 value1 [fieldN valueN]</span><br><span class="line"></span><br><span class="line">hget mykey [field1]</span><br><span class="line">hmget mykey field1 [fieldN]</span><br><span class="line">hgetall mykey // 获取所有属性及属性值</span><br><span class="line"></span><br><span class="line">hdel mykey field1 [fieldN]</span><br><span class="line">del mykey // 删除整个key集合</span><br><span class="line"></span><br><span class="line">hincr by mykey field1 5 // key的field1属性自增5</span><br><span class="line">hexists mykey field1 // 判断mykey中的field1属性是否存在</span><br><span class="line">hlen mykey // 获取mykey中属性的数量</span><br><span class="line">hkeys mykey // 获取mykey中所有的属性名</span><br><span class="line">kvals mykey // 获取mykey中所有的属性值</span><br></pre></td></tr></table></figure>

<h2 id="list存储"><a href="#list存储" class="headerlink" title="list存储"></a>list存储</h2><p>按插入顺序排序的字符串链表，用于<code>消息队列</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lpush mylist a b c // 往mylist左侧依次插入a b c</span><br><span class="line">lpushx mylist a b c // 只有mylist存在才插入</span><br><span class="line">rpush mylist 1 2 3 // 往mylist右侧依次插入1 2 3</span><br><span class="line">rpushx mylist 1 2 3 // 只有mylist存在才插入</span><br><span class="line">lset mylist index value // 往mylist下标为index插入value</span><br><span class="line">linsert mylist before b x // 往mylist的第1个b元素之前插入x</span><br><span class="line">linsert mylist after b x // 往mylist的第1个b元素之后插入x</span><br><span class="line">rpoplpush mylist1 mylist2 // 弹出mylist1最后一个元素插入mylist2第一个元素</span><br><span class="line"></span><br><span class="line">lpop mylist // 弹出mylist左侧的第一个元素</span><br><span class="line">rpop mylist // 弹出mylist右侧的第一个元素</span><br><span class="line"></span><br><span class="line">lrange mylist 0 -1 // 查看链表第0个元素到倒数第1个元素</span><br><span class="line">llen mylist // mylist元素个数</span><br><span class="line"></span><br><span class="line">lrem mylist 2 value // 从左往右删除2个value</span><br><span class="line">lrem mylist -2 value // 从右往左删除2个value</span><br><span class="line">lrem mylist 0 value // 删除所有value</span><br></pre></td></tr></table></figure>

<h2 id="set存储"><a href="#set存储" class="headerlink" title="set存储"></a>set存储</h2><p>无排序的字符集合，类似<code>Set&lt;Object&gt;</code></p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">sadd myset a b c // 往myset中插入a b c</span><br><span class="line">srem myset a b // 删除元素a b </span><br><span class="line">smembers myset // 查看所有元素</span><br><span class="line">scard myset // 元素数量</span><br><span class="line">sismember myset a // set是否存在元素a</span><br><span class="line">srandmember myset // 返回set中随机一个成员</span><br><span class="line"></span><br><span class="line">sdiff myset1 myset2 // 差集运算</span><br><span class="line">sdiffstore myset3 myset1 myset2 // 将myset1和myset2差集运算结果存储到myset3</span><br><span class="line">sinter myset1 myset2 // 交集运算</span><br><span class="line">sinterstore myset3 myset1 myset2 // 将myset1和myset2交集运算结果存储到myset3</span><br><span class="line">sunion myset1 myset2 // 并集运算</span><br><span class="line">sunionstore myset3 myset1 myset2 // 将myset1和myset2并集运算结果存储到myset3</span><br></pre></td></tr></table></figure>

<h2 id="sorted-set存储"><a href="#sorted-set存储" class="headerlink" title="sorted-set存储"></a>sorted-set存储</h2><p>使用<code>分数</code>排序的set，常用于排行榜、构建索引数据</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">zadd myset 90 a 80 b 60 c</span><br><span class="line"></span><br><span class="line">zscore myset a // 获取myset中a的分数</span><br><span class="line">zcard myset // 元素数量</span><br><span class="line"></span><br><span class="line">zrange myset 0 -1 // 查看myset第0个元素到倒数第1个元素</span><br><span class="line">zrange myset 0 -1 withscores// 包括分数，从小到大排序</span><br><span class="line">zrevrange myset 0 -1 withscores// 从大到小排序</span><br><span class="line">zrangebyscore myset 0 100 withscores limit 0 2 // 查看myset分数在0-100之间第0-2个元素</span><br><span class="line">zcount myset 80 90 // 分数在80-90之间的元素个数</span><br><span class="line"></span><br><span class="line">zrem myset b c // 删除元素a b</span><br><span class="line">zremrangebyrank myset 0 -1 // 删除myset第0个元素到倒数第1个元素</span><br><span class="line">zremrangebyscore myset 80 100 // 删除分数在80-100之间的元素</span><br><span class="line"></span><br><span class="line">zincrby myset 5 a // a元素自增5</span><br></pre></td></tr></table></figure>

<h1 id="keys操作"><a href="#keys操作" class="headerlink" title="keys操作"></a>keys操作</h1><p>这里的key，相当于关系型数据库的table</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">keys my* // 获取所有的my开头的key</span><br><span class="line">del myset1 myset2 myset3 </span><br><span class="line">exists myset</span><br><span class="line">rename myset newset</span><br><span class="line">expire myset 1000 // 1000秒后过期</span><br><span class="line">ttl myset // 剩余超时时间</span><br><span class="line">type myset // 获取myset的类型, 如string、hash、set等</span><br></pre></td></tr></table></figure>

<h1 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h1><p>一个Redis实例可以提供16个数据库(下标0-15)</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">select 0 // 选择0号数据库(默认)</span><br><span class="line">move myset 1 // 移动myset到1号数据库</span><br></pre></td></tr></table></figure>

<h1 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h1><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">multi // 开启事务</span><br><span class="line">exec // 提交事务</span><br><span class="line">discard // 回滚事务</span><br></pre></td></tr></table></figure>

<h1 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h1><p>分为<code>RDB持久化</code>和<code>AOF持久化</code>两种</p>
<h2 id="RDB持久化-默认"><a href="#RDB持久化-默认" class="headerlink" title="RDB持久化(默认)"></a>RDB持久化(默认)</h2><p>指定时间间隔内将数据库写入磁盘<br>优势, 只包含一个备份文件, 性能最大化, 通过fork进程让子进程完成持久化操作, 启动效率比AOF高.<br>劣势, 不能最大限度避免数据丢失.<br><code>/usr/local/redis/redis.conf</code><br>save 900 1 900秒至少有一个key发生变化就持久化一次</p>
<p>dbfilename dump.rdb<br>dir ./<br>保存在当前目录的dump.rdb文件中</p>
<h2 id="AOF持久化"><a href="#AOF持久化" class="headerlink" title="AOF持久化"></a>AOF持久化</h2><p>以日志形式记录服务器每次操作<br>优势, 更高的数据安全性, 每秒同步、每修改同步、不同步, 当日志文件过大, 重写日志文件.<br>劣势, 运行效率低</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认关闭AOF方式</span></span><br><span class="line">appendonly no</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">产生日志文件名</span></span><br><span class="line">appendfilename &quot;appendonly.aof&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendsync always</span></span><br><span class="line">appendsync everysec</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">appendsync no 三种同步策略</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis慢查询日志</title>
    <url>/posts/Redis_slow_log.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Redis</code>的命令有一个生命周期, 比如发送一个<code>set key value</code>命令.</p>
<ol>
<li><code>Redis</code>客户端发送<code>set key value</code>到<code>Redis</code>服务端</li>
<li>因为<code>Redis</code>是单线程, 所以命令在队列中排队.</li>
<li><code>Redis</code>服务端执行<code>set key value</code>命令, 并产生结果</li>
<li><code>Redis</code>服务端将结果发送给<code>Redis</code>客户端</li>
</ol>
<p>而<code>Redis</code>命令的慢查询命令就是<code>Redis</code>服务端消耗时间较长的命令, 耗时过长是导致客户端超时的原因<strong>之一</strong>.</p>
<span id="more"></span>

<h1 id="慢查询配置"><a href="#慢查询配置" class="headerlink" title="慢查询配置"></a>慢查询配置</h1><p>慢查询其实就是一个固定长度的<code>FIFO</code>队列, 它保存在内存中.<br>既然是<code>FIFO</code>, 那么肯定会存在旧的慢查询丢失问题, 所以需要定期进行持久化到硬盘.</p>
<h2 id="修改配置文件重启-不推荐"><a href="#修改配置文件重启-不推荐" class="headerlink" title="修改配置文件重启(不推荐)"></a>修改配置文件重启(不推荐)</h2><p><code>Redis</code>配置文件在<code>/etc/redis.conf</code>下, 里面有两个属性.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 超过 10000 微秒的命令会被记录下来, 为0则记录所有命令, 为负数则禁用慢查询日志</span><br><span class="line">slowlog-log-slower-than 10000</span><br><span class="line"># 慢查询日志队列长度, slowlog reset 命令会清空队列回收内存</span><br><span class="line">slowlog-max-len 128</span><br></pre></td></tr></table></figure>
<p>实际我们不这样做, 因为<code>Redis</code>支持动态配置.</p>
<h2 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h2><p><code>Redis</code>可以通过命令, 将配置写入内存中, 再调用<code>config rewrite</code>回写到配置文件中.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">    <span class="comment"># 慢查询日志队列长度, slowlog reset 命令会清空队列回收内存</span></span><br><span class="line">    config <span class="built_in">set</span> slowlog-max-len 256</span><br><span class="line">    config get slowlog-max-len</span><br><span class="line">    <span class="comment"># 超过 20000 微秒的命令会被记录下来, 为0则记录所有命令, 为负数则禁用慢查询日志</span></span><br><span class="line">    config <span class="built_in">set</span> slowlog-log-slower-than 20000</span><br><span class="line">    config get slowlog-log-slower-than</span><br><span class="line">    config rewrite</span><br></pre></td></tr></table></figure>
<p><strong>注意! 如果<code>Redis Server</code>启动时没有指定配置文件, 则<code>config rewrite</code>会报错!</strong></p>
<p>所以需要指定配置文件</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">redis-server /etc/redis.conf</span><br></pre></td></tr></table></figure>

<h2 id="Docker-配置"><a href="#Docker-配置" class="headerlink" title="Docker 配置"></a>Docker 配置</h2><p>如果是<code>Docker</code>启动的话, <code>Image</code>里是没有<code>redis.conf</code>的, 需要自己映射<code>volume</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 准备外部文件</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/docker/redis/&#123;conf,data&#125; -p</span><br><span class="line"><span class="built_in">cp</span> /etc/redis.conf /opt/docker/redis/redis.conf</span><br><span class="line"><span class="built_in">cd</span> /opt/docker/redis</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 映射到容器内</span></span><br><span class="line">docker run -p 6380:6379 -v <span class="variable">$PWD</span>/data:/data -v <span class="variable">$PWD</span>/conf/redis.conf:/etc/redis/redis.conf -d redis redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>

<p>如果是<code>Docker-Compose</code>启动的话, 需要指定<code>volume</code>, 然后后台启动<code>docker-compose up -d</code>.</p>
<figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># https://github.com/docker-library/redis/issues/125#issuecomment-363322332</span></span><br><span class="line"><span class="attr">version:</span> <span class="string">&#x27;3&#x27;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis-data:/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">./conf/redis.conf:/etc/redis/redis.conf</span></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="attr">redis-data:</span></span><br></pre></td></tr></table></figure>

<h1 id="慢查询命令"><a href="#慢查询命令" class="headerlink" title="慢查询命令"></a>慢查询命令</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 查看慢查询里前100条命令, 注意这里是FIFO</span></span><br><span class="line">slowlog get 100;</span><br><span class="line"><span class="comment"># 2. 记录超过0毫秒的命令, 即所有命令记录下来</span></span><br><span class="line">config <span class="built_in">set</span> slowlog-log-slower-than 0</span><br><span class="line"><span class="comment"># 3. 执行命令</span></span><br><span class="line"><span class="built_in">set</span> k1 v1</span><br><span class="line"><span class="comment"># 4. 查看慢查询里前100条命令, 注意这里是FIFO</span></span><br><span class="line">slowlog get 100</span><br><span class="line"><span class="comment"># 1) 1) (integer) 1</span></span><br><span class="line"><span class="comment">#    2) (integer) 1549684719</span></span><br><span class="line"><span class="comment">#    3) (integer) 141</span></span><br><span class="line"><span class="comment">#    4) 1) &quot;set&quot;</span></span><br><span class="line"><span class="comment">#       2) &quot;k1&quot;</span></span><br><span class="line"><span class="comment">#       3) &quot;v1;&quot;</span></span><br><span class="line"><span class="comment">#    5) &quot;172.17.0.1:56592&quot;</span></span><br><span class="line"><span class="comment">#    6) &quot;&quot;</span></span><br><span class="line"><span class="comment"># 5. 清空慢查询队列</span></span><br><span class="line">slowlog reset</span><br></pre></td></tr></table></figure>
<p>可以看到慢查询日志由<code>6</code>个部分组成。<a href="https://redis.io/commands/slowlog">官方文档</a></p>
<table>
<thead>
<tr>
<th align="center">条目</th>
<th align="center">值</th>
<th align="center">说明</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center"><code>(integer) 1</code></td>
<td align="center">慢查询日志的<code>id</code>, 自增</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center"><code>(integer) 1549684719</code></td>
<td align="center">开始命令的<code>unix</code>时间戳</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center"><code>(integer) 141</code></td>
<td align="center">执行命令消耗的时间, 以微秒为单位</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center"><code>1) &quot;set&quot; 2) &quot;k1&quot; 3) &quot;v1;&quot;</code></td>
<td align="center">组成命令的参数, 以数组形式存放</td>
</tr>
<tr>
<td align="center">5</td>
<td align="center"><code>&quot;172.17.0.1:56592&quot;</code></td>
<td align="center"><code>4.0+</code>新增, 客户端的<code>ip:port</code></td>
</tr>
<tr>
<td align="center">6</td>
<td align="center"><code>&quot;&quot;</code></td>
<td align="center"><code>4.0+</code>新增, 客户端的名称</td>
</tr>
</tbody></table>
<h1 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h1><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># 不要设置过大, 默认10ms, 通常设置1ms</span><br><span class="line">config set slowlog-max-len 1</span><br><span class="line"># 不要设置过小, 通常设置1000左右</span><br><span class="line">config set slowlog-log-slower-than 1000</span><br></pre></td></tr></table></figure>
<p>慢查询日志是一个<code>FIFO</code>队列, 如果一段时间没有处理, 则旧的慢查询日志则会从队列移除, 所以我们需要定期持久化慢查询日志到硬盘, 通过定时任务插入<code>MySQL</code>等方式.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">slowlog get 100</span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://redis.io/commands/slowlog">slowlog官方文档</a></li>
<li><a href="https://segmentfault.com/a/1190000009915519">Redis高级功能 - 慢查询日志</a></li>
<li><a href="https://segmentfault.com/a/1190000014091287">docker 安装部署 redis（配置文件启动）</a></li>
</ul>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>Redis持久化RDB和AOF</title>
    <url>/posts/Redis_RDB_and_AOF.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>Redis</code>的高速建立在数据存储在内存中, 但是断电的话, 就会导致数据丢失的问题.<br>为此我们需要对数据进行持久化到硬盘中, 用于数据恢复.<br><code>Redis</code>提供了两种持久化存储方案, <code>Redis</code>在启动时会优先加载<code>AOF</code>文件恢复数据.</p>
<ol>
<li><code>AOF(Append Only File)</code>: 记录每次执行的命令到日志中, 恢复数据时重新执行一次日志文件中的命令.</li>
<li><code>RDB(Redis Database Backup)</code>: 将数据库的所有数据直接写入磁盘</li>
</ol>
<span id="more"></span>

<h1 id="RDB-Redis-Database-Backup"><a href="#RDB-Redis-Database-Backup" class="headerlink" title="RDB ( Redis Database Backup )"></a>RDB ( Redis Database Backup )</h1><p><code>RDB</code>会将当前<code>Redis</code>中所有存储的数据持久化到<code>dump.rdb</code>文件中.</p>
<h2 id="save-持久化-阻塞"><a href="#save-持久化-阻塞" class="headerlink" title="save 持久化 ( 阻塞 )"></a>save 持久化 ( 阻塞 )</h2><p><code>Redis</code>是单线程的, 所以<code>save</code>命令一旦执行, 其时间复杂度是<code>O(n)</code>, 数据量一大, <code>Redis</code>就会阻塞后面的请求.<br>所以一般不直接使用<code>save</code>命令进行持久化.</p>
<h2 id="bgsave-持久化-fork子进程"><a href="#bgsave-持久化-fork子进程" class="headerlink" title="bgsave 持久化 ( fork子进程 )"></a>bgsave 持久化 ( fork子进程 )</h2><p><code>Redis</code>提供了<code>bgsave</code>命令, <code>fork</code>一个子进程来进行<code>save</code>. 这样就不会阻塞住原本的进程.<br><code>fork</code>后的子进程执行<code>save</code>命令, 会创建一个临时<code>RDB</code>文件, 待持久化完毕后, 覆盖之前的<code>RDB</code>文件.<br>但是<code>fork</code>这个操作, 仍然是阻塞的, </p>
<h2 id="save-seconds-changes-定时持久化"><a href="#save-seconds-changes-定时持久化" class="headerlink" title="save seconds changes ( 定时持久化 )"></a>save seconds changes ( 定时持久化 )</h2><p><code>Redis</code>的配置文件中, 还提供了另一种<code>RDB</code>持久化方式, 格式: <code>save &lt;seconds&gt; &lt;changes&gt;</code></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># save &quot;&quot; # 关闭 RDB</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br></pre></td></tr></table></figure>
<p>表示<code>seconds</code>秒内改变了<code>changes</code>次数据, 则自动<code>bgsave</code>.<br>缺点也很明显, 无法控制生成RDB的频率</p>
<h2 id="最佳配置-开启-RDB-时"><a href="#最佳配置-开启-RDB-时" class="headerlink" title="最佳配置 ( 开启 RDB 时 )"></a>最佳配置 ( 开启 RDB 时 )</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 开启默认的 save 策略, save 60 10000 视数据量而定</span></span><br><span class="line">save 900 1</span><br><span class="line">save 300 10</span><br><span class="line">save 60 10000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 指定 RDB 文件名</span></span><br><span class="line">dbfilename dump-6379.rdb</span><br><span class="line"><span class="comment"># 3. 指定存储文件夹, 放RDB文件、AOF文件、log文件</span></span><br><span class="line"><span class="built_in">dir</span> /data</span><br><span class="line"><span class="comment"># 4. 指定 bgsave 发生错误时停止写入</span></span><br><span class="line">stop-writes-on-bgsave-error <span class="built_in">yes</span> </span><br><span class="line"><span class="comment"># 5. 压缩 RDB 文件</span></span><br><span class="line">rdbcompression <span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 6. 校验 RDB 文件</span></span><br><span class="line">rdbchecksum <span class="built_in">yes</span></span><br></pre></td></tr></table></figure>
<p>值得注意的是, 即使在配置文件中关闭<code>RDB</code>自动持久化, 在以下情况, 仍会产生<code>RDB</code>文件.</p>
<ol>
<li>主从复制之全量复制时, 会生成RDB文件</li>
<li><code>debug reload</code>重启Redis, 会生成RDB文件</li>
<li><code>redis-cli SHUTDOWN</code>保存退出时, 如果没有开启AOF, 则自动执行<code>bgsave</code></li>
</ol>
<h1 id="AOF-Append-Only-File"><a href="#AOF-Append-Only-File" class="headerlink" title="AOF(Append Only File)"></a>AOF(Append Only File)</h1><p><code>Redis</code>开启<code>AOF</code>持久化的时候, 每次写操作都会<strong>追加</strong>到日志文件中. 这个顺序写操作是很快的.<br>并且, <code>AOF</code>记录是直接写在操作系统层面的<code>cache</code>内存上的, 不是直接写入磁盘的. 基于内存的操作也是很快的.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 打开 AOF 持久化</span></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 三种 fsync 方式</span></span><br><span class="line"><span class="comment"># appendfsync always # 每次执行命令都会 fsync, 性能超级差</span></span><br><span class="line">appendfsync everysec <span class="comment"># 每秒执行 fsync</span></span><br><span class="line"><span class="comment"># appendfsync no     # 取决于操作系统执行 fsync (不可控)</span></span><br></pre></td></tr></table></figure>
<p>这里有三种配置方式, 一般生产环境都用<code>everysec</code>.<br>因为你既然用了<code>Redis</code>, 那肯定是为了应对超高并发的读写操作. 如果你用了<code>always</code>, 那相当于每次都写入磁盘, 就失去了读写内存带来的高性能优势了.</p>
<p>当然<code>AOF</code>日志文件不可能无限增长, 下面介绍下如何压缩重写<code>AOF</code>文件.</p>
<h2 id="手动重写"><a href="#手动重写" class="headerlink" title="手动重写"></a>手动重写</h2><p>假设要执行以下命令</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">set</span> a a</span><br><span class="line"><span class="built_in">set</span> a b</span><br><span class="line"><span class="built_in">set</span> a c</span><br></pre></td></tr></table></figure>
<p>那么<code>AOF</code>肯定不会傻傻的将这<code>3</code>条命令写到<code>AOF</code>文件中, 因为只要保证<code>set a c</code>即可.<br>忽略中间态, 这就是<code>AOF</code>重写.<br>可以极大的减少<code>AOF</code>文件大小, 加快<code>AOF</code>恢复速度.</p>
<p>要手动重写, 只需要执行<code>bgrewriteaof</code>命令即可.</p>
<ol>
<li>首先, <code>Redis</code>会<code>fork</code>一个子进程.</li>
<li>基于当前内存中的数据, 而不是之前的<code>AOF</code>文件, 来生成一个新的<code>AOF</code>文件.</li>
<li>此时<code>Redis</code>仍在接收写请求, 会往内存、旧<code>AOF</code>文件、新<code>AOF</code>文件, 三个地方写入日志.</li>
<li>新<code>AOF</code>文件生成完毕, 则会将内存中的<code>AOF</code>日志追加写入新<code>AOF</code>文件.</li>
<li>用新<code>AOF</code>文件覆盖旧<code>AOF</code>文件, 保证只有一个<code>AOF</code>文件.</li>
</ol>
<p>这里为什么要基于当前内存中的数据, 而不是之前的<code>AOF</code>文件, 来生成一个新的<code>AOF</code>文件呢?<br>因为这个<code>AOF</code>很容易出现破损的情况, 比如断电, 磁盘满了.<br>然后新<code>AOF</code>文件是根据破损的旧<code>AOF</code>文件生成的, 又是破损的<code>AOF</code>文件.<br>所以干脆基于内存已有数据生成新<code>AOF</code>文件.</p>
<p>然后<code>Redis</code>还提供了一个命令修复破损的<code>AOF</code>记录, <code>redis-check-aof --fix my.aof</code></p>
<h2 id="自动重写"><a href="#自动重写" class="headerlink" title="自动重写"></a>自动重写</h2><p><code>Redis</code>在<code>2.4</code>之后提供了自动重写<code>AOF</code>的功能, 就不用再去手动执行<code>bgrewriteaof</code>了.<br>配置文件<code>/etc/redis.conf</code>中提供了满足一定条件就自动重写的配置.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 当 AOF 文件大于某个值时进行重写</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="comment"># 2. AOF 文件增长率, 下次就是到达 128mb、 256mb 就会重写.</span></span><br><span class="line">auto-aof-rewrite-percentage 100 </span><br></pre></td></tr></table></figure>

<p>我们可以在<code>redis-cli</code>客户端查看<code>info</code>信息.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">info persistence</span><br><span class="line"><span class="comment"># AOF开启, 才会追加以下信息</span></span><br><span class="line"><span class="comment"># aof_current_size  AOF 文件当前大小</span></span><br><span class="line"><span class="comment"># aof_base_size     上次AOF文件重写时的大小</span></span><br></pre></td></tr></table></figure>

<p>当同时满足以下条件时, <code>AOF</code>文件会自动重写.</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">aof_current_size &gt; auto_aof_rewrite_min_size</span><br><span class="line">aof_current_size - aof_base_size / aof_base_size &gt; auto_aof_rewrite_percentage</span><br></pre></td></tr></table></figure>

<h2 id="最佳配置-开启-AOF-时"><a href="#最佳配置-开启-AOF-时" class="headerlink" title="最佳配置 ( 开启 AOF 时 )"></a>最佳配置 ( 开启 AOF 时 )</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 1. 开启 AOF</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 2. 指定 AOF 文件名</span></span><br><span class="line">appendfilename appendonly-6379.aof</span><br><span class="line"><span class="comment"># 3. 指定存储文件夹, 放RDB文件、AOF文件、log文件</span></span><br><span class="line"><span class="built_in">dir</span> /data</span><br><span class="line"><span class="comment"># 4. AOF 每秒保存一次, 宕机最多丢失一秒数据</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># 5. AOF 重写时是否正常执行 AOF</span></span><br><span class="line">no-appendfsync-on-rewrite <span class="built_in">yes</span></span><br><span class="line"><span class="comment"># 6. 当 AOF 文件大于 64mb 时进行重写, 视数据量而定</span></span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="comment"># 7. AOF 文件增长率, 下次就是到达 128mb、 256mb 就会重写</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br></pre></td></tr></table></figure>

<h1 id="当-RDB-遇到-AOF"><a href="#当-RDB-遇到-AOF" class="headerlink" title="当 RDB 遇到 AOF"></a>当 RDB 遇到 AOF</h1><ol>
<li><code>RDB</code>快照生成和<code>AOF</code>重写操作是互斥的, 同一时间只能有一个执行.</li>
<li>当同时有<code>RDB</code>和<code>AOF</code>文件的时候, 优先使用<code>AOF</code>文件进行数据恢复.</li>
</ol>
<h1 id="数据备份和恢复"><a href="#数据备份和恢复" class="headerlink" title="数据备份和恢复"></a>数据备份和恢复</h1><p>不管是<code>RDB</code>还是<code>AOF</code>, 每次生成都会覆盖掉原有的旧文件.<br>那么我们就需要定时的把旧的备份文件移动到别的目录下, 避免被覆盖掉.</p>
<ol>
<li>每小时复制一份<code>RDB</code>到备份目录下, 只保留<code>48</code>小时的数据</li>
<li>每天复制一份<code>RDB</code>到备份目录下, 只保留<code>1</code>个月的数据</li>
<li>每晚将服务器上所有<code>RDB</code>发送到远程的云存储上.</li>
</ol>
<p>既然有备份, 就会要恢复. 恢复<code>AOF</code>数据只要将<code>AOF</code>文件复制到<code>Redis</code>数据目录下, 然后重启<code>Redis</code>即可.<br>恢复<code>RDB</code>数据的方案就有点复杂了.</p>
<ol>
<li>停止<code>Redis</code>, 修改配置文件<code>appendonly no</code>.</li>
<li>复制<code>RDB</code>备份到<code>Redis</code>数据目录下, 重启<code>Redis</code>, 确认数据恢复.</li>
<li>在命令行热修改配置<code>config set appendonly yes</code>, 开启<code>AOF</code>.</li>
<li>停止<code>Redis</code>, 修改配置文件<code>appendonly yes</code>, 重启<code>Redis</code></li>
</ol>
<p>当<code>Redis</code>开启<code>AOF</code>的时候, 是优先使用<code>AOF</code>恢复数据的. 即使<code>AOF</code>文件被删除, 也会基于重启后的数据生成一份新的<code>AOF</code>文件, 然后覆盖掉你复制进来的有数据的<code>RDB</code>文件, 变成一个空的<code>RDB</code>文件.<br>所以我们才需要提前先手动把<code>AOF</code>关闭. 上面的恢复步骤这么复杂, 就是为了规避这个<code>case</code>带来的问题. </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://redis.io/commands/slowlog">slowlog官方文档</a></li>
<li><a href="https://segmentfault.com/a/1190000009915519">Redis高级功能 - 慢查询日志</a></li>
<li><a href="https://segmentfault.com/a/1190000014091287">docker 安装部署 redis（配置文件启动）</a></li>
<li><a href="http://redis.cn/topics/persistence.html">Redis 持久化 官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>使用scan代替keys获取所有key</title>
    <url>/posts/Use_scan_instead_of_keys_to_get_all_the_keys.html</url>
    <content><![CDATA[<h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p><code>Redis</code>的<code>keys</code>命令可以获取所有的<code>key</code>, 时间复杂度是<code>O(n)</code>, 一旦数据量大了, 因为<code>Redis</code>是单线程的, 就会导致<code>Redis</code>阻塞的情况.<br>为了解决阻塞问题, <code>Redis 2.8.0</code>推出了<code>scan</code>命令, <code>scan</code>可以返回默认大小为<code>10</code>的<code>key</code>, 并返回一个游标, 作为下次调用<code>scan</code>的参数.</p>
<span id="more"></span>

<h1 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3 k4 v4 k5 v5 k6 v6 k7 v7 k8 v8 k9 v9 k10 v10 k11 v11 k12 v12 k13 v13 k14 v14</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line"> 1) <span class="string">&quot;k14&quot;</span></span><br><span class="line"> 2) <span class="string">&quot;k1&quot;</span></span><br><span class="line"> 3) <span class="string">&quot;k13&quot;</span></span><br><span class="line"> 4) <span class="string">&quot;k5&quot;</span></span><br><span class="line"> 5) <span class="string">&quot;k2&quot;</span></span><br><span class="line"> 6) <span class="string">&quot;k12&quot;</span></span><br><span class="line"> 7) <span class="string">&quot;k11&quot;</span></span><br><span class="line"> 8) <span class="string">&quot;k10&quot;</span></span><br><span class="line"> 9) <span class="string">&quot;k4&quot;</span></span><br><span class="line">10) <span class="string">&quot;k8&quot;</span></span><br><span class="line">11) <span class="string">&quot;k9&quot;</span></span><br><span class="line">12) <span class="string">&quot;k3&quot;</span></span><br><span class="line">13) <span class="string">&quot;k6&quot;</span></span><br><span class="line">14) <span class="string">&quot;k7&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; scan 0 match * count 10</span><br><span class="line">1) <span class="string">&quot;11&quot;</span></span><br><span class="line">2)  1) <span class="string">&quot;k5&quot;</span></span><br><span class="line">    2) <span class="string">&quot;k3&quot;</span></span><br><span class="line">    3) <span class="string">&quot;k6&quot;</span></span><br><span class="line">    4) <span class="string">&quot;k7&quot;</span></span><br><span class="line">    5) <span class="string">&quot;k1&quot;</span></span><br><span class="line">    6) <span class="string">&quot;k11&quot;</span></span><br><span class="line">    7) <span class="string">&quot;k14&quot;</span></span><br><span class="line">    8) <span class="string">&quot;k12&quot;</span></span><br><span class="line">    9) <span class="string">&quot;k2&quot;</span></span><br><span class="line">   10) <span class="string">&quot;k13&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; scan 11 match * count 10</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;k10&quot;</span></span><br><span class="line">   2) <span class="string">&quot;k4&quot;</span></span><br><span class="line">   3) <span class="string">&quot;k8&quot;</span></span><br><span class="line">   4) <span class="string">&quot;k9&quot;</span></span><br></pre></td></tr></table></figure>
<p>初始化一堆<code>key</code></p>
<ol>
<li>用<code>keys</code>命令获取到所有的<code>key</code></li>
<li>用<code>scan</code>命令<strong>两次</strong>获取到所有的<code>key</code></li>
</ol>
<h1 id="多线程下原子性问题思考"><a href="#多线程下原子性问题思考" class="headerlink" title="多线程下原子性问题思考"></a>多线程下原子性问题思考</h1><p>我们在上面使用了两次<code>scan</code>命令, 就说明在这两次<code>scan</code>中, 可能会发生<code>set</code>或者<code>del</code>操作, 不是一个原子性操作.</p>
<blockquote>
<p>Elements that were not constantly present in the collection during a full iteration, may be returned or not: it is undefined.</p>
</blockquote>
<p>根据<a href="https://redis.io/commands/scan">官方文档</a>, 也就是说, 如果在<code>scan</code>过程中<code>set</code>或<code>del</code>了某个<code>key</code>, 那么这个<code>key</code>就变成了玄学状态. 可能被返回, 也可能不被返回.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scan 0 match * count 10</span><br><span class="line">1) <span class="string">&quot;11&quot;</span></span><br><span class="line">2)  1) <span class="string">&quot;k5&quot;</span></span><br><span class="line">    2) <span class="string">&quot;k3&quot;</span></span><br><span class="line">    3) <span class="string">&quot;k6&quot;</span></span><br><span class="line">    4) <span class="string">&quot;k7&quot;</span></span><br><span class="line">    5) <span class="string">&quot;k1&quot;</span></span><br><span class="line">    6) <span class="string">&quot;k11&quot;</span></span><br><span class="line">    7) <span class="string">&quot;k14&quot;</span></span><br><span class="line">    8) <span class="string">&quot;k12&quot;</span></span><br><span class="line">    9) <span class="string">&quot;k2&quot;</span></span><br><span class="line">   10) <span class="string">&quot;k13&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k15 v15</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; scan 11 match * count 10</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;k10&quot;</span></span><br><span class="line">   2) <span class="string">&quot;k4&quot;</span></span><br><span class="line">   3) <span class="string">&quot;k8&quot;</span></span><br><span class="line">   4) <span class="string">&quot;k9&quot;</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; scan 0 match * count 10</span><br><span class="line">1) <span class="string">&quot;13&quot;</span></span><br><span class="line">2)  1) <span class="string">&quot;k5&quot;</span></span><br><span class="line">    2) <span class="string">&quot;k3&quot;</span></span><br><span class="line">    3) <span class="string">&quot;k6&quot;</span></span><br><span class="line">    4) <span class="string">&quot;k7&quot;</span></span><br><span class="line">    5) <span class="string">&quot;k1&quot;</span></span><br><span class="line">    6) <span class="string">&quot;k11&quot;</span></span><br><span class="line">    7) <span class="string">&quot;k14&quot;</span></span><br><span class="line">    8) <span class="string">&quot;k15&quot;</span></span><br><span class="line">    9) <span class="string">&quot;k12&quot;</span></span><br><span class="line">   10) <span class="string">&quot;k2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; scan 13 match * count 10</span><br><span class="line">1) <span class="string">&quot;0&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;k13&quot;</span></span><br><span class="line">   2) <span class="string">&quot;k10&quot;</span></span><br><span class="line">   3) <span class="string">&quot;k4&quot;</span></span><br><span class="line">   4) <span class="string">&quot;k8&quot;</span></span><br><span class="line">   5) <span class="string">&quot;k9&quot;</span></span><br></pre></td></tr></table></figure>
<p>可以看到, <code>k15</code>没有在第一次扫描时返回, 而在第二次扫描时返回.<br>所以这个玄学状态, 应该是取决于<code>set</code>或<code>del</code>的元素的位置.</p>
<h1 id="整合-Spring-Data-Redis"><a href="#整合-Spring-Data-Redis" class="headerlink" title="整合 Spring Data Redis"></a>整合 Spring Data Redis</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">scan</span><span class="params">(String pattern, Consumer&lt;String&gt; consumer)</span> &#123;</span><br><span class="line">        RedisSerializer&lt;String&gt; keySerializer = (RedisSerializer&lt;String&gt;) stringRedisTemplate.getKeySerializer();</span><br><span class="line"></span><br><span class="line">        <span class="type">ScanOptions</span> <span class="variable">options</span> <span class="operator">=</span> ScanOptions.scanOptions().match(pattern).count(<span class="number">10</span>).build();</span><br><span class="line">        <span class="keyword">try</span>(Cursor&lt;String&gt; cursor = getStringRedisTemplate().executeWithStickyConnection((RedisCallback&lt;Cursor&lt;String&gt;&gt;) connection -&gt;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">ConvertingCursor</span>&lt;&gt;(connection.scan(options), keySerializer::deserialize))) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(cursor == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">while</span> (cursor.hasNext()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> cursor.next();</span><br><span class="line">                consumer.accept(key);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>整合到<code>Spring Data Redis</code>中就是这样, 奇怪的是, 最新的<code>Spring Data Redis 2.1.6</code>实现了<code>hscan</code>命令, 但是却没有实现<code>scan</code>, 只能自己写<code>execute</code>实现了.<br>可以参考我的工具类集合<a href="https://github.com/Ahaochan/ahao-common-utils/blob/master/src/main/java/com/ahao/util/spring/redis/RedisHelper.java"><code>RedisHelper</code></a>.</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://redis.io/commands/scan">scan 官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Redis</category>
      </categories>
      <tags>
        <tag>Redis</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL Server分页</title>
    <url>/posts/paging_query_of_SQL_Server.html</url>
    <content><![CDATA[<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><p>基于<code>Mybatis</code>的<a href="http://www.mybatis.org/mybatis-3/zh/dynamic-sql.html">动态SQL</a>。<br>使用<a href="https://github.com/alibaba/fastjson">fastjson</a>格式化输出数据。</p>
<span id="more"></span>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">StudentDao</span> &#123;</span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; <span class="title function_">getStudent</span><span class="params">(<span class="meta">@Param(&quot;sex&quot;)</span> String sex,</span></span><br><span class="line"><span class="params">                              <span class="meta">@Param(&quot;page&quot;)</span> <span class="type">int</span> page, <span class="meta">@Param(&quot;pageSize&quot;)</span> <span class="type">int</span> pageSize)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyTest</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> StudentDao dao;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 查找性别为男, 分页大小为10, 的第2页数据</span></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; data = dao.getStudent(<span class="string">&quot;男&quot;</span>, <span class="number">2</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(JSONObject.toJSONString(data));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="SQL-Server-2005"><a href="#SQL-Server-2005" class="headerlink" title="SQL Server 2005"></a>SQL Server 2005</h1><p>在2005之后, 使用<code>ROW_NUMBER()</code>函数标记记录的<strong>行号</strong>, 然后再使用<code>where</code>进行筛选。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;getStudent&quot; resultType<span class="operator">=</span>&quot;Map&quot;<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>bind name<span class="operator">=</span>&quot;skip&quot; <span class="keyword">value</span><span class="operator">=</span>&quot;(page-1)*pageSize&quot;<span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>bind name<span class="operator">=</span>&quot;record&quot; <span class="keyword">value</span><span class="operator">=</span>&quot;page*pageSize&quot;<span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">SELECT</span>  <span class="operator">*</span></span><br><span class="line">    <span class="keyword">FROM</span> (</span><br><span class="line">        <span class="keyword">SELECT</span> TOP <span class="number">100</span> <span class="keyword">PERCENT</span> tmp.<span class="operator">*</span>, </span><br><span class="line">            <span class="built_in">ROW_NUMBER</span>() <span class="keyword">OVER</span> (<span class="keyword">ORDER</span> <span class="keyword">BY</span> tmp.birthday <span class="keyword">desc</span>) <span class="keyword">AS</span> row_num</span><br><span class="line">        <span class="keyword">FROM</span> (</span><br><span class="line">            <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> s.id, s.name, <span class="keyword">CONVERT</span> (<span class="type">VARCHAR</span>(<span class="number">10</span>), s.birthday, <span class="number">120</span>) <span class="keyword">AS</span> birthday</span><br><span class="line">            <span class="keyword">FROM</span> student s</span><br><span class="line">            <span class="keyword">WHERE</span> s.sex <span class="operator">=</span> $&#123;sex&#125;</span><br><span class="line">            <span class="keyword">ORDER</span> <span class="keyword">BY</span> s.birthday</span><br><span class="line">        ) tmp</span><br><span class="line">        <span class="keyword">ORDER</span> <span class="keyword">BY</span> row_num</span><br><span class="line">    ) tmp</span><br><span class="line">    <span class="operator">&lt;</span><span class="operator">!</span>[CDATA[<span class="keyword">WHERE</span> row_num <span class="operator">&gt;</span> $&#123;<span class="keyword">skip</span>&#125; <span class="keyword">and</span> row_num <span class="operator">&lt;=</span> $&#123;record&#125;]]<span class="operator">&gt;</span></span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="SQL-Server-2012"><a href="#SQL-Server-2012" class="headerlink" title="SQL Server 2012"></a>SQL Server 2012</h1><p>在2012之后, 使用<a href="https://technet.microsoft.com/zh-cn/library/gg699618.aspx">OFFSET FETCH 子句</a>进行分页处理。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="operator">&lt;</span><span class="keyword">select</span> id<span class="operator">=</span>&quot;getStudent&quot; resultType<span class="operator">=</span>&quot;Map&quot;<span class="operator">&gt;</span></span><br><span class="line">    <span class="operator">&lt;</span>bind name<span class="operator">=</span>&quot;skip&quot; <span class="keyword">value</span><span class="operator">=</span>&quot;(page-1)*pageSize&quot;<span class="operator">/</span><span class="operator">&gt;</span></span><br><span class="line">    <span class="keyword">SELECT</span> <span class="keyword">DISTINCT</span> s.id, s.name, <span class="keyword">CONVERT</span> (<span class="type">VARCHAR</span>(<span class="number">10</span>), s.birthday, <span class="number">120</span>) <span class="keyword">AS</span> birthday</span><br><span class="line">    <span class="keyword">FROM</span> student s</span><br><span class="line">    <span class="keyword">WHERE</span> s.sex <span class="operator">=</span> $&#123;sex&#125;</span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span> s.birthday</span><br><span class="line">    <span class="keyword">OFFSET</span> $&#123;<span class="keyword">skip</span>&#125; <span class="keyword">ROWS</span> <span class="keyword">FETCH</span> NEXT $&#123;pageSize&#125; <span class="keyword">ROWS</span> <span class="keyword">ONLY</span>;</span><br><span class="line"><span class="operator">&lt;</span><span class="operator">/</span><span class="keyword">select</span><span class="operator">&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>SQL Server</category>
      </categories>
      <tags>
        <tag>SQL Server</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLServer不能为表中的标识列插入显式值</title>
    <url>/posts/Cannot_insert_explicit_value_for_identity_column.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天遇到个问题，要把线上生产环境的某张数据表的数据导出到本地的测试环境，但是导出后的<code>SQL</code>文件执行时出现了错误。</p>
<figure class="highlight text"><table><tr><td class="code"><pre><span class="line">[SQL] INSERT INTO [test_user] ([id], [name]) VALUES (100, &#x27;测试用户&#x27;)</span><br><span class="line">[Err] 23000 - [SQL Server]当 IDENTITY_INSERT 设置为 OFF 时，不能为表 &#x27;test_user&#x27; 中的标识列插入显式值。</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>设置<code>identity_insert</code>为<code>ON</code>，执行完毕再设置为<code>OFF</code>即可。<br>设置语法为<code>SET IDENTITY_INSERT [ database.[ owner.] ] &#123; table &#125; &#123; ON | OFF &#125; </code></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">set</span> identity_insert ClassInfo <span class="keyword">ON</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> [m_opendata] ([id], [name]) <span class="keyword">VALUES</span> (<span class="number">100</span>, <span class="string">&#x27;测试标题&#x27;</span>);</span><br><span class="line"><span class="keyword">set</span> identity_insert ClassInfo OFF;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://www.cnblogs.com/xgcblog/archive/2011/08/10/2133974.html">当 IDENTITY_INSERT 设置为 OFF 时，不能为表中的标识列插入显式值</a></li>
</ul>
]]></content>
      <categories>
        <category>SQL Server</category>
      </categories>
      <tags>
        <tag>SQL Server</tag>
      </tags>
  </entry>
  <entry>
    <title>SQLServer的PARTITION_BY进行分区查询</title>
    <url>/posts/use_PARTITION_BY_to_query.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>假设有一个用户表<code>admin(id, name, sex)</code>, 现在有个需求。<br>是按照性别<code>sex</code>进行分区, 然后排序。</p>
<span id="more"></span>

<p>比如有以下数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id          name       sex(1男2女)</span><br><span class="line">1          admin1          1</span><br><span class="line">2          admin2          1</span><br><span class="line">3          admin3          2</span><br><span class="line">4          admin4          2</span><br><span class="line">5          admin5          2</span><br></pre></td></tr></table></figure>

<p>要求查询性别<code>sex</code>进行分区, 然后排序。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id          name       sex(1男2女)   row_num</span><br><span class="line">1          admin1          1            1</span><br><span class="line">2          admin2          1            2</span><br><span class="line">3          admin3          2            1</span><br><span class="line">4          admin4          2            2</span><br><span class="line">5          admin5          2            3</span><br></pre></td></tr></table></figure>

<h1 id="使用ROW-NUMBER进行排序"><a href="#使用ROW-NUMBER进行排序" class="headerlink" title="使用ROW_NUMBER进行排序"></a>使用ROW_NUMBER进行排序</h1><p>首先获取行数, <code>SQLServer</code>提供了<code>ROW_NUMBER</code>函数。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> tmp.<span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> tmp.id <span class="keyword">asc</span>) <span class="keyword">as</span> row_num</span><br><span class="line"><span class="keyword">from</span> ( <span class="keyword">select</span> id, name, sex <span class="keyword">from</span> admin ) tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> row_num <span class="keyword">asc</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id          name       sex(1男2女)   row_num</span><br><span class="line">1          admin1          1            1</span><br><span class="line">2          admin2          1            2</span><br><span class="line">3          admin3          2            3</span><br><span class="line">4          admin4          2            4</span><br><span class="line">5          admin5          2            5</span><br></pre></td></tr></table></figure>
<p>但是需求是, 根据<code>sex</code>分区排序, 所以添加一个<code>partition by</code>关键字。</p>
<h1 id="使用PARTITION-BY进行分区"><a href="#使用PARTITION-BY进行分区" class="headerlink" title="使用PARTITION  BY进行分区"></a>使用PARTITION  BY进行分区</h1><figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">select</span> tmp.<span class="operator">*</span>, <span class="built_in">ROW_NUMBER</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> sex <span class="keyword">order</span> <span class="keyword">by</span> tmp.id <span class="keyword">asc</span>) <span class="keyword">as</span> row_num</span><br><span class="line"><span class="keyword">from</span> ( <span class="keyword">select</span> id, name, sex <span class="keyword">from</span> admin ) tmp</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> sex <span class="keyword">asc</span>, row_num <span class="keyword">asc</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">id          name       sex(1男2女)   row_num</span><br><span class="line">1          admin1          1            1</span><br><span class="line">2          admin2          1            2</span><br><span class="line">3          admin3          2            1</span><br><span class="line">4          admin4          2            2</span><br><span class="line">5          admin5          2            3</span><br></pre></td></tr></table></figure>
<p>完成, 此外还可以用来做分区求和等功能。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://blog.csdn.net/wawmg/article/details/40840093">sum over partition by 的用法</a></li>
</ul>
]]></content>
      <categories>
        <category>SQL Server</category>
      </categories>
      <tags>
        <tag>SQL Server</tag>
      </tags>
  </entry>
  <entry>
    <title>CSS基础</title>
    <url>/posts/css_foundation.html</url>
    <content><![CDATA[<h1 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h1><p>格式为<code>属性名:属性值;</code></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background-color:red;color:white;&quot;</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>
<div style="background-color:red;color:white;">测试</div>

<h1 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h1><p>由上到下，由外到内，优先级由低到高。<br><code>style</code> &gt; <code>id选择器</code> &gt; <code>class类选择器</code> &gt; <code>标签选择器</code>，优先级由低到高</p>
<h1 id="引入方式"><a href="#引入方式" class="headerlink" title="引入方式"></a>引入方式</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;test/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">        <span class="selector-tag">div</span> &#123;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">background-color</span>:red;</span></span><br><span class="line"><span class="language-css">            <span class="attribute">color</span>:white;</span></span><br><span class="line"><span class="language-css">        &#125;</span></span><br><span class="line"><span class="language-css">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;test/css&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">        @import url(div.css);<span class="comment">&lt;!--外部引用，兼容性差，不使用--&gt;</span></span></span><br><span class="line"><span class="language-xml">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">&quot;stylesheet&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span> <span class="attr">href</span>=<span class="string">&quot;div.css&quot;</span>/&gt;</span><span class="comment">&lt;!--外部引用--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;background-color:red;color:white;&quot;</span>&gt;</span>测试<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>CSS</category>
      </categories>
      <tags>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>CSS背景</title>
    <url>/posts/css_how_to_set_background.html</url>
    <content><![CDATA[<h1 id="设置纯色背景"><a href="#设置纯色背景" class="headerlink" title="设置纯色背景"></a>设置纯色背景</h1><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-color</span>:gray;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h1 id="设置图片背景"><a href="#设置图片背景" class="headerlink" title="设置图片背景"></a>设置图片背景</h1><p>如果同时设置纯色背景和图片背景，则纯色背景在图片背景之下。并且图片背景会平铺整个屏幕。</p>
<ul>
<li><code>background-repeat</code>属性可以设置平铺方式，<code>repeat-x</code>、<code>repeat-y</code>、<code>no-repeat</code>。</li>
<li><code>background-position</code>属性可以设置图片背景的位置。<code>top</code>、<code>bottom</code>等。</li>
<li><code>background-attachment</code>属性可以设置图片是否随文档滚动。<code>fixed</code>、<code>scroll</code>。<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">type</span>=<span class="string">&quot;text/css&quot;</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css">    <span class="selector-tag">body</span> &#123;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-image</span>:<span class="built_in">url</span>(<span class="string">http://cn.bing.com/sa/simg/CN_Logo_Gray.png</span>);</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-repeat</span>:no-repeat;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-position</span>:center;</span></span><br><span class="line"><span class="language-css">        <span class="attribute">background-attachment</span>:fixed;</span></span><br><span class="line"><span class="language-css">    &#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
]]></content>
      <categories>
        <category>CSS</category>
      </categories>
      <tags>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>CSS选择器</title>
    <url>/posts/css_selector.html</url>
    <content><![CDATA[<h1 id="基本选择器"><a href="#基本选择器" class="headerlink" title="基本选择器"></a>基本选择器</h1><h2 id="标签元素选择器"><a href="#标签元素选择器" class="headerlink" title="标签元素选择器"></a>标签元素选择器</h2><figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>:red;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>

<h2 id="class类选择器"><a href="#class类选择器" class="headerlink" title="class类选择器"></a>class类选择器</h2><p>以<code>.</code>开头</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-class">.test1</span>&#123; // 满足class为test1，且标签为<span class="selector-tag">div</span>的形式，<span class="selector-tag">div</span>可省略</span><br><span class="line">    <span class="attribute">background-color</span>:red;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br><span class="line">// &lt;<span class="selector-tag">div</span> class=&quot;test1&quot;&gt;测试&lt;/<span class="selector-tag">div</span>&gt;</span><br></pre></td></tr></table></figure>

<h2 id="ID选择器"><a href="#ID选择器" class="headerlink" title="ID选择器"></a>ID选择器</h2><p>以<code>#</code>开头</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span><span class="selector-id">#test2</span> &#123; // 满足id为test2，且标签为<span class="selector-tag">div</span>的形式，<span class="selector-tag">div</span>可省略</span><br><span class="line">    <span class="attribute">background-color</span>:red;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br><span class="line">// &lt;<span class="selector-tag">div</span> id=&quot;test2&quot;&gt;测试&lt;/<span class="selector-tag">div</span>&gt;</span><br></pre></td></tr></table></figure>
<h1 id="扩展选择器"><a href="#扩展选择器" class="headerlink" title="扩展选择器"></a>扩展选择器</h1><h2 id="属性选择器"><a href="#属性选择器" class="headerlink" title="属性选择器"></a>属性选择器</h2><p>格式<code>元素名[属性名]&#123;样式&#125;</code><br>给拥有某个属性的元素标签设置特定样式</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">a</span><span class="selector-attr">[href]</span><span class="selector-attr">[title]</span> &#123;<span class="attribute">color</span>:red;&#125;</span><br><span class="line"><span class="selector-tag">a</span><span class="selector-attr">[href=<span class="string">&quot;http://www.w3school.com.cn/about_us.asp&quot;</span>]</span> &#123;<span class="attribute">color</span>: red;&#125;</span><br></pre></td></tr></table></figure>

<h2 id="关联选择器"><a href="#关联选择器" class="headerlink" title="关联选择器"></a>关联选择器</h2><p>在标签嵌套时使用，比如特定<code>div</code>标签中的<code>p</code>标签</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span> <span class="selector-tag">p</span> &#123; <span class="comment">/* 用空格隔开 */</span></span><br><span class="line">    <span class="attribute">background-color</span>:red;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &lt;div&gt;&lt;p&gt;测试&lt;/p&gt;&lt;/div&gt; */</span></span><br></pre></td></tr></table></figure>

<h2 id="组合选择器"><a href="#组合选择器" class="headerlink" title="组合选择器"></a>组合选择器</h2><p>把不同标签设置相同的样式</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-tag">div</span>,<span class="selector-tag">p</span> &#123; <span class="comment">/* 用,隔开 */</span></span><br><span class="line">    <span class="attribute">background-color</span>:red;</span><br><span class="line">    <span class="attribute">color</span>:white;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &lt;div&gt;测试&lt;/div&gt;&lt;p&gt;测试&lt;/p&gt; */</span></span><br></pre></td></tr></table></figure>

<h2 id="伪元素选择器"><a href="#伪元素选择器" class="headerlink" title="伪元素选择器"></a>伪元素选择器</h2><p><a href="http://www.w3school.com.cn/css/css_pseudo_classes.asp">伪类选择器</a></p>
]]></content>
      <categories>
        <category>CSS</category>
      </categories>
      <tags>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>文字单行溢出显示省略号</title>
    <url>/posts/Text_single_line_overflow_display_ellipses.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>搜索候选框需要单行显示, 超出长度的部分用省略号表示。</p>
<span id="more"></span>

<h1 id="简单粗暴的方式"><a href="#简单粗暴的方式" class="headerlink" title="简单粗暴的方式"></a>简单粗暴的方式</h1><p>直接使用<code>substring</code>截取字符串, 然后加上省略号。<br>但是这种方式不支持响应式。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> title = <span class="string">&#x27;1234567890&#x27;</span>;</span><br><span class="line"><span class="keyword">if</span> (title.<span class="property">length</span> &gt; <span class="number">23</span>) &#123;</span><br><span class="line">    title = title.<span class="title function_">substring</span>(<span class="number">0</span>, <span class="number">23</span>) + <span class="string">&#x27;...&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// substr和substring的区别</span></span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;abc&quot;</span>.<span class="title function_">substr</span>(<span class="number">1</span>,<span class="number">2</span>));    <span class="comment">// 从第2个字符(0为起始)之后长度为2的子字符串, returns &quot;bc&quot;</span></span><br><span class="line"><span class="title function_">alert</span>(<span class="string">&quot;abc&quot;</span>.<span class="title function_">substring</span>(<span class="number">1</span>,<span class="number">2</span>)); <span class="comment">// 从第2个字符(0为起始)开始, 第3个字符之前的子字符串, returns &quot;b&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="CSS3的解决方案-支持IE8"><a href="#CSS3的解决方案-支持IE8" class="headerlink" title="CSS3的解决方案(支持IE8)"></a>CSS3的解决方案(支持IE8)</h1><p>添加以下样式即可</p>
<figure class="highlight css"><table><tr><td class="code"><pre><span class="line"><span class="selector-class">.ellipses</span> &#123;</span><br><span class="line">    <span class="attribute">overflow</span>: hidden;        <span class="comment">/* 当内容溢出元素框时, 超出部分隐藏 */</span></span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;     <span class="comment">/* 文本不会换行，文本会在在同一行上继续，直到遇到 &lt;br&gt; 标签为止 */</span></span><br><span class="line">    <span class="attribute">text-overflow</span>: ellipsis; <span class="comment">/* 规定当文本溢出包含元素时, 用省略号表示超出部分 */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>CSS</category>
      </categories>
      <tags>
        <tag>CSS</tag>
      </tags>
  </entry>
  <entry>
    <title>Ajax提交之快速获取表单值</title>
    <url>/posts/get_form_values_when_use_AJAX_submit.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>表单请求经常需要进行表单验证, 然后再进行请求, 再对页面进行后处理, 比如弹出个对话框提示请求成功。<br>普通的<code>form</code>提交是不能满足需求的, 要通过<code>AJAX</code>来处理。</p>
<span id="more"></span>

<h1 id="使用jQuery的submit函数"><a href="#使用jQuery的submit函数" class="headerlink" title="使用jQuery的submit函数"></a>使用jQuery的submit函数</h1><p><code>jQuery</code>提供了<code>submit</code>函数, 来接管提交事件, </p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;#form-userInfo&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 拦截默认的提交方式</span></span><br><span class="line">    event.<span class="title function_">preventDefault</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取表单值</span></span><br><span class="line">    <span class="keyword">var</span> username = $(<span class="string">&#x27;input[name=&quot;username&quot;]&#x27;</span>).<span class="title function_">val</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ajax请求</span></span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/login&#x27;</span>, <span class="comment">// url where to submit the request</span></span><br><span class="line">        type : <span class="string">&#x27;POST&#x27;</span>, <span class="comment">// type of action POST || GET</span></span><br><span class="line">        dataType : <span class="string">&#x27;json&#x27;</span>, <span class="comment">// data type</span></span><br><span class="line">        data : &#123; <span class="attr">username</span>: username &#125;, <span class="comment">// post data || get data</span></span><br><span class="line">        success : <span class="keyword">function</span>(<span class="params">result</span>) &#123;</span><br><span class="line">            <span class="comment">// 3.1. 请求成功</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">xhr, resp, text</span>) &#123;</span><br><span class="line">            <span class="comment">// 3.2. 请求失败</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr, resp, text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="serializeArray-序列化参数"><a href="#serializeArray-序列化参数" class="headerlink" title="serializeArray 序列化参数"></a>serializeArray 序列化参数</h1><p>获取参数的方式有很多种, 上面使用的是最简单的方法, 通过获取元素来获取值。<br>但是如果有很多个参数, 比如用户名、密码、性别、城市、手机号、身份证号等等。<br>每个都要去手动获取元素再来获取值, 就太麻烦了。</p>
<p><code>jQuery</code>提供了<code>serialize</code>和<code>serializeArray</code>两个方法去序列化参数, 关于这两个方法的不同, 可以查阅参考资料和<code>jQuery</code>文档。<br>这里使用<code>serializeArray</code>, 主要是第二步获取参数的方式不同。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="string">&#x27;#form-userInfo&#x27;</span>).<span class="title function_">submit</span>(<span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 拦截默认的提交方式</span></span><br><span class="line">    event.<span class="title function_">preventDefault</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 获取表单值, 看这里!!!!</span></span><br><span class="line">    <span class="keyword">var</span> data = &#123;&#125;;</span><br><span class="line">    $(<span class="variable language_">this</span>).<span class="title function_">serializeArray</span>().<span class="title function_">map</span>(<span class="keyword">function</span>(<span class="params">x</span>)&#123;data[x.<span class="property">name</span>] = x.<span class="property">value</span>;&#125;);</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 3. ajax请求</span></span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&#x27;/login&#x27;</span>, <span class="comment">// url where to submit the request</span></span><br><span class="line">        type : <span class="string">&#x27;POST&#x27;</span>, <span class="comment">// type of action POST || GET</span></span><br><span class="line">        dataType : <span class="string">&#x27;json&#x27;</span>, <span class="comment">// data type</span></span><br><span class="line">        data : &#123; <span class="attr">username</span>: username &#125;, <span class="comment">// post data || get data</span></span><br><span class="line">        success : <span class="keyword">function</span>(<span class="params">result</span>) &#123;</span><br><span class="line">            <span class="comment">// 3.1. 请求成功</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(result);</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">error</span>: <span class="keyword">function</span>(<span class="params">xhr, resp, text</span>) &#123;</span><br><span class="line">            <span class="comment">// 3.2. 请求失败</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(xhr, resp, text);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/a/17784656/6335926">Convert form data to JavaScript object with jQuery</a></li>
<li><a href="https://stackoverflow.com/questions/10430502">What’s the difference between .serialize() and .serializeArray()?</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>Ajax</tag>
      </tags>
  </entry>
  <entry>
    <title>Ajax详解</title>
    <url>/posts/Ajax_simple_use.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>AJAX</code>即<code>Asynchronous Javascript And XML（异步JavaScript和XML）</code>，是指一种创建交互式网页应用的网页开发技术。<br><code>AJAX</code> = 异步 <code>JavaScript</code>和<code>XML</code>（标准通用标记语言的子集）。<br><code>AJAX</code> 是一种用于创建快速动态网页的技术。<br>通过在后台与服务器进行少量数据交换，<code>AJAX</code> 可以使网页实现异步更新。这意味着可以在不重新加载整个网页的情况下，对网页的某部分进行更新。<br>传统的网页（不使用 <code>AJAX</code>）如果需要更新内容，必须重载整个网页页面。</p>
<span id="more"></span>

<h1 id="获取XMLHttpRequest对象"><a href="#获取XMLHttpRequest对象" class="headerlink" title="获取XMLHttpRequest对象"></a>获取XMLHttpRequest对象</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">getXMLHttpRequest</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">var</span> xhr;</span><br><span class="line">    <span class="keyword">try</span>&#123;    </span><br><span class="line">        xhr = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();<span class="comment">//firfox, Opera 8.0+, Safari</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            xhr = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&#x27;Msxml2.XMLHTTP&#x27;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(e)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                xhr = <span class="keyword">new</span> <span class="title class_">ActiveXObject</span>(<span class="string">&#x27;Microsoft.XMLHTTP&#x27;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span>(e)&#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> xhr;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="发送数据"><a href="#发送数据" class="headerlink" title="发送数据"></a>发送数据</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> xhr = <span class="title function_">getXMLHttpRequest</span>();</span><br><span class="line">xhr.<span class="title function_">open</span>(<span class="string">&#x27;post&#x27;</span>, <span class="string">&#x27;http://localhost:8080/test&#x27;</span>, <span class="literal">true</span>);<span class="comment">//true是异步提交</span></span><br><span class="line">xhr.<span class="title function_">setRequestHeader</span>(<span class="string">&#x27;Content-type&#x27;</span>, <span class="string">&#x27;application/x-www-form-urlencoded&#x27;</span>);<span class="comment">//post提交表单必须</span></span><br><span class="line">xhr.<span class="title function_">send</span>(<span class="string">&#x27;username=张三&amp;sex=男&#x27;</span>);</span><br></pre></td></tr></table></figure>

<h1 id="接收数据"><a href="#接收数据" class="headerlink" title="接收数据"></a>接收数据</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">xhr.<span class="property">onreadystatechange</span> = <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="keyword">if</span>(xhr.<span class="property">readyState</span>===<span class="number">4</span> &amp;&amp; request.<span class="property">status</span>===<span class="number">200</span>)&#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;id&#x27;</span>).<span class="property">innerHTML</span> = xhr.<span class="property">responseText</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="jQuery实现AJAX"><a href="#jQuery实现AJAX" class="headerlink" title="jQuery实现AJAX"></a>jQuery实现AJAX</h1><figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">    $(<span class="string">&#x27;#id&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">            <span class="attr">type</span>: <span class="string">&#x27;POST&#x27;</span>,</span><br><span class="line">            contentType : <span class="string">&#x27;application/json&#x27;</span>,</span><br><span class="line">            <span class="attr">async</span>: <span class="literal">true</span>,</span><br><span class="line">            timeout : <span class="number">100000</span>, </span><br><span class="line">            <span class="attr">url</span>: <span class="string">&#x27;http://localhost:8080/test&#x27;</span>,</span><br><span class="line">            <span class="attr">dataType</span>: <span class="string">&#x27;json&#x27;</span>,</span><br><span class="line">            <span class="attr">data</span>:&#123;</span><br><span class="line">                <span class="attr">name</span>:<span class="string">&#x27;张三&#x27;</span>,</span><br><span class="line">                <span class="attr">sex</span>:<span class="string">&#x27;男&#x27;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">beforeSend</span>: <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">                <span class="title function_">alert</span>(<span class="string">&#x27;加载中&#x27;</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">success</span>: <span class="keyword">function</span> (<span class="params">data</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> json = <span class="built_in">eval</span>(data);</span><br><span class="line">                <span class="title function_">alert</span>(json);</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">error</span>: <span class="keyword">function</span> (<span class="params">xhr</span>) &#123;</span><br><span class="line">               <span class="title function_">alert</span>(<span class="string">&#x27;失败&#x27;</span>+xhr.<span class="property">status</span>);<span class="comment">//传入XMLHttpRequest对象</span></span><br><span class="line">            &#125;,</span><br><span class="line">            done : <span class="keyword">function</span>(<span class="params">e</span>) &#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;DONE&#x27;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">   &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>Ajax</tag>
      </tags>
  </entry>
  <entry>
    <title>IE8使用console会导致页面阻塞</title>
    <url>/posts/IE8_use_the_console_object_will_cause_the_page_to_be_blocked.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在<code>JS</code>里经常会使用<code>console.log()</code>来调试程序(<strong>这是不对的</strong>), 结果在<code>IE8</code>里面发现<code>AJAX</code>执行不了, 一开始以为是<code>IE8</code>不支持<code>JSONP</code>, 后来才知道原来是<code>console</code>的锅。</p>
<span id="more"></span>

<h1 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h1><p><code>console</code>对象调用<code>log()</code>方法打印日志, 这个操作在<code>IE8</code>的正式环境是行不通的。<br>因为在<code>IE8</code>中, <code>console</code>对象只有在<code>Dev Toolbar </code>开发者工具打开的时候才会创建, 如果在正式环境下, <code>console</code>对象没有创建, 而<code>JS</code>代码去调用了<code>console.log()</code>就会抛出找不到<code>console</code>对象的错误, 导致后续的代码无法执行。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>最好的解决方案就是不使用<code>console.log()</code>调试, 使用浏览器<code>Dev Toolbar </code>开发者工具提供的断点进行<code>debug</code>。</p>
<p><strong>但是</strong><br>代码开发人员的素质水平参差不齐, 所以还是要兼容<code>console</code>。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 避免出现console错误</span></span><br><span class="line">(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> methods = [</span><br><span class="line">        <span class="string">&#x27;assert&#x27;</span>, <span class="string">&#x27;clear&#x27;</span>, <span class="string">&#x27;count&#x27;</span>, <span class="string">&#x27;debug&#x27;</span>, <span class="string">&#x27;dir&#x27;</span>, <span class="string">&#x27;dirxml&#x27;</span>, <span class="string">&#x27;error&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;exception&#x27;</span>, <span class="string">&#x27;group&#x27;</span>, <span class="string">&#x27;groupCollapsed&#x27;</span>, <span class="string">&#x27;groupEnd&#x27;</span>, <span class="string">&#x27;info&#x27;</span>, <span class="string">&#x27;log&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;markTimeline&#x27;</span>, <span class="string">&#x27;profile&#x27;</span>, <span class="string">&#x27;profileEnd&#x27;</span>, <span class="string">&#x27;table&#x27;</span>, <span class="string">&#x27;time&#x27;</span>, <span class="string">&#x27;timeEnd&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;timeStamp&#x27;</span>, <span class="string">&#x27;trace&#x27;</span>, <span class="string">&#x27;warn&#x27;</span></span><br><span class="line">    ];</span><br><span class="line">    <span class="keyword">var</span> length = methods.<span class="property">length</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable language_">console</span> = (<span class="variable language_">window</span>.<span class="property">console</span> = <span class="variable language_">window</span>.<span class="property">console</span> || &#123;&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (length--) &#123;</span><br><span class="line">        <span class="keyword">var</span> method = methods[length];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// method不存在则设置默认方法</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="variable language_">console</span>[method]) &#123;</span><br><span class="line">            <span class="variable language_">console</span>[method] = <span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">alert</span>(<span class="string">&#x27;not support!&#x27;</span>) &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;());</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/a/12315859/6335926">why-does-javascript-only-work-after-opening-developer-tools-in-ie-once</a></li>
<li><a href="https://stackoverflow.com/questions/690251">what-happened-to-console-log-in-ie8</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>IE8</tag>
      </tags>
  </entry>
  <entry>
    <title>call和apply的区别</title>
    <url>/posts/The_difference_between_call_and_apply.html</url>
    <content><![CDATA[<h1 id="两者的异同"><a href="#两者的异同" class="headerlink" title="两者的异同"></a>两者的异同</h1><p><code>call</code> 和 <code>apply</code> 都是为了改变 <code>this</code> 而存在的。<br>两者可以说是完全一致, 唯一的不同就在于接收的参数的<strong>形式</strong>不同。</p>
<ul>
<li>call: 接收<strong>多个</strong>参数</li>
<li>apply: 接收<strong>一个</strong>数组参数</li>
</ul>
<span id="more"></span>

<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 函数功能, 打印 this 和 所有参数</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f</span>(<span class="params"></span>)&#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;this:&quot;</span>+<span class="variable language_">this</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i <span class="keyword">in</span> <span class="variable language_">arguments</span>)&#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;arguments[&quot;</span>+i+<span class="string">&quot;]=&quot;</span>+<span class="variable language_">arguments</span>[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">f</span>(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>);</span><br><span class="line"><span class="comment">// this:[object Window]</span></span><br><span class="line"><span class="comment">// arguments[0]=1</span></span><br><span class="line"><span class="comment">// arguments[1]=2</span></span><br><span class="line"><span class="comment">// arguments[2]=3</span></span><br><span class="line"></span><br><span class="line">f.<span class="title function_">call</span>(<span class="string">&#x27;我是this&#x27;</span>, <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>); <span class="comment">// 接收多个参数</span></span><br><span class="line"><span class="comment">// this:我是this</span></span><br><span class="line"><span class="comment">// arguments[0]=1</span></span><br><span class="line"><span class="comment">// arguments[1]=2</span></span><br><span class="line"><span class="comment">// arguments[2]=3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">f.<span class="title function_">apply</span>(<span class="string">&#x27;我是this&#x27;</span>, arr); <span class="comment">// 接收一个数组参数</span></span><br><span class="line"><span class="comment">// this:我是this</span></span><br><span class="line"><span class="comment">// arguments[0]=1</span></span><br><span class="line"><span class="comment">// arguments[1]=2</span></span><br><span class="line"><span class="comment">// arguments[2]=3</span></span><br></pre></td></tr></table></figure>
<p>可以粗略的理解为如下Java代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f1</span><span class="params">(String... strs)</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">f2</span><span class="params">(String[] strs)</span>;</span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>jQuery的clone陷阱</title>
    <url>/posts/Cloning_trap_of_jQuery.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>clone()</code> 方法生成被选元素的副本，包含子节点、文本和属性。<br>这里的属性, 包括了 <code>id</code>。当<code>clone</code>了<code>id</code>后, 获取<code>id</code>将会获取第一个匹配<code>id</code>的元素。造成不可预期的后果。</p>
<span id="more"></span>

<h1 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h1><p><a href="https://jsfiddle.net/ju8npczb/8/">Demo地址</a></p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>复制时间到第一个div中<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;div-clone&quot;</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>/&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;div-source&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;time&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">$(<span class="string">&#x27;#btn&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 1. 更新 div-source 中的时间</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> $time = $(<span class="string">&#x27;#time&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">  $time.<span class="title function_">html</span>(<span class="string">&#x27;时间:&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>());</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 2. clone 到 div-clone 中</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> $clone = $time.<span class="title function_">clone</span>();</span></span><br><span class="line"><span class="language-javascript">  $(<span class="string">&#x27;.div-clone&#x27;</span>).<span class="title function_">html</span>($clone);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>这是一个简单的页面, 每点击一次<strong>按钮</strong>, 就会更新<code>div-source</code>的时间, 再复制到<code>div-clone</code>中。<br>当第一次点击时, 页面如下, <code>div-clone</code>复制成功。</p>
<ol>
<li>更新<code>id</code>为<code>time</code>的元素文本为 <strong>现在的时间</strong></li>
<li>复制<code>id</code>为<code>time</code>的元素文本</li>
<li>粘贴到<code>div-clone</code>里面<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>复制时间到第一个div中<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;div-clone&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;time&quot;</span>&gt;</span>时间:Wed Mar 14 2018 14:53:15 GMT+0800 (中国标准时间)<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;div-source&quot;</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;time&quot;</span>&gt;</span>时间:Wed Mar 14 2018 14:53:15 GMT+0800 (中国标准时间)<span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
问题出在第二次点击时, 只会更新第一个<code>div</code>, 不更新第二个<code>div</code></li>
<li>更新<code>div-clone</code>下的<code>id</code>为<code>time</code>的元素文本为 <strong>现在的时间</strong>, 因为现在<code>id</code>为<code>time</code>的元素有两个。会更新第一个元素，也就是<code>div-clone</code>下的<code>id</code>为<code>time</code>的元素</li>
<li>复制<code>div-clone</code>下的<code>id</code>为<code>time</code>的元素文本</li>
<li>粘贴到<code>div-clone</code>里面</li>
<li><code>div-source</code>没被操作<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>复制时间到第一个div中<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;div-clone&quot;</span>&gt;</span></span><br><span class="line">     // 注意这里!!!有两个id为time的元素</span><br><span class="line">     <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;time&quot;</span>&gt;</span>时间:Wed Mar 14 2018 15:01:05 GMT+0800 (中国标准时间)<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;div-source&quot;</span>&gt;</span> </span><br><span class="line">     // 注意这里!!!有两个id为time的元素</span><br><span class="line">     <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">&quot;time&quot;</span>&gt;</span>时间:Wed Mar 14 2018 14:53:15 GMT+0800 (中国标准时间)<span class="tag">&lt;/<span class="name">p</span>&gt;</span>  </span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">$(<span class="string">&#x27;#btn&#x27;</span>).<span class="title function_">click</span>(<span class="keyword">function</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="comment">// 第二次点击, 预期是更新 div-source 的时间, 实际会更新 div-clone 中的时间</span></span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> $time = $(<span class="string">&#x27;#time&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">  $time.<span class="title function_">html</span>(<span class="string">&#x27;时间:&#x27;</span>+<span class="keyword">new</span> <span class="title class_">Date</span>());</span></span><br><span class="line"><span class="language-javascript">  </span></span><br><span class="line"><span class="language-javascript">  <span class="keyword">var</span> $clone = $time.<span class="title function_">clone</span>();</span></span><br><span class="line"><span class="language-javascript">  $(<span class="string">&#x27;.div-clone&#x27;</span>).<span class="title function_">html</span>($clone);</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><code>clone</code>最好不要复制带有<code>id</code>属性的元素, 否则会发生不可预期的错误。</p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://www.w3school.com.cn/jquery/manipulation_clone.asp">jQuery 文档操作 - clone() 方法</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>jQuery</tag>
      </tags>
  </entry>
  <entry>
    <title>为什么jQuery选择器只返回一个元素?</title>
    <url>/posts/why_jQuery_selector_return_only_one_element.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>稍有常识的人都知道, 如果我们使用形如<code>$(&#39;p&#39;)</code>、<code>$(&#39;.myclass&#39;)</code>之类的选择器，会返回一个数组。<br>但今天在<a href="https://www.bing.com/">必应</a>中进行控制台js调试时, 却发现不管怎么用, 都只返回<code>第一个</code>元素。</p>
<span id="more"></span>
<h1 id="Chrome的坑"><a href="#Chrome的坑" class="headerlink" title="Chrome的坑"></a>Chrome的坑</h1><p><a href="https://stackoverflow.com/questions/44769950/why-does-jquery-class-selector-only-return-one-element">Why does jQuery class selector only return one element?</a>提到<br>该网页根本没有引入jQuery。在F12控制台中, <code>$</code>其实是<code>debugger</code>调试器的快捷方式<code>document.querySelector()</code>。<br>如果想要获取所有元素的话, 使用<code>$$(.myclass)</code>即可。</p>
<h1 id="检查页面是否引入jQuery"><a href="#检查页面是否引入jQuery" class="headerlink" title="检查页面是否引入jQuery"></a>检查页面是否引入jQuery</h1><p>使用<code>console.log($)</code>调试。<br>如果引入了jQuery, 则输出</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> (<span class="params">a,b</span>)&#123;<span class="keyword">return</span> <span class="keyword">new</span> n.<span class="property">fn</span>.<span class="title function_">init</span>(a,b)&#125;</span><br></pre></td></tr></table></figure>
<p>如果没有引入jQuery, 则输出</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">function $(selector, [startNode]) &#123; [Command Line API] &#125;</span><br></pre></td></tr></table></figure>


<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/44769950/why-does-jquery-class-selector-only-return-one-element">Why does jQuery class selector only return one element?</a>提到</li>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/console/expressions">google developers</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>jQuery</tag>
      </tags>
  </entry>
  <entry>
    <title>使用JavaScript判断浏览器类型</title>
    <url>/posts/Use_JavaScript_to_determine_browser_type.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>使用<code>User-Agent</code>判断浏览器是不可靠的。因为使用控制台可以随意的伪装<code>User-Agent</code>。</p>
<span id="more"></span>

<h1 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h1><p>使用各浏览器特有的<strong>属性</strong>进行检测</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// Opera 8.0+</span></span><br><span class="line"><span class="keyword">var</span> isOpera = (!!<span class="variable language_">window</span>.<span class="property">opr</span> &amp;&amp; !!opr.<span class="property">addons</span>) || !!<span class="variable language_">window</span>.<span class="property">opera</span> || navigator.<span class="property">userAgent</span>.<span class="title function_">indexOf</span>(<span class="string">&#x27; OPR/&#x27;</span>) &gt;= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Firefox 1.0+</span></span><br><span class="line"><span class="keyword">var</span> isFirefox = <span class="keyword">typeof</span> <span class="title class_">InstallTrigger</span> !== <span class="string">&#x27;undefined&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Safari 3.0+ &quot;[object HTMLElementConstructor]&quot; </span></span><br><span class="line"><span class="keyword">var</span> isSafari = <span class="regexp">/constructor/i</span>.<span class="title function_">test</span>(<span class="variable language_">window</span>.<span class="property">HTMLElement</span>) || (<span class="keyword">function</span> (<span class="params">p</span>) &#123; <span class="keyword">return</span> p.<span class="title function_">toString</span>() === <span class="string">&quot;[object SafariRemoteNotification]&quot;</span>; &#125;)(!<span class="variable language_">window</span>[<span class="string">&#x27;safari&#x27;</span>] || (<span class="keyword">typeof</span> safari !== <span class="string">&#x27;undefined&#x27;</span> &amp;&amp; safari.<span class="property">pushNotification</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Internet Explorer 6-11</span></span><br><span class="line"><span class="keyword">var</span> isIE = <span class="comment">/*@cc_on!@*/</span><span class="literal">false</span> || !!<span class="variable language_">document</span>.<span class="property">documentMode</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Edge 20+</span></span><br><span class="line"><span class="keyword">var</span> isEdge = !isIE &amp;&amp; !!<span class="variable language_">window</span>.<span class="property">StyleMedia</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Chrome 1+</span></span><br><span class="line"><span class="keyword">var</span> isChrome = !!<span class="variable language_">window</span>.<span class="property">chrome</span> &amp;&amp; !!<span class="variable language_">window</span>.<span class="property">chrome</span>.<span class="property">webstore</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Blink engine detection</span></span><br><span class="line"><span class="keyword">var</span> isBlink = (isChrome || isOpera) &amp;&amp; !!<span class="variable language_">window</span>.<span class="property">CSS</span>;</span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/User-Agent">User-Agent MDN</a></li>
<li><a href="http://www.useragentstring.com/pages/useragentstring.php">List of User Agent Strings</a></li>
<li><a href="https://stackoverflow.com/questions/9847580/how-to-detect-safari-chrome-ie-firefox-and-opera-browser">How to detect Safari, Chrome, IE, Firefox and Opera browser?</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>使用copy事件添加版权信息</title>
    <url>/posts/Add_copyright_information_using_the_copy_event.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在慕课网遇到个比较降低用户体验的事情。其实在知乎、掘金也有碰到, 以及其他小网站也会碰到。<br>就是他们会拦截<code>copy</code>事件, 然后加上自己的<code>copyright</code>。<br>问题就在于, 我复制代码去执行, 还得手动去删除<code>copyright</code>, 太麻烦了。</p>
<span id="more"></span>

<h1 id="添加版权信息"><a href="#添加版权信息" class="headerlink" title="添加版权信息"></a>添加版权信息</h1><p>网上搜了下, 果然有代码, 遂复制一份。略微修改, 加了点注释</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">addCopyright</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> body_element = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&#x27;body&#x27;</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 获取 selection https://developer.mozilla.org/zh-CN/docs/Web/API/Selection</span></span><br><span class="line">        <span class="keyword">var</span> selection = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">window</span>.<span class="property">getSelection</span>) &#123; <span class="comment">// DOM,FF,Webkit,Chrome,IE10</span></span><br><span class="line">            selection = <span class="variable language_">window</span>.<span class="title function_">getSelection</span>();</span><br><span class="line">            <span class="comment">// alert(&quot;文字复制成功！若有文字残缺请用右键复制\n转载请注明出处：&quot; + document.location.href);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">getSelection</span>) &#123; <span class="comment">// IE10</span></span><br><span class="line">            selection = <span class="variable language_">document</span>.<span class="title function_">getSelection</span>();</span><br><span class="line">            <span class="comment">// alert(&quot;文字复制成功！若有文字残缺请用右键复制\n转载请注明出处：&quot; + document.location.href);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="variable language_">document</span>.<span class="property">selection</span>) &#123; <span class="comment">// IE6+10-</span></span><br><span class="line">            selection = <span class="variable language_">document</span>.<span class="property">selection</span>.<span class="title function_">createRange</span>().<span class="property">text</span>;</span><br><span class="line">            <span class="comment">// alert(&quot;文字复制成功！若有文字残缺请用右键复制\n转载请注明出处：&quot; + document.location.href);</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            selection = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="comment">// alert(&quot;浏览器兼容问题导致复制失败！&quot;);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 自定义版权信息</span></span><br><span class="line">        <span class="keyword">var</span> pagelink = <span class="string">&quot;&lt;br /&gt;&lt;br /&gt; 转载请注明来源: &lt;a href=&#x27;&quot;</span> + <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span> + <span class="string">&quot;&#x27;&gt;&quot;</span> + <span class="variable language_">document</span>.<span class="property">location</span>.<span class="property">href</span> + <span class="string">&quot;&lt;/a&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 插入版权信息</span></span><br><span class="line">        <span class="keyword">var</span> copy_text = selection + pagelink;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 6. 新建一个div, 插入 复制内容+版权信息</span></span><br><span class="line">        <span class="keyword">var</span> new_div = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">        new_div.<span class="property">style</span>.<span class="property">left</span> = <span class="string">&#x27;-99999px&#x27;</span>;</span><br><span class="line">        new_div.<span class="property">style</span>.<span class="property">position</span> = <span class="string">&#x27;absolute&#x27;</span>;</span><br><span class="line">        body_element.<span class="title function_">appendChild</span>(new_div);</span><br><span class="line">        new_div.<span class="property">innerHTML</span> = copy_text;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 7. 选择新div中的内容</span></span><br><span class="line">        selection.<span class="title function_">selectAllChildren</span>(new_div);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 8. 删除div</span></span><br><span class="line">        <span class="variable language_">window</span>.<span class="built_in">setTimeout</span>(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">            body_element.<span class="title function_">removeChild</span>(new_div);</span><br><span class="line">        &#125;, <span class="number">0</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 9. 浏览器复制选中的内容</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 获得所有元素</span></span><br><span class="line">    <span class="keyword">var</span> all = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 为所有元素添加copy事件</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = all.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> element = all[i];</span><br><span class="line">        element[<span class="string">&#x27;oncopy&#x27;</span>] = addCopyright;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h1 id="Hack方案"><a href="#Hack方案" class="headerlink" title="Hack方案"></a>Hack方案</h1><p>明显这是可以通过<a href="https://greasyfork.org/zh-CN">GreaseMonkey</a>解决的事情。<br>思路就是修改<code>copy</code>事件为空即可。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 获得所有元素</span></span><br><span class="line">    <span class="keyword">var</span> all = <span class="variable language_">document</span>.<span class="title function_">getElementsByTagName</span>(<span class="string">&quot;*&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 为所有元素添加copy事件</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>, len = all.<span class="property">length</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> element = all[i];</span><br><span class="line">        element[<span class="string">&#x27;oncopy&#x27;</span>] = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>写完后才发现早有人实现了。<a href="https://greasyfork.org/zh-CN/scripts/28497-remove-web-limits-modified">网页限制解除(改)</a></p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="http://wangbaiyuan.cn/javascript-implementation-article-copy-plus-copyright-information.html">JavaScript实现文章复制加版权信息</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>检测F12控制台是否开启</title>
    <url>/posts/Check_whether_the_F12_console_is_turned_on.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>吧友提到了拦截控制台的情况。<a href="http://tieba.baidu.com/p/5507907516">别人页面中有个js文件,无法调试.有啥办法解除这个限制.</a><br>于是好奇找了下<code>stackoverflow</code>, <a href="https://stackoverflow.com/questions/7798748/find-out-whether-chrome-console-is-open">Find out whether Chrome console is open</a>, 但是代码不太懂。<br>后来dalao告诉我知乎有篇文章: <a href="https://www.zhihu.com/question/24188524">前端开发中如何在JS文件中检测用户浏览器是否打开了调试面板（F12打开开发者工具）？</a></p>
<span id="more"></span>

<h1 id="Chrome-适用-截止至63-0-3239-108"><a href="#Chrome-适用-截止至63-0-3239-108" class="headerlink" title="Chrome 适用(截止至63.0.3239.108)"></a>Chrome 适用(截止至63.0.3239.108)</h1><p>在控制台打开的时候, 打印<code>html</code>元素会去取<code>id</code>属性的值, 只要覆盖<code>id</code>属性的<code>get</code>方法, 就可以判断是否开启控制台。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">status: <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;devtool-status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> checkStatus;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 1. 创建一个html元素, 不能使用普通Object, 两者日志处理方式不同</span></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> element = <span class="keyword">new</span> <span class="title class_">Image</span>();</span></span><br><span class="line"><span class="language-javascript"><span class="comment">//var element = document.createElement(&#x27;any&#x27;);</span></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 2. 重新定义该元素的get方法</span></span></span><br><span class="line"><span class="language-javascript"><span class="title class_">Object</span>.<span class="title function_">defineProperty</span>(element, <span class="string">&#x27;id&#x27;</span>, &#123;</span></span><br><span class="line"><span class="language-javascript">  <span class="attr">get</span>:<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    checkStatus=<span class="string">&#x27;on&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">  &#125;</span></span><br><span class="line"><span class="language-javascript">&#125;);</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="comment">// 3. 定时检测控制台是否打开</span></span></span><br><span class="line"><span class="language-javascript"><span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    checkStatus = <span class="string">&#x27;off&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="comment">// 3.1 不使用log, 使用debug, 避免污染控制台</span></span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">debug</span>(element);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#devtool-status&#x27;</span>).<span class="property">innerHTML</span> = checkStatus;</span></span><br><span class="line"><span class="language-javascript">&#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Firefox-适用-截止至57-0-4"><a href="#Firefox-适用-截止至57-0-4" class="headerlink" title="Firefox 适用(截止至57.0.4)"></a>Firefox 适用(截止至57.0.4)</h1><p>打印普通对象的日志会调用该对象的<code>toString</code>方法。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">status: <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;devtool-status&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.bootcss.com/jquery/3.2.1/jquery.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> checkStatus;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="keyword">var</span> devtools = <span class="regexp">/./</span>;</span></span><br><span class="line"><span class="language-javascript">devtools.<span class="property">toString</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">  checkStatus = <span class="string">&#x27;on&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">&#125;</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="built_in">setInterval</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">    checkStatus = <span class="string">&#x27;off&#x27;</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">console</span>.<span class="title function_">log</span>(devtools);</span></span><br><span class="line"><span class="language-javascript">    <span class="variable language_">document</span>.<span class="title function_">querySelector</span>(<span class="string">&#x27;#devtool-status&#x27;</span>).<span class="property">innerHTML</span> = checkStatus;</span></span><br><span class="line"><span class="language-javascript">&#125;, <span class="number">1000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://stackoverflow.com/questions/7798748/find-out-whether-chrome-console-is-open">Find out whether Chrome console is open</a></li>
<li><a href="https://segmentfault.com/a/1190000012359015">突破前端反调试–阻止页面不断debugger</a></li>
<li><a href="https://www.zhihu.com/question/24188524">前端开发中如何在JS文件中检测用户浏览器是否打开了调试面板（F12打开开发者工具）？</a></li>
</ul>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>缺少分号导致IIFE失效</title>
    <url>/posts/Missing_semicolon_causes_IIFE_not_working.html</url>
    <content><![CDATA[<h1 id="正文"><a href="#正文" class="headerlink" title="正文"></a>正文</h1><p>先来看这两段代码, 执行之后可以看到控制台爆出<code>log.(...) is not a function</code>的错误异常信息。</p>
<span id="more"></span>

<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="literal">undefined</span>;</span><br><span class="line"><span class="comment">// 1. 执行错误</span></span><br><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; 测试1&quot;</span>)</span><br><span class="line">    (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">alert</span>(<span class="string">&quot;测试哈哈哈&quot;</span>); &#125;)();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 正确执行</span></span><br><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; 测试1&quot;</span>);</span><br><span class="line">    (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">alert</span>(<span class="string">&quot;测试哈哈哈&quot;</span>); &#125;)();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>万物皆对象, 函数也是对象。<br>所以函数也可以返回函数, 做到<code>fun(arg1)(arg2)(arg3)</code>这种奇葩的语法。</p>
<p>我们再把第一种缺少分号的函数换个写法, 这两种写法是等价的。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">$(<span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// 1. 原代码</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; 测试1&quot;</span>)</span><br><span class="line">    (<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">alert</span>(<span class="string">&quot;测试哈哈哈&quot;</span>); &#125;)();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 2. 换种写法, 类似于`fun(arg1)(arg2)(arg3)`</span></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot; 测试1&quot;</span>)(<span class="keyword">function</span> (<span class="params"></span>) &#123; <span class="title function_">alert</span>(<span class="string">&quot;测试哈哈哈&quot;</span>); &#125;)();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>我们预想的执行方式截然不同。<code>console.log()</code>和匿名函数变成了一条语句。<br>即使是使用了<code>&#39;use strict&#39;;</code>也不会在写代码的时候报错。<br>所以不要太过于依赖没有分号。</p>
<h1 id="结合window-onerror造成更大杀伤力"><a href="#结合window-onerror造成更大杀伤力" class="headerlink" title="结合window.onerror造成更大杀伤力"></a>结合window.onerror造成更大杀伤力</h1><p>第一行我加上了<code>window.onerror = undefined;</code>。<br>因为项目上使用了<a href="https://www.kaipuyun.cn/">开普云</a>的一个<code>js</code>脚本。</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span> <span class="attr">id</span>=<span class="string">&quot;kpyfx_js_id_10000077&quot;</span> <span class="attr">src</span>=<span class="string">&quot;//fxsjcj.kaipuyun.cn/count/10000077/10000077.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这个<code>js</code>没有详细去看, 因为压缩混淆过了。<br>但是我知道的是, 它拦截了异常报错信息, 导致控制台无法正常提示错误, 拖住我好久(生气</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">window</span>.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">url, error, line, column</span>) &#123;</span><br><span class="line">    _$xerrorcode = <span class="string">&quot;msg[&quot;</span> + url + <span class="string">&quot;]#line[&quot;</span> + line + <span class="string">&quot;]#column[&quot;</span> + column + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>
<p>所以我在第一行加上了<code>window.onerror = undefined;</code>(或者<code>null</code>)。<br>因为我在浏览器控制台输入<code>window.onerror</code>, 返回的是<code>null</code>。</p>
]]></content>
      <categories>
        <category>JavaScript</category>
      </categories>
      <tags>
        <tag>JavaScript</tag>
      </tags>
  </entry>
  <entry>
    <title>NPM包管理工具入门</title>
    <url>/posts/what_is_npm.html</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><code>NPM</code>对于<code>Nodejs</code>, 就像<code>Maven</code>对于<code>Java</code>.<br><code>NPM</code>是一个包管理工具, 用于管理依赖. </p>
<span id="more"></span>

<h1 id="npmrc-详解"><a href="#npmrc-详解" class="headerlink" title="npmrc 详解"></a>npmrc 详解</h1><p>作为一个包管理工具, 肯定有相关的配置.<br>比如, 从哪个仓库下载依赖, 保存到本地的哪个目录下.</p>
<p>安装好<code>NPM</code>后, 会有三个文件</p>
<ol>
<li>每个项目的配置文件(<code>/path/to/my/project/.npmrc</code>)</li>
<li>每个用户的配置文件(<code>〜/.npmrc</code>)</li>
<li>全局配置文件(<code>$PREFIX/etc/npmrc</code>)</li>
<li><code>NPM</code>内置配置文件(<code>/path/to/npm/npmrc</code>)</li>
</ol>
<p>具体可以看看<a href="https://docs.npmjs.com/cli/v7/configuring-npm/npmrc"><code>npmrc</code>官方文档</a></p>
<figure class="highlight shell"><figcaption><span>script</span></figcaption><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置远程仓库</span></span><br><span class="line">npm config set registry https://registry.npm.taobao.org </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置缓存位置</span></span><br><span class="line">npm config set cache &quot;D:\nodejs\node_cache&quot;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置全局模块存放位置</span>  </span><br><span class="line">npm config set prefix &quot;D:\nodejs&quot;</span><br><span class="line"></span><br><span class="line">npm config ls</span><br></pre></td></tr></table></figure>
<p>像我们一开始都会配置国内仓库, 这些命令都是去修改用户的配置文件, 也就是<code>~/.npmrc</code></p>
<h1 id="package-json-和-package-lock-json"><a href="#package-json-和-package-lock-json" class="headerlink" title="package.json 和 package-lock.json"></a>package.json 和 package-lock.json</h1><p>和<code>pom.xml</code>类似, <code>package.json</code>就是描述这个项目的, 发布的时候会用到.<br>这里拿<code>hexo</code>的举个例子.</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo-site&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;0.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;scripts&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;build&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo generate&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;clean&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo clean&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;deploy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo deploy&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;hexo server&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hexo&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="string">&quot;5.3.0&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;dependencies&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;hexo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^5.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-archive&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-category&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-index&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-generator-tag&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-renderer-ejs&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^1.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-renderer-marked&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^3.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-renderer-stylus&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-server&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^2.0.0&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;hexo-theme-landscape&quot;</span><span class="punctuation">:</span> <span class="string">&quot;^0.0.3&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p><code>name</code>和<code>version</code>是必填项, 用来标记项目名称和版本号. 这个<code>name</code>可以作为<code>require</code>的参数传递.<br><code>scripts</code>用来注册<code>npm</code>命令, 比如<code>npm clean</code>就会调用<code>hexo clean</code>命令.<br><code>hexo</code>是自定义的配置, 不用管.<br><code>dependencies</code>表示本项目的所有依赖名称以及版本哈.</p>
<p>具体可以看看<a href="https://docs.npmjs.com/cli/v7/configuring-npm/package-json"><code>package.json</code>官方文档</a></p>
<p><code>package-lock.json</code>和<code>package.json</code>结构差不多, 那为什么要有两个不同的文件呢?</p>
<h1 id="package-json-和-package-lock-json-1"><a href="#package-json-和-package-lock-json-1" class="headerlink" title="package.json 和 package-lock.json"></a>package.json 和 package-lock.json</h1><p>比如说<code>hexo</code>依赖的<code>hexo-renderer-ejs</code>在<code>package.json</code>的版本号是<code>1.0.0</code>.<br>在执行<code>npm install</code>的时候, <code>npm</code>会根据<code>package.json</code>的定义, 从本地磁盘或远程仓库里获取依赖.</p>
<p>假设<code>hexo-renderer-ejs</code>紧急发布了一个修复<code>bug</code>的版本<code>1.0.2</code>.<br>那在执行<code>npm install</code>的时候就会去根据主版本号<code>1</code>去获取最新的<code>hexo-renderer-ejs</code>版本.</p>
<p>正常按语义化版本的规范来说, 只要主版本号不变, 那都是兼容的.<br>但万一不按规范来, 比如<code>1.0.2</code>和<code>1.0.0</code>是不兼容的. 而<code>npm install</code>每次都会根据主版本号去拉取最新的依赖, 那风险就很大了.</p>
<p>为了解决这个问题, <code>package-lock.json</code>就出现了. <code>package-lock.json</code>和<code>package.json</code>结构差不多.<br>执行<code>npm install</code>的时候, <code>npm</code>会根据<code>package.json</code>拉取最新的依赖版本, 然后生成<code>package-lock.json</code>, 锁定版本号.<br>然后下次<code>npm install</code>的时候, 就会从<code>package-lock.json</code>中获取准确的版本号, 就不会出现升级风险. </p>
<h1 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h1><ul>
<li><a href="https://docs.npmjs.com/cli/v7/">官方文档</a></li>
</ul>
]]></content>
      <categories>
        <category>Nodejs</category>
      </categories>
      <tags>
        <tag>Nodejs</tag>
      </tags>
  </entry>
</search>
